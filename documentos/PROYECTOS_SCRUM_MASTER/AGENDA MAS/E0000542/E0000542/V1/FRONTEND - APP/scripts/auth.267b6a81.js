!function(){"use strict";angular.module("sdx.agenda.globals",["sdx.envConfig","mm.foundation"])}(),function(){"use strict";function a(a,b){return{login:a+"/Login/",buscarPaciente:a+"/BuscarPaciente/",obtenerDisponibilidad:a+"/ObtenerDisponibilidad/",notificarCitaNueva:a+"/NotificarCitaNueva/",editarInformacionPaciente:a+"/EditarInformacionPaciente/",crearTelefonoPaciente:a+"/CrearTelefonoPaciente/",anularCita:a+"/AnularCita/",obtenerCitasFuturas:a+"/ObtenerCitasFuturas/",buscarProfesional:a+"/BuscarProfesional/",obtenerCitasAgendadas:a+"/ObtenerCitasAgendadas/",rechazarCita:a+"/RechazarCita",crearCaso:a+"/CrearCaso",agendarCita:a+"/AgendarCita",cerrarCaso:a+"/CerrarCaso",enviarCorreo:a+"/NotificarCita",obtenerEstablecimiento:a+"/ObtenerEstablecimiento",obtenerCentroContacto:a+"/ObtenerCentroContacto",crearCentroContacto:a+"/CrearCentroContacto",actualizarCentroContacto:a+"/ActualizarCentroContacto",obtenerContratos:a+"/ObtenerContratos",actualizarContrato:a+"/ActualizarContrato",obtenerListaTrabajo:a+"/ObtenerListaTrabajo",crearTelefonista:a+"/CrearTelefonista",actualizarTelefonista:a+"/ActualizarTelefonista",obtenerAlcanceCentroContacto:a+"/ObtenerAlcanceCentroContacto",obtenerCitasPorFiltro:a+"/ObtenerCitasPorFiltro",notificarCitaReagendada:a+"/NotificarCitaReagendada",jasperServer:b}}angular.module("sdx.agenda.globals").factory("RestEndpoints",a),a.$inject=["AGENDA_API_BASE","REPORTS_BASE"]}(),function(){"use strict";angular.module("sdx.agenda.globals").constant("PhoneTypes",{telephone:{label:"TEL1_FICHA_FAMILIAR",typeId:1},cellphone:{label:"MOVIL_FICHA_FAMILIAR",typeId:4}}).constant("HealthProblemsConst",{Alergias:"medicina general",Cefalea:"neuro","Colon Irritable":"medicina general",Diabetes:"medicina general",Diarrea:"medicina general","Hipertensión Arterial":"cardio",Infertilidad:"gine","Obesidad y Nutrición":"medicina general","Patología Mamaría":"gine"})}(),function(){"use strict";function a(a,b,c,d,e){b.debugInfoEnabled(d),c.debugEnabled(d),a.state("publicLogin",{url:"/publico",views:{main:{templateUrl:"main.html",controller:"AuthPatientController as apc"}}}).state("publicLoginOrigin",{url:"/publico/:origin",resolve:{params:["$base64","$stateParams","$state",function(a,b,c){var d={origin:a.decode(b.origin)};return d.origin||c.go("errorLoginDirect"),d}]},views:{main:{templateUrl:"main.html",controller:"AuthPatientController as apc"}}}).state("privateLogin",{url:"/privado",views:{main:{templateUrl:"main.html",controller:"AuthPatientController as apc"}}}).state("loginDirect",{url:"/auth/:type/:run/:birthday",resolve:{params:["$base64","$stateParams","$state",function(a,b,c){var d={type:b.type,run:a.decode(b.run),birthday:a.decode(b.birthday)};return d.type&&d.run&&d.birthday?d:c.go("errorLoginDirect")}]},views:{main:{templateUrl:"login-direct.html",controller:"directController as dc"}}}).state("loginDirectOrigin",{url:"/auth/:type/:run/:birthday/:origin",resolve:{params:["$base64","$stateParams","$state",function(a,b,c){var d={type:b.type,run:a.decode(b.run),birthday:a.decode(b.birthday),origin:a.decode(b.origin)};return d.type&&d.run&&d.birthday&&d.origin?d:c.go("errorLoginDirect")}]},views:{main:{templateUrl:"login-direct.html",controller:"directController as vm"}}}).state("errorLoginDirect",{url:"/direct/error",views:{main:{templateUrl:"error-login-direct.html"}}}).state("error-ruta",{url:"/error-ruta",views:{main:{templateUrl:"error-router.html"}}}),e.otherwise("/error-ruta")}angular.module("sdx.agenda.autentificacion",["ui.router","sdx.agenda.globals","sdx.agenda.patientSession","base64"]).config(a),a.$inject=["$stateProvider","$compileProvider","$logProvider","DEBUG","$urlRouterProvider"]}(),function(){"use strict";function a(a,b,c){var d=this;return d.isPublic=c.is("publicLogin")||c.is("publicLoginOrigin"),d.error=!1,d.typeAuth="reservar",d.birthdate=null,d.run=null,d.autentificacion=function(){d.isPublic&&(d.loading=!0,a.auth({birthday:d.birthdate,run:d.run}).then(function(b){return a["goto"](d.typeAuth,"publico")},function(a){"RUN y/o fecha de nacimiento incorrectos, o su establecimiento no tiene habilitado este servicio."==a?d.error=a:d.error="Sin conmunicación con el servidor"})["finally"](function(){d.loading=!1}))},d.runFormat=function(){d.run=b("RunFormatFilter")(d.run)},d.runValidate=function(){return d.runFormat(),b("RunFormatFilter")(d.run||"","validate")},d}angular.module("sdx.agenda.autentificacion").controller("AuthPatientController",a),a.$inject=["PatientSession","$filter","$state"]}(),function(){"use strict";function a(a,b){function c(){d.loading=!0,a.auth({birthday:b.birthday,run:b.run},b.origin).then(function(b){b.typeAttention="publico","cancelar"===d.typeAuth&&(b.section="delete"),a["goto"](b.section,b.typeAttention)},function(a){d.error=a})["finally"](function(){d.loading=!1})}var d=this;d.loading=!1,c()}angular.module("sdx.agenda.autentificacion").controller("directController",a),a.$inject=["PatientSession","params"]}(),function(){"use strict";angular.module("sdx.agenda.appointments",["sdx.agenda.globals"])}(),function(){"use strict";function a(a,b,c,d,e){var f=this;f.appointments=[],f.appointmentsLoaded=!1,f.HTTP_CONFIG={headers:{"Content-Type":"text/json"}},f.anularCita=function(d){return a.post(c.anularCita,{IdentificadorCitaRechazada:d.IdentificadorCita},f.HTTP_CONFIG)["catch"](function(){return b.reject({type:"error",msg:"Ha ocurrido un error al agendar la cita"})})};var g={newResource:function(){return{id:null,date:null,typeAttention:null,specialty:null,professional:{id:null,name:null}}},load:function(e){return a.post(c.obtenerDisponibilidad,{FechaInicio:d("date")(new Date,"yyyyMMdd"),IdsNodo:e.healthCareCenter.id,IdentificadorPaciente:e.id},f.HTTP_CONFIG).then(function(a){return a.data.hasOwnProperty("TypeCupo")?(angular.isArray(a.data.TypeCupo)||(a.data.TypeCupo?a.data.TypeCupo=[a.data.TypeCupo]:a.data.TypeCupo=[]),a.data.TypeCupo.forEach(function(a){var b=parseInt(a.Fecha.substring(0,4)),c=parseInt(a.Fecha.substring(4,6))-1,d=parseInt(a.Fecha.substring(6,8)),e=parseInt(a.Hora.split(/\:/g)[1]),g=parseInt(a.Hora.split(/\:/g)[0]);f.appointments.push({id:parseInt(a.IdCupo),professional:{name:a.NombreMedico+" "+a.ApPaternoMedico,id:parseInt(a.IdMedico)},specialty:a.Especialidad,typeAttention:a.TipoAtencion,date:new Date(b,c,d,g,e),healthCareCenter:{id:a.IdNodo}})}),f.appointmentsLoaded=!0,f.appointments):b.reject()})},getList:function(a,c){return f.appointmentsLoaded&&!c?b.resolve(f.appointments):g.load(a).then(function(){return f.appointments})},getListFuture:function(a){return f.appointmentsFutureLoaded?f.futureAppointments:g.loadFutures(a).then(function(){return f.futureAppointments})},make:function(e,g,h){return a.post(c.notificarCitaNueva,{FechaEnteraCupo:d("date")(new Date(e.date),"yyyyMMdd"),IdCupo:e.id,IdPaciente:g,Fecha:d("date")(new Date(e.date),"yyyy-MM-dd HH:mm"),IdNodo:e.healthCareCenter.id,Comentario:e.healthCareCenter.id},f.HTTP_CONFIG).then(function(a){return a.data&&a.data.RespuestaBase&&a.data.RespuestaBase.hasOwnProperty("Estatus")?0!==parseInt(a.data.RespuestaBase.Estatus)?b.reject({type:"warning",msg:a.data.RespuestaBase.Descripcion}):{IdentificadorCita:a.data.IdentificadorCita,IdCaso:a.data.IdCaso,IdCupo:a.data.IdCupo}:b.reject({type:"error",msg:"Ha ocurrido un error en el servidor. Por favor intente más tarde"})})},loadFutures:function(d){return a({method:"POST",url:c.obtenerListaTrabajo,headers:{"Content-Type":"text/json"},data:JSON.stringify({IdPaciente:d.id})}).then(function(a){var c=a.data;if(c.RespuestaBase&&0===c.RespuestaBase.Estatus){var e=[],g={};c.Citas.forEach(function(a){if(!a.FechaCita)return!1;if(parseInt(a.IdPaciente)!==parseInt(d.id))return!1;var b=parseInt(a.FechaCita.substring(0,4)),c=parseInt(a.FechaCita.substring(4,6))-1,e=parseInt(a.FechaCita.substring(6,8)),f=parseInt(a.HoraCita.split(/\:/g)[1]),h=parseInt(a.HoraCita.split(/\:/g)[0]);g[a.IdCita]={id:a.IdCita,idQuota:a.IdCupo,status:a.EstadoSonia,idCase:a.IdCaso,date:new Date(b,c,e,h,f),patient:{id:a.IdPaciente,run:a.RutPaciente,name:a.NombrePaciente,cellphone:a.MOVIL_CONTACTO||a.MOVIL_FICHA_FAMILIAR,tagCelhone:a.MOVIL_CONTACTO?"MOVIL_FICHA_FAMILIAR":a.MOVIL_FICHA_FAMILIAR?"MOVIL_FICHA_FAMILIAR":"",telephone:a.TEL1_CONTACTO||a.TEL1_FICHA_FAMILIAR,tagTelephone:a.TEL1_CONTACTO?"TEL1_FICHA_FAMILIAR":a.TEL1_FICHA_FAMILIAR?"TEL_FICHA_FAMILIAR":"",email:a.Email,telephoneAreaCode:a.TEL1_CONTACTO_CODIGO_AREA,telephoneCountryCode:a.TEL1_CONTACTO_CODIGO_PAIS},healthCareCenter:{id:a.IdNodo,name:a.Nodo},specialty:{id:a.IdEspecialidad,name:a.Especialidad},typeAttention:{id:0,name:a.TipoAtencion},professional:{id:0,name:a.Profesional}}});for(var h in g)g.hasOwnProperty(h)&&e.push(g[h]);return f.futureAppointments=e,e}return b.reject("Ha ocurrido un error al cargar las citas agendadas")})},availablesForReschedule:function(e){return a({method:"POST",url:c.obtenerDisponibilidad,headers:{"Content-Type":"text/json"},data:JSON.stringify({FechaInicio:d("date")(new Date,"yyyyMMdd"),IdsNodo:e.healthCareCenter.id,IdentificadorPaciente:e.patient.id})}).then(function(a){var c=a.data,d=[];return c?(angular.isArray(c.TypeCupo)||(c.TypeCupo?c.TypeCupo=[c.TypeCupo]:c.TypeCupo=[]),c.TypeCupo.forEach(function(a){if(a.Especialidad.toLowerCase()!==e.specialty.name.toLowerCase()||a.TipoAtencion.toLowerCase()!==e.typeAttention.name.toLowerCase())return!1;var b=parseInt(a.Fecha.substring(0,4)),c=parseInt(a.Fecha.substring(4,6))-1,f=parseInt(a.Fecha.substring(6,8)),g=parseInt(a.Hora.split(/\:/g)[1]),h=parseInt(a.Hora.split(/\:/g)[0]);d.push({id:parseInt(a.IdCupo),healthCareCenter:parseInt(a.IdNodo),professional:a.NombreMedico+" "+a.ApPaternoMedico,specialty:a.Especialidad,typeAttention:a.TipoAtencion,date:new Date(b,c,f,h,g)})}),d):b.reject("Ha ocurrido un error al cargar las citas disponibles")})},sendEmail:function(d,e){return a({method:"POST",url:c.enviarCorreo,headers:{"Content-Type":"text/json"},data:JSON.stringify({idCita:d,idPaciente:e.id,rutPaciente:e.run})}).then(function(a){try{var c=a.data;return 0===c.RespuestaBase.Estatus?!0:b.reject("Ha ocurrido algo inesperado")}catch(d){return b.reject("Ha ocurrido algo inesperado")}},function(a){return b.reject("Ha ocurrido un error al enviar el correo electrónico.")})},confirm:function(d,g,h,i){var j;switch(g){case"confirm":j=e.Confirmada;break;case"cancel":j=e.Cancelada;break;default:j=e.Reagendada}return a.post(c.agendarCita,{IdCaso:d.idCase,IdCita:h||d.id,IdCupo:i,IdEstadoCita:j,Comentario:d.healthCareCenter.id},f.HTTP_CONFIG).then(function(a){var c=a.data;0===c.RespuestaBase.Estatus&&b.resolve()})},cancel:function(d,e){return a.post(c.anularCita,{IdentificadorCitaRechazada:d.id},f.HTTP_CONFIG).then(function(a){var c=a.data;0===c.Estatus?b.resolve():b.reject("Ha ocurrido un error al anular la cita")})},reschedule:function(e,g,h){return a.post(c.notificarCitaReagendada,{FechaEnteraCupo:d("date")(new Date(h.date),"yyyyMMdd"),IdCupo:h.id,IdPaciente:e.patient.id,Fecha:d("date")(new Date(h.date),"yyyy-MM-dd HH:mm"),IdCitaEliminada:e.id,IdNodo:e.healthCareCenter.id},f.HTTP_CONFIG).then(function(a){var c=a.data;0!==parseInt(c.Estatus)?b.reject("Ha ocurrido un error al anular la cita"):b.resolve()})}};return g}angular.module("sdx.agenda.appointments").constant("EstadoCitaConst",{Agendada:1,Confirmada:2,Cancelada:3,Reagendada:4}).factory("AppointmentsService",a),a.$inject=["$http","$q","RestEndpoints","$filter","EstadoCitaConst"]}(),function(){"use strict";angular.module("sdx.agenda.patient",["sdx.agenda.globals"])}(),function(){"use strict";function a(a,b,c,d){var e=this;e.newPhone=function(e,f,g){return a({method:"POST",url:b.crearTelefonoPaciente,headers:{"Content-Type":"text/json"},data:JSON.stringify({Telefono:e,IdPaciente:g.id,EtiquetaTelefono:d[f].label,TipoTelefono:d[f].typeId,CodArea:"",CodPais:"56"})}).then(function(a){var b=a.data;0===parseInt(b.Estatus)?g[f]=e:c.reject()})},e.editPhoneEmail=function(e,f,g,h){return a({method:"POST",url:b.editarInformacionPaciente,headers:{"Content-Type":"text/json"},data:JSON.stringify({Email:g||"",EtiquetaTelefono:d[f].label,IdPaciente:h.id,Telefono:e||"",CodigoArea:"0"})}).then(function(a){var b=a.data;return 0===parseInt(b.Estatus)?(h.email=g,void(h[f]=e)):void c.reject()})};var f={getContactDataCopy:function(a){return{email:a.email,telephone:a.telephone,cellphone:a.cellphone,areaCode:String(a.telephoneAreaCode)||"2",countryCode:String(a.telephoneCountryCode)||"56"}},updateContactData:function(a,b,d,f){a.telephone=a.telephone.toString(),b=b.toString();var g=[];return a.telephone!==b&&(a.telephone?g.push(e.editPhoneEmail(b,"telephone",f,a)):g.push(e.newPhone(b,"telephone",a))),a.cellphone!==d&&(a.cellphone?g.push(e.editPhoneEmail(d,"cellphone",f,a)):g.push(e.newPhone(b,"cellphone",a))),g.length||a.email.toString()===f.toString()||g.push(e.editPhoneEmail(b,"telephone",f,a)),c.all(g)},updateEmail:function(a,b){return e.editPhoneEmail(a.telephone,"telephone",b,a)},getFromApi:function(a){var b={};return angular.isObject(a)?(b.id=parseInt(a.Id_Paciente),b.name=a.Nombres+" "+a.Ap_Paterno+" "+a.Ap_Materno,b.run=a.Rut,b.healthCareCenter={},b.healthCareCenter.id=parseInt(a.Id_nodo),b.healthCareCenter.name=a.Nodo,b.section=a.section,b.email=a.Email,b.telephone=a.Tel_Contacto,b.cellphone=a.Movil_Contacto,b.telephoneAreaCode=a.Tel_Contacto_Codigo_Area,b.telephoneCountryCode=a.Tel_Contacto_Codigo_Pais,b):b},isValidData:function(a,b){return b&&a&&b.FechaNacimiento&&a&&parseInt(a)!==parseInt(b.Id_Paciente)}};return f}angular.module("sdx.agenda.patient").factory("PatientService",a),a.$inject=["$http","RestEndpoints","$q","PhoneTypes"]}(),function(){"use strict";angular.module("sdx.agenda.patientSession",["base64","sdx.agenda.globals","sdx.agenda.patient"])}(),function(){"use strict";function a(a,b,c,d,e,f,g){var h=this;h.state={finished:!1,step:1,section:"specialty",prev:{step:0},origin:null},h.selectedAppointment=null,h.patient=null,e.onbeforeunload=function(){localStorage.ss=a.encode(JSON.stringify({state:h.state,patient:h.patient,sa:h.selectedAppointment})),h.stopAutoLogout()},h.logout=function(){var a;a=h.state.origin&&i.test(h.state.origin)?h.state.origin:"../autentificacion/#/publico",h.selectedAppointment=null,h.patient=null,h.state=null,e.location.href=a},h.startAutoLogout=function(){var a=new Date(h.state.timeStart.getTime()+6e4*g),b=a-new Date;0>=b&&h.logout(),h.autoLogout=e.setTimeout(function(){h.logout()},b)},h.stopAutoLogout=function(){h.autoLogout&&e.clearTimeout(h.autoLogout)};var i=/^(https?:\/\/)?((([a-z\d]([a-z\d-]*[a-z\d])*)\.)+[a-z]{2,}|((\d{1,3}\.){3}\d{1,3}))(\:\d+)?(\/[-a-z\d%_.~+]*)*(\?[;&a-z\d%_.~+=-]*)?(\#[-a-z\d_]*)?$/i;return{state:function(){return h.state},selectedAppointment:function(){return h.selectedAppointment},setSelectedAppointment:function(a){return h.selectedAppointment=a,h.selectedAppointment},patient:function(){return h.patient},auth:function(a,e){return a.birthday?(a.birthday=a.birthday.split(/\//g),a.birthday.forEach(function(b,c){a.birthday[c]=parseInt(b)<10?"0"+parseInt(b):b}),a.birthday=a.birthday.join("/")):a.birthday="",h.state.origin=e,c({method:"POST",url:b.buscarPaciente,headers:{"Content-Type":"text/json"},data:{Rut:a.run.replace(/[\-\.]/g,"").toLowerCase().trim(),FechaNacimiento:a.birthday}}).then(function(b){var c=b.data;return console.log(b),console.log(c.length),console.log(c.Id_Paciente),void 0==c.Id_Paciente?d.reject("RUN y/o fecha de nacimiento incorrectos, o su establecimiento no tiene habilitado este servicio."):f.isValidData(a.id,c)?d.reject("Paciente no encontrado."):(h.patient=f.getFromApi(c),h.patient)})},load:function(){if(localStorage.ss){var b=angular.fromJson(a.decode(localStorage.ss));h.state=b.state,h.state.timeStart&&(h.state.timeStart=new Date(h.state.timeStart)),h.patient=b.patient,h.selectedAppointment=b.sa,localStorage.removeItem("ss")}return d.resolve()},logout:function(){h.logout()},"goto":function(a,b){var c;switch(a){case"confirmar":h.state.section="confirmar",c="../agendamiento/#/confirmar";break;default:c="../agendamiento/"}h.state.typeAttention=b,h.state.timeStart=new Date,e.top.location=c},clear:function(){h.state.appointmentsStart=void 0,h.selectedAppointment=void 0,h.state.step=h.state.prev.step||1,h.state.prev.step=void 0},startSession:function(){h.stopAutoLogout(),h.startAutoLogout()}}}angular.module("sdx.agenda.patientSession").factory("PatientSession",a),a.$inject=["$base64","RestEndpoints","$http","$q","$window","PatientService","TIME_LIMIT_PATIENT_SESSION"]}(),function(){"use strict";function a(){return{template:'<div class="sk-fading-circle"><div class="sk-circle1 sk-circle"></div><div class="sk-circle2 sk-circle"></div><div class="sk-circle3 sk-circle"></div><div class="sk-circle4 sk-circle"></div><div class="sk-circle5 sk-circle"></div><div class="sk-circle6 sk-circle"></div><div class="sk-circle7 sk-circle"></div><div class="sk-circle8 sk-circle"></div><div class="sk-circle9 sk-circle"></div><div class="sk-circle10 sk-circle"></div><div class="sk-circle11 sk-circle"></div><div class="sk-circle12 sk-circle"></div></div>',link:function(a,b,c){$(b).find(".sk-circle").addClass(c.loadIcon)}}}angular.module("sdx.agenda.globals").directive("loadIcon",a),a.$inject=[]}(),function(){"use strict";function a(){return{link:function(a,b,c){var d=c.itOnly;d&&($(b).attr("it-only",""),d=new RegExp(d),$(b).keypress(function(a){var b=String.fromCharCode(document.all?a.keyCode:a.which);a.key||d.test(b)?d.test(b)||1!==a.key.length||/^[cvx]$/.test(a.key)||a.preventDefault():a.preventDefault()}))}}}function b(){return{link:function(a,b,c){function d(){$(this).val()?c.itPatternerrormessage||this.setCustomValidity(""):this.setCustomValidity(e)}var e=c.itEmptymessage;e&&($(b).attr("it-emptyMessage",""),$(b).change(d),$(b).keypress(d),$(b).keyup(d),$(b).val()||b[0].setCustomValidity(e))}}}function c(){return{scope:{reg:"=itPattern"},link:function(a,b,c){function d(){var a="function"==typeof e?e():new RegExp(e),b=$(this);""!==b.val()?"object"==typeof a&&a.test(b.val())?this.setCustomValidity(""):"boolean"==typeof a&&a?this.setCustomValidity(""):this.setCustomValidity(f):""!==b.val()||c.itEmptymessage?this.setCustomValidity(""):this.setCustomValidity(f)}var e=a.reg||"",f=c.itPatternerrormessage;e&&f&&($(b).attr("it-pattern",""),$(b).attr("it-patternerrormessage",""),$(b).change(d),$(b).keypress(d),$(b).keyup(d))}}}angular.module("sdx.agenda.globals").directive("itOnly",a).directive("itEmptymessage",b).directive("itPattern",c),a.$inject=[],b.$inject=[],c.$inject=[]}(),function(){function a(){return function(a,c){if(c=c?c:"format","format"===c){var d=b(a),e=d[0],f=d[1];if(!e||!f)return"";for(var g="";e.length>3;)g="."+e.substr(e.length-3)+g,e=e.substring(0,e.length-3);return(e+g+"-"+f).toLowerCase()}if("validate"===c){for(var h=a.replace(/\./g,"").split(/\-/),i=parseInt(h[0]),j=0,k=1;i;i=Math.floor(i/10))k=(k+i%10*(9-j++%6))%11;var l=k?k-1:"k";return String(l)===h[1]}}}function b(a){var b=(a||"").replace(/[\.\-]/g,"");if(0===b.length)return[null,null];if(1===b.length)return[b,null];var c=b.charAt(b.length-1),d=b.substring(0,b.length-1);return[d,c]}angular.module("sdx.agenda.globals").filter("RunFormatFilter",a),a.$inject=[]}();