--dbo.DerivacionConsultasDeleteTrigger.sql

USE [Consultas]
GO

/****** Object:  Trigger [DerivacionConsultasDeleteTrigger]    Script Date: 11/24/2014 13:13:00 ******/
IF EXISTS (SELECT * FROM sys.triggers WHERE object_id = OBJECT_ID(N'[dbo].[DerivacionConsultasDeleteTrigger]'))
	DROP TRIGGER [dbo].[DerivacionConsultasDeleteTrigger]
GO

/****** Object:  Trigger [dbo].[DerivacionConsultasDeleteTrigger]    Script Date: 11/24/2014 13:13:01 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

/*
TRIGGER			  : DerivacionConsultasDeleteTrigger
FECHA             : 24/10/2013
AUTOR             : Enrique SÃ¡nchez
TAREA			  : CHC2076 - DerivaciÃ³n entre instancias - DerivaciÃ³n SIC Fase 1 - v4.41
APLICACIÃ“N ORIGEN : Consultas Externas  
MODIFICACION	  : (20/11/2014) Alberto PagÃ¡n Benedicto - V4.49 - 1440 - APB - Segunda parte DerivaciÃ³n entre instancias
MODIFICACION	  : (15/06/2015) Alberto PagÃ¡n Benedicto - V4.52 - 1898 - APB - Nuevo formato impreso SIC
MODIFICACION	  : (23/08/2017) - v17.3 - 18451 - FCB - Ingresar observación al motivo de egreso en SIC
*/

CREATE TRIGGER [dbo].[DerivacionConsultasDeleteTrigger]
ON [dbo].[DerivacionConsultas]
FOR DELETE
AS

DECLARE @usuario varchar(250)
       ,@FechaEliminada datetime
       ,@estacion varchar(15)

SELECT @FechaEliminada = getdate()
	  ,@estacion = host_name()
	  ,@usuario = SYSTEM_USER

INSERT INTO Consultas..DerivacionConsultasBorrados (
	   CodPaciente
      ,CodDerivacion
      ,CodEpisodioOrigen
      ,FechaConsulta
      ,CodCentroOrigen
      ,CodServicioOrigen
      ,CodCentroFinal
      ,CodServicioFinal
      ,Solicitud
      ,DictamenClinico
      ,Comentarios
      ,Inspecciones
      ,CodColectivo
      ,FechaInicial
      ,DNIMedEpi
      ,MedicoOrigen
      ,Motivo
      ,IdMotivo 
      ,FechaCierre
      ,CodDiagnosticoProvisional
      ,SalidaAlta
      ,Origen
      ,BajaTrabajo
      ,EpiAbierto
      ,DNIMedAlta
      ,CodHistoria
      ,CodProceso
      ,TipoRemision
      ,DniMedDestino
      ,FechaCPrimera
      ,CitaConfirmada
      ,AsisteCita
      ,PrimeraCita
      ,FechaBorrado
	  ,Estacion
	  ,Usuario
      ,IdGuiaClinica
	  ,FAsigGuia
	  ,Fecha
	  ,NIF
	  ,AyudaGuia
	  ,RecomendGuia
	  ,TratamientoGuia
	  ,PruebasGuia
	  ,FichaDatosGuia
	  ,TipoGuia
	  ,FechaPrevista
	  ,DescMotivoPasiva 
	  ,IdUnidad
	  ,codDiagnosticoPrimero
	  ,NumAutorizacion
	  ,Comunicada
	  ,fechaConfirmacion
	  ,confirmada
	  ,CodIntervencion
	  ,NifConfirmante
	  ,LibreEleccion
	  ,IDProblemaSalud
      ,NumNacionalInter
      ,codigoRYF
      ,IDEspecialidadDEIS
      ,Enfermeria
	  ,ProtocoloCRM
	  ,CheckHospital
	  ,CheckCS
	  ,codPlanGRD
	  ,CodPlanCuidados
	  ,RechazosCita
	  ,NoAsistenciasCita
	  ,NumE112
	  ,EstadoGES		
	  ,Cod_Latera	
	  ,CodPacienteDestino
	  ,CodEpisodioDestino		 
	  ,DescUnidadDestino
	  ,ComunicadaDestino
	  ,FechaComunicacion
	  ,ConfirmadaDestino	
	  ,FechaConfirmadaDestino
	  ,IDTransaccion
	  ,DerivacionManual
	  --(20/11/2014) - V4.49 â€“ 1440 â€“ APB â€“ Segunda parte DerivaciÃ³n entre instancias - INI
	  ,CodSistema
	  ,FechaCancelacion
	  ,FechaAccionCorrectora
	  ,FechaNoAtendida
	  --(20/11/2014) - V4.49 â€“ 1440 â€“ APB â€“ Segunda parte DerivaciÃ³n entre instancias - FIN
	  --(15/06/2015) - V4.52 â€“ 1898 â€“ APB â€“ Nuevo formato impreso SIC - INI
	  ,IdCausaInterconsulta
      ,DescCausaInterconsulta
      ,CodSubProblema
	  --(15/06/2015) - V4.52 â€“ 1898 â€“ APB â€“ Nuevo formato impreso SIC - FIN
	  ,RUNProfEgreso
	  ,NomProfEgreso
	  ,ObservacionEgreso
)

SELECT CodPaciente
      ,CodDerivacion
      ,CodEpisodioOrigen
      ,FechaConsulta
      ,CodCentroOrigen
      ,CodServicioOrigen
      ,CodCentroFinal
      ,CodServicioFinal
      ,Solicitud
      ,DictamenClinico
      ,Comentarios
      ,Inspecciones
      ,CodColectivo
      ,FechaInicial
      ,DNIMedEpi
      ,MedicoOrigen
      ,Motivo
      ,IdMotivo
      ,FechaCierre
      ,CodDiagnosticoProvisional
      ,SalidaAlta
      ,Origen
      ,BajaTrabajo
      ,EpiAbierto
      ,DNIMedAlta
      ,CodHistoria
      ,CodProceso
      ,TipoRemision
      ,DniMedDestino
      ,FechaCPrimera
      ,CitaConfirmada
      ,AsisteCita
      ,PrimeraCita
      ,@FechaEliminada
	  ,@estacion
	  ,@usuario
      ,IdGuiaClinica
	  ,FAsigGuia
	  ,Fecha
	  ,NIF
	  ,AyudaGuia
	  ,RecomendGuia
	  ,TratamientoGuia
	  ,PruebasGuia
	  ,FichaDatosGuia
	  ,TipoGuia
	  ,FechaPrevista
	  ,MC.Descripcion
	  ,IdUnidad
	  ,codDiagnosticoPrimero
	  ,NumAutorizacion
	  ,Comunicada
	  ,fechaConfirmacion
	  ,confirmada
	  ,CodIntervencion
	  ,NifConfirmante
	  ,LibreEleccion
	  ,IDProblemaSalud
      ,NumNacionalInter
      ,codigoRYF
      ,IDEspecialidadDEIS
      ,Enfermeria
	  ,ProtocoloCRM
	  ,CheckHospital
	  ,CheckCS
	  ,codPlanGRD
	  ,CodPlanCuidados
	  ,RechazosCita
	  ,NoAsistenciasCita
	  ,NumE112
	  ,EstadoGES		
	  ,Cod_Latera	  
	  ,CodPacienteDestino
	  ,CodEpisodioDestino		 
	  ,DescUnidadDestino
	  ,ComunicadaDestino
	  ,FechaComunicacion
	  ,ConfirmadaDestino
	  ,FechaConfirmadaDestino
	  ,IDTransaccion
	  ,DerivacionManual
	  --(20/11/2014) - V4.49 â€“ 1440 â€“ APB â€“ Segunda parte DerivaciÃ³n entre instancias - INI
	  ,CodSistema
	  ,FechaCancelacion
	  ,FechaAccionCorrectora
	  ,FechaNoAtendida
	  --(20/11/2014) - V4.49 â€“ 1440 â€“ APB â€“ Segunda parte DerivaciÃ³n entre instancias - FIN
	  --(15/06/2015) - V4.52 â€“ 1898 â€“ APB â€“ Nuevo formato impreso SIC - INI
	  ,IdCausaInterconsulta
      ,DescCausaInterconsulta
      ,CodSubProblema
	  --(15/06/2015) - V4.52 â€“ 1898 â€“ APB â€“ Nuevo formato impreso SIC - FIN
	  ,RUNProfEgreso
	  ,NomProfEgreso
	  ,ObservacionEgreso

FROM Deleted D
	 LEFT JOIN Parametros..MotivosCitas MC ON MC.Codigo = D.IdMotivo

GO
GO



--dbo.HDPDeleteTriggerNEW.sql

USE [Consultas]
GO

/****** Object:  Trigger [HDPDeleteTriggerNEW]    Script Date: 11/24/2014 12:39:08 ******/
IF EXISTS (SELECT * FROM sys.triggers WHERE object_id = OBJECT_ID(N'[dbo].[HDPDeleteTriggerNEW]'))
	DROP TRIGGER [dbo].[HDPDeleteTriggerNEW]
GO

/****** Object:  Trigger [dbo].[HDPDeleteTriggerNEW]    Script Date: 11/24/2014 12:39:08 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

--MODIFICACION: (12/03/2008) azaragoza. Incluyo los campos Fecha y NIF en la select
--MODIFICACION: (10/04/2008) azaragoza. Incluyo los campos en la insert
--MODIFICACION: (14/08/2009) Ismael Sampere. Incluyo los campos para las guias clinicas
--MODIFICACION: (05/02/2010) Teresa L Fabuel S. Se aÃ±ade campo IdUnidad
--MODIFICACION: (25/03/2010) Paco Aznar. Se aÃ±ade el campo CodDiagnosticoPrimero
--MODIFICACION: (13/04/2010) Paco Aznar. Se aÃ±ade el campo NumAutorizacion y Comunicada
--MODIFICACION: (20/04/2010) Paco Aznar. Se aÃ±ade el campo confirmada y fecha de confirmacion
--MODIFICACION: (21/04/2010) JoaquÃ­n Aniorte. Se aÃ±ade el campo CodIntervencion
--MODIFICACION: (13/05/2010) Paco Aznar. Se aÃ±ade el campo NifConfirmante
--MODIFICACION: (14/09/2010) Paco Aznar. Se aÃ±ade el campo LibreEleccion, IDProblemaSalud y NumNacionalInter
--MODIFICACION: (10/11/2010) Paco Aznar. Se obtiene el campo codigoRYF y especialidadDEIS
--MODIFICACION: (09/01/2012) Alfredo Samper. Se aÃ±aden los campos:
--											 Enfermeria, CodIntervencion, ProtocoloCRM, CheckHospital, CheckCS, CodDiagnosticoPrimero,
--											 NumAutorizacion, codPlanGRD, CodPlanCuidados, NifConfirmante, RechazosCita, NoAsistenciasCita,
--									         NumE112 y EstadoGES
--MODIFICACION: (21/06/2012) CÃ©sar Moreno. CHC-1852. Se aÃ±aden el campo Cod_Latera
--MODIFICACION: (30/10/2012) Enrique SÃ¡nchez. CHC-2038. Se recupera IdMotivo en vez de Motivo de EpisodioConsulta
--MODIFICACION: (21/10/2013) Enrique SÃ¡nchez. CHC-2076. v4.41. DerivaciÃ³n SIC Fase 1 - Se registra la columna DerivacionSIC
--MODIFICACION: (20/11/2014) Alberto PagÃ¡n Benedicto - V4.49 - 1440 - APB - Segunda parte DerivaciÃ³n entre instancias
--MODIFICACION: (15/06/2015) Alberto PagÃ¡n Benedicto - V4.52 - 1898 - APB - Nuevo formato impreso SIC
--MODIFICACION:	(14/12/2015) v4.57 - 2724 - CCM - Incorporar folio SIGGES a una solicitud de interconsulta
--MODIFICACION: (24/12/2015) - v4.58 - 2760 - SGN - Agregar prioridad en Gestor Interconsultas
--MODIFICACION: (21/09/2016) - V4.59r10 - 13071 - APB - Error integraciÃ³n Florence - Rayen (campo IdSIC)
-- MODIFICACION: (23/08/2017) - v17.3 â€“ 18451 â€“ FCB - Ingresar observaciÃ³n al motivo de egreso en SIC

CREATE TRIGGER [dbo].[HDPDeleteTriggerNEW]
ON [dbo].[EpisodioConsultas]
FOR DELETE
AS


DECLARE @usuario varchar(250)
	   ,@FechaEliminada datetime
	   ,@estacion varchar(15)

SELECT @FechaEliminada = getdate()
	  ,@estacion = host_name()
	  ,@usuario = SYSTEM_USER

INSERT INTO Consultas..EpisodioConsultasBorrados (
	   CodPaciente
      ,CodEpisodio
      ,CodEpisodioOrigen
      ,FechaConsulta
      ,CodCentroOrigen
      ,CodServicioOrigen
      ,CodCentroFinal
      ,CodServicioFinal
      ,Solicitud
      ,DictamenClinico
      ,Comentarios
      ,Inspecciones
      ,CodColectivo
      ,FechaInicial
      ,DNIMedEpi
      ,MedicoOrigen
      ,Motivo
      ,IdMotivo --ESA CHC2038
      ,FechaCierre
      ,CodDiagnosticoProvisional
      ,SalidaAlta
      ,Origen
      ,BajaTrabajo
      ,EpiAbierto
      ,DNIMedAlta
      ,CodHistoria
      ,CodProceso
      ,TipoRemision
      ,DniMedDestino
      ,FechaCPrimera
      ,PrimeraCita
      ,FechaBorrado
	  ,Estacion
	  ,Usuario
      ,IdGuiaClinica
	  ,FAsigGuia
	  ,Fecha
	  ,NIF
	  ,AyudaGuia
	  ,RecomendGuia
	  ,TratamientoGuia
	  ,PruebasGuia
	  ,FichaDatosGuia
	  ,TipoGuia
	  ,FechaPrevista
	  ,DescMotivoPasiva --ESA CHC2038
	  ,IdUnidad
	  ,codDiagnosticoPrimero
	  ,NumAutorizacion
	  ,Comunicada
	  ,fechaConfirmacion
	  ,confirmada
	  ,CodIntervencion
	  ,NifConfirmante
	  ,LibreEleccion
	  ,IDProblemaSalud
      ,NumNacionalInter
      ,codigoRYF
      ,IDEspecialidadDEIS
      ,Enfermeria
	  ,ProtocoloCRM
	  ,CheckHospital
	  ,CheckCS
	  ,codPlanGRD
	  ,CodPlanCuidados
	  ,RechazosCita
	  ,NoAsistenciasCita
	  ,NumE112
	  ,EstadoGES
	  --CHC-1852 INI
	  ,Cod_Latera
	  --CHC-1852 FIN
	  --ESA CHC2076 INI
	  ,DerivacionSIC
	  --ESA CHC2076 FIN
	  --(20/11/2014) - V4.49 â€“ 1440 â€“ APB â€“ Segunda parte DerivaciÃ³n entre instancias - INI
	  ,SICporIntegracion
	  ,CodSistema
	  --(20/11/2014) - V4.49 â€“ 1440 â€“ APB â€“ Segunda parte DerivaciÃ³n entre instancias - FIN
	  --(15/06/2015) - V4.52 â€“ 1898 â€“ APB â€“ Nuevo formato impreso SIC - INI
	  ,IdCausaInterconsulta
      ,DescCausaInterconsulta
      ,CodSubProblema
	  --(15/06/2015) - V4.52 â€“ 1898 â€“ APB â€“ Nuevo formato impreso SIC - FIN
	  ,FolioSigges
	  ,PrioridadHosp
	  ,NifPrioridadHosp
	  ,IdSIC
	  ,RUNProfEgreso
	  ,NomProfEgreso
	  ,ObservacionEgreso
)

SELECT CodPaciente
      ,CodEpisodio
      ,CodEpisodioOrigen
      ,FechaConsulta
      ,CodCentroOrigen
      ,CodServicioOrigen
      ,CodCentroFinal
      ,CodServicioFinal
      ,Solicitud
      ,DictamenClinico
      ,Comentarios
      ,Inspecciones
      ,CodColectivo
      ,FechaInicial
      ,DNIMedEpi
      ,MedicoOrigen
      ,Motivo
      ,IdMotivo --ESA CHC2038
      ,FechaCierre
      ,CodDiagnosticoProvisional
      ,SalidaAlta
      ,Origen
      ,BajaTrabajo
      ,EpiAbierto
      ,DNIMedAlta
      ,CodHistoria
      ,CodProceso
      ,TipoRemision
      ,DniMedDestino
      ,FechaCPrimera
      ,PrimeraCita
      ,@FechaEliminada
	  ,@estacion
	  ,@usuario
      ,IdGuiaClinica
	  ,FAsigGuia
	  ,Fecha
	  ,NIF
	  ,AyudaGuia
	  ,RecomendGuia
	  ,TratamientoGuia
	  ,PruebasGuia
	  ,FichaDatosGuia
	  ,TipoGuia
	  ,FechaPrevista
	  ,MC.Descripcion --ESA CHC2038
	  ,IdUnidad
	  ,codDiagnosticoPrimero
	  ,NumAutorizacion
	  ,Comunicada
	  ,fechaConfirmacion
	  ,confirmada
	  ,CodIntervencion
	  ,NifConfirmante
	  ,LibreEleccion
	  ,IDProblemaSalud
      ,NumNacionalInter
      ,codigoRYF
      ,IDEspecialidadDEIS
      ,Enfermeria
	  ,ProtocoloCRM
	  ,CheckHospital
	  ,CheckCS
	  ,codPlanGRD
	  ,CodPlanCuidados
	  ,RechazosCita
	  ,NoAsistenciasCita
	  ,NumE112
	  ,EstadoGES
	  --CHC-1852 INI
	  ,Cod_Latera
	  --CHC-1852 FIN
	  --ESA CHC2076 INI
	  ,DerivacionSIC
	  --ESA CHC2076 FIN
	  --(20/11/2014) - V4.49 â€“ 1440 â€“ APB â€“ Segunda parte DerivaciÃ³n entre instancias - INI
	  ,SICporIntegracion
	  ,CodSistema
	  --(20/11/2014) - V4.49 â€“ 1440 â€“ APB â€“ Segunda parte DerivaciÃ³n entre instancias - FIN
	  --(15/06/2015) - V4.52 â€“ 1898 â€“ APB â€“ Nuevo formato impreso SIC - INI
	  ,IdCausaInterconsulta
      ,DescCausaInterconsulta
      ,CodSubProblema
	  --(15/06/2015) - V4.52 â€“ 1898 â€“ APB â€“ Nuevo formato impreso SIC - FIN
	  ,FolioSigges
	  ,PrioridadHosp
	  ,NifPrioridadHosp
	  ,IdSIC
	  ,RUNProfEgreso
	  ,NomProfEgreso
	  ,ObservacionEgreso
FROM Deleted D
	 LEFT JOIN Parametros..MotivosCitas MC ON MC.Codigo = D.IdMotivo --ESA CHC2038

GO
GO



--dbo.SpConDDerivacionConsulta.sql

USE [Consultas]
GO

/****** Object:  StoredProcedure [dbo].[SpConDDerivacionConsulta]    Script Date: 11/07/2013 10:44:11 ******/
IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[SpConDDerivacionConsulta]') AND type in (N'P', N'PC'))
DROP PROCEDURE [dbo].[SpConDDerivacionConsulta]
GO

USE [Consultas]
GO

/****** Object:  StoredProcedure [dbo].[SpConDDerivacionConsulta]    Script Date: 11/07/2013 10:44:11 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO



/**********************************************************
PROCEDIMIENTO		: 	SpConDDerivacionConsulta
FUNCION             : 	Elimina la derivación de SIC
DEVUELVE            :	
FECHA               : 	07/11/2013
VERSION             : 	1.0
AUTOR               : 	Enrique Sánchez
APLICACIN ORIGEN   	: 	Derivación entre instancias - Derivación de SIC
TAREA				:   CHC2076 - Derivación entre instancias - Derivación de SIC Fase 1 - v4.41
MODIFICACION: (23/08/2017) - v17.3 – 18451 – FCB - Ingresar observación al motivo de egreso en SIC
***********************************************************/

CREATE Proc [dbo].[SpConDDerivacionConsulta]

	@spvar_CodPaciente char(16),
	@spvar_CodDerivacion char(5),
	@spvar_Puesto varchar(50) = '',
	@spvar_Usuario varchar(8) = '',
	@spvar_Motivo varchar(500) = ''
	,@spvar_RUNProfesional varchar(9) = null
	,@spvar_NomProfesional varchar(80) = null
	,@spvar_Observacion varchar(500) = null
	
AS

BEGIN
	--Eliminamos la fila
	DELETE consultas..DerivacionConsultas
	WHERE codpaciente = @spvar_codpaciente
	AND	codderivacion = @spvar_CodDerivacion
	
	UPDATE Consultas..DerivacionConsultasBorrados
		SET RUNProfEgreso=@spvar_RUNProfesional
			,NomProfEgreso=@spvar_NomProfesional
			,ObservacionEgreso=@spvar_Observacion
		WHERE CodPaciente = @spvar_codpaciente and 	codderivacion = @spvar_CodDerivacion
	
	--Insertamos la trazabilidad
	INSERT INTO Consultas.dbo.TrazabilidadDerivacionConsultas
           (CodPaciente
           ,CodDerivacion
           ,Usuario
           ,Puesto
           ,FCreacion
           ,FPrevista
           ,FModificacion
           ,CodCentroAnterior
           ,CodCentroNuevo
           ,FCita
           ,FCitacion
           ,FEliminacion
           ,FEliminacionCita
           ,FPasiva
           ,FActiva
           ,FCierre
           ,FAlta
           ,Asiste
           ,Motivo
           ,EliAutomaticaAusencia
           ,EliAutomaticaRechazo)
     VALUES
           (@spvar_CodPaciente --CodPaciente
           ,@spvar_CodDerivacion --CodEpisodio
           ,@spvar_Usuario --Usuario
           ,@spvar_Puesto --Puesto
           ,NULL --FCreacion
           ,NULL --FPrevista
           ,NULL --FModificacion
           ,NULL --CodCentroAnterior
           ,NULL --CodCentroNuevo
           ,NULL --FCita
           ,NULL --FCitacion
           ,GETDATE() --FEliminacion
           ,NULL --FEliminacionCita
           ,NULL --FPasiva
           ,NULL --FActiva
           ,NULL --FCierre
           ,NULL --FAlta
           ,NULL --Asiste
           ,@spvar_Motivo --Motivo
           ,NULL --EliAutomaticaAusencia
           ,NULL -- EliAutomaticaRechazo
           )         
          
END








GO



GO



--dbo.SpConDEliminaEpiCons.sql

    USE [Consultas];
    GO
    IF EXISTS 
    (
        SELECT * 
            FROM sys.procedures 
            WHERE [object_id] = OBJECT_ID('[dbo].[SpConDEliminaEpiCons]')
    )
    BEGIN
        DROP PROCEDURE [dbo].[SpConDEliminaEpiCons];
    END
    GO
    


--	PROCEDIMIENTO		: 	SpConDEliminaEpiCons
--	FUNCION             : 	Elimina el episodio de consultas
--	DEVUELVE            :	
--	FECHA               : 	24/09/2007
--	VERSION             : 	1.0
--	AUTOR               : 	Teresa L Fabuel S
--  MODIFICACION		:   
--	APLICACIN ORIGEN   	: 	Propuesta de Consultas Externas
--	REVISION			:	(09/01/2008) Teresa L Fabuel Serrano. Poner en la insert los campos de la select.
--							Ismael(06/02/2008): Añadido nuevo campo FAsigGuia
-- Modificado. azaragoza 12-03-08. Incluyo los campos Fecha y NIF en la select
-- Modificado. azaragoza 10-04-08. Incluyo los campos en la insert
-- Modificado: Ismael Sampere(07/10/2009): Trazabilidad de consultas externas
-- Modificado: Ismael Sampere(22/10/2009): Nuevo parametro de motivo de eliminacion
-- Modificado: Paco Aznar(09/09/2010): Se guarda si la eliminación de la propuesta fue automática por asistencias o rechazos
-- Modificado: v4.65 - 13486 - CCM - 13486 - Egreso de episodios de consulta externa con historia asociada
-- MODIFICACION: (23/08/2017) - v17.3 – 18451 – FCB - Ingresar observación al motivo de egreso en SIC

CREATE Proc [dbo].[SpConDEliminaEpiCons]

	@spvar_CodPaciente char(16),
	@spvar_CodEpisodio char(5),
	@spvar_Puesto varchar(50) = '',
	@spvar_Usuario varchar(8) = '',
	@spvar_Motivo varchar(500) = '',
	@spvar_EliAutoAsist bit = NULL,
	@spvar_EliAutoRechazo bit = NULL
	,@spvar_RUNProfesional varchar(9) = null
	,@spvar_NomProfesional varchar(80) = null
	,@spvar_Observacion varchar(500) = null
As

begin
	insert into consultas..historicoepisodioconsultas
	(
		 CodPaciente
		,CodEpisodio
		,CodEpisodioOrigen
		,FechaConsulta
		,CodCentroOrigen
		,CodServicioOrigen
		,CodCentroFinal
		,CodServicioFinal
		,Solicitud
		,DictamenClinico
		,Comentarios
		,Inspecciones
		,CodColectivo
		,FechaInicial
		,DNIMedEpi
		,MedicoOrigen
		,Motivo
		,FechaCierre
		,CodDiagnosticoProvisional
		,SalidaAlta
		,Origen
		,BajaTrabajo
		,EpiAbierto
		,DNIMedAlta
		,CodHistoria
		,CodProceso
		,TipoRemision
		,DniMedDestino
		,FechaCPrimera
		,PrimeraCita
		,IdGuiaClinica
		,FAsigGuia
		,Fecha
		,NIF
	    ,RUNProfEgreso
	    ,NomProfEgreso
	    ,ObservacionEgreso
	)
	select CodPaciente
		  ,CodEpisodio
		  ,CodEpisodioOrigen
		  ,FechaConsulta
		  ,CodCentroOrigen
		  ,CodServicioOrigen
		  ,CodCentroFinal
		  ,CodServicioFinal
		  ,Solicitud
		  ,DictamenClinico
		  ,Comentarios
		  ,Inspecciones
		  ,CodColectivo
		  ,FechaInicial
		  ,DNIMedEpi
		  ,MedicoOrigen
		  ,Motivo
		  ,FechaCierre
		  ,CodDiagnosticoProvisional
		  ,SalidaAlta
		  ,Origen
		  ,BajaTrabajo
		  ,EpiAbierto
		  ,DNIMedAlta
		  ,CodHistoria
		  ,CodProceso
		  ,TipoRemision
		  ,DniMedDestino
		  ,FechaCPrimera
		  ,PrimeraCita
		  ,IdGuiaClinica
		  ,FAsigGuia
		  ,Fecha
		  ,NIF
	      ,RUNProfEgreso
	      ,NomProfEgreso
	      ,ObservacionEgreso
  	from consultas..episodioconsultas
	where codpaciente = @spvar_codpaciente
		  and codepisodio = @spvar_codepisodio

-------Se controla que no se eliminen las Solicitudes con datos en la historia clinica	
	If not exists (select * from consultas..PrimeraVisita 
					where CodPaciente = @spvar_CodPaciente and CodEpisodio = @spvar_CodEpisodio)
	begin 
		delete consultas..episodioconsultas
		where codpaciente = @spvar_codpaciente
		and	codepisodio = @spvar_codepisodio

		update Consultas..EpisodioConsultasBorrados
		set RUNProfEgreso=@spvar_RUNProfesional
			,NomProfEgreso=@spvar_NomProfesional
			,ObservacionEgreso=@spvar_Observacion
		where CodPaciente = @spvar_codpaciente and CodEpisodio = @spvar_codepisodio

	end
	else 
	begin
		declare @idmotivo char(3)
		select @idmotivo = m.Codigo from Parametros..MotivosCitas m
		inner join Consultas..EpisodioConsultas e on m.CodCentro = e.CodCentroFinal
		where Descripcion = @spvar_Motivo and CodPaciente = @spvar_codpaciente and CodEpisodio = @spvar_codepisodio
		
		update Consultas..EpisodioConsultas
		set Estado = 'E',
			IdMotivo = @idmotivo,
			FechaCierre = GETDATE(),
			SalidaAlta = 0,
			EpiAbierto = 0
			,RUNProfEgreso=@spvar_RUNProfesional
			,NomProfEgreso=@spvar_NomProfesional
			,ObservacionEgreso=@spvar_Observacion
		where CodPaciente = @spvar_codpaciente and CodEpisodio = @spvar_codepisodio
	end
	
-----Fin modificacion
	
	-- Ismael(07/10/2009) Trazabilidad de consultas externas
	INSERT INTO Consultas.dbo.TrazabilidadEpisodioConsultas
           (CodPaciente
           ,CodEpisodio
           ,Usuario
           ,Puesto
           ,FCreacion
           ,FPrevista
           ,FModificacion
           ,CodCentroAnterior
           ,CodCentroNuevo
           ,FCita
           ,FCitacion
           ,FEliminacion
           ,FEliminacionCita
           ,FPasiva
           ,FActiva
           ,FCierre
           ,FAlta
           ,Asiste
           ,Motivo
           ,EliAutomaticaAusencia
           ,EliAutomaticaRechazo)
     VALUES
           (@spvar_CodPaciente --CodPaciente
           ,@spvar_CodEpisodio --CodEpisodio
           ,@spvar_Usuario --Usuario
           ,@spvar_Puesto --Puesto
           ,NULL --FCreacion
           ,NULL --FPrevista
           ,NULL --FModificacion
           ,NULL --CodCentroAnterior
           ,NULL --CodCentroNuevo
           ,NULL --FCita
           ,NULL --FCitacion
           ,GETDATE() --FEliminacion
           ,NULL --FEliminacionCita
           ,NULL --FPasiva
           ,NULL --FActiva
           ,NULL --FCierre
           ,NULL --FAlta
           ,NULL --Asiste
           ,@spvar_Motivo --Motivo
           ,@spvar_EliAutoAsist --EliAutomaticaAusencia
           ,@spvar_EliAutoRechazo -- EliAutomaticaRechazo
           )
end








    GO

GO



--dbo.SpConIQuiNuevo.sql

USE [Consultas]
GO
/****** Object:  StoredProcedure [dbo].[SpConIQuiNuevo]    Script Date: 03/08/2017 9:54:15 ******/
IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[SpConIQuiNuevo]') AND type in (N'P', N'PC'))
DROP PROCEDURE [dbo].[SpConIQuiNuevo]
GO

USE [Consultas]
GO

SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

--	PROCEDIMIENTO		: 	SpConIQuiNuevo
--	FUNCION                 		: 	Inserta un nuevo informe quirÃºrgico
--	DEVUELVE                		: 
--	FECHA                  			: 	21/12/2005
--	VERSION                 		: 	1.0
--	AUTOR                   		: 	Gerardo Prieto David (MECEMSA Consultores)
--  MODIFICACION		:   MPS 31/05/07 aÃ±adir parametros para possum
--							Jorge Poveda SÃ¡ez 10/12/2007 AÃ±ado dos campos CodExamInterven 1 y 2
--							Ismael 14/12/2007 AÃ±adido el parametro ActualizaIngreso para actualizar la fecha de
--							hospitalizacion con respecto a la de inicio de la intervencion
--							Ismael 18/12/2007 valor por defecto a los parametros por compatibilidad
--							Oscar 19/08/2008 se guarda la informaciÃ³n del paciente para kiosko
--							Pablo 31/12/2008 se aumenta el tamaÃ±o de descOperatoria
--							Ismael 27/01/2009 Actualizacion de estados de la preoperatoria para RCLE
--							Pablo GonzÃ¡lez 10/03/2009 InfoPaciente en preoperatoria
--							Pablo GonzÃ¡lez 30/03/2009 No se acualiza inforpaciente
--							26/11/2013 -  v4.41 - CTF - 73569626D - CHC3335_ModificaciÃ³n Campo Analista en InfQuirurgico 
--	APLICACIÃ“N ORIGEN   	: 	Informe quirÃºrgico
--  MODIFICACIÃ“N	: 05/09/2016 - v4.64 - 12771 - CCM - Repasar las tablas que tienen historificacion
--  MODIFICACION: 15/05/2017 - v17.2 - 16142 - FCB - Solicitud de PabellÃ³n - Registro de especialidad
--  MODIFICACION: 03/08/2017 - v17.3 - 16153 - MPR - Registro Quirurgico - Incorporar registro de Turno

CREATE Procedure [dbo].[SpConIQuiNuevo]
	
	@spvar_CodInforme Varchar(7) = NULL,
	@spvar_CodIntervencion Varchar(7),
	@spvar_CodPaciente Char(16), 
	@spvar_CodEpisodio Char(5), 
	@spvar_FSolicitud Smalldatetime, 
	@spvar_CodCirujano Char(8), 
	@spvar_CodInstrumentista Char(8), 
	@spvar_CodAyuda1 Char(8),
	@spvar_CodAyuda2 Char(8), 
	@spvar_CodAyuda3 Char(8), 
	@spvar_CodMedInforma Char(8), 
	@spvar_CodQuirofano Char(2),
	@spvar_Posicion Char(2), 
	@spvar_CodVia Char(2), 
	@spvar_CodProcedimiento Char(6), 
	@spvar_CodCIE Char(6), 
	@spvar_CodAntibiotico int,
	@spvar_TipoIntervencion Char(1), 
	@spvar_Destino Char(1), 
	@spvar_Drenaje Bit, 
	@spvar_TecnicaEmpleada Varchar(100),
	@spvar_TecnicaCierre Varchar(100), 
	@spvar_Pieza Varchar(40), 
	@spvar_HoraInicio Smalldatetime, 
	@spvar_HoraFin Smalldatetime,
	@spvar_FInforme Smalldatetime, 
	@spvar_CodMutua Char(5), 
	@spvar_Facturable Bit = 0,
	@spvar_CantidadProcesos Tinyint = 1,
	@spvar_DescOperatoria varchar(max), --Pablo
	@spvar_SolBiopsia char(10),
	@spvar_SolLaboratorio char(10),
	@spvar_SolCitologias char(10),
	@spvar_SolHormonales bit,
	@spvar_SolRadiologia char(10),
	@spvar_SolPostmortem bit,
	@spvar_Firmado bit = 0,
	@spvar_NumCordales char(2) = null,
	@spvar_CodExamInterv char(7) = null,
	@spvar_TasaMorbilidad float = null,  -- mps 
	@spvar_TasaMortalidad float = null,   -- mps 
	@spvar_CodExamInterv1 char(7) = null, --Jorge
	@spvar_CodExamInterv2 char(7) = null,  --Jorge
	@spvar_ActualizaIngreso as bit = '0',
	@spvar_InfoPaciente as varchar(4000) = null
	,@spvar_NombreAnestesista as varchar(70)=null --43
	,@spvar_CodCentro as varchar(5)   --44
	,@spvar_IdPlano tinyint =NULL
	,@spvar_IdCuadrante tinyint = NULL
	,@spvar_DNIUsuarioModifica varchar(8) = NULL
	,@spvar_idTurnoInfQuirurgico int
As
Exec SpConSQuiSusp @spvar_CodIntervencion

	if @spvar_DNIUsuarioModifica  is NULL
	BEGIN
		SET @spvar_DNIUsuarioModifica = ''
	END

	If @@RowCount = 0

		Begin
		
			If (Select CodPaciente From HClinica..Preoperatoria Where CodIntervencion = @spvar_CodIntervencion) Is Null
			
				--	Se borrÃ³ desde otro sitio la hoja de preoperatorio.
				Select 2

			Else

				Begin
					-- mps guardar los datos del possum 
					if exists(select * from hclinica..preoperatoria
								where CodIntervencion = @spvar_CodIntervencion)
					begin
					
					INSERT INTO Historificacion..HClinica_Preoperatoria
						   (CodHojaPreop, CodIntervencion, CodPaciente, CodEpisodio, CodProc,
							CodProtocolo, TipoAnestesia, JClinico, CodCIEPreop, RQuirurgico,
							ProfAntibiotica, ProfOtros, ProfTromboembolica, Region, FPreoperatoria,
							DNIMedicoPreop, DescPreop, TecPrevistas, CSuspendida, FPrevista,
							Ambulatoria, Tipo, PreopCompleto, FIntervencion, Autotransfusion,
							VistoBueno, MedicoRemite, CodMutua, Anestesista, FConsentInterv,
							FConsentProtesis, CodCenRemite, Preanestesia, FPasivo, DiasLEspera,
							NecesHemoderiv, UsuHemoderiv, CodHistoria, Eliminado, Servicio,
							FechaFirma, FechaUltimaAct, DescProtocolo, CiruMenor, TiempoOper,
							CodProtocolo2, DescProtocolo2, CodProtocolo3, DescProtocolo3, cma, 
							MotivoPreferente, Estado, JornadaExtra, DniASQ, FEliminada, FSuspendida,
							TasaMorbilidad, TasaMortalidad, Lateralidad, ResaltaPlaning, CodExamInterven,
							TieneImagen, Factivo, FultimoPasivo, JornadaExtraVali, DniASQVali,
							ObservacionesPreoper, Confirmacion, EliminadoPlan, CMAsinHDIA,
							CodigoGRD, PesoGRD, Complejidad, RequiereUvi, EstadoRCLE, InfoPaciente,
							dniInfoPacMed, dniInfoPacEnf, dniInfoPacAnes, FInfoPaciente, ObsEnfermeria,
							Neoplasia, DniCirujanoPrevisto, AvisadoPac, ObservacionesAvisadoPac,
							DniAvisadoPac, CodAvisoPac, ComplejidadPreop, IntervencionEspecial,
							UHD, TieneEquipo, CentroDestino, TipoCenRemite, ServicioOrigen,
							Ayudantes, AlergiaLatex, RequiereIngreso, TieneProtesis, Infeccioso,
							Preparatoria, DNISuspendida, DNIEliminada, FecModificacionPreop,
							CiruAUrgente, DniAyudantePrevisto, AvisoPlanificar, FPrevistaIntervencion,
							NumListaRCLE, EsSincronizadoRCLE, PacFirmaConsen, NumSuspensiones,
							Observaciones, Pagado, CodMotivoPreferente, IdPlano, IdCuadrante,
							EsReIntervencion, DescReIntervencion, Validado, FCreacionHistorico, DNIUsuarioModifica 
							,CodEspecialidadUrg )
					 SELECT Prp.CodHojaPreop, Prp.CodIntervencion, Prp.CodPaciente, Prp.CodEpisodio, Prp.CodProc,
							Prp.CodProtocolo, Prp.TipoAnestesia, Prp.JClinico, Prp.CodCIEPreop, Prp.RQuirurgico,
							Prp.ProfAntibiotica, Prp.ProfOtros, Prp.ProfTromboembolica, Prp.Region, Prp.FPreoperatoria,
							Prp.DNIMedicoPreop, Prp.DescPreop, Prp.TecPrevistas, Prp.CSuspendida, Prp.FPrevista,
							Prp.Ambulatoria, Prp.Tipo, Prp.PreopCompleto, Prp.FIntervencion, Prp.Autotransfusion,
							Prp.VistoBueno, Prp.MedicoRemite, Prp.CodMutua, Prp.Anestesista, Prp.FConsentInterv,
							Prp.FConsentProtesis, Prp.CodCenRemite, Prp.Preanestesia, Prp.FPasivo, Prp.DiasLEspera,
							Prp.NecesHemoderiv, Prp.UsuHemoderiv, Prp.CodHistoria, Prp.Eliminado, Prp.Servicio,
							Prp.FechaFirma, Prp.FechaUltimaAct, Prp.DescProtocolo, Prp.CiruMenor, Prp.TiempoOper,
							Prp.CodProtocolo2, Prp.DescProtocolo2, Prp.CodProtocolo3, Prp.DescProtocolo3, Prp.cma, 
							Prp.MotivoPreferente, Prp.Estado, Prp.JornadaExtra, Prp.DniASQ, Prp.FEliminada, Prp.FSuspendida,
							Prp.TasaMorbilidad, Prp.TasaMortalidad, Prp.Lateralidad, Prp.ResaltaPlaning, Prp.CodExamInterven,
							Prp.TieneImagen, Prp.Factivo, Prp.FultimoPasivo, Prp.JornadaExtraVali, Prp.DniASQVali,
							Prp.ObservacionesPreoper, Prp.Confirmacion, Prp.EliminadoPlan, Prp.CMAsinHDIA,
							Prp.CodigoGRD, Prp.PesoGRD, Prp.Complejidad, Prp.RequiereUvi, Prp.EstadoRCLE, Prp.InfoPaciente,
							Prp.dniInfoPacMed, Prp.dniInfoPacEnf, Prp.dniInfoPacAnes, Prp.FInfoPaciente, Prp.ObsEnfermeria,
							Prp.Neoplasia, Prp.DniCirujanoPrevisto, Prp.AvisadoPac, Prp.ObservacionesAvisadoPac,
							Prp.DniAvisadoPac, Prp.CodAvisoPac, Prp.ComplejidadPreop, Prp.IntervencionEspecial,
							Prp.UHD, Prp.TieneEquipo, Prp.CentroDestino, Prp.TipoCenRemite, Prp.ServicioOrigen,
							Prp.Ayudantes, Prp.AlergiaLatex, Prp.RequiereIngreso, Prp.TieneProtesis, Prp.Infeccioso,
							Prp.Preparatoria, Prp.DNISuspendida, Prp.DNIEliminada, Prp.FecModificacionPreop,
							Prp.CiruAUrgente, Prp.DniAyudantePrevisto, Prp.AvisoPlanificar, Prp.FPrevistaIntervencion,
							Prp.NumListaRCLE, Prp.EsSincronizadoRCLE, Prp.PacFirmaConsen, Prp.NumSuspensiones,
							Prp.Observaciones, Prp.Pagado, Prp.CodMotivoPreferente, Prp.IdPlano, Prp.IdCuadrante,
							Prp.EsReIntervencion, Prp.DescReIntervencion, Prp.Validado, GetDate(), @spvar_DNIUsuarioModifica 
							,Prp.CodEspecialidadUrg
					   FROM HClinica..Preoperatoria Prp
					   WHERE CodIntervencion = @spvar_CodIntervencion
									
					
						update hclinica..preoperatoria
						set TasaMorbilidad = @spvar_TasaMorbilidad,
							TasaMortalidad = @spvar_TasaMortalidad
						where CodIntervencion = @spvar_CodIntervencion
					end

					--Ismael(27/01/2009) Actualizacion de estados de la preoperatoria para RCLE
					if @spvar_Firmado = '1'
					begin
						declare @Tipo as char(1)
						
						select @Tipo = Tipo 
						from hclinica..preoperatoria
						where CodIntervencion = @spvar_CodIntervencion
					
						if @Tipo = parametros.dbo.fnParValorConstante('m_strCodTipoUrgente')
						begin
							INSERT INTO Historificacion..HClinica_Preoperatoria
									   (CodHojaPreop, CodIntervencion, CodPaciente, CodEpisodio, CodProc,
										CodProtocolo, TipoAnestesia, JClinico, CodCIEPreop, RQuirurgico,
										ProfAntibiotica, ProfOtros, ProfTromboembolica, Region, FPreoperatoria,
										DNIMedicoPreop, DescPreop, TecPrevistas, CSuspendida, FPrevista,
										Ambulatoria, Tipo, PreopCompleto, FIntervencion, Autotransfusion,
										VistoBueno, MedicoRemite, CodMutua, Anestesista, FConsentInterv,
										FConsentProtesis, CodCenRemite, Preanestesia, FPasivo, DiasLEspera,
										NecesHemoderiv, UsuHemoderiv, CodHistoria, Eliminado, Servicio,
										FechaFirma, FechaUltimaAct, DescProtocolo, CiruMenor, TiempoOper,
										CodProtocolo2, DescProtocolo2, CodProtocolo3, DescProtocolo3, cma, 
										MotivoPreferente, Estado, JornadaExtra, DniASQ, FEliminada, FSuspendida,
										TasaMorbilidad, TasaMortalidad, Lateralidad, ResaltaPlaning, CodExamInterven,
										TieneImagen, Factivo, FultimoPasivo, JornadaExtraVali, DniASQVali,
										ObservacionesPreoper, Confirmacion, EliminadoPlan, CMAsinHDIA,
										CodigoGRD, PesoGRD, Complejidad, RequiereUvi, EstadoRCLE, InfoPaciente,
										dniInfoPacMed, dniInfoPacEnf, dniInfoPacAnes, FInfoPaciente, ObsEnfermeria,
										Neoplasia, DniCirujanoPrevisto, AvisadoPac, ObservacionesAvisadoPac,
										DniAvisadoPac, CodAvisoPac, ComplejidadPreop, IntervencionEspecial,
										UHD, TieneEquipo, CentroDestino, TipoCenRemite, ServicioOrigen,
										Ayudantes, AlergiaLatex, RequiereIngreso, TieneProtesis, Infeccioso,
										Preparatoria, DNISuspendida, DNIEliminada, FecModificacionPreop,
										CiruAUrgente, DniAyudantePrevisto, AvisoPlanificar, FPrevistaIntervencion,
										NumListaRCLE, EsSincronizadoRCLE, PacFirmaConsen, NumSuspensiones,
										Observaciones, Pagado, CodMotivoPreferente, IdPlano, IdCuadrante,
										EsReIntervencion, DescReIntervencion, Validado, FCreacionHistorico, DNIUsuarioModifica )
								 SELECT Prp.CodHojaPreop, Prp.CodIntervencion, Prp.CodPaciente, Prp.CodEpisodio, Prp.CodProc,
										Prp.CodProtocolo, Prp.TipoAnestesia, Prp.JClinico, Prp.CodCIEPreop, Prp.RQuirurgico,
										Prp.ProfAntibiotica, Prp.ProfOtros, Prp.ProfTromboembolica, Prp.Region, Prp.FPreoperatoria,
										Prp.DNIMedicoPreop, Prp.DescPreop, Prp.TecPrevistas, Prp.CSuspendida, Prp.FPrevista,
										Prp.Ambulatoria, Prp.Tipo, Prp.PreopCompleto, Prp.FIntervencion, Prp.Autotransfusion,
										Prp.VistoBueno, Prp.MedicoRemite, Prp.CodMutua, Prp.Anestesista, Prp.FConsentInterv,
										Prp.FConsentProtesis, Prp.CodCenRemite, Prp.Preanestesia, Prp.FPasivo, Prp.DiasLEspera,
										Prp.NecesHemoderiv, Prp.UsuHemoderiv, Prp.CodHistoria, Prp.Eliminado, Prp.Servicio,
										Prp.FechaFirma, Prp.FechaUltimaAct, Prp.DescProtocolo, Prp.CiruMenor, Prp.TiempoOper,
										Prp.CodProtocolo2, Prp.DescProtocolo2, Prp.CodProtocolo3, Prp.DescProtocolo3, Prp.cma, 
										Prp.MotivoPreferente, Prp.Estado, Prp.JornadaExtra, Prp.DniASQ, Prp.FEliminada, Prp.FSuspendida,
										Prp.TasaMorbilidad, Prp.TasaMortalidad, Prp.Lateralidad, Prp.ResaltaPlaning, Prp.CodExamInterven,
										Prp.TieneImagen, Prp.Factivo, Prp.FultimoPasivo, Prp.JornadaExtraVali, Prp.DniASQVali,
										Prp.ObservacionesPreoper, Prp.Confirmacion, Prp.EliminadoPlan, Prp.CMAsinHDIA,
										Prp.CodigoGRD, Prp.PesoGRD, Prp.Complejidad, Prp.RequiereUvi, Prp.EstadoRCLE, Prp.InfoPaciente,
										Prp.dniInfoPacMed, Prp.dniInfoPacEnf, Prp.dniInfoPacAnes, Prp.FInfoPaciente, Prp.ObsEnfermeria,
										Prp.Neoplasia, Prp.DniCirujanoPrevisto, Prp.AvisadoPac, Prp.ObservacionesAvisadoPac,
										Prp.DniAvisadoPac, Prp.CodAvisoPac, Prp.ComplejidadPreop, Prp.IntervencionEspecial,
										Prp.UHD, Prp.TieneEquipo, Prp.CentroDestino, Prp.TipoCenRemite, Prp.ServicioOrigen,
										Prp.Ayudantes, Prp.AlergiaLatex, Prp.RequiereIngreso, Prp.TieneProtesis, Prp.Infeccioso,
										Prp.Preparatoria, Prp.DNISuspendida, Prp.DNIEliminada, Prp.FecModificacionPreop,
										Prp.CiruAUrgente, Prp.DniAyudantePrevisto, Prp.AvisoPlanificar, Prp.FPrevistaIntervencion,
										Prp.NumListaRCLE, Prp.EsSincronizadoRCLE, Prp.PacFirmaConsen, Prp.NumSuspensiones,
										Prp.Observaciones, Prp.Pagado, Prp.CodMotivoPreferente, Prp.IdPlano, Prp.IdCuadrante,
										Prp.EsReIntervencion, Prp.DescReIntervencion, Prp.Validado, GetDate(), @spvar_DNIUsuarioModifica 
								   FROM HClinica..Preoperatoria Prp
								   WHERE CodIntervencion = @spvar_CodIntervencion
						
							update hclinica..preoperatoria
							set EstadoRCLE = parametros.dbo.fnParValorConstante('m_strEstadoRCLEFirmaU')
							where CodIntervencion = @spvar_CodIntervencion							
						end
						else
						begin
						
								INSERT INTO Historificacion..HClinica_Preoperatoria
								   (CodHojaPreop, CodIntervencion, CodPaciente, CodEpisodio, CodProc,
									CodProtocolo, TipoAnestesia, JClinico, CodCIEPreop, RQuirurgico,
									ProfAntibiotica, ProfOtros, ProfTromboembolica, Region, FPreoperatoria,
									DNIMedicoPreop, DescPreop, TecPrevistas, CSuspendida, FPrevista,
									Ambulatoria, Tipo, PreopCompleto, FIntervencion, Autotransfusion,
									VistoBueno, MedicoRemite, CodMutua, Anestesista, FConsentInterv,
									FConsentProtesis, CodCenRemite, Preanestesia, FPasivo, DiasLEspera,
									NecesHemoderiv, UsuHemoderiv, CodHistoria, Eliminado, Servicio,
									FechaFirma, FechaUltimaAct, DescProtocolo, CiruMenor, TiempoOper,
									CodProtocolo2, DescProtocolo2, CodProtocolo3, DescProtocolo3, cma, 
									MotivoPreferente, Estado, JornadaExtra, DniASQ, FEliminada, FSuspendida,
									TasaMorbilidad, TasaMortalidad, Lateralidad, ResaltaPlaning, CodExamInterven,
									TieneImagen, Factivo, FultimoPasivo, JornadaExtraVali, DniASQVali,
									ObservacionesPreoper, Confirmacion, EliminadoPlan, CMAsinHDIA,
									CodigoGRD, PesoGRD, Complejidad, RequiereUvi, EstadoRCLE, InfoPaciente,
									dniInfoPacMed, dniInfoPacEnf, dniInfoPacAnes, FInfoPaciente, ObsEnfermeria,
									Neoplasia, DniCirujanoPrevisto, AvisadoPac, ObservacionesAvisadoPac,
									DniAvisadoPac, CodAvisoPac, ComplejidadPreop, IntervencionEspecial,
									UHD, TieneEquipo, CentroDestino, TipoCenRemite, ServicioOrigen,
									Ayudantes, AlergiaLatex, RequiereIngreso, TieneProtesis, Infeccioso,
									Preparatoria, DNISuspendida, DNIEliminada, FecModificacionPreop,
									CiruAUrgente, DniAyudantePrevisto, AvisoPlanificar, FPrevistaIntervencion,
									NumListaRCLE, EsSincronizadoRCLE, PacFirmaConsen, NumSuspensiones,
									Observaciones, Pagado, CodMotivoPreferente, IdPlano, IdCuadrante,
									EsReIntervencion, DescReIntervencion, Validado, FCreacionHistorico, DNIUsuarioModifica )
							 SELECT Prp.CodHojaPreop, Prp.CodIntervencion, Prp.CodPaciente, Prp.CodEpisodio, Prp.CodProc,
									Prp.CodProtocolo, Prp.TipoAnestesia, Prp.JClinico, Prp.CodCIEPreop, Prp.RQuirurgico,
									Prp.ProfAntibiotica, Prp.ProfOtros, Prp.ProfTromboembolica, Prp.Region, Prp.FPreoperatoria,
									Prp.DNIMedicoPreop, Prp.DescPreop, Prp.TecPrevistas, Prp.CSuspendida, Prp.FPrevista,
									Prp.Ambulatoria, Prp.Tipo, Prp.PreopCompleto, Prp.FIntervencion, Prp.Autotransfusion,
									Prp.VistoBueno, Prp.MedicoRemite, Prp.CodMutua, Prp.Anestesista, Prp.FConsentInterv,
									Prp.FConsentProtesis, Prp.CodCenRemite, Prp.Preanestesia, Prp.FPasivo, Prp.DiasLEspera,
									Prp.NecesHemoderiv, Prp.UsuHemoderiv, Prp.CodHistoria, Prp.Eliminado, Prp.Servicio,
									Prp.FechaFirma, Prp.FechaUltimaAct, Prp.DescProtocolo, Prp.CiruMenor, Prp.TiempoOper,
									Prp.CodProtocolo2, Prp.DescProtocolo2, Prp.CodProtocolo3, Prp.DescProtocolo3, Prp.cma, 
									Prp.MotivoPreferente, Prp.Estado, Prp.JornadaExtra, Prp.DniASQ, Prp.FEliminada, Prp.FSuspendida,
									Prp.TasaMorbilidad, Prp.TasaMortalidad, Prp.Lateralidad, Prp.ResaltaPlaning, Prp.CodExamInterven,
									Prp.TieneImagen, Prp.Factivo, Prp.FultimoPasivo, Prp.JornadaExtraVali, Prp.DniASQVali,
									Prp.ObservacionesPreoper, Prp.Confirmacion, Prp.EliminadoPlan, Prp.CMAsinHDIA,
									Prp.CodigoGRD, Prp.PesoGRD, Prp.Complejidad, Prp.RequiereUvi, Prp.EstadoRCLE, Prp.InfoPaciente,
									Prp.dniInfoPacMed, Prp.dniInfoPacEnf, Prp.dniInfoPacAnes, Prp.FInfoPaciente, Prp.ObsEnfermeria,
									Prp.Neoplasia, Prp.DniCirujanoPrevisto, Prp.AvisadoPac, Prp.ObservacionesAvisadoPac,
									Prp.DniAvisadoPac, Prp.CodAvisoPac, Prp.ComplejidadPreop, Prp.IntervencionEspecial,
									Prp.UHD, Prp.TieneEquipo, Prp.CentroDestino, Prp.TipoCenRemite, Prp.ServicioOrigen,
									Prp.Ayudantes, Prp.AlergiaLatex, Prp.RequiereIngreso, Prp.TieneProtesis, Prp.Infeccioso,
									Prp.Preparatoria, Prp.DNISuspendida, Prp.DNIEliminada, Prp.FecModificacionPreop,
									Prp.CiruAUrgente, Prp.DniAyudantePrevisto, Prp.AvisoPlanificar, Prp.FPrevistaIntervencion,
									Prp.NumListaRCLE, Prp.EsSincronizadoRCLE, Prp.PacFirmaConsen, Prp.NumSuspensiones,
									Prp.Observaciones, Prp.Pagado, Prp.CodMotivoPreferente, Prp.IdPlano, Prp.IdCuadrante,
									Prp.EsReIntervencion, Prp.DescReIntervencion, Prp.Validado, GetDate(), @spvar_DNIUsuarioModifica 
							   FROM HClinica..Preoperatoria Prp
							   WHERE CodIntervencion = @spvar_CodIntervencion
								
							update hclinica..preoperatoria
							set EstadoRCLE = parametros.dbo.fnParValorConstante('m_strEstadoRCLEFirmaPP')
							where CodIntervencion = @spvar_CodIntervencion
						end
 					end

					--	Si no se facilita el cÃ³digo de informe (informe nuevo), se genera un cÃ³digo nuevo.
					If @spvar_CodInforme Is Null

						Begin

							--	Obtener el nuevo cÃ³digo de informe.
							Declare @Numero Varchar(5)
							Declare @Anyo Varchar(2)

							Select @Anyo = substring(convert(varchar(4),datepart(yy,getdate())),3,2)

							Select 
								@Numero =convert(varchar(5), IsNull(Max(convert(int,SubString(CodInforme,3,5)))+1,1))
							From 
								HClinica..InformeQuirurgico		
							Where
								CodInforme Like @Anyo + '%'

							Select @spvar_CodInforme = convert(varchar(7), @Anyo + stuff('00000', 6-DataLength(@Numero), DataLength(@Numero), @Numero))	

						End			

					--	Borrado de cualquier informe previo.
					Delete From HClinica..InformeQuirurgico
					Where 
						CodIntervencion = @spvar_CodIntervencion

					-- Para asegurarnos de que no inserta un Codigo de Mutua null
					If @spvar_CodMutua is null
					begin
						Select @spvar_CodMutua = CodMutua
						From HClinica..Preoperatoria
						Where CodIntervencion = @spvar_CodIntervencion
					end

					-- Para asegurarnos de que no inserta un Codigo de Procedimiento null
					If @spvar_CodProcedimiento is null
					begin
						Select @spvar_CodProcedimiento = CodProc
						From HClinica..Preoperatoria
						Where CodIntervencion = @spvar_CodIntervencion
					end


					--CTF - 73569626D - CHC3335_ModificaciÃ³n Campo Analista en InfQuirurgico - INI
					IF (SELECT ValorConstante FROM Parametros..constantes WHERE NombreConstante = 'm_bolAnestesiologia' and CentroRef=@spvar_CodCentro)=1 
						BEGIN
							Select @spvar_NombreAnestesista = null
						END
					--CTF - 73569626D - CHC3335_ModificaciÃ³n Campo Analista en InfQuirurgico - FIN

					--	InserciÃ³n de los datos en la tabla.
					Insert HClinica..InformeQuirurgico (
						CodIntervencion,
						CodInforme,
						CodPaciente, 
						CodEpisodio, 
						FSolicitud, 
						CodCirujano,
						CodInstrumentista,
                        CodAyudante1, 
						CodAyudante2, 
						CodAyudante3, 
                        CodMedInforma, 
						CodQuirofano, 
						PosicionInter,
                        CodVia, 
						CodProcedimiento, 
						CodPostCIE,
                        CodAntibioticos, 
						TipoInter, 
						DestinoInter,
						Drenaje, 
						TecnicasEmpleadas, 
                        TecnicaCierre, 
						PiezaExtirpada, 
						HInicioInter,
                        HFinInter, 
						FInforme,
						CodMutua, 
						Facturable,
                        CantidadProcesos,
						DescOperatoria,
						SolBiopsia,
						SolLaboratorio,
						SolCitologias,
						SolHormonales,
						SolRadiologia,
						SolPostmortem,
						Firmado,
						NumCordales,
						CodExamInterven,
						CodExamInterven1,
						CodExamInterven2
						--InfoPaciente
						--CTF - 73569626D - CHC3335_ModificaciÃ³n Campo Analista en InfQuirurgico 
						,NombreAnestesista
						--(08/09/2015) - v4.53r1 - 2500 - VAS - Plano y extremidad de intervenciones quirÃºrgicas - INI
					    ,IdPlano 
					    ,IdCuadrante 
					    --(08/09/2015) - v4.53r1 - 2500 - VAS - Plano y extremidad de intervenciones quirÃºrgicas - FIN
						,IdTurnoInfQuirurgico
					)  
                   	Values (
						@spvar_CodIntervencion,
						@spvar_CodInforme,
						@spvar_CodPaciente, 
						@spvar_CodEpisodio, 
						@spvar_FSolicitud, 
						@spvar_CodCirujano, 
						@spvar_CodInstrumentista, 
                        @spvar_CodAyuda1, 
						@spvar_CodAyuda2, 
						@spvar_CodAyuda3, 
						@spvar_CodMedInforma, 
                        @spvar_CodQuirofano, 
						@spvar_Posicion, 
						@spvar_CodVia, 
						@spvar_CodProcedimiento, 
						@spvar_CodCIE, 	
						@spvar_CodAntibiotico,
                        @spvar_TipoIntervencion, 
						@spvar_Destino, 
						@spvar_Drenaje, 
						@spvar_TecnicaEmpleada, 
						@spvar_TecnicaCierre, 
                        @spvar_Pieza, 
						@spvar_HoraInicio, 
						@spvar_HoraFin, 
						@spvar_FInforme,
						@spvar_CodMutua, 
						@spvar_Facturable,
                        @spvar_CantidadProcesos,
						@spvar_DescOperatoria,
						@spvar_SolBiopsia,
						@spvar_SolLaboratorio,
						@spvar_SolCitologias,
						@spvar_SolHormonales,
						@spvar_SolRadiologia,
						@spvar_SolPostmortem,
						@spvar_Firmado,
						@spvar_NumCordales,
					    @spvar_CodExamInterv,
						@spvar_CodExamInterv1,
						@spvar_CodExamInterv2
						--@spvar_InfoPaciente
						--CTF - 73569626D - CHC3335_ModificaciÃ³n Campo Analista en InfQuirurgico 
						,@spvar_NombreAnestesista
						--(08/09/2015) - v4.53r1 - 2500 - VAS - Plano y extremidad de intervenciones quirÃºrgicas - INI
						,@spvar_IdPlano
						,@spvar_IdCuadrante
						--(08/09/2015) - v4.53r1 - 2500 - VAS - Plano y extremidad de intervenciones quirÃºrgicas - FIN
						,@spvar_idTurnoInfQuirurgico
					)

					--	Actualizar la fecha de la intervenciÃ³n en la hoja preoperatoria.
					
					
					INSERT INTO Historificacion..HClinica_Preoperatoria
						   (CodHojaPreop, CodIntervencion, CodPaciente, CodEpisodio, CodProc,
							CodProtocolo, TipoAnestesia, JClinico, CodCIEPreop, RQuirurgico,
							ProfAntibiotica, ProfOtros, ProfTromboembolica, Region, FPreoperatoria,
							DNIMedicoPreop, DescPreop, TecPrevistas, CSuspendida, FPrevista,
							Ambulatoria, Tipo, PreopCompleto, FIntervencion, Autotransfusion,
							VistoBueno, MedicoRemite, CodMutua, Anestesista, FConsentInterv,
							FConsentProtesis, CodCenRemite, Preanestesia, FPasivo, DiasLEspera,
							NecesHemoderiv, UsuHemoderiv, CodHistoria, Eliminado, Servicio,
							FechaFirma, FechaUltimaAct, DescProtocolo, CiruMenor, TiempoOper,
							CodProtocolo2, DescProtocolo2, CodProtocolo3, DescProtocolo3, cma, 
							MotivoPreferente, Estado, JornadaExtra, DniASQ, FEliminada, FSuspendida,
							TasaMorbilidad, TasaMortalidad, Lateralidad, ResaltaPlaning, CodExamInterven,
							TieneImagen, Factivo, FultimoPasivo, JornadaExtraVali, DniASQVali,
							ObservacionesPreoper, Confirmacion, EliminadoPlan, CMAsinHDIA,
							CodigoGRD, PesoGRD, Complejidad, RequiereUvi, EstadoRCLE, InfoPaciente,
							dniInfoPacMed, dniInfoPacEnf, dniInfoPacAnes, FInfoPaciente, ObsEnfermeria,
							Neoplasia, DniCirujanoPrevisto, AvisadoPac, ObservacionesAvisadoPac,
							DniAvisadoPac, CodAvisoPac, ComplejidadPreop, IntervencionEspecial,
							UHD, TieneEquipo, CentroDestino, TipoCenRemite, ServicioOrigen,
							Ayudantes, AlergiaLatex, RequiereIngreso, TieneProtesis, Infeccioso,
							Preparatoria, DNISuspendida, DNIEliminada, FecModificacionPreop,
							CiruAUrgente, DniAyudantePrevisto, AvisoPlanificar, FPrevistaIntervencion,
							NumListaRCLE, EsSincronizadoRCLE, PacFirmaConsen, NumSuspensiones,
							Observaciones, Pagado, CodMotivoPreferente, IdPlano, IdCuadrante,
							EsReIntervencion, DescReIntervencion, Validado, FCreacionHistorico, DNIUsuarioModifica )
					 SELECT Prp.CodHojaPreop, Prp.CodIntervencion, Prp.CodPaciente, Prp.CodEpisodio, Prp.CodProc,
							Prp.CodProtocolo, Prp.TipoAnestesia, Prp.JClinico, Prp.CodCIEPreop, Prp.RQuirurgico,
							Prp.ProfAntibiotica, Prp.ProfOtros, Prp.ProfTromboembolica, Prp.Region, Prp.FPreoperatoria,
							Prp.DNIMedicoPreop, Prp.DescPreop, Prp.TecPrevistas, Prp.CSuspendida, Prp.FPrevista,
							Prp.Ambulatoria, Prp.Tipo, Prp.PreopCompleto, Prp.FIntervencion, Prp.Autotransfusion,
							Prp.VistoBueno, Prp.MedicoRemite, Prp.CodMutua, Prp.Anestesista, Prp.FConsentInterv,
							Prp.FConsentProtesis, Prp.CodCenRemite, Prp.Preanestesia, Prp.FPasivo, Prp.DiasLEspera,
							Prp.NecesHemoderiv, Prp.UsuHemoderiv, Prp.CodHistoria, Prp.Eliminado, Prp.Servicio,
							Prp.FechaFirma, Prp.FechaUltimaAct, Prp.DescProtocolo, Prp.CiruMenor, Prp.TiempoOper,
							Prp.CodProtocolo2, Prp.DescProtocolo2, Prp.CodProtocolo3, Prp.DescProtocolo3, Prp.cma, 
							Prp.MotivoPreferente, Prp.Estado, Prp.JornadaExtra, Prp.DniASQ, Prp.FEliminada, Prp.FSuspendida,
							Prp.TasaMorbilidad, Prp.TasaMortalidad, Prp.Lateralidad, Prp.ResaltaPlaning, Prp.CodExamInterven,
							Prp.TieneImagen, Prp.Factivo, Prp.FultimoPasivo, Prp.JornadaExtraVali, Prp.DniASQVali,
							Prp.ObservacionesPreoper, Prp.Confirmacion, Prp.EliminadoPlan, Prp.CMAsinHDIA,
							Prp.CodigoGRD, Prp.PesoGRD, Prp.Complejidad, Prp.RequiereUvi, Prp.EstadoRCLE, Prp.InfoPaciente,
							Prp.dniInfoPacMed, Prp.dniInfoPacEnf, Prp.dniInfoPacAnes, Prp.FInfoPaciente, Prp.ObsEnfermeria,
							Prp.Neoplasia, Prp.DniCirujanoPrevisto, Prp.AvisadoPac, Prp.ObservacionesAvisadoPac,
							Prp.DniAvisadoPac, Prp.CodAvisoPac, Prp.ComplejidadPreop, Prp.IntervencionEspecial,
							Prp.UHD, Prp.TieneEquipo, Prp.CentroDestino, Prp.TipoCenRemite, Prp.ServicioOrigen,
							Prp.Ayudantes, Prp.AlergiaLatex, Prp.RequiereIngreso, Prp.TieneProtesis, Prp.Infeccioso,
							Prp.Preparatoria, Prp.DNISuspendida, Prp.DNIEliminada, Prp.FecModificacionPreop,
							Prp.CiruAUrgente, Prp.DniAyudantePrevisto, Prp.AvisoPlanificar, Prp.FPrevistaIntervencion,
							Prp.NumListaRCLE, Prp.EsSincronizadoRCLE, Prp.PacFirmaConsen, Prp.NumSuspensiones,
							Prp.Observaciones, Prp.Pagado, Prp.CodMotivoPreferente, Prp.IdPlano, Prp.IdCuadrante,
							Prp.EsReIntervencion, Prp.DescReIntervencion, Prp.Validado, GetDate(), @spvar_DNIUsuarioModifica 
					   FROM HClinica..Preoperatoria Prp
					   WHERE CodIntervencion = @spvar_CodIntervencion
					
					
					Update 
						HClinica..Preoperatoria
					Set 
						FIntervencion = @spvar_HoraInicio
					Where 
						CodIntervencion = @spvar_CodIntervencion

					-- Actualizamos la fecha de ingreso si es posterior al inicio de la intervencion
					if @spvar_ActualizaIngreso = '1'
					begin
						update ingresos..episodiohospitalizacion
						set FechaHospitalizacion = @spvar_HoraInicio
						where CodPaciente = @spvar_CodPaciente and CodEpisodio = @spvar_CodEpisodio 
					end
					
					Select 0

				End

		End

	Else

		Select 1
		
/* 01/04/2009		JGALVEZ		ENIAC1/PREPROD		Command(s) completed successfully */




GO



--dbo.SpConSDerivacionesSICFechas1.sql

USE [Consultas]
GO

/****** Object:  StoredProcedure [dbo].[SpConSDerivacionesSICFechas1]    Script Date: 06/29/2015 08:14:02 ******/
IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[SpConSDerivacionesSICFechas1]') AND type in (N'P', N'PC'))
DROP PROCEDURE [dbo].[SpConSDerivacionesSICFechas1]
GO

USE [Consultas]
GO

/****** Object:  StoredProcedure [dbo].[SpConSDerivacionesSICFechas1]    Script Date: 06/29/2015 08:14:02 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO


/*
***********************************************************************
PROCEDIMIENTO : SpConSDerivacionesSICFechas1
FUNCION		  : Busca las derivaciones de SIC filtrando por CodHistoria, Tarjeta Sanitaria y las opciones de citación
DEVUELVE	  :
FECHA		  : 30/10/2013
VERSION		  : 1.0
AUTOR		  : Enrique Sánchez
TAREA		  : CHC2076 - Derivación SIC - v4.41.1
MODIFICACION  : (29/08/2014) - v4.46r2 - 1247 - RRG - Incluir estado de confirmacion de asistencia - REQ 53268
MODIFICACIÓN  : (30/10/2014) - V4.48 - 1169 - VAS - Citas espontáneas
MODIFICACIÓN  : (20/11/2014) - V4.48 - 1489 - VAS - Iconos estado SIC en Gestor Interconsultas
MODIFICACIÓN  : (20/11/2014) Alberto Pagán Benedicto - V4.49 - 1440 - APB - Segunda parte Derivación entre instancias
MODIFICACIÓN  : (08/01/2015) --V4.49 – 1440 – ACT – Segunda parte Derivación entre instancias
MODIFICACION:	(22/06/2015) v4.52 - 1899 - SGN - Problema distribución cupos florence
MODIFICACION  : (16/11/2015) v4.55r1 - 2696 - CCM - Impresión múltiples SIC
MODIFICACION  : (09/05/2017) - 17.2 - 16146 - SGH - Incluir Nombre Social del Paciente
MODIFICACION  : (19/05/2017) - 17.2 - 16506 - SGH - Filtros Prais Listados Sol. Interconsultas e Intervenciones
MODIFICACION  : (26/05/2017) - 17.2 - 16112 - SGH - Modificar reporte de gestor de interconsultas
MODIFICACION  : (23/08/2017) - v17.3 – 18451 – FCB - Ingresar observación al motivo de egreso en SIC
***********************************************************************
*/

CREATE PROCEDURE [dbo].[SpConSDerivacionesSICFechas1]
	 @spvar_CodHistoria char(8) = null
	,@spvar_TSanitaria char(16) = null
	,@spvar_Citados	bit = 0
	,@spvar_NoCitados bit = 0
	,@spvar_FecCita	smalldatetime = null
	,@spvar_FecCitaDesde smalldatetime = null
	,@spvar_FecCitaHasta smalldatetime = null
	,@spvar_FechaPrevistaDesde smalldatetime = null
	,@spvar_FechaPrevistaHasta smalldatetime = null
	,@spvar_AUGE bit = null
	,@spvar_FecSolDesde	smalldatetime = null
	,@spvar_FecSolHasta	smalldatetime = null
	,@spvar_Reservadas bit = 0
	,@spvar_Confirmadas bit = 0
	,@spvar_Comunicadas bit = 0
	,@spvar_SinComunicar bit = 0
	,@spvar_LibreEleccion bit = null
	,@spvar_DniMedicoOrigen char(8) = null
	,@spvar_NumFilasCCEE int = null
	,@spvar_ConfAsistencia bit = 0 
	,@spvar_CitaEspontanea bit = 0 
AS

declare @CodPaciente char(16) 

--Aplicamos máximo de filas si este parámetro trae algún valor.
if @spvar_NumFilasCCEE is not null
	set rowcount @spvar_NumFilasCCEE

	if @spvar_CodHistoria is null
		select @CodPaciente = CodPaciente from Hclinica..Pacientes where NumTarjSanitaria = @spvar_TSanitaria
	else
		select @CodPaciente = CodPaciente from Hclinica..Pacientes where CodHistoria = @spvar_CodHistoria

	if @spvar_Reservadas = 1 or @spvar_Confirmadas = 1
	begin
	select	p.CodHistoria,
			p.CodPaciente,
			'PacNombre'=  rtrim(p.PacNombre),
			'PacApell1' = rtrim(p.PacApell1),
			'PacApell2' = rtrim(p.PacApell2),
			e.CodDerivacion as CodEpisodio,
			e.FechaCPrimera,
			e.FechaConsulta,
			e.DictamenClinico as Juicio,
			e.CodCentroFinal,
			S.Codigo,
			s.DescServicio ServicioDestino,
			s1.DescServicio ServicioRemite,
			'0' as Pasiva,
			e.Solicitud, 
			e.FechaPrevista,			
				case
					when e.IdGuiaClinica is null then 0
					else 1
				end as TieneGuia,
			'' as MotivoPasiva,
			e.CodColectivo,
			MP.Entidad + '-' + MS.Entidad as Aseguradora,
			cs.CodCent as HospitalRef,
			cs.NomCentro as DescCentro,
			(case when e.CitaConfirmada = 0 then 1 else 0 end) as NoDerecho,
			null as CodConsulta,
			null as CodTipoConsulta2,
			null as FechaCita,			
			null as IdCita,
			null as CodTipoConsulta,			
			null as CodigoServicio,
			e.confirmada,
			p.NumTarjSanitaria,
			e.comunicada,
			e.IdUnidad,
			e.CodigoRYF,
			e.CodCentroOrigen,
			cs1.DescCentro as DescCentroRef
			,'' as IdMotivo,
			p.FecNac,			
			null as CodHistoriaPapel,			
			p.Genero,
			'Sexo' = COD.Descripcion,
			'RUT Profesional' = e.DniMedDestino,
			'Profesional' = NULL,
			'Citador' = NULL,
			'TipoConsulta' = NULL,
			'Prioridad' = COD2.Descripcion			
			,e.Estado 
			,e.DescUnidadDestino as Unidad			
			,p.DirTelf			
			,'TiempoEspera' = DATEDIFF(DD, e.FechaConsulta, ISNULL(e.FechaInicial, GETDATE())) 
			,COD2.Posicion as OrdenPrioridad 
			,2 as DerivacionSIC
			,e.ConfirmadaDestino
			,isnull(e.DerivacionManual,0) as DerivacionManual
			,e.ComunicadaDestino
			,e.AsisteCita
			,null as ConfAsistencia 
			,null as CitaEspontanea	
			,e.FechaInicial	
			,0 as NoAtendido
			,e.FechaNoAtendida
			,e.NoAsistenciasCita
			, NULL as idOrigenCita 
			, NULL as DescOrigenCitas
			,p.Email
			,p.Direccion 
			,p.DirNum
			 ,p.CodPostal 
			 ,L.NomPoblacion  
			 ,p1.Nombre as Provincia
			,L.NomPoblacion as Localidad
			,p.telf2
			,isNull(p.TarjSanitariaResp,'') as RutTutor
			,IsNull(PMRemite.NomMedico , '') as NombreMedicoRemi
			,IsNull(PMRemite.Apell1 , '') as Apel1MedicoRemi
			,IsNull(PMRemite.Apell2 , '') as Apel2MEdicoRemi
			,IsNull(PMRemite.Nif , '') as RutMedicoRemi
			,I.DescDiagnostico
			,CI.DescDiagnostico as DescDiagnosProvi
			,e.inspecciones 
			,e.IDProblemaSalud
			,gc.DescGuia as descProblema
			,gc1.DescGuia as descSubProblema
			,isnull(PMcita.Nif,isnull(DEcita.Nif,isnull(TD.Nif,Acita.nif))) as Nif
			,e.IdCausaInterconsulta
			,e.DescCausaInterconsulta
			,e.comentarios
			,e.TipoRemision
			,e.motivo
			,p.AtiendeAlNombre as NombreSocial
			,CASE WHEN 
			(
				EXISTS (select * from Hclinica..MutuasSaludSecPaciente MSSP 
				INNER JOIN parametros..MutuasSalud MS on MS.Codigo = MSSP.CodColectivo
				where codpaciente = e.CodPaciente and MS.EsPrais = 1)
			) THEN 1 ELSE 0 END AS EsPRAIS
			,'SIC Derivada' as ProfesionalAtiende
			,p.Telf3
			,p.TelfFijoUFamiliar
			,e.RUNProfEgreso
			,e.NomProfEgreso
			,e.ObservacionEgreso
			,e.FechaCierre
	from	Consultas..DerivacionConsultas e with (nolock)
			inner join Hclinica..Pacientes p with (nolock) on p.CodPaciente = @CodPaciente and p.CodPaciente = e.CodPaciente
			left join Parametros..ServiciosExternos s with (nolock) on s.Codigo = e.CodServicioFinal
			left join Parametros..Servicios s1 with (nolock) on s1.Codigo = e.CodServicioOrigen
			left join Parametros..DatosOtrosCentros cs with (nolock) on cs.CodCent = e.CodCentroFinal
			left join Parametros..CentrosSalud cs1 with (nolock) on cs1.CodCentro = e.CodCentroOrigen
			left join Parametros..Codigos COD on COD.Codigo = p.Genero and Tabla = 'EstGenero'
			left join Parametros..Codigos COD2 on COD2.Codigo = e.Solicitud and COD2.Tabla = 'EstTipoExamen'	
			LEFT JOIN parametros..DireccionLocalidad L ON p.DirCodLocalidad = L.CodPoblacion and p.dircodprov = l.codprovincia 		    
			LEFT JOIN parametros..codprovincias p1 on p1.codigo = p.dircodprov
			left join Parametros..ParametrosMedicos PMRemite on PMRemite.DNIMedico = e.DNIMedEpi
			LEFT JOIN Parametros..CIEDiagnostico I on e.CodDiagnosticoProvisional = I.CodDiagnostico
			LEFT JOIN Parametros..CIEDiagnostico CI on e.CodDiagnosticoPrimero = CI.CodDiagnostico
			left join  Parametros..GuiasClinicas gc on  gc.CodGuia = e.IDProblemaSalud 
			left join  Parametros..GuiasClinicas gc1 on  gc1.CodGuia = e.CodSubProblema
			LEFT JOIN Parametros..TecnicosDatos TD on TD.DNITecnico = e.NIF
			left join Parametros..ParametrosMedicos PMcita on PMcita.DNIMedico = e.NIF
			left join Parametros..DatosEnfermeras DEcita on DEcita.DNIEnf = e.NIF
			left join Parametros..Administrativo Acita on Acita.DNIAdminist = e.NIF	  
			LEFT JOIN Parametros..MutuasSalud MS ON e.CodColectivo = MS.Codigo
			LEFT JOIN Parametros..MutuaPrincipal MP ON MS.CodMutua = MP.Codigo			

	where  (@spvar_Citados = '0' or (@spvar_Citados = '1' and e.FechaCPrimera is not null))
			and (@spvar_NoCitados = '0' or (@spvar_NoCitados = '1' and e.FechaCPrimera is null))
			and (@spvar_FecCita is null or datediff(d, @spvar_FecCita, e.FechaCPrimera) = 0)
			and (@spvar_FecCitaDesde is null or datediff(d, @spvar_FecCitaDesde, e.FechaCPrimera) >= 0)
			and (@spvar_FecCitaHasta is null or datediff(d, @spvar_FecCitaHasta, e.FechaCPrimera) <= 0)
			and (@spvar_FechaPrevistaDesde is null or e.FechaPrevista >= @spvar_FechaPrevistaDesde)
			and (@spvar_FechaPrevistaHasta is null or e.FechaPrevista <= @spvar_FechaPrevistaHasta)
			and (@spvar_AUGE is null or e.IdGuiaClinica is not null)
			and (@spvar_FecSolDesde is null or datediff(d, @spvar_FecSolDesde, e.FechaConsulta) >= 0)
			and (@spvar_FecSolHasta is null or datediff(d, @spvar_FecSolHasta, e.FechaConsulta) <= 0)
			and (@spvar_Reservadas = '0' or (@spvar_Reservadas = '1' and e.FechaCPrimera is not null and (e.CitaConfirmada = 0 or e.CitaConfirmada is null)))
			and (@spvar_Confirmadas = '0' or (@spvar_Confirmadas = '1' and e.FechaCPrimera is not null and e.CitaConfirmada = 1))
			and (@spvar_Comunicadas = '0' or (@spvar_Comunicadas = '1' and e.comunicada is not null))
			and (@spvar_SinComunicar = '0' or (@spvar_SinComunicar = '1' and e.comunicada is null))
			and (@spvar_DniMedicoOrigen is null or e.DNIMedEpi = @spvar_DniMedicoOrigen)
			and (
				(@spvar_LibreEleccion is null and (e.LibreEleccion is null or e.LibreEleccion = 0)
				or
				(e.LibreEleccion = 1)))
	end
else
	begin
	select	p.CodHistoria,
			p.CodPaciente,
			'PacNombre'=  rtrim(p.PacNombre), 
			'PacApell1' = rtrim(p.PacApell1),
			'PacApell2' = rtrim(p.PacApell2),
			e.CodDerivacion as CodEpisodio,
			e.FechaCPrimera,			
			e.FechaConsulta,			
			e.DictamenClinico as Juicio,
			e.CodCentroFinal,
			S.Codigo, 
			s.DescServicio ServicioDestino,
			s1.DescServicio ServicioRemite,
			'0' as Pasiva,
			e.Solicitud, 
			e.FechaPrevista,			
				case
					when e.IdGuiaClinica is null then 0
					else 1
				end as TieneGuia,
			'' as MotivoPasiva,
			e.CodColectivo,
			MP.Entidad + '-' + MS.Entidad as Aseguradora,
			cs.CodCent as HospitalRef,
			cs.NomCentro as DescCentro,
			(case when e.CitaConfirmada = 0 then 1 else 0 end) as NoDerecho,
			null as CodConsulta,
			null as FechaCita,
			null as IdCita,
			null as CodTipoConsulta,
			null as CodigoServicio,
			null as CodTipoConsulta2,
			e.confirmada,
			p.NumTarjSanitaria,
			e.comunicada,
			e.IdUnidad,
			e.CodigoRYF,
			e.CodCentroOrigen,
			cs1.DescCentro as DescCentroRef
			,'' as IdMotivo,
			p.FecNac,		
			null as CodHistoriaPapel,			
			p.Genero,
			'Sexo' = COD.Descripcion,
			'RUT Profesional' =  NULL,
			'Profesional' = NULL,
			'Citador' = NULL,
			'TipoConsulta' = NULL,
			'Prioridad' = COD2.Descripcion			
			,e.Estado 							
			,e.DescUnidadDestino as Unidad			
			,p.DirTelf			
			,'TiempoEspera' = DATEDIFF(DD, e.FechaConsulta, ISNULL(e.FechaInicial, GETDATE())) 
			,COD2.Posicion as OrdenPrioridad 
			,2 as DerivacionSIC
			,e.ConfirmadaDestino
			,isnull(e.DerivacionManual,0) as DerivacionManual
			,e.ComunicadaDestino
			,e.AsisteCita
			,null as ConfAsistencia 
			,null as CitaEspontanea	
			,e.FechaInicial	
			,0 as NoAtendido
			,e.FechaNoAtendida
			,e.NoAsistenciasCita
			, NULL as idOrigenCita 
			, NULL as DescOrigenCitas
			,p.Email
			,p.Direccion 
			,p.DirNum
			 ,p.CodPostal 
			 ,L.NomPoblacion  
			 ,p1.Nombre as Provincia
			,L.NomPoblacion as Localidad
			,p.telf2
			,isNull(p.TarjSanitariaResp,'') as RutTutor
			,IsNull(PMRemite.NomMedico , '') as NombreMedicoRemi
			,IsNull(PMRemite.Apell1 , '') as Apel1MedicoRemi
			,IsNull(PMRemite.Apell2 , '') as Apel2MEdicoRemi
			,IsNull(PMRemite.Nif , '') as RutMedicoRemi
			,I.DescDiagnostico
			,CI.DescDiagnostico as DescDiagnosProvi
			,e.inspecciones 
			,e.IDProblemaSalud
			,gc.DescGuia as descProblema
			,gc1.DescGuia as descSubProblema
			,isnull(PMcita.Nif,isnull(DEcita.Nif,isnull(TD.Nif,Acita.nif))) as Nif
			,e.IdCausaInterconsulta
			,e.DescCausaInterconsulta
			,e.comentarios
			,e.TipoRemision
			,e.motivo
			,p.AtiendeAlNombre as NombreSocial
			,CASE WHEN 
			(
				EXISTS (select * from Hclinica..MutuasSaludSecPaciente MSSP 
				INNER JOIN parametros..MutuasSalud MS on MS.Codigo = MSSP.CodColectivo
				where codpaciente = e.CodPaciente and MS.EsPrais = 1)
			) THEN 1 ELSE 0 END AS EsPRAIS
			,'SIC Derivada' as ProfesionalAtiende
			,p.Telf3
			,p.TelfFijoUFamiliar
			,e.RUNProfEgreso
			,e.NomProfEgreso
			,e.ObservacionEgreso
			,e.FechaCierre
	from	Consultas..DerivacionConsultas e with (nolock)
			inner join Hclinica..Pacientes p with (nolock) on p.CodPaciente = @CodPaciente and p.CodPaciente = e.CodPaciente
			left join Parametros..ServiciosExternos s with (nolock) on s.Codigo = e.CodServicioFinal
			left join Parametros..Servicios s1 with (nolock) on s1.Codigo = e.CodServicioOrigen
			left join Parametros..DatosOtrosCentros cs with (nolock) on cs.CodCent = e.CodCentroFinal
			left join Parametros..CentrosSalud cs1 with (nolock) on cs1.CodCentro = e.CodCentroOrigen	
			left join Parametros..Codigos COD on COD.Codigo = p.Genero and Tabla = 'EstGenero'						
			left join Parametros..Codigos COD2 on COD2.Codigo = e.Solicitud and COD2.Tabla = 'EstTipoExamen'
			LEFT JOIN parametros..DireccionLocalidad L ON p.DirCodLocalidad = L.CodPoblacion and p.dircodprov = l.codprovincia 		    
			LEFT JOIN parametros..codprovincias p1 on p1.codigo = p.dircodprov
			left join Parametros..ParametrosMedicos PMRemite on PMRemite.DNIMedico = e.DNIMedEpi
			LEFT JOIN Parametros..CIEDiagnostico I on e.CodDiagnosticoProvisional = I.CodDiagnostico
			LEFT JOIN Parametros..CIEDiagnostico CI on e.CodDiagnosticoPrimero = CI.CodDiagnostico
			left join  Parametros..GuiasClinicas gc on  gc.CodGuia = e.IDProblemaSalud 
			left join  Parametros..GuiasClinicas gc1 on  gc1.CodGuia = e.CodSubProblema 
			LEFT JOIN Parametros..TecnicosDatos TD on TD.DNITecnico = e.NIF
			left join Parametros..ParametrosMedicos PMcita on PMcita.DNIMedico = e.NIF
			left join Parametros..DatosEnfermeras DEcita on DEcita.DNIEnf = e.NIF
			left join Parametros..Administrativo Acita on Acita.DNIAdminist = e.NIF	 
			LEFT JOIN Parametros..MutuasSalud MS ON e.CodColectivo = MS.Codigo
			LEFT JOIN Parametros..MutuaPrincipal MP ON MS.CodMutua = MP.Codigo			
	
	where  (@spvar_Citados = '0' or (@spvar_Citados = '1' and e.FechaCPrimera is not null))
			and (@spvar_NoCitados = '0' or (@spvar_NoCitados = '1' and e.FechaCPrimera is null))
			and (@spvar_FecCita is null or datediff(d, @spvar_FecCita, e.FechaCPrimera) = 0)
			and (@spvar_FecCitaDesde is null or datediff(d, @spvar_FecCitaDesde, e.FechaCPrimera) >= 0)
			and (@spvar_FecCitaHasta is null or datediff(d, @spvar_FecCitaHasta, e.FechaCPrimera) <= 0)
			and (@spvar_FechaPrevistaDesde is null or e.FechaPrevista >= @spvar_FechaPrevistaDesde)
			and (@spvar_FechaPrevistaHasta is null or e.FechaPrevista <= @spvar_FechaPrevistaHasta)
			and (@spvar_AUGE is null or e.IdGuiaClinica is not null)
			and (@spvar_FecSolDesde is null or datediff(d, @spvar_FecSolDesde, e.FechaConsulta) >= 0)
			and (@spvar_FecSolHasta is null or datediff(d, @spvar_FecSolHasta, e.FechaConsulta) <= 0)
			and (@spvar_Comunicadas = '0' or (@spvar_Comunicadas = '1' and e.comunicada is not null))
			and (@spvar_SinComunicar = '0' or (@spvar_SinComunicar = '1' and e.comunicada is null))
			and (@spvar_DniMedicoOrigen is null or e.DNIMedEpi = @spvar_DniMedicoOrigen)
			and (
				(@spvar_LibreEleccion is null and (e.LibreEleccion is null or e.LibreEleccion = 0)
				or
				(e.LibreEleccion = 1)))
				
select @@ROWCOUNT

end


GO
GO



--dbo.SpConSDerivacionesSICFechas2.sql

USE [Consultas]
GO

/****** Object:  StoredProcedure [dbo].[SpConSDerivacionesSICFechas2]    Script Date: 10/31/2013 13:17:48 ******/
IF EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[SpConSDerivacionesSICFechas2]') AND type in (N'P', N'PC'))
DROP PROCEDURE [dbo].[SpConSDerivacionesSICFechas2]
GO

/****** Object:  StoredProcedure [dbo].[SpConSDerivacionesSICFechas2]    Script Date: 10/31/2013 13:17:48 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

/*
***********************************************************************
PROCEDIMIENTO : SpConSDerivacionesSICFechas2
FUNCION		  : Busca las derivaciones SIC
			    filtrando por CodHistoria o Tarjeta Sanitaria sólamente y mostrando las derivaciones normales y pasivas
DEVUELVE	  :
FECHA		  : 30/10/2013
VERSION		  : 1.0
AUTOR		  : Enrique Sánchez
TAREA		  : CHC2076 - Derivación SIC - v4.41.1
MODIFICACION  : (29/08/2014) - v4.46r2 - 1247 - RRG - Incluir estado de confirmacion de asistencia - REQ 53268
MODIFICACIÓN  : (03/11/2014) - V4.48 - 1169 - VAS - Citas Espontaneas
MODIFICACIÓN  : (20/11/2014) - V4.48 - 1489 - VAS - Iconos estado SIC en Gestor Interconsultas
MODIFICACIÓN  : (20/11/2014) Alberto Pagán Benedicto - V4.49 - 1440 - APB - Segunda parte Derivación entre instancias
MODIFICACIÓN  : (08/01/2015) --V4.49 – 1440 – ACT – Segunda parte Derivación entre instancias
MODIFICACION  :	(22/06/2015) v4.52 - 1899 - SGN - Problema distribución cupos florence
MODIFICACION  : (16/11/2015) v4.55r1 - 2696 - CCM - Impresión múltiples SIC
MODIFICACION  : (09/05/2017) - 17.2 - 16146 - SGH - Incluir Nombre Social del Paciente
MODIFICACION  : (19/05/2017) - 17.2 - 16506 - SGH - Filtros Prais Listados Sol. Interconsultas e Intervenciones
MODIFICACION  : (26/05/2017) - 17.2 - 16112 - SGH - Modificar reporte de gestor de interconsultas
MODIFICACION  : (23/08/2017) - v17.3 – 18451 – FCB - Ingresar observación al motivo de egreso en SIC
***********************************************************************
*/

CREATE PROCEDURE [dbo].[SpConSDerivacionesSICFechas2]
	 @spvar_CodHistoria char(8) = null
	,@spvar_TSanitaria char(16) = null
	,@spvar_FechaPrevistaDesde smalldatetime = null
	,@spvar_FechaPrevistaHasta smalldatetime = null
	,@spvar_AUGE bit = null
	,@spvar_Eliminadas bit = null
	,@spvar_Rechazadas bit = null
	,@spvar_NumFilasCCEE int = null
	,@spvar_ConfAsistencia bit = 0 
	,@spvar_CitaEspontanea bit = 0 
AS

declare @CodPaciente char(16)

--Aplicamos máximo de filas si este parámetro trae algún valor.
if @spvar_NumFilasCCEE is not null
	set rowcount @spvar_NumFilasCCEE

if @spvar_CodHistoria is null
	select @CodPaciente = CodPaciente from Hclinica..Pacientes where NumTarjSanitaria = @spvar_TSanitaria
else
	select @CodPaciente = CodPaciente from Hclinica..Pacientes where CodHistoria = @spvar_CodHistoria

	--Busca las propuestas normales, pasivas, eliminadas y rechazadas
	select	p.CodHistoria,
			p.CodPaciente,
			'PacNombre'= rtrim(p.PacNombre), 
			'PacApell1' = rtrim(p.PacApell1),
			'PacApell2' = rtrim(p.PacApell2),
			e.CodDerivacion as CodEpisodio,
			e.FechaCPrimera,				
			e.FechaConsulta,				
			e.DictamenClinico as Juicio,
			e.CodCentroFinal,
			S.Codigo, 
			s.DescServicio ServicioDestino,
			s1.DescServicio ServicioRemite,
			'0' as Pasiva,
			e.Solicitud,
			e.FechaPrevista,				
			case
				when e.IdGuiaClinica is null then 0
				else 1
			end as TieneGuia,
			ISNULL(MC.Descripcion,'') as MotivoPasiva, 
			e.CodColectivo,
			MP.Entidad + '-' + MS.Entidad as Aseguradora,
			cs.CodCent as HospitalRef,
			cs.NomCentro as DescCentro,
			(case when e.CitaConfirmada = 0 then 1 else 0 end) as NoDerecho,
			null as CodConsulta,
			null as FechaCita,
			null as IdCita,
			null as CodTipoConsulta,
			null as CodigoServicio,
			null as CodTipoConsulta2,
			e.confirmada,
			p.NumTarjSanitaria,
			e.comunicada,
			e.CodigoRYF,
			e.CodCentroOrigen,
			cs1.DescCentro as DescCentroRef
			,ISNULL(IdMotivo,'') as IdMotivo, 
			p.FecNac,				
			null as CodHistoriaPapel,				
			p.Genero,
			'Sexo' = COD.Descripcion,
			'RUT Profesional' = NULL,
			'Profesional' = NULL,
			'Citador' = NULL,
			'TipoConsulta' = NULL,
			'Prioridad' = COD2.Descripcion	
			,e.Estado 				
			,e.DescUnidadDestino as Unidad				
			,p.DirTelf				
			,'TiempoEspera' = DATEDIFF(DD, e.FechaConsulta, ISNULL(e.FechaInicial, GETDATE()))
			,COD2.Posicion as OrdenPrioridad 
			,2 as DerivacionSIC
			,e.ConfirmadaDestino 
			,isnull(e.DerivacionManual,0) as DerivacionManual
			,e.ComunicadaDestino
			,e.AsisteCita
			,null as ConfAsistencia 
			,null as CitaEspontanea	
			,e.FechaInicial	
			,0 as NoAtendido
			,e.FechaNoAtendida
			,e.NoAsistenciasCita
			, NULL as idOrigenCita 
			, NULL as DescOrigenCitas
			,p.Email
			,p.Direccion 
			,p.DirNum
			 ,p.CodPostal 
			 ,L.NomPoblacion  
			 ,p1.Nombre as Provincia
			,L.NomPoblacion as Localidad
			,p.telf2
			,isNull(p.TarjSanitariaResp,'') as RutTutor
			,IsNull(PMRemite.NomMedico , '') as NombreMedicoRemi
			,IsNull(PMRemite.Apell1 , '') as Apel1MedicoRemi
			,IsNull(PMRemite.Apell2 , '') as Apel2MEdicoRemi
			,IsNull(PMRemite.Nif , '') as RutMedicoRemi
			,I.DescDiagnostico
			,CI.DescDiagnostico as DescDiagnosProvi
			,e.inspecciones 
			,e.IDProblemaSalud
			,gc.DescGuia as descProblema
			,gc1.DescGuia as descSubProblema
			,isnull(PMcita.Nif,isnull(DEcita.Nif,isnull(TD.Nif,Acita.nif))) as Nif
			,e.IdCausaInterconsulta
			,e.DescCausaInterconsulta
			,e.comentarios
			,e.TipoRemision
			,e.motivo
			,p.AtiendeAlNombre as NombreSocial
			,CASE WHEN 
			(
				EXISTS (select * from Hclinica..MutuasSaludSecPaciente MSSP 
				INNER JOIN parametros..MutuasSalud MS on MS.Codigo = MSSP.CodColectivo
				where codpaciente = e.CodPaciente and MS.EsPrais = 1)
			) THEN 1 ELSE 0 END AS EsPRAIS,
			'SIC Derivada' as ProfesionalAtiende,
			p.Telf3,
			p.TelfFijoUFamiliar  
			,e.RUNProfEgreso
			,e.NomProfEgreso
			,e.ObservacionEgreso 
			,e.FechaCierre 
	from	Consultas..DerivacionConsultas e with (nolock)
			inner join Hclinica..Pacientes p with (nolock) on p.CodPaciente = @CodPaciente and p.CodPaciente = e.CodPaciente
			left join Parametros..ServiciosExternos s with (nolock) on s.Codigo = e.CodServicioFinal
			left join Parametros..Servicios s1 with (nolock) on s1.Codigo = e.CodServicioOrigen
			left join Parametros..DatosOtrosCentros cs with (nolock) on cs.CodCent = e.CodCentroFinal
			left join Parametros..CentrosSalud cs1 with (nolock) on cs1.CodCentro = e.CodCentroOrigen					
			left join Parametros..Codigos COD on COD.Codigo = p.Genero and Tabla = 'EstGenero'				
			left join Parametros..Codigos COD2 on COD2.Codigo = e.Solicitud and COD2.Tabla = 'EstTipoExamen'				
			left join Parametros..MotivosCitas MC on e.IdMotivo = MC.Codigo
			LEFT JOIN parametros..DireccionLocalidad L ON p.DirCodLocalidad = L.CodPoblacion and p.dircodprov = l.codprovincia 		    
			LEFT JOIN parametros..codprovincias p1 on p1.codigo = p.dircodprov
			left join Parametros..ParametrosMedicos PMRemite on PMRemite.DNIMedico = e.DNIMedEpi
			LEFT JOIN Parametros..CIEDiagnostico I on e.CodDiagnosticoProvisional = I.CodDiagnostico
			LEFT JOIN Parametros..CIEDiagnostico CI on e.CodDiagnosticoPrimero = CI.CodDiagnostico
			left join  Parametros..GuiasClinicas gc on  gc.CodGuia = e.IDProblemaSalud 
			left join  Parametros..GuiasClinicas gc1 on  gc1.CodGuia = e.CodSubProblema
			LEFT JOIN Parametros..TecnicosDatos TD on TD.DNITecnico = e.NIF
			left join Parametros..ParametrosMedicos PMcita on PMcita.DNIMedico = e.NIF
			left join Parametros..DatosEnfermeras DEcita on DEcita.DNIEnf = e.NIF
			left join Parametros..Administrativo Acita on Acita.DNIAdminist = e.NIF	  
			LEFT JOIN Parametros..MutuasSalud MS ON e.CodColectivo = MS.Codigo
			LEFT JOIN Parametros..MutuaPrincipal MP ON MS.CodMutua = MP.Codigo
	union
	select	p.CodHistoria,
			p.CodPaciente,
			'PacNombre'= rtrim(p.PacNombre), 
			'PacApell1' = rtrim(p.PacApell1),
			'PacApell2' = rtrim(p.PacApell2),
			e.CodDerivacion as CodEpisodio,
			e.FechaCPrimera,				
			e.FechaConsulta,				
			e.DictamenClinico as Juicio,
			e.CodCentroFinal,
			S.Codigo, 
			s.DescServicio ServicioDestino,
			s1.DescServicio ServicioRemite,
			case 
				when Asistido is null then null
				when Asistido = 'R' then '2'
				else '1'
			end as Pasiva,
			e.Solicitud,
			e.FechaPrevista,				
			case
				when e.IdGuiaClinica is null then 0
				else 1
			end as TieneGuia,
			DescMotivoPasiva as MotivoPasiva,
			e.CodColectivo,
			MP.Entidad + '-' + MS.Entidad as Aseguradora,
			cs.CodCent as HospitalRef,
			cs.NomCentro as DescCentro,
			(case when e.CitaConfirmada = 0 then 1 else 0 end) as NoDerecho,
			null as CodConsulta,
			null as FechaCita,
			null as IdCita,
			null as CodTipoConsulta,
			null as CodigoServicio,
			null as CodTipoConsulta2,
			null as confirmada,
			p.NumTarjSanitaria,
			e.comunicada,
			e.CodigoRYF,
			e.CodCentroOrigen,
			cs1.DescCentro as DescCentroRef,
			(select top 1 M.ID_Sidra from Parametros..[MotivosCitas] M where M.[Codigo] = e.[IdMotivo]) as IdMotivo,
			p.FecNac,				
			null as CodHistoriaPapel,				
			p.Genero,
			'Sexo' = COD.Descripcion,
			'RUT Profesional' = e.DniMedDestino,
			'Profesional' = NULL,
			'Citador' = NULL,
			'TipoConsulta' = NULL,
			'Prioridad' = COD2.Descripcion					
			,e.Estado 				
			,e.DescUnidadDestino as Unidad				
			,p.DirTelf				
			,'TiempoEspera' = DATEDIFF(DD, e.FechaConsulta, e.FechaBorrado)
			,COD2.Posicion as OrdenPrioridad 
			,2 as DerivacionSIC
			,e.ConfirmadaDestino
			,isnull(e.DerivacionManual,0) as DerivacionManual
			,e.ComunicadaDestino
			,e.AsisteCita
			,null as ConfAsistencia 
			,null as CitaEspontanea	
			,e.FechaInicial	
			,0 as NoAtendido
			,e.FechaNoAtendida
			,e.NoAsistenciasCita
			, NULL as idOrigenCita 
			, NULL as DescOrigenCitas
			,p.Email
			,p.Direccion 
			,p.DirNum
			 ,p.CodPostal 
			 ,L.NomPoblacion  
			 ,p1.Nombre as Provincia
			,L.NomPoblacion as Localidad
			,p.telf2
			,isNull(p.TarjSanitariaResp,'') as RutTutor
			,IsNull(PMRemite.NomMedico , '') as NombreMedicoRemi
			,IsNull(PMRemite.Apell1 , '') as Apel1MedicoRemi
			,IsNull(PMRemite.Apell2 , '') as Apel2MEdicoRemi
			,IsNull(PMRemite.Nif , '') as RutMedicoRemi
			,I.DescDiagnostico
			,CI.DescDiagnostico as DescDiagnosProvi
			,e.inspecciones 
			,e.IDProblemaSalud
			,gc.DescGuia as descProblema
			,gc1.DescGuia as descSubProblema
			,isnull(PMcita.Nif,isnull(DEcita.Nif,isnull(TD.Nif,Acita.nif))) as Nif
			,e.IdCausaInterconsulta
			,e.DescCausaInterconsulta
			,e.comentarios
			,e.TipoRemision
			,e.motivo
			,p.AtiendeAlNombre as NombreSocial
			,CASE WHEN 
			(
				EXISTS (select * from Hclinica..MutuasSaludSecPaciente MSSP 
				INNER JOIN parametros..MutuasSalud MS on MS.Codigo = MSSP.CodColectivo
				where codpaciente = e.CodPaciente and MS.EsPrais = 1)
			) THEN 1 ELSE 0 END AS EsPRAIS,
			'SIC Derivada' as ProfesionalAtiende,
			p.Telf3,
			p.TelfFijoUFamiliar
			,e.RUNProfEgreso
			,e.NomProfEgreso
			,e.ObservacionEgreso
			,e.FechaBorrado as FechaCierre
	from	Consultas..DerivacionConsultasBorrados e with (nolock)
			inner join Hclinica..Pacientes p with (nolock) on p.CodPaciente = @CodPaciente and p.CodPaciente = e.CodPaciente
			left join Parametros..ServiciosExternos s with (nolock) on s.Codigo = e.CodServicioFinal
			left join Parametros..Servicios s1 with (nolock) on s1.Codigo = e.CodServicioOrigen
			left join Parametros..DatosOtrosCentros cs with (nolock) on cs.CodCent = e.CodCentroFinal
			left join Parametros..CentrosSalud cs1 with (nolock) on cs1.CodCentro = e.CodCentroOrigen
			left join Parametros..Codigos COD on COD.Codigo = p.Genero and Tabla = 'EstGenero'				
			left join Parametros..Codigos COD2 on COD2.Codigo = e.Solicitud and COD2.Tabla = 'EstTipoExamen'
			LEFT JOIN parametros..DireccionLocalidad L ON p.DirCodLocalidad = L.CodPoblacion and p.dircodprov = l.codprovincia 		    
			LEFT JOIN parametros..codprovincias p1 on p1.codigo = p.dircodprov
			left join Parametros..ParametrosMedicos PMRemite on PMRemite.DNIMedico = e.DNIMedEpi
			LEFT JOIN Parametros..CIEDiagnostico I on e.CodDiagnosticoProvisional = I.CodDiagnostico
			LEFT JOIN Parametros..CIEDiagnostico CI on e.CodDiagnosticoPrimero = CI.CodDiagnostico
			left join  Parametros..GuiasClinicas gc on  gc.CodGuia = e.IDProblemaSalud 
			left join  Parametros..GuiasClinicas gc1 on  gc1.CodGuia = e.CodSubProblema 
			LEFT JOIN Parametros..TecnicosDatos TD on TD.DNITecnico = e.NIF
			left join Parametros..ParametrosMedicos PMcita on PMcita.DNIMedico = e.NIF
			left join Parametros..DatosEnfermeras DEcita on DEcita.DNIEnf = e.NIF
			left join Parametros..Administrativo Acita on Acita.DNIAdminist = e.NIF	 
			LEFT JOIN Parametros..MutuasSalud MS ON e.CodColectivo = MS.Codigo
			LEFT JOIN Parametros..MutuaPrincipal MP ON MS.CodMutua = MP.Codigo			

	where	( Asistido = 'N' or Asistido is null or Asistido = 'R' ) 


GO


GO



--dbo.SpConSDerivacionesSICFechas3Pac.sql

USE [Consultas]
GO

/****** Object:  StoredProcedure [dbo].[SpConSDerivacionesSICFechas3Pac]    Script Date: 12/03/2013 12:43:41 ******/
IF EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[SpConSDerivacionesSICFechas3Pac]') AND type in (N'P', N'PC'))
DROP PROCEDURE [dbo].[SpConSDerivacionesSICFechas3Pac]
GO

/****** Object:  StoredProcedure [dbo].[SpConSDerivacionesSICFechas3Pac]    Script Date: 12/03/2013 12:43:41 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

/*
***********************************************************************
PROCEDIMIENTO : SpConSDerivacionesSICFechas3Pac
FUNCION		  : Busca las propuestas de consultas externas filtrando por cualquier campo, cuando existe código paciente
DEVUELVE	  :
FECHA		  : 30/10/2013
VERSION		  : 1.0
AUTOR		  : Enrique Sánchez
TAREA		  : CHC2076 - Derivación SIC - v4.41.1
MODIFICACION  : (20/03/2014) - CHC4019 - v4.42 - MAIPU REQ 46859 HEC_CORRECTIVO_PROBLEMA EN BUSQUEDAS POR FILTRO
MODIFICACION  : (09/07/2014) - v4.46 – 0001022: 10925 – JVT - Observaciones pendientes derivación entre instancias
MODIFICACION  : (29/08/2014) - v4.46r2 - 1247 - RRG - Incluir estado de confirmacion de asistencia - REQ 53268
MODIFICACIÓN  : (20/11/2014) - 1169 - VAS - Citas espontáneas
MODIFICACIÓN  : (20/11/2014) Alberto Pagán Benedicto - V4.49 - 1440 - APB - Segunda parte Derivación entre instancias
MODIFICACION  : (24/12/2014) - v4.49 - 1439 - RRG - Transversalidad del caso GES - REQ 55104
MODIFICACIÓN  : (08/01/2015) --V4.49 – 1440 – ACT – Segunda parte Derivación entre instancias
MODIFICACIÓN  : (30/04/2015) - V4.49r3 – 2156 – APO – Derivación entre instancias
MODIFICACION  : (29/06/2015) v4.52 - 1899 - SGN - Problema distribución cupos florence
MODIFICACION  : (16/11/2015) v4.55r1 - 2696 - CCM - Impresión múltiples SIC
MODIFICACION  : (09/05/2017) - 17.2 - 16146 - SGH - Incluir Nombre Social del Paciente
MODIFICACION  : (19/05/2017) - 17.2 - 16506 - SGH - Filtros Prais Listados Sol. Interconsultas e Intervenciones
MODIFICACION  : (26/05/2017) - 17.2 - 16112 - SGH - Modificar reporte de gestor de interconsultas
MODIFICACION  : (23/08/2017) - v17.3 – 18451 – FCB - Ingresar observación al motivo de egreso en SIC
***********************************************************************
*/

CREATE PROCEDURE [dbo].[SpConSDerivacionesSICFechas3Pac]
	 @spvar_Nombre char(20) = null
	,@spvar_Apell1 char(25) = null
	,@spvar_Apell2 char(25) = null
	,@spvar_CodServicio char(4) = null
	,@spvar_CodServicioRemite char(4) = null
	,@spvar_FecSolDesde smalldatetime = null
	,@spvar_FecSolHasta smalldatetime = null
	,@spvar_Citados bit = 0
	,@spvar_NoCitados bit = 0
	,@spvar_FecCita smalldatetime = null
	,@spvar_FecCitaDesde smalldatetime = null
	,@spvar_FecCitaHasta smalldatetime = null
	,@spvar_CodCentro char(5) = null
	,@spvar_CodTipoRemision char(1) = null
	,@spvar_Prioridad char(1) = null
	,@spvar_DniMedicoDestino char(8) = null
	,@spvar_BuscaPasivas bit = 0
	,@spvar_NumQuery int = 0
	,@spvar_FechaPrevistaDesde smalldatetime = null
	,@spvar_FechaPrevistaHasta smalldatetime = null
	,@spvar_AUGE bit = null
	,@spvar_Eliminadas bit = null
	,@spvar_Rechazadas bit = null
	,@spvar_CodColectivo varchar(5) = null
	,@spvar_codCentroDestino char(5) = null
	,@spvar_Reservadas bit = 0
	,@spvar_Confirmadas bit = 0
	,@spvar_PropConfirmadas bit = 0
	,@spvar_FecRecDesde smalldatetime = null
	,@spvar_FecRecHasta smalldatetime = null
	,@spvar_FecConfDesde smalldatetime = null
	,@spvar_FecConfHasta smalldatetime = null
	,@spvar_PropPendientes bit = 0
	,@spvar_idUnidad int = null
	,@spvar_Comunicadas bit = 0
	,@spvar_SinComunicar bit = 0
	,@spvar_LibreEleccion bit = null
	,@spvar_DniMedicoOrigen char(8) = null
	,@spvar_codPaciente char(16)
	,@spvar_NumFilasCCEE int = null
	,@spvar_Atendidas bit = 0
	,@spvar_ConfAsistencia bit = 0 
	,@spvar_CitaEspontanea bit = 0 
	,@spvar_PRAIS bit = null
AS

--Aplicamos máximo de filas si este parámetro trae algún valor.
if @spvar_NumFilasCCEE is not null
	set rowcount @spvar_NumFilasCCEE

	--Busca las propuestas pasivas
	if @spvar_BuscaPasivas = 1 
	BEGIN
		select	p.CodHistoria,
				p.CodPaciente,
				'PacNombre'= rtrim(p.PacNombre), 
				'PacApell1' = rtrim(p.PacApell1),
				'PacApell2' = rtrim(p.PacApell2),
				e.CodDerivacion as CodEpisodio,
				e.FechaCPrimera,				
				e.FechaConsulta,				
				e.DictamenClinico as Juicio,
				e.CodCentroFinal,
				S.Codigo, 
				s.DescServicio ServicioDestino,
				s1.DescServicio ServicioRemite,
				'0' as Pasiva, 
				e.Solicitud, 
				e.FechaPrevista,				
				case
					when 
						isnull(
								e.IdGuiaClinica,
								(
									select MIN (I.CodProblema)
									from 	(
												SELECT 
													  ipd.CodPaciente
													, ipd.CodEpisodio
													, ipd.CodProblema
													, ipd.CodSubProblema
													, ipd.CodDiagnostico
													, ipd.IDInformeIPD					
												FROM HClinica..InformeIPD ipd 
												union
												select 
													  tcGES.CodPaciente
													, tcGES.CodEpisodio
													, ipd.CodProblema
													, ipd.CodSubProblema
													, ipd.CodDiagnostico
													, tcGES.IDInformeIPD	
												FROM Hclinica..TrazabilidadCasoGES tcges 
													inner join hclinica..informeipd ipd on tcges.idinformeipd=ipd.idinformeipd 
											) I 
											inner join Parametros..CIEDiagnostico CIEDiag on I.CodDiagnostico=CIEDiag.CodDiagnostico
									WHERE I.CodPaciente=e.CodPaciente
									  and I.CodEpisodio=e.CodEpisodioOrigen	
								)
							  ) is null then 0
					else 1
				end as TieneGuia,
				'' as MotivoPasiva,
				e.CodColectivo,
				MP.Entidad + '-' + MS.Entidad as Aseguradora,
				cs.CodCent as HospitalRef,
				cs.NomCentro as DescCentro,
				(case when e.CitaConfirmada = 0 then 1 else 0 end) as NoDerecho,
				null as codConsulta,
				null as fechaCita,
				null as idCita,
				null as CodTipoConsulta,
				null as CodigoServicio,
				null as confirmada,
				null as CodTipoConsulta2,
				p.NumTarjSanitaria,
				e.comunicada,
				e.CodigoRYF,
				e.CodCentroOrigen,
				cs1.DescCentro as DescCentroRef,
				(select top 1 ID_Sidra from Parametros..[MotivosCitas] M where M.Codigo = e.IdMotivo) as IdMotivo,
				p.FecNac,				
				null as CodHistoriaPapel,				
				p.Genero,
				'Sexo' = COD.Descripcion,
				'RUT Profesional' = NULL,
				'Profesional' = NULL,
				'Citador' = NULL,
				'TipoConsulta' = NULL,
				'Prioridad' = COD2.Descripcion					
 			    ,e.Estado 
			    ,e.DescUnidadDestino as Unidad			
				,p.DirTelf				
				,'TiempoEspera' = DATEDIFF(DD, e.FechaConsulta, ISNULL(e.FechaInicial, GETDATE())) 
				,COD2.Posicion as OrdenPrioridad 
				,2 as DerivacionSIC
				,e.ConfirmadaDestino
				,isnull(e.DerivacionManual,0) as DerivacionManual
				,e.ComunicadaDestino
				,e.AsisteCita
				,null as ConfAsistencia 
				,null as CitaEspontanea	
				,e.FechaInicial	
				,0 as NoAtendido
				,e.FechaNoAtendida
				,e.NoAsistenciasCita
				, NULL as idOrigenCita 
				, NULL as DescOrigenCitas
				,p.Email
				,p.Direccion 
				,p.DirNum
				 ,p.CodPostal 
				 ,L.NomPoblacion  
				 ,p1.Nombre as Provincia
				,L.NomPoblacion as Localidad
				,p.telf2
				,isNull(p.TarjSanitariaResp,'') as RutTutor
				,IsNull(PMRemite.NomMedico , '') as NombreMedicoRemi
				,IsNull(PMRemite.Apell1 , '') as Apel1MedicoRemi
				,IsNull(PMRemite.Apell2 , '') as Apel2MEdicoRemi
				,IsNull(PMRemite.Nif , '') as RutMedicoRemi
				,I.DescDiagnostico
				,CI.DescDiagnostico as DescDiagnosProvi
				,e.inspecciones 
				,e.IDProblemaSalud
				,gc.DescGuia as descProblema
				,gc1.DescGuia as descSubProblema
				,isnull(PMcita.Nif,isnull(DEcita.Nif,isnull(TD.Nif,Acita.nif))) as Nif
				,e.IdCausaInterconsulta
				,e.DescCausaInterconsulta
				,e.comentarios
				,e.TipoRemision
				,e.motivo
				,p.AtiendeAlNombre as NombreSocial
				,CASE WHEN 
				(
					EXISTS (select * from Hclinica..MutuasSaludSecPaciente MSSP 
					INNER JOIN parametros..MutuasSalud MS on MS.Codigo = MSSP.CodColectivo
					where codpaciente = e.CodPaciente and MS.EsPrais = 1)
				) THEN 1 ELSE 0 END AS EsPRAIS
				,'SIC Derivada' as ProfesionalAtiende
				,p.Telf3
				,p.TelfFijoUFamiliar	
				,e.RUNProfEgreso
				,e.NomProfEgreso
				,e.ObservacionEgreso 	
				,e.FechaCierre				           
		from	Consultas..DerivacionConsultas e with (nolock) 
				inner join Hclinica..Pacientes p with (nolock) on p.CodPaciente = e.CodPaciente 
				left join Parametros..ServiciosExternos s with (nolock) on s.Codigo = e.CodServicioFinal
				left join Parametros..Servicios s1 with (nolock) on s1.Codigo = e.CodServicioOrigen
				left join Parametros..DatosOtrosCentros cs with (nolock) on cs.CodCent = e.CodCentroFinal
				left join Parametros..CentrosSalud cs1 with (nolock) on cs1.CodCentro = e.CodCentroOrigen
				left join Parametros..Codigos COD on COD.Codigo = p.Genero and Tabla = 'EstGenero'			
				left join Parametros..Codigos COD2 on COD2.Codigo = e.Solicitud and COD2.Tabla = 'EstTipoExamen'	
				LEFT JOIN parametros..DireccionLocalidad L ON p.DirCodLocalidad = L.CodPoblacion and p.dircodprov = l.codprovincia 		    
				LEFT JOIN parametros..codprovincias p1 on p1.codigo = p.dircodprov
				left join Parametros..ParametrosMedicos PMRemite on PMRemite.DNIMedico = e.DNIMedEpi
				LEFT JOIN Parametros..CIEDiagnostico I on e.CodDiagnosticoProvisional = I.CodDiagnostico
				LEFT JOIN Parametros..CIEDiagnostico CI on e.CodDiagnosticoPrimero = CI.CodDiagnostico
				left join  Parametros..GuiasClinicas gc on  gc.CodGuia = e.IDProblemaSalud 
				left join  Parametros..GuiasClinicas gc1 on  gc1.CodGuia = e.CodSubProblema 
				LEFT JOIN Parametros..TecnicosDatos TD on TD.DNITecnico = e.NIF
				left join Parametros..ParametrosMedicos PMcita on PMcita.DNIMedico = e.NIF
				left join Parametros..DatosEnfermeras DEcita on DEcita.DNIEnf = e.NIF
				left join Parametros..Administrativo Acita on Acita.DNIAdminist = e.NIF				
				LEFT JOIN Parametros..MutuasSalud MS ON e.CodColectivo = MS.Codigo
				LEFT JOIN Parametros..MutuaPrincipal MP ON MS.CodMutua = MP.Codigo			
		where	(e.AsisteCita = 0 and e.NoAsistenciasCita > 0)
				and p.CodPaciente = @spvar_codPaciente 
				and (@spvar_Nombre is null or PacNombre like (rtrim(@spvar_Nombre) + '%') )
				and (@spvar_Apell1 is null or PacApell1 like (rtrim(@spvar_Apell1) + '%') )
				and (@spvar_Apell2 is null or PacApell2 like (rtrim(@spvar_Apell2) + '%') )
				and (@spvar_CodServicio is null or e.CodServicioFinal = @spvar_CodServicio)
				and (@spvar_CodServicioRemite is null or e.CodServicioOrigen = @spvar_CodServicioRemite)
				and (@spvar_FecSolDesde is null or datediff(d, @spvar_FecSolDesde, e.FechaConsulta) >= 0)
				and (@spvar_FecSolHasta is null or datediff(d, @spvar_FecSolHasta, e.FechaConsulta) <= 0)
				and (@spvar_FecCita is null or datediff(d, @spvar_FecCita, e.FechaCPrimera) = 0)
				and (@spvar_FecCitaDesde is null or datediff(d, @spvar_FecCitaDesde, e.FechaCPrimera) >= 0)
				and (@spvar_FecCitaHasta is null or datediff(d, @spvar_FecCitaHasta, e.FechaCPrimera) <= 0)
				and (@spvar_CodCentro is null or e.CodCentroOrigen = @spvar_CodCentro)
				and (@spvar_CodTipoRemision is null or e.TipoRemision = @spvar_CodTipoRemision)
				and (@spvar_Prioridad is null or e.Solicitud = @spvar_Prioridad)
				and (@spvar_DniMedicoDestino is null or e.DniMedDestino = @spvar_DniMedicoDestino)
				and (@spvar_FechaPrevistaDesde is null or e.FechaPrevista >= @spvar_FechaPrevistaDesde)
				and (@spvar_FechaPrevistaHasta is null or e.FechaPrevista <= @spvar_FechaPrevistaHasta)
				and (@spvar_AUGE is null or e.IdGuiaClinica is not null)
				and (@spvar_CodColectivo is null or e.CodColectivo = @spvar_CodColectivo)
				and (@spvar_codCentroDestino is null or e.CodCentroFinal = @spvar_codCentroDestino)
				and (@spvar_idUnidad is null or e.IdUnidad = @spvar_idUnidad)
				and (@spvar_DniMedicoOrigen is null or e.DNIMedEpi = @spvar_DniMedicoOrigen)
				and (
					(@spvar_LibreEleccion is null and (e.LibreEleccion is null or e.LibreEleccion = 0)
					or
					(e.LibreEleccion = 1)))
				and (@spvar_PRAIS is null
					or 
					(@spvar_PRAIS = 1 and 
					EXISTS (select MS.EsPrais from 
					Hclinica..MutuasSaludSecPaciente MSSP 
					INNER JOIN parametros..MutuasSalud MS on MS.Codigo = MSSP.CodColectivo
					where codpaciente = e.CodPaciente and MS.EsPrais = 1))
					or 
					(@spvar_PRAIS = 0 and 
					NOT EXISTS (select MS.EsPrais from 
					Hclinica..MutuasSaludSecPaciente MSSP 
					INNER JOIN parametros..MutuasSalud MS on MS.Codigo = MSSP.CodColectivo
					where codpaciente = e.CodPaciente and MS.EsPrais = 1)))
							
	END
ELSE
	BEGIN
		if @spvar_Eliminadas = 1
		begin
			select	p.CodHistoria,
				p.CodPaciente,
				'PacNombre'= rtrim(p.PacNombre), 
				'PacApell1' = rtrim(p.PacApell1),
				'PacApell2' = rtrim(p.PacApell2),
				e.CodDerivacion as CodEpisodio,
				e.FechaCPrimera,				
				e.FechaConsulta,				
				e.DictamenClinico as Juicio,
				e.CodCentroFinal,
				S.Codigo, 
				s.DescServicio ServicioDestino,
				s1.DescServicio ServicioRemite,
				null as Pasiva,
				e.Solicitud,
				e.FechaPrevista,				
				
				case
					when 
						isnull(
								e.IdGuiaClinica,
								(
									select MIN (I.CodProblema)
									from 	(
												SELECT 
													  ipd.CodPaciente
													, ipd.CodEpisodio
													, ipd.CodProblema
													, ipd.CodSubProblema
													, ipd.CodDiagnostico
													, ipd.IDInformeIPD					
												FROM HClinica..InformeIPD ipd 
												union
												select 
													  tcGES.CodPaciente
													, tcGES.CodEpisodio
													, ipd.CodProblema
													, ipd.CodSubProblema
													, ipd.CodDiagnostico
													, tcGES.IDInformeIPD	
												FROM Hclinica..TrazabilidadCasoGES tcges 
													inner join hclinica..informeipd ipd on tcges.idinformeipd=ipd.idinformeipd 
											) I 
											inner join Parametros..CIEDiagnostico CIEDiag on I.CodDiagnostico=CIEDiag.CodDiagnostico
									WHERE I.CodPaciente=e.CodPaciente
									  and I.CodEpisodio=e.CodEpisodioOrigen	
								)
							  ) is null then 0
					else 1
				end as TieneGuia,
				DescMotivoPasiva as MotivoPasiva,
				e.CodColectivo,
				MP.Entidad + '-' + MS.Entidad  as Aseguradora,
				cs.CodCent as HospitalRef,
				cs.NomCentro as DescCentro,				
					(case when e.CitaConfirmada = 0 then 1 else 0 end) as NoDerecho,
				null as codConsulta,
				null as fechaCita,
				null as idCita,
				null as CodTipoConsulta,
				null as CodigoServicio,
				null as confirmada,
				null as CodTipoConsulta2,
				p.NumTarjSanitaria,
				e.comunicada,
				e.CodigoRYF,
				e.CodCentroOrigen,
				cs1.DescCentro as DescCentroRef,
 				(select top 1 ID_Sidra from Parametros..[MotivosCitas] M where M.Codigo = e.IdMotivo) as IdMotivo,
				p.FecNac,
				null as CodHistoriaPapel,						
				p.Genero,
				'Sexo' = COD.Descripcion,
				'RUT Profesional' = NULL,
				'Profesional' = NULL,
				'Citador' = NULL,
				'TipoConsulta' = NULL,
				'Prioridad' = COD2.Descripcion					
   			    ,e.Estado 
			    ,e.DescUnidadDestino as Unidad				
				,p.DirTelf				
				,'TiempoEspera' = DATEDIFF(DD, e.FechaConsulta, e.FechaBorrado)
				,COD2.Posicion as OrdenPrioridad 
				,2 as DerivacionSIC
				,e.ConfirmadaDestino
				,isnull(e.DerivacionManual,0) as DerivacionManual
				,e.ComunicadaDestino
				,e.AsisteCita
				,null as ConfAsistencia
				,null as CitaEspontanea
				,e.FechaInicial	
				,0 as NoAtendido
				,e.FechaNoAtendida
				,e.NoAsistenciasCita
				, NULL as idOrigenCita 
				, NULL as DescOrigenCitas
				,p.Email
				,p.Direccion 
				,p.DirNum
				 ,p.CodPostal 
				 ,L.NomPoblacion  
				 ,p1.Nombre as Provincia
				,L.NomPoblacion as Localidad
				,p.telf2
				,isNull(p.TarjSanitariaResp,'') as RutTutor
				,IsNull(PMRemite.NomMedico , '') as NombreMedicoRemi
				,IsNull(PMRemite.Apell1 , '') as Apel1MedicoRemi
				,IsNull(PMRemite.Apell2 , '') as Apel2MEdicoRemi
				,IsNull(PMRemite.Nif , '') as RutMedicoRemi
				,I.DescDiagnostico
				,CI.DescDiagnostico as DescDiagnosProvi
				,e.inspecciones 
				,e.IDProblemaSalud
				,gc.DescGuia as descProblema
				,gc1.DescGuia as descSubProblema
				,isnull(PMcita.Nif,isnull(DEcita.Nif,isnull(TD.Nif,Acita.nif))) as Nif
				,e.IdCausaInterconsulta
				,e.DescCausaInterconsulta
				,e.comentarios
				,e.TipoRemision
				,e.motivo	
				,p.AtiendeAlNombre as NombreSocial
				,CASE WHEN 
				(
					EXISTS (select * from Hclinica..MutuasSaludSecPaciente MSSP 
					INNER JOIN parametros..MutuasSalud MS on MS.Codigo = MSSP.CodColectivo
					where codpaciente = e.CodPaciente and MS.EsPrais = 1)
				) THEN 1 ELSE 0 END AS EsPRAIS
				,'SIC Derivada' as ProfesionalAtiende
				,p.Telf3
				,p.TelfFijoUFamiliar
				,e.RUNProfEgreso
				,e.NomProfEgreso
				,e.ObservacionEgreso 
				,e.FechaBorrado	as FechaCierre				           
			from	Consultas..DerivacionConsultasBorrados e with (nolock)
					inner join Hclinica..Pacientes p with (nolock) on p.CodPaciente = e.codPaciente 
					left join Parametros..ServiciosExternos s with (nolock) on s.Codigo = e.CodServicioFinal
					left join Parametros..Servicios s1 with (nolock) on s1.Codigo = e.CodServicioOrigen
					left join Parametros..DatosOtrosCentros cs with (nolock) on cs.CodCent = e.CodCentroFinal
					left join Parametros..CentrosSalud cs1 with (nolock) on cs1.CodCentro = e.CodCentroOrigen						
					left join Parametros..Codigos COD on COD.Codigo = p.Genero and Tabla = 'EstGenero'				
					left join Parametros..Codigos COD2 on COD2.Codigo = e.Solicitud and COD2.Tabla = 'EstTipoExamen'
					LEFT JOIN parametros..DireccionLocalidad L ON p.DirCodLocalidad = L.CodPoblacion and p.dircodprov = l.codprovincia 		    
					LEFT JOIN parametros..codprovincias p1 on p1.codigo = p.dircodprov
					left join Parametros..ParametrosMedicos PMRemite on PMRemite.DNIMedico = e.DNIMedEpi
					LEFT JOIN Parametros..CIEDiagnostico I on e.CodDiagnosticoProvisional = I.CodDiagnostico
					LEFT JOIN Parametros..CIEDiagnostico CI on e.CodDiagnosticoPrimero = CI.CodDiagnostico
					left join  Parametros..GuiasClinicas gc on  gc.CodGuia = e.IDProblemaSalud 
					left join  Parametros..GuiasClinicas gc1 on  gc1.CodGuia = e.CodSubProblema 
					LEFT JOIN Parametros..TecnicosDatos TD on TD.DNITecnico = e.NIF
					left join Parametros..ParametrosMedicos PMcita on PMcita.DNIMedico = e.NIF
					left join Parametros..DatosEnfermeras DEcita on DEcita.DNIEnf = e.NIF
					left join Parametros..Administrativo Acita on Acita.DNIAdminist = e.NIF	
					LEFT JOIN Parametros..MutuasSalud MS ON e.CodColectivo = MS.Codigo
					LEFT JOIN Parametros..MutuaPrincipal MP ON MS.CodMutua = MP.Codigo			
			where	asistido is null
					and p.CodPaciente = @spvar_codPaciente 
					and (@spvar_Nombre is null or PacNombre like (rtrim(@spvar_Nombre) + '%') )
					and (@spvar_Apell1 is null or PacApell1 like (rtrim(@spvar_Apell1) + '%') )
					and (@spvar_Apell2 is null or PacApell2 like (rtrim(@spvar_Apell2) + '%') )
					and (@spvar_CodServicio is null or e.CodServicioFinal = @spvar_CodServicio)
					and (@spvar_CodServicioRemite is null or e.CodServicioOrigen = @spvar_CodServicioRemite)
					and (@spvar_FecSolDesde is null or datediff(d, @spvar_FecSolDesde, e.FechaConsulta) >= 0)
					and (@spvar_FecSolHasta is null or datediff(d, @spvar_FecSolHasta, e.FechaConsulta) <= 0)
					and (@spvar_FecCita is null or datediff(d, @spvar_FecCita, e.FechaCPrimera) = 0)
					and (@spvar_FecCitaDesde is null or datediff(d, @spvar_FecCitaDesde, e.FechaCPrimera) >= 0)
					and (@spvar_FecCitaHasta is null or datediff(d, @spvar_FecCitaHasta, e.FechaCPrimera) <= 0)
					and (@spvar_CodCentro is null or e.CodCentroOrigen = @spvar_CodCentro)
					and (@spvar_CodTipoRemision is null or e.TipoRemision = @spvar_CodTipoRemision)
					and (@spvar_Prioridad is null or e.Solicitud = @spvar_Prioridad)
					and (@spvar_DniMedicoDestino is null or e.DniMedDestino = @spvar_DniMedicoDestino)
					and (@spvar_FechaPrevistaDesde is null or e.FechaPrevista >= @spvar_FechaPrevistaDesde)
					and (@spvar_FechaPrevistaHasta is null or e.FechaPrevista <= @spvar_FechaPrevistaHasta)
					and (@spvar_AUGE is null or e.IdGuiaClinica is not null)
					and (@spvar_CodColectivo is null or e.CodColectivo = @spvar_CodColectivo)
					and (@spvar_codCentroDestino is null or e.CodCentroFinal = @spvar_codCentroDestino)
					and (@spvar_idUnidad is null or e.IdUnidad = @spvar_idUnidad)
					and (@spvar_DniMedicoOrigen is null or e.DNIMedEpi = @spvar_DniMedicoOrigen)
					and (
						(@spvar_LibreEleccion is null and (e.LibreEleccion is null or e.LibreEleccion = 0)
						or
						(e.LibreEleccion = 1)))
					and (@spvar_PRAIS is null
										or 
										(@spvar_PRAIS = 1 and 
										EXISTS (select MS.EsPrais from 
										Hclinica..MutuasSaludSecPaciente MSSP 
										INNER JOIN parametros..MutuasSalud MS on MS.Codigo = MSSP.CodColectivo
										where codpaciente = e.CodPaciente and MS.EsPrais = 1))
										or 
										(@spvar_PRAIS = 0 and 
										NOT EXISTS (select MS.EsPrais from 
										Hclinica..MutuasSaludSecPaciente MSSP 
										INNER JOIN parametros..MutuasSalud MS on MS.Codigo = MSSP.CodColectivo
										where codpaciente = e.CodPaciente and MS.EsPrais = 1)))			
		union
				
		select	p.CodHistoria,
				p.CodPaciente,
				'PacNombre'= rtrim(p.PacNombre), 
				'PacApell1' = rtrim(p.PacApell1),
				'PacApell2' = rtrim(p.PacApell2),
				e.CodDerivacion as CodEpisodio,
				e.FechaCPrimera,				
				e.FechaConsulta,				
				e.DictamenClinico as Juicio,
				e.CodCentroFinal,
				S.Codigo, 
				s.DescServicio ServicioDestino,
				s1.DescServicio ServicioRemite,
				null as Pasiva,
				e.Solicitud,
				e.FechaPrevista,				
				case
					when 
						isnull(
								e.IdGuiaClinica,
								(
									select MIN (I.CodProblema)
									from 	(
												SELECT 
													  ipd.CodPaciente
													, ipd.CodEpisodio
													, ipd.CodProblema
													, ipd.CodSubProblema
													, ipd.CodDiagnostico
													, ipd.IDInformeIPD					
												FROM HClinica..InformeIPD ipd 
												union
												select 
													  tcGES.CodPaciente
													, tcGES.CodEpisodio
													, ipd.CodProblema
													, ipd.CodSubProblema
													, ipd.CodDiagnostico
													, tcGES.IDInformeIPD	
												FROM Hclinica..TrazabilidadCasoGES tcges 
													inner join hclinica..informeipd ipd on tcges.idinformeipd=ipd.idinformeipd 
											) I 
											inner join Parametros..CIEDiagnostico CIEDiag on I.CodDiagnostico=CIEDiag.CodDiagnostico
									WHERE I.CodPaciente=e.CodPaciente
									  and I.CodEpisodio=e.CodEpisodioOrigen	
								)
							  ) is null then 0
					else 1
				end as TieneGuia,			
				(select top 1 M.Descripcion from Parametros..[MotivosCitas] M where M.Codigo = e.IdMotivo) as MotivoPasiva,
				e.CodColectivo,
				MP.Entidad + '-' + MS.Entidad  as Aseguradora,
				cs.CodCent as HospitalRef,
				cs.NomCentro as DescCentro,				
				(case when e.CitaConfirmada = 0 then 1 else 0 end) as NoDerecho,
				null as codConsulta,
				null as fechaCita,
				null as idCita,
				null as CodTipoConsulta,
				null as CodigoServicio,
				null as confirmada,
				null as CodTipoConsulta2,
				p.NumTarjSanitaria,
				e.comunicada,
				e.CodigoRYF,
				e.CodCentroOrigen,
				cs1.DescCentro as DescCentroRef,
 				(select top 1 ID_Sidra from Parametros..[MotivosCitas] M where M.Codigo = e.IdMotivo) as IdMotivo,
				p.FecNac,
				null as CodHistoriaPapel,						
				p.Genero,
				'Sexo' = COD.Descripcion,
				'RUT Profesional' = NULL,
				'Profesional' = NULL,
				'Citador' = NULL,
				'TipoConsulta' = NULL,
				'Prioridad' = COD2.Descripcion					
   			    ,e.Estado 
			    ,e.DescUnidadDestino as Unidad				
				,p.DirTelf				
				,'TiempoEspera' = DATEDIFF(DD, e.FechaConsulta, ISNULL(e.FechaInicial, GETDATE()))
				,COD2.Posicion as OrdenPrioridad 
				,2 as DerivacionSIC
				,e.ConfirmadaDestino
				,isnull(e.DerivacionManual,0) as DerivacionManual
				,e.ComunicadaDestino
				,e.AsisteCita
				,null as ConfAsistencia 
				,null as CitaEspontanea	
				,e.FechaInicial	
				,0 as NoAtendido
				,e.FechaNoAtendida
				,e.NoAsistenciasCita
				, NULL as idOrigenCita 
				, NULL as DescOrigenCitas
				,p.Email
				,p.Direccion 
				,p.DirNum
				 ,p.CodPostal 
				 ,L.NomPoblacion  
				 ,p1.Nombre as Provincia
				,L.NomPoblacion as Localidad
				,p.telf2
				,isNull(p.TarjSanitariaResp,'') as RutTutor
				,IsNull(PMRemite.NomMedico , '') as NombreMedicoRemi
				,IsNull(PMRemite.Apell1 , '') as Apel1MedicoRemi
				,IsNull(PMRemite.Apell2 , '') as Apel2MEdicoRemi
				,IsNull(PMRemite.Nif , '') as RutMedicoRemi
				,I.DescDiagnostico
				,CI.DescDiagnostico as DescDiagnosProvi
				,e.inspecciones 
				,e.IDProblemaSalud
				,gc.DescGuia as descProblema
				,gc1.DescGuia as descSubProblema
				,isnull(PMcita.Nif,isnull(DEcita.Nif,isnull(TD.Nif,Acita.nif))) as Nif
				,e.IdCausaInterconsulta
				,e.DescCausaInterconsulta
				,e.comentarios
				,e.TipoRemision
				,e.motivo
				,p.AtiendeAlNombre as NombreSocial
				,CASE WHEN 
				(
					EXISTS (select * from Hclinica..MutuasSaludSecPaciente MSSP 
					INNER JOIN parametros..MutuasSalud MS on MS.Codigo = MSSP.CodColectivo
					where codpaciente = e.CodPaciente and MS.EsPrais = 1)
				) THEN 1 ELSE 0 END AS EsPRAIS
				,'SIC Derivada' as ProfesionalAtiende
				,p.Telf3
				,p.TelfFijoUFamiliar
				,e.RUNProfEgreso
				,e.NomProfEgreso
				,e.ObservacionEgreso 	
				,e.FechaCierre 	           
			from	Consultas..DerivacionConsultas e with (nolock)
					inner join Hclinica..Pacientes p with (nolock) on p.CodPaciente = e.codPaciente 
					left join Parametros..ServiciosExternos s with (nolock) on s.Codigo = e.CodServicioFinal
					left join Parametros..Servicios s1 with (nolock) on s1.Codigo = e.CodServicioOrigen
					left join Parametros..DatosOtrosCentros cs with (nolock) on cs.CodCent = e.CodCentroFinal
					left join Parametros..CentrosSalud cs1 with (nolock) on cs1.CodCentro = e.CodCentroOrigen						
					left join Parametros..Codigos COD on COD.Codigo = p.Genero and Tabla = 'EstGenero'				
					left join Parametros..Codigos COD2 on COD2.Codigo = e.Solicitud and COD2.Tabla = 'EstTipoExamen'
					LEFT JOIN parametros..DireccionLocalidad L ON p.DirCodLocalidad = L.CodPoblacion and p.dircodprov = l.codprovincia 		    
					LEFT JOIN parametros..codprovincias p1 on p1.codigo = p.dircodprov
					left join Parametros..ParametrosMedicos PMRemite on PMRemite.DNIMedico = e.DNIMedEpi
					LEFT JOIN Parametros..CIEDiagnostico I on e.CodDiagnosticoProvisional = I.CodDiagnostico
					LEFT JOIN Parametros..CIEDiagnostico CI on e.CodDiagnosticoPrimero = CI.CodDiagnostico
					left join  Parametros..GuiasClinicas gc on  gc.CodGuia = e.IDProblemaSalud 
					left join  Parametros..GuiasClinicas gc1 on  gc1.CodGuia = e.CodSubProblema 
					LEFT JOIN Parametros..TecnicosDatos TD on TD.DNITecnico = e.NIF
					left join Parametros..ParametrosMedicos PMcita on PMcita.DNIMedico = e.NIF
					left join Parametros..DatosEnfermeras DEcita on DEcita.DNIEnf = e.NIF
					left join Parametros..Administrativo Acita on Acita.DNIAdminist = e.NIF	
					LEFT JOIN Parametros..MutuasSalud MS ON e.CodColectivo = MS.Codigo
					LEFT JOIN Parametros..MutuaPrincipal MP ON MS.CodMutua = MP.Codigo			
			where	e.Estado = 'E'
					and p.CodPaciente = @spvar_codPaciente 
					and (@spvar_Nombre is null or PacNombre like (rtrim(@spvar_Nombre) + '%') )
					and (@spvar_Apell1 is null or PacApell1 like (rtrim(@spvar_Apell1) + '%') )
					and (@spvar_Apell2 is null or PacApell2 like (rtrim(@spvar_Apell2) + '%') )
					and (@spvar_CodServicio is null or e.CodServicioFinal = @spvar_CodServicio)
					and (@spvar_CodServicioRemite is null or e.CodServicioOrigen = @spvar_CodServicioRemite)
					and (@spvar_FecSolDesde is null or datediff(d, @spvar_FecSolDesde, e.FechaConsulta) >= 0)
					and (@spvar_FecSolHasta is null or datediff(d, @spvar_FecSolHasta, e.FechaConsulta) <= 0)
					and (@spvar_FecCita is null or datediff(d, @spvar_FecCita, e.FechaCPrimera) = 0)
					and (@spvar_FecCitaDesde is null or datediff(d, @spvar_FecCitaDesde, e.FechaCPrimera) >= 0)
					and (@spvar_FecCitaHasta is null or datediff(d, @spvar_FecCitaHasta, e.FechaCPrimera) <= 0)
					and (@spvar_CodCentro is null or e.CodCentroOrigen = @spvar_CodCentro)
					and (@spvar_CodTipoRemision is null or e.TipoRemision = @spvar_CodTipoRemision)
					and (@spvar_Prioridad is null or e.Solicitud = @spvar_Prioridad)
					and (@spvar_DniMedicoDestino is null or e.DniMedDestino = @spvar_DniMedicoDestino)
					and (@spvar_FechaPrevistaDesde is null or e.FechaPrevista >= @spvar_FechaPrevistaDesde)
					and (@spvar_FechaPrevistaHasta is null or e.FechaPrevista <= @spvar_FechaPrevistaHasta)
					and (@spvar_AUGE is null or e.IdGuiaClinica is not null)
					and (@spvar_CodColectivo is null or e.CodColectivo = @spvar_CodColectivo)
					and (@spvar_codCentroDestino is null or e.CodCentroFinal = @spvar_codCentroDestino)
					and (@spvar_idUnidad is null or e.IdUnidad = @spvar_idUnidad)
					and (@spvar_DniMedicoOrigen is null or e.DNIMedEpi = @spvar_DniMedicoOrigen)
					and (
						(@spvar_LibreEleccion is null and (e.LibreEleccion is null or e.LibreEleccion = 0)
						or
						(e.LibreEleccion = 1)))
					and (@spvar_PRAIS is null
										or 
										(@spvar_PRAIS = 1 and 
										EXISTS (select MS.EsPrais from 
										Hclinica..MutuasSaludSecPaciente MSSP 
										INNER JOIN parametros..MutuasSalud MS on MS.Codigo = MSSP.CodColectivo
										where codpaciente = e.CodPaciente and MS.EsPrais = 1))
										or 
										(@spvar_PRAIS = 0 and 
										NOT EXISTS (select MS.EsPrais from 
										Hclinica..MutuasSaludSecPaciente MSSP 
										INNER JOIN parametros..MutuasSalud MS on MS.Codigo = MSSP.CodColectivo
										where codpaciente = e.CodPaciente and MS.EsPrais = 1)))				
		end
	else
		begin
			if @spvar_Rechazadas = 1
			begin
				select	p.CodHistoria,
						p.CodPaciente,
						'PacNombre'= rtrim(p.PacNombre), 
						'PacApell1' = rtrim(p.PacApell1),
						'PacApell2' = rtrim(p.PacApell2),
						e.CodDerivacion as CodEpisodio,
						e.FechaCPrimera,						
						e.FechaConsulta,						
						e.DictamenClinico as Juicio,
						e.CodCentroFinal,
						S.Codigo, 
						s.DescServicio ServicioDestino,
						s1.DescServicio ServicioRemite,
						'2' as Pasiva,
						e.Solicitud,
						e.FechaPrevista,						
						case
							when 
								isnull(
										e.IdGuiaClinica,
										(
											select MIN (I.CodProblema)
											from 	(
														SELECT 
															  ipd.CodPaciente
															, ipd.CodEpisodio
															, ipd.CodProblema
															, ipd.CodSubProblema
															, ipd.CodDiagnostico
															, ipd.IDInformeIPD					
														FROM HClinica..InformeIPD ipd 
														union
														select 
															  tcGES.CodPaciente
															, tcGES.CodEpisodio
															, ipd.CodProblema
															, ipd.CodSubProblema
															, ipd.CodDiagnostico
															, tcGES.IDInformeIPD	
														FROM Hclinica..TrazabilidadCasoGES tcges 
															inner join hclinica..informeipd ipd on tcges.idinformeipd=ipd.idinformeipd 
													) I 
													inner join Parametros..CIEDiagnostico CIEDiag on I.CodDiagnostico=CIEDiag.CodDiagnostico
											WHERE I.CodPaciente=e.CodPaciente
											  and I.CodEpisodio=e.CodEpisodioOrigen	
										)
									  ) is null then 0
							else 1
						end as TieneGuia,					
						DescMotivoPasiva as MotivoPasiva,
						e.CodColectivo,
						MP.Entidad + '-' + MS.Entidad  as Aseguradora,
						cs.CodCent as HospitalRef,
					    cs.NomCentro as DescCentro,						
						(case when e.CitaConfirmada = 0 then 1 else 0 end) as NoDerecho,
						null as codConsulta,
						null as fechaCita,
						null as idCita,
						null as CodTipoConsulta,
						null as CodigoServicio,
						null as confirmada,
						null as CodTipoConsulta2,
					    p.NumTarjSanitaria,
					    e.comunicada,
					    e.CodigoRYF,
						e.CodCentroOrigen,
						cs1.DescCentro as DescCentroRef,
						(select top 1 ID_Sidra from Parametros..[MotivosCitas] M where M.Codigo = e.IdMotivo) as IdMotivo,
						p.FecNac,				
						null as CodHistoriaPapel,				
						p.Genero,
						'Sexo' = COD.Descripcion,
						'RUT Profesional' = NULL,
						'Profesional' = NULL,
						'Citador' = NULL,
						'TipoConsulta' = NULL,
						'Prioridad' = COD2.Descripcion	
						,e.Estado 
						,e.DescUnidadDestino as Unidad 
						,p.DirTelf						
						,'TiempoEspera' = DATEDIFF(DD, e.FechaConsulta, e.FechaBorrado)
						,COD2.Posicion as OrdenPrioridad 
						,2 as DerivacionSIC
						,e.ConfirmadaDestino
						,isnull(e.DerivacionManual,0) as DerivacionManual
						,e.ComunicadaDestino
						,e.AsisteCita
						,null as ConfAsistencia 
						,null as CitaEspontanea	
						,e.FechaInicial	
						,0 as NoAtendido
						,e.FechaNoAtendida
						,e.NoAsistenciasCita
						, NULL as idOrigenCita 
						, NULL as DescOrigenCitas
						,p.Email
						,p.Direccion 
						,p.DirNum
						 ,p.CodPostal 
						 ,L.NomPoblacion  
						 ,p1.Nombre as Provincia
						,L.NomPoblacion as Localidad
						,p.telf2
						,isNull(p.TarjSanitariaResp,'') as RutTutor
						,IsNull(PMRemite.NomMedico , '') as NombreMedicoRemi
						,IsNull(PMRemite.Apell1 , '') as Apel1MedicoRemi
						,IsNull(PMRemite.Apell2 , '') as Apel2MEdicoRemi
						,IsNull(PMRemite.Nif , '') as RutMedicoRemi
						,I.DescDiagnostico
						,CI.DescDiagnostico as DescDiagnosProvi
						,e.inspecciones 
						,e.IDProblemaSalud
						,gc.DescGuia as descProblema
						,gc1.DescGuia as descSubProblema
						,isnull(PMcita.Nif,isnull(DEcita.Nif,isnull(TD.Nif,Acita.nif))) as Nif
						,e.IdCausaInterconsulta
						,e.DescCausaInterconsulta
						,e.comentarios
						,e.TipoRemision
						,e.motivo
						,p.AtiendeAlNombre as NombreSocial
						,CASE WHEN 
						(
							EXISTS (select * from Hclinica..MutuasSaludSecPaciente MSSP 
							INNER JOIN parametros..MutuasSalud MS on MS.Codigo = MSSP.CodColectivo
							where codpaciente = e.CodPaciente and MS.EsPrais = 1)
						) THEN 1 ELSE 0 END AS EsPRAIS
						,'SIC Derivada' as ProfesionalAtiende
						,p.Telf3
						,p.TelfFijoUFamiliar
						,e.RUNProfEgreso
						,e.NomProfEgreso
						,e.ObservacionEgreso 	
						,e.FechaBorrado as FechaCierre         
				from	Consultas..DerivacionConsultasBorrados e with (nolock)
						inner join Hclinica..Pacientes p with (nolock) on p.CodPaciente = e.codPaciente 
						left join Parametros..ServiciosExternos s with (nolock) on s.Codigo = e.CodServicioFinal
						left join Parametros..Servicios s1 with (nolock) on s1.Codigo = e.CodServicioOrigen
						left join Parametros..DatosOtrosCentros cs with (nolock) on cs.CodCent = e.CodCentroFinal
						left join Parametros..CentrosSalud cs1 with (nolock) on cs1.CodCentro = e.CodCentroOrigen
						left join Parametros..Codigos COD on COD.Codigo = p.Genero and Tabla = 'EstGenero'
						left join Parametros..Codigos COD2 on COD2.Codigo = e.Solicitud and COD2.Tabla = 'EstTipoExamen'	
						LEFT JOIN parametros..DireccionLocalidad L ON p.DirCodLocalidad = L.CodPoblacion and p.dircodprov = l.codprovincia 		    
						LEFT JOIN parametros..codprovincias p1 on p1.codigo = p.dircodprov
						left join Parametros..ParametrosMedicos PMRemite on PMRemite.DNIMedico = e.DNIMedEpi
						LEFT JOIN Parametros..CIEDiagnostico I on e.CodDiagnosticoProvisional = I.CodDiagnostico
						LEFT JOIN Parametros..CIEDiagnostico CI on e.CodDiagnosticoPrimero = CI.CodDiagnostico
						left join  Parametros..GuiasClinicas gc on  gc.CodGuia = e.IDProblemaSalud 
						left join  Parametros..GuiasClinicas gc1 on  gc1.CodGuia = e.CodSubProblema 
						LEFT JOIN Parametros..TecnicosDatos TD on TD.DNITecnico = e.NIF
						left join Parametros..ParametrosMedicos PMcita on PMcita.DNIMedico = e.NIF
						left join Parametros..DatosEnfermeras DEcita on DEcita.DNIEnf = e.NIF
						left join Parametros..Administrativo Acita on Acita.DNIAdminist = e.NIF	
				        LEFT JOIN Parametros..MutuasSalud MS ON e.CodColectivo = MS.Codigo
						LEFT JOIN Parametros..MutuaPrincipal MP ON MS.CodMutua = MP.Codigo			

				where	asistido = 'R'
						and p.CodPaciente = @spvar_codPaciente 
						and (@spvar_Nombre is null or PacNombre like (rtrim(@spvar_Nombre) + '%') )
						and (@spvar_Apell1 is null or PacApell1 like (rtrim(@spvar_Apell1) + '%') )
						and (@spvar_Apell2 is null or PacApell2 like (rtrim(@spvar_Apell2) + '%') )
						and (@spvar_CodServicio is null or e.CodServicioFinal = @spvar_CodServicio)
						and (@spvar_CodServicioRemite is null or e.CodServicioOrigen = @spvar_CodServicioRemite)
						and (@spvar_FecSolDesde is null or datediff(d, @spvar_FecSolDesde, e.FechaConsulta) >= 0)
						and (@spvar_FecSolHasta is null or datediff(d, @spvar_FecSolHasta, e.FechaConsulta) <= 0)
						and (@spvar_FecCita is null or datediff(d, @spvar_FecCita, e.FechaCPrimera) = 0)
						and (@spvar_FecCitaDesde is null or datediff(d, @spvar_FecCitaDesde, e.FechaCPrimera) >= 0)
						and (@spvar_FecCitaHasta is null or datediff(d, @spvar_FecCitaHasta, e.FechaCPrimera) <= 0)
						and (@spvar_CodCentro is null or e.CodCentroOrigen = @spvar_CodCentro)
						and (@spvar_CodTipoRemision is null or e.TipoRemision = @spvar_CodTipoRemision)
						and (@spvar_Prioridad is null or e.Solicitud = @spvar_Prioridad)
						and (@spvar_DniMedicoDestino is null or e.DniMedDestino = @spvar_DniMedicoDestino)
						and (@spvar_FechaPrevistaDesde is null or e.FechaPrevista >= @spvar_FechaPrevistaDesde)
						and (@spvar_FechaPrevistaHasta is null or e.FechaPrevista <= @spvar_FechaPrevistaHasta)
						and (@spvar_AUGE is null or e.IdGuiaClinica is not null)
						and (@spvar_CodColectivo is null or e.CodColectivo = @spvar_CodColectivo)
						and (@spvar_codCentroDestino is null or e.CodCentroFinal = @spvar_codCentroDestino)
						and (@spvar_FecRecDesde is null or datediff(d, @spvar_FecRecDesde, e.FechaBorrado) >= 0)
						and (@spvar_FecRecHasta is null or datediff(d, @spvar_FecRecHasta, e.FechaBorrado) <= 0)
						and (@spvar_idUnidad is null or e.IdUnidad = @spvar_idUnidad)
						and (@spvar_DniMedicoOrigen is null or e.DNIMedEpi = @spvar_DniMedicoOrigen)
						and (
							(@spvar_LibreEleccion is null and (e.LibreEleccion is null or e.LibreEleccion = 0)
							or
							(e.LibreEleccion = 1)))
						and (@spvar_PRAIS is null
											or 
											(@spvar_PRAIS = 1 and 
											EXISTS (select MS.EsPrais from 
											Hclinica..MutuasSaludSecPaciente MSSP 
											INNER JOIN parametros..MutuasSalud MS on MS.Codigo = MSSP.CodColectivo
											where codpaciente = e.CodPaciente and MS.EsPrais = 1))
											or 
											(@spvar_PRAIS = 0 and 
											NOT EXISTS (select MS.EsPrais from 
											Hclinica..MutuasSaludSecPaciente MSSP 
											INNER JOIN parametros..MutuasSalud MS on MS.Codigo = MSSP.CodColectivo
											where codpaciente = e.CodPaciente and MS.EsPrais = 1)))
			end
		else
			begin
				if @spvar_Reservadas = 1 or @spvar_Confirmadas = 1
				begin
				--Busca las propuestas normales
				select	p.CodHistoria,
						p.CodPaciente,
						'PacNombre'= rtrim(p.PacNombre), 
						'PacApell1' = rtrim(p.PacApell1),
						'PacApell2' = rtrim(p.PacApell2),
						e.CodDerivacion as CodEpisodio,
						e.FechaCPrimera,
						e.FechaConsulta,						
						e.DictamenClinico as Juicio,
						e.CodCentroFinal,
						S.Codigo, 
						s.DescServicio ServicioDestino,
						s1.DescServicio ServicioRemite,
						'0' as Pasiva,
						e.Solicitud,
						e.FechaPrevista,						
						case
							when 
								isnull(
										e.IdGuiaClinica,
										(
											select MIN (I.CodProblema)
											from 	(
														SELECT 
															  ipd.CodPaciente
															, ipd.CodEpisodio
															, ipd.CodProblema
															, ipd.CodSubProblema
															, ipd.CodDiagnostico
															, ipd.IDInformeIPD					
														FROM HClinica..InformeIPD ipd 
														union
														select 
															  tcGES.CodPaciente
															, tcGES.CodEpisodio
															, ipd.CodProblema
															, ipd.CodSubProblema
															, ipd.CodDiagnostico
															, tcGES.IDInformeIPD	
														FROM Hclinica..TrazabilidadCasoGES tcges 
															inner join hclinica..informeipd ipd on tcges.idinformeipd=ipd.idinformeipd 
													) I 
													inner join Parametros..CIEDiagnostico CIEDiag on I.CodDiagnostico=CIEDiag.CodDiagnostico
											WHERE I.CodPaciente=e.CodPaciente
											  and I.CodEpisodio=e.CodEpisodioOrigen	
										)
									  ) is null then 0
							else 1
						end as TieneGuia,						
						'' as MotivoPasiva,
						e.CodColectivo,
						MP.Entidad + '-' + MS.Entidad  as Aseguradora,
						cs.CodCent as HospitalRef,
						cs.NomCentro as DescCentro,						
							(case when e.CitaConfirmada = 0 then 1 else 0 end) as NoDerecho,
						null as CodConsulta,
						null as FechaCita,						
						null as IdCita,
						null as CodTipoConsulta,
						null as CodigoServicio,
						null as CodTipoConsulta2,
						e.confirmada,
						p.NumTarjSanitaria,
						e.comunicada,
						e.CodigoRYF,
						e.CodCentroOrigen,
						cs1.DescCentro as DescCentroRef
						, '' IdMotivo,
						p.FecNac,				
						null as CodHistoriaPapel,				
						p.Genero,
						'Sexo' = COD.Descripcion,
						'RUT Profesional' = NULL,
						'Profesional' = NULL,
						'Citador' = NULL,
						'TipoConsulta' = NULL,
						'Prioridad' = COD2.Descripcion					
						,e.Estado 			        
						,e.DescUnidadDestino as Unidad 				
						,p.DirTelf				
						,'TiempoEspera' = DATEDIFF(DD, e.FechaConsulta, ISNULL(e.FechaInicial, GETDATE())) 
						,COD2.Posicion as OrdenPrioridad 
						,2 as DerivacionSIC
						,e.ConfirmadaDestino
						,isnull(e.DerivacionManual,0) as DerivacionManual
						,e.ComunicadaDestino
						,e.AsisteCita
						,null as ConfAsistencia 
						,null as CitaEspontanea	
						,e.FechaInicial	
						,0 as NoAtendido
						,e.FechaNoAtendida
						,e.NoAsistenciasCita
						, NULL as idOrigenCita 
						, NULL as DescOrigenCitas
						,p.Email
						,p.Direccion 
						,p.DirNum
						 ,p.CodPostal 
						 ,L.NomPoblacion  
						 ,p1.Nombre as Provincia
						,L.NomPoblacion as Localidad
						,p.telf2
						,isNull(p.TarjSanitariaResp,'') as RutTutor
						,IsNull(PMRemite.NomMedico , '') as NombreMedicoRemi
						,IsNull(PMRemite.Apell1 , '') as Apel1MedicoRemi
						,IsNull(PMRemite.Apell2 , '') as Apel2MEdicoRemi
						,IsNull(PMRemite.Nif , '') as RutMedicoRemi
						,I.DescDiagnostico
						,CI.DescDiagnostico as DescDiagnosProvi
						,e.inspecciones 
						,e.IDProblemaSalud
						,gc.DescGuia as descProblema
						,gc1.DescGuia as descSubProblema	
						,isnull(PMcita.Nif,isnull(DEcita.Nif,isnull(TD.Nif,Acita.nif))) as Nif
						,e.IdCausaInterconsulta
						,e.DescCausaInterconsulta
						,e.comentarios
						,e.TipoRemision
						,e.motivo
						,p.AtiendeAlNombre as NombreSocial
						,CASE WHEN 
						(
							EXISTS (select * from Hclinica..MutuasSaludSecPaciente MSSP 
							INNER JOIN parametros..MutuasSalud MS on MS.Codigo = MSSP.CodColectivo
							where codpaciente = e.CodPaciente and MS.EsPrais = 1)
						) THEN 1 ELSE 0 END AS EsPRAIS
						,'SIC Derivada' as ProfesionalAtiende
						,p.Telf3
						,p.TelfFijoUFamiliar   
						,e.RUNProfEgreso
						,e.NomProfEgreso
						,e.ObservacionEgreso       
						,e.FechaCierre  
				from	Consultas..DerivacionConsultas e with (nolock)
						inner join Hclinica..Pacientes p with (nolock) on p.CodPaciente = e.codPaciente 
						left join Parametros..ServiciosExternos s with (nolock) on s.Codigo = e.CodServicioFinal
						left join Parametros..Servicios s1 with (nolock) on s1.Codigo = e.CodServicioOrigen
						left join Parametros..DatosOtrosCentros cs with (nolock) on cs.CodCent = e.CodCentroFinal
						left join Parametros..CentrosSalud cs1 with (nolock) on cs1.CodCentro = e.CodCentroOrigen
						left join Parametros..Codigos COD on COD.Codigo = p.Genero and Tabla = 'EstGenero'
						left join Parametros..Codigos COD2 on COD2.Codigo = e.Solicitud and COD2.Tabla = 'EstTipoExamen'
						LEFT JOIN parametros..DireccionLocalidad L ON p.DirCodLocalidad = L.CodPoblacion and p.dircodprov = l.codprovincia 		    
						LEFT JOIN parametros..codprovincias p1 on p1.codigo = p.dircodprov
						left join Parametros..ParametrosMedicos PMRemite on PMRemite.DNIMedico = e.DNIMedEpi
						LEFT JOIN Parametros..CIEDiagnostico I on e.CodDiagnosticoProvisional = I.CodDiagnostico
						LEFT JOIN Parametros..CIEDiagnostico CI on e.CodDiagnosticoPrimero = CI.CodDiagnostico
						left join  Parametros..GuiasClinicas gc on  gc.CodGuia = e.IDProblemaSalud 
						left join  Parametros..GuiasClinicas gc1 on  gc1.CodGuia = e.CodSubProblema 
						LEFT JOIN Parametros..TecnicosDatos TD on TD.DNITecnico = e.NIF
						left join Parametros..ParametrosMedicos PMcita on PMcita.DNIMedico = e.NIF
						left join Parametros..DatosEnfermeras DEcita on DEcita.DNIEnf = e.NIF
						left join Parametros..Administrativo Acita on Acita.DNIAdminist = e.NIF	
						LEFT JOIN Parametros..MutuasSalud MS ON e.CodColectivo = MS.Codigo
						LEFT JOIN Parametros..MutuaPrincipal MP ON MS.CodMutua = MP.Codigo			
				where	p.CodPaciente = @spvar_codPaciente 
				        and (@spvar_Nombre is null or PacNombre like (rtrim(@spvar_Nombre) + '%') )
						and (@spvar_Apell1 is null or PacApell1 like (rtrim(@spvar_Apell1) + '%') )
						and (@spvar_Apell2 is null or PacApell2 like (rtrim(@spvar_Apell2) + '%') )
						and (@spvar_CodServicio is null or e.CodServicioFinal = @spvar_CodServicio)
						and (@spvar_CodServicioRemite is null or e.CodServicioOrigen = @spvar_CodServicioRemite)
						and (@spvar_FecSolDesde is null or datediff(d, @spvar_FecSolDesde, e.FechaConsulta) >= 0)
						and (@spvar_FecSolHasta is null or datediff(d, @spvar_FecSolHasta, e.FechaConsulta) <= 0)
						and (@spvar_FecCita is null or datediff(d, @spvar_FecCita, e.FechaCPrimera) = 0)
						and (@spvar_FecCitaDesde is null or datediff(d, @spvar_FecCitaDesde, e.FechaCPrimera) >= 0)
						and (@spvar_FecCitaHasta is null or datediff(d, @spvar_FecCitaHasta, e.FechaCPrimera) <= 0)
						and (@spvar_CodCentro is null or e.CodCentroOrigen = @spvar_CodCentro)
						and (@spvar_CodTipoRemision is null or e.TipoRemision = @spvar_CodTipoRemision)
						and (@spvar_Prioridad is null or e.Solicitud = @spvar_Prioridad)
						and (@spvar_DniMedicoDestino is null or e.DniMedDestino = @spvar_DniMedicoDestino)
						and (@spvar_Citados = '0' or (@spvar_Citados = '1' and e.FechaCPrimera is not null))
						and (@spvar_NoCitados = '0' or (@spvar_NoCitados = '1' and e.FechaCPrimera is null and e.confirmada = '1' and e.ConfirmadaDestino = '1'))
						and (@spvar_FechaPrevistaDesde is null or e.FechaPrevista >= @spvar_FechaPrevistaDesde)
						and (@spvar_FechaPrevistaHasta is null or e.FechaPrevista <= @spvar_FechaPrevistaHasta)
						and (@spvar_AUGE is null or e.IdGuiaClinica is not null)
						and (@spvar_CodColectivo is null or e.CodColectivo = @spvar_CodColectivo)
						and (@spvar_codCentroDestino is null or e.CodCentroFinal = @spvar_codCentroDestino)
						and (@spvar_Reservadas = '0' or (@spvar_Reservadas = '1' and e.FechaCPrimera is not null and (e.CitaConfirmada = 0 or e.CitaConfirmada is null) ))
						and (@spvar_Confirmadas = '0' or (@spvar_Confirmadas = '1' and e.FechaCPrimera is not null and e.CitaConfirmada = 1))
						and (@spvar_idUnidad is null or e.IdUnidad = @spvar_idUnidad)
						and (@spvar_DniMedicoOrigen is null or e.DNIMedEpi = @spvar_DniMedicoOrigen)
						and (
							(@spvar_LibreEleccion is null and (e.LibreEleccion is null or e.LibreEleccion = 0)
							or
							(e.LibreEleccion = 1)))
						and (@spvar_PRAIS is null
											or 
											(@spvar_PRAIS = 1 and 
											EXISTS (select MS.EsPrais from 
											Hclinica..MutuasSaludSecPaciente MSSP 
											INNER JOIN parametros..MutuasSalud MS on MS.Codigo = MSSP.CodColectivo
											where codpaciente = e.CodPaciente and MS.EsPrais = 1))
											or 
											(@spvar_PRAIS = 0 and 
											NOT EXISTS (select MS.EsPrais from 
											Hclinica..MutuasSaludSecPaciente MSSP 
											INNER JOIN parametros..MutuasSalud MS on MS.Codigo = MSSP.CodColectivo
											where codpaciente = e.CodPaciente and MS.EsPrais = 1)))
				end
			else
				begin
					if @spvar_Atendidas = 1
					begin
						select	p.CodHistoria,
						p.CodPaciente,
						'PacNombre'= rtrim(p.PacNombre), 
						'PacApell1' = rtrim(p.PacApell1),
						'PacApell2' = rtrim(p.PacApell2),
						e.CodDerivacion as CodEpisodio,
						e.FechaCPrimera,						
						e.FechaConsulta,						
						e.DictamenClinico as Juicio,
						e.CodCentroFinal,
						S.Codigo, 
						s.DescServicio ServicioDestino,
						s1.DescServicio ServicioRemite,
						'0' as Pasiva,
						e.Solicitud,
						e.FechaPrevista,						
						case
							when 
								isnull(
										e.IdGuiaClinica,
										(
											select MIN (I.CodProblema)
											from 	(
														SELECT 
															  ipd.CodPaciente
															, ipd.CodEpisodio
															, ipd.CodProblema
															, ipd.CodSubProblema
															, ipd.CodDiagnostico
															, ipd.IDInformeIPD					
														FROM HClinica..InformeIPD ipd 
														union
														select 
															  tcGES.CodPaciente
															, tcGES.CodEpisodio
															, ipd.CodProblema
															, ipd.CodSubProblema
															, ipd.CodDiagnostico
															, tcGES.IDInformeIPD	
														FROM Hclinica..TrazabilidadCasoGES tcges 
															inner join hclinica..informeipd ipd on tcges.idinformeipd=ipd.idinformeipd 
													) I 
													inner join Parametros..CIEDiagnostico CIEDiag on I.CodDiagnostico=CIEDiag.CodDiagnostico
											WHERE I.CodPaciente=e.CodPaciente
											  and I.CodEpisodio=e.CodEpisodioOrigen	
										)
									  ) is null then 0
							else 1
						end as TieneGuia,
						'' as MotivoPasiva,
						e.CodColectivo,
						MP.Entidad + '-' + MS.Entidad  as Aseguradora,
						cs.CodCent as HospitalRef,
						cs.NomCentro as DescCentro,						
							(case when e.CitaConfirmada = 0 then 1 else 0 end) as NoDerecho,
						null as CodConsulta,
						null as FechaCita,						
						null as IdCita,
						null as CodTipoConsulta,
						null as CodigoServicio,
						null as CodTipoConsulta2,
						e.confirmada,
						p.NumTarjSanitaria,
						e.comunicada,
						e.CodigoRYF,
						e.CodCentroOrigen,
						cs1.DescCentro as DescCentroRef
						,'' IdMotivo,
						p.FecNac,
						null as CodHistoriaPapel,				
						p.Genero,
						'Sexo' = COD.Descripcion,
						'RUT Profesional' = NULL,
						'Profesional' = NULL,
						'Citador' = NULL,
						'TipoConsulta' = NULL,
						'Prioridad' = COD2.Descripcion	
						,e.Estado
						,e.DescUnidadDestino as Unidad 						
						,p.DirTelf						
						,'TiempoEspera' = DATEDIFF(DD, e.FechaConsulta, ISNULL(e.FechaInicial, GETDATE())) 
						,COD2.Posicion as OrdenPrioridad 
						,2 as DerivacionSIC
						,e.ConfirmadaDestino
						,isnull(e.DerivacionManual,0) as DerivacionManual
						,e.ComunicadaDestino
						,e.AsisteCita
						,null as ConfAsistencia
						,null as CitaEspontanea	
						,e.FechaInicial	
						,0 as NoAtendido
						,e.FechaNoAtendida
						,e.NoAsistenciasCita
						, NULL as idOrigenCita 
						, NULL as DescOrigenCitas
						,p.Email
						,p.Direccion 
						,p.DirNum
						 ,p.CodPostal 
						 ,L.NomPoblacion  
						 ,p1.Nombre as Provincia
						,L.NomPoblacion as Localidad
						,p.telf2
						,isNull(p.TarjSanitariaResp,'') as RutTutor
						,IsNull(PMRemite.NomMedico , '') as NombreMedicoRemi
						,IsNull(PMRemite.Apell1 , '') as Apel1MedicoRemi
						,IsNull(PMRemite.Apell2 , '') as Apel2MEdicoRemi
						,IsNull(PMRemite.Nif , '') as RutMedicoRemi
						,I.DescDiagnostico
						,CI.DescDiagnostico as DescDiagnosProvi
						,e.inspecciones 
						,e.IDProblemaSalud
						,gc.DescGuia as descProblema
						,gc1.DescGuia as descSubProblema						
						,isnull(PMcita.Nif,isnull(DEcita.Nif,isnull(TD.Nif,Acita.nif))) as Nif
						,e.IdCausaInterconsulta
						,e.DescCausaInterconsulta
						,e.comentarios
						,e.TipoRemision
						,e.motivo
						,p.AtiendeAlNombre as NombreSocial
						,CASE WHEN 
						(
							EXISTS (select * from Hclinica..MutuasSaludSecPaciente MSSP 
							INNER JOIN parametros..MutuasSalud MS on MS.Codigo = MSSP.CodColectivo
							where codpaciente = e.CodPaciente and MS.EsPrais = 1)
						) THEN 1 ELSE 0 END AS EsPRAIS
						,'SIC Derivada' as ProfesionalAtiende
						,p.Telf3
						,p.TelfFijoUFamiliar
						,e.RUNProfEgreso
						,e.NomProfEgreso
						,e.ObservacionEgreso 	    
						,e.FechaCierre       
				from	Consultas..DerivacionConsultas e with (nolock)
						inner join Hclinica..Pacientes p with (nolock) on p.CodPaciente = e.codPaciente 
						left join Parametros..ServiciosExternos s with (nolock) on s.Codigo = e.CodServicioFinal
						left join Parametros..Servicios s1 with (nolock) on s1.Codigo = e.CodServicioOrigen
						left join Parametros..DatosOtrosCentros cs with (nolock) on cs.CodCent = e.CodCentroFinal
						left join Parametros..CentrosSalud cs1 with (nolock) on cs1.CodCentro = e.CodCentroOrigen						
						left join Parametros..Codigos COD on COD.Codigo = p.Genero and Tabla = 'EstGenero'
						left join Parametros..Codigos COD2 on COD2.Codigo = e.Solicitud and COD2.Tabla = 'EstTipoExamen'
						LEFT JOIN parametros..DireccionLocalidad L ON p.DirCodLocalidad = L.CodPoblacion and p.dircodprov = l.codprovincia 		    
						LEFT JOIN parametros..codprovincias p1 on p1.codigo = p.dircodprov
						left join Parametros..ParametrosMedicos PMRemite on PMRemite.DNIMedico = e.DNIMedEpi
						LEFT JOIN Parametros..CIEDiagnostico I on e.CodDiagnosticoProvisional = I.CodDiagnostico
						LEFT JOIN Parametros..CIEDiagnostico CI on e.CodDiagnosticoPrimero = CI.CodDiagnostico
						left join  Parametros..GuiasClinicas gc on  gc.CodGuia = e.IDProblemaSalud 
						left join  Parametros..GuiasClinicas gc1 on  gc1.CodGuia = e.CodSubProblema 
						LEFT JOIN Parametros..TecnicosDatos TD on TD.DNITecnico = e.NIF
						left join Parametros..ParametrosMedicos PMcita on PMcita.DNIMedico = e.NIF
						left join Parametros..DatosEnfermeras DEcita on DEcita.DNIEnf = e.NIF
						left join Parametros..Administrativo Acita on Acita.DNIAdminist = e.NIF	
						LEFT JOIN Parametros..MutuasSalud MS ON e.CodColectivo = MS.Codigo
						LEFT JOIN Parametros..MutuaPrincipal MP ON MS.CodMutua = MP.Codigo			
				where   e.AsisteCita = 1
						and p.CodPaciente = @spvar_codPaciente 
						and (@spvar_Nombre is null or PacNombre like (rtrim(@spvar_Nombre) + '%') )
						and (@spvar_Apell1 is null or PacApell1 like (rtrim(@spvar_Apell1) + '%') )
						and (@spvar_Apell2 is null or PacApell2 like (rtrim(@spvar_Apell2) + '%') )
						and (@spvar_CodServicio is null or e.CodServicioFinal = @spvar_CodServicio)
						and (@spvar_CodServicioRemite is null or e.CodServicioOrigen = @spvar_CodServicioRemite)
						and (@spvar_FecSolDesde is null or datediff(d, @spvar_FecSolDesde, e.FechaConsulta) >= 0)
						and (@spvar_FecSolHasta is null or datediff(d, @spvar_FecSolHasta, e.FechaConsulta) <= 0)
						and (@spvar_FecCita is null or datediff(d, @spvar_FecCita, e.FechaCPrimera) = 0)
						and (@spvar_FecCitaDesde is null or datediff(d, @spvar_FecCitaDesde, e.FechaCPrimera) >= 0)
						and (@spvar_FecCitaHasta is null or datediff(d, @spvar_FecCitaHasta, e.FechaCPrimera) <= 0)
						and (@spvar_CodCentro is null or e.CodCentroOrigen = @spvar_CodCentro)
						and (@spvar_CodTipoRemision is null or e.TipoRemision = @spvar_CodTipoRemision)
						and (@spvar_Prioridad is null or e.Solicitud = @spvar_Prioridad)
						and (@spvar_DniMedicoDestino is null or e.DniMedDestino = @spvar_DniMedicoDestino)
						and (@spvar_Citados = '0' or (@spvar_Citados = '1' and e.FechaCPrimera is not null))
						and (@spvar_NoCitados = '0' or (@spvar_NoCitados = '1' and e.FechaCPrimera is null and e.confirmada = '1' and e.ConfirmadaDestino = '1'))
						and (@spvar_FechaPrevistaDesde is null or e.FechaPrevista >= @spvar_FechaPrevistaDesde)
						and (@spvar_FechaPrevistaHasta is null or e.FechaPrevista <= @spvar_FechaPrevistaHasta)
						and (@spvar_AUGE is null or e.IdGuiaClinica is not null)
						and (@spvar_CodColectivo is null or e.CodColectivo = @spvar_CodColectivo)
						and (@spvar_codCentroDestino is null or e.CodCentroFinal = @spvar_codCentroDestino)
						and (@spvar_Reservadas = '0' or (@spvar_Reservadas = '1' and e.FechaCPrimera is not null and (e.CitaConfirmada = 0 or e.CitaConfirmada is null)))
						and (@spvar_Confirmadas = '0' or (@spvar_Confirmadas = '1' and e.FechaCPrimera is not null and e.citaConfirmada = 1))
						and (@spvar_idUnidad is null or e.IdUnidad = @spvar_idUnidad)
						and (@spvar_DniMedicoOrigen is null or e.DNIMedEpi = @spvar_DniMedicoOrigen)
						and (
							(@spvar_LibreEleccion is null and (e.LibreEleccion is null or e.LibreEleccion = 0)
							or
							(e.LibreEleccion = 1)))
						and (@spvar_PRAIS is null
											or 
											(@spvar_PRAIS = 1 and 
											EXISTS (select MS.EsPrais from 
											Hclinica..MutuasSaludSecPaciente MSSP 
											INNER JOIN parametros..MutuasSalud MS on MS.Codigo = MSSP.CodColectivo
											where codpaciente = e.CodPaciente and MS.EsPrais = 1))
											or 
											(@spvar_PRAIS = 0 and 
											NOT EXISTS (select MS.EsPrais from 
											Hclinica..MutuasSaludSecPaciente MSSP 
											INNER JOIN parametros..MutuasSalud MS on MS.Codigo = MSSP.CodColectivo
											where codpaciente = e.CodPaciente and MS.EsPrais = 1)))
					end
				else
					begin
						select 
						e.Codhistoria,
						e.CodPaciente,
						'PacNombre'=  rtrim(p.Pacnombre),
						'PacApell1' = rtrim(p.PacApell1),
						'PacApell2' = rtrim(p.PacApell2),
						e.CodDerivacion as CodEpisodio,
						e.FechaCPrimera,						
						e.FechaConsulta,						
						e.DictamenClinico as Juicio,
						e.CodCentroFinal,
						S.Codigo, 
						s.DescServicio ServicioDestino,
						s1.DescServicio ServicioRemite,
						'0' as Pasiva,
						e.Solicitud,
						e.FechaPrevista,						
						case
							when 
								isnull(
										e.IdGuiaClinica,
										(
											select MIN (I.CodProblema)
											from 	(
														SELECT 
															  ipd.CodPaciente
															, ipd.CodEpisodio
															, ipd.CodProblema
															, ipd.CodSubProblema
															, ipd.CodDiagnostico
															, ipd.IDInformeIPD					
														FROM HClinica..InformeIPD ipd 
														union
														select 
															  tcGES.CodPaciente
															, tcGES.CodEpisodio
															, ipd.CodProblema
															, ipd.CodSubProblema
															, ipd.CodDiagnostico
															, tcGES.IDInformeIPD	
														FROM Hclinica..TrazabilidadCasoGES tcges 
															inner join hclinica..informeipd ipd on tcges.idinformeipd=ipd.idinformeipd 
													) I 
													inner join Parametros..CIEDiagnostico CIEDiag on I.CodDiagnostico=CIEDiag.CodDiagnostico
											WHERE I.CodPaciente=e.CodPaciente
											  and I.CodEpisodio=e.CodEpisodioOrigen	
										)
									  ) is null then 0
							else 1
						end as TieneGuia,					
						'' as MotivoPasiva,
						e.CodColectivo,
						MP.Entidad + '-' + MS.Entidad  as Aseguradora,
						cs.CodCent as HospitalRef,
						cs.NomCentro as DescCentro,						
						(case when e.CitaConfirmada = 0 then 1 else 0 end) as NoDerecho,
						null as CodConsulta,
						null as FechaCita,						
						null as IdCita,
						null as CodTipoConsulta,
						null as CodigoServicio,
						null as CodTipoConsulta2,
						e.Confirmada,
						p.NumTarjSanitaria,
						e.comunicada,
						e.CodigoRYF,
						e.CodCentroOrigen,
						cs1.DescCentro as DescCentroRef
						, '' IdMotivo,
						p.FecNac,				
						null as CodHistoriaPapel,				
						p.Genero,
						'Sexo' = COD.Descripcion,
						'RUT Profesional' = NULL,
						'Profesional' = NULL,
						'Citador' = NULL,
						'TipoConsulta' = NULL,
						'Prioridad' = COD2.Descripcion								
			    		,e.Estado 			    	
			    		,e.DescUnidadDestino as Unidad 				
						,p.DirTelf				
						,'TiempoEspera' = DATEDIFF(DD, e.FechaConsulta, ISNULL(e.FechaInicial, GETDATE()))
						,COD2.Posicion as OrdenPrioridad 
						,2 as DerivacionSIC
						,e.ConfirmadaDestino
						,isnull(e.DerivacionManual,0) as DerivacionManual
						,e.ComunicadaDestino
						,e.AsisteCita
						,null as ConfAsistencia 
						,null as CitaEspontanea	
						,e.FechaInicial
						,0 as NoAtendido
						,e.FechaNoAtendida
						,e.NoAsistenciasCita
						, NULL as idOrigenCita 
						, NULL as DescOrigenCitas
						,p.Email
						,p.Direccion 
						,p.DirNum
						 ,p.CodPostal 
						 ,L.NomPoblacion  
						 ,p1.Nombre as Provincia
						,L.NomPoblacion as Localidad
						,p.telf2
						,isNull(p.TarjSanitariaResp,'') as RutTutor
						,IsNull(PMRemite.NomMedico , '') as NombreMedicoRemi
						,IsNull(PMRemite.Apell1 , '') as Apel1MedicoRemi
						,IsNull(PMRemite.Apell2 , '') as Apel2MEdicoRemi
						,IsNull(PMRemite.Nif , '') as RutMedicoRemi
						,I.DescDiagnostico
						,CI.DescDiagnostico as DescDiagnosProvi
						,e.inspecciones 
						,e.IDProblemaSalud
						,gc.DescGuia as descProblema
						,gc1.DescGuia as descSubProblema
						,isnull(PMcita.Nif,isnull(DEcita.Nif,isnull(TD.Nif,Acita.nif))) as Nif
						,e.IdCausaInterconsulta
						,e.DescCausaInterconsulta
						,e.comentarios
						,e.TipoRemision
						,e.motivo
						,p.AtiendeAlNombre as NombreSocial
						,CASE WHEN 
						(
							EXISTS (select * from Hclinica..MutuasSaludSecPaciente MSSP 
							INNER JOIN parametros..MutuasSalud MS on MS.Codigo = MSSP.CodColectivo
							where codpaciente = e.CodPaciente and MS.EsPrais = 1)
						) THEN 1 ELSE 0 END AS EsPRAIS	
						,'SIC Derivada' as ProfesionalAtiende
						,p.Telf3
						,p.TelfFijoUFamiliar	
						,e.RUNProfEgreso
						,e.NomProfEgreso
						,e.ObservacionEgreso     
						,e.FechaCierre       
				from	Consultas..DerivacionConsultas e with (nolock)
						inner join Hclinica..Pacientes p with (nolock) on p.CodPaciente = e.codPaciente 
						left join Parametros..ServiciosExternos s with (nolock) on s.Codigo = e.CodServicioFinal
						left join Parametros..Servicios s1 with (nolock) on s1.Codigo = e.CodServicioOrigen						
						left join Parametros..DatosOtrosCentros cs with (nolock) on cs.CodCent = e.CodCentroFinal
						left join Parametros..CentrosSalud cs1 with (nolock) on cs1.CodCentro = e.CodCentroOrigen
						left join Parametros..MutuasSalud m on e.CodColectivo = m.codigo						
						left join Parametros..Codigos COD on COD.Codigo = p.Genero and Tabla = 'EstGenero'						
						left join Parametros..Codigos COD2 on COD2.Codigo = e.Solicitud and COD2.Tabla = 'EstTipoExamen'
						LEFT JOIN parametros..DireccionLocalidad L ON p.DirCodLocalidad = L.CodPoblacion and p.dircodprov = l.codprovincia 		    
						LEFT JOIN parametros..codprovincias p1 on p1.codigo = p.dircodprov
						left join Parametros..ParametrosMedicos PMRemite on PMRemite.DNIMedico = e.DNIMedEpi
						LEFT JOIN Parametros..CIEDiagnostico I on e.CodDiagnosticoProvisional = I.CodDiagnostico
						LEFT JOIN Parametros..CIEDiagnostico CI on e.CodDiagnosticoPrimero = CI.CodDiagnostico
						left join  Parametros..GuiasClinicas gc on  gc.CodGuia = e.IDProblemaSalud 
						left join  Parametros..GuiasClinicas gc1 on  gc1.CodGuia = e.CodSubProblema 	
						LEFT JOIN Parametros..TecnicosDatos TD on TD.DNITecnico = e.NIF
						left join Parametros..ParametrosMedicos PMcita on PMcita.DNIMedico = e.NIF
						left join Parametros..DatosEnfermeras DEcita on DEcita.DNIEnf = e.NIF
						left join Parametros..Administrativo Acita on Acita.DNIAdminist = e.NIF						
						LEFT JOIN Parametros..MutuasSalud MS ON e.CodColectivo = MS.Codigo
						LEFT JOIN Parametros..MutuaPrincipal MP ON MS.CodMutua = MP.Codigo			
				where   p.CodPaciente = @spvar_codPaciente 
						and (@spvar_Nombre is null or PacNombre like (rtrim(@spvar_Nombre) + '%') )
                        and (@spvar_Apell1 is null or PacApell1 like (rtrim(@spvar_Apell1) + '%') )
                        and (@spvar_Apell2 is null or PacApell2 like (rtrim(@spvar_Apell2) + '%') )
                        and (@spvar_CodServicio is null or e.CodServicioFinal = @spvar_CodServicio)
                        and (@spvar_CodServicioRemite is null or e.CodServicioOrigen = @spvar_CodServicioRemite)
                        and (@spvar_FecSolDesde is null or datediff(d, @spvar_FecSolDesde, e.FechaConsulta) >= 0)
                        and (@spvar_FecSolHasta is null or datediff(d, @spvar_FecSolHasta, e.FechaConsulta) <= 0)
                        and (@spvar_FecCita is null or datediff(d, @spvar_FecCita, e.FechaCPrimera) = 0)
                        and (@spvar_FecCitaDesde is null or datediff(d, @spvar_FecCitaDesde, e.FechaCPrimera) >= 0)
                        and (@spvar_FecCitaHasta is null or datediff(d, @spvar_FecCitaHasta, e.FechaCPrimera) <= 0)
                        and (@spvar_CodCentro is null or e.CodCentroOrigen = @spvar_CodCentro)
                        and (@spvar_CodTipoRemision is null or e.TipoRemision = @spvar_CodTipoRemision)
                        and (@spvar_Prioridad is null or e.Solicitud = @spvar_Prioridad)
                        and (@spvar_DniMedicoDestino is null or e.DniMedDestino = @spvar_DniMedicoDestino)
                        and (@spvar_Citados = '0' or (@spvar_Citados = '1' and e.FechaCPrimera is not null))
						and (@spvar_NoCitados = '0' or (@spvar_NoCitados = '1' and e.FechaCPrimera is null and e.confirmada = '1' and e.ConfirmadaDestino = '1'))
                        and (@spvar_FechaPrevistaDesde is null or e.FechaPrevista >= @spvar_FechaPrevistaDesde)
                        and (@spvar_FechaPrevistaHasta is null or e.FechaPrevista <= @spvar_FechaPrevistaHasta)
                        and (@spvar_AUGE is null or e.IdGuiaClinica is not null)
                        and (@spvar_CodColectivo is null or e.CodColectivo = @spvar_CodColectivo)
                        and (@spvar_codCentroDestino is null or e.CodCentroFinal = @spvar_codCentroDestino)           
                        and (@spvar_PropConfirmadas = '0' or (@spvar_PropConfirmadas = '1' and e.confirmada = 1 and e.ConfirmadaDestino = 1))                       
                        and (@spvar_FecConfDesde is null or (datediff(d, @spvar_FecConfDesde, e.FechaConfirmacion) >= 0) or (e.fechaConfirmacion is null and (datediff(d, @spvar_FecConfDesde, e.FechaConsulta) >= 0)))
                        and (@spvar_FecConfHasta is null or (datediff(d, @spvar_FecConfHasta, e.FechaConfirmacion) <= 0) or (e.fechaConfirmacion is null and (datediff(d, @spvar_FecConfHasta, e.FechaConsulta) >= 0))) 
                        and (@spvar_PropPendientes = '0' or (@spvar_PropPendientes = '1' and (e.confirmada = 0 or e.ConfirmadaDestino = 0)))
                        and (@spvar_idUnidad is null or e.IdUnidad = @spvar_idUnidad)
                        and (@spvar_Comunicadas = '0' or ((@spvar_Comunicadas = '1' and e.Comunicada = 1)))
                        and (@spvar_SinComunicar = '0' or (@spvar_SinComunicar = '1' and e.comunicada = 0 and e.confirmada = 1))
						and (@spvar_DniMedicoOrigen is null or e.DNIMedEpi = @spvar_DniMedicoOrigen)
						and (
							(@spvar_LibreEleccion is null and (e.LibreEleccion is null or e.LibreEleccion = 0)
							or
							(e.LibreEleccion = 1)))
						and (@spvar_PRAIS is null
											or 
											(@spvar_PRAIS = 1 and 
											EXISTS (select MS.EsPrais from 
											Hclinica..MutuasSaludSecPaciente MSSP 
											INNER JOIN parametros..MutuasSalud MS on MS.Codigo = MSSP.CodColectivo
											where codpaciente = e.CodPaciente and MS.EsPrais = 1))
											or 
											(@spvar_PRAIS = 0 and 
											NOT EXISTS (select MS.EsPrais from 
											Hclinica..MutuasSaludSecPaciente MSSP 
											INNER JOIN parametros..MutuasSalud MS on MS.Codigo = MSSP.CodColectivo
											where codpaciente = e.CodPaciente and MS.EsPrais = 1)))
					end
				end
			end
		end

	END


GO
GO



--dbo.SpConSDerivacionesSICFechas3SinPac.sql

USE [Consultas]
GO
/****** Object:  StoredProcedure [dbo].[SpConSDerivacionesSICFechas3SinPac]    Script Date: 25/08/2017 13:44:06 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


/*
***********************************************************************
PROCEDIMIENTO		: SpConSDerivacionesSICFechas3SinPac
FUNCION				: Busca las propuestas de consultas externas filtrando por cualquier campo, cuando NO existe código paciente
DEVUELVE			:
FECHA				: 30/10/2013
VERSION				: 1.0
AUTOR				: Enrique Sánchez
TAREA				: CHC2076 - Derivación SIC - v4.41.1
MODIFICACION		: (09/07/2014) - v4.46 – 0001022: 10925 – JVT - Observaciones pendientes derivación entre instancias
MODIFICACION		: (29/08/2014) - v4.46r2 - 1247 - RRG - Incluir estado de confirmacion de asistencia - REQ 53268
MODIFICACIÓN		: (20/11/2014) - 1169 - VAS - Citas espontáneas
MODIFICACIÓN		: (20/11/2014) - V4.48 - 1489 - VAS - Iconos estado SIC en Gestor Interconsultas
MODIFICACIÓN        : (20/11/2014) Alberto Pagán Benedicto - V4.49 - 1440 - APB - Segunda parte Derivación entre instancias
MODIFICACION		: (24/12/2014) - v4.49 - 1439 - RRG - Transversalidad del caso GES - REQ 55104
MODIFICACIÓN		: (08/01/2015) - V4.49 – 1440 – ACT – Segunda parte Derivación entre instancias
MODIFICACIÓN		: (30/04/2015) - V4.49r3 – 2156 – APO – Derivación entre instancias
MODIFICACION		: (29/06/2015) v4.52 - 1899 - SGN - Problema distribución cupos florence
MODIFICACION		: (16/11/2015) v4.55r1 - 2696 - CCM - Impresión múltiples SIC
MODIFICACION        : (09/05/2017) - 17.2 - 16146 - SGH - Incluir Nombre Social del Paciente
MODIFICACION		: (19/05/2017) - 17.2 - 16506 - SGH - Filtros Prais Listados Sol. Interconsultas e Intervenciones
MODIFICACION		: (26/05/2017) - 17.2 - 16112 - SGH - Modificar reporte de gestor de interconsultas
MODIFICACION		: (23/08/2017) - v17.3 – 18451 – FCB - Ingresar observación al motivo de egreso en SIC
***********************************************************************
*/

ALTER PROCEDURE [dbo].[SpConSDerivacionesSICFechas3SinPac]
	 @spvar_Nombre char(20) = null
	,@spvar_Apell1 char(25) = null
	,@spvar_Apell2 char(25) = null
	,@spvar_CodServicio	char(4) = null
	,@spvar_CodServicioRemite char(4) = null
	,@spvar_FecSolDesde	smalldatetime = null
	,@spvar_FecSolHasta	smalldatetime = null
	,@spvar_Citados bit = 0
	,@spvar_NoCitados bit = 0
	,@spvar_FecCita smalldatetime = null
	,@spvar_FecCitaDesde smalldatetime = null
	,@spvar_FecCitaHasta smalldatetime = null
	,@spvar_CodCentro char(5)= null
	,@spvar_CodTipoRemision char(1)= null
	,@spvar_Prioridad char(1) = null
	,@spvar_DniMedicoDestino char(8)= null
	,@spvar_BuscaPasivas bit = 0
	,@spvar_NumQuery int = 0
	,@spvar_FechaPrevistaDesde smalldatetime = null
	,@spvar_FechaPrevistaHasta smalldatetime = null
	,@spvar_AUGE bit = null
	,@spvar_Eliminadas bit = null
	,@spvar_Rechazadas bit = null
	,@spvar_CodColectivo varchar(5) = null
	,@spvar_codCentroDestino char(5) = null
	,@spvar_Reservadas bit = 0
	,@spvar_Confirmadas bit = 0
	,@spvar_PropConfirmadas bit = 0
	,@spvar_FecRecDesde smalldatetime = null
	,@spvar_FecRecHasta smalldatetime = null
	,@spvar_FecConfDesde smalldatetime = null
	,@spvar_FecConfHasta smalldatetime = null
	,@spvar_PropPendientes bit = 0
	,@spvar_idUnidad int = null
	,@spvar_Comunicadas bit = 0
	,@spvar_SinComunicar bit = 0
	,@spvar_LibreEleccion bit = null
	,@spvar_DniMedicoOrigen char(8) = null
	,@spvar_NumFilasCCEE int = null
	,@spvar_Atendidas bit = 0
	,@spvar_ConfAsistencia bit = 0 
	,@spvar_CitaEspontanea bit = 0
	,@spvar_PRAIS bit = null 
as

--Aplicamos máximo de filas si este parámetro trae algún valor.
if @spvar_NumFilasCCEE is not null
	set rowcount @spvar_NumFilasCCEE

--Busca las propuestas pasivas
if @spvar_BuscaPasivas = 1 
BEGIN
	select	p.CodHistoria,
			p.CodPaciente,
			'PacNombre'= rtrim(p.PacNombre), 
			'PacApell1' = rtrim(p.PacApell1),
			'PacApell2' = rtrim(p.PacApell2),
			e.CodDerivacion as CodEpisodio,				
			e.FechaCPrimera,				
			e.FechaConsulta,			
			e.DictamenClinico as Juicio,
			e.CodCentroFinal,
			S.Codigo, 
			s.DescServicio ServicioDestino,
			s1.DescServicio ServicioRemite,
			'0' as Pasiva,
			e.Solicitud, 
			e.FechaPrevista,			
			case
				when 
					isnull(
							e.IdGuiaClinica,
							(
								select MIN (I.CodProblema)
								from 	(
											SELECT 
												  ipd.CodPaciente
												, ipd.CodEpisodio
												, ipd.CodProblema
												, ipd.CodSubProblema
												, ipd.CodDiagnostico
												, ipd.IDInformeIPD					
											FROM HClinica..InformeIPD ipd 
											union
											select 
												  tcGES.CodPaciente
												, tcGES.CodEpisodio
												, ipd.CodProblema
												, ipd.CodSubProblema
												, ipd.CodDiagnostico
												, tcGES.IDInformeIPD	
											FROM Hclinica..TrazabilidadCasoGES tcges 
												inner join hclinica..informeipd ipd on tcges.idinformeipd=ipd.idinformeipd 
										) I 
										inner join Parametros..CIEDiagnostico CIEDiag on I.CodDiagnostico=CIEDiag.CodDiagnostico
								WHERE I.CodPaciente=e.CodPaciente
								  and I.CodEpisodio=e.CodEpisodioOrigen	
							)
						  ) is null then 0
				else 1
			end as TieneGuia,
			'' as MotivoPasiva, 
			e.CodColectivo,
			MP.Entidad + '-' + MS.Entidad as Aseguradora,
			cs.CodCent as HospitalRef,
			cs.NomCentro as DescCentro,
			(case when e.CitaConfirmada = 0 then 1 else 0 end) as NoDerecho,
			null as codConsulta,
			null as fechaCita,
			null as idCita,
			null as CodTipoConsulta,
			null as CodigoServicio,
			null as confirmada,
			null as CodTipoConsulta2,
			p.NumTarjSanitaria,
			e.comunicada,
			e.CodigoRYF,
			e.CodCentroOrigen,
			cs1.DescCentro as DescCentroRef,
			(select top 1 ISNULL(ID_Sidra, '') from Parametros..[MotivosCitas] M where M.Codigo = e.IdMotivo) as IdMotivo,
			p.FecNac,
			null as CodHistoriaPapel,			
			p.Genero,
			'Sexo' = COD.Descripcion,
			'RUT Profesional' = NULL,
			'Profesional' = NULL,
			'Citador' = NULL,
			'TipoConsulta' = NULL,
			'Prioridad' = COD2.Descripcion				
		    ,e.Estado 		    
		    ,e.DescUnidadDestino as Unidad 			
			,p.DirTelf			
			,'TiempoEspera' = DATEDIFF(DD, e.FechaConsulta, ISNULL(e.FechaInicial, GETDATE())) 
			,COD2.Posicion as OrdenPrioridad 
			,2 as DerivacionSIC
			,e.ConfirmadaDestino
			,isnull(e.DerivacionManual,0) as DerivacionManual
			,e.ComunicadaDestino
			,e.AsisteCita
			,null as ConfAsistencia 
			,null as CitaEspontanea	
			,e.FechaInicial	
			,0 as NoAtendido
			,e.FechaNoAtendida
			,e.NoAsistenciasCita
			, NULL as idOrigenCita 
			, NULL as DescOrigenCitas
			,p.Email
			,p.Direccion 
			,p.DirNum
			 ,p.CodPostal 
			 ,L.NomPoblacion  
			 ,p1.Nombre as Provincia
			,L.NomPoblacion as Localidad
			,p.telf2
			,isNull(p.TarjSanitariaResp,'') as RutTutor
			,IsNull(PMRemite.NomMedico , '') as NombreMedicoRemi
			,IsNull(PMRemite.Apell1 , '') as Apel1MedicoRemi
			,IsNull(PMRemite.Apell2 , '') as Apel2MEdicoRemi
			,IsNull(PMRemite.Nif , '') as RutMedicoRemi
			,I.DescDiagnostico
			,CI.DescDiagnostico as DescDiagnosProvi
			,e.inspecciones 
			,e.IDProblemaSalud
			,gc.DescGuia as descProblema
			,gc1.DescGuia as descSubProblema
			,isnull(PMcita.Nif,isnull(DEcita.Nif,isnull(TD.Nif,Acita.nif))) as Nif
			,e.IdCausaInterconsulta
			,e.DescCausaInterconsulta
			,e.comentarios
			,e.TipoRemision
			,e.motivo
			,p.AtiendeAlNombre as NombreSocial
			,CASE WHEN 
			(
				EXISTS (select * from Hclinica..MutuasSaludSecPaciente MSSP 
				INNER JOIN parametros..MutuasSalud MS on MS.Codigo = MSSP.CodColectivo
				where codpaciente = e.CodPaciente and MS.EsPrais = 1)
			) THEN 1 ELSE 0 END AS EsPRAIS
			,'' as ProfesionalAtiende
			,p.Telf3
			,p.TelfFijoUFamiliar
			,e.RUNProfEgreso
			,e.NomProfEgreso
			,e.ObservacionEgreso 
			,e.FechaCierre				
	from	
			Consultas..DerivacionConsultas e with (nolock) 
			inner join Hclinica..Pacientes p with (nolock)  on p.CodPaciente = e.CodPaciente
			left join Parametros..ServiciosExternos s with (nolock) on s.Codigo = e.CodServicioFinal
			left join Parametros..Servicios s1 with (nolock) on s1.Codigo = e.CodServicioOrigen
			left join Parametros..DatosOtrosCentros cs with (nolock) on cs.CodCent = e.CodCentroFinal
			left join Parametros..CentrosSalud cs1 with (nolock) on cs1.CodCentro = e.CodCentroOrigen
			left join Parametros..Codigos COD on COD.Codigo = p.Genero and Tabla = 'EstGenero'			
			left join Parametros..Codigos COD2 on COD2.Codigo = e.Solicitud and COD2.Tabla = 'EstTipoExamen'	
			LEFT JOIN parametros..DireccionLocalidad L ON p.DirCodLocalidad = L.CodPoblacion and p.dircodprov = l.codprovincia 		    
			LEFT JOIN parametros..codprovincias p1 on p1.codigo = p.dircodprov
			left join Parametros..ParametrosMedicos PMRemite on PMRemite.DNIMedico = e.DNIMedEpi
			LEFT JOIN Parametros..CIEDiagnostico I on e.CodDiagnosticoProvisional = I.CodDiagnostico
			LEFT JOIN Parametros..CIEDiagnostico CI on e.CodDiagnosticoPrimero = CI.CodDiagnostico
			left join  Parametros..GuiasClinicas gc on  gc.CodGuia = e.IDProblemaSalud 
			left join  Parametros..GuiasClinicas gc1 on  gc1.CodGuia = e.CodSubProblema	
			LEFT JOIN Parametros..TecnicosDatos TD on TD.DNITecnico = e.NIF
			left join Parametros..ParametrosMedicos PMcita on PMcita.DNIMedico = e.NIF
			left join Parametros..DatosEnfermeras DEcita on DEcita.DNIEnf = e.NIF
			left join Parametros..Administrativo Acita on Acita.DNIAdminist = e.NIF	
			LEFT JOIN Parametros..MutuasSalud MS ON e.CodColectivo = MS.Codigo
			LEFT JOIN Parametros..MutuaPrincipal MP ON MS.CodMutua = MP.Codigo							
	where	(e.AsisteCita = 0 and e.NoAsistenciasCita > 0) 
			and e.Estado is null
			and (@spvar_Nombre is null or PacNombre like (rtrim(@spvar_Nombre) + '%') )
			and (@spvar_Apell1 is null or PacApell1 like (rtrim(@spvar_Apell1) + '%') )
			and (@spvar_Apell2 is null or PacApell2 like (rtrim(@spvar_Apell2) + '%') )
			and (@spvar_CodServicio is null or e.CodServicioFinal = @spvar_CodServicio)
			and (@spvar_CodServicioRemite is null or e.CodServicioOrigen = @spvar_CodServicioRemite)
			and (@spvar_FecSolDesde is null or datediff(d, @spvar_FecSolDesde, e.FechaConsulta) >= 0)
			and (@spvar_FecSolHasta is null or datediff(d, @spvar_FecSolHasta, e.FechaConsulta) <= 0)
			and (@spvar_FecCita is null or datediff(d, @spvar_FecCita, e.FechaCPrimera) = 0)
			and (@spvar_FecCitaDesde is null or datediff(d, @spvar_FecCitaDesde, e.FechaCPrimera) >= 0)
			and (@spvar_FecCitaHasta is null or datediff(d, @spvar_FecCitaHasta, e.FechaCPrimera) <= 0)
			and (@spvar_CodCentro is null or e.CodCentroOrigen = @spvar_CodCentro)
			and (@spvar_CodTipoRemision is null or e.TipoRemision = @spvar_CodTipoRemision)
			and (@spvar_Prioridad is null or e.Solicitud = @spvar_Prioridad)
			and (@spvar_DniMedicoDestino is null or e.DniMedDestino = @spvar_DniMedicoDestino)
			and (@spvar_FechaPrevistaDesde is null or e.FechaPrevista >= @spvar_FechaPrevistaDesde)
			and (@spvar_FechaPrevistaHasta is null or e.FechaPrevista <= @spvar_FechaPrevistaHasta)
			and (@spvar_AUGE is null or e.IdGuiaClinica is not null)
			and (@spvar_CodColectivo is null or e.CodColectivo = @spvar_CodColectivo)
			and (@spvar_codCentroDestino is null or e.CodCentroFinal = @spvar_codCentroDestino)
			and (@spvar_idUnidad is null or e.IdUnidad = @spvar_idUnidad)
			and (@spvar_DniMedicoOrigen is null or e.DNIMedEpi = @spvar_DniMedicoOrigen)
			and (
				(@spvar_LibreEleccion is null and (e.LibreEleccion is null or e.LibreEleccion = 0)
				or
				(e.LibreEleccion = 1)))
			and (@spvar_PRAIS is null
				or 
				(@spvar_PRAIS = 1 and 
				EXISTS (select MS.EsPrais from 
				Hclinica..MutuasSaludSecPaciente MSSP 
				INNER JOIN parametros..MutuasSalud MS on MS.Codigo = MSSP.CodColectivo
				where codpaciente = e.CodPaciente and MS.EsPrais = 1))
				or 
				(@spvar_PRAIS = 0 and 
				NOT EXISTS (select MS.EsPrais from 
				Hclinica..MutuasSaludSecPaciente MSSP 
				INNER JOIN parametros..MutuasSalud MS on MS.Codigo = MSSP.CodColectivo
				where codpaciente = e.CodPaciente and MS.EsPrais = 1)))					
END
ELSE
BEGIN
	if @spvar_Eliminadas = 1
	begin
		select	p.CodHistoria,
				p.CodPaciente,
				'PacNombre'= rtrim(p.PacNombre), 
				'PacApell1' = rtrim(p.PacApell1),
				'PacApell2' = rtrim(p.PacApell2),
				e.CodDerivacion as CodEpisodio,				
				e.FechaCPrimera,				
				e.FechaConsulta,				
				e.DictamenClinico as Juicio,
				e.CodCentroFinal,
				S.Codigo, 
				s.DescServicio ServicioDestino,
				s1.DescServicio ServicioRemite,
				null as Pasiva,
				e.Solicitud, 
				e.FechaPrevista,
				
				case
					when 
						isnull(
								e.IdGuiaClinica,
								(
									select MIN (I.CodProblema)
									from 	(
												SELECT 
													  ipd.CodPaciente
													, ipd.CodEpisodio
													, ipd.CodProblema
													, ipd.CodSubProblema
													, ipd.CodDiagnostico
													, ipd.IDInformeIPD					
												FROM HClinica..InformeIPD ipd 
												union
												select 
													  tcGES.CodPaciente
													, tcGES.CodEpisodio
													, ipd.CodProblema
													, ipd.CodSubProblema
													, ipd.CodDiagnostico
													, tcGES.IDInformeIPD	
												FROM Hclinica..TrazabilidadCasoGES tcges 
													inner join hclinica..informeipd ipd on tcges.idinformeipd=ipd.idinformeipd 
											) I 
											inner join Parametros..CIEDiagnostico CIEDiag on I.CodDiagnostico=CIEDiag.CodDiagnostico
									WHERE I.CodPaciente=e.CodPaciente
									  and I.CodEpisodio=e.CodEpisodioOrigen	
								)
							  ) is null then 0
					else 1
				end as TieneGuia,
				
				DescMotivoPasiva as MotivoPasiva,
				e.CodColectivo,
				MP.Entidad + '-' + MS.Entidad as Aseguradora,
				cs.CodCent as HospitalRef,
				cs.NomCentro as DescCentro,
				(case when e.CitaConfirmada = 0 then 1 else 0 end) as NoDerecho,
				null as codConsulta,
				null as fechaCita,
				null as idCita,
				null as CodTipoConsulta,
				null as CodigoServicio,
				null as confirmada,
				null as CodTipoConsulta2,
				p.NumTarjSanitaria,
				e.comunicada,
				e.CodigoRYF,
				e.CodCentroOrigen,
				cs1.DescCentro as DescCentroRef,
				(select top 1 ISNULL(ID_Sidra, '') from Parametros..[MotivosCitas] M where M.Codigo = e.IdMotivo) as IdMotivo,
				p.FecNac,				
				null as CodHistoriaPapel,				
				p.Genero,
				'Sexo' = COD.Descripcion,
				'RUT Profesional' = NULL,
				'Profesional' = NULL,
				'Citador' = NULL,
				'TipoConsulta' = NULL,
				'Prioridad' = COD2.Descripcion	
				,e.Estado 			        
			    ,e.DescUnidadDestino as Unidad 				
				,p.DirTelf				
				,'TiempoEspera' = DATEDIFF(DD, e.FechaConsulta, e.FechaBorrado)
				,COD2.Posicion as OrdenPrioridad 
				,2 as DerivacionSIC
				,e.ConfirmadaDestino
				,isnull(e.DerivacionManual,0) as DerivacionManual
				,e.ComunicadaDestino
				,e.AsisteCita
				,null as ConfAsistencia 
				,null as CitaEspontanea	
				,e.FechaInicial	
				,0 as NoAtendido
				,e.FechaNoAtendida
				,e.NoAsistenciasCita
				, NULL as idOrigenCita 
				, NULL as DescOrigenCitas
				,p.Email
				,p.Direccion 
				,p.DirNum
				 ,p.CodPostal 
				 ,L.NomPoblacion  
				 ,p1.Nombre as Provincia
				,L.NomPoblacion as Localidad
				,p.telf2
				,isNull(p.TarjSanitariaResp,'') as RutTutor
				,IsNull(PMRemite.NomMedico , '') as NombreMedicoRemi
				,IsNull(PMRemite.Apell1 , '') as Apel1MedicoRemi
				,IsNull(PMRemite.Apell2 , '') as Apel2MEdicoRemi
				,IsNull(PMRemite.Nif , '') as RutMedicoRemi
				,I.DescDiagnostico
				,CI.DescDiagnostico as DescDiagnosProvi
				,e.inspecciones 
				,e.IDProblemaSalud
				,gc.DescGuia as descProblema
				,gc1.DescGuia as descSubProblema
				,isnull(PMcita.Nif,isnull(DEcita.Nif,isnull(TD.Nif,Acita.nif))) as Nif
				,e.IdCausaInterconsulta
				,e.DescCausaInterconsulta
				,e.comentarios
				,e.TipoRemision
				,e.motivo
				,p.AtiendeAlNombre as NombreSocial
				,CASE WHEN 
				(
					EXISTS (select * from Hclinica..MutuasSaludSecPaciente MSSP 
					INNER JOIN parametros..MutuasSalud MS on MS.Codigo = MSSP.CodColectivo
					where codpaciente = e.CodPaciente and MS.EsPrais = 1)
				) THEN 1 ELSE 0 END AS EsPRAIS	
				,'' as ProfesionalAtiende
				,p.Telf3
				,p.TelfFijoUFamiliar
				,e.RUNProfEgreso
				,e.NomProfEgreso
				,e.ObservacionEgreso 
				,e.FechaBorrado	as FechaCierre			
		from	Consultas..DerivacionConsultasBorrados e with (nolock)
				inner join Hclinica..Pacientes p with (nolock) on p.CodPaciente = e.CodPaciente
				left join Parametros..ServiciosExternos s with (nolock) on s.Codigo = e.CodServicioFinal
				left join Parametros..Servicios s1 with (nolock) on s1.Codigo = e.CodServicioOrigen
				left join Parametros..DatosOtrosCentros cs with (nolock) on cs.CodCent = e.CodCentroFinal
				left join Parametros..CentrosSalud cs1 with (nolock) on cs1.CodCentro = e.CodCentroOrigen				
				left join Parametros..Codigos COD on COD.Codigo = p.Genero and Tabla = 'EstGenero'				
				left join Parametros..Codigos COD2 on COD2.Codigo = e.Solicitud and COD2.Tabla = 'EstTipoExamen'
				LEFT JOIN parametros..DireccionLocalidad L ON p.DirCodLocalidad = L.CodPoblacion and p.dircodprov = l.codprovincia 		    
				LEFT JOIN parametros..codprovincias p1 on p1.codigo = p.dircodprov
				left join Parametros..ParametrosMedicos PMRemite on PMRemite.DNIMedico = e.DNIMedEpi
				LEFT JOIN Parametros..CIEDiagnostico I on e.CodDiagnosticoProvisional = I.CodDiagnostico
				LEFT JOIN Parametros..CIEDiagnostico CI on e.CodDiagnosticoPrimero = CI.CodDiagnostico
				left join  Parametros..GuiasClinicas gc on  gc.CodGuia = e.IDProblemaSalud 
				left join  Parametros..GuiasClinicas gc1 on  gc1.CodGuia = e.CodSubProblema
				LEFT JOIN Parametros..TecnicosDatos TD on TD.DNITecnico = e.NIF
				left join Parametros..ParametrosMedicos PMcita on PMcita.DNIMedico = e.NIF
				left join Parametros..DatosEnfermeras DEcita on DEcita.DNIEnf = e.NIF
				left join Parametros..Administrativo Acita on Acita.DNIAdminist = e.NIF	
				LEFT JOIN Parametros..MutuasSalud MS ON e.CodColectivo = MS.Codigo
				LEFT JOIN Parametros..MutuaPrincipal MP ON MS.CodMutua = MP.Codigo	
		where	asistido is null
				and (@spvar_Nombre is null or PacNombre like (rtrim(@spvar_Nombre) + '%') )
				and (@spvar_Apell1 is null or PacApell1 like (rtrim(@spvar_Apell1) + '%') )
				and (@spvar_Apell2 is null or PacApell2 like (rtrim(@spvar_Apell2) + '%') )
				and (@spvar_CodServicio is null or e.CodServicioFinal = @spvar_CodServicio)
				and (@spvar_CodServicioRemite is null or e.CodServicioOrigen = @spvar_CodServicioRemite)
				and (@spvar_FecSolDesde is null or datediff(d, @spvar_FecSolDesde, e.FechaConsulta) >= 0)
				and (@spvar_FecSolHasta is null or datediff(d, @spvar_FecSolHasta, e.FechaConsulta) <= 0)
				and (@spvar_FecCita is null or datediff(d, @spvar_FecCita, e.FechaCPrimera) = 0)
				and (@spvar_FecCitaDesde is null or datediff(d, @spvar_FecCitaDesde, e.FechaCPrimera) >= 0)
				and (@spvar_FecCitaHasta is null or datediff(d, @spvar_FecCitaHasta, e.FechaCPrimera) <= 0)
				and (@spvar_CodCentro is null or e.CodCentroOrigen = @spvar_CodCentro)
				and (@spvar_CodTipoRemision is null or e.TipoRemision = @spvar_CodTipoRemision)
				and (@spvar_Prioridad is null or e.Solicitud = @spvar_Prioridad)
				and (@spvar_DniMedicoDestino is null or e.DniMedDestino = @spvar_DniMedicoDestino)
				and (@spvar_FechaPrevistaDesde is null or e.FechaPrevista >= @spvar_FechaPrevistaDesde)
				and (@spvar_FechaPrevistaHasta is null or e.FechaPrevista <= @spvar_FechaPrevistaHasta)
				and (@spvar_AUGE is null or e.IdGuiaClinica is not null)
				and (@spvar_CodColectivo is null or e.CodColectivo = @spvar_CodColectivo)
				and (@spvar_codCentroDestino is null or e.CodCentroFinal = @spvar_codCentroDestino)
				and (@spvar_idUnidad is null or e.IdUnidad = @spvar_idUnidad)
				and (@spvar_DniMedicoOrigen is null or e.DNIMedEpi = @spvar_DniMedicoOrigen)
				and (
					(@spvar_LibreEleccion is null and (e.LibreEleccion is null or e.LibreEleccion = 0)
					or
					(e.LibreEleccion = 1)))
				and (@spvar_PRAIS is null
					or 
					(@spvar_PRAIS = 1 and 
					EXISTS (select MS.EsPrais from 
					Hclinica..MutuasSaludSecPaciente MSSP 
					INNER JOIN parametros..MutuasSalud MS on MS.Codigo = MSSP.CodColectivo
					where codpaciente = e.CodPaciente and MS.EsPrais = 1))
					or 
					(@spvar_PRAIS = 0 and 
					NOT EXISTS (select MS.EsPrais from 
					Hclinica..MutuasSaludSecPaciente MSSP 
					INNER JOIN parametros..MutuasSalud MS on MS.Codigo = MSSP.CodColectivo
					where codpaciente = e.CodPaciente and MS.EsPrais = 1)))
		union
		
		select	p.CodHistoria,
				p.CodPaciente,				
				'PacNombre'= rtrim(p.PacNombre), 
				'PacApell1' = rtrim(p.PacApell1),
				'PacApell2' = rtrim(p.PacApell2),				
				e.CodDerivacion as CodEpisodio,				
				e.FechaCPrimera,			
				e.FechaConsulta,				
				e.DictamenClinico as Juicio,
				e.CodCentroFinal,
				S.Codigo, 
				s.DescServicio ServicioDestino,
				s1.DescServicio ServicioRemite,
				null as Pasiva,
				e.Solicitud, 
				e.FechaPrevista,				
				case
					when 
						isnull(
								e.IdGuiaClinica,
								(
									select MIN (I.CodProblema)
									from 	(
												SELECT 
													  ipd.CodPaciente
													, ipd.CodEpisodio
													, ipd.CodProblema
													, ipd.CodSubProblema
													, ipd.CodDiagnostico
													, ipd.IDInformeIPD					
												FROM HClinica..InformeIPD ipd 
												union
												select 
													  tcGES.CodPaciente
													, tcGES.CodEpisodio
													, ipd.CodProblema
													, ipd.CodSubProblema
													, ipd.CodDiagnostico
													, tcGES.IDInformeIPD	
												FROM Hclinica..TrazabilidadCasoGES tcges 
													inner join hclinica..informeipd ipd on tcges.idinformeipd=ipd.idinformeipd 
											) I 
											inner join Parametros..CIEDiagnostico CIEDiag on I.CodDiagnostico=CIEDiag.CodDiagnostico
									WHERE I.CodPaciente=e.CodPaciente
									  and I.CodEpisodio=e.CodEpisodioOrigen	
								)
							  ) is null then 0
					else 1
				end as TieneGuia,
				(select top 1 M.Descripcion from Parametros..[MotivosCitas] M where M.Codigo = e.IdMotivo) as MotivoPasiva,
				e.CodColectivo,
				MP.Entidad + '-' + MS.Entidad as Aseguradora,
				cs.CodCent as HospitalRef,
				cs.NomCentro as DescCentro,
				(case when e.CitaConfirmada = 0 then 1 else 0 end) as NoDerecho,
				null as codConsulta,
				null as fechaCita,
				null as idCita,
				null as CodTipoConsulta,
				null as CodigoServicio,
				null as confirmada,
				null as CodTipoConsulta,
				p.NumTarjSanitaria,
				e.comunicada,
				e.CodigoRYF,
				e.CodCentroOrigen,
				cs1.DescCentro as DescCentroRef,
				e.IdMotivo as IdMotivo,
				p.FecNac,
				null as CodHistoriaPapel,			
				p.Genero,
				'Sexo' = COD.Descripcion,
				'RUT Profesional' = NULL,
				'Profesional' = NULL,
				'Citador' = NULL,
				'TipoConsulta' = NULL,
				'Prioridad' = COD2.Descripcion	
				,e.Estado 
			    ,e.DescUnidadDestino as Unidad				
				,p.DirTelf				
				,'TiempoEspera' = DATEDIFF(DD, e.FechaConsulta, ISNULL(e.FechaInicial, GETDATE())) 
				,COD2.Posicion as OrdenPrioridad 
				,2 as DerivacionSIC
				,e.ConfirmadaDestino
				,isnull(e.DerivacionManual,0) as DerivacionManual
				,e.ComunicadaDestino
				,e.AsisteCita
				,null as ConfAsistencia 
				,null as CitaEspontanea	
				,e.FechaInicial	
				,0 as NoAtendido
				,e.FechaNoAtendida
				,e.NoAsistenciasCita
				, NULL as idOrigenCita 
				, NULL as DescOrigenCitas
				,p.Email
				,p.Direccion 
				,p.DirNum
				 ,p.CodPostal 
				 ,L.NomPoblacion  
				 ,p1.Nombre as Provincia
				,L.NomPoblacion as Localidad
				,p.telf2
				,isNull(p.TarjSanitariaResp,'') as RutTutor
				,IsNull(PMRemite.NomMedico , '') as NombreMedicoRemi
				,IsNull(PMRemite.Apell1 , '') as Apel1MedicoRemi
				,IsNull(PMRemite.Apell2 , '') as Apel2MEdicoRemi
				,IsNull(PMRemite.Nif , '') as RutMedicoRemi
				,I.DescDiagnostico
				,CI.DescDiagnostico as DescDiagnosProvi
				,e.inspecciones 
				,e.IDProblemaSalud
				,gc.DescGuia as descProblema
				,gc1.DescGuia as descSubProblema
				,isnull(PMcita.Nif,isnull(DEcita.Nif,isnull(TD.Nif,Acita.nif))) as Nif
				,e.IdCausaInterconsulta
				,e.DescCausaInterconsulta
				,e.comentarios
				,e.TipoRemision
				,e.motivo
				,p.AtiendeAlNombre as NombreSocial
				,CASE WHEN 
				(
					EXISTS (select * from Hclinica..MutuasSaludSecPaciente MSSP 
					INNER JOIN parametros..MutuasSalud MS on MS.Codigo = MSSP.CodColectivo
					where codpaciente = e.CodPaciente and MS.EsPrais = 1)
				) THEN 1 ELSE 0 END AS EsPRAIS
				,'' as ProfesionalAtiende
				,p.Telf3
				,p.TelfFijoUFamiliar
				,e.RUNProfEgreso
				,e.NomProfEgreso
				,e.ObservacionEgreso 	
				,e.FechaCierre			
		from	Consultas..DerivacionConsultas e with (nolock)	
				inner join Hclinica..Pacientes p with (nolock) on p.CodPaciente = e.CodPaciente
				left join Parametros..ServiciosExternos s with (nolock) on s.Codigo = e.CodServicioFinal
				left join Parametros..Servicios s1 with (nolock) on s1.Codigo = e.CodServicioOrigen
				left join Parametros..DatosOtrosCentros cs with (nolock) on cs.CodCent = e.CodCentroFinal
				left join Parametros..CentrosSalud cs1 with (nolock) on cs1.CodCentro = e.CodCentroOrigen				
				left join Parametros..Codigos COD on COD.Codigo = p.Genero and Tabla = 'EstGenero'				
				left join Parametros..Codigos COD2 on COD2.Codigo = e.Solicitud and COD2.Tabla = 'EstTipoExamen'	
				LEFT JOIN parametros..DireccionLocalidad L ON p.DirCodLocalidad = L.CodPoblacion and p.dircodprov = l.codprovincia 		    
				LEFT JOIN parametros..codprovincias p1 on p1.codigo = p.dircodprov
				left join Parametros..ParametrosMedicos PMRemite on PMRemite.DNIMedico = e.DNIMedEpi
				LEFT JOIN Parametros..CIEDiagnostico I on e.CodDiagnosticoProvisional = I.CodDiagnostico
				LEFT JOIN Parametros..CIEDiagnostico CI on e.CodDiagnosticoPrimero = CI.CodDiagnostico
				left join  Parametros..GuiasClinicas gc on  gc.CodGuia = e.IDProblemaSalud 
				left join  Parametros..GuiasClinicas gc1 on  gc1.CodGuia = e.CodSubProblema	
				LEFT JOIN Parametros..TecnicosDatos TD on TD.DNITecnico = e.NIF	
				left join Parametros..ParametrosMedicos PMcita on PMcita.DNIMedico = e.NIF
				left join Parametros..DatosEnfermeras DEcita on DEcita.DNIEnf = e.NIF
				left join Parametros..Administrativo Acita on Acita.DNIAdminist = e.NIF	
				LEFT JOIN Parametros..MutuasSalud MS ON e.CodColectivo = MS.Codigo
				LEFT JOIN Parametros..MutuaPrincipal MP ON MS.CodMutua = MP.Codigo	
		where	e.Estado = 'E' 
				and (@spvar_Nombre is null or PacNombre like (rtrim(@spvar_Nombre) + '%') )
				and (@spvar_Apell1 is null or PacApell1 like (rtrim(@spvar_Apell1) + '%') )
				and (@spvar_Apell2 is null or PacApell2 like (rtrim(@spvar_Apell2) + '%') )
				and (@spvar_CodServicio is null or e.CodServicioFinal = @spvar_CodServicio)
				and (@spvar_CodServicioRemite is null or e.CodServicioOrigen = @spvar_CodServicioRemite)
				and (@spvar_FecSolDesde is null or datediff(d, @spvar_FecSolDesde, e.FechaConsulta) >= 0)
				and (@spvar_FecSolHasta is null or datediff(d, @spvar_FecSolHasta, e.FechaConsulta) <= 0)
				and (@spvar_FecCita is null or datediff(d, @spvar_FecCita, e.FechaCPrimera) = 0)
				and (@spvar_FecCitaDesde is null or datediff(d, @spvar_FecCitaDesde, e.FechaCPrimera) >= 0)
				and (@spvar_FecCitaHasta is null or datediff(d, @spvar_FecCitaHasta, e.FechaCPrimera) <= 0)
				and (@spvar_CodCentro is null or e.CodCentroOrigen = @spvar_CodCentro)
				and (@spvar_CodTipoRemision is null or e.TipoRemision = @spvar_CodTipoRemision)
				and (@spvar_Prioridad is null or e.Solicitud = @spvar_Prioridad)
				and (@spvar_DniMedicoDestino is null or e.DniMedDestino = @spvar_DniMedicoDestino)
				and (@spvar_FechaPrevistaDesde is null or e.FechaPrevista >= @spvar_FechaPrevistaDesde)
				and (@spvar_FechaPrevistaHasta is null or e.FechaPrevista <= @spvar_FechaPrevistaHasta)
				and (@spvar_AUGE is null or e.IdGuiaClinica is not null)
				and (@spvar_CodColectivo is null or e.CodColectivo = @spvar_CodColectivo)
				and (@spvar_codCentroDestino is null or e.CodCentroFinal = @spvar_codCentroDestino)
				and (@spvar_idUnidad is null or e.IdUnidad = @spvar_idUnidad)
				and (@spvar_DniMedicoOrigen is null or e.DNIMedEpi = @spvar_DniMedicoOrigen)
				and (
					(@spvar_LibreEleccion is null and (e.LibreEleccion is null or e.LibreEleccion = 0)
					or
					(e.LibreEleccion = 1)))	
				and (@spvar_PRAIS is null
					or 
					(@spvar_PRAIS = 1 and 
					EXISTS (select MS.EsPrais from 
					Hclinica..MutuasSaludSecPaciente MSSP 
					INNER JOIN parametros..MutuasSalud MS on MS.Codigo = MSSP.CodColectivo
					where codpaciente = e.CodPaciente and MS.EsPrais = 1))
					or 
					(@spvar_PRAIS = 0 and 
					NOT EXISTS (select MS.EsPrais from 
					Hclinica..MutuasSaludSecPaciente MSSP 
					INNER JOIN parametros..MutuasSalud MS on MS.Codigo = MSSP.CodColectivo
					where codpaciente = e.CodPaciente and MS.EsPrais = 1)))
								
	end
else
	begin
		if @spvar_Rechazadas = 1
		begin
			select	p.CodHistoria,
					p.CodPaciente,
					'PacNombre'= rtrim(p.PacNombre), 
					'PacApell1' = rtrim(p.PacApell1),
					'PacApell2' = rtrim(p.PacApell2),
					e.CodDerivacion as CodEpisodio,					
					e.FechaCPrimera,				
					e.FechaConsulta,				
					e.DictamenClinico as Juicio,
					e.CodCentroFinal,
					S.Codigo, 
					s.DescServicio ServicioDestino,
					s1.DescServicio ServicioRemite,
					'2' as Pasiva,
					e.Solicitud, 
					e.FechaPrevista,					
					case
						when 
							isnull(
									e.IdGuiaClinica,
									(
										select MIN (I.CodProblema)
										from 	(
													SELECT 
														  ipd.CodPaciente
														, ipd.CodEpisodio
														, ipd.CodProblema
														, ipd.CodSubProblema
														, ipd.CodDiagnostico
														, ipd.IDInformeIPD					
													FROM HClinica..InformeIPD ipd 
													union
													select 
														  tcGES.CodPaciente
														, tcGES.CodEpisodio
														, ipd.CodProblema
														, ipd.CodSubProblema
														, ipd.CodDiagnostico
														, tcGES.IDInformeIPD	
													FROM Hclinica..TrazabilidadCasoGES tcges 
														inner join hclinica..informeipd ipd on tcges.idinformeipd=ipd.idinformeipd 
												) I 
												inner join Parametros..CIEDiagnostico CIEDiag on I.CodDiagnostico=CIEDiag.CodDiagnostico
										WHERE I.CodPaciente=e.CodPaciente
										  and I.CodEpisodio=e.CodEpisodioOrigen	
									)
								  ) is null then 0
						else 1
					end as TieneGuia,			
					DescMotivoPasiva as MotivoPasiva,
					e.CodColectivo,
					MP.Entidad + '-' + MS.Entidad as Aseguradora,
					cs.CodCent as HospitalRef,
					cs.NomCentro as DescCentro,
					(case when e.CitaConfirmada = 0 then 1 else 0 end) as NoDerecho,
					null as codConsulta,
					null as fechaCita,
					null as idCita,
					null as CodTipoConsulta,
					null as CodigoServicio,
					null as confirmada,
					null as CodTipoConsulta2,
				    p.NumTarjSanitaria,
				    e.comunicada,
				    e.CodigoRYF,
					e.CodCentroOrigen,
					cs1.DescCentro as DescCentroRef,
					(select top 1 ISNULL(ID_Sidra, '') from Parametros..[MotivosCitas] M where M.Codigo = e.IdMotivo) as IdMotivo,
					p.FecNac,
					null as CodHistoriaPapel,					
					p.Genero,
					'Sexo' = COD.Descripcion,
					'RUT Profesional' = NULL,
					'Profesional' = NULL,
					'Citador' = NULL,
					'TipoConsulta' = NULL,
					'Prioridad' = COD2.Descripcion	
					,e.Estado 
		            ,e.DescUnidadDestino as Unidad 					
					,p.DirTelf					
					,'TiempoEspera' = DATEDIFF(DD, e.FechaConsulta, e.FechaBorrado)
					,COD2.Posicion as OrdenPrioridad 
					,2 as DerivacionSIC
					,e.ConfirmadaDestino
					,isnull(e.DerivacionManual,0) as DerivacionManual
					,e.ComunicadaDestino
					,e.AsisteCita
					,null as ConfAsistencia 
					,null as CitaEspontanea	
					,e.FechaInicial	
					,0 as NoAtendido
					,e.FechaNoAtendida
					,e.NoAsistenciasCita
					, NULL as idOrigenCita 
					, NULL as DescOrigenCitas
					,p.Email
					,p.Direccion 
					,p.DirNum
					 ,p.CodPostal 
					 ,L.NomPoblacion  
					 ,p1.Nombre as Provincia
					,L.NomPoblacion as Localidad
					,p.telf2
					,isNull(p.TarjSanitariaResp,'') as RutTutor
					,IsNull(PMRemite.NomMedico , '') as NombreMedicoRemi
					,IsNull(PMRemite.Apell1 , '') as Apel1MedicoRemi
					,IsNull(PMRemite.Apell2 , '') as Apel2MEdicoRemi
					,IsNull(PMRemite.Nif , '') as RutMedicoRemi
					,I.DescDiagnostico
					,CI.DescDiagnostico as DescDiagnosProvi
					,e.inspecciones 
					,e.IDProblemaSalud
					,gc.DescGuia as descProblema
					,gc1.DescGuia as descSubProblema
					,isnull(PMcita.Nif,isnull(DEcita.Nif,isnull(TD.Nif,Acita.nif))) as Nif
					,e.IdCausaInterconsulta
					,e.DescCausaInterconsulta
					,e.comentarios
					,e.TipoRemision
					,e.motivo
					,p.AtiendeAlNombre as NombreSocial
					,CASE WHEN 
					(
						EXISTS (select * from Hclinica..MutuasSaludSecPaciente MSSP 
						INNER JOIN parametros..MutuasSalud MS on MS.Codigo = MSSP.CodColectivo
						where codpaciente = e.CodPaciente and MS.EsPrais = 1)
					) THEN 1 ELSE 0 END AS EsPRAIS
					,'' as ProfesionalAtiende
					,p.Telf3
					,p.TelfFijoUFamiliar
					,e.RUNProfEgreso
					,e.NomProfEgreso
					,e.ObservacionEgreso 	
					,e.FechaBorrado	as FechaCierre								
			from	Consultas..DerivacionConsultasBorrados e with (nolock)
					inner join Hclinica..Pacientes p with (nolock) on p.CodPaciente = e.CodPaciente
					left join Parametros..ServiciosExternos s with (nolock) on s.Codigo = e.CodServicioFinal
					left join Parametros..Servicios s1 with (nolock) on s1.Codigo = e.CodServicioOrigen
					left join Parametros..DatosOtrosCentros cs with (nolock) on cs.CodCent = e.CodCentroFinal
					left join Parametros..CentrosSalud cs1 with (nolock) on cs1.CodCentro = e.CodCentroOrigen
					left join Parametros..DatosOtrosCentros do with (nolock) on do.CodCent = e.CodCentroFinal
					left join Parametros..Codigos COD on COD.Codigo = p.Genero and Tabla = 'EstGenero'					
					left join Parametros..Codigos COD2 on COD2.Codigo = e.Solicitud and COD2.Tabla = 'EstTipoExamen'					
					LEFT JOIN parametros..DireccionLocalidad L ON p.DirCodLocalidad = L.CodPoblacion and p.dircodprov = l.codprovincia 		    
					LEFT JOIN parametros..codprovincias p1 on p1.codigo = p.dircodprov
					left join Parametros..ParametrosMedicos PMRemite on PMRemite.DNIMedico = e.DNIMedEpi
					LEFT JOIN Parametros..CIEDiagnostico I on e.CodDiagnosticoProvisional = I.CodDiagnostico
					LEFT JOIN Parametros..CIEDiagnostico CI on e.CodDiagnosticoPrimero = CI.CodDiagnostico
					left join  Parametros..GuiasClinicas gc on  gc.CodGuia = e.IDProblemaSalud 
					left join  Parametros..GuiasClinicas gc1 on  gc1.CodGuia = e.CodSubProblema
					LEFT JOIN Parametros..TecnicosDatos TD on TD.DNITecnico = e.NIF
					left join Parametros..ParametrosMedicos PMcita on PMcita.DNIMedico = e.NIF
					left join Parametros..DatosEnfermeras DEcita on DEcita.DNIEnf = e.NIF
					left join Parametros..Administrativo Acita on Acita.DNIAdminist = e.NIF	
					LEFT JOIN Parametros..MutuasSalud MS ON e.CodColectivo = MS.Codigo
					LEFT JOIN Parametros..MutuaPrincipal MP ON MS.CodMutua = MP.Codigo	

			where	asistido = 'R'
					and (@spvar_Nombre is null or PacNombre like (rtrim(@spvar_Nombre) + '%') )
					and (@spvar_Apell1 is null or PacApell1 like (rtrim(@spvar_Apell1) + '%') )
					and (@spvar_Apell2 is null or PacApell2 like (rtrim(@spvar_Apell2) + '%') )
					and (@spvar_CodServicio is null or e.CodServicioFinal = @spvar_CodServicio)
					and (@spvar_CodServicioRemite is null or e.CodServicioOrigen = @spvar_CodServicioRemite)
					and (@spvar_FecSolDesde is null or datediff(d, @spvar_FecSolDesde, e.FechaConsulta) >= 0)
					and (@spvar_FecSolHasta is null or datediff(d, @spvar_FecSolHasta, e.FechaConsulta) <= 0)
					and (@spvar_FecCita is null or datediff(d, @spvar_FecCita, e.FechaCPrimera) = 0)
					and (@spvar_FecCitaDesde is null or datediff(d, @spvar_FecCitaDesde, e.FechaCPrimera) >= 0)
					and (@spvar_FecCitaHasta is null or datediff(d, @spvar_FecCitaHasta, e.FechaCPrimera) <= 0)
					and (@spvar_CodCentro is null or e.CodCentroOrigen = @spvar_CodCentro)
					and (@spvar_CodTipoRemision is null or e.TipoRemision = @spvar_CodTipoRemision)
					and (@spvar_Prioridad is null or e.Solicitud = @spvar_Prioridad)
					and (@spvar_DniMedicoDestino is null or e.DniMedDestino = @spvar_DniMedicoDestino)
					and (@spvar_FechaPrevistaDesde is null or e.FechaPrevista >= @spvar_FechaPrevistaDesde)
					and (@spvar_FechaPrevistaHasta is null or e.FechaPrevista <= @spvar_FechaPrevistaHasta)
					and (@spvar_AUGE is null or e.IdGuiaClinica is not null)
					and (@spvar_CodColectivo is null or e.CodColectivo = @spvar_CodColectivo)
					and (@spvar_codCentroDestino is null or e.CodCentroFinal = @spvar_codCentroDestino)
					and (@spvar_FecRecDesde is null or datediff(d, @spvar_FecRecDesde, e.FechaBorrado) >= 0)
					and (@spvar_FecRecHasta is null or datediff(d, @spvar_FecRecHasta, e.FechaBorrado) <= 0)
					and (@spvar_idUnidad is null or e.IdUnidad = @spvar_idUnidad)
					and (@spvar_DniMedicoOrigen is null or e.DNIMedEpi = @spvar_DniMedicoOrigen)
					and (
						(@spvar_LibreEleccion is null and (e.LibreEleccion is null or e.LibreEleccion = 0)
						or
						(e.LibreEleccion = 1)))
					and (@spvar_PRAIS is null
						or 
						(@spvar_PRAIS = 1 and 
						EXISTS (select MS.EsPrais from 
						Hclinica..MutuasSaludSecPaciente MSSP 
						INNER JOIN parametros..MutuasSalud MS on MS.Codigo = MSSP.CodColectivo
						where codpaciente = e.CodPaciente and MS.EsPrais = 1))
						or 
						(@spvar_PRAIS = 0 and 
						NOT EXISTS (select MS.EsPrais from 
						Hclinica..MutuasSaludSecPaciente MSSP 
						INNER JOIN parametros..MutuasSalud MS on MS.Codigo = MSSP.CodColectivo
						where codpaciente = e.CodPaciente and MS.EsPrais = 1)))

		end
	else
		begin
			if @spvar_Reservadas = 1 or @spvar_Confirmadas = 1
			begin
			--Busca las propuestas normales
			select	p.CodHistoria,
					p.CodPaciente,
					'PacNombre'= rtrim(p.PacNombre), 
					'PacApell1' = rtrim(p.PacApell1),
					'PacApell2' = rtrim(p.PacApell2),
					e.CodDerivacion as CodEpisodio,					
					e.FechaCPrimera,				
					e.FechaConsulta,					
					e.DictamenClinico as Juicio,
					e.CodCentroFinal,
					S.Codigo, 
					s.DescServicio ServicioDestino,
					s1.DescServicio ServicioRemite,
					'0' as Pasiva,
					e.Solicitud,
					e.FechaPrevista,					
					case
						when 
							isnull(
									e.IdGuiaClinica,
									(
										select MIN (I.CodProblema)
										from 	(
													SELECT 
														  ipd.CodPaciente
														, ipd.CodEpisodio
														, ipd.CodProblema
														, ipd.CodSubProblema
														, ipd.CodDiagnostico
														, ipd.IDInformeIPD					
													FROM HClinica..InformeIPD ipd 
													union
													select 
														  tcGES.CodPaciente
														, tcGES.CodEpisodio
														, ipd.CodProblema
														, ipd.CodSubProblema
														, ipd.CodDiagnostico
														, tcGES.IDInformeIPD	
													FROM Hclinica..TrazabilidadCasoGES tcges 
														inner join hclinica..informeipd ipd on tcges.idinformeipd=ipd.idinformeipd 
												) I 
												inner join Parametros..CIEDiagnostico CIEDiag on I.CodDiagnostico=CIEDiag.CodDiagnostico
										WHERE I.CodPaciente=e.CodPaciente
										  and I.CodEpisodio=e.CodEpisodioOrigen	
									)
								  ) is null then 0
						else 1
					end as TieneGuia,					
					'' as MotivoPasiva,
					e.CodColectivo,
					MP.Entidad + '-' + MS.Entidad as Aseguradora,
					cs.CodCent as HospitalRef,
					cs.NomCentro as DescCentro,
					(case when e.CitaConfirmada = 0 then 1 else 0 end) as NoDerecho,
					null as CodConsulta,					
					null as FechaCita,					
					null as IdCita,
					null as CodTipoConsulta,
					null as CodigoServicio,
					null as CodTipoConsulta2,	
					e.confirmada,					
					p.NumTarjSanitaria,
					e.comunicada,
					e.CodigoRYF,
					e.CodCentroOrigen,
					cs1.DescCentro as DescCentroRef
					,'' as IdMotivo,
					p.FecNac,					
					null as CodHistoriaPapel,					
					p.Genero,
					'Sexo' = COD.Descripcion,
					'RUT Profesional' = NULL,
					'Profesional' = NULL,
					'Citador' = NULL,
					'TipoConsulta' = NULL,
					'Prioridad' = COD2.Descripcion	
					,e.Estado 
		            ,e.DescUnidadDestino as Unidad 					
					,p.DirTelf
					,'TiempoEspera' = DATEDIFF(DD, e.FechaConsulta, ISNULL(e.FechaInicial, GETDATE())) 
					,COD2.Posicion as OrdenPrioridad 
					,2 as DerivacionSIC
					,e.ConfirmadaDestino
					,isnull(e.DerivacionManual,0) as DerivacionManual
					,e.ComunicadaDestino
					,e.AsisteCita
					,null as ConfAsistencia 
					,null as CitaEspontanea	
					,e.FechaInicial	
					,0 as NoAtendido
					,e.FechaNoAtendida
					,e.NoAsistenciasCita
					, NULL as idOrigenCita 
					, NULL as DescOrigenCitas
					,p.Email
					,p.Direccion 
					,p.DirNum
					 ,p.CodPostal 
					 ,L.NomPoblacion  
					 ,p1.Nombre as Provincia
					,L.NomPoblacion as Localidad
					,p.telf2
					,isNull(p.TarjSanitariaResp,'') as RutTutor
					,IsNull(PMRemite.NomMedico , '') as NombreMedicoRemi
					,IsNull(PMRemite.Apell1 , '') as Apel1MedicoRemi
					,IsNull(PMRemite.Apell2 , '') as Apel2MEdicoRemi
					,IsNull(PMRemite.Nif , '') as RutMedicoRemi
					,I.DescDiagnostico
					,CI.DescDiagnostico as DescDiagnosProvi
					,e.inspecciones 
					,e.IDProblemaSalud
					,gc.DescGuia as descProblema
					,gc1.DescGuia as descSubProblema
					,isnull(PMcita.Nif,isnull(DEcita.Nif,isnull(TD.Nif,Acita.nif))) as Nif
					,e.IdCausaInterconsulta
					,e.DescCausaInterconsulta
					,e.comentarios
					,e.TipoRemision
					,e.motivo
					,p.AtiendeAlNombre as NombreSocial
					,CASE WHEN 
					(
						EXISTS (select * from Hclinica..MutuasSaludSecPaciente MSSP 
						INNER JOIN parametros..MutuasSalud MS on MS.Codigo = MSSP.CodColectivo
						where codpaciente = e.CodPaciente and MS.EsPrais = 1)
					) THEN 1 ELSE 0 END AS EsPRAIS
					,'' as ProfesionalAtiende
					,p.Telf3
					,p.TelfFijoUFamiliar
					,e.RUNProfEgreso
					,e.NomProfEgreso
					,e.ObservacionEgreso 	
					,e.FechaCierre			
			from	Consultas..DerivacionConsultas e with (nolock)
					inner join Hclinica..Pacientes p with (nolock) on p.CodPaciente = e.CodPaciente
					left join Parametros..ServiciosExternos s with (nolock) on s.Codigo = e.CodServicioFinal
					left join Parametros..Servicios s1 with (nolock) on s1.Codigo = e.CodServicioOrigen
					left join Parametros..DatosOtrosCentros cs with (nolock) on cs.CodCent = e.CodCentroFinal
					left join Parametros..CentrosSalud cs1 with (nolock) on cs1.CodCentro = e.CodCentroOrigen						
					left join Parametros..Codigos COD on COD.Codigo = p.Genero and Tabla = 'EstGenero'					
					left join Parametros..Codigos COD2 on COD2.Codigo = e.Solicitud and COD2.Tabla = 'EstTipoExamen'
					LEFT JOIN parametros..DireccionLocalidad L ON p.DirCodLocalidad = L.CodPoblacion and p.dircodprov = l.codprovincia 		    
					LEFT JOIN parametros..codprovincias p1 on p1.codigo = p.dircodprov
					left join Parametros..ParametrosMedicos PMRemite on PMRemite.DNIMedico = e.DNIMedEpi
					LEFT JOIN Parametros..CIEDiagnostico I on e.CodDiagnosticoProvisional = I.CodDiagnostico
					LEFT JOIN Parametros..CIEDiagnostico CI on e.CodDiagnosticoPrimero = CI.CodDiagnostico
					left join  Parametros..GuiasClinicas gc on  gc.CodGuia = e.IDProblemaSalud 
					left join  Parametros..GuiasClinicas gc1 on  gc1.CodGuia = e.CodSubProblema
					LEFT JOIN Parametros..TecnicosDatos TD on TD.DNITecnico = e.NIF
					left join Parametros..ParametrosMedicos PMcita on PMcita.DNIMedico = e.NIF
					left join Parametros..DatosEnfermeras DEcita on DEcita.DNIEnf = e.NIF
					left join Parametros..Administrativo Acita on Acita.DNIAdminist = e.NIF	
					LEFT JOIN Parametros..MutuasSalud MS ON e.CodColectivo = MS.Codigo
					LEFT JOIN Parametros..MutuaPrincipal MP ON MS.CodMutua = MP.Codigo	
			where	e.Estado is null
					and (@spvar_Nombre is null or PacNombre like (rtrim(@spvar_Nombre) + '%') )
					and (@spvar_Apell1 is null or PacApell1 like (rtrim(@spvar_Apell1) + '%') )
					and (@spvar_Apell2 is null or PacApell2 like (rtrim(@spvar_Apell2) + '%') )
					and (@spvar_CodServicio is null or e.CodServicioFinal = @spvar_CodServicio)
					and (@spvar_CodServicioRemite is null or e.CodServicioOrigen = @spvar_CodServicioRemite)
					and (@spvar_FecSolDesde is null or datediff(d, @spvar_FecSolDesde, e.FechaConsulta) >= 0)
					and (@spvar_FecSolHasta is null or datediff(d, @spvar_FecSolHasta, e.FechaConsulta) <= 0)
					and (@spvar_FecCita is null or datediff(d, @spvar_FecCita, e.FechaCPrimera) = 0)
					and (@spvar_FecCitaDesde is null or datediff(d, @spvar_FecCitaDesde, e.FechaCPrimera) >= 0)
					and (@spvar_FecCitaHasta is null or datediff(d, @spvar_FecCitaHasta, e.FechaCPrimera) <= 0)
					and (@spvar_CodCentro is null or e.CodCentroOrigen = @spvar_CodCentro)
					and (@spvar_CodTipoRemision is null or e.TipoRemision = @spvar_CodTipoRemision)
					and (@spvar_Prioridad is null or e.Solicitud = @spvar_Prioridad)
					and (@spvar_DniMedicoDestino is null or e.DniMedDestino = @spvar_DniMedicoDestino)
					and (@spvar_Citados = '0' or (@spvar_Citados = '1' and e.FechaCPrimera is not null))
                    and (@spvar_NoCitados = '0' or (@spvar_NoCitados = '1' and e.FechaCPrimera is null and e.confirmada = '1' and e.ConfirmadaDestino = '1'))
					and (@spvar_FechaPrevistaDesde is null or e.FechaPrevista >= @spvar_FechaPrevistaDesde)
					and (@spvar_FechaPrevistaHasta is null or e.FechaPrevista <= @spvar_FechaPrevistaHasta)
					and (@spvar_AUGE is null or e.IdGuiaClinica is not null)
					and (@spvar_CodColectivo is null or e.CodColectivo = @spvar_CodColectivo)
					and (@spvar_codCentroDestino is null or e.CodCentroFinal = @spvar_codCentroDestino)
					and (@spvar_Reservadas = '0' or (@spvar_Reservadas = '1' and e.FechaCPrimera is not null and (e.CitaConfirmada = 0 or e.CitaConfirmada is null)))
					and (@spvar_Confirmadas = '0' or (@spvar_Confirmadas = '1' and e.FechaCPrimera is not null and e.CitaConfirmada = 1))
					and (@spvar_idUnidad is null or e.IdUnidad = @spvar_idUnidad)
					and (@spvar_DniMedicoOrigen is null or e.DNIMedEpi = @spvar_DniMedicoOrigen)
					and (
						(@spvar_LibreEleccion is null and (e.LibreEleccion is null or e.LibreEleccion = 0)
						or
						(e.LibreEleccion = 1)))
					and (@spvar_PRAIS is null
						or 
						(@spvar_PRAIS = 1 and 
						EXISTS (select MS.EsPrais from 
						Hclinica..MutuasSaludSecPaciente MSSP 
						INNER JOIN parametros..MutuasSalud MS on MS.Codigo = MSSP.CodColectivo
						where codpaciente = e.CodPaciente and MS.EsPrais = 1))
						or 
						(@spvar_PRAIS = 0 and 
						NOT EXISTS (select MS.EsPrais from 
						Hclinica..MutuasSaludSecPaciente MSSP 
						INNER JOIN parametros..MutuasSalud MS on MS.Codigo = MSSP.CodColectivo
						where codpaciente = e.CodPaciente and MS.EsPrais = 1)))
			end
		else
			begin
				if @spvar_Atendidas = 1
				begin
					select	p.CodHistoria,
					p.CodPaciente,
					'PacNombre'= rtrim(p.PacNombre), 
					'PacApell1' = rtrim(p.PacApell1),
					'PacApell2' = rtrim(p.PacApell2),
					e.CodDerivacion as CodEpisodio,				
					e.FechaCPrimera,					
					e.FechaConsulta,					
					e.DictamenClinico as Juicio,
					e.CodCentroFinal,
					S.Codigo, 
					s.DescServicio ServicioDestino,
					s1.DescServicio ServicioRemite,
					'0' as Pasiva,
					e.Solicitud, 
					e.FechaPrevista,					
					case
						when 
							isnull(
									e.IdGuiaClinica,
									(
										select MIN (I.CodProblema)
										from 	(
													SELECT 
														  ipd.CodPaciente
														, ipd.CodEpisodio
														, ipd.CodProblema
														, ipd.CodSubProblema
														, ipd.CodDiagnostico
														, ipd.IDInformeIPD					
													FROM HClinica..InformeIPD ipd 
													union
													select 
														  tcGES.CodPaciente
														, tcGES.CodEpisodio
														, ipd.CodProblema
														, ipd.CodSubProblema
														, ipd.CodDiagnostico
														, tcGES.IDInformeIPD	
													FROM Hclinica..TrazabilidadCasoGES tcges 
														inner join hclinica..informeipd ipd on tcges.idinformeipd=ipd.idinformeipd 
												) I 
												inner join Parametros..CIEDiagnostico CIEDiag on I.CodDiagnostico=CIEDiag.CodDiagnostico
										WHERE I.CodPaciente=e.CodPaciente
										  and I.CodEpisodio=e.CodEpisodioOrigen	
									)
								  ) is null then 0
						else 1
					end as TieneGuia,
					'' as MotivoPasiva,
					e.CodColectivo,
					MP.Entidad + '-' + MS.Entidad as Aseguradora,
					cs.codCent as HospitalRef,
					cs.nomCentro as DescCentro,
					(case when e.CitaConfirmada = 0 then 1 else 0 end) as NoDerecho,
					null as CodConsulta,					
					null as FechaCita,					
					null as IdCita,
					null as CodTipoConsulta,
					null as CodigoServicio,
					null as CodTipoConsulta2,
					e.confirmada,
					p.NumTarjSanitaria,
					e.comunicada,
					e.CodigoRYF,
					e.CodCentroOrigen,
					cs1.DescCentro as DescCentroRef
					,'' as IdMotivo,
					p.FecNac,					
					null as CodHistoriaPapel,										
					p.Genero,
					'Sexo' = COD.Descripcion,
					'RUT Profesional' = NULL,
					'Profesional' = NULL,
					'Citador' = NULL,
					'TipoConsulta' = NULL,
					'Prioridad' = COD2.Descripcion						
		            ,e.Estado 
		            ,e.DescUnidadDestino as Unidad 					
					,p.DirTelf					
					,'TiempoEspera' = DATEDIFF(DD, e.FechaConsulta, ISNULL(e.FechaInicial, GETDATE())) 
					,COD2.Posicion as OrdenPrioridad 
					,2 as DerivacionSIC
					,e.ConfirmadaDestino
					,isnull(e.DerivacionManual,0) as DerivacionManual
					,e.ComunicadaDestino
					,e.AsisteCita
					,null as ConfAsistencia 
					,null as CitaEspontanea	
					,e.FechaInicial	
					,0 as NoAtendido
					,e.FechaNoAtendida
					,e.NoAsistenciasCita
					, NULL as idOrigenCita 
					, NULL as DescOrigenCitas
					,p.Email
					,p.Direccion 
					,p.DirNum
					 ,p.CodPostal 
					 ,L.NomPoblacion  
					 ,p1.Nombre as Provincia
					,L.NomPoblacion as Localidad
					,p.telf2
					,isNull(p.TarjSanitariaResp,'') as RutTutor
					,IsNull(PMRemite.NomMedico , '') as NombreMedicoRemi
					,IsNull(PMRemite.Apell1 , '') as Apel1MedicoRemi
					,IsNull(PMRemite.Apell2 , '') as Apel2MEdicoRemi
					,IsNull(PMRemite.Nif , '') as RutMedicoRemi
					,I.DescDiagnostico
					,CI.DescDiagnostico as DescDiagnosProvi
					,e.inspecciones 
					,e.IDProblemaSalud
					,gc.DescGuia as descProblema
					,gc1.DescGuia as descSubProblema
					,isnull(PMcita.Nif,isnull(DEcita.Nif,isnull(TD.Nif,Acita.nif))) as Nif
					,e.IdCausaInterconsulta
					,e.DescCausaInterconsulta
					,e.comentarios
					,e.TipoRemision
					,e.motivo
					,p.AtiendeAlNombre as NombreSocial
					,CASE WHEN 
					(
						EXISTS (select * from Hclinica..MutuasSaludSecPaciente MSSP 
						INNER JOIN parametros..MutuasSalud MS on MS.Codigo = MSSP.CodColectivo
						where codpaciente = e.CodPaciente and MS.EsPrais = 1)
					) THEN 1 ELSE 0 END AS EsPRAIS
					,'SIC Derivada' as ProfesionalAtiende
					,p.Telf3
					,p.TelfFijoUFamiliar
					,e.RUNProfEgreso
					,e.NomProfEgreso
					,e.ObservacionEgreso 
					,e.FechaCierre				
			from	Consultas..DerivacionConsultas e with (nolock)
					inner join Hclinica..Pacientes p with (nolock) on p.CodPaciente = e.CodPaciente 
					left join Parametros..ServiciosExternos s with (nolock) on s.Codigo = e.CodServicioFinal
					left join Parametros..Servicios s1 with (nolock) on s1.Codigo = e.CodServicioOrigen
					left join Parametros..DatosOtrosCentros cs with (nolock) on cs.CodCent = e.CodCentroFinal
					left join Parametros..CentrosSalud cs1 with (nolock) on cs1.CodCentro = e.CodCentroOrigen						
					left join Parametros..Codigos COD on COD.Codigo = p.Genero and Tabla = 'EstGenero'
					left join Parametros..Codigos COD2 on COD2.Codigo = e.Solicitud and COD2.Tabla = 'EstTipoExamen'
					LEFT JOIN parametros..DireccionLocalidad L ON p.DirCodLocalidad = L.CodPoblacion and p.dircodprov = l.codprovincia 		    
					LEFT JOIN parametros..codprovincias p1 on p1.codigo = p.dircodprov
					left join Parametros..ParametrosMedicos PMRemite on PMRemite.DNIMedico = e.DNIMedEpi
					LEFT JOIN Parametros..CIEDiagnostico I on e.CodDiagnosticoProvisional = I.CodDiagnostico
					LEFT JOIN Parametros..CIEDiagnostico CI on e.CodDiagnosticoPrimero = CI.CodDiagnostico
					left join  Parametros..GuiasClinicas gc on  gc.CodGuia = e.IDProblemaSalud 
					left join  Parametros..GuiasClinicas gc1 on  gc1.CodGuia = e.CodSubProblema	
					LEFT JOIN Parametros..TecnicosDatos TD on TD.DNITecnico = e.NIF	
					left join Parametros..ParametrosMedicos PMcita on PMcita.DNIMedico = e.NIF
					left join Parametros..DatosEnfermeras DEcita on DEcita.DNIEnf = e.NIF
					left join Parametros..Administrativo Acita on Acita.DNIAdminist = e.NIF				
					LEFT JOIN Parametros..MutuasSalud MS ON e.CodColectivo = MS.Codigo
					LEFT JOIN Parametros..MutuaPrincipal MP ON MS.CodMutua = MP.Codigo	

			where	e.Estado is null
					and p.CodPaciente = e.CodPaciente
					and e.AsisteCita = 1
					and (@spvar_Nombre is null or PacNombre like (rtrim(@spvar_Nombre) + '%') )
					and (@spvar_Apell1 is null or PacApell1 like (rtrim(@spvar_Apell1) + '%') )
					and (@spvar_Apell2 is null or PacApell2 like (rtrim(@spvar_Apell2) + '%') )
					and (@spvar_CodServicio is null or e.CodServicioFinal = @spvar_CodServicio)
					and (@spvar_CodServicioRemite is null or e.CodServicioOrigen = @spvar_CodServicioRemite)
					and (@spvar_FecSolDesde is null or datediff(d, @spvar_FecSolDesde, e.FechaConsulta) >= 0)
					and (@spvar_FecSolHasta is null or datediff(d, @spvar_FecSolHasta, e.FechaConsulta) <= 0)
					and (@spvar_FecCita is null or datediff(d, @spvar_FecCita, e.FechaCPrimera) = 0)
					and (@spvar_FecCitaDesde is null or datediff(d, @spvar_FecCitaDesde, e.FechaCPrimera) >= 0)
					and (@spvar_FecCitaHasta is null or datediff(d, @spvar_FecCitaHasta, e.FechaCPrimera) <= 0)
					and (@spvar_CodCentro is null or e.CodCentroOrigen = @spvar_CodCentro)
					and (@spvar_CodTipoRemision is null or e.TipoRemision = @spvar_CodTipoRemision)
					and (@spvar_Prioridad is null or e.Solicitud = @spvar_Prioridad)
					and (@spvar_DniMedicoDestino is null or e.DniMedDestino = @spvar_DniMedicoDestino)
					and (@spvar_Citados = '0' or (@spvar_Citados = '1' and e.FechaCPrimera is not null))
                    and (@spvar_NoCitados = '0' or (@spvar_NoCitados = '1' and e.FechaCPrimera is null and e.confirmada = '1' and e.ConfirmadaDestino = '1'))
					and (@spvar_FechaPrevistaDesde is null or e.FechaPrevista >= @spvar_FechaPrevistaDesde)
					and (@spvar_FechaPrevistaHasta is null or e.FechaPrevista <= @spvar_FechaPrevistaHasta)
					and (@spvar_AUGE is null or e.IdGuiaClinica is not null)
					and (@spvar_CodColectivo is null or e.CodColectivo = @spvar_CodColectivo)
					and (@spvar_codCentroDestino is null or e.CodCentroFinal = @spvar_codCentroDestino)
					and (@spvar_Reservadas = '0' or (@spvar_Reservadas = '1' and e.FechaCPrimera is not null and (e.CitaConfirmada = 0 or e.CitaConfirmada is null) ))
					and (@spvar_Confirmadas = '0' or (@spvar_Confirmadas = '1' and e.FechaCPrimera is not null and e.CitaConfirmada = 1))
					and (@spvar_idUnidad is null or e.IdUnidad = @spvar_idUnidad)
					and (@spvar_DniMedicoOrigen is null or e.DNIMedEpi = @spvar_DniMedicoOrigen)
					and (
						(@spvar_LibreEleccion is null and (e.LibreEleccion is null or e.LibreEleccion = 0)
						or
						(e.LibreEleccion = 1)))
					and (@spvar_PRAIS is null
						or 
						(@spvar_PRAIS = 1 and 
						EXISTS (select MS.EsPrais from 
						Hclinica..MutuasSaludSecPaciente MSSP 
						INNER JOIN parametros..MutuasSalud MS on MS.Codigo = MSSP.CodColectivo
						where codpaciente = e.CodPaciente and MS.EsPrais = 1))
						or 
						(@spvar_PRAIS = 0 and 
						NOT EXISTS (select MS.EsPrais from 
						Hclinica..MutuasSaludSecPaciente MSSP 
						INNER JOIN parametros..MutuasSalud MS on MS.Codigo = MSSP.CodColectivo
						where codpaciente = e.CodPaciente and MS.EsPrais = 1)))

				end
			else
				begin
					select 
					e.Codhistoria,
					e.CodPaciente,
					'PacNombre'=  rtrim(p.Pacnombre),
					'PacApell1' = rtrim(p.PacApell1),
					'PacApell2' = rtrim(p.PacApell2),
					e.codderivacion as CodEpisodio,					
					e.FechaCPrimera,					
					e.FechaConsulta,				
					e.DictamenClinico as Juicio,
					e.CodCentroFinal,
					S.Codigo, 
					s.DescServicio ServicioDestino,
					s1.DescServicio ServicioRemite,
					'0' as Pasiva,
					e.Solicitud,					
					e.FechaPrevista,					
					case
						when 
							isnull(
									e.IdGuiaClinica,
									(
										select MIN (I.CodProblema)
										from 	(
													SELECT 
														  ipd.CodPaciente
														, ipd.CodEpisodio
														, ipd.CodProblema
														, ipd.CodSubProblema
														, ipd.CodDiagnostico
														, ipd.IDInformeIPD					
													FROM HClinica..InformeIPD ipd 
													union
													select 
														  tcGES.CodPaciente
														, tcGES.CodEpisodio
														, ipd.CodProblema
														, ipd.CodSubProblema
														, ipd.CodDiagnostico
														, tcGES.IDInformeIPD	
													FROM Hclinica..TrazabilidadCasoGES tcges 
														inner join hclinica..informeipd ipd on tcges.idinformeipd=ipd.idinformeipd 
												) I 
												inner join Parametros..CIEDiagnostico CIEDiag on I.CodDiagnostico=CIEDiag.CodDiagnostico
										WHERE I.CodPaciente=e.CodPaciente
										  and I.CodEpisodio=e.CodEpisodioOrigen	
									)
								  ) is null then 0
						else 1
					end as TieneGuia,
					'' as MotivoPasiva,
					e.CodColectivo,
					MP.Entidad + '-' + MS.Entidad as Aseguradora,					
					cs.CodCent as HospitalRef,
					cs.NomCentro as DescCentro,
					(case when e.CitaConfirmada = 0 then 1 else 0 end) as NoDerecho,
					null as CodConsulta,					
					null as FechaCita,					
					null as IdCita,
					null as CodTipoConsulta,
					null as CodigoServicio,
					null as CodTipoConsulta2,	
					e.Confirmada,
					p.NumTarjSanitaria,
					e.comunicada,
					e.CodigoRYF,
					e.CodCentroOrigen,
					cs1.DescCentro as DescCentroRef
					,'' as IdMotivo,
					p.FecNac,					
					null as CodHistoriaPapel,					
					p.Genero,
					'Sexo' = COD.Descripcion,
					'RUT Profesional' = e.DniMedDestino,
					'Profesional' = NULL,
					'Citador' = NULL,
					'TipoConsulta' = NULL,
					'Prioridad' = COD2.Descripcion	
					,e.Estado 		            	
		            ,e.DescUnidadDestino as Unidad 					
					,p.DirTelf					
					,'TiempoEspera' = DATEDIFF(DD, e.FechaConsulta, ISNULL(e.FechaInicial, GETDATE()))
					,COD2.Posicion as OrdenPrioridad 
					,2 as DerivacionSIC
					,e.ConfirmadaDestino
					,isnull(e.DerivacionManual,0) as DerivacionManual
					,e.ComunicadaDestino
					,e.AsisteCita
					,null as ConfAsistencia 
					,null as CitaEspontanea	
					,e.FechaInicial	
					,0 as NoAtendido
					,e.FechaNoAtendida
					,e.NoAsistenciasCita
					, NULL as idOrigenCita 
					, NULL as DescOrigenCitas
					,p.Email
					,p.Direccion 
					,p.DirNum
					 ,p.CodPostal 
					 ,L.NomPoblacion  
					 ,p1.Nombre as Provincia
					,L.NomPoblacion as Localidad
					,p.telf2
					,isNull(p.TarjSanitariaResp,'') as RutTutor
					,IsNull(PMRemite.NomMedico , '') as NombreMedicoRemi
					,IsNull(PMRemite.Apell1 , '') as Apel1MedicoRemi
					,IsNull(PMRemite.Apell2 , '') as Apel2MEdicoRemi
					,IsNull(PMRemite.Nif , '') as RutMedicoRemi
					,I.DescDiagnostico
					,CI.DescDiagnostico as DescDiagnosProvi
					,e.inspecciones 
					,e.IDProblemaSalud
					,gc.DescGuia as descProblema
					,gc1.DescGuia as descSubProblema
					,isnull(PMcita.Nif,isnull(DEcita.Nif,isnull(TD.Nif,Acita.nif))) as Nif
					,e.IdCausaInterconsulta
					,e.DescCausaInterconsulta
					,e.comentarios
					,e.TipoRemision
					,e.motivo
					,p.AtiendeAlNombre as NombreSocial
					,CASE WHEN 
					(
						EXISTS (select * from Hclinica..MutuasSaludSecPaciente MSSP 
						INNER JOIN parametros..MutuasSalud MS on MS.Codigo = MSSP.CodColectivo
						where codpaciente = e.CodPaciente and MS.EsPrais = 1)
					) THEN 1 ELSE 0 END AS EsPRAIS
					,'' as ProfesionalAtiende
					,p.Telf3
					,p.TelfFijoUFamiliar
					,e.RUNProfEgreso
					,e.NomProfEgreso
					,e.ObservacionEgreso 
					,e.FechaCierre										
			from	Consultas..DerivacionConsultas e with (nolock)
					inner join Hclinica..Pacientes p with (nolock) on p.CodPaciente = e.CodPaciente
					left join Parametros..ServiciosExternos s with (nolock) on s.Codigo = e.CodServicioFinal
					left join Parametros..Servicios s1 with (nolock) on s1.Codigo = e.CodServicioOrigen
					left join Parametros..DatosOtrosCentros cs with (nolock) on cs.CodCent = e.CodCentroFinal
					left join Parametros..CentrosSalud cs1 with (nolock) on cs1.CodCentro = e.CodCentroOrigen
					left join Parametros..MutuasSalud m on e.CodColectivo = m.codigo
					left join Parametros..Codigos COD on COD.Codigo = p.Genero and Tabla = 'EstGenero'
					left join Parametros..Codigos COD2 on COD2.Codigo = e.Solicitud and COD2.Tabla = 'EstTipoExamen'
					LEFT JOIN parametros..DireccionLocalidad L ON p.DirCodLocalidad = L.CodPoblacion and p.dircodprov = l.codprovincia 		    
					LEFT JOIN parametros..codprovincias p1 on p1.codigo = p.dircodprov
					left join Parametros..ParametrosMedicos PMRemite on PMRemite.DNIMedico = e.DNIMedEpi
					LEFT JOIN Parametros..CIEDiagnostico I on e.CodDiagnosticoProvisional = I.CodDiagnostico
					LEFT JOIN Parametros..CIEDiagnostico CI on e.CodDiagnosticoPrimero = CI.CodDiagnostico
					left join  Parametros..GuiasClinicas gc on  gc.CodGuia = e.IDProblemaSalud 
					left join  Parametros..GuiasClinicas gc1 on  gc1.CodGuia = e.CodSubProblema
					LEFT JOIN Parametros..TecnicosDatos TD on TD.DNITecnico = e.NIF
					left join Parametros..ParametrosMedicos PMcita on PMcita.DNIMedico = e.NIF
					left join Parametros..DatosEnfermeras DEcita on DEcita.DNIEnf = e.NIF
					left join Parametros..Administrativo Acita on Acita.DNIAdminist = e.NIF	
					LEFT JOIN Parametros..MutuasSalud MS ON e.CodColectivo = MS.Codigo
					LEFT JOIN Parametros..MutuaPrincipal MP ON MS.CodMutua = MP.Codigo	
			
			where   e.Estado is null
					and (@spvar_Nombre is null or PacNombre like (rtrim(@spvar_Nombre) + '%') )
                    and (@spvar_Apell1 is null or PacApell1 like (rtrim(@spvar_Apell1) + '%') )
                    and (@spvar_Apell2 is null or PacApell2 like (rtrim(@spvar_Apell2) + '%') )
                    and (@spvar_CodServicio is null or e.CodServicioFinal = @spvar_CodServicio)
                    and (@spvar_CodServicioRemite is null or e.CodServicioOrigen = @spvar_CodServicioRemite)
                    and (@spvar_FecSolDesde is null or datediff(d, @spvar_FecSolDesde, e.FechaConsulta) >= 0)
                    and (@spvar_FecSolHasta is null or datediff(d, @spvar_FecSolHasta, e.FechaConsulta) <= 0)
                    and (@spvar_FecCita is null or datediff(d, @spvar_FecCita, e.FechaCPrimera) = 0)
                    and (@spvar_FecCitaDesde is null or datediff(d, @spvar_FecCitaDesde, e.FechaCPrimera) >= 0)
                    and (@spvar_FecCitaHasta is null or datediff(d, @spvar_FecCitaHasta, e.FechaCPrimera) <= 0)
                    and (@spvar_CodCentro is null or e.CodCentroOrigen = @spvar_CodCentro)
                    and (@spvar_CodTipoRemision is null or e.TipoRemision = @spvar_CodTipoRemision)
                    and (@spvar_Prioridad is null or e.Solicitud = @spvar_Prioridad)
                    and (@spvar_DniMedicoDestino is null or e.DniMedDestino = @spvar_DniMedicoDestino)
                    and (@spvar_Citados = '0' or (@spvar_Citados = '1' and e.FechaCPrimera is not null))
                    and (@spvar_NoCitados = '0' or (@spvar_NoCitados = '1' and e.FechaCPrimera is null and e.confirmada = '1' and e.ConfirmadaDestino = '1'))
                    and (@spvar_FechaPrevistaDesde is null or e.FechaPrevista >= @spvar_FechaPrevistaDesde)
                    and (@spvar_FechaPrevistaHasta is null or e.FechaPrevista <= @spvar_FechaPrevistaHasta)
                    and (@spvar_AUGE is null or e.IdGuiaClinica is not null)
                    and (@spvar_CodColectivo is null or e.CodColectivo = @spvar_CodColectivo)
                    and (@spvar_codCentroDestino is null or e.CodCentroFinal = @spvar_codCentroDestino)           
                    and (@spvar_PropConfirmadas = '0' or (@spvar_PropConfirmadas = '1' and  e.confirmada = 1 and e.ConfirmadaDestino = 1))                       
                    and (@spvar_FecConfDesde is null or (datediff(d, @spvar_FecConfDesde, e.FechaConfirmacion) >= 0) or (e.fechaConfirmacion is null and (datediff(d, @spvar_FecConfDesde, e.FechaConsulta) >= 0)))
                    and (@spvar_FecConfHasta is null or (datediff(d, @spvar_FecConfHasta, e.FechaConfirmacion) <= 0) or (e.fechaConfirmacion is null and (datediff(d, @spvar_FecConfHasta, e.FechaConsulta) >= 0))) 
                    and (@spvar_PropPendientes = '0' or (@spvar_PropPendientes = '1' and (e.confirmada = 0 or e.ConfirmadaDestino = 0)))
                    and (@spvar_idUnidad is null or e.IdUnidad = @spvar_idUnidad)
                    and (@spvar_Comunicadas = '0' or ((@spvar_Comunicadas = '1' and e.Comunicada = 1)))
                    and (@spvar_SinComunicar = '0' or (@spvar_SinComunicar = '1' and e.comunicada = 0 and e.confirmada = 1))
					and (@spvar_DniMedicoOrigen is null or e.DNIMedEpi = @spvar_DniMedicoOrigen)
					and (
						(@spvar_LibreEleccion is null and (e.LibreEleccion is null or e.LibreEleccion = 0)
						or
						(e.LibreEleccion = 1)))
					and (@spvar_PRAIS is null
						or 
						(@spvar_PRAIS = 1 and 
						EXISTS (select MS.EsPrais from 
						Hclinica..MutuasSaludSecPaciente MSSP 
						INNER JOIN parametros..MutuasSalud MS on MS.Codigo = MSSP.CodColectivo
						where codpaciente = e.CodPaciente and MS.EsPrais = 1))
						or 
						(@spvar_PRAIS = 0 and 
						NOT EXISTS (select MS.EsPrais from 
						Hclinica..MutuasSaludSecPaciente MSSP 
						INNER JOIN parametros..MutuasSalud MS on MS.Codigo = MSSP.CodColectivo
						where codpaciente = e.CodPaciente and MS.EsPrais = 1)))
				end
			end
		end
	end

END



GO



--dbo.SpConSDetalleEpisodioCCWSHC.sql

USE [Consultas]
    GO
    IF EXISTS 
    (
        SELECT * 
            FROM sys.procedures 
            WHERE [object_id] = OBJECT_ID('[dbo].[SpConSDetalleEpisodioCCWSHC]')
    )
    BEGIN
        DROP PROCEDURE [dbo].[SpConSDetalleEpisodioCCWSHC];
    END
    GO

/*
PROCEDIMIENTO	: HClinica..SpConSDetalleEpisodioCCWSHC
FUNCION			: Recupera todos los datos necesarios para la respuesta del método ObtenerDetalleHistorialClinico para un episodio de Consulta Externa
ORIGEN          : WS Historial Clínico Florence - Método ObtenerDetalleHistorialClinico
DEVUELVE		: Devuelve 13 tablas con los siguientes datos:
							  1. Datos del episodio
							  2. Datos del paciente
							  3. Antecedentes patológicos del paciente
							  4. Anamnesis
							  5. Diagnósticos
							  6. Interconsultas
							  7. Citas
							  8. Profesional prestador
							  9. Prestaciones
							  10. Recetas
							  11. Prescripciones
							  12. Registros de pruebas
							  13. Pruebas						 
FECHA			: 10/08/2012
VERSION        	: WS Historial Clinico 1.0
AUTOR			: Enrique Sánchez CHC-1919, v4.31.2
****************************************************
REVISIONES:
----------------------------------------------------
AUTOR			: Enrique Sánchez
FECHA			: 18/09/2012
VERSION			: WS Historial Clinico 2.03
INCIDENCIA		: CHC-2062
DESCRIPCION		: Se engloban en una cita ficticia todos los registros de actividades, recetas y pruebas cuya fecha de registro no casa con ninguna de las citas del episodio
----------------------------------------------------
AUTOR			: Enrique Sánchez
FECHA			: 02/11/2012
VERSION			: WS Historial Clinico 2.03
INCIDENCIA		: REQ14162
DESCRIPCION		: Se corrige la unidad temporal de la duración en las recetas prolongadas
----------------------------------------------------
AUTOR			: Jose Antonio Vaquerizo
FECHA			: 02/07/2014
VERSION			: WS Historial Clinico 2.03
INCIDENCIA		: 59038_874 - v4.46
DESCRIPCION		: Comprobar por centro en LEFT JOIN de la tabla Parametros..EspecialidadDEIS


MODIFICACION: 30/06/2016 v4.62 - 3009 - JMG - Actualizar PA Visor Historia Clínica Compartida	
MODIFICACION: 19/10/2016 v4.63r5 - 13825 - LMF - Descripcion prueba laboratorio(13) y obtencion de otras pruebas(13)
MODIFICACION: 24/10/2016 v4.63r6 - 13911 - LMF - Se hace un top 1 del episodio (0).Se obtiene el estado y resultado de las pruebas 
												 de laboratorio y otras pruebas(13)	
MODIFICACION: 04/11/2016 v4.63r7 - 14026 - LMF - Se añade el bloque de ResultadosExamen	
MODIFICACION: 22/12/2016 v4.63r9 - 15006 - DVR - Observaciones visor clinico 
MODIFICACION: 30/12/2016 v4.63r9 - 15066 - DVR - Observacion visor clinico 
MODIFICACION: 11/01/2017 v4.63r10 - 15143 - DVR - Modificación de WS historial clínico
MODIFICACION: 12/06/2017 v4.68r4/17.1r4 - 18365 - SGH - Modificación representación de Motivo Consulta en Visor Clínico
*/

CREATE PROCEDURE [dbo].[SpConSDetalleEpisodioCCWSHC] 
	@spvar_CodPaciente   CHAR(16),
	@spvar_CodEpisodio   CHAR(5),
	@spvar_Fecha SMALLDATETIME
AS
BEGIN

DECLARE @spvar_IdEspecialidadDEIS CHAR(10)=NULL
DECLARE @spvar_IdEpisodio CHAR(22) = NULL
DECLARE @spvar_FechaEpisodio DATETIME = NULL

/*---------------------------------------
DATOS COMUNES DEL EPISODIO
----------------------------------------*/

SET @spvar_IdEpisodio=@spvar_CodPaciente + '-' + @spvar_CodEpisodio 

DECLARE @txtResumenEpis varchar(max)=''
DECLARE @ResumenEpis TABLE ( descinforme Text, nommedico varchar(max), indicacionesAltaDAU2012 Text)
INSERT @ResumenEpis Exec HClinica..SpHClSTextoInfAlta @spvar_CodPaciente, @spvar_CodEpisodio

IF (select count(*) from @ResumenEpis) > 0
BEGIN
	DECLARE @descInforme varchar(max)
	SET @descInforme =(select top 1 descinforme from @ResumenEpis)
	DECLARE @indicaciones varchar(max)
	SET @indicaciones =(select top 1 indicacionesAltaDAU2012 from @ResumenEpis)

	IF NOT @descInforme is NULL
	BEGIN
		SET	@txtResumenEpis = @descInforme 
	END

	IF NOT  @indicaciones is NULL
	BEGIN
		SET @txtResumenEpis = @txtResumenEpis + ' ' + @indicaciones 
	END

END


/*Datos episodio*/
/* 02/07/2014 - v4.46 – 59038_874 – JVT – Excepción en integración de historia clínica de Florence.
 Comprobar por centro en LEFT JOIN de la tabla Parametros..EspecialidadDEIS
*/
SELECT @spvar_FechaEpisodio=E.FechaInicial  FROM Consultas..EpisodioConsultas E WHERE E.CodEpisodio=@spvar_CodEpisodio AND E.CodPaciente=@spvar_CodPaciente
SELECT TOP 1
		'IdEpisodio' = @spvar_IdEpisodio,
		'CodigoDEISEstablecimiento' = SUBSTRING(C.CodCentro,1,2) + '-' + SUBSTRING(C.CodCentro,3,5),
		'DescripcionEstablecimiento' = RTRIM(isnull(C.DescCentro,'')),
		'CodigoDEISEspecialidad' = RTRIM(isnull(ED.IDEspecialidad,'')),
		'DescripcionEspecialidad' = RTRIM(isnull(S.DescServicio,'')),
		'TipoEpisodio' = 'Consulta Externa',
		'FechaHoraInicio' = E.FechaInicial,		
		'EstadoEpisodio' = CASE WHEN E.FechaCierre IS NULL THEN 'Abierto' ELSE 'Cerrado' END,
	    'PrevisionPaciente' = MS.Entidad,
	    'Resumen' = @txtResumenEpis
FROM
		Consultas..EpisodioConsultas E
	    LEFT JOIN Parametros..CentrosSalud C ON E.CodCentroFinal=C.CodCentro		    
	    LEFT JOIN Parametros..Servicios S ON S.Codigo=E.CodServicioFinal	
	    LEFT JOIN Parametros..MutuasSalud MS ON E.CodColectivo = MS.Codigo
		LEFT JOIN Parametros..MutuaPrincipal MP ON MS.CodMutua = MP.Codigo
		LEFT JOIN Parametros..EspecialidadDEIS ED ON ED.CodServicio=S.Codigo AND ED.CodCentro=C.CodCentro

WHERE	
		E.CodEpisodio=@spvar_CodEpisodio AND E.CodPaciente=@spvar_CodPaciente
ORDER BY ED.IDEspecialidad
		
--Guardamos el codigo DEIS de la especialidad para las atenciones
/* 02/07/2014 - v4.46 – 59038_874 – JVT – Excepción en integración de historia clínica de Florence.
 Comprobar por centro en LEFT JOIN de la tabla Parametros..EspecialidadDEIS
*/
SELECT	
	@spvar_IdEspecialidadDEIS =	isnull(ED.IDEspecialidad,'') 
FROM 
	Consultas..EpisodioConsultas E 
	LEFT JOIN Parametros..EspecialidadDEIS ED ON ED.CodServicio=E.CodServicioFinal AND ED.CodCentro = E.CodCentroFinal	
WHERE		
	E.CodEpisodio=@spvar_CodEpisodio AND E.CodPaciente=@spvar_CodPaciente
	
--Datos paciente
SELECT
		'RUT'= RTRIM(isnull(P.NumTarjSanitaria,'')),
		'RUNResponsable' = RTRIM(isnull(P.TarjSanitariaResp,'')),
		'OtraIdentificacion ' = isnull(P.Nif,''),
		'IdRyF' = RTRIM(ISNULL(P.SegSocial,'')),
		'Sexo' = PC.Descripcion,
		'NombreCompleto' = RTRIM(P.PacNombre) + ' ' + RTRIM(P.PacApell1) + ' ' + RTRIM(P.pacapell2),
		'FechaNacimiento' = CONVERT(VARCHAR(10),P.fecnac,120),		
		'CodPaciente' = P.CodPaciente
FROM
		Hclinica..pacientes P
		LEFT JOIN Parametros..Codigos PC ON PC.Tabla='EstGenero' AND P.Genero=PC.Codigo
WHERE 
		P.CodPaciente=@spvar_CodPaciente

--Antecedentes patologicos

DECLARE @Longitud tinyint,@x tinyint

DECLARE @Antecedentes AS TABLE (Fecha SMALLDATETIME,Codigo CHAR(6), CIE VARCHAR(150) NULL)

INSERT @Antecedentes (Fecha,Codigo)
SELECT FecCrea,CodDiag
FROM Hclinica..DiagnosticosCIE
WHERE CodPaciente=@spvar_CodPaciente AND Substring(CodDiag,1,1)<>'E'
	AND CodDiag <> '999.9'
	AND ((NOT (CodEpisodio = @spvar_CodEpisodio ) ) OR  @spvar_CodEpisodio IS NULL)

INSERT @Antecedentes (Fecha,Codigo)
SELECT FecIni,CodProblem
FROM Hclinica..Problemas
WHERE CodPaciente=@spvar_CodPaciente AND CodGrupProblem='2' AND CodProblem IS NOT NULL
	AND (
			(Problemas.CodProblem   in 
				(SELECT CodDiag
				 FROM Hclinica..DiagnosticosCIE
				 WHERE CodPaciente=@spvar_CodPaciente AND Substring(CodDiag,1,1)<>'E' 
					AND ((CodEpisodio <> @spvar_CodEpisodio ) OR @spvar_CodEpisodio IS NULL)
				)	
			)
		 OR
			(Problemas.CodProblem  NOT in 
				(SELECT CodDiag
				 FROM Hclinica..DiagnosticosCIE
				 WHERE CodPaciente=@spvar_CodPaciente AND Substring(CodDiag,1,1)<>'E' 
					
				)	
			)
		)
		
INSERT @Antecedentes (Fecha,Codigo)
SELECT F_Alta,Cod_CIE
FROM Hclinica..CMBD
WHERE CodPaciente=@spvar_CodPaciente AND Cod_Cie IS NOT NULL

SELECT @Longitud=Max(Datalength(Cod_Cie_Otros))
FROM Hclinica..CMBD
WHERE CodPaciente=@spvar_CodPaciente

SELECT @x=0

WHILE @x<@Longitud
  BEGIN
    INSERT @Antecedentes (Fecha,Codigo)
    SELECT F_Alta,SubString(Cod_CIE_Otros,6*@x+1,6)
    FROM Hclinica..CMBD
    WHERE CodPaciente=@spvar_CodPaciente AND SubString(Cod_CIE_Otros,6*@x+1,6) IS NOT NULL

    SELECT @x=@x+1
  END

SELECT distinct Codigo AS CodigoAntecedente, I.DescDiagnostico, @spvar_CodPaciente AS CodPaciente
From @Antecedentes, parametros..CIEDiagnostico I
WHERE I.CodDiagnostico=Codigo
ORDER BY DescDiagnostico
--Fin antecedentes
	
--Diagnósticos
SELECT
    'CodigoDiagnostico' = DC.CodDiag,
	'TIpoCodigoDiagnostico' = DI.VersionDiag,
	'DescripcionDiagnostico' = DI.DescDiagnostico,	
	'EsAuge' =  CASE GC.TipoGuia WHEN 1 THEN '1' ELSE '0' END,
	'IdEpisodio' = @spvar_IdEpisodio
FROM
	Hclinica..DiagnosticosCIE DC
	INNER JOIN Parametros..CIEDiagnostico DI ON DI.CodDiagnostico=DC.CodDiag 	  
	LEFT JOIN (SELECT CI.CodDiagnostico,GCL.TipoGuia 
				FROM Parametros..GuiasClinicas GCL
				INNER JOIN Parametros..CriteriosInclusion CI ON CI.CodGuia=GCL.CodGuia GROUP BY CI.CodDiagnostico,GCL.TipoGuia) GC ON GC.CodDiagnostico=DI.CodDiagnostico 
WHERE
	DC.CodPaciente=@spvar_CodPaciente AND DC.CodEpisodio=@spvar_CodEpisodio
	AND DC.FecBorrado IS NULL

--Evoluciones
SELECT  
'IdEpisodio' = @spvar_IdEpisodio,
'TextoEvolucion' = ISNULL(IP.Evolucion,''),
'ProfesionalEvolucion' = RTRIM(v1.Nombre) + ' ' + RTRIM(v1.Apellido1) + ' ' + RTRIM(v1.Apellido2),
'RolProfesionalEvolucion' = ISNULL(C.Descripcion,ISNULL(v1.RolUsuario,'')),
'FechaHoraEvolucion' = ISNULL(IP.HComienzo,'')
FROM Consultas..InformesProgreso IP
	LEFT JOIN Parametros..vParDatosUsuarios v1 ON v1.Dni = IP.NIFMedico
	LEFT JOIN Parametros..Codigos C on v1.CodRol = C.Codigo and C.Tabla = 'RolUsuario'
WHERE 
	IP.CodPaciente = @spvar_CodPaciente and IP.CodEpisodio = @spvar_CodEpisodio
ORDER BY IP.HComienzo ASC

--Interconsultas
SELECT
	'IdSolicitud' = I.CodRegistro,
	'FechaHoraSolicitud' = convert(CHAR(8), I.FechaSolic,112) + ' ' + convert(CHAR(5), I.FechaSolic,108),
	'NombreEspecialidadOrigen'=S.DescServicio,
	'NombreEspecialidadDestino' = SD.DescServicio,
	'DiagnosticoProvisional' = isnull(D.DescDiagnostico,''),
	'CodigoDEISEstablecimientoOrigen' = SUBSTRING(I.CodCentroSolic,1,2) + '-' + SUBSTRING(I.CodCentroSolic,3,5),
	'NombreEstablecimientoOrigen' = C.DescCentro,
	'CodigoDEISEstablecimientoDestino'=SUBSTRING(I.CodCentroSalida,1,2) + '-' + SUBSTRING(I.CodCentroSalida,3,5),
	'NombreEstablecimientoDestino' = CD.DescCentro,
	'MotivoSolicitud' = isnull(I.CausaEnvio,''),
	'Conclusion'=isnull(I.Conclusion,''),
	'RUTProfesionalSolicita' = COALESCE(I.NifMedSolic, I.NifEnfSolic),
	'IdEpisodio' = @spvar_IdEpisodio
FROM 
	Hclinica..Interconsulta I
	INNER JOIN Parametros..Servicios S ON I.CodServSolic=S.Codigo
	INNER JOIN Parametros..Servicios SD ON I.CodServSalida=SD.Codigo
	LEFT JOIN Parametros..CIEDiagnostico D ON I.DiagnProv=D.CodDiagnostico
	INNER JOIN Parametros..CentrosSalud C ON C.CodCentro=I.CodCentroSolic
	LEFT JOIN Parametros..CentrosSalud CD ON CD.CodCentro=I.CodCentroSalida
WHERE
	I.CodPaciente=@spvar_CodPaciente AND I.CodEpisodio=@spvar_CodEpisodio

/*------------------------------------------------
DATOS RELATIVOS A CADA CITA DENTRO DEL EPISODIO
-------------------------------------------------*/	
DECLARE @tmpCitas AS TABLE (
	FechaHora SMALLDATETIME,
	IdAtencion VARCHAR(20),
	CodigoDEISEstablecimiento VARCHAR(10), 
	DescripcionEstablecimiento VARCHAR(250),
	CodigoDEISEspecialidad VARCHAR(50),
	DescripcionEspecialidad VARCHAR(250),
	TipoAtencion VARCHAR(250),
	FechaHoraInicio CHAR(14),
	EstadoAtencion VARCHAR(50),
	PrevisionPaciente VARCHAR(250),
	FechaCita SMALLDATETIME,
	NIFMedicoConsulta CHAR(8),
	IdEpisodio CHAR(22),
	CodConsulta CHAR(6),
    ResumenAtencion VARCHAR(MAX)
	)
--Citas
/* 02/07/2014 - v4.46 – 59038_874 – JVT – Excepción en integración de historia clínica de Florence.
 Comprobar por centro en LEFT JOIN de la tabla Parametros..EspecialidadDEIS
*/
INSERT @tmpCitas 
SELECT
    'FechaHora' = C.FechaCita,
	'IdAtencion' = C.IdCita,
	'CodigoDEISEstablecimiento' = SUBSTRING(UC.CodCentro,1,2) + '-' + SUBSTRING(UC.CodCentro,3,5),
	'DescripcionEstablecimiento' = isnull(CS.DescCentro,''),
	'CodigoDEISEspecialidad' = (SELECT TOP 1 Descripcion FROM Parametros..EspecialidadDEIS ED WHERE ED.CodServicio=S.Codigo AND ED.CodCentro=CS.CodCentro),
	'DescripcionEspecialidad' = S.DescServicio,
	'TipoAtencion' = CN.DescCons,
	'FechaHoraInicio' =  convert(CHAR(8), C.FechaCita,112) + ' ' + convert(CHAR(5), C.FechaCita,108),
	'EstadoAtencion' = CASE C.Asiste WHEN 1 THEN 'ASISTE' ELSE 'NO ASISTE' END,
	'PrevisionPaciente' = MS.Entidad,
	'FechaCita' = C.FechaCita,
	'NIFMedicoConsulta'= C.NIFMedicoConsulta,
	'IdEpisodio'=@spvar_IdEpisodio,
	'CodConsulta' = C.CodConsulta,
	'ResumenAtencion'=''
FROM 
	Hclinica..Citas C 
	LEFT JOIN Parametros..Servicios S ON S.Codigo = C.CodigoServicio   
	LEFT JOIN parametros..Consultas CN ON CN.CodCons =  C.CodConsulta
	LEFT JOIN Parametros..UbicacionesConsulta UC ON UC.CodUbicCons = CN.CodLocaliz AND UC.CodCentro = CN.CodCentro
	LEFT JOIn Parametros..CentrosSalud CS ON CS.CodCentro=UC.CodCentro
	LEFT JOIN Parametros..ParametrosMedicos PM ON PM.DNIMedico=COALESCE(CN.nifmedcons, C.NIFMedicoConsulta)
	LEFT JOIN Parametros..DatosEnfermeras DE ON DE.DNIEnf = COALESCE(CN.nifmedcons,C.NIFMedicoConsulta)
	LEFT JOIN Parametros..Administrativo A ON A.DNIAdminist = COALESCE(CN.nifmedcons,C.NIFMedicoConsulta)
	LEFT JOIN Parametros..Servicios SM ON SM.Codigo=COALESCE(PM.CodServicioMedico,DE.codservicio,A.CodServicioAdminist)
	LEFT JOIN Parametros..MutuasSalud MS ON C.CodColectivo = MS.Codigo
	LEFT JOIN Parametros..MutuaPrincipal MP ON MS.CodMutua = MP.Codigo	
	
	INNER JOIN Consultas..EpisodioConsultas E ON E.CodEpisodio=C.CodEpisodio AND E.CodPaciente=C.CodPaciente
WHERE
	C.CodPaciente=@spvar_CodPaciente AND C.CodEpisodio=@spvar_CodEpisodio and  
	CAST(C.FechaCita as DATE)>= CAST(@spvar_Fecha as DATE) AND
	C.Asiste=1 and C.HoraInicial IS NOT NULL

--Profesional cita
DECLARE @tmpProfesionales AS TABLE (RUT VARCHAR(10), NombreCompleto VARCHAR(max),TipoProfesional VARCHAR(max), IdAtencion integer, CodConsulta CHAR(10))
INSERT @tmpProfesionales
SELECT
	'RUT'= isnull(COALESCE(PM.DNIMedico, DE.DNIEnf, A.DNIAdminist),''),
	'NombreCompleto' = isnull(RTRIM(COALESCE(PM.NomMedico,DE.NombreEnf,A.NomAdminis)) + ' ' + RTRIM(COALESCE(PM.Apell1,DE.Apell1Enf,A.Apell1Administ)) + ' ' + RTRIM(COALESCE(PM.Apell2,DE.Apell2Enf, A.Apell2Administ)),''),
	'TipoProfesional' = isnull(SM.DescServicio,''),
	'IdAtencion'=C.IdAtencion,
	'CodConsulta'=C.CodConsulta
FROM
	@tmpCitas C 
	LEFT JOIN parametros..Consultas CN ON CN.CodCons =  C.CodConsulta
	LEFT JOIN Parametros..ParametrosMedicos PM ON PM.DNIMedico=COALESCE(C.NIFMedicoConsulta, CN.nifmedcons)
	LEFT JOIN Parametros..DatosEnfermeras DE ON DE.DNIEnf = COALESCE(C.NIFMedicoConsulta, CN.nifmedcons)
	LEFT JOIN Parametros..Administrativo A ON A.DNIAdminist = COALESCE(C.NIFMedicoConsulta, CN.nifmedcons)
	LEFT JOIN Parametros..Servicios SM ON SM.Codigo=COALESCE(PM.CodServicioMedico,DE.codservicio,A.CodServicioAdminist)

---------------------
--  detalle FISIO ok
---------------------

INSERT @tmpCitas 
select		
	citas.FechaCita,
	fi.codregistro as IdAtencion,
	'' as CodigoDEISEstablecimiento, --SUBSTRING(UC.CodCentro,1,2) + '-' + SUBSTRING(UC.CodCentro,3,5) as 'CodigoDEISEstablecimiento',
	CS.DescCentro as DescripcionEstablecimiento,
	(select top 1 esp.Descripcion from parametros..EspecialidadDEIS esp 
					where med.CodServicioMedico=esp.CodServicio and esp.CodCentro=p.CodCenSalud) as CodigoDEISEspecialidad,
    (select DescServicio from parametros..Servicios where Codigo = citas.CodServicio) as DescripcionEspecialidad,
	agendas.DescPuesto as TipoAtencion,  --agenda
	convert(CHAR(8), citas.FechaCita,112) + ' ' + convert(CHAR(5), citas.FechaCita,108) as FechaHoraInicio,
	(CASE Citas.Asiste WHEN 1 THEN 'ASISTE' WHEN 0 THEN 'NO ASISTE' ELSE 'PENDIENTE' END) as EstadoAtencion,
	MS.Entidad as PrevisionPaciente,
	citas.FechaCita as FechaCita,
	FI.DNIMedico as NIFMedicoConsulta,
    FI.CodEpisodio as IdEpisodio,
	citas.CodGimnasio as CodConsulta,
	'' as ResumenAtencion
            
from	HClinica.dbo.CitasFisioterapia citas
		inner join HClinica..Fisioterapia FI On				FI.CodRegistro = Citas.CodRegistro			
		inner join hclinica..pacientes p					on  FI.codPaciente=p.codPaciente
		left join Parametros..MutuasSalud MS on				citas.CodColectivo = MS.Codigo
	    left join Ingresos..EpisodioHospitalizacion EH		On	EH.CodPaciente = FI.CodPaciente And EH.CodEpisodio = FI.CodEpisodio
		left join consultas..Episodioconsultas EC			On	EC.CodPaciente = FI.CodPaciente	And EC.CodEpisodio = FI.CodEpisodio
		left join parametros..puestosfisioterapia agendas	On  agendas.CodAgenda = citas.CodAgenda
		left join parametros..Gimnasios gim					on  citas.CodGimnasio = gim.CodGimnasio
		left join parametros..CentrosSalud CS				on	CS.CodCentro = gim.CentroSalud
		left join PARAMETROS..PARAMETROSMEDICOS MED			on  FI.DNIMEdico=MED.DNIMedico
	
where	FI.CodPaciente  = @spvar_CodPaciente
		AND FI.CodEpisodio = @spvar_CodEpisodio
		AND  citas.Asiste=1  and citas.FechaLlegada IS NOT NULL and 
		CAST(citas.HoraInicial as DATE)>= CAST(@spvar_Fecha as DATE) 


---------------------
--  detalle FISIO profesional ok
---------------------
INSERT @tmpProfesionales
select	distinct
	MEd.nif as RUT,
	ltrim(rtrim(MEd.NomMedico))+' '+ltrim(rtrim(Med.Apell1))+' '+ltrim(rtrim(Med.Apell2)) as NombreCompleto,
    (select DescServicio from parametros..Servicios where Codigo = citas.CodServicio) as 'TipoProfesional',
    fi.codregistro as IdAtencion,
    citas.CodGimnasio as CodConsulta
from	
	HClinica.dbo.CitasFisioterapia citas
	inner join HClinica..Fisioterapia FI On				FI.CodRegistro = Citas.CodRegistro			
	inner join hclinica..pacientes p					on  FI.codPaciente=p.codPaciente
			
	left join Parametros..MutuasSalud MS on				citas.CodColectivo = MS.Codigo
	
	left join Ingresos..EpisodioHospitalizacion EH		On	EH.CodPaciente = FI.CodPaciente	And EH.CodEpisodio = FI.CodEpisodio
	left join consultas..Episodioconsultas EC			On	EC.CodPaciente = FI.CodPaciente	And EC.CodEpisodio = FI.CodEpisodio
			
	left join parametros..puestosfisioterapia agendas	On  agendas.CodAgenda = citas.CodAgenda

	left join parametros..Gimnasios gim					on  citas.CodGimnasio = gim.CodGimnasio
	left join parametros..CentrosSalud CS				on	CS.CodCentro = gim.CentroSalud
			
	left join PARAMETROS..PARAMETROSMEDICOS MED			on  FI.DNIMEdico=MED.DNIMedico
where	FI.CodPaciente  = @spvar_CodPaciente
		AND FI.CodEpisodio = @spvar_CodEpisodio
		AND  citas.Asiste=1  and citas.FechaLlegada IS NOT NULL and 
		CAST(citas.HoraInicial as DATE)>= CAST(@spvar_Fecha as DATE) 


	
	
	
--ACTIVIDADES
DECLARE @tmpActividades AS TABLE (IdActividad varchar(12), FechaRegistro DATETIME,Descripcion VARCHAR(max), IdAtencion integer, CodConsulta CHAR(6))
--PRESTACIONES SALUD
INSERT @tmpActividades
SELECT 
	'IdActividad' = PP.CodPrestacion,
	'FechaRegistro' = convert(CHAR(8), PP.FechaHoraRegistro,112) + ' ' + convert(CHAR(5), PP.FechaHoraRegistro,108),
	'Descripcion' = PS.Descripcion,
	'IdAtencion' =  '', --COALESCE(C1.IdAtencion,C2.IdAtencion,C3.IdAtencion) ,
	'CodConsulta' = '' -- COALESCE(C1.CodConsulta,C2.CodConsulta,C3.CodConsulta)	
FROM
	HClinica..PrestacionesPaciente PP
	INNER JOIN Parametros..PrestacionesSalud PS ON PS.CodPrestacion = PP.CodPrestacion
	--LEFT JOIN @tmpCitas C1 ON C1.IdAtencion=PP.IdCita AND PP.CodConsulta=C1.CodConsulta
	--LEFT JOIN @tmpCitas C2 ON C2.FechaCita=PP.FechaCita AND PP.CodConsulta=C2.CodConsulta
	--LEFT JOIN @tmpCitas C3 ON DateAdd(day,datediff(day,0, C3.FechaCita), 0) = DateAdd(day,datediff(day,0, PP.FechaHoraRegistro), 0) -- AND PP.CodConsulta=C3.CodConsulta
WHERE
	PP.CodPaciente = @spvar_CodPaciente	AND PP.CodEpisodio = @spvar_CodEpisodio

UNION	
--PRESTACIONES SALUD AUGE
SELECT
		'IdActividad' = PP.CodPrestacion,
		'FechaRegistro' = convert(CHAR(8), PP.FechaHoraRegistro,112) + ' ' + convert(CHAR(5), PP.FechaHoraRegistro,108),
		'Descripcion' = PSA.Descripcion,
		'IdAtencion' = '', --COALESCE(C1.IdAtencion,C2.IdAtencion,C3.IdAtencion),
		'CodConsulta' = '' --COALESCE(C1.CodConsulta,C2.CodConsulta,C3.CodConsulta)		
FROM
		HClinica..PrestacionesPaciente PP
		INNER JOIN Parametros..PrestacionesSaludAUGE PSA ON PSA.CodPrestacion = PP.CodPrestacion	
		--LEFT JOIN @tmpCitas C1 ON C1.IdAtencion =PP.IdCita AND PP.CodConsulta=C1.CodConsulta
		--LEFT JOIN @tmpCitas C2 ON C2.FechaCita=PP.FechaCita AND PP.CodConsulta=C2.CodConsulta
		--LEFT JOIN @tmpCitas C3 ON DateAdd(day,datediff(day,0, C3.FechaCita), 0) = DateAdd(day,datediff(day,0, PP.FechaHoraRegistro), 0) -- AND PP.CodConsulta=C3.CodConsulta	
WHERE
		PP.CodPaciente = @spvar_CodPaciente AND PP.CodEpisodio = @spvar_CodEpisodio
UNION
--CURAS Y PROCEDIMIENTOS
SELECT	
	'IdActividad' =PC.CodCura,
	'FechaRegistro' = convert(CHAR(8), PC.F_Consulta,112)  + ' ' +  convert(CHAR(5), PC.F_Consulta,108),	
	'Descripcion' = CU.Descripcion,
	'IdAtencion' = '', --COALESCE(C1.IdAtencion,C2.IdAtencion,C3.IdAtencion),
	'CodConsulta' =''  --COALESCE(C1.CodConsulta,C2.CodConsulta,C3.CodConsulta)
FROM
	Hclinica..ProcedimientosCitas PC
	--LEFT JOIN @tmpCitas C1 ON C1.IdAtencion=PC.IdCita AND PC.CodConsulta=C1.CodConsulta
	--LEFT JOIN @tmpCitas C2 ON C2.FechaCita=PC.FechaCita AND PC.CodConsulta=C2.CodConsulta
	--LEFT JOIN @tmpCitas C3 ON DateAdd(day,datediff(day,0, C3.FechaCita), 0) = DateAdd(day,datediff(day,0, PC.F_Consulta), 0) -- AND PC.CodConsulta=C3.CodConsulta	
	INNER JOIN Parametros..Curas CU ON CU.CodCura = PC.CodCura		
WHERE
	PC.CodPaciente = @spvar_CodPaciente AND PC.CodEpisodio = @spvar_CodEpisodio

--RECETAS
DECLARE @tmpRecetas AS TABLE (IdReceta integer, Fecha DATETIME,TipoReceta VARCHAR(250),Estado VARCHAR(20), IdAtencion integer, CodConsulta CHAR(6))
INSERT @tmpRecetas
SELECT 
	'IdReceta' = R.IDRecetaTratamiento,
	'FechaGeneracion' = T.FecConsulta,
	'TipoReceta' = TR.Descripcion,
	'Estado' = 'Entregada',
	'IdAtencion'= '', --C.IdAtencion,
	'CodConsulta' = '' -- C.CodConsulta
FROM	
	Consultas..Tratamiento T
	INNER JOIN Consultas..RecetaTratamientoMed R ON T.IdRecetaTratamiento=R.IDRecetaTratamiento
	LEFT JOIN Parametros..TipoRecetaTrat TR ON R.codTipoReceta=TR.IDTipoRecetaTrat
	--INNER JOIN @tmpCitas C ON DateAdd(day,datediff(day,0, C.FechaCita), 0) = DateAdd(day,datediff(day,0, T.FecConsulta), 0)  --AND C.CodConsulta=T.CodConsulta
WHERE	
	T.CodPaciente=@spvar_CodPaciente AND T.CodEpisodio=@spvar_CodEpisodio	
UNION	--Recetas prolongadas
SELECT 
	'IdReceta' = R.IDRecetaTratamiento,
	'FechaGeneracion' = TR.FecConsulta, 
	'TipoReceta' = TRT.Descripcion,
	'Estado' = 'Entregada',
	'IdAtencion'= '', --C.IdAtencion,
	'CodConsulta' = '' --C.CodConsulta
FROM	
	Consultas..RecetaTratamientoMed R	
	INNER JOIN  Consultas..Tratamiento TR ON TR.IdRecetaTratamiento = R.idRecetaTratamiento 
	INNER JOIN  Consultas..RecetaTtoProlongada RT ON RT.idRecetaTratamiento = R.IDRecetaTratamiento 
	INNER JOIN  Consultas..RecetaTtoMedicamentoProlongada RMP ON RMP.idRecetaProlongada = RT.idRecetaTtoProlongada
	LEFT JOIN Parametros..TipoRecetaTrat TRT ON R.codTipoReceta=TRT.IDTipoRecetaTrat
	--INNER JOIN @tmpCitas C ON DateAdd(day,datediff(day,0, C.FechaCita), 0) = DateAdd(day,datediff(day,0, R.Fecha), 0)  --AND C.CodConsulta=T.CodConsulta
WHERE	
	R.CodPaciente=@spvar_CodPaciente AND TR.CodEpisodio=@spvar_CodEpisodio AND TR.Receta=1

--PRESCRIPCIONES
DECLARE @tmpPrescripciones TABLE (IdPrescripcion INT, DescripcionPrescripcion VARCHAR(max),Entregado VARCHAR(10),FechaRegistro DATETIME,IdReceta INT)
INSERT @tmpPrescripciones
SELECT DISTINCT	
	IdPrescripcion=T.IdEspecialidad,
	DescripcionPrescripcion = (Case WHEN GC.NombreGuia IS NULL THEN RTRIM(CFE.DescEspecialidad) ELSE GC.NombreGuia END) + ': ' +
	(
		CASE When convert(INT,dosismed)=dosismed then convert(VARCHAR,dosismed) else convert(VARCHAR,convert(decimal(10,5),dosismed)) end +
		CASE isnull(DetalleDosis,'') WHEN '' THEN '' ELSE ' ' + RTRIM(DetalleDosis)  END +
		CASE WHEN T.DosisUnitaria=1 THEN ' Dosis única'
		ELSE
			CASE WHEN FrecDosis IS NOT NULL THEN			
				 ' C/' + RTRIM(CONVERT(VARCHAR,FrecDosis)) + ' ' + C1.Descripcion + ' durante ' + cast(T.TiempoTratam as varchar) + ' ' + codtmpTrat.Descripcion													
			ELSE
				' '	
			END
		END	
	),
	Entregado=isnull(convert(VARCHAR(10),D.Unidades),''),
	'FechaRegistro'=T.FecConsulta,
	'IdReceta' = T.idRecetaTratamientoMed	
FROM
	Consultas..HistTratamientoMedico T
LEFT JOIN
	Parametros..Codigos C1 ON T.UdTmpDosis=C1.Codigo AND C1.Tabla = 'EstTiempoDurac1'
LEFT JOIN  
	Parametros..Codigos codtmpTrat ON codtmpTrat.Tabla = 'EstTiempoDurac2' AND codtmpTrat.Codigo =T.UdTmpDuracion
INNER JOIN 
	Farmacias..REspecialidad CFRE ON CFRE.IdEspecialidad = T.IdEspecialidad AND (CFRE.Tipo = '1' OR CFRE.Tipo = '2')
INNER JOIN 
	Farmacias..GuiasCentro GC ON GC.idEspecialidad = CFRE.IdEspecialidad
INNER JOIN 
	Farmacias..Especialidad CFE ON CFRE.CodEspec=CFE.CodEspec 
								AND	CFE.Tipo=CFRE.Tipo 
								AND	CFE.FecBaja IS NULL 
								AND (CFRE.Tipo = '1' OR CFRE.Tipo = '2')
								AND (CFE.FecAlta=CFRE.FecAlta 
									OR (CFE.FecAlta IS NULL AND CFRE.FecAlta IS NULL) 
									AND CFRE.FecBaja = CFE.FecBaja 
									OR (CFRE.FecBaja IS NULL AND CFE.FecBaja IS NULL)
									)
LEFT JOIN Consultas..Dispensaciones D ON D.IdEspecialidad=T.IdEspecialidad AND T.CodEpisodio=D.CodEpisodio AND T.CodPaciente=D.CodPaciente AND T.FecConsulta=D.FecConsulta
INNER JOIN @tmpRecetas TR ON TR.IdReceta=T.idRecetaTratamientoMed
WHERE 
	T.CodPaciente = @spvar_CodPaciente AND
	T.CodEpisodio = @spvar_CodEpisodio	

UNION
SELECT DISTINCT
	IdPrescripcion=T.IdEspecialidad,
	DescripcionPrescripcion =  (Case WHEN GC.NombreGuia IS NULL THEN RTRIM(CFE.DescEspecialidad) ELSE GC.NombreGuia END) + ': ' +	
	(
		CASE When convert(INT,dosismed)=dosismed then convert(VARCHAR,dosismed) else convert(VARCHAR,convert(decimal(10,5),dosismed)) end +
		CASE isnull(DetalleDosis,'') WHEN '' THEN '' ELSE ' ' + RTRIM(DetalleDosis)  END +
		CASE WHEN T.DosisUnitaria=1 THEN ' Dosis única'
		ELSE
			CASE WHEN FrecDosis IS NOT NULL THEN			
				 ' C/' + RTRIM(CONVERT(VARCHAR,FrecDosis)) + ' ' + C1.Descripcion + ' durante ' + cast(T.TiempoTratam as varchar) + ' ' + codtmpTrat.Descripcion									
			ELSE
				' '	
			END
		END		
	),	
	Entregado=isnull(convert(VARCHAR(10),D.Unidades),''),
	'FechaRegistro'= T.FecConsulta,
	'IdReceta'=T.idRecetaTratamientoMed	
FROM
	Consultas..TratamientoMedico T
LEFT JOIN
	Parametros..Codigos C1 ON T.UdTmpDosis=C1.Codigo AND C1.Tabla = 'EstTiempoDurac1'
LEFT JOIN  
	Parametros..Codigos codtmpTrat ON codtmpTrat.Tabla = 'EstTiempoDurac2' AND codtmpTrat.Codigo =T.UdTmpDuracion
INNER JOIN 
	Farmacias..REspecialidad CFRE ON CFRE.IdEspecialidad = T.IdEspecialidad AND (CFRE.Tipo = '1' OR CFRE.Tipo = '2')
INNER JOIN 
	Farmacias..GuiasCentro GC ON GC.idEspecialidad = CFRE.IdEspecialidad
INNER JOIN 
	Farmacias..Especialidad CFE ON CFRE.CodEspec=CFE.CodEspec 
								AND	CFE.Tipo=CFRE.Tipo 
								AND	CFE.FecBaja IS NULL 
								AND (CFRE.Tipo = '1' OR CFRE.Tipo = '2')
								AND (CFE.FecAlta=CFRE.FecAlta 
									OR (CFE.FecAlta IS NULL AND CFRE.FecAlta IS NULL) 
									AND CFRE.FecBaja = CFE.FecBaja 
									OR (CFRE.FecBaja IS NULL AND CFE.FecBaja IS NULL)
									)
LEFT JOIN Consultas..Dispensaciones D ON D.IdEspecialidad=T.IdEspecialidad AND T.CodEpisodio=D.CodEpisodio AND T.CodPaciente=D.CodPaciente AND T.FecConsulta=D.FecConsulta
INNER JOIN @tmpRecetas TR ON TR.IdReceta=T.idRecetaTratamientoMed
WHERE 
	T.CodPaciente = @spvar_CodPaciente AND
	T.CodEpisodio = @spvar_CodEpisodio		
UNION
SELECT distinct 
	IdPrescripcion=RMP.IDEspecialidad,			
	DescripcionPrescripcion = (Case WHEN GC.NombreGuia IS NULL THEN RTRIM(CFE.DescEspecialidad) ELSE GC.NombreGuia END) + ': ' +
	(
	cast(RMP.unidadesDosis  as varchar) + ' ' + RMP.detalleDosis + 	
	CASE WHEN RMP.frecuenciaDosis IS NOT NULL THEN			
			' C/' + cast(RMP.frecuenciaDosis as varchar) + ' ' + codFrec.Descripcion + ' durante ' + cast(RMP.diasTotal as varchar) + ' ' + codtmpTrat.Descripcion					
	ELSE
			' '	
	END		
	),
	Entregado=isnull(convert(VARCHAR(10),D.Unidades),''),
	'FechaRegistro'= TR.FecConsulta,
	'IdReceta'=T.IDRecetaTratamiento	
FROM Consultas..RecetaTratamientoMed T
	INNER JOIN Consultas..Tratamiento TR ON TR.IdRecetaTratamiento = T.idRecetaTratamiento 
	INNER JOIN Consultas..RecetaTtoProlongada RT ON RT.idRecetaTratamiento = T.IDRecetaTratamiento 
	INNER JOIN Consultas..RecetaTtoMedicamentoProlongada RMP ON RMP.idRecetaProlongada = RT.idRecetaTtoProlongada
	INNER JOIN Farmacias..REspecialidad CFRE ON CFRE.IdEspecialidad  = RMP.IdEspecialidad
	LEFT JOIN  Parametros..Codigos codFrec ON codFrec.Tabla = 'EstTiempoDurac1' and codFrec.Codigo =RMP.UdTmpDosis
	LEFT JOIN  Parametros..Codigos codtmpTrat ON codtmpTrat.Tabla = 'EstTiempoDurac2' and codtmpTrat.Codigo =RMP.UdTmpDuracion
	INNER JOIN Farmacias..Especialidad CFE ON CFE.CodEspec = CFRE.CodEspec	
	LEFT JOIN  Consultas..Dispensaciones D ON D.IdEspecialidad=RMP.idEspecialidad AND TR.CodEpisodio=D.CodEpisodio AND TR.CodPaciente=D.CodPaciente AND TR.FecConsulta=D.FecConsulta
	INNER JOIN Farmacias..GuiasCentro GC ON GC.idEspecialidad = CFRE.IdEspecialidad
	INNER JOIN @tmpRecetas TMPR ON TMPR.IdReceta=T.idRecetaTratamiento	
WHERE	
	T.CodPaciente= @Spvar_CodPaciente AND
	TR.CodEpisodio=@spvar_CodEpisodio

--PRUEBAS	
DECLARE @tmpRegistros TABLE 
(	TipoPrueba char(1),
	CodRegistro VARCHAR(15),
	FechaHora SMALLDATETIME,
	FechaHoraRegistro CHAR(14), 
	Resultados VARCHAR(max), 
	IdAtencion integer, 
	CodConsulta CHAR(6),
	ObservacionExamen varchar(max))

	
DECLARE @tmpPruebas TABLE 
(	FechaHora SMALLDATETIME,
    CodigoExamen VARCHAR(21),
	DescripcionExamen VARCHAR(max),
	EstadoExamen VARCHAR(25), 
	Resultado varchar(255),	
	CodRegistro VARCHAR(50),
	CodigoPrueba char(21),
	DescPrueba varchar(max),
	ObservacionPrueba varchar(max),
	Unidades varchar(16),
	ValorMinimo varchar(100),
	ValorMaximo varchar(100))

Declare @tmpEstadosPrueba AS TABLE (
	IdEstado integer,
	Estado VARCHAR(30)
)
INSERT into @tmpEstadosPrueba values 
	(0,'Pendiente de llegada'),
	(1,'En espera'),
	(2,'En proceso'),
	(3,'Pendiente de informar'),
	(4,'Borrador'),
	(5,'Informe firmado'),
	(6,'Pendiente de realizar'),
	(7,'Realizada sin firmar'),
	(8,'Anulada'),
	(9,'Ficticio'),
	(10,'Pasiva')

--Insertamos las solicitudes de todos los tipos de pruebas
INSERT INTO @tmpRegistros
SELECT
	'R',
	IR.CodRegistro, 
	IR.F_Solicitud,
	convert(CHAR(8), IR.F_Solicitud,112) + ' ' + convert(CHAR(5), IR.F_Solicitud,108), 
	IR.Informe, 
	'IdAtencion'='', --C.IdAtencion
	'CodConsulta'='', --C.CodConsulta
	IR.Juicio_Clinico_V
FROM  
	HClinica..InformeRadiologico IR
	--INNER JOIN @tmpCitas C ON (DateAdd(day,datediff(day,0, C.FechaCita), 0) = DateAdd(day,datediff(day,0, IR.F_Solicitud), 0))
WHERE 
	IR.CodPaciente = @spvar_CodPaciente	AND IR.CodEpisodio = @spvar_CodEpisodio		
UNION
SELECT
	'L',
	SL.CodRegistro, 
	SL.FSolicitud,
	convert(CHAR(8), SL.FSolicitud,112) + ' ' + convert(CHAR(5), SL.FSolicitud,108), 
	SL.ResumenAnalisis, 
	'IdAtencion'='', --C.IdAtencion
	'CodConsulta'='', --C.CodConsulta
	JuicioClinico
FROM 
	HClinica..solicitudeslaboratorio SL
	--INNER JOIN @tmpCitas C ON (DateAdd(day,datediff(day,0, C.FechaCita), 0) = DateAdd(day,datediff(day,0, SL.FSolicitud), 0))
WHERE 
	SL.CodPaciente = @spvar_CodPaciente	AND SL.CodEpisodio = @spvar_CodEpisodio	
UNION
SELECT
	'E',
	IE.CodRegistro, 
	IE.FechaSolicitud,
	convert(CHAR(8), IE.FechaSolicitud,112) + ' ' + convert(CHAR(5), IE.FechaSolicitud,108)	, 
	IE.DescResultados, 
	'IdAtencion'='', --C.IdAtencion
	'CodConsulta'='', --C.CodConsulta
	DescDiagPrev
FROM
	HClinica..InformeEndoscopia IE	
	--INNER JOIN @tmpCitas C ON (DateAdd(day,datediff(day,0, C.FechaCita), 0) = DateAdd(day,datediff(day,0, IE.FechaSolicitud), 0))
WHERE
	IE.CodPaciente = @spvar_CodPaciente	AND IE.CodEpisodio = @spvar_CodEpisodio	
UNION
SELECT
	'O',
	IC.CodRegistro, 
	IC.FecSolic,
	convert(CHAR(8), IC.FecSolic,112) + ' ' + convert(CHAR(5), 	IC.FecSolic,108), 
	CAST(IC.ValoracionPrueba AS VARCHAR(250)), 
	'IdAtencion'='', --C.IdAtencion
	'CodConsulta'='', --C.CodConsulta
	JuicioClinico
FROM
	HClinica..InformesComp IC	
	--INNER JOIN @tmpCitas C ON (DateAdd(day,datediff(day,0, C.FechaCita), 0) = DateAdd(day,datediff(day,0, IC.FecSolic), 0))
WHERE 
	IC.CodPaciente = @spvar_CodPaciente AND IC.CodEpisodio = @spvar_CodEpisodio
UNION
SELECT
	'A',
	AP.CodRegistro, 
	AP.FechaSolicitud,
	convert(CHAR(8), AP.FechaSolicitud,112) + ' ' + convert(CHAR(5),AP.FechaSolicitud,108), 
	CASE WHEN AP.CodRegistro like '%CG%' or AP.CodRegistro like '%PG%' THEN CI.DescConsejos 
		 ELSE AP.DatosMicro 
	END As Resultado, 
	'IdAtencion'='', --C.IdAtencion
	'CodConsulta'='', --C.CodConsulta
	DatosMuestra
FROM
	HClinica..AnatomiaPatologica AP	
	--INNER JOIN @tmpCitas C ON (DateAdd(day,datediff(day,0, C.FechaCita), 0) = DateAdd(day,datediff(day,0,AP.FechaSolicitud), 0))
	LEFT JOIN Hclinica..Citologia CI On AP.CodRegistro = CI.CodRegistro
WHERE
	AP.CodPaciente = @spvar_CodPaciente	AND AP.CodEpisodio = @spvar_CodEpisodio
	

--Pruebas radiologicas
INSERT INTO @tmpPruebas 
SELECT 	
    'FechaHora' = IR.FechaHora,
	'CodigoExamen' = DX.Cod_Examen,	
	'DescripcionExamen' = DX.Examen,
	'EstadoExamen' = TE.Estado,	
	'Resultado' = IR.Resultados,		
	'CodRegistro' = PR.CodInforme,
	'CodigoPrueba' = DX.Cod_Examen,
	'DescPrueba' = DX.Examen,
	'ObservacionPrueba'=PR.Observaciones,
	'Unidades' ='',
	'ValorMinimo' = '',
	'ValorMaximo'=''
FROM 
	@tmpRegistros IR
	INNER JOIN HClinica..PruebasRadiologicas PR ON IR.CodRegistro = PR.CodInforme
	INNER JOIN Parametros..DictamenesX DX ON DX.Cod_Examen = PR.CodPrueba
	LEFT JOIN @tmpEstadosPrueba TE ON TE.IdEstado=PR.Estado	
UNION
--Pruebas laboratorio
SELECT	
    'FechaHora' = SL.FechaHora,	   
	'CodigoExamen' = ISNULL(Per.CodPerfil,'SIN GRUPO'),
	'DescripcionExamen' = ISNULL(Per.DesPerfil,'SIN GRUPO'),
	'EstadoExamen' = CASE WHEN DL.FRealizacion IS NULL THEN 'Pendiente de informar' ELSE 'Realizada' END ,	
	'Resultado' = DL.Resultado,	
	'CodRegistro' = SL.CodRegistro,
	'CodigoPrueba' = PL.CodPrueba,
	'DescPrueba' = PL.DesPrueba,
	'ObservacionPrueba'= ISNULL(DL.Comentario,''),
	'Unidades' =CASE WHEN Unidades='0' Then '' ELSE Unidades END,
	'ValorMinimo' = DL.ValorInf,
	'ValorMaximo'=DL.ValorSup
FROM
	@tmpRegistros SL
	INNER JOIN HClinica..determinacionlaboratorio DL ON SL.CodRegistro= DL.CodRegistro	
	INNER JOIN Parametros..PruebasLab PL ON PL.CodPrueba = DL.CodPrueba	
	LEFT JOIN Parametros..PerfilesLab Per ON Per.CodPerfil = DL.CodPerfil	
UNION
--Pruebas de endoscopia
SELECT	
    'FechaHora' = R.FechaHora,
	'CodigoExamen' = DX.Cod_Examen,
	'DescripcionExamen' = DX.Examen,
	'EstadoExamen' = TE.Estado,
	'Resultado' = R.Resultados,		
	'CodRegistro' = IE.CodRegistro,
	'CodigoPrueba' = DX.Cod_Examen,
	'DescPrueba' = DX.Examen,
	'ObservacionPrueba'=IE.DescObserv,
	'Unidades' ='',
	'ValorMinimo' = '',
	'ValorMaximo'=''		
FROM
	@tmpRegistros R
	INNER JOIN Hclinica..InformeEndoscopia IE ON IE.CodRegistro=R.CodRegistro AND IE.CodPaciente=@spvar_CodPaciente AND IE.CodEpisodio=@spvar_CodEpisodio
	INNER JOIN Parametros..DictamenesX DX ON DX.Cod_Examen = IE.CodPrueba
	LEFT JOIN @tmpEstadosPrueba TE ON TE.IdEstado=ISNULL(IE.Estado,3)	
UNION
--Otras Pruebas
SELECT	
    'FechaHora' = IC.FechaHora,
	'CodigoExamen'= DX.Cod_Examen,
	'DescripcionExamen'= DX.Examen,
	'EstadoExamen'= TE.Estado,
	'Resultado' = IC.Resultados,	
	'CodRegistro' = IC.CodRegistro,
	'CodigoPrueba' = DX.Cod_Examen,
	'DescPrueba' = DX.Examen,
	'ObservacionPrueba'=''	,
	'Unidades' ='',
	'ValorMinimo' = '',
	'ValorMaximo'=''
FROM
	@tmpRegistros IC
	INNER JOIN Hclinica..InformesComp I ON IC.CodRegistro=I.CodRegistro AND I.CodPaciente=@spvar_CodPaciente AND I.CodEpisodio=@spvar_CodEpisodio
	INNER JOIN Parametros..DictamenesX DX ON DX.Cod_Examen = I.CodPrueba
	LEFT JOIN @tmpestadosprueba TE on TE.IdEstado= CASE	WHEN F_Recepcion IS NULL THEN 6
													    WHEN F_Recepcion IS NOT NULL AND FecRealiz IS NULL THEN 7 
														WHEN F_Recepcion IS NOT NULL AND FecRealiz IS NOT NULL AND Firmado = 0 THEN 3 
														WHEN Firmado = 1 THEN 5
														ELSE 2 
													END	
UNION
--Anatomia Patológica
SELECT	
    'FechaHora' = AP.FechaHora,
	'CodigoExamen'= NM.CodigoSNOMED,
	'DescripcionExamen'=NM.Caracteristicas,
	'EstadoExamen' = TE.Estado,
	'Resultado' = AP.Resultados,	
	'CodRegistro' = AP.CodRegistro,
	'CodigoPrueba' = NM.CodigoSNOMED,
	'DescPrueba' = NM.Caracteristicas,
	'ObservacionPrueba'= CASE WHEN AP.CodRegistro like '%CG%' or AP.CodRegistro like '%PG%' THEN CI.DescInfecciones ELSE A.Obs END,
	'Unidades' ='',
	'ValorMinimo' = '',
	'ValorMaximo'=''
FROM
	@tmpRegistros AP
	INNER JOIN Hclinica..AnatomiaPatologica A ON AP.CodRegistro=A.CodRegistro AND A.CodPaciente=@spvar_CodPaciente AND A.CodEpisodio=@spvar_CodEpisodio
	INNER JOIN Parametros..SNOMED NM ON NM.CodigoSNOMED = A.CodProc	
	LEFT JOIN Hclinica..Citologia CI on CI.CodRegistro = AP.CodRegistro
	LEFT JOIN @tmpEstadosPrueba TE ON TE.IdEstado=A.Estado	
	
--Si existe algún registro que no casa con ninguna cita en el episodio creamos la cita ficticia y englobamos en ella todos los registros no enlazados con alguna cita


IF (SELECT COUNT(*) FROM (SELECT IdAtencion,'Tipo'='Actividad' FROM @tmpActividades  UNION all SELECT IdAtencion,'Tipo'='Receta' FROM @tmpRecetas  UNION all SELECT IdAtencion,'Tipo'='Registro' FROM @tmpRegistros) T WHERE T.IdAtencion IS NULL)>0
BEGIN
	INSERT @tmpCitas --Insertamos la cita ficticia a partir de una existente
	SELECT TOP 1
				@spvar_FechaEpisodio, 
				0, --IdAtencion
				CodigoDEISEstablecimiento,
				DescripcionEstablecimiento,
				CodigoDEISEspecialidad,
				DescripcionEspecialidad,
				'REGISTROS REALIZADOS FUERA DE ATENCIÓN',
				convert(CHAR(8), @spvar_FechaEpisodio,112) + ' ' + convert(CHAR(5), @spvar_FechaEpisodio,108),
				'ASISTE',
				PrevisionPaciente,
				@spvar_FechaEpisodio,
				'',
				IdEpisodio,
				'000000', --CodConsulta		
				''
	FROM @tmpCitas		
	--Actualizamos los registros con la nueva cita
	UPDATE @tmpActividades SET IdAtencion=0,CodConsulta='000000' WHERE IdAtencion IS NULL
	UPDATE @tmpRecetas SET IdAtencion=0,CodConsulta='000000' WHERE IdAtencion IS NULL 
	UPDATE @tmpRegistros SET IdAtencion=0,CodConsulta='000000' WHERE IdAtencion IS NULL 
END

--Mostramos resultados
--Citas
SELECT 
	FechaHora,
	IdAtencion,
	CodigoDEISEstablecimiento,
	DescripcionEstablecimiento,
	CodigoDEISEspecialidad,
	DescripcionEspecialidad,
	TipoAtencion,
	FechaHoraInicio,
	EstadoAtencion,
	PrevisionPaciente,
	IdEpisodio,
	CodConsulta
FROM 
	@tmpCitas
	
	
--Profesionales
SELECT * FROM @tmpProfesionales

--Actividades
SELECT * FROM @tmpActividades

--Recetas
SELECT * FROM @tmpRecetas TR1 


--Prescripciones
SELECT * FROM @tmpPrescripciones


--Registros
SELECT 'FechaHora'=FechaHora,'IdOrdenExamen'= CodRegistro,IdAtencion,CodConsulta FROM @tmpRegistros Tr1
GROUP BY FechaHora,CodRegistro,IdAtencion,CodConsulta 


--Pruebas a mostrar
SELECT 
    'FechaHora'= TR.FechaHora,
	'CodigoExamen' = TP.CodigoExamen,	
	'DescripcionExamen' = TP.DescripcionExamen,		
	'EstadoExamen'=ISNULL(TP.EstadoExamen,''),	
	'Observacion'= ISNULL(TR.ObservacionExamen,''),	
	'IdOrdenExamen' = TP.CodRegistro	
FROM 
	@tmpPruebas TP		
	INNER JOIN @tmpregistros TR ON TP.CodRegistro=TR.CodRegistro
GROUP BY TR.FechaHora,CodigoExamen,DescripcionExamen,TP.EstadoExamen,TR.ObservacionExamen,TP.CodRegistro
ORDER BY TP.CodRegistro,TP.DescripcionExamen

--RESULTADOS DE EXAMEN
--====================
SELECT 
    'FechaHora'= TR.FechaHora,
	'CodigoResultado' = TP.CodigoPrueba,	
	'DescripcionResultado' = TP.DescPrueba,
	'ValorResultado' = ISNULL(TP.Resultado,''),	
	'UnidadMedida'= ISNULL(TP.Unidades,''),
	'ValorMinimo'= TP.ValorMinimo,
	'ValorMaximo' = TP.ValorMaximo	,
	'Observacion' =TP.ObservacionPrueba,
	'CodigoExamen'= TP.CodigoExamen,	
	'idOrdenExamen'= TP.CodRegistro 
FROM 
	@tmppruebas TP		
	INNER JOIN @tmpregistros TR ON TP.CodRegistro=TR.CodRegistro

ORDER BY TP.CodRegistro,TP.DescPrueba


--FIN PRUEBAS	

END


GO



--dbo.SpConSPropuestasCCEEFechas1.sql

USE [Consultas]
GO

/****** Object:  StoredProcedure [dbo].[SpConSPropuestasCCEEFechas1]    Script Date: 11/11/2013 13:00:20 ******/
IF EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[SpConSPropuestasCCEEFechas1]') AND type in (N'P', N'PC'))
DROP PROCEDURE [dbo].[SpConSPropuestasCCEEFechas1]
GO

/****** Object:  StoredProcedure [dbo].[SpConSPropuestasCCEEFechas1]    Script Date: 11/11/2013 13:00:20 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

/*
***********************************************************************
PROCEDIMIENTO : SpConSPropuestasCCEEFechas1
FUNCION		  : Busca las propuestas de consultas externas 
				filtrando por CodHistoria, Tarjeta Sanitaria y las opciones de citación
DEVUELVE	  : 
FECHA		  : 08/08/2008
VERSION		  : 1.0
AUTOR		  : Jesús Mañogil (Mecemsa)
***********************************************************************
MODIFICACIÓN  : (13/05/2009) Ramon. Obtengo la prioridad para las comprobaciones de las citas
MODIFICACIÓN  : (14/08/2009) Ismael. Nuevos campos FechaPrevista y TieneGuia
MODIFICACIÓN  : (21/08/2009) Ismael. Nuevos filtros por FechaPrevista y TieneGuia
MODIFICACIÓN  : (25/08/2009) Sonia Mateo. Devuelvo el campo DescMotivoPasiva de las propuestas pasivas
MODIFICACIÓN  : (02/09/2009) Ismael. Devuelvo el campo CodColectivo
MODIFICACIÓN  : (23/10/2009) Ismael. Incluyo la Aseguradora-Convenio
MODIFICACIÓN  : (30/11/2009) Ismael. Corrijo la Aseguradora-Conveni.
MODIFICACIÓN  : (30/11/2009) Paco Aznar. Se devuelven los campos hospital referencia y descripcion del centro destino
MODIFICACIÓN  : (12/03/2010) Paco Aznar. Se filtran propuestas reservadas y confirmadas y se devuelven más campos
MODIFICACIÓN  : (31/03/2010) Paco Aznar. Se devuelve el SIP
MODIFICACIÓN  : (13/04/2010) Paco Aznar. Se filtran las propuestas comunicadas y sin comunicar y se devuelve el campo de comunicada
MODIFICACIÓN  : (15/04/2010) Ramón Jiménez. Se devuelve la Unidad
MODIFICACIÓN  : (14/09/2010) Paco Aznar. Se filtra por dniMedicoOrigen y por LibreEleccion
MODIFICACIÓN  : (15/11/2010) Paco Aznar. Se devuelve el campo codigoRyF
MODIFICACIÓN  : (23/08/2011) A. Zaragoza. Funcionalidad fechas
MODIFICACIÓN  : (25/08/2011) Carlos H. Camacho. Se devuelve el centro de origen
MODIFICACIÓN  : (18/10/2011) Carlos H Camacho. Añadimos condición para número máximo de filas
MODIFICACIÓN  : (20/10/2011) Jose Almela Pérez. Modificado el nombre de FechaCita por FechaCita____
MODIFICACIÓN  : (28/10/2011) Jose Almela Pérez. Añadido el Id sidra
MODIFICACIÖN  : (13/12/2011) Adrián Puchades Olmos. Devuelvo la fecha de nacimiento del paciente
MODIFICACIÓN  : (28/02/2012) Alfredo Samper. CHC1236 - v4.28 - Se devuelven nuevos campos
MODIFICACIÓN  : (03/07/2012) César Moreno. CHC-1895 - v4.30 - Devolvemos el estado, por si tiene volor "e", indica egresada
MODIFICACIÓN  : (28/08/2012) Alberto Pagán CHC1921 - v4.32 - nueva columna Unidad en DataGrid
MODIFICACIÓN  : (22/11/2012) Enrique Sánchez - CHC2360 - Normalizacion del código de historia papel
MODIFICACIÓN  : (09/03/2013) Enrique Sánchez - CHC2871 - v4.38.2 - Se recupera el teléfono del paciente
MODIFICACIÓN  : (14/05/2013)  MAIPU CHC3029 V4.38 r7 FCB, Comunicar a SAP la confirmación de una reserva (de cita)
MODIFICACIÓN  : (26/07/2013) - Alfredo 4.40 CHC3061 - Añado el tiempo de espera
MODIFICACIÓN  : (30/10/2013) Enrique Sánchez - CHC2076 - Derivación SIC - v4.41 - Se recupera la columna DerivacionSIC
MODIFICACIÓN  : (11/11/2013) - MAIPU CHC3807 V4.40 R 16 FCB, Orden de Prioridad en la grilla del Gestor de lista de espera
MODIFICACION  : (20/03/2014) - CHC4019 - v4.42 - MAIPU REQ 46859 HEC_CORRECTIVO_PROBLEMA EN BUSQUEDAS POR FILTRO
MODIFICACIÓN  : (22/07/2014) - V4.46 - 1024 - ECR - Estado previo a confirmación de cita
MODIFICACIÓN  : (03/11/2014) - V4.48 - 1169 - VAS - Citas Espontaneas
MODIFICACIÓN  : (20/11/2014) - V4.48 - 1489 - VAS - Iconos estado SIC en Gestor Interconsultas
MODIFICACIÓN  : (20/11/2014) Alberto Pagán Benedicto - V4.49 - 1440 - APB - Segunda parte Derivación entre instancias
MODIFICACION  : (24/12/2014) - v4.49 - 1439 - RRG - Transversalidad del caso GES - REQ 55104
MODIFICACION  : (01/04/2015) - v4.49r2 - 2031 - ACT - Problemas con IC Duplicadas en Florence
MODIFICACION  :	(22/06/2015) v4.52 - 1899 - SGN - Problema distribución cupos florence
MODIFICACION  : (16/11/2015) - v4.55r1 - 2696 - CCM - Impresión Multiple SIC
MODIFICACION  : (01/12/2015) - v4.57 - 2724 - CCM - Incorporar folio SIGGES a una solicitud de interconsulta
MODIFICACION  : (24/12/2015) - v4.58 - 2760 - SGN - Agregar prioridad en Gestor Interconsultas
MODIFICACION  : (09/05/2017) - 17.2 - 16146 - SGH - Incluir Nombre Social del Paciente
MODIFICACION  : (19/05/2017) - 17.2 - 16506 - SGH - Filtros Prais Listados Sol. Interconsultas e Intervenciones
MODIFICACION  : (26/05/2017) - 17.2 - 16112 - SGH - Modificar reporte de gestor de interconsultas
MODIFICACION  : (23/08/2017) - v17.3 – 18451 – FCB - Ingresar observación al motivo de egreso en SIC
*/

CREATE PROCEDURE [dbo].[SpConSPropuestasCCEEFechas1]
	 @spvar_CodHistoria char(8) = null
	,@spvar_TSanitaria char(16) = null
	,@spvar_Citados bit = 0
	,@spvar_NoCitados bit = 0
	,@spvar_FecCita smalldatetime = null
	,@spvar_FecCitaDesde smalldatetime = null
	,@spvar_FecCitaHasta smalldatetime = null
	,@spvar_FechaPrevistaDesde smalldatetime = null
	,@spvar_FechaPrevistaHasta smalldatetime = null
	,@spvar_AUGE bit = null
	,@spvar_FecSolDesde smalldatetime = null
	,@spvar_FecSolHasta smalldatetime = null
	,@spvar_Reservadas bit = 0
	,@spvar_Confirmadas bit = 0
	,@spvar_Comunicadas bit = 0
	,@spvar_SinComunicar bit = 0
	,@spvar_LibreEleccion bit = null
	,@spvar_DniMedicoOrigen char(8) = null
	,@spvar_NumFilasCCEE int = null
	,@spvar_ConfAsistencia bit = 0 
	,@spvar_CitaEspontanea bit = 0 
AS

declare @CodPaciente char(16) 

--Aplicamos máximo de filas si este parámetro trae algún valor.
if @spvar_NumFilasCCEE is not null
	set rowcount @spvar_NumFilasCCEE

	if @spvar_CodHistoria is null
		select @CodPaciente = CodPaciente from Hclinica..Pacientes where NumTarjSanitaria = @spvar_TSanitaria
	else
		select @CodPaciente = CodPaciente from Hclinica..Pacientes where CodHistoria = @spvar_CodHistoria

	if @spvar_Reservadas = 1 or @spvar_Confirmadas = 1
	begin
	select	p.CodHistoria,
			p.CodPaciente,
			'PacNombre'= rtrim(p.PacNombre), 
			'PacApell1' = rtrim(p.PacApell1),
			'PacApell2' = rtrim(p.PacApell2),
			e.CodEpisodio,
			parametros.dbo.fnParFechaHoraUTC(e.FechaCPrimera) as FechaCPrimera____,
			c.ConfAsistencia, 
			parametros.dbo.fnParFechaHoraUTC(e.FechaConsulta) as FechaConsulta____,
			e.DictamenClinico as Juicio,
			e.CodCentroFinal,
			S.Codigo, 
			s.DescServicio ServicioDestino,
			case when e.DerivacionSIC = 1 then se1.DescServicio else s1.DescServicio end as ServicioRemite,		
			'0' as Pasiva,
			e.Solicitud, 
			parametros.dbo.fnParFechaHoraUTC(e.FechaPrevista) as FechaPrevista____,
			case
				when 
					isnull(
							e.IdGuiaClinica,
							(
								select MIN (I.CodProblema)
								from 	(
											SELECT 
												  ipd.CodPaciente
												, ipd.CodEpisodio
												, ipd.CodProblema
												, ipd.CodSubProblema
												, ipd.CodDiagnostico
												, ipd.IDInformeIPD					
											FROM HClinica..InformeIPD ipd 
											union
											select 
												  tcGES.CodPaciente
												, tcGES.CodEpisodio
												, ipd.CodProblema
												, ipd.CodSubProblema
												, ipd.CodDiagnostico
												, tcGES.IDInformeIPD	
											FROM Hclinica..TrazabilidadCasoGES tcges 
												inner join hclinica..informeipd ipd on tcges.idinformeipd=ipd.idinformeipd 
										) I 
										inner join Parametros..CIEDiagnostico CIEDiag on I.CodDiagnostico=CIEDiag.CodDiagnostico
								WHERE I.CodPaciente=e.CodPaciente
								  and I.CodEpisodio=e.CodEpisodio		
							)
						  ) is null then 0
				else 1
			end as TieneGuia,			
			'' as MotivoPasiva,
			e.CodColectivo,
			MP.Entidad + '-' + MS.Entidad  as Aseguradora,
			cs.HospitalRef,
			cs.DescCentro,
			c.NoDerecho,
			c.CodConsulta,
			c.CodTipoConsulta2 as CodTipoConsulta2,	
			parametros.dbo.fnParFechaHoraUTC(FechaCita) as FechaCita____,
			c.IdCita,
			c.CodTipoConsulta,			
			c.CodigoServicio,
			e.confirmada,
			p.NumTarjSanitaria,
			e.comunicada,
			e.IdUnidad,
			e.CodigoRYF,
			e.CodCentroOrigen,
			COALESCE(cs1.DescCentro,DOC.NomCentro) as DescCentroRef
			,'' as IdMotivo,
			p.FecNac,
			RIGHT('00000000' + LTRIM (RTRIM(AHP.CodHistoriaPapel)),8 ) as CodHistoriaPapel,
			p.Genero,
			'Sexo' = COD.Descripcion,
			'RUT Profesional' = e.DniMedDestino,
			'Profesional' = PM.NomMedico + ' ' + PM.Apell1 + ' ' + PM.Apell2,
			'Citador' = COALESCE(PMcita.NomMedico, DEcita.NombreEnf, Acita.NomAdminis) + ' ' +
						COALESCE(PMcita.Apell1, DEcita.Apell1Enf, Acita.Apell1Administ) + ' ' +
						COALESCE(PMcita.Apell2, DEcita.Apell2Enf, Acita.Apell2Administ),
			'TipoConsulta' = TC.DescTipoCons,
			'Prioridad' = COD2.Descripcion
			,e.Estado 
			,u.Descripcion as Unidad
			,p.DirTelf
			,'TiempoEspera' = DATEDIFF(DD, e.FechaConsulta, ISNULL(e.FechaInicial, GETDATE())) 
			,COD2.Posicion as OrdenPrioridad 
			,e.DerivacionSIC
			,c.Asiste as AsisteCita
			,c.CitaEspontanea 
			,c.HoraInicial as FechaInicial 
			,c.NoAtendido
			,null as FechaNoAtendida
			,e.NoAsistenciasCita
			, c.idOrigenCita 
			, O.DescOrigenCitas
			,p.Email
			,p.Direccion 
			,p.DirNum
			 ,p.CodPostal 
			 ,L.NomPoblacion  
			 ,p1.Nombre as Provincia
			,L.NomPoblacion as Localidad
			,p.telf2
			,isNull(p.TarjSanitariaResp,'') as RutTutor
			,IsNull(PMRemite.NomMedico , '') as NombreMedicoRemi
			,IsNull(PMRemite.Apell1 , '') as Apel1MedicoRemi
			,IsNull(PMRemite.Apell2 , '') as Apel2MEdicoRemi
			,IsNull(PMRemite.Nif , '') as RutMedicoRemi
			,I.DescDiagnostico
			,CI.DescDiagnostico as DescDiagnosProvi
			,e.inspecciones 
			,e.IDProblemaSalud
			,gc.DescGuia as descProblema
			,gc1.DescGuia as descSubProblema
			,isnull(PMcita.Nif,isnull(DEcita.Nif,isnull(TD.Nif,Acita.nif))) as Nif
			,e.IdCausaInterconsulta
			,e.DescCausaInterconsulta
			,e.comentarios
			,e.TipoRemision
			,e.motivo
			,e.FolioSigges
			,e.PrioridadHosp
			,Cod3.Posicion as OrdenPrioridadHosp
			,p.AtiendeAlNombre as NombreSocial
			,CASE WHEN 
			(
				EXISTS (select * from Hclinica..MutuasSaludSecPaciente MSSP 
				INNER JOIN parametros..MutuasSalud MS on MS.Codigo = MSSP.CodColectivo
				where codpaciente = e.CodPaciente and MS.EsPrais = 1)
			) THEN 1 ELSE 0 END AS EsPRAIS,
			CASE WHEN c.Asiste = 1 THEN 
			(
				SELECT 
				PMAten.NomMedico + ' ' + PMAten.Apell1 + ' ' + 	PMAten.Apell2 
				FROM  Parametros..ParametrosMedicos PMAten 
				WHERE PMAten.DNIMedico = c.NIFMedicoConsulta
			) ELSE '' END as ProfesionalAtiende,
			p.Telf3,
			p.TelfFijoUFamiliar 
			,e.RUNProfEgreso
			,e.NomProfEgreso
			,e.ObservacionEgreso 
			,e.FechaCierre		
	from	Consultas..EpisodioConsultas e with (nolock)
			inner join Hclinica..Pacientes p with (nolock) on p.codpaciente = e.codpaciente 
			left join Parametros..Servicios s with (nolock) on s.Codigo = e.CodServicioFinal
			left join Parametros..Servicios s1 with (nolock) on s1.Codigo = e.CodServicioOrigen
			left join Parametros..ServiciosExternos se1 with (nolock) on se1.Codigo = e.CodServicioOrigen
			left join Parametros..CentrosSalud cs with (nolock) on cs.CodCentro = e.CodCentroFinal
			left join Parametros..CentrosSalud cs1 with (nolock) on cs1.CodCentro = e.CodCentroOrigen 
			left join Parametros..DatosOtrosCentros DOC with (nolock) on DOC.CodCent = e.CodCentroOrigen
			left join Hclinica..Citas c with (nolock) on c.CodPaciente = e.CodPaciente and c.codepisodio = e.CodEpisodio and c.CodTipoConsulta = 0 
													AND ( (e.FechaCPrimera IS NULL AND c.FechaEntrada = (SELECT MAX(c1.FechaEntrada) FROM Hclinica..Citas c1 WHERE c.codpaciente = c1.codpaciente AND c.codepisodio = c1.CodEpisodio AND c1.CodTipoConsulta=0)) 
														OR e.FechaCPrimera = C.FechaCita) 
			left join Hclinica..ArchivoHistoriasPapel AHP on AHP.CodPaciente = P.CodPaciente and AHP.CodCentro = cs.CodCentro
			left join Parametros..Codigos COD on COD.Codigo = p.Genero and Tabla = 'EstGenero'
			left join Parametros..ParametrosMedicos PM on PM.DNIMedico = e.DniMedDestino
			left join Parametros..ParametrosMedicos PMcita on PMcita.DNIMedico = e.NIF
			left join Parametros..DatosEnfermeras DEcita on DEcita.DNIEnf = e.NIF
			left join Parametros..Administrativo Acita on Acita.DNIAdminist = e.NIF				
			left join Parametros..TiposConsultas TC on TC.CodTipoCons = c.CodTipoConsulta and TC.CodClaseCons = c.CodTipoConsulta2 and TC.CodServCons = S.Codigo
			left join Parametros..Codigos COD2 on COD2.Codigo = e.Solicitud and COD2.Tabla = 'EstTipoExamen'
			left join Parametros..Unidad u on e.IdUnidad = u.IdUnidad
			left join Parametros..OrigenesCitas O on c.idOrigenCita = O.idOrigenCita
			LEFT JOIN parametros..DireccionLocalidad L ON p.DirCodLocalidad = L.CodPoblacion and p.dircodprov = l.codprovincia 		    
			LEFT JOIN parametros..codprovincias p1 on p1.codigo = p.dircodprov
			left join Parametros..ParametrosMedicos PMRemite on PMRemite.DNIMedico = e.DNIMedEpi
			LEFT JOIN Parametros..CIEDiagnostico I on e.CodDiagnosticoProvisional = I.CodDiagnostico
			LEFT JOIN Parametros..CIEDiagnostico CI on e.CodDiagnosticoPrimero = CI.CodDiagnostico
			left join  Parametros..GuiasClinicas gc on  gc.CodGuia = e.IDProblemaSalud 
			left join  Parametros..GuiasClinicas gc1 on  gc1.CodGuia = e.CodSubProblema 
			LEFT JOIN Parametros..TecnicosDatos TD on TD.DNITecnico = e.NIF
			LEFT JOIN Parametros..Codigos Cod3 ON (e.PrioridadHosp = Cod3.Codigo and cod3.Tabla = 'EstTipoExamen')
			LEFT JOIN Parametros..MutuasSalud MS ON e.CodColectivo = MS.Codigo
			LEFT JOIN Parametros..MutuaPrincipal MP ON MS.CodMutua = MP.Codigo			
	where	p.codpaciente = @CodPaciente 
			and (@spvar_Citados = '0' or (@spvar_Citados = '1' and e.FechaCPrimera is not null))
			and (@spvar_NoCitados = '0' or (@spvar_NoCitados = '1' and e.FechaCPrimera is null))
			and (@spvar_FecCita is null or datediff(d, @spvar_FecCita, e.FechaCPrimera) = 0)
			and (@spvar_FecCitaDesde is null or datediff(d, @spvar_FecCitaDesde, e.FechaCPrimera) >= 0)
			and (@spvar_FecCitaHasta is null or datediff(d, @spvar_FecCitaHasta, e.FechaCPrimera) <= 0)
			and (@spvar_FechaPrevistaDesde is null or e.FechaPrevista >= @spvar_FechaPrevistaDesde)
			and (@spvar_FechaPrevistaHasta is null or e.FechaPrevista <= @spvar_FechaPrevistaHasta)
			and (@spvar_AUGE is null or e.IdGuiaClinica is not null)
			and (@spvar_FecSolDesde is null or datediff(d, @spvar_FecSolDesde, e.FechaConsulta) >= 0)
			and (@spvar_FecSolHasta is null or datediff(d, @spvar_FecSolHasta, e.FechaConsulta) <= 0)
			and (@spvar_Reservadas = '0' or (@spvar_Reservadas = '1' and e.FechaCPrimera = c.FechaCita and c.NoDerecho = 1 ))
			and (@spvar_Confirmadas = '0' or (@spvar_Confirmadas = '1' and e.FechaCPrimera = c.FechaCita and (c.NoDerecho = 0 or c.NoDerecho is null)))
			and (@spvar_Comunicadas = '0' or (@spvar_Comunicadas = '1' and e.comunicada is not null))
			and (@spvar_SinComunicar = '0' or (@spvar_SinComunicar = '1' and e.comunicada is null))
			and (@spvar_DniMedicoOrigen is null or e.DNIMedEpi = @spvar_DniMedicoOrigen)
			and (
				(@spvar_LibreEleccion is null and (e.LibreEleccion is null or e.LibreEleccion = 0)
				or
				(e.LibreEleccion = 1)))
			and (@spvar_ConfAsistencia = 0 or (@spvar_ConfAsistencia = 1 and c.ConfAsistencia = 1)) 
	end
else
	begin
	select	p.CodHistoria,
			p.CodPaciente,
			'PacNombre'= rtrim(p.PacNombre), 
			'PacApell1' = rtrim(p.PacApell1),
			'PacApell2' = rtrim(p.PacApell2),
			e.CodEpisodio,
			parametros.dbo.fnParFechaHoraUTC(FechaCPrimera) as FechaCPrimera____,
			c.ConfAsistencia, 
			parametros.dbo.fnParFechaHoraUTC(FechaConsulta) as FechaConsulta____,
			e.DictamenClinico as Juicio,
			e.CodCentroFinal,
			S.Codigo, 
			s.DescServicio ServicioDestino,
			case when e.DerivacionSIC = 1 then se1.DescServicio else s1.DescServicio end as ServicioRemite,		
			'0' as Pasiva,
			e.Solicitud,
			parametros.dbo.fnParFechaHoraUTC(FechaPrevista) as FechaPrevista____,
			case
				when 
					isnull(
							e.IdGuiaClinica,
							(
								select MIN (I.CodProblema)
								from 	(
											SELECT 
												  ipd.CodPaciente
												, ipd.CodEpisodio
												, ipd.CodProblema
												, ipd.CodSubProblema
												, ipd.CodDiagnostico
												, ipd.IDInformeIPD					
											FROM HClinica..InformeIPD ipd 
											union
											select 
												  tcGES.CodPaciente
												, tcGES.CodEpisodio
												, ipd.CodProblema
												, ipd.CodSubProblema
												, ipd.CodDiagnostico
												, tcGES.IDInformeIPD	
											FROM Hclinica..TrazabilidadCasoGES tcges 
												inner join hclinica..informeipd ipd on tcges.idinformeipd=ipd.idinformeipd 
										) I 
										inner join Parametros..CIEDiagnostico CIEDiag on I.CodDiagnostico=CIEDiag.CodDiagnostico
								WHERE I.CodPaciente=e.CodPaciente
								  and I.CodEpisodio=e.CodEpisodio		
							)
						  ) is null then 0
				else 1
			end as TieneGuia,				
			'' as MotivoPasiva,
			e.CodColectivo,
			MP.Entidad + '-' + MS.Entidad  as Aseguradora,
			cs.HospitalRef,
			cs.DescCentro,
			(select top 1 NoDerecho from
					Consultas..EpisodioConsultas ec with (nolock)
						left join Hclinica..Citas c  with (nolock)
							on c.CodPaciente = ec.CodPaciente
							and c.codepisodio = ec.CodEpisodio
					where
					c.FechaCita = ec.FechaCPrimera
					and ec.CodPaciente = @CodPaciente
					and ec.CodEpisodio = e.CodEpisodio)	as NoDerecho,
					
			(select top 1 CodConsulta from
					Consultas..EpisodioConsultas ec with (nolock)
						left join Hclinica..Citas c  with (nolock)
							on c.CodPaciente = ec.CodPaciente
							and c.codepisodio = ec.CodEpisodio
					where
					c.FechaCita = ec.FechaCPrimera
					and ec.CodPaciente = @CodPaciente
					and ec.CodEpisodio = e.CodEpisodio)	as CodConsulta,
			(select top 1
				parametros.dbo.fnParFechaHoraUTC(FechaCita) as FechaCita____
			from
					Consultas..EpisodioConsultas ec with (nolock)
						left join Hclinica..Citas c  with (nolock)
							on c.CodPaciente = ec.CodPaciente
							and c.codepisodio = ec.CodEpisodio
					where
					c.FechaCita = ec.FechaCPrimera
					and ec.CodPaciente = @CodPaciente
					and ec.CodEpisodio = e.CodEpisodio)	as FechaCita____,
			(select top 1 IdCita from
					Consultas..EpisodioConsultas ec with (nolock)
						left join Hclinica..Citas c  with (nolock)
							on c.CodPaciente = ec.CodPaciente
							and c.codepisodio = ec.CodEpisodio
					where
					c.FechaCita = ec.FechaCPrimera
					and ec.CodPaciente = @CodPaciente
					and ec.CodEpisodio = e.CodEpisodio)	as IdCita,
			(select top 1 CodTipoConsulta from
					Consultas..Episodioconsultas ec with (nolock)
						left join Hclinica..Citas c  with (nolock)
							on c.CodPaciente = ec.CodPaciente
							and c.codepisodio = ec.CodEpisodio
					where
					c.FechaCita = ec.FechaCPrimera
					and ec.CodPaciente = @CodPaciente
					and ec.CodEpisodio = e.CodEpisodio)	as CodTipoConsulta,
			(select top 1 c.CodigoServicio from
					Consultas..EpisodioConsultas ec with (nolock)
						left join Hclinica..Citas c  with (nolock)
							on c.CodPaciente = ec.CodPaciente
							and c.codepisodio = ec.CodEpisodio
					where
					c.FechaCita = ec.FechaCPrimera
					and ec.CodPaciente = @CodPaciente
					and ec.CodEpisodio = e.CodEpisodio)	as CodigoServicio,
			c.CodTipoConsulta2 as CodTipoConsulta2,	
			e.confirmada,
			p.NumTarjSanitaria,
			e.comunicada,
			e.IdUnidad,
			e.CodigoRYF,
			e.CodCentroOrigen,
			COALESCE(cs1.DescCentro,DOC.NomCentro) as DescCentroRef
			,'' as IdMotivo,
			p.FecNac,
			RIGHT('00000000' + LTRIM (RTRIM(AHP.CodHistoriaPapel)),8 ) as CodHistoriaPapel,
			p.Genero,
			'Sexo' = COD.Descripcion,
			'RUT Profesional' = e.DniMedDestino,
			'Profesional' = PM.NomMedico + ' ' + PM.Apell1 + ' ' + PM.Apell2,
			'Citador' = COALESCE(PMcita.NomMedico, DEcita.NombreEnf, Acita.NomAdminis) + ' ' +
						COALESCE(PMcita.Apell1, DEcita.Apell1Enf, Acita.Apell1Administ) + ' ' +
						COALESCE(PMcita.Apell2, DEcita.Apell2Enf, Acita.Apell2Administ),
			'TipoConsulta' = TC.DescTipoCons,
			'Prioridad' = COD2.Descripcion
			,e.Estado 						
			,u.Descripcion as Unidad
			,p.DirTelf
			,'TiempoEspera' = DATEDIFF(DD, e.FechaConsulta, ISNULL(e.FechaInicial, GETDATE())) 
			,COD2.Posicion as OrdenPrioridad 
			,e.DerivacionSIC
			,c.Asiste as AsisteCita
			,c.CitaEspontanea 
			,c.HoraInicial as FechaInicial 
			,c.NoAtendido
			,null as FechaNoAtendida
			,e.NoAsistenciasCita
			, c.idOrigenCita 
			, O.DescOrigenCitas
			,p.Email
			,p.Direccion 
			,p.DirNum
			 ,p.CodPostal 
			 ,L.NomPoblacion  
			 ,p1.Nombre as Provincia
			,L.NomPoblacion as Localidad
			,p.telf2
			,isNull(p.TarjSanitariaResp,'') as RutTutor
			,IsNull(PMRemite.NomMedico , '') as NombreMedicoRemi
			,IsNull(PMRemite.Apell1 , '') as Apel1MedicoRemi
			,IsNull(PMRemite.Apell2 , '') as Apel2MEdicoRemi
			,IsNull(PMRemite.Nif , '') as RutMedicoRemi
			,I.DescDiagnostico
			,CI.DescDiagnostico as DescDiagnosProvi
			,e.inspecciones 
			,e.IDProblemaSalud
			,gc.DescGuia as descProblema
			,gc1.DescGuia as descSubProblema
			,isnull(PMcita.Nif,isnull(DEcita.Nif,isnull(TD.Nif,Acita.nif))) as Nif
			,e.IdCausaInterconsulta
			,e.DescCausaInterconsulta
			,e.comentarios
			,e.TipoRemision
			,e.motivo
			,e.FolioSigges
			,e.PrioridadHosp
			,Cod3.Posicion as OrdenPrioridadHosp
			,p.AtiendeAlNombre as NombreSocial
			,CASE WHEN 
			(
				EXISTS (select * from Hclinica..MutuasSaludSecPaciente MSSP 
				INNER JOIN parametros..MutuasSalud MS on MS.Codigo = MSSP.CodColectivo
				where codpaciente = e.CodPaciente and MS.EsPrais = 1)
			) THEN 1 ELSE 0 END AS EsPRAIS,
			CASE WHEN c.Asiste = 1 THEN 
			(
				SELECT 
				PMAten.NomMedico + ' ' + PMAten.Apell1 + ' ' + 	PMAten.Apell2 
				FROM  Parametros..ParametrosMedicos PMAten 
				WHERE PMAten.DNIMedico = c.NIFMedicoConsulta
			) ELSE '' END as ProfesionalAtiende,
			p.Telf3,
			p.TelfFijoUFamiliar 
			,e.RUNProfEgreso
			,e.NomProfEgreso
			,e.ObservacionEgreso 
			,e.FechaCierre				
from	Consultas..EpisodioConsultas e with (nolock)
			inner join Hclinica..Pacientes p with (nolock) on p.codpaciente = e.codpaciente 
			left join Parametros..Servicios s with (nolock) on s.Codigo = e.CodServicioFinal
			left join Parametros..Servicios s1 with (nolock) on s1.Codigo = e.CodServicioOrigen
			left join Parametros..ServiciosExternos se1 with (nolock) on se1.Codigo = e.CodServicioOrigen
			left join Parametros..CentrosSalud cs with (nolock) on cs.CodCentro = e.CodCentroFinal
			left join Parametros..CentrosSalud cs1 with (nolock) on cs1.CodCentro = e.CodCentroOrigen	
			left join Parametros..DatosOtrosCentros DOC with (nolock) on DOC.CodCent = e.CodCentroOrigen
			left join Hclinica..Citas C on e.CodPaciente = c.CodPaciente and e.CodEpisodio = C.CodEpisodio and c.CodTipoConsulta = 0 
										AND ( (e.FechaCPrimera IS NULL AND c.FechaEntrada = (SELECT MAX(c1.FechaEntrada) FROM Hclinica..Citas c1 WHERE c.codpaciente = c1.codpaciente AND c.codepisodio = c1.CodEpisodio AND c1.CodTipoConsulta=0)) 
														OR e.FechaCPrimera = C.FechaCita) 
			left join Hclinica..ArchivoHistoriasPapel AHP on AHP.CodPaciente = P.CodPaciente and AHP.CodCentro = cs.CodCentro
			left join Parametros..Codigos COD on COD.Codigo = p.Genero and Tabla = 'EstGenero'
			left join Parametros..ParametrosMedicos PM on PM.DNIMedico = e.DniMedDestino
			left join Parametros..ParametrosMedicos PMcita on PMcita.DNIMedico = e.NIF
			left join Parametros..DatosEnfermeras DEcita on DEcita.DNIEnf = e.NIF
			left join Parametros..Administrativo Acita on Acita.DNIAdminist = e.NIF				
			left join Parametros..TiposConsultas TC on TC.CodTipoCons = c.CodTipoConsulta and TC.CodClaseCons = c.CodTipoConsulta2 and TC.CodServCons = S.Codigo
			left join Parametros..Codigos COD2 on COD2.Codigo = e.Solicitud and COD2.Tabla = 'EstTipoExamen'
			left join Parametros..Unidad u on e.IdUnidad = u.IdUnidad
			left join Parametros..OrigenesCitas O on c.idOrigenCita = O.idOrigenCita
			LEFT JOIN parametros..DireccionLocalidad L ON p.DirCodLocalidad = L.CodPoblacion and p.dircodprov = l.codprovincia 		    
			LEFT JOIN parametros..codprovincias p1 on p1.codigo = p.dircodprov
			left join Parametros..ParametrosMedicos PMRemite on PMRemite.DNIMedico = e.DNIMedEpi
			LEFT JOIN Parametros..CIEDiagnostico I on e.CodDiagnosticoProvisional = I.CodDiagnostico
			LEFT JOIN Parametros..CIEDiagnostico CI on e.CodDiagnosticoPrimero = CI.CodDiagnostico
			left join  Parametros..GuiasClinicas gc on  gc.CodGuia = e.IDProblemaSalud 
			left join  Parametros..GuiasClinicas gc1 on  gc1.CodGuia = e.CodSubProblema  
			LEFT JOIN Parametros..TecnicosDatos TD on TD.DNITecnico = e.NIF
			LEFT JOIN Parametros..Codigos Cod3 ON (e.PrioridadHosp = Cod3.Codigo and cod3.Tabla = 'EstTipoExamen')
			LEFT JOIN Parametros..MutuasSalud MS ON e.CodColectivo = MS.Codigo
			LEFT JOIN Parametros..MutuaPrincipal MP ON MS.CodMutua = MP.Codigo			
	where	p.codpaciente = @CodPaciente --v4.42 - MAIPU CHC4019
			and (@spvar_Citados = '0' or (@spvar_Citados = '1' and e.FechaCPrimera is not null))
			and (@spvar_NoCitados = '0' or (@spvar_NoCitados = '1' and e.FechaCPrimera is null))
			and (@spvar_FecCita is null or datediff(d, @spvar_FecCita, e.FechaCPrimera) = 0)
			and (@spvar_FecCitaDesde is null or datediff(d, @spvar_FecCitaDesde, e.FechaCPrimera) >= 0)
			and (@spvar_FecCitaHasta is null or datediff(d, @spvar_FecCitaHasta, e.FechaCPrimera) <= 0)
			and (@spvar_FechaPrevistaDesde is null or e.FechaPrevista >= @spvar_FechaPrevistaDesde)
			and (@spvar_FechaPrevistaHasta is null or e.FechaPrevista <= @spvar_FechaPrevistaHasta)
			and (@spvar_AUGE is null or e.IdGuiaClinica is not null)
			and (@spvar_FecSolDesde is null or datediff(d, @spvar_FecSolDesde, e.FechaConsulta) >= 0)
			and (@spvar_FecSolHasta is null or datediff(d, @spvar_FecSolHasta, e.FechaConsulta) <= 0)
			and (@spvar_Comunicadas = '0' or (@spvar_Comunicadas = '1' and e.comunicada is not null))
			and (@spvar_SinComunicar = '0' or (@spvar_SinComunicar = '1' and e.comunicada is null))
			and (@spvar_DniMedicoOrigen is null or e.DNIMedEpi = @spvar_DniMedicoOrigen)
			and (
				(@spvar_LibreEleccion is null and (e.LibreEleccion is null or e.LibreEleccion = 0)
				or
				(e.LibreEleccion = 1)))
			and (@spvar_ConfAsistencia = 0 or (@spvar_ConfAsistencia = 1 and C.ConfAsistencia = 1)) --V4.46 - 1024 - ECR
				
select @@ROWCOUNT

end

GO
GO



--dbo.SpConSPropuestasCCEEFechas2.sql

USE [Consultas]

GO
/****** Object:  StoredProcedure [dbo].[SpConSPropuestasCCEEFechas2]    Script Date: 11/11/2013 13:04:30 ******/
IF EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[SpConSPropuestasCCEEFechas2]') AND type in (N'P', N'PC'))
	DROP PROCEDURE [dbo].[SpConSPropuestasCCEEFechas2]
GO

/****** Object:  StoredProcedure [dbo].[SpConSPropuestasCCEEFechas2]    Script Date: 11/11/2013 13:04:30 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON 
GO

/*
***********************************************************************
PROCEDIMIENTO : SpConSPropuestasCCEEFechas2
FUNCION		  : Busca las propuestas de consultas externas 
				filtrando por CodHistoria o Tarjeta Sanitaria sólamente y mostrando las propuestas normales y pasivas
DEVUELVE	  : 
FECHA		  : 08/08/2008
VERSION		  : 1.0
AUTOR		  : Jesús Mañogil (Mecemsa)
***********************************************************************
MODIFICACIÓN  : (13/05/2009) Ramon. Obtengo la prioridad para las comprobaciones de las citas
MODIFICACIÓN  : (14/08/2009) Ismael. Nuevos campos FechaPrevista y TieneGuia
MODIFICACIÓN  : (21/08/2009) Ismael. Nuevos filtros por FechaPrevista y TieneGuia
MODIFICACIÓN  : (25/08/2009) Sonia Mateo. Devuelvo el campo DescMotivoPasiva de las propuestas pasivas
MODIFICACIÓN  : (02/09/2009) Ismael. Devuelvo el campo CodColectivo
MODIFICACIÓN  : (22/10/2009) Ismael. Propuestas rechazadas y eliminadas
MODIFICACIÓN  : (23/10/2009) Ismael. Incluyo la Aseguradora-Convenio
MODIFICACIÓN  : (30/11/2009) Ismael. Corrijo la Aseguradora-Convenio
MODIFICACIÓN  : (30/11/2009) Paco Aznar. Se devuelven los campos hospital referencia y descripción del centro destino
										 obteniéndose las propuestas del departamento logado
MODIFICACIÓN  : (12/03/2010) Paco Aznar. Se filtran propuestas reservadas y confirmadas y se devuelven más campos
MODIFICACIÓN  : (31/03/2010) Paco Aznar. Se devuelve el SIP
MODIFICACIÓN  : (13/04/2010) Paco Aznar. Se devuelve el campo comunicada
MODIFICACIÓN  : (15/11/2010) Paco Aznar. Se devuelve el campo codigoRyF
MODIFICACION  : (22/07/2011) Carlos H. Se añade modificación formato fechas
MODIFICACIÓN  : (25/08/2011) Carlos H. 25/08/2011 Devuelve centro de origen
MODIFICACIÓN  : (14/10/2011) César Moreno. Se cruzan las tablas de mutuas por el campo CodMutua
MODIFICACIÓN  : (18/10/2011) Carlos H Camacho. Añadimos condición para número máximo de filas
MODIFICACIÓN  : (20/10/2011) Jose Almela. Ponemos el nombre correcto a la columna FechaCita (añadir ____) para la transformación de fechas
MODIFICACIÓN  : (28/11/2011) Jose Almela. Se añade el id sidra de la SIC
MODIFICACIÖN  : (13/12/2011) Adrián Puchades Olmos. Devuelvo la fecha de nacimiento del paciente
MODIFICACIÓN  : (28/02/2012) Alfredo Samper. CHC1236 - v4.28 - Se devuelven nuevos campos
MODIFICACIÓN  : (27/06/2012) César Moreno. CHC1882 - v4.29 - Solo se devuelve la cita inicial, no las sucesivas
MODIFICACIÓN  : (03/07/2012) César Moreno. CHC-1895 - v4.30 - Devolvemos el estado, por si tiene valor "e", indica egresada
MODIFICACIÓN  : (28/08/2012) Alberto Pagán CHC1921 - v4.32 - nueva columna Unidad en DataGrid
MODIFICACIÓN  : (30/10/2012) Enrique Sánchez CHC2038 - v4.33.2 - Se devuelve si existe el IdMotivo y Descripción de las propuestas normales, pasivas, eliminadas y rechazadas
MODIFICACIÓN  : (22/11/2012) Enrique Sánchez - CHC2360 - Normalizacion del código de historia papel
MODIFICACIÓN  : (09/03/2013) Enrique Sánchez - CHC2871 - v4.38.2 - Se recupera el teléfono del paciente
MODIFICACIÓN  : (14/05/2013) MAIPU CHC3029 V4.38 r7 FCB, Comunicar a SAP la confirmación de una reserva (de cita)
MODIFICACIÓN  : (26/07/2013) - Alfredo 4.40 CHC3061 - Añado el tiempo de espera
MODIFICACIÓN  : (30/10/2013) - Enrique Sánchez - CHC2076 - Derivación SIC - v4.41 - Se recupera la columna DerivacionSIC
MODIFICACIÓN  : (11/11/2013) - MAIPU CHC3807 V4.40 R 16 FCB, Orden de Prioridad en la grilla del Gestor de lista de espera
MODIFICACION  : (20/03/2014) - CHC4019 - v4.42 - MAIPU REQ 46859 HEC_CORRECTIVO_PROBLEMA EN BUSQUEDAS POR FILTRO
MODIFICACIÓN  : (22/07/2014) - V4.46 - 1024 - ECR - Estado previo a confirmación de cita
MODIFICACIÓN  : (03/11/2014) - V4.48 - 1169 - VAS - Citas Espontáneas
MODIFICACIÓN  : (20/11/2014) - V4.48 - 1489 - VAS - Iconos estado SIC en Gestor Interconsultas
MODIFICACIÓN  : (20/11/2014) - V4.49 - 1440 - APB - Segunda parte Derivación entre instancias
MODIFICACION  : (24/12/2014) - v4.49 - 1439 - RRG - Transversalidad del caso GES - REQ 55104
MODIFICACION  : (01/04/2015) - v4.49r2 - 2031 - ACT - Problemas con IC Duplicadas en Florence
MODIFICACION  : (21/04/2015) - v4.49r2 - 1992 - APO - Si es derivación el servicio que remite se obtiene de la tabla servicios externos
MODIFICACION  :	(22/06/2015) - v4.52 - 1899 - SGN - Problema distribución cupos florence
MODIFICACION  :	(10/05/2016) - v4.54 - 114752 - Patrick Vicuña - se mejora performance del SP, eliminando Subquerys del select y agregando tabla temporal
MODIFICACION  : (16/11/2015) - v4.55r1 - 2696 - CCM - Impresión Multiple SIC
MODIFICACION  : (01/12/2015) - v4.57 - 2724 - CCM - Incorporar folio SIGGES a una solicitud de interconsulta
MODIFICACION  : (01/12/2015) - v4.57r5 - 3245 - APO - Problemas Gestor de Interconsultas
MODIFICACION  : (24/12/2015) - v4.58 - 2760 - SGN - Agregar prioridad en Gestor Interconsultas
MODIFICACION  : (10/06/2016) - v4.57r5 - 3245 - APB - Problemas Gestor de Interconsultas (definición de comentarios varchar(2000))
MODIFICACION  : (09/05/2017) - 17.2 - 16146 - SGH - Incluir Nombre Social del Paciente
MODIFICACION  : (19/05/2017) - 17.2 - 16506 - SGH - Filtros Prais Listados Sol. Interconsultas e Intervenciones
MODIFICACION  : (26/05/2017) - 17.2 - 16112 - SGH - Modificar reporte de gestor de interconsultas
MODIFICACION  : (23/08/2017) - v17.3 – 18451 – FCB - Ingresar observación al motivo de egreso en SIC
*/

CREATE PROCEDURE [dbo].[SpConSPropuestasCCEEFechas2]
       @spvar_CodHistoria char(8) = null
      ,@spvar_TSanitaria char(16) = null
      ,@spvar_FechaPrevistaDesde smalldatetime = null
      ,@spvar_FechaPrevistaHasta smalldatetime = null
      ,@spvar_AUGE bit = null
      ,@spvar_Eliminadas bit = null
      ,@spvar_Rechazadas bit = null
      ,@spvar_NumFilasCCEE int = null
      ,@spvar_ConfAsistencia bit = 0
      ,@spvar_CitaEspontanea bit = 0 
AS

declare @CodPaciente char(16)

CREATE TABLE #PropuestasCCEEFecha
	(
	CodHistoria varchar(8),
	CodPaciente varchar(16),
	PacNombre varchar(20),
	PacApell1 varchar(25),
	PacApell2 varchar(25),
	CodEpisodio char(5),
	FechaCPrimera____ varchar(25),
	ConfAsistencia bit,
	FechaConsulta____ varchar(25),
	Juicio varchar(5000),
	CodCentroFinal char(5),
	Codigo char(4),
	ServicioDestino char(40),
	ServicioRemite char(40),
	Pasiva char(1),
	Solicitud char(1),
	FechaPrevista____ varchar(25),
	TieneGuia int,
	MotivoPasiva varchar(500),
	CodColectivo char(5),
	Aseguradora varchar(70),
	HospitalRef char(5),
	DescCentro varchar(30),
	NoDerecho char(1),
	CodConsulta varchar(50),
	FechaCita____ varchar(25),
	IdCita smallint,
	CodTipoConsulta char(7),
	CodigoServicio char(4),
	CodTipoConsulta2 char(7),
	confirmada bit,
	NumTarjSanitaria char(16),
	comunicada bit,
	CodigoRYF char(20),
	CodCentroOrigen char(5),
	DescCentroRef varchar(35),
	IdMotivo int,
	FecNac datetime,
	CodHistoriaPapel varchar(8),
	Genero char(1),
	Sexo varchar(50),
	[RUT Profesional] char(8),
	Profesional varchar(50),
	Citador varchar(50),
	TipoConsulta nvarchar(60),
	Prioridad varchar(50),
	Estado char(1),
	Unidad varchar(255),
	DirTelf varchar(14),
	TiempoEspera int,
	OrdenPrioridad int,
	DerivacionSIC tinyint,
	AsisteCita bit,
	CitaEspontanea bit,
	FechaInicial smalldatetime,
	NoAtendido bit,
	FechaNoAtendida datetime,
	NoAsistenciasCita int,
	idOrigenCita int,
	DescOrigenCitas varchar(25),
	Email varchar(100),
	Direccion varchar(100),
	DirNum char(6),
	CodPostal char(5),
	NomPoblacion varchar(30),
	Provincia varchar(40),
	Localidad varchar(30),
	telf2 char(14),
	RutTutor char(16),
	NombreMedicoRemi char(15),
	Apel1MedicoRemi char(15),
	Apel2MEdicoRemi char(15),
	RutMedicoRemi char(9),
	DescDiagnostico varchar(256),
	DescDiagnosProvi varchar(256),
	inspecciones varchar(2000),
	IDProblemaSalud int,
	descProblema varchar(300),
	descSubProblema varchar(300),
	Nif char(9),
	IdCausaInterconsulta tinyint,
	DescCausaInterconsulta varchar(60),
	comentarios varchar(2000),
	TipoRemision char(1),
	motivo char(2),
	FolioSigges char(10),
	PrioridadHosp char(1),
	OrdenPrioridadHosp int,
	NombreSocial varchar(50),
	EsPRAIS bit,
	ProfesionalAtiende varchar(50),
	Telf3 char(14),
	TelfFijoUFamiliar char(14) 
	,RUNProfEgreso varchar(9)
	,NomProfEgreso varchar(80)
	,ObservacionEgreso varchar(500)
	,FechaCierre smalldatetime
	)
	
--Aplicamos máximo de filas si este parámetro trae algún valor.
if @spvar_NumFilasCCEE is not null
      set rowcount @spvar_NumFilasCCEE

if @spvar_CodHistoria is null
      select @CodPaciente = CodPaciente from Hclinica..Pacientes where NumTarjSanitaria = @spvar_TSanitaria
else
      select @CodPaciente = CodPaciente from Hclinica..Pacientes where CodHistoria = @spvar_CodHistoria

              --Busca las propuestas normales, pasivas, eliminadas y rechazadas
              insert into #PropuestasCCEEFecha
              select    p.CodHistoria,
                        p.CodPaciente,
                        'PacNombre' = rtrim(p.PacNombre),
                        'PacApell1' = rtrim(p.PacApell1),
                        'PacApell2' = rtrim(p.PacApell2),
                        e.CodEpisodio,
                        parametros.dbo.fnParFechaHoraUTC(e.FechaCPrimera) as FechaCPrimera____,
                        c.ConfAsistencia as ConfAsistencia,
                        parametros.dbo.fnParFechaHoraUTC(e.FechaConsulta) as FechaConsulta____,
                        e.DictamenClinico as Juicio,
                        e.CodCentroFinal,
                        S.Codigo,
                        s.DescServicio ServicioDestino,
                        case when e.DerivacionSIC = 1 then se1.DescServicio else s1.DescServicio end as ServicioRemite,
                        0 as Pasiva,
                        e.Solicitud,
                        parametros.dbo.fnParFechaHoraUTC(FechaPrevista) as FechaPrevista____,
                        case
                             when 
                                   isnull(
                                               e.IdGuiaClinica,
                                               (
                                                     select MIN (I.CodProblema)
                                                     from (
                                                                       SELECT 
                                                                              ipd.CodPaciente
                                                                            , ipd.CodEpisodio
                                                                            , ipd.CodProblema
                                                                            , ipd.CodSubProblema
                                                                            , ipd.CodDiagnostico
                                                                            , ipd.IDInformeIPD                         
                                                                       FROM Hclinica..InformeIPD ipd 
                                                                       union
                                                                       select 
                                                                              tcGES.CodPaciente
                                                                            , tcGES.CodEpisodio
                                                                            , ipd.CodProblema
                                                                            , ipd.CodSubProblema
                                                                            , ipd.CodDiagnostico
                                                                            , tcGES.IDInformeIPD      
                                                                       FROM Hclinica..TrazabilidadCasoGES tcges 
                                                                            inner join Hclinica..InformeIPD ipd on tcges.IDInformeIPD = ipd.IDInformeIPD
                                                                 ) I 
                                                                 inner join Parametros..CIEDiagnostico CIEDiag on I.CodDiagnostico = CIEDiag.CodDiagnostico
                                                     WHERE I.CodPaciente = e.CodPaciente
                                                           and I.CodEpisodio = e.CodEpisodio        
                                               )
                                           ) is null then 0
                             else 1
                        end as TieneGuia,
                        ISNULL(MC.Descripcion,'') as MotivoPasiva,
                        e.CodColectivo,
                        MP.Entidad + '-' + MS.Entidad  as Aseguradora, ---nuevo
                        cs.HospitalRef,
                        cs.DescCentro,
                        c.NoDerecho as NoDerecho, ---nuevo
                        c.CodConsulta as CodConsulta,
                        parametros.dbo.fnParFechaHoraUTC(FechaCPrimera) as FechaCita____,
                        c.IdCita as IdCita,
                        c.CodTipoConsulta as CodTipoConsulta,
                        c.CodigoServicio as CodigoServicio,
                        c.CodTipoConsulta2 as CodTipoConsulta2,
                        e.confirmada,
                        p.NumTarjSanitaria,
                        e.comunicada,
                        e.CodigoRYF,
                        e.CodCentroOrigen,
                        COALESCE(cs1.DescCentro,DOC.NomCentro) as DescCentroRef
                        ,ISNULL(IdMotivo,'') as IdMotivo,
                        p.FecNac,
                        RIGHT('00000000' + LTRIM (RTRIM(AHP.CodHistoriaPapel)),8 ) as CodHistoriaPapel,
                        p.Genero,
                        'Sexo' = COD.Descripcion,
                        'RUT Profesional' = e.DniMedDestino,
                        'Profesional' = PM.NomMedico + ' ' + PM.Apell1 + ' ' + PM.Apell2,
                        'Citador' = COALESCE(PMcita.NomMedico, DEcita.NombreEnf, Acita.NomAdminis) + ' ' +
                                    COALESCE(PMcita.Apell1, DEcita.Apell1Enf, Acita.Apell1Administ) + ' ' +
                                    COALESCE(PMcita.Apell2, DEcita.Apell2Enf, Acita.Apell2Administ),
                        'TipoConsulta' = TC.DescTipoCons,
                        'Prioridad' = COD2.Descripcion
                        ,e.Estado
                        ,u.Descripcion as Unidad
                        ,p.DirTelf
                        ,'TiempoEspera' = DATEDIFF(DD, e.FechaConsulta, ISNULL(e.FechaInicial, GETDATE()))
                        ,COD2.Posicion as OrdenPrioridad
                        ,e.DerivacionSIC
                        ,c.Asiste as AsisteCita
                        ,c.CitaEspontanea
                        ,c.HoraInicial as FechaInicial
                        ,c.NoAtendido
                        ,null as FechaNoAtendida
                        ,e.NoAsistenciasCita
                        ,C.idOrigenCita
                        ,O.DescOrigenCitas
                        ,p.Email
                        ,p.Direccion
                        ,p.DirNum
                        ,p.CodPostal
                        ,L.NomPoblacion
                        ,p1.Nombre as Provincia
                        ,L.NomPoblacion as Localidad
                        ,p.telf2
                        ,isnull(p.TarjSanitariaResp,'') as RutTutor
                        ,isnull(PMRemite.NomMedico,'') as NombreMedicoRemi
                        ,isnull(PMRemite.Apell1,'') as Apel1MedicoRemi
                        ,isnull(PMRemite.Apell2,'') as Apel2MEdicoRemi
                        ,isnull(PMRemite.Nif,'') as RutMedicoRemi
                        ,I.DescDiagnostico
                        ,CI.DescDiagnostico as DescDiagnosProvi
                        ,e.inspecciones
                        ,e.IDProblemaSalud
                        ,gc.DescGuia as descProblema
                        ,gc1.DescGuia as descSubProblema
                        ,isnull(PMcita.Nif,isnull(DEcita.Nif,isnull(TD.Nif,Acita.nif))) as Nif
                        ,e.IdCausaInterconsulta
                        ,e.DescCausaInterconsulta
                        ,e.comentarios
                        ,e.TipoRemision
                        ,e.motivo
                        ,e.FolioSigges
						,e.PrioridadHosp
						,Cod3.Posicion as OrdenPrioridadHosp
						,p.AtiendeAlNombre as NombreSocial
						,CASE WHEN 
						(
							EXISTS (select * from Hclinica..MutuasSaludSecPaciente MSSP 
							INNER JOIN parametros..MutuasSalud MS on MS.Codigo = MSSP.CodColectivo
							where codpaciente = e.CodPaciente and MS.EsPrais = 1)
						) THEN 1 ELSE 0 END AS EsPRAIS,	
						CASE WHEN c.Asiste = 1 THEN 
						(
							SELECT 
							PMAten.NomMedico + ' ' + PMAten.Apell1 + ' ' + 	PMAten.Apell2 
							FROM  Parametros..ParametrosMedicos PMAten 
							WHERE PMAten.DNIMedico = c.NIFMedicoConsulta
						) ELSE '' END as ProfesionalAtiende,
						p.Telf3,
						p.TelfFijoUFamiliar 
						,e.RUNProfEgreso
						,e.NomProfEgreso
						,e.ObservacionEgreso
						,e.FechaCierre
            from  Consultas..EpisodioConsultas e with (nolock)
                  inner join Hclinica..Pacientes p with (nolock) on e.CodPaciente = p.CodPaciente
                  left join Parametros..Servicios s with (nolock) on e.CodServicioFinal = s.Codigo
                  left join Parametros..Servicios s1 with (nolock) on e.CodServicioOrigen = s1.Codigo
                  left join Parametros..ServiciosExternos se1 with (nolock) on e.CodServicioOrigen = se1.Codigo
                  left join Parametros..CentrosSalud cs with (nolock) on e.CodCentroFinal = cs.CodCentro
                  left join Parametros..CentrosSalud cs1 with (nolock) on e.CodCentroOrigen = cs1.CodCentro
                  left join Parametros..DatosOtrosCentros DOC with (nolock) on e.CodCentroOrigen = DOC.CodCent
                  left join Hclinica..Citas C on e.CodPaciente = c.CodPaciente and e.CodEpisodio = C.CodEpisodio and c.CodTipoConsulta = 0
                                                 AND ((e.FechaCPrimera IS NULL AND c.FechaEntrada = (SELECT MAX(c1.FechaEntrada) FROM Hclinica..Citas c1
                                                                                                     WHERE c.CodPaciente = c1.CodPaciente AND c.CodEpisodio = c1.CodEpisodio AND c1.CodTipoConsulta = 0))
                                                                                                           OR e.FechaCPrimera = C.FechaCita)
                  left join Hclinica..ArchivoHistoriasPapel AHP on P.CodPaciente = AHP.CodPaciente and cs.CodCentro = AHP.CodCentro
                  left join Parametros..Codigos COD on p.Genero = COD.Codigo and Tabla = 'EstGenero'
                  left join Parametros..ParametrosMedicos PM on e.DniMedDestino = PM.DNIMedico
                  left join Parametros..ParametrosMedicos PMcita on e.NIF = PMcita.DNIMedico
                  left join Parametros..DatosEnfermeras DEcita on e.NIF = DEcita.DNIEnf
                  left join Parametros..Administrativo Acita on e.NIF = Acita.DNIAdminist
                  left join Parametros..TiposConsultas TC on c.CodTipoConsulta = TC.CodTipoCons and c.CodTipoConsulta2 = TC.CodClaseCons and S.Codigo = TC.CodServCons
                  left join Parametros..Codigos COD2 on COD2.Codigo = e.Solicitud and COD2.Tabla = 'EstTipoExamen'
                  left join Parametros..Unidad u on e.IdUnidad = u.IdUnidad
                  left join Parametros..MotivosCitas MC on e.IdMotivo = MC.Codigo
                  left join Parametros..OrigenesCitas O on C.idOrigenCita = O.idOrigenCita
                  left join parametros..DireccionLocalidad L on p.DirCodLocalidad = L.CodPoblacion and p.DirCodProv = L.CodProvincia
                  left join parametros..CodProvincias p1 on p.DirCodProv = p1.Codigo
                  left join Parametros..ParametrosMedicos PMRemite on e.DNIMedEpi = PMRemite.DNIMedico
                  left join Parametros..CIEDiagnostico I on e.CodDiagnosticoProvisional = I.CodDiagnostico
                  left join Parametros..CIEDiagnostico CI on e.CodDiagnosticoPrimero = CI.CodDiagnostico
                  left join Parametros..GuiasClinicas gc on e.IDProblemaSalud = gc.CodGuia
                  left join Parametros..GuiasClinicas gc1 on e.CodSubProblema = gc1.CodGuia
                  left join Parametros..TecnicosDatos TD on e.NIF = TD.DNITecnico
                  left join Parametros..MutuasSalud MS on e.CodColectivo = MS.Codigo
                  left join Parametros..MutuaPrincipal MP on MS.CodMutua = MP.Codigo
                  left join Parametros..Codigos Cod3 on (e.PrioridadHosp = Cod3.Codigo and cod3.Tabla = 'EstTipoExamen')
            
            where p.CodPaciente = @CodPaciente

------------------------------------------------- Episodio consulta borrado ---------------------------------------------------------------------           
            insert into #PropuestasCCEEFecha
                 select p.CodHistoria,
                        p.CodPaciente,
                        'PacNombre' = rtrim(p.PacNombre),
                        'PacApell1' = rtrim(p.PacApell1),
                        'PacApell2' = rtrim(p.PacApell2),
                        e.CodEpisodio,
                        parametros.dbo.fnParFechaHoraUTC(e.FechaCPrimera) as FechaCPrimera____,
                        c.ConfAsistencia as ConfAsistencia,
                        parametros.dbo.fnParFechaHoraUTC(e.FechaConsulta) as FechaConsulta____,
                        e.DictamenClinico as Juicio,
                        e.CodCentroFinal,
                        S.Codigo,
                        s.DescServicio as ServicioDestino,
                        case when e.DerivacionSIC = 1 then se1.DescServicio else s1.DescServicio end as ServicioRemite,
                        case
							when Asistido is null then null
							when Asistido = 'R' then '2'
							else '1'
						end as Pasiva,
                        e.Solicitud,
                        parametros.dbo.fnParFechaHoraUTC(FechaPrevista) as FechaPrevista____,
                        case
                             when 
                                   isnull(
                                               e.IdGuiaClinica,
                                               (
                                                     select MIN (I.CodProblema)
                                                     from (
                                                                       SELECT 
                                                                              ipd.CodPaciente
                                                                            , ipd.CodEpisodio
                                                                            , ipd.CodProblema
                                                                            , ipd.CodSubProblema
                                                                            , ipd.CodDiagnostico
                                                                            , ipd.IDInformeIPD                         
                                                                       FROM Hclinica..InformeIPD ipd 
                                                                       union
                                                                       select 
                                                                              tcGES.CodPaciente
                                                                            , tcGES.CodEpisodio
                                                                            , ipd.CodProblema
                                                                            , ipd.CodSubProblema
                                                                            , ipd.CodDiagnostico
                                                                            , tcGES.IDInformeIPD      
                                                                       FROM Hclinica..TrazabilidadCasoGES tcges 
                                                                            inner join Hclinica..InformeIPD ipd on tcges.IDInformeIPD = ipd.IDInformeIPD
                                                                 ) I 
                                                                 inner join Parametros..CIEDiagnostico CIEDiag on I.CodDiagnostico = CIEDiag.CodDiagnostico
                                                     WHERE I.CodPaciente = e.CodPaciente
                                                           and I.CodEpisodio = e.CodEpisodio
                                               )
                                           ) is null then 0
                             else 1
                        end as TieneGuia,
                        DescMotivoPasiva as MotivoPasiva,
                        e.CodColectivo,
                        MP.Entidad + '-' + MS.Entidad  as Aseguradora, ---nuevo
                        cs.HospitalRef,
                        cs.DescCentro,
                        c.NoDerecho as NoDerecho, ---nuevo
                        c.CodConsulta as CodConsulta,
                        parametros.dbo.fnParFechaHoraUTC(c.FechaCita) as FechaCita____,
                        c.IdCita as IdCita,
                        c.CodTipoConsulta as CodTipoConsulta,
                        c.CodigoServicio as CodigoServicio,
                        c.CodTipoConsulta2 as CodTipoConsulta2,
                        null as confirmada,
                        p.NumTarjSanitaria,
                        e.comunicada,
                        e.CodigoRYF,
                        e.CodCentroOrigen,
                        COALESCE(cs1.DescCentro,DOC.NomCentro) as DescCentroRef
                        ,M.ID_Sidra as IdMotivo,
                        p.FecNac,
                        RIGHT('00000000' + LTRIM (RTRIM(AHP.CodHistoriaPapel)),8 ) as CodHistoriaPapel,
                        p.Genero,
                        'Sexo' = COD.Descripcion,
                        'RUT Profesional' = e.DniMedDestino,
                        'Profesional' = PM.NomMedico + ' ' + PM.Apell1 + ' ' + PM.Apell2,
                        'Citador' = COALESCE(PMcita.NomMedico, DEcita.NombreEnf, Acita.NomAdminis) + ' ' +
                                    COALESCE(PMcita.Apell1, DEcita.Apell1Enf, Acita.Apell1Administ) + ' ' +
                                    COALESCE(PMcita.Apell2, DEcita.Apell2Enf, Acita.Apell2Administ),
                        'TipoConsulta' = TC.DescTipoCons,
                        'Prioridad' = COD2.Descripcion
                        ,e.Estado
                        ,u.Descripcion as Unidad
                        ,p.DirTelf
                        ,'TiempoEspera' = DATEDIFF(DD, e.FechaConsulta, e.FechaBorrado)
                        ,COD2.Posicion as OrdenPrioridad
                        ,e.DerivacionSIC
                        ,c.Asiste as AsisteCita
                        ,c.CitaEspontanea
                        ,c.HoraInicial as FechaInicial
                        ,c.NoAtendido
                        ,null as FechaNoAtendida
                        ,e.NoAsistenciasCita
                        ,C.idOrigenCita
                        ,O.DescOrigenCitas
                        ,p.Email
                        ,p.Direccion
                        ,p.DirNum
                        ,p.CodPostal
                        ,L.NomPoblacion
                        ,p1.Nombre as Provincia
                        ,L.NomPoblacion as Localidad
                        ,p.telf2
                        ,isnull(p.TarjSanitariaResp,'') as RutTutor
                        ,isnull(PMRemite.NomMedico,'') as NombreMedicoRemi
                        ,isnull(PMRemite.Apell1,'') as Apel1MedicoRemi
                        ,isnull(PMRemite.Apell2,'') as Apel2MEdicoRemi
                        ,isnull(PMRemite.Nif,'') as RutMedicoRemi
                        ,I.DescDiagnostico
                        ,CI.DescDiagnostico as DescDiagnosProvi
                        ,e.inspecciones
                        ,e.IDProblemaSalud
                        ,gc.DescGuia as descProblema
                        ,gc1.DescGuia as descSubProblema
                        ,isnull(PMcita.Nif,isnull(DEcita.Nif,isnull(TD.Nif,Acita.nif))) as Nif
                        ,e.IdCausaInterconsulta
                        ,e.DescCausaInterconsulta
                        ,e.comentarios
                        ,e.TipoRemision
                        ,e.motivo
                        ,null as FolioSigges
						,e.PrioridadHosp
						,Cod3.Posicion as OrdenPrioridadHosp
            			,p.AtiendeAlNombre as NombreSocial
						,CASE WHEN 
						(
							EXISTS (select * from Hclinica..MutuasSaludSecPaciente MSSP 
							INNER JOIN parametros..MutuasSalud MS on MS.Codigo = MSSP.CodColectivo
							where codpaciente = e.CodPaciente and MS.EsPrais = 1)
						) THEN 1 ELSE 0 END AS EsPRAIS,
						CASE WHEN c.Asiste = 1 THEN 
						(
							SELECT 
							PMAten.NomMedico + ' ' + PMAten.Apell1 + ' ' + 	PMAten.Apell2 
							FROM  Parametros..ParametrosMedicos PMAten 
							WHERE PMAten.DNIMedico = c.NIFMedicoConsulta
						) ELSE '' END as ProfesionalAtiende,
						p.Telf3,
						p.TelfFijoUFamiliar 
						,e.RUNProfEgreso
						,e.NomProfEgreso
						,e.ObservacionEgreso
						,e.FechaBorrado as FechaCierre
            from  Consultas..EpisodioConsultasBorrados e with (nolock)
                  inner join Hclinica..Pacientes p with (nolock) on e.CodPaciente = p.CodPaciente
                  left join Parametros..Servicios s with (nolock) on e.CodServicioFinal = s.Codigo
                  left join Parametros..Servicios s1 with (nolock) on e.CodServicioOrigen = s1.Codigo
                  left join Parametros..ServiciosExternos se1 with (nolock) on e.CodServicioOrigen = se1.Codigo
                  left join Parametros..CentrosSalud cs with (nolock) on e.CodCentroFinal = cs.CodCentro
                  left join Parametros..CentrosSalud cs1 with (nolock) on e.CodCentroOrigen = cs1.CodCentro
                  left join Parametros..DatosOtrosCentros DOC with (nolock) on e.CodCentroOrigen = DOC.CodCent
                  left join Hclinica..Citas C on e.CodPaciente = c.CodPaciente and e.CodEpisodio = C.CodEpisodio and c.CodTipoConsulta = 0
                                                 AND ((e.FechaCPrimera IS NULL AND c.FechaEntrada = (SELECT MAX(c1.FechaEntrada) FROM Hclinica..Citas c1
                                                                                                     WHERE c.CodPaciente = c1.CodPaciente AND c.CodEpisodio = c1.CodEpisodio AND c1.CodTipoConsulta = 0))
                                                                                                           OR e.FechaCPrimera = C.FechaCita)
                  left join Hclinica..ArchivoHistoriasPapel AHP on P.CodPaciente = AHP.CodPaciente and cs.CodCentro = AHP.CodCentro
                  left join Parametros..Codigos COD on p.Genero = COD.Codigo and Tabla = 'EstGenero'
                  left join Parametros..ParametrosMedicos PM on e.DniMedDestino = PM.DNIMedico
                  left join Parametros..ParametrosMedicos PMcita on e.NIF = PMcita.DNIMedico
                  left join Parametros..DatosEnfermeras DEcita on e.NIF = DEcita.DNIEnf
                  left join Parametros..Administrativo Acita on e.NIF = Acita.DNIAdminist
                  left join Parametros..TiposConsultas TC on c.CodTipoConsulta = TC.CodTipoCons and c.CodTipoConsulta2 = TC.CodClaseCons and S.Codigo = TC.CodServCons
                  left join Parametros..Codigos COD2 on COD2.Codigo = e.Solicitud and COD2.Tabla = 'EstTipoExamen'
                  left join Parametros..Unidad u on e.IdUnidad = u.IdUnidad
                  left join Parametros..OrigenesCitas O on C.idOrigenCita = O.idOrigenCita
                  left join parametros..DireccionLocalidad L on p.DirCodLocalidad = L.CodPoblacion and p.DirCodProv = L.CodProvincia
                  left join parametros..CodProvincias p1 on p.DirCodProv = p1.Codigo
                  left join Parametros..ParametrosMedicos PMRemite on e.DNIMedEpi = PMRemite.DNIMedico
                  left join Parametros..CIEDiagnostico I on e.CodDiagnosticoProvisional = I.CodDiagnostico
                  left join Parametros..CIEDiagnostico CI on e.CodDiagnosticoPrimero = CI.CodDiagnostico
                  left join Parametros..GuiasClinicas gc on e.IDProblemaSalud = gc.CodGuia
                  left join Parametros..GuiasClinicas gc1 on e.CodSubProblema = gc1.CodGuia
                  left join Parametros..TecnicosDatos TD on e.NIF = TD.DNITecnico
                  left join Parametros..MutuasSalud MS on e.CodColectivo = MS.Codigo
                  left join Parametros..MutuaPrincipal MP on MS.CodMutua = MP.Codigo
                  left join Parametros..Codigos Cod3 on (e.PrioridadHosp = Cod3.Codigo and cod3.Tabla = 'EstTipoExamen')
                  left join Parametros..MotivosCitas M on M.Codigo = e.IdMotivo
                                       
      where p.CodPaciente = @CodPaciente and (e.Asistido = 'N' or e.Asistido is null or e.Asistido = 'R')
            
select * from #PropuestasCCEEFecha
GO



--dbo.SpConSPropuestasCCEEFechas3Pac.sql



USE [Consultas]
GO

/****** Object:  StoredProcedure [dbo].[SpConSPropuestasCCEEFechas3Pac]    Script Date: 12/03/2013 12:39:37 ******/
IF EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[SpConSPropuestasCCEEFechas3Pac]') AND type in (N'P', N'PC'))
DROP PROCEDURE [dbo].[SpConSPropuestasCCEEFechas3Pac]
GO

/****** Object:  StoredProcedure [dbo].[SpConSPropuestasCCEEFechas3Pac]    Script Date: 12/03/2013 12:39:37 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

/*
***********************************************************************
PROCEDIMIENTO : SpConSPropuestasCCEEFechas3Pac
FUNCION		  : Busca las propuestas de consultas externas 
			    filtrando por cualquier campo, cuando existe código paciente (Viene de SpConSPropuestasCCEE3)
DEVUELVE	  : 
FECHA		  : 06/10/2010
VERSION		  : 1.0
AUTOR		  : Paco Aznar
***********************************************************************
MODIFICACION  : Carlos H. 22/07/2011 Modificación formato fechas
			  : Carlos H. 25/08/2011 Devuelve centro de origen
MODIFICACIÓN  : (14/10/2011) César Moreno. Se cruzan las tablas de mutuas por el campo CodMutua
MODIFICACIÓN  : (18/10/2011) Carlos H Camacho. Añadimos condición para número máximo de filas
MODIFICACION  : (20/10/2011) Eliminada columna redundante de FechaCita
MODIFICACION  : (22/11/2011) Miguel Angel Gómez. Se añade un nuevo parámetro de entrada, @spvar_Atendidas
MODIFICACIÖN  : (13/12/2011) Adrián Puchades Olmos. Devuelvo la fecha de nacimiento del paciente
MODIFICACIÓN  : (28/02/2012) Alfredo Samper. CHC1236 - v4.28 - Se devuelven nuevos campos
MODIFICACIÓN  : (03/07/2012) César Moreno. CHC-1895 - v4.30 - Devolvemos el estado, por si tiene volor "e", indica egresada
MODIFICACIÓN  : (28/08/2012) Alberto Pagán CHC1921 - v4.32 - nueva columna Unidad en DataGrid
MODIFICACIÓN  : (22/11/2012) Enrique Sánchez - CHC2360 - Normalizacion del código de historia papel
MODIFICACIÓN  : (09/03/2013) Enrique Sánchez - CHC2871 - v4.38.2 - Se recupera el teléfono del paciente
MODIFICACIÓN  : (14/05/2013)  MAIPU CHC3029 V4.38 r7 FCB, Comunicar a SAP la confirmación de una reserva (de cita)
MODIFICACIÓN  : (26/07/2013) - Alfredo 4.40 CHC3061 - Añado el tiempo de espera
MODIFICACIÓN  : (30/10/2013) Enrique Sánchez - CHC2076 - Derivación SIC - v4.41 - Se recupera la columna DerivacionSIC
MODIFICACIÓN  : (11/11/2013) - MAIPU CHC3807 V4.40 R 16 FCB, Orden de Prioridad en la grilla del Gestor de lista de espera
MODIFICACIÓN  : (11/11/2013) - MAIPU CHC3817 V4.40 R17 FCB, Citas Atendidas
MODIFICACION  : (20/03/2014) - CHC4019 - v4.42 - MAIPU REQ 46859 HEC_CORRECTIVO_PROBLEMA EN BUSQUEDAS POR FILTRO
MODIFICACIÓN  : (10/04/2014) Alberto Pagán - v4.42 - MAIPU CHC3984 REQ 46118 Gestor de interconsultas no entrega información de NSP
MODIFICACION  : (09/07/2014) - v4.46 – 0001022: 10925 – JVT - Observaciones pendientes derivación entre instancias
MODIFICACIÓN  : (22/07/2014) - V4.46 - 1024 - ECR - Estado previo a confirmación de cita
MODIFICACIÓN  : (30/10/2014) - V4.48 - 1169 - VAS - Citas espontáneas
MODIFICACIÓN  : (20/11/2014) - V4.48 - 1489 - VAS - Iconos estado SIC en Gestor Interconsultas
MODIFICACIÓN  : (20/11/2014) Alberto Pagán Benedicto - V4.49 - 1440 - APB - Segunda parte Derivación entre instancias
MODIFICACION  : (24/12/2014) - v4.49 - 1439 - RRG - Transversalidad del caso GES - REQ 55104
MODIFICACION  : (01/04/2015) - v4.49r2 - 2031 - ACT - Problemas con IC Duplicadas en Florence
MODIFICACION  : (29/06/2015) - v4.52 - 1899 - SGN - Problema distribución cupos florence
MODIFICACION  : (16/11/2015) - v4.55r1 - 2696 - CCM - Impresión Multiple SIC
MODIFICACION  : (30/11/2015) - v4.55r2 - 2737 - CCM - Solicitudes interconsultas agregar columna
MODIFICACION  : (01/12/2015) - v4.57 - 2724 - CCM - Incorporar folio SIGGES a una solicitud de interconsulta
MODIFICACION  : (24/12/2015) - v4.58 - 2760 - SGN - Agregar prioridad en Gestor Interconsultas
MODIFICACION  : (09/05/2017) - 17.2 - 16146 - SGH - Incluir Nombre Social del Paciente
MODIFICACION  : (19/05/2017) - 17.2 - 16506 - SGH - Filtros Prais Listados Sol. Interconsultas e Intervenciones
MODIFICACION  : (26/05/2017) - 17.2 - 16112 - SGH - Modificar reporte de gestor de interconsultas
MODIFICACION  : (23/08/2017) - v17.3 – 18451 – FCB - Ingresar observación al motivo de egreso en SIC
*/

CREATE PROCEDURE [dbo].[SpConSPropuestasCCEEFechas3Pac]
	 @spvar_Nombre char(20) = null
	,@spvar_Apell1 char(25) = null
	,@spvar_Apell2 char(25) = null
	,@spvar_CodServicio char(4) = null
	,@spvar_CodServicioRemite char(4) = null
	,@spvar_FecSolDesde smalldatetime = null
	,@spvar_FecSolHasta smalldatetime = null
	,@spvar_Citados bit = 0
	,@spvar_NoCitados bit = 0
	,@spvar_FecCita smalldatetime = null
	,@spvar_FecCitaDesde smalldatetime = null
	,@spvar_FecCitaHasta smalldatetime = null
	,@spvar_CodCentro char(5) = null
	,@spvar_CodTipoRemision char(1) = null
	,@spvar_Prioridad char(1) = null
	,@spvar_DniMedicoDestino char(8)= null
	,@spvar_BuscaPasivas bit = 0
	,@spvar_NumQuery int = 0
	,@spvar_FechaPrevistaDesde smalldatetime = null
	,@spvar_FechaPrevistaHasta smalldatetime = null
	,@spvar_AUGE bit = null
	,@spvar_Eliminadas bit = null
	,@spvar_Rechazadas bit = null
	,@spvar_CodColectivo varchar(5) = null
	,@spvar_codCentroDestino char(5) = null
	,@spvar_Reservadas bit = 0
	,@spvar_Confirmadas bit = 0
	,@spvar_PropConfirmadas bit = 0
	,@spvar_FecRecDesde smalldatetime = null
	,@spvar_FecRecHasta smalldatetime = null
	,@spvar_FecConfDesde smalldatetime = null
	,@spvar_FecConfHasta smalldatetime = null
	,@spvar_PropPendientes bit = 0
	,@spvar_idUnidad int = null
	,@spvar_Comunicadas bit = 0
	,@spvar_SinComunicar bit = 0
	,@spvar_LibreEleccion bit = null
	,@spvar_DniMedicoOrigen char(8) = null
	,@spvar_codPaciente char(16)
	,@spvar_NumFilasCCEE int = null
	,@spvar_Atendidas bit = 0
	,@spvar_ConfAsistencia bit = 0 --V4.46 - 1024 - ECR
	,@spvar_Espontanea bit = 0 --(30/10/2014) - V4.48 - 1169 - VAS - Citas espontáneas
	,@spvar_PRAIS bit = null
AS

--Aplicamos máximo de filas si este parámetro trae algún valor.
if @spvar_NumFilasCCEE is not null
	set rowcount @spvar_NumFilasCCEE

--Busca las propuestas pasivas
if @spvar_BuscaPasivas = 1 
BEGIN
	select	p.CodHistoria,
			p.CodPaciente,
			'PacNombre'= rtrim(p.PacNombre), 
			'PacApell1' = rtrim(p.PacApell1),
			'PacApell2' = rtrim(p.PacApell2),
			e.CodEpisodio,
			parametros.dbo.fnParFechaHoraUTC(e.FechaCPrimera) as FechaCPrimera____,
			C.ConfAsistencia, 
			parametros.dbo.fnParFechaHoraUTC(e.FechaConsulta) as FechaConsulta____,
			e.DictamenClinico as Juicio,
			e.CodCentroFinal,
			s.Codigo, 
			s.DescServicio ServicioDestino,
			case when e.DerivacionSIC = 1 then se1.DescServicio else s1.DescServicio end as ServicioRemite,		
			'0' as Pasiva,
			e.Solicitud, 
			parametros.dbo.fnParFechaHoraUTC(e.FechaPrevista) as FechaPrevista____,
			case
				when 
					isnull(
							e.IdGuiaClinica,
							(
								select MIN (I.CodProblema)
								from 	(
											SELECT 
												  ipd.CodPaciente
												, ipd.CodEpisodio
												, ipd.CodProblema
												, ipd.CodSubProblema
												, ipd.CodDiagnostico
												, ipd.IDInformeIPD					
											FROM HClinica..InformeIPD ipd 
											union
											select 
												  tcGES.CodPaciente
												, tcGES.CodEpisodio
												, ipd.CodProblema
												, ipd.CodSubProblema
												, ipd.CodDiagnostico
												, tcGES.IDInformeIPD	
											FROM Hclinica..TrazabilidadCasoGES tcges 
												inner join hclinica..informeipd ipd on tcges.idinformeipd=ipd.idinformeipd 
										) I 
										inner join Parametros..CIEDiagnostico CIEDiag on I.CodDiagnostico=CIEDiag.CodDiagnostico
								WHERE I.CodPaciente=e.CodPaciente
								  and I.CodEpisodio=e.CodEpisodio		
							)
						  ) is null then 0
				else 1
			end as TieneGuia,
			'' as MotivoPasiva,
			e.CodColectivo,
			MP.Entidad + '-' + MS.Entidad as Aseguradora,
			cs.HospitalRef,
			cs.DescCentro,	
			0 as noDerecho,
			null as codConsulta,
			null as fechaCita,
			null as idCita,
			null as CodTipoConsulta,
			null as CodigoServicio,
			null as confirmada,
			null as CodTipoConsulta2, 
			p.NumTarjSanitaria,
			e.comunicada,
			e.CodigoRYF,
			e.CodCentroOrigen,
			COALESCE(cs1.DescCentro,DOC.NomCentro) as DescCentroRef	
			,(select top 1 ID_Sidra from Parametros..[MotivosCitas] M where M.Codigo = e.IdMotivo) as IdMotivo,
			p.FecNac,
			RIGHT('00000000' + LTRIM (RTRIM(AHP.CodHistoriaPapel)),8 ) as CodHistoriaPapel,
			p.Genero,
			'Sexo' = COD.Descripcion,
			'RUT Profesional' = e.DniMedDestino,
			'Profesional' = PM.NomMedico + ' ' + PM.Apell1 + ' ' + PM.Apell2,
			'Citador' = COALESCE(PMcita.NomMedico, DEcita.NombreEnf, Acita.NomAdminis) + ' ' +
						COALESCE(PMcita.Apell1, DEcita.Apell1Enf, Acita.Apell1Administ) + ' ' +
						COALESCE(PMcita.Apell2, DEcita.Apell2Enf, Acita.Apell2Administ),
			'TipoConsulta' = TC.DescTipoCons,
			'Prioridad' = COD2.Descripcion	
		    ,e.Estado
		    ,u.Descripcion as Unidad
			,p.DirTelf
			,'TiempoEspera' = DATEDIFF(DD, e.FechaConsulta, ISNULL(e.FechaInicial, GETDATE()))
			,COD2.Posicion as OrdenPrioridad 
			,e.DerivacionSIC
			,c.Asiste as AsisteCita
			,c.CitaEspontanea 
			,c.HoraInicial as FechaInicial 
			,c.NoAtendido
			,null as FechaNoAtendida
			,e.NoAsistenciasCita
			, c.idOrigenCita 
			, O.DescOrigenCitas
			,p.Email
			,p.Direccion 
			,p.DirNum
			 ,p.CodPostal 
			 ,L.NomPoblacion  
			 ,p1.Nombre as Provincia
			,L.NomPoblacion as Localidad
			,p.telf2
			,isNull(p.TarjSanitariaResp,'') as RutTutor
			
			,IsNull(PMRemite.NomMedico , '') as NombreMedicoRemi
			,IsNull(PMRemite.Apell1 , '') as Apel1MedicoRemi
			,IsNull(PMRemite.Apell2 , '') as Apel2MEdicoRemi
			,IsNull(PMRemite.Nif , '') as RutMedicoRemi
			,I.DescDiagnostico
			,CI.DescDiagnostico as DescDiagnosProvi
			,e.inspecciones 
			,e.IDProblemaSalud
			,gc.DescGuia as descProblema
			,gc1.DescGuia as descSubProblema
			,isnull(PMcita.Nif,isnull(DEcita.Nif,isnull(TD.Nif,Acita.nif))) as Nif
			,e.IdCausaInterconsulta
			,e.DescCausaInterconsulta
			,e.comentarios
			,e.TipoRemision
			,e.motivo
			,e.FolioSigges
			,e.PrioridadHosp
			,Cod3.Posicion as OrdenPrioridadHosp
			,p.AtiendeAlNombre as NombreSocial
			,CASE WHEN 
			(
				EXISTS (select * from Hclinica..MutuasSaludSecPaciente MSSP 
				INNER JOIN parametros..MutuasSalud MS on MS.Codigo = MSSP.CodColectivo
				where codpaciente = e.CodPaciente and MS.EsPrais = 1)
			) THEN 1 ELSE 0 END AS EsPRAIS,
			'' as ProfesionalAtiende,
			p.Telf3,
			p.TelfFijoUFamiliar
			,e.RUNProfEgreso
			,e.NomProfEgreso
			,e.ObservacionEgreso
			,e.FechaCierre
	from	Consultas..EpisodioConsultas e with (nolock)
			inner join Hclinica..Pacientes p with (nolock) on p.CodPaciente = e.CodPaciente 
			left join Parametros..Servicios s with (nolock) on s.Codigo = e.CodServicioFinal
			left join Parametros..Servicios s1 with (nolock) on s1.Codigo = e.CodServicioOrigen
			left join Parametros..ServiciosExternos se1 with (nolock) on se1.Codigo = e.CodServicioOrigen
			left join Parametros..CentrosSalud cs with (nolock) on cs.CodCentro = e.CodCentroFinal
			left join Parametros..CentrosSalud cs1 with (nolock) on cs1.CodCentro = e.CodCentroOrigen
			left join Parametros..DatosOtrosCentros DOC with (nolock) on DOC.CodCent = e.CodCentroOrigen
			left join Hclinica..Citas C on e.CodPaciente = c.CodPaciente and e.CodEpisodio = C.CodEpisodio and c.CodTipoConsulta = 0 
			                               AND ( (e.FechaCPrimera IS NULL AND c.FechaEntrada = (SELECT MAX(c1.FechaEntrada) FROM Hclinica..Citas c1 WHERE c.codpaciente = c1.codpaciente AND c.codepisodio = c1.CodEpisodio AND c1.CodTipoConsulta=0)) 
														OR e.FechaCPrimera = C.FechaCita) 
			left join Hclinica..ArchivoHistoriasPapel AHP on AHP.CodPaciente = P.CodPaciente and AHP.CodCentro = cs.CodCentro
			left join Parametros..Codigos COD on COD.Codigo = p.Genero and Tabla = 'EstGenero'
			left join Parametros..ParametrosMedicos PM on PM.DNIMedico = e.DniMedDestino
			left join Parametros..ParametrosMedicos PMcita on PMcita.DNIMedico = e.NIF
			left join Parametros..DatosEnfermeras DEcita on DEcita.DNIEnf = e.NIF
			left join Parametros..Administrativo Acita on Acita.DNIAdminist = e.NIF				
			left join Parametros..TiposConsultas TC on TC.CodTipoCons = c.CodTipoConsulta and TC.CodClaseCons = c.CodTipoConsulta2 and TC.CodServCons = s.Codigo
			left join Parametros..Codigos COD2 on COD2.Codigo = e.Solicitud and COD2.Tabla = 'EstTipoExamen'
			left join Parametros..Unidad u on e.IdUnidad = u.IdUnidad
			left join Parametros..OrigenesCitas O on C.idOrigenCita = O.idOrigenCita
			LEFT JOIN parametros..DireccionLocalidad L ON p.DirCodLocalidad = L.CodPoblacion and p.dircodprov = l.codprovincia 		    
			LEFT JOIN parametros..codprovincias p1 on p1.codigo = p.dircodprov
			left join Parametros..ParametrosMedicos PMRemite on PMRemite.DNIMedico = e.DNIMedEpi
			LEFT JOIN Parametros..CIEDiagnostico I on e.CodDiagnosticoProvisional = I.CodDiagnostico
			LEFT JOIN Parametros..CIEDiagnostico CI on e.CodDiagnosticoPrimero = CI.CodDiagnostico
			left join  Parametros..GuiasClinicas gc on  gc.CodGuia = e.IDProblemaSalud 
			left join  Parametros..GuiasClinicas gc1 on  gc1.CodGuia = e.CodSubProblema  
			LEFT JOIN Parametros..TecnicosDatos TD on TD.DNITecnico = e.NIF
			LEFT JOIN Parametros..Codigos Cod3 ON (e.PrioridadHosp = Cod3.Codigo and cod3.Tabla = 'EstTipoExamen')
			LEFT JOIN Parametros..MutuasSalud MS ON e.CodColectivo = MS.Codigo
			LEFT JOIN Parametros..MutuaPrincipal MP ON MS.CodMutua = MP.Codigo			
	where ((c.NoAtendido = 1 and c.Asiste = 1) or (c.Asiste = 0 and e.NoAsistenciasCita > 0))
			and p.CodPaciente = @spvar_codPaciente 
			and (@spvar_Nombre is null or PacNombre like (rtrim(@spvar_Nombre) + '%') )
			and (@spvar_Apell1 is null or PacApell1 like (rtrim(@spvar_Apell1) + '%') )
			and (@spvar_Apell2 is null or PacApell2 like (rtrim(@spvar_Apell2) + '%') )
			and (@spvar_CodServicio is null or e.CodServicioFinal = @spvar_CodServicio)
			and (@spvar_CodServicioRemite is null or e.CodServicioOrigen = @spvar_CodServicioRemite)
			and (@spvar_FecSolDesde is null or datediff(d, @spvar_FecSolDesde, e.FechaConsulta) >= 0)
			and (@spvar_FecSolHasta is null or datediff(d, @spvar_FecSolHasta, e.FechaConsulta) <= 0)
			and (@spvar_FecCita is null or datediff(d, @spvar_FecCita, e.FechaCPrimera) = 0)
			and (@spvar_FecCitaDesde is null or datediff(d, @spvar_FecCitaDesde, e.FechaCPrimera) >= 0)
			and (@spvar_FecCitaHasta is null or datediff(d, @spvar_FecCitaHasta, e.FechaCPrimera) <= 0)
			and (@spvar_CodCentro is null or e.CodCentroOrigen = @spvar_CodCentro)
			and (@spvar_CodTipoRemision is null or e.TipoRemision = @spvar_CodTipoRemision)
			and (@spvar_Prioridad is null or e.Solicitud = @spvar_Prioridad)
			and (@spvar_DniMedicoDestino is null or e.DniMedDestino = @spvar_DniMedicoDestino)
			and (@spvar_FechaPrevistaDesde is null or e.FechaPrevista >= @spvar_FechaPrevistaDesde)
			and (@spvar_FechaPrevistaHasta is null or e.FechaPrevista <= @spvar_FechaPrevistaHasta)
			and (@spvar_AUGE is null or e.IdGuiaClinica is not null)
			and (@spvar_CodColectivo is null or e.CodColectivo = @spvar_CodColectivo)
			and (@spvar_codCentroDestino is null or e.CodCentroFinal = @spvar_codCentroDestino)
			and (@spvar_idUnidad is null or e.IdUnidad = @spvar_idUnidad)
			and (@spvar_DniMedicoOrigen is null or e.DNIMedEpi = @spvar_DniMedicoOrigen)
			and ((@spvar_LibreEleccion is null and (e.LibreEleccion is null or e.LibreEleccion = 0) or (e.LibreEleccion = 1)))
			and (@spvar_ConfAsistencia = 0 or (@spvar_ConfAsistencia = 1 and C.ConfAsistencia = 1)) --V4.46 - 1024 - ECR
			and (@spvar_PRAIS is null 
				or 
				(@spvar_PRAIS = 1 and 
				EXISTS (select MS.EsPrais from 
				Hclinica..MutuasSaludSecPaciente MSSP 
				INNER JOIN parametros..MutuasSalud MS on MS.Codigo = MSSP.CodColectivo
				where codpaciente = e.CodPaciente and MS.EsPrais = 1))
				or 
				(@spvar_PRAIS = 0 and 
				NOT EXISTS (select MS.EsPrais from 
				Hclinica..MutuasSaludSecPaciente MSSP 
				INNER JOIN parametros..MutuasSalud MS on MS.Codigo = MSSP.CodColectivo
				where codpaciente = e.CodPaciente and MS.EsPrais = 1)))
						
END
ELSE
BEGIN
	if @spvar_Eliminadas = 1
	begin
		select	p.CodHistoria,
			p.CodPaciente,
			'PacNombre'= rtrim(p.PacNombre), 
			'PacApell1' = rtrim(p.PacApell1),
			'PacApell2' = rtrim(p.PacApell2),
			e.CodEpisodio,
			parametros.dbo.fnParFechaHoraUTC(e.FechaCPrimera) as FechaCPrimera____,
			C.ConfAsistencia,
			parametros.dbo.fnParFechaHoraUTC(e.FechaConsulta) as FechaConsulta____,
			e.DictamenClinico as Juicio,
			e.CodCentroFinal,
			s.Codigo, 
			s.DescServicio ServicioDestino,
			case when e.DerivacionSIC = 1 then se1.DescServicio else s1.DescServicio end as ServicioRemite,		
			null as Pasiva,
			e.Solicitud, 
			parametros.dbo.fnParFechaHoraUTC(e.FechaPrevista) as FechaPrevista____,
			case
				when 
					isnull(
							e.IdGuiaClinica,
							(
								select MIN (I.CodProblema)
								from 	(
											SELECT 
												  ipd.CodPaciente
												, ipd.CodEpisodio
												, ipd.CodProblema
												, ipd.CodSubProblema
												, ipd.CodDiagnostico
												, ipd.IDInformeIPD					
											FROM HClinica..InformeIPD ipd 
											union
											select 
												  tcGES.CodPaciente
												, tcGES.CodEpisodio
												, ipd.CodProblema
												, ipd.CodSubProblema
												, ipd.CodDiagnostico
												, tcGES.IDInformeIPD	
											FROM Hclinica..TrazabilidadCasoGES tcges 
												inner join hclinica..informeipd ipd on tcges.idinformeipd=ipd.idinformeipd 
										) I 
										inner join Parametros..CIEDiagnostico CIEDiag on I.CodDiagnostico=CIEDiag.CodDiagnostico
								WHERE I.CodPaciente=e.CodPaciente
								  and I.CodEpisodio=e.CodEpisodio		
							)
						  ) is null then 0
				else 1
			end as TieneGuia,
			DescMotivoPasiva as MotivoPasiva,
			e.CodColectivo,
			MP.Entidad + '-' + MS.Entidad  as Aseguradora,
			cs.HospitalRef,
			cs.DescCentro,	
			0 as noDerecho,
			null as codConsulta,
			null as fechaCita,
			null as idCita,
			null as CodTipoConsulta,
			null as CodigoServicio,
			null as confirmada,
			null as CodTipoConsulta2, 
			p.NumTarjSanitaria,
			e.comunicada,
			e.CodigoRYF,
			e.CodCentroOrigen,
			COALESCE(cs1.DescCentro,DOC.NomCentro) as DescCentroRef	
			,(select top 1 ID_Sidra from Parametros..[MotivosCitas] M where M.Codigo = e.IdMotivo) as IdMotivo,
			p.FecNac,
			RIGHT('00000000' + LTRIM (RTRIM(AHP.CodHistoriaPapel)),8 ) as CodHistoriaPapel,
			p.Genero,
			'Sexo' = COD.Descripcion,
			'RUT Profesional' = e.DniMedDestino,
			'Profesional' = PM.NomMedico + ' ' + PM.Apell1 + ' ' + PM.Apell2,
			'Citador' = COALESCE(PMcita.NomMedico, DEcita.NombreEnf, Acita.NomAdminis) + ' ' +
						COALESCE(PMcita.Apell1, DEcita.Apell1Enf, Acita.Apell1Administ) + ' ' +
						COALESCE(PMcita.Apell2, DEcita.Apell2Enf, Acita.Apell2Administ),
			'TipoConsulta' = TC.DescTipoCons,
			'Prioridad' = COD2.Descripcion	
		    ,e.Estado 
		    ,u.Descripcion as Unidad
			,p.DirTelf
			,'TiempoEspera' = DATEDIFF(DD, e.FechaConsulta, e.FechaBorrado) 
			,COD2.Posicion as OrdenPrioridad 
			,e.DerivacionSIC
			,c.Asiste as AsisteCita
			,c.CitaEspontanea 
			,c.HoraInicial as FechaInicial 
			,c.NoAtendido
			,null as FechaNoAtendida
			,e.NoAsistenciasCita
			, c.idOrigenCita 
			, O.DescOrigenCitas
			,p.Email
			,p.Direccion 
			,p.DirNum
			 ,p.CodPostal 
			 ,L.NomPoblacion  
			 ,p1.Nombre as Provincia
			,L.NomPoblacion as Localidad
			,p.telf2
			,isNull(p.TarjSanitariaResp,'') as RutTutor
			
			,IsNull(PMRemite.NomMedico , '') as NombreMedicoRemi
			,IsNull(PMRemite.Apell1 , '') as Apel1MedicoRemi
			,IsNull(PMRemite.Apell2 , '') as Apel2MEdicoRemi
			,IsNull(PMRemite.Nif , '') as RutMedicoRemi
			,I.DescDiagnostico
			,CI.DescDiagnostico as DescDiagnosProvi
			,e.inspecciones 
			,e.IDProblemaSalud
			,gc.DescGuia as descProblema
			,gc1.DescGuia as descSubProblema
			,isnull(PMcita.Nif,isnull(DEcita.Nif,isnull(TD.Nif,Acita.nif))) as Nif
			,e.IdCausaInterconsulta
			,e.DescCausaInterconsulta
			,e.comentarios
			,e.TipoRemision
			,e.motivo
			, null as FolioSigges
			,e.PrioridadHosp
			,Cod3.Posicion as OrdenPrioridadHosp
			,p.AtiendeAlNombre as NombreSocial
			,CASE WHEN 
			(
				EXISTS (select * from Hclinica..MutuasSaludSecPaciente MSSP 
				INNER JOIN parametros..MutuasSalud MS on MS.Codigo = MSSP.CodColectivo
				where codpaciente = e.CodPaciente and MS.EsPrais = 1)
			) THEN 1 ELSE 0 END AS EsPRAIS,
			'' as ProfesionalAtiende,
			p.Telf3,
			p.TelfFijoUFamiliar
			,e.RUNProfEgreso
			,e.NomProfEgreso
			,e.ObservacionEgreso
			,e.FechaBorrado as FechaCierre
		from	Consultas..EpisodioConsultasBorrados e with (nolock)
				inner join Hclinica..Pacientes p with (nolock) on p.CodPaciente = e.CodPaciente 
				left join Parametros..Servicios s with (nolock) on s.Codigo = e.CodServicioFinal
				left join Parametros..Servicios s1 with (nolock) on s1.Codigo = e.CodServicioOrigen
				left join Parametros..ServiciosExternos se1 with (nolock) on se1.Codigo = e.CodServicioOrigen
				left join Parametros..CentrosSalud cs with (nolock) on cs.CodCentro = e.CodCentroFinal
				left join Parametros..CentrosSalud cs1 with (nolock) on cs1.CodCentro = e.CodCentroOrigen
				left join Parametros..DatosOtrosCentros DOC with (nolock) on DOC.CodCent = e.CodCentroOrigen
				left join Hclinica..Citas C on e.CodPaciente = c.CodPaciente and e.CodEpisodio = C.CodEpisodio and c.CodTipoConsulta = 0 
							AND ( (e.FechaCPrimera IS NULL AND c.FechaEntrada = (SELECT MAX(c1.FechaEntrada) FROM Hclinica..Citas c1 WHERE c.codpaciente = c1.codpaciente AND c.codepisodio = c1.CodEpisodio AND c1.CodTipoConsulta=0)) 
														OR e.FechaCPrimera = C.FechaCita) 

				left join Hclinica..ArchivoHistoriasPapel AHP on AHP.CodPaciente = P.CodPaciente and AHP.CodCentro = cs.CodCentro
				left join Parametros..Codigos COD on COD.Codigo = p.Genero and Tabla = 'EstGenero'
				left join Parametros..ParametrosMedicos PM on PM.DNIMedico = e.DniMedDestino
				left join Parametros..ParametrosMedicos PMcita on PMcita.DNIMedico = e.NIF
				left join Parametros..DatosEnfermeras DEcita on DEcita.DNIEnf = e.NIF
				left join Parametros..Administrativo Acita on Acita.DNIAdminist = e.NIF				
				left join Parametros..TiposConsultas TC on TC.CodTipoCons = c.CodTipoConsulta and TC.CodClaseCons = c.CodTipoConsulta2 and TC.CodServCons = s.Codigo
				left join Parametros..Codigos COD2 on COD2.Codigo = e.Solicitud and COD2.Tabla = 'EstTipoExamen'
				left join Parametros..Unidad u on e.IdUnidad = u.IdUnidad
				left join Parametros..OrigenesCitas O on C.idOrigenCita = O.idOrigenCita
				LEFT JOIN parametros..DireccionLocalidad L ON p.DirCodLocalidad = L.CodPoblacion and p.dircodprov = l.codprovincia 		    
				LEFT JOIN parametros..codprovincias p1 on p1.codigo = p.dircodprov
				left join Parametros..ParametrosMedicos PMRemite on PMRemite.DNIMedico = e.DNIMedEpi
				LEFT JOIN Parametros..CIEDiagnostico I on e.CodDiagnosticoProvisional = I.CodDiagnostico
				LEFT JOIN Parametros..CIEDiagnostico CI on e.CodDiagnosticoPrimero = CI.CodDiagnostico
				left join  Parametros..GuiasClinicas gc on  gc.CodGuia = e.IDProblemaSalud 
				left join  Parametros..GuiasClinicas gc1 on  gc1.CodGuia = e.CodSubProblema  
				LEFT JOIN Parametros..TecnicosDatos TD on TD.DNITecnico = e.NIF
				LEFT JOIN Parametros..Codigos Cod3 ON (e.PrioridadHosp = Cod3.Codigo and cod3.Tabla = 'EstTipoExamen')
				LEFT JOIN Parametros..MutuasSalud MS ON e.CodColectivo = MS.Codigo
				LEFT JOIN Parametros..MutuaPrincipal MP ON MS.CodMutua = MP.Codigo			
		where	Asistido is null
				and p.CodPaciente = @spvar_codPaciente 
				and (@spvar_Nombre is null or PacNombre like (rtrim(@spvar_Nombre) + '%') )
				and (@spvar_Apell1 is null or PacApell1 like (rtrim(@spvar_Apell1) + '%') )
				and (@spvar_Apell2 is null or PacApell2 like (rtrim(@spvar_Apell2) + '%') )
				and (@spvar_CodServicio is null or e.CodServicioFinal = @spvar_CodServicio)
				and (@spvar_CodServicioRemite is null or e.CodServicioOrigen = @spvar_CodServicioRemite)
				and (@spvar_FecSolDesde is null or datediff(d, @spvar_FecSolDesde, e.FechaConsulta) >= 0)
				and (@spvar_FecSolHasta is null or datediff(d, @spvar_FecSolHasta, e.FechaConsulta) <= 0)
				and (@spvar_FecCita is null or datediff(d, @spvar_FecCita, e.FechaCPrimera) = 0)
				and (@spvar_FecCitaDesde is null or datediff(d, @spvar_FecCitaDesde, e.FechaCPrimera) >= 0)
				and (@spvar_FecCitaHasta is null or datediff(d, @spvar_FecCitaHasta, e.FechaCPrimera) <= 0)
				and (@spvar_CodCentro is null or e.CodCentroOrigen = @spvar_CodCentro)
				and (@spvar_CodTipoRemision is null or e.TipoRemision = @spvar_CodTipoRemision)
				and (@spvar_Prioridad is null or e.Solicitud = @spvar_Prioridad)
				and (@spvar_DniMedicoDestino is null or e.DniMedDestino = @spvar_DniMedicoDestino)
				and (@spvar_FechaPrevistaDesde is null or e.FechaPrevista >= @spvar_FechaPrevistaDesde)
				and (@spvar_FechaPrevistaHasta is null or e.FechaPrevista <= @spvar_FechaPrevistaHasta)
				and (@spvar_AUGE is null or e.IdGuiaClinica is not null)
				and (@spvar_CodColectivo is null or e.CodColectivo = @spvar_CodColectivo)
				and (@spvar_codCentroDestino is null or e.CodCentroFinal = @spvar_codCentroDestino)
				and (@spvar_idUnidad is null or e.IdUnidad = @spvar_idUnidad)
				and (@spvar_DniMedicoOrigen is null or e.DNIMedEpi = @spvar_DniMedicoOrigen)
				and ((@spvar_LibreEleccion is null and (e.LibreEleccion is null or e.LibreEleccion = 0) or (e.LibreEleccion = 1)))
				and (@spvar_ConfAsistencia = 0 or (@spvar_ConfAsistencia = 1 and C.ConfAsistencia = 1)) --V4.46 - 1024 - ECR
				and (@spvar_PRAIS is null
					or 
					(@spvar_PRAIS = 1 and 
					EXISTS (select MS.EsPrais from 
					Hclinica..MutuasSaludSecPaciente MSSP 
					INNER JOIN parametros..MutuasSalud MS on MS.Codigo = MSSP.CodColectivo
					where codpaciente = e.CodPaciente and MS.EsPrais = 1))
					or 
					(@spvar_PRAIS = 0 and 
					NOT EXISTS (select MS.EsPrais from 
					Hclinica..MutuasSaludSecPaciente MSSP 
					INNER JOIN parametros..MutuasSalud MS on MS.Codigo = MSSP.CodColectivo
					where codpaciente = e.CodPaciente and MS.EsPrais = 1)))
		union									
		select p.CodHistoria,
			p.CodPaciente,				
			'PacNombre'= rtrim(p.PacNombre), 
			'PacApell1' = rtrim(p.PacApell1),
			'PacApell2' = rtrim(p.PacApell2),
			e.CodEpisodio,
			parametros.dbo.fnParFechaHoraUTC(e.FechaCPrimera) as FechaCPrimera____,
			C.ConfAsistencia, 
			parametros.dbo.fnParFechaHoraUTC(e.FechaConsulta) as FechaConsulta____,
			e.DictamenClinico as Juicio,
			e.CodCentroFinal,
			s.Codigo, 
			s.DescServicio ServicioDestino,
			case when e.DerivacionSIC = 1 then se1.DescServicio else s1.DescServicio end as ServicioRemite,		
			null as Pasiva,
			e.Solicitud, 
			parametros.dbo.fnParFechaHoraUTC(e.FechaPrevista) as FechaPrevista____,
			case
				when 
					isnull(
							e.IdGuiaClinica,
							(
								select MIN (I.CodProblema)
								from 	(
											SELECT 
												  ipd.CodPaciente
												, ipd.CodEpisodio
												, ipd.CodProblema
												, ipd.CodSubProblema
												, ipd.CodDiagnostico
												, ipd.IDInformeIPD					
											FROM HClinica..InformeIPD ipd 
											union
											select 
												  tcGES.CodPaciente
												, tcGES.CodEpisodio
												, ipd.CodProblema
												, ipd.CodSubProblema
												, ipd.CodDiagnostico
												, tcGES.IDInformeIPD	
											FROM Hclinica..TrazabilidadCasoGES tcges 
												inner join hclinica..informeipd ipd on tcges.idinformeipd=ipd.idinformeipd 
										) I 
										inner join Parametros..CIEDiagnostico CIEDiag on I.CodDiagnostico=CIEDiag.CodDiagnostico
								WHERE I.CodPaciente=e.CodPaciente
								  and I.CodEpisodio=e.CodEpisodio		
							)
						  ) is null then 0
				else 1
			end as TieneGuia,
			(select top 1 M.Descripcion FROM Parametros..[MotivosCitas] M where M.Codigo = e.IdMotivo) as MotivoPasiva,
			e.CodColectivo,
			MP.Entidad + '-' + MS.Entidad as Aseguradora,
			cs.HospitalRef,
			cs.DescCentro,	
			0 as noDerecho,
			null as codConsulta,
			null as fechaCita,
			null as idCita,
			null as CodTipoConsulta,
			null as CodigoServicio,
			null as confirmada,
			null as CodTipoConsulta2, 
			p.NumTarjSanitaria,
			e.comunicada,
			e.CodigoRYF,
			e.CodCentroOrigen,
			COALESCE(cs1.DescCentro,DOC.NomCentro) as DescCentroRef
			,(select top 1 ID_Sidra from Parametros..[MotivosCitas] M where M.Codigo = e.IdMotivo) as IdMotivo,
			p.FecNac,
			RIGHT('00000000' + LTRIM (RTRIM(AHP.CodHistoriaPapel)),8 ) as CodHistoriaPapel,
			p.Genero,
			'Sexo' = COD.Descripcion,
			'RUT Profesional' = e.DniMedDestino,
			'Profesional' = PM.NomMedico + ' ' + PM.Apell1 + ' ' + PM.Apell2,
			'Citador' = COALESCE(PMcita.NomMedico, DEcita.NombreEnf, Acita.NomAdminis) + ' ' +
						COALESCE(PMcita.Apell1, DEcita.Apell1Enf, Acita.Apell1Administ) + ' ' +
						COALESCE(PMcita.Apell2, DEcita.Apell2Enf, Acita.Apell2Administ),
			'TipoConsulta' = TC.DescTipoCons,
			'Prioridad' = COD2.Descripcion	
		    ,e.Estado 
		    ,u.Descripcion as Unidad
			,p.DirTelf
			,'TiempoEspera' = DATEDIFF(DD, e.FechaConsulta, ISNULL(e.FechaInicial, GETDATE())) 
			,COD2.Posicion as OrdenPrioridad 
			,e.DerivacionSIC
			,c.Asiste as AsisteCita
			,c.CitaEspontanea 
			,c.HoraInicial as FechaInicial 
			,c.NoAtendido
			,null as FechaNoAtendida
			,e.NoAsistenciasCita
			, c.idOrigenCita 
			, O.DescOrigenCitas
			,p.Email
			,p.Direccion 
			,p.DirNum
			,p.CodPostal 
			,L.NomPoblacion  
			,p1.Nombre as Provincia
			,L.NomPoblacion as Localidad
			,p.telf2
			,isNull(p.TarjSanitariaResp,'') as RutTutor
			
			,IsNull(PMRemite.NomMedico , '') as NombreMedicoRemi
			,IsNull(PMRemite.Apell1 , '') as Apel1MedicoRemi
			,IsNull(PMRemite.Apell2 , '') as Apel2MEdicoRemi
			,IsNull(PMRemite.Nif , '') as RutMedicoRemi
			,I.DescDiagnostico
			,CI.DescDiagnostico as DescDiagnosProvi
			,e.inspecciones 
			,e.IDProblemaSalud
			,gc.DescGuia as descProblema
			,gc1.DescGuia as descSubProblema
			,isnull(PMcita.Nif,isnull(DEcita.Nif,isnull(TD.Nif,Acita.nif))) as Nif
			,e.IdCausaInterconsulta
			,e.DescCausaInterconsulta
			,e.comentarios
			,e.TipoRemision
			,e.motivo
			,e.FolioSigges
			,e.PrioridadHosp
			,Cod3.Posicion as OrdenPrioridadHosp
			,p.AtiendeAlNombre as NombreSocial
			,CASE WHEN 
			(
				EXISTS (select * from Hclinica..MutuasSaludSecPaciente MSSP 
				INNER JOIN parametros..MutuasSalud MS on MS.Codigo = MSSP.CodColectivo
				where codpaciente = e.CodPaciente and MS.EsPrais = 1)
			) THEN 1 ELSE 0 END AS EsPRAIS,
			'' as ProfesionalAtiende,
			p.Telf3,
			p.TelfFijoUFamiliar
			,e.RUNProfEgreso
			,e.NomProfEgreso
			,e.ObservacionEgreso
			,e.FechaCierre
		from	Consultas..EpisodioConsultas e with (nolock)
				inner join Hclinica..Pacientes p with (nolock) on p.CodPaciente = e.CodPaciente 
				left join Parametros..Servicios s with (nolock) on s.Codigo = e.CodServicioFinal
				left join Parametros..Servicios s1 with (nolock) on s1.Codigo = e.CodServicioOrigen
				left join Parametros..ServiciosExternos se1 with (nolock) on se1.Codigo = e.CodServicioOrigen
				left join Parametros..CentrosSalud cs with (nolock) on cs.CodCentro = e.CodCentroFinal
				left join Parametros..CentrosSalud cs1 with (nolock) on cs1.CodCentro = e.CodCentroOrigen
				left join Parametros..DatosOtrosCentros DOC with (nolock) on DOC.CodCent = e.CodCentroOrigen
				left join Hclinica..Citas C on e.CodPaciente = c.CodPaciente and e.CodEpisodio = C.CodEpisodio and c.CodTipoConsulta = 0 
										AND ( (e.FechaCPrimera IS NULL AND c.FechaEntrada = (SELECT MAX(c1.FechaEntrada) FROM Hclinica..Citas c1 WHERE c.codpaciente = c1.codpaciente AND c.codepisodio = c1.CodEpisodio AND c1.CodTipoConsulta=0)) 
														OR e.FechaCPrimera = C.FechaCita) 

				left join Hclinica..ArchivoHistoriasPapel AHP on AHP.CodPaciente = P.CodPaciente and AHP.CodCentro = cs.CodCentro
				left join Parametros..Codigos COD on COD.Codigo = p.Genero and Tabla = 'EstGenero'
				left join Parametros..ParametrosMedicos PM on PM.DNIMedico = e.DniMedDestino
				left join Parametros..ParametrosMedicos PMcita on PMcita.DNIMedico = e.NIF
				left join Parametros..DatosEnfermeras DEcita on DEcita.DNIEnf = e.NIF
				left join Parametros..Administrativo Acita on Acita.DNIAdminist = e.NIF				
				left join Parametros..TiposConsultas TC on TC.CodTipoCons = c.CodTipoConsulta and TC.CodClaseCons = c.CodTipoConsulta2 and TC.CodServCons = s.Codigo
				left join Parametros..Codigos COD2 on COD2.Codigo = e.Solicitud and COD2.Tabla = 'EstTipoExamen'
				left join Parametros..Unidad u on e.IdUnidad = u.IdUnidad
				left join Parametros..OrigenesCitas O on C.idOrigenCita = O.idOrigenCita
				LEFT JOIN parametros..DireccionLocalidad L ON p.DirCodLocalidad = L.CodPoblacion and p.dircodprov = l.codprovincia 		    
				LEFT JOIN parametros..codprovincias p1 on p1.codigo = p.dircodprov
				left join Parametros..ParametrosMedicos PMRemite on PMRemite.DNIMedico = e.DNIMedEpi
				LEFT JOIN Parametros..CIEDiagnostico I on e.CodDiagnosticoProvisional = I.CodDiagnostico
				LEFT JOIN Parametros..CIEDiagnostico CI on e.CodDiagnosticoPrimero = CI.CodDiagnostico
				left join  Parametros..GuiasClinicas gc on  gc.CodGuia = e.IDProblemaSalud 
				left join  Parametros..GuiasClinicas gc1 on  gc1.CodGuia = e.CodSubProblema  
				LEFT JOIN Parametros..TecnicosDatos TD on TD.DNITecnico = e.NIF
				LEFT JOIN Parametros..Codigos Cod3 ON (e.PrioridadHosp = Cod3.Codigo and cod3.Tabla = 'EstTipoExamen')
				LEFT JOIN Parametros..MutuasSalud MS ON e.CodColectivo = MS.Codigo
				LEFT JOIN Parametros..MutuaPrincipal MP ON MS.CodMutua = MP.Codigo							
		where	e.Estado = 'E'
				and p.CodPaciente = @spvar_codPaciente 
				and (@spvar_Nombre is null or PacNombre like (rtrim(@spvar_Nombre) + '%') )
				and (@spvar_Apell1 is null or PacApell1 like (rtrim(@spvar_Apell1) + '%') )
				and (@spvar_Apell2 is null or PacApell2 like (rtrim(@spvar_Apell2) + '%') )
				and (@spvar_CodServicio is null or e.CodServicioFinal = @spvar_CodServicio)
				and (@spvar_CodServicioRemite is null or e.CodServicioOrigen = @spvar_CodServicioRemite)
				and (@spvar_FecSolDesde is null or datediff(d, @spvar_FecSolDesde, e.FechaConsulta) >= 0)
				and (@spvar_FecSolHasta is null or datediff(d, @spvar_FecSolHasta, e.FechaConsulta) <= 0)
				and (@spvar_FecCita is null or datediff(d, @spvar_FecCita, e.FechaCPrimera) = 0)
				and (@spvar_FecCitaDesde is null or datediff(d, @spvar_FecCitaDesde, e.FechaCPrimera) >= 0)
				and (@spvar_FecCitaHasta is null or datediff(d, @spvar_FecCitaHasta, e.FechaCPrimera) <= 0)
				and (@spvar_CodCentro is null or e.CodCentroOrigen = @spvar_CodCentro)
				and (@spvar_CodTipoRemision is null or e.TipoRemision = @spvar_CodTipoRemision)
				and (@spvar_Prioridad is null or e.Solicitud = @spvar_Prioridad)
				and (@spvar_DniMedicoDestino is null or e.DniMedDestino = @spvar_DniMedicoDestino)
				and (@spvar_FechaPrevistaDesde is null or e.FechaPrevista >= @spvar_FechaPrevistaDesde)
				and (@spvar_FechaPrevistaHasta is null or e.FechaPrevista <= @spvar_FechaPrevistaHasta)
				and (@spvar_AUGE is null or e.IdGuiaClinica is not null)
				and (@spvar_CodColectivo is null or e.CodColectivo = @spvar_CodColectivo)
				and (@spvar_codCentroDestino is null or e.CodCentroFinal = @spvar_codCentroDestino)
				and (@spvar_idUnidad is null or e.IdUnidad = @spvar_idUnidad)
				and (@spvar_DniMedicoOrigen is null or e.DNIMedEpi = @spvar_DniMedicoOrigen)
				and ((@spvar_LibreEleccion is null and (e.LibreEleccion is null or e.LibreEleccion = 0) or (e.LibreEleccion = 1)))
				and (@spvar_ConfAsistencia = 0 or (@spvar_ConfAsistencia = 1 and C.ConfAsistencia = 1)) 
				and (@spvar_PRAIS is null
					or 
					(@spvar_PRAIS = 1 and 
					EXISTS (select MS.EsPrais from 
					Hclinica..MutuasSaludSecPaciente MSSP 
					INNER JOIN parametros..MutuasSalud MS on MS.Codigo = MSSP.CodColectivo
					where codpaciente = e.CodPaciente and MS.EsPrais = 1))
					or 
					(@spvar_PRAIS = 0 and 
					NOT EXISTS (select MS.EsPrais from 
					Hclinica..MutuasSaludSecPaciente MSSP 
					INNER JOIN parametros..MutuasSalud MS on MS.Codigo = MSSP.CodColectivo
					where codpaciente = e.CodPaciente and MS.EsPrais = 1)))
	end
else
	begin
		if @spvar_Rechazadas = 1
		begin
			select	p.CodHistoria,
					p.CodPaciente,
					'PacNombre'= rtrim(p.PacNombre), 
					'PacApell1' = rtrim(p.PacApell1),
					'PacApell2' = rtrim(p.PacApell2),
					e.CodEpisodio,
					parametros.dbo.fnParFechaHoraUTC(e.FechaCPrimera) as FechaCPrimera____,
					C.ConfAsistencia, 
					parametros.dbo.fnParFechaHoraUTC(e.FechaConsulta) as FechaConsulta____,
					e.DictamenClinico as Juicio,
					e.CodCentroFinal,
					s.Codigo, 
					s.DescServicio ServicioDestino,
					case when e.DerivacionSIC = 1 then se1.DescServicio else s1.DescServicio end as ServicioRemite,		
					'2' as Pasiva,
					e.Solicitud, 
					parametros.dbo.fnParFechaHoraUTC(e.FechaPrevista) as FechaPrevista____,
					case
						when 
							isnull(
									e.IdGuiaClinica,
									(
										select MIN (I.CodProblema)
										from 	(
													SELECT 
														  ipd.CodPaciente
														, ipd.CodEpisodio
														, ipd.CodProblema
														, ipd.CodSubProblema
														, ipd.CodDiagnostico
														, ipd.IDInformeIPD					
													FROM HClinica..InformeIPD ipd 
													union
													select 
														  tcGES.CodPaciente
														, tcGES.CodEpisodio
														, ipd.CodProblema
														, ipd.CodSubProblema
														, ipd.CodDiagnostico
														, tcGES.IDInformeIPD	
													FROM Hclinica..TrazabilidadCasoGES tcges 
														inner join hclinica..informeipd ipd on tcges.idinformeipd=ipd.idinformeipd 
												) I 
												inner join Parametros..CIEDiagnostico CIEDiag on I.CodDiagnostico=CIEDiag.CodDiagnostico
										WHERE I.CodPaciente=e.CodPaciente
										  and I.CodEpisodio=e.CodEpisodio		
									)
								  ) is null then 0
						else 1
					end as TieneGuia,				
					DescMotivoPasiva as MotivoPasiva,
					e.CodColectivo,
					MP.Entidad + '-' + MS.Entidad as Aseguradora,
					cs.HospitalRef,
					cs.DescCentro,	
					0 as noDerecho,
					null as codConsulta,
					null as fechaCita,
					null as idCita,
					null as CodTipoConsulta,
					null as CodigoServicio,
					null as confirmada,
					null as CodTipoConsulta2, 
				    p.NumTarjSanitaria,
				    e.comunicada,
				    e.CodigoRYF,
					e.CodCentroOrigen,
					COALESCE(cs1.DescCentro,DOC.NomCentro) as DescCentroRef	
					,(select top 1 ID_Sidra from Parametros..[MotivosCitas] M where M.Codigo = e.IdMotivo) as IdMotivo,
					p.FecNac,				
					RIGHT('00000000' + LTRIM (RTRIM(AHP.CodHistoriaPapel)),8 ) as CodHistoriaPapel,
					p.Genero,
					'Sexo' = COD.Descripcion,
					'RUT Profesional' = e.DniMedDestino,
					'Profesional' = PM.NomMedico + ' ' + PM.Apell1 + ' ' + PM.Apell2,
					'Citador' = COALESCE(PMcita.NomMedico, DEcita.NombreEnf, Acita.NomAdminis) + ' ' +
								COALESCE(PMcita.Apell1, DEcita.Apell1Enf, Acita.Apell1Administ) + ' ' +
								COALESCE(PMcita.Apell2, DEcita.Apell2Enf, Acita.Apell2Administ),
					'TipoConsulta' = TC.DescTipoCons,
					'Prioridad' = COD2.Descripcion	
					,e.Estado 
					,u.Descripcion as Unidad 
					,p.DirTelf
					,'TiempoEspera' = DATEDIFF(DD, e.FechaConsulta, e.FechaBorrado) 
					,COD2.Posicion as OrdenPrioridad 
					,e.DerivacionSIC
					,c.Asiste as AsisteCita
					,c.CitaEspontanea 
					,c.HoraInicial as FechaInicial 
					,c.NoAtendido
					,null as FechaNoAtendida
					,e.NoAsistenciasCita
					, c.idOrigenCita 
					, O.DescOrigenCitas
					,p.Email
					,p.Direccion 
					,p.DirNum
					 ,p.CodPostal 
					 ,L.NomPoblacion  
					 ,p1.Nombre as Provincia
					,L.NomPoblacion as Localidad
					,p.telf2
					,isNull(p.TarjSanitariaResp,'') as RutTutor
					
					,IsNull(PMRemite.NomMedico , '') as NombreMedicoRemi
					,IsNull(PMRemite.Apell1 , '') as Apel1MedicoRemi
					,IsNull(PMRemite.Apell2 , '') as Apel2MEdicoRemi
					,IsNull(PMRemite.Nif , '') as RutMedicoRemi
					,I.DescDiagnostico
					,CI.DescDiagnostico as DescDiagnosProvi
					,e.inspecciones 
					,e.IDProblemaSalud
					,gc.DescGuia as descProblema
					,gc1.DescGuia as descSubProblema
					,isnull(PMcita.Nif,isnull(DEcita.Nif,isnull(TD.Nif,Acita.nif))) as Nif
					,e.IdCausaInterconsulta
					,e.DescCausaInterconsulta
					,e.comentarios
					,e.TipoRemision
					,e.motivo
					, null as FolioSigges
					,e.PrioridadHosp
					,Cod3.Posicion as OrdenPrioridadHosp
					,p.AtiendeAlNombre as NombreSocial
					,CASE WHEN 
					(
						EXISTS (select * from Hclinica..MutuasSaludSecPaciente MSSP 
						INNER JOIN parametros..MutuasSalud MS on MS.Codigo = MSSP.CodColectivo
						where codpaciente = e.CodPaciente and MS.EsPrais = 1)
					) THEN 1 ELSE 0 END AS EsPRAIS,
					'' as ProfesionalAtiende,
					p.Telf3,
					p.TelfFijoUFamiliar	
					,e.RUNProfEgreso
					,e.NomProfEgreso
					,e.ObservacionEgreso	
					,e.FechaBorrado	 as FechaCierre
			from	Consultas..EpisodioConsultasBorrados e with (nolock)
					inner join Hclinica..Pacientes p with (nolock) on p.CodPaciente = e.CodPaciente --v4.42 - MAIPU CHC4019
					left join Parametros..Servicios s with (nolock) on s.Codigo = e.CodServicioFinal
					left join Parametros..Servicios s1 with (nolock) on s1.Codigo = e.CodServicioOrigen
					left join Parametros..ServiciosExternos se1 with (nolock) on se1.Codigo = e.CodServicioOrigen
					left join Parametros..CentrosSalud cs with (nolock) on cs.CodCentro = e.CodCentroFinal
					left join Parametros..CentrosSalud cs1 with (nolock) on cs1.CodCentro = e.CodCentroOrigen
					left join Parametros..DatosOtrosCentros DOC with (nolock) on DOC.CodCent = e.CodCentroOrigen
					left join Parametros..DatosOtrosCentros do with (nolock) on do.CodCent = e.CodCentroFinal
				    left join Hclinica..Citas C on e.CodPaciente = c.CodPaciente and e.CodEpisodio = C.CodEpisodio and c.CodTipoConsulta = 0 
							AND ( (e.FechaCPrimera IS NULL AND c.FechaEntrada = (SELECT MAX(c1.FechaEntrada) FROM Hclinica..Citas c1 WHERE c.codpaciente = c1.codpaciente AND c.codepisodio = c1.CodEpisodio AND c1.CodTipoConsulta=0)) 
														OR e.FechaCPrimera = C.FechaCita)

					left join Hclinica..ArchivoHistoriasPapel AHP on AHP.CodPaciente = P.CodPaciente and AHP.CodCentro = cs.CodCentro
					left join Parametros..Codigos COD on COD.Codigo = p.Genero and Tabla = 'EstGenero'
					left join Parametros..ParametrosMedicos PM on PM.DNIMedico = e.DniMedDestino
					left join Parametros..ParametrosMedicos PMcita on PMcita.DNIMedico = e.NIF
					left join Parametros..DatosEnfermeras DEcita on DEcita.DNIEnf = e.NIF
					left join Parametros..Administrativo Acita on Acita.DNIAdminist = e.NIF				
					left join Parametros..TiposConsultas TC on TC.CodTipoCons = c.CodTipoConsulta and TC.CodClaseCons = c.CodTipoConsulta2 and TC.CodServCons = s.Codigo
					left join Parametros..Codigos COD2 on COD2.Codigo = e.Solicitud and COD2.Tabla = 'EstTipoExamen'	
					left join Parametros..Unidad u on e.IdUnidad = u.IdUnidad 
					left join Parametros..OrigenesCitas O on C.idOrigenCita = O.idOrigenCita
					LEFT JOIN parametros..DireccionLocalidad L ON p.DirCodLocalidad = L.CodPoblacion and p.dircodprov = l.codprovincia 		    
					LEFT JOIN parametros..codprovincias p1 on p1.codigo = p.dircodprov
					left join Parametros..ParametrosMedicos PMRemite on PMRemite.DNIMedico = e.DNIMedEpi
					LEFT JOIN Parametros..CIEDiagnostico I on e.CodDiagnosticoProvisional = I.CodDiagnostico
					LEFT JOIN Parametros..CIEDiagnostico CI on e.CodDiagnosticoPrimero = CI.CodDiagnostico
					left join  Parametros..GuiasClinicas gc on  gc.CodGuia = e.IDProblemaSalud 
					left join  Parametros..GuiasClinicas gc1 on  gc1.CodGuia = e.CodSubProblema  
					LEFT JOIN Parametros..TecnicosDatos TD on TD.DNITecnico = e.NIF
					LEFT JOIN Parametros..Codigos Cod3 ON (e.PrioridadHosp = Cod3.Codigo and cod3.Tabla = 'EstTipoExamen')
				    LEFT JOIN Parametros..MutuasSalud MS ON e.CodColectivo = MS.Codigo
				    LEFT JOIN Parametros..MutuaPrincipal MP ON MS.CodMutua = MP.Codigo
			where	Asistido = 'R'
					and p.CodPaciente = @spvar_codPaciente --v4.42 - MAIPU CHC4019
					and (@spvar_Nombre is null or PacNombre like (rtrim(@spvar_Nombre) + '%') )
					and (@spvar_Apell1 is null or PacApell1 like (rtrim(@spvar_Apell1) + '%') )
					and (@spvar_Apell2 is null or PacApell2 like (rtrim(@spvar_Apell2) + '%') )
					and (@spvar_CodServicio is null or e.CodServicioFinal = @spvar_CodServicio)
					and (@spvar_CodServicioRemite is null or e.CodServicioOrigen = @spvar_CodServicioRemite)
					and (@spvar_FecSolDesde is null or datediff(d, @spvar_FecSolDesde, e.FechaConsulta) >= 0)
					and (@spvar_FecSolHasta is null or datediff(d, @spvar_FecSolHasta, e.FechaConsulta) <= 0)
					and (@spvar_FecCita is null or datediff(d, @spvar_FecCita, e.FechaCPrimera) = 0)
					and (@spvar_FecCitaDesde is null or datediff(d, @spvar_FecCitaDesde, e.FechaCPrimera) >= 0)
					and (@spvar_FecCitaHasta is null or datediff(d, @spvar_FecCitaHasta, e.FechaCPrimera) <= 0)
					and (@spvar_CodCentro is null or e.CodCentroOrigen = @spvar_CodCentro)
					and (@spvar_CodTipoRemision is null or e.TipoRemision = @spvar_CodTipoRemision)
					and (@spvar_Prioridad is null or e.Solicitud = @spvar_Prioridad)
					and (@spvar_DniMedicoDestino is null or e.DniMedDestino = @spvar_DniMedicoDestino)
					and (@spvar_FechaPrevistaDesde is null or e.FechaPrevista >= @spvar_FechaPrevistaDesde)
					and (@spvar_FechaPrevistaHasta is null or e.FechaPrevista <= @spvar_FechaPrevistaHasta)
					and (@spvar_AUGE is null or e.IdGuiaClinica is not null)
					and (@spvar_CodColectivo is null or e.CodColectivo = @spvar_CodColectivo)
					and (@spvar_codCentroDestino is null or e.CodCentroFinal = @spvar_codCentroDestino)
					and (@spvar_FecRecDesde is null or datediff(d, @spvar_FecRecDesde, e.FechaBorrado) >= 0)
					and (@spvar_FecRecHasta is null or datediff(d, @spvar_FecRecHasta, e.FechaBorrado) <= 0)
					and (@spvar_idUnidad is null or e.IdUnidad = @spvar_idUnidad)
					and (@spvar_DniMedicoOrigen is null or e.DNIMedEpi = @spvar_DniMedicoOrigen)
					and ((@spvar_LibreEleccion is null and (e.LibreEleccion is null or e.LibreEleccion = 0) or (e.LibreEleccion = 1)))
					and (@spvar_ConfAsistencia = 0 or (@spvar_ConfAsistencia = 1 and C.ConfAsistencia = 1)) --V4.46 - 1024 - ECR
					and (@spvar_PRAIS is null
						or 
						(@spvar_PRAIS = 1 and 
						EXISTS (select MS.EsPrais from 
						Hclinica..MutuasSaludSecPaciente MSSP 
						INNER JOIN parametros..MutuasSalud MS on MS.Codigo = MSSP.CodColectivo
						where codpaciente = e.CodPaciente and MS.EsPrais = 1))
						or 
						(@spvar_PRAIS = 0 and 
						NOT EXISTS (select MS.EsPrais from 
						Hclinica..MutuasSaludSecPaciente MSSP 
						INNER JOIN parametros..MutuasSalud MS on MS.Codigo = MSSP.CodColectivo
						where codpaciente = e.CodPaciente and MS.EsPrais = 1)))
		end
	else
		begin
			if @spvar_Reservadas = 1 or @spvar_Confirmadas = 1
			begin
			--Busca las propuestas normales
			select	p.CodHistoria,
					p.CodPaciente,
					'PacNombre'= rtrim(p.PacNombre), 
					'PacApell1' = rtrim(p.PacApell1),
					'PacApell2' = rtrim(p.PacApell2),
					e.CodEpisodio,
					parametros.dbo.fnParFechaHoraUTC(e.FechaCPrimera) as FechaCPrimera____,
					c.ConfAsistencia, 
					parametros.dbo.fnParFechaHoraUTC(e.FechaConsulta) as FechaConsulta____,
					e.DictamenClinico as Juicio,
					e.CodCentroFinal,
					s.Codigo, 
					s.DescServicio ServicioDestino,
					case when e.DerivacionSIC = 1 then se1.DescServicio else s1.DescServicio end as ServicioRemite,		
					'0' as Pasiva,
					e.Solicitud, 
					parametros.dbo.fnParFechaHoraUTC(e.FechaPrevista) as FechaPrevista____,
					case
						when 
							isnull(
									e.IdGuiaClinica,
									(
										select MIN (I.CodProblema)
										from 	(
													SELECT 
														  ipd.CodPaciente
														, ipd.CodEpisodio
														, ipd.CodProblema
														, ipd.CodSubProblema
														, ipd.CodDiagnostico
														, ipd.IDInformeIPD					
													FROM HClinica..InformeIPD ipd 
													union
													select 
														  tcGES.CodPaciente
														, tcGES.CodEpisodio
														, ipd.CodProblema
														, ipd.CodSubProblema
														, ipd.CodDiagnostico
														, tcGES.IDInformeIPD	
													FROM Hclinica..TrazabilidadCasoGES tcges 
														inner join hclinica..informeipd ipd on tcges.idinformeipd=ipd.idinformeipd 
												) I 
												inner join Parametros..CIEDiagnostico CIEDiag on I.CodDiagnostico=CIEDiag.CodDiagnostico
										WHERE I.CodPaciente=e.CodPaciente
										  and I.CodEpisodio=e.CodEpisodio		
									)
								  ) is null then 0
						else 1
					end as TieneGuia,					
					'' as MotivoPasiva,
					e.CodColectivo,
					MP.Entidad + '-' + MS.Entidad  as Aseguradora,
					cs.HospitalRef,
					cs.DescCentro,	
					c.NoDerecho,
					c.CodConsulta,
					parametros.dbo.fnParFechaHoraUTC(c.FechaCita) as FechaCita____,
					c.IdCita,
					c.CodTipoConsulta,
					c.CodigoServicio,
					c.CodTipoConsulta2,
					e.confirmada,
					p.NumTarjSanitaria,
					e.comunicada,
					e.CodigoRYF,
					e.CodCentroOrigen,
					COALESCE(cs1.DescCentro,DOC.NomCentro) as DescCentroRef	
					, '' IdMotivo,
					p.FecNac,				
					RIGHT('00000000' + LTRIM (RTRIM(AHP.CodHistoriaPapel)),8 ) as CodHistoriaPapel,
					p.Genero,
					'Sexo' = COD.Descripcion,
					'RUT Profesional' = e.DniMedDestino,
					'Profesional' = PM.NomMedico + ' ' + PM.Apell1 + ' ' + PM.Apell2,
					'Citador' = COALESCE(PMcita.NomMedico, DEcita.NombreEnf, Acita.NomAdminis) + ' ' +
								COALESCE(PMcita.Apell1, DEcita.Apell1Enf, Acita.Apell1Administ) + ' ' +
								COALESCE(PMcita.Apell2, DEcita.Apell2Enf, Acita.Apell2Administ),
					'TipoConsulta' = TC.DescTipoCons,
					'Prioridad' = COD2.Descripcion	
					,e.Estado 
					,u.Descripcion as Unidad 
					,p.DirTelf
					,'TiempoEspera' = DATEDIFF(DD, e.FechaConsulta, ISNULL(e.FechaInicial, GETDATE())) 
					,COD2.Posicion as OrdenPrioridad 
					,e.DerivacionSIC
					,c.Asiste as AsisteCita
					,c.CitaEspontanea 
					,c.HoraInicial as FechaInicial 
					,c.NoAtendido
					,null as FechaNoAtendida
					,e.NoAsistenciasCita
					, c.idOrigenCita 
					, O.DescOrigenCitas
					,p.Email
					,p.Direccion 
					,p.DirNum
					 ,p.CodPostal 
					 ,L.NomPoblacion  
					 ,p1.Nombre as Provincia
					,L.NomPoblacion as Localidad
					,p.telf2
					,isNull(p.TarjSanitariaResp,'') as RutTutor
					
					,IsNull(PMRemite.NomMedico , '') as NombreMedicoRemi
					,IsNull(PMRemite.Apell1 , '') as Apel1MedicoRemi
					,IsNull(PMRemite.Apell2 , '') as Apel2MEdicoRemi
					,IsNull(PMRemite.Nif , '') as RutMedicoRemi
					,I.DescDiagnostico
					,CI.DescDiagnostico as DescDiagnosProvi
					,e.inspecciones 
					,e.IDProblemaSalud
					,gc.DescGuia as descProblema
					,gc1.DescGuia as descSubProblema
					,isnull(PMcita.Nif,isnull(DEcita.Nif,isnull(TD.Nif,Acita.nif))) as Nif
					,e.IdCausaInterconsulta
					,e.DescCausaInterconsulta
					,e.comentarios
					,e.TipoRemision
					,e.motivo
					,e.FolioSigges
					,e.PrioridadHosp
					,Cod3.Posicion as OrdenPrioridadHosp
					,p.AtiendeAlNombre as NombreSocial
					,CASE WHEN 
					(
						EXISTS (select * from Hclinica..MutuasSaludSecPaciente MSSP 
						INNER JOIN parametros..MutuasSalud MS on MS.Codigo = MSSP.CodColectivo
						where codpaciente = e.CodPaciente and MS.EsPrais = 1)
					) THEN 1 ELSE 0 END AS EsPRAIS,
					'' as ProfesionalAtiende,
					p.Telf3,
					p.TelfFijoUFamiliar
					,e.RUNProfEgreso
					,e.NomProfEgreso
					,e.ObservacionEgreso
					,e.FechaCierre
			from	Consultas..EpisodioConsultas e with (nolock)
					inner join Hclinica..Pacientes p with (nolock) on p.CodPaciente = e.CodPaciente 
					left join Parametros..Servicios s with (nolock) on s.Codigo = e.CodServicioFinal
					left join Parametros..Servicios s1 with (nolock) on s1.Codigo = e.CodServicioOrigen
					left join Parametros..ServiciosExternos se1 with (nolock) on se1.Codigo = e.CodServicioOrigen
					left join Parametros..CentrosSalud cs with (nolock) on cs.CodCentro = e.CodCentroFinal
					left join Parametros..CentrosSalud cs1 with (nolock) on cs1.CodCentro = e.CodCentroOrigen
					left join parametros..DatosOtrosCentros DOC with (nolock) on DOC.CodCent = e.CodCentroOrigen
					left join Hclinica..Citas c with (nolock) on c.CodPaciente = e.CodPaciente and c.codepisodio = e.CodEpisodio and c.CodTipoConsulta = 0 
							AND ( (e.FechaCPrimera IS NULL AND c.FechaEntrada = (SELECT MAX(c1.FechaEntrada) FROM Hclinica..Citas c1 WHERE c.codpaciente = c1.codpaciente AND c.codepisodio = c1.CodEpisodio AND c1.CodTipoConsulta=0)) 
														OR e.FechaCPrimera = C.FechaCita) 

					left join Hclinica..ArchivoHistoriasPapel AHP on AHP.CodPaciente = P.CodPaciente and AHP.CodCentro = cs.CodCentro
					left join Parametros..Codigos COD on COD.Codigo = p.Genero and Tabla = 'EstGenero'
					left join Parametros..ParametrosMedicos PM on PM.DNIMedico = e.DniMedDestino
					left join Parametros..ParametrosMedicos PMcita on PMcita.DNIMedico = e.NIF
					left join Parametros..DatosEnfermeras DEcita on DEcita.DNIEnf = e.NIF
					left join Parametros..Administrativo Acita on Acita.DNIAdminist = e.NIF				
					left join Parametros..TiposConsultas TC on TC.CodTipoCons = c.CodTipoConsulta and TC.CodClaseCons = c.CodTipoConsulta2 and TC.CodServCons = s.Codigo
					left join Parametros..Codigos COD2 on COD2.Codigo = e.Solicitud and COD2.Tabla = 'EstTipoExamen'
					left join Parametros..Unidad u on e.IdUnidad = u.IdUnidad 
					Left join Parametros..OrigenesCitas O on c.idOrigenCita = O.idOrigenCita
					LEFT JOIN parametros..DireccionLocalidad L ON p.DirCodLocalidad = L.CodPoblacion and p.dircodprov = l.codprovincia 		    
					LEFT JOIN parametros..codprovincias p1 on p1.codigo = p.dircodprov
					left join Parametros..ParametrosMedicos PMRemite on PMRemite.DNIMedico = e.DNIMedEpi
					LEFT JOIN Parametros..CIEDiagnostico I on e.CodDiagnosticoProvisional = I.CodDiagnostico
					LEFT JOIN Parametros..CIEDiagnostico CI on e.CodDiagnosticoPrimero = CI.CodDiagnostico
					left join  Parametros..GuiasClinicas gc on  gc.CodGuia = e.IDProblemaSalud 
					left join  Parametros..GuiasClinicas gc1 on  gc1.CodGuia = e.CodSubProblema  
					LEFT JOIN Parametros..TecnicosDatos TD on TD.DNITecnico = e.NIF
					LEFT JOIN Parametros..Codigos Cod3 ON (e.PrioridadHosp = Cod3.Codigo and cod3.Tabla = 'EstTipoExamen')
					LEFT JOIN Parametros..MutuasSalud MS ON e.CodColectivo = MS.Codigo
					LEFT JOIN Parametros..MutuaPrincipal MP ON MS.CodMutua = MP.Codigo				
			where	(@spvar_Nombre is null or PacNombre like (rtrim(@spvar_Nombre) + '%') )
			        and p.codpaciente = @spvar_codPaciente --v4.42 - MAIPU CHC4019
					and (@spvar_Apell1 is null or PacApell1 like (rtrim(@spvar_Apell1) + '%') )
					and (@spvar_Apell2 is null or PacApell2 like (rtrim(@spvar_Apell2) + '%') )
					and (@spvar_CodServicio is null or e.CodServicioFinal = @spvar_CodServicio)
					and (@spvar_CodServicioRemite is null or e.CodServicioOrigen = @spvar_CodServicioRemite)
					and (@spvar_FecSolDesde is null or datediff(d, @spvar_FecSolDesde, e.FechaConsulta) >= 0)
					and (@spvar_FecSolHasta is null or datediff(d, @spvar_FecSolHasta, e.FechaConsulta) <= 0)
					and (@spvar_FecCita is null or datediff(d, @spvar_FecCita, e.FechaCPrimera) = 0)
					and (@spvar_FecCitaDesde is null or datediff(d, @spvar_FecCitaDesde, e.FechaCPrimera) >= 0)
					and (@spvar_FecCitaHasta is null or datediff(d, @spvar_FecCitaHasta, e.FechaCPrimera) <= 0)
					and (@spvar_CodCentro is null or e.CodCentroOrigen = @spvar_CodCentro)
					and (@spvar_CodTipoRemision is null or e.TipoRemision = @spvar_CodTipoRemision)
					and (@spvar_Prioridad is null or e.Solicitud = @spvar_Prioridad)
					and (@spvar_DniMedicoDestino is null or e.DniMedDestino = @spvar_DniMedicoDestino)
					and (@spvar_Citados = '0' or (@spvar_Citados = '1' and e.FechaCPrimera is not null))

                    and (@spvar_NoCitados = '0' or (@spvar_NoCitados = '1' and e.FechaCPrimera is null and e.confirmada = '1'))
					and (@spvar_FechaPrevistaDesde is null or e.FechaPrevista >= @spvar_FechaPrevistaDesde)
					and (@spvar_FechaPrevistaHasta is null or e.FechaPrevista <= @spvar_FechaPrevistaHasta)
					and (@spvar_AUGE is null or e.IdGuiaClinica is not null)
					and (@spvar_CodColectivo is null or e.CodColectivo = @spvar_CodColectivo)
					and (@spvar_codCentroDestino is null or e.CodCentroFinal = @spvar_codCentroDestino)
					and (@spvar_Reservadas = '0' or (@spvar_Reservadas = '1' and e.FechaCPrimera = c.FechaCita and c.NoDerecho = 1 ))					
					and (@spvar_Confirmadas = '0' or (@spvar_Confirmadas = '1' and e.FechaCPrimera = c.FechaCita and (c.NoDerecho = 0 or c.NoDerecho is null)))
					and (@spvar_idUnidad is null or e.IdUnidad = @spvar_idUnidad)
					and (@spvar_DniMedicoOrigen is null or e.DNIMedEpi = @spvar_DniMedicoOrigen)
					and ((@spvar_LibreEleccion is null and (e.LibreEleccion is null or e.LibreEleccion = 0) or (e.LibreEleccion = 1)))
					and (@spvar_ConfAsistencia = 0 or (@spvar_ConfAsistencia = 1 and c.ConfAsistencia = 1)) --V4.46 - 1024 - ECR
					and (@spvar_PRAIS is null
						or 
						(@spvar_PRAIS = 1 and 
						EXISTS (select MS.EsPrais from 
						Hclinica..MutuasSaludSecPaciente MSSP 
						INNER JOIN parametros..MutuasSalud MS on MS.Codigo = MSSP.CodColectivo
						where codpaciente = e.CodPaciente and MS.EsPrais = 1))
						or 
						(@spvar_PRAIS = 0 and 
						NOT EXISTS (select MS.EsPrais from 
						Hclinica..MutuasSaludSecPaciente MSSP 
						INNER JOIN parametros..MutuasSalud MS on MS.Codigo = MSSP.CodColectivo
						where codpaciente = e.CodPaciente and MS.EsPrais = 1)))

			end
		else
			begin
				if @spvar_Atendidas = 1
				begin
					select	p.CodHistoria,
					p.CodPaciente,
					'PacNombre'= rtrim(p.PacNombre), 
					'PacApell1' = rtrim(p.PacApell1),
					'PacApell2' = rtrim(p.PacApell2),
					e.CodEpisodio,
					parametros.dbo.fnParFechaHoraUTC(e.FechaCPrimera) as FechaCPrimera____,
					c.ConfAsistencia, 
					parametros.dbo.fnParFechaHoraUTC(e.FechaConsulta) as FechaConsulta____,
					e.DictamenClinico as Juicio,
					e.CodCentroFinal,
					s.Codigo, 
					s.DescServicio ServicioDestino,
					case when e.DerivacionSIC = 1 then se1.DescServicio else s1.DescServicio end as ServicioRemite,		
					'0' as Pasiva,
					e.Solicitud, 
					parametros.dbo.fnParFechaHoraUTC(e.FechaPrevista) as FechaPrevista____,
					case
						when 
							isnull(
									e.IdGuiaClinica,
									(
										select MIN (I.CodProblema)
										from 	(
													SELECT 
														  ipd.CodPaciente
														, ipd.CodEpisodio
														, ipd.CodProblema
														, ipd.CodSubProblema
														, ipd.CodDiagnostico
														, ipd.IDInformeIPD					
													FROM HClinica..InformeIPD ipd 
													union
													select 
														  tcGES.CodPaciente
														, tcGES.CodEpisodio
														, ipd.CodProblema
														, ipd.CodSubProblema
														, ipd.CodDiagnostico
														, tcGES.IDInformeIPD	
													FROM Hclinica..TrazabilidadCasoGES tcges 
														inner join hclinica..informeipd ipd on tcges.idinformeipd=ipd.idinformeipd 
												) I 
												inner join Parametros..CIEDiagnostico CIEDiag on I.CodDiagnostico=CIEDiag.CodDiagnostico
										WHERE I.CodPaciente=e.CodPaciente
										  and I.CodEpisodio=e.CodEpisodio		
									)
								  ) is null then 0
						else 1
					end as TieneGuia,
					'' as MotivoPasiva,
					e.CodColectivo,
					MP.Entidad + '-' + MS.Entidad as Aseguradora,
					cs.HospitalRef,
					cs.DescCentro,	
					c.NoDerecho,
					c.CodConsulta,
					parametros.dbo.fnParFechaHoraUTC(c.FechaCita) as FechaCita____,
					c.IdCita,
					c.CodTipoConsulta,
					c.CodigoServicio,
					c.CodTipoConsulta2,
					e.confirmada,
					p.NumTarjSanitaria,
					e.comunicada,
					e.CodigoRYF,
					e.CodCentroOrigen,
					COALESCE(cs1.DescCentro,DOC.NomCentro) as DescCentroRef
					, '' IdMotivo,
					p.FecNac,				
					RIGHT('00000000' + LTRIM (RTRIM(AHP.CodHistoriaPapel)),8 ) as CodHistoriaPapel,
					p.Genero,
					'Sexo' = COD.Descripcion,
					'RUT Profesional' = e.DniMedDestino,
					'Profesional' = PM.NomMedico + ' ' + PM.Apell1 + ' ' + PM.Apell2,
					'Citador' = COALESCE(PMcita.NomMedico, DEcita.NombreEnf, Acita.NomAdminis) + ' ' +
								COALESCE(PMcita.Apell1, DEcita.Apell1Enf, Acita.Apell1Administ) + ' ' +
								COALESCE(PMcita.Apell2, DEcita.Apell2Enf, Acita.Apell2Administ),
					'TipoConsulta' = TC.DescTipoCons,
					'Prioridad' = COD2.Descripcion	
					,e.Estado 
					,u.Descripcion as Unidad 
					,p.DirTelf
					,'TiempoEspera' = DATEDIFF(DD, e.FechaConsulta, ISNULL(e.FechaInicial, GETDATE())) 
					,COD2.Posicion as OrdenPrioridad 
					,e.DerivacionSIC
					,c.Asiste as AsisteCita
					,c.CitaEspontanea 
					,c.HoraInicial as FechaInicial 
					,c.NoAtendido
					,null as FechaNoAtendida
					,e.NoAsistenciasCita
					, c.idOrigenCita 
					, O.DescOrigenCitas
					,p.Email
					,p.Direccion 
					,p.DirNum
					 ,p.CodPostal 
					 ,L.NomPoblacion  
					 ,p1.Nombre as Provincia
					,L.NomPoblacion as Localidad
					,p.telf2
					,isNull(p.TarjSanitariaResp,'') as RutTutor
					
					,IsNull(PMRemite.NomMedico , '') as NombreMedicoRemi
					,IsNull(PMRemite.Apell1 , '') as Apel1MedicoRemi
					,IsNull(PMRemite.Apell2 , '') as Apel2MEdicoRemi
					,IsNull(PMRemite.Nif , '') as RutMedicoRemi
					,I.DescDiagnostico
					,CI.DescDiagnostico as DescDiagnosProvi
					,e.inspecciones 
					,e.IDProblemaSalud
					,gc.DescGuia as descProblema
					,gc1.DescGuia as descSubProblema
					,isnull(PMcita.Nif,isnull(DEcita.Nif,isnull(TD.Nif,Acita.nif))) as Nif
					,e.IdCausaInterconsulta
					,e.DescCausaInterconsulta
					,e.comentarios
					,e.TipoRemision
					,e.motivo
					,e.FolioSigges
					,e.PrioridadHosp
					,Cod3.Posicion as OrdenPrioridadHosp
					,p.AtiendeAlNombre as NombreSocial
					,CASE WHEN 
					(
						EXISTS (select * from Hclinica..MutuasSaludSecPaciente MSSP 
						INNER JOIN parametros..MutuasSalud MS on MS.Codigo = MSSP.CodColectivo
						where codpaciente = e.CodPaciente and MS.EsPrais = 1)
					) THEN 1 ELSE 0 END AS EsPRAIS,	
					(
						SELECT 
						PMAten.NomMedico + ' ' + PMAten.Apell1 + ' ' + 	PMAten.Apell2 
						FROM  Parametros..ParametrosMedicos PMAten 
						WHERE PMAten.DNIMedico = c.NIFMedicoConsulta
					) 
					as ProfesionalAtiende,
					p.Telf3,
					p.TelfFijoUFamiliar
					,e.RUNProfEgreso
					,e.NomProfEgreso
					,e.ObservacionEgreso
					,e.FechaCierre
			from	Consultas..EpisodioConsultas e with (nolock)
					inner join Hclinica..Pacientes p with (nolock) on p.CodPaciente = e.CodPaciente 
					left join Parametros..Servicios s with (nolock) on s.Codigo = e.CodServicioFinal
					left join Parametros..Servicios s1 with (nolock) on s1.Codigo = e.CodServicioOrigen
					left join Parametros..ServiciosExternos se1 with (nolock) on se1.Codigo = e.CodServicioOrigen
					left join Parametros..CentrosSalud cs with (nolock) on cs.CodCentro = e.CodCentroFinal
					left join Parametros..CentrosSalud cs1 with (nolock) on cs1.CodCentro = e.CodCentroOrigen
					left join Parametros..DatosOtrosCentros DOC with (nolock) on DOC.CodCent = e.CodCentroOrigen
					left join Hclinica..Citas c with (nolock) on c.CodPaciente = e.CodPaciente and c.codepisodio = e.CodEpisodio
						                                         and c.FechaCita = e.FechaCPrimera and c.CodTipoConsulta = 0 
						                                       AND ( (e.FechaCPrimera IS NULL AND c.FechaEntrada = (SELECT MAX(c1.FechaEntrada) FROM Hclinica..Citas c1 WHERE c.codpaciente = c1.codpaciente AND c.codepisodio = c1.CodEpisodio AND c1.CodTipoConsulta=0)) 
														OR e.FechaCPrimera = C.FechaCita) 

					left join Hclinica..ArchivoHistoriasPapel AHP on AHP.CodPaciente = P.CodPaciente and AHP.CodCentro = cs.CodCentro
					left join Parametros..Codigos COD on COD.Codigo = p.Genero and Tabla = 'EstGenero'
					left join Parametros..ParametrosMedicos PM on PM.DNIMedico = e.DniMedDestino
					left join Parametros..ParametrosMedicos PMcita on PMcita.DNIMedico = e.NIF
					left join Parametros..DatosEnfermeras DEcita on DEcita.DNIEnf = e.NIF
					left join Parametros..Administrativo Acita on Acita.DNIAdminist = e.NIF				
					left join Parametros..TiposConsultas TC on TC.CodTipoCons = c.CodTipoConsulta and TC.CodClaseCons = c.CodTipoConsulta2 and TC.CodServCons = s.Codigo
					left join Parametros..Codigos COD2 on COD2.Codigo = e.Solicitud and COD2.Tabla = 'EstTipoExamen'
					left join Parametros..Unidad u on e.IdUnidad = u.IdUnidad 
					left join Parametros..OrigenesCitas O on c.idOrigenCita = O.idOrigenCita
					LEFT JOIN parametros..DireccionLocalidad L ON p.DirCodLocalidad = L.CodPoblacion and p.dircodprov = l.codprovincia 		    
					LEFT JOIN parametros..codprovincias p1 on p1.codigo = p.dircodprov
					left join Parametros..ParametrosMedicos PMRemite on PMRemite.DNIMedico = e.DNIMedEpi
					LEFT JOIN Parametros..CIEDiagnostico I on e.CodDiagnosticoProvisional = I.CodDiagnostico
					LEFT JOIN Parametros..CIEDiagnostico CI on e.CodDiagnosticoPrimero = CI.CodDiagnostico
					left join  Parametros..GuiasClinicas gc on  gc.CodGuia = e.IDProblemaSalud 
					left join  Parametros..GuiasClinicas gc1 on  gc1.CodGuia = e.CodSubProblema  
					LEFT JOIN Parametros..TecnicosDatos TD on TD.DNITecnico = e.NIF
					LEFT JOIN Parametros..Codigos Cod3 ON (e.PrioridadHosp = Cod3.Codigo and cod3.Tabla = 'EstTipoExamen')
					LEFT JOIN Parametros..MutuasSalud MS ON e.CodColectivo = MS.Codigo
					LEFT JOIN Parametros..MutuaPrincipal MP ON MS.CodMutua = MP.Codigo				
			where	c.Asiste = 1
					and p.codpaciente = @spvar_codPaciente 
					and c.HoraInicial is not null 
					and (@spvar_Nombre is null or PacNombre like (rtrim(@spvar_Nombre) + '%') )
					and (@spvar_Apell1 is null or PacApell1 like (rtrim(@spvar_Apell1) + '%') )
					and (@spvar_Apell2 is null or PacApell2 like (rtrim(@spvar_Apell2) + '%') )
					and (@spvar_CodServicio is null or e.CodServicioFinal = @spvar_CodServicio)
					and (@spvar_CodServicioRemite is null or e.CodServicioOrigen = @spvar_CodServicioRemite)
					and (@spvar_FecSolDesde is null or datediff(d, @spvar_FecSolDesde, e.FechaConsulta) >= 0)
					and (@spvar_FecSolHasta is null or datediff(d, @spvar_FecSolHasta, e.FechaConsulta) <= 0)
					and (@spvar_FecCita is null or datediff(d, @spvar_FecCita, e.FechaCPrimera) = 0)
					and (@spvar_FecCitaDesde is null or datediff(d, @spvar_FecCitaDesde, e.FechaCPrimera) >= 0)
					and (@spvar_FecCitaHasta is null or datediff(d, @spvar_FecCitaHasta, e.FechaCPrimera) <= 0)
					and (@spvar_CodCentro is null or e.CodCentroOrigen = @spvar_CodCentro)
					and (@spvar_CodTipoRemision is null or e.TipoRemision = @spvar_CodTipoRemision)
					and (@spvar_Prioridad is null or e.Solicitud = @spvar_Prioridad)
					and (@spvar_DniMedicoDestino is null or e.DniMedDestino = @spvar_DniMedicoDestino)
					and (@spvar_Citados = '0' or (@spvar_Citados = '1' and e.FechaCPrimera is not null))
                    and (@spvar_NoCitados = '0' or (@spvar_NoCitados = '1' and e.FechaCPrimera is null and e.confirmada = '1'))
					and (@spvar_FechaPrevistaDesde is null or e.FechaPrevista >= @spvar_FechaPrevistaDesde)
					and (@spvar_FechaPrevistaHasta is null or e.FechaPrevista <= @spvar_FechaPrevistaHasta)
					and (@spvar_AUGE is null or e.IdGuiaClinica is not null)
					and (@spvar_CodColectivo is null or e.CodColectivo = @spvar_CodColectivo)
					and (@spvar_codCentroDestino is null or e.CodCentroFinal = @spvar_codCentroDestino)
					and (@spvar_Reservadas = '0' or (@spvar_Reservadas = '1' and e.FechaCPrimera = c.FechaCita and c.NoDerecho = 1 ))
					and (@spvar_Confirmadas = '0' or (@spvar_Confirmadas = '1' and e.FechaCPrimera = c.FechaCita and (c.NoDerecho = 0 or c.NoDerecho is null)))
					and (@spvar_idUnidad is null or e.IdUnidad = @spvar_idUnidad)
					and (@spvar_DniMedicoOrigen is null or e.DNIMedEpi = @spvar_DniMedicoOrigen)
					and ((@spvar_LibreEleccion is null and (e.LibreEleccion is null or e.LibreEleccion = 0) or (e.LibreEleccion = 1)))
					and (@spvar_ConfAsistencia = 0 or (@spvar_ConfAsistencia = 1 and c.ConfAsistencia = 1)) 
					and (@spvar_PRAIS is null
						or 
						(@spvar_PRAIS = 1 and 
						EXISTS (select MS.EsPrais from 
						Hclinica..MutuasSaludSecPaciente MSSP 
						INNER JOIN parametros..MutuasSalud MS on MS.Codigo = MSSP.CodColectivo
						where codpaciente = e.CodPaciente and MS.EsPrais = 1))
						or 
						(@spvar_PRAIS = 0 and 
						NOT EXISTS (select MS.EsPrais from 
						Hclinica..MutuasSaludSecPaciente MSSP 
						INNER JOIN parametros..MutuasSalud MS on MS.Codigo = MSSP.CodColectivo
						where codpaciente = e.CodPaciente and MS.EsPrais = 1)))

				end
			else
				begin
					select 
					e.Codhistoria,
					e.CodPaciente,
					'PacNombre'= rtrim(p.Pacnombre),
					'PacApell1' = rtrim(p.PacApell1),
					'PacApell2' = rtrim(p.PacApell2),
					e.CodEpisodio,
					parametros.dbo.fnParFechaHoraUTC(e.FechaCPrimera) as FechaCPrimera____,
					c.ConfAsistencia,
					parametros.dbo.fnParFechaHoraUTC(e.FechaConsulta) as FechaConsulta____,
					e.DictamenClinico as Juicio,
					e.CodCentroFinal,
					s.Codigo, 
					s.DescServicio ServicioDestino,
					case when e.DerivacionSIC = 1 then se1.DescServicio else s1.DescServicio end as ServicioRemite,		
					'0' as Pasiva,
					e.Solicitud,
					parametros.dbo.fnParFechaHoraUTC(e.FechaPrevista) as FechaPrevista____,
					case
						when 
							isnull(
									e.IdGuiaClinica,
									(
										select MIN (I.CodProblema)
										from 	(
													SELECT 
														  ipd.CodPaciente
														, ipd.CodEpisodio
														, ipd.CodProblema
														, ipd.CodSubProblema
														, ipd.CodDiagnostico
														, ipd.IDInformeIPD					
													FROM HClinica..InformeIPD ipd 
													union
													select 
														  tcGES.CodPaciente
														, tcGES.CodEpisodio
														, ipd.CodProblema
														, ipd.CodSubProblema
														, ipd.CodDiagnostico
														, tcGES.IDInformeIPD	
													FROM Hclinica..TrazabilidadCasoGES tcges 
														inner join hclinica..informeipd ipd on tcges.idinformeipd=ipd.idinformeipd 
												) I 
												inner join Parametros..CIEDiagnostico CIEDiag on I.CodDiagnostico=CIEDiag.CodDiagnostico
										WHERE I.CodPaciente=e.CodPaciente
										  and I.CodEpisodio=e.CodEpisodio		
									)
								  ) is null then 0
						else 1
					end as TieneGuia,				
					'' as MotivoPasiva,
					e.CodColectivo,
					MP.Entidad + '-' + MS.Entidad as Aseguradora,
					cs.HospitalRef,
					cs.DescCentro,
					c.Noderecho,
					c.CodConsulta,
					parametros.dbo.fnParFechaHoraUTC(c.FechaCita) as FechaCita____,
					c.IdCita,
					c.CodTipoConsulta,
					c.CodigoServicio,
					c.CodTipoConsulta2,
					e.Confirmada,
					p.NumTarjSanitaria,
					e.comunicada,
					e.CodigoRYF,
					e.CodCentroOrigen,
					COALESCE(cs1.DescCentro,DOC.NomCentro) as DescCentroRef
					, '' IdMotivo,
					p.FecNac,				
					RIGHT('00000000' + LTRIM (RTRIM(AHP.CodHistoriaPapel)),8 ) as CodHistoriaPapel,
					p.Genero,
					'Sexo' = COD.Descripcion,
					'RUT Profesional' = e.DniMedDestino,
					'Profesional' = PM.NomMedico + ' ' + PM.Apell1 + ' ' + PM.Apell2,
					'Citador' = COALESCE(PMcita.NomMedico, DEcita.NombreEnf, Acita.NomAdminis) + ' ' +
								COALESCE(PMcita.Apell1, DEcita.Apell1Enf, Acita.Apell1Administ) + ' ' +
								COALESCE(PMcita.Apell2, DEcita.Apell2Enf, Acita.Apell2Administ),
					'TipoConsulta' = TC.DescTipoCons,
					'Prioridad' = COD2.Descripcion	
		    		,e.Estado 
		    		,u.Descripcion as Unidad 
					,p.DirTelf
					,'TiempoEspera' = DATEDIFF(DD, e.FechaConsulta, ISNULL(e.FechaInicial, GETDATE())) 
					,COD2.Posicion as OrdenPrioridad 
					,e.DerivacionSIC
					,c.Asiste as AsisteCita
					,c.CitaEspontanea 
					,c.HoraInicial as FechaInicial 
					,c.NoAtendido
					,null as FechaNoAtendida
					,e.NoAsistenciasCita
					, c.idOrigenCita 
					, O.DescOrigenCitas
					,p.Email
					,p.Direccion 
					,p.DirNum
					 ,p.CodPostal 
					 ,L.NomPoblacion  
					 ,p1.Nombre as Provincia
					,L.NomPoblacion as Localidad
					,p.telf2
					,isNull(p.TarjSanitariaResp,'') as RutTutor
					
					,IsNull(PMRemite.NomMedico , '') as NombreMedicoRemi
					,IsNull(PMRemite.Apell1 , '') as Apel1MedicoRemi
					,IsNull(PMRemite.Apell2 , '') as Apel2MEdicoRemi
					,IsNull(PMRemite.Nif , '') as RutMedicoRemi
					,I.DescDiagnostico
					,CI.DescDiagnostico as DescDiagnosProvi
					,e.inspecciones 
					,e.IDProblemaSalud
					,gc.DescGuia as descProblema
					,gc1.DescGuia as descSubProblema
					,isnull(PMcita.Nif,isnull(DEcita.Nif,isnull(TD.Nif,Acita.nif))) as Nif
					,e.IdCausaInterconsulta
					,e.DescCausaInterconsulta
					,e.comentarios
					,e.TipoRemision
					,e.motivo
					,e.FolioSigges
					,e.PrioridadHosp
					,Cod3.Posicion as OrdenPrioridadHosp
					,p.AtiendeAlNombre as NombreSocial
					,CASE WHEN 
					(
						EXISTS (select * from Hclinica..MutuasSaludSecPaciente MSSP 
						INNER JOIN parametros..MutuasSalud MS on MS.Codigo = MSSP.CodColectivo
						where codpaciente = e.CodPaciente and MS.EsPrais = 1)
					) THEN 1 ELSE 0 END AS EsPRAIS,
					'' as ProfesionalAtiende,
					p.Telf3,
					p.TelfFijoUFamiliar
					,e.RUNProfEgreso
					,e.NomProfEgreso
					,e.ObservacionEgreso
					,e.FechaCierre
			from	Consultas..Episodioconsultas e with (nolock)
					inner join Hclinica..Pacientes p with (nolock) on p.CodPaciente = e.CodPaciente 
					left join Parametros..Servicios s with (nolock) on s.Codigo = e.CodServicioFinal
					left join Parametros..Servicios s1 with (nolock) on s1.Codigo = e.CodServicioOrigen
					left join Parametros..ServiciosExternos se1 with (nolock) on se1.Codigo = e.CodServicioOrigen
					left join Hclinica..Citas c with (nolock) on c.CodPaciente = e.CodPaciente and c.codepisodio = e.CodEpisodio
							                                     and c.FechaCita = e.FechaCPrimera and c.CodTipoConsulta = 0
							                                     AND ( (e.FechaCPrimera IS NULL AND c.FechaEntrada = (SELECT MAX(c1.FechaEntrada) FROM Hclinica..Citas c1 WHERE c.codpaciente = c1.codpaciente AND c.codepisodio = c1.CodEpisodio AND c1.CodTipoConsulta=0)) 
														OR e.FechaCPrimera = C.FechaCita) 

					left join Parametros..CentrosSalud cs with (nolock) on cs.CodCentro = e.CodCentroFinal
					left join Parametros..CentrosSalud cs1 with (nolock) on cs1.CodCentro = e.CodCentroOrigen
					left join Parametros..DatosOtrosCentros DOC with (nolock) on DOC.CodCent = e.CodCentroOrigen
					left join Parametros..MutuasSalud m on e.CodColectivo = m.codigo
					left join Hclinica..ArchivoHistoriasPapel AHP on AHP.CodPaciente = P.CodPaciente and AHP.CodCentro = cs.CodCentro
					left join Parametros..Codigos COD on COD.Codigo = p.Genero and Tabla = 'EstGenero'
					left join Parametros..ParametrosMedicos PM on PM.DNIMedico = e.DniMedDestino
					left join Parametros..ParametrosMedicos PMcita on PMcita.DNIMedico = e.NIF
					left join Parametros..DatosEnfermeras DEcita on DEcita.DNIEnf = e.NIF
					left join Parametros..Administrativo Acita on Acita.DNIAdminist = e.NIF				
					left join Parametros..TiposConsultas TC on TC.CodTipoCons = c.CodTipoConsulta and TC.CodClaseCons = c.CodTipoConsulta2 and TC.CodServCons = s.Codigo
					left join Parametros..Codigos COD2 on COD2.Codigo = e.Solicitud and COD2.Tabla = 'EstTipoExamen'
					left join Parametros..Unidad u on e.IdUnidad = u.IdUnidad 
					left join Parametros..OrigenesCitas O on c.idOrigenCita = O.idOrigenCita 
					LEFT JOIN parametros..DireccionLocalidad L ON p.DirCodLocalidad = L.CodPoblacion and p.dircodprov = l.codprovincia 		    
					LEFT JOIN parametros..codprovincias p1 on p1.codigo = p.dircodprov
					left join Parametros..ParametrosMedicos PMRemite on PMRemite.DNIMedico = e.DNIMedEpi
					LEFT JOIN Parametros..CIEDiagnostico I on e.CodDiagnosticoProvisional = I.CodDiagnostico
					LEFT JOIN Parametros..CIEDiagnostico CI on e.CodDiagnosticoPrimero = CI.CodDiagnostico
					left join  Parametros..GuiasClinicas gc on  gc.CodGuia = e.IDProblemaSalud 
					left join  Parametros..GuiasClinicas gc1 on  gc1.CodGuia = e.CodSubProblema 
					LEFT JOIN Parametros..TecnicosDatos TD on TD.DNITecnico = e.NIF 
					LEFT JOIN Parametros..Codigos Cod3 ON (e.PrioridadHosp = Cod3.Codigo and cod3.Tabla = 'EstTipoExamen')
					LEFT JOIN Parametros..MutuasSalud MS ON e.CodColectivo = MS.Codigo
					LEFT JOIN Parametros..MutuaPrincipal MP ON MS.CodMutua = MP.Codigo			
			where  (@spvar_Nombre is null or PacNombre like (rtrim(@spvar_Nombre) + '%') )
					and p.codpaciente = @spvar_codPaciente --v4.42 - MAIPU CHC4019
                    and (@spvar_Apell1 is null or PacApell1 like (rtrim(@spvar_Apell1) + '%') )
                    and (@spvar_Apell2 is null or PacApell2 like (rtrim(@spvar_Apell2) + '%') )
                    and (@spvar_CodServicio is null or e.CodServicioFinal = @spvar_CodServicio)
                    and (@spvar_CodServicioRemite is null or e.CodServicioOrigen = @spvar_CodServicioRemite)
                    and (@spvar_FecSolDesde is null or datediff(d, @spvar_FecSolDesde, e.FechaConsulta) >= 0)
                    and (@spvar_FecSolHasta is null or datediff(d, @spvar_FecSolHasta, e.FechaConsulta) <= 0)
                    and (@spvar_FecCita is null or datediff(d, @spvar_FecCita, e.FechaCPrimera) = 0)
                    and (@spvar_FecCitaDesde is null or datediff(d, @spvar_FecCitaDesde, e.FechaCPrimera) >= 0)
                    and (@spvar_FecCitaHasta is null or datediff(d, @spvar_FecCitaHasta, e.FechaCPrimera) <= 0)
                    and (@spvar_CodCentro is null or e.CodCentroOrigen = @spvar_CodCentro)
                    and (@spvar_CodTipoRemision is null or e.TipoRemision = @spvar_CodTipoRemision)
                    and (@spvar_Prioridad is null or e.Solicitud = @spvar_Prioridad)
                    and (@spvar_DniMedicoDestino is null or e.DniMedDestino = @spvar_DniMedicoDestino)
                    and (@spvar_Citados = '0' or (@spvar_Citados = '1' and e.FechaCPrimera is not null))
                    and (@spvar_NoCitados = '0' or (@spvar_NoCitados = '1' and e.FechaCPrimera is null and e.confirmada = '1'))
                    and (@spvar_FechaPrevistaDesde is null or e.FechaPrevista >= @spvar_FechaPrevistaDesde)
                    and (@spvar_FechaPrevistaHasta is null or e.FechaPrevista <= @spvar_FechaPrevistaHasta)
                    and (@spvar_AUGE is null or e.IdGuiaClinica is not null)
                    and (@spvar_CodColectivo is null or e.CodColectivo = @spvar_CodColectivo)
                    and (@spvar_codCentroDestino is null or e.CodCentroFinal = @spvar_codCentroDestino)           
                   -- and (@spvar_PropConfirmadas = '0' or (@spvar_PropConfirmadas = '1' and (e.confirmada is null or e.confirmada = 1) and (m.autoConfirmar = 1 and cs.autoConfirmar = 1)))                       
					and (@spvar_PropConfirmadas = '0' or (@spvar_PropConfirmadas = '1' and ((e.confirmada = 1) or (e.confirmada is null and m.autoConfirmar = 1 and cs.autoConfirmar = 1))))
                    and (@spvar_FecConfDesde is null or (datediff(d, @spvar_FecConfDesde, e.FechaConfirmacion) >= 0) or (e.fechaConfirmacion is null and (datediff(d, @spvar_FecConfDesde, e.FechaConsulta) >= 0)))
                    and (@spvar_FecConfHasta is null or (datediff(d, @spvar_FecConfHasta, e.FechaConfirmacion) <= 0) or (e.fechaConfirmacion is null and (datediff(d, @spvar_FecConfHasta, e.FechaConsulta) >= 0))) 
                    and (@spvar_PropPendientes = '0' or (@spvar_PropPendientes = '1' and e.confirmada = 0))
                    and (@spvar_idUnidad is null or e.IdUnidad = @spvar_idUnidad)
                    and (@spvar_Comunicadas = '0' or ((@spvar_Comunicadas = '1' and e.Comunicada = 1) and (m.autoConfirmar = 1 and cs.autoConfirmar = 1)))
                    and (@spvar_SinComunicar = '0' or (@spvar_SinComunicar = '1' and e.comunicada = 0 and e.confirmada = 1))
					and (@spvar_DniMedicoOrigen is null or e.DNIMedEpi = @spvar_DniMedicoOrigen)
					and ((@spvar_LibreEleccion is null and (e.LibreEleccion is null or e.LibreEleccion = 0) or (e.LibreEleccion = 1)))
					and (@spvar_ConfAsistencia = 0 or (@spvar_ConfAsistencia = 1 and c.ConfAsistencia = 1)) --V4.46 - 1024 - ECR
					and (@spvar_PRAIS is null
						or 
						(@spvar_PRAIS = 1 and 
						EXISTS (select MS.EsPrais from 
						Hclinica..MutuasSaludSecPaciente MSSP 
						INNER JOIN parametros..MutuasSalud MS on MS.Codigo = MSSP.CodColectivo
						where codpaciente = e.CodPaciente and MS.EsPrais = 1))
						or 
						(@spvar_PRAIS = 0 and 
						NOT EXISTS (select MS.EsPrais from 
						Hclinica..MutuasSaludSecPaciente MSSP 
						INNER JOIN parametros..MutuasSalud MS on MS.Codigo = MSSP.CodColectivo
						where codpaciente = e.CodPaciente and MS.EsPrais = 1)))
				end
			end
		end
	end

END

GO
GO



--dbo.SpConSPropuestasCCEEFechas3SinPac.sql

USE [Consultas]
GO

/****** Object:  StoredProcedure [dbo].[SpConSPropuestasCCEEFechas3SinPac]    Script Date: 03/21/2013 16:42:22 ******/
IF EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[SpConSPropuestasCCEEFechas3SinPac]') AND type in (N'P', N'PC'))
DROP PROCEDURE [dbo].[SpConSPropuestasCCEEFechas3SinPac]
GO

/****** Object:  StoredProcedure [dbo].[SpConSPropuestasCCEEFechas3SinPac]    Script Date: 03/21/2013 16:42:22 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

/*
***********************************************************************
PROCEDIMIENTO : SpConSPropuestasCCEEFechas3SinPac
FUNCION		  : Busca las propuestas de consultas externas 
				filtrando por cualquier campo, cuando no existe código paciente (Viene de SpConSPropuestasCCEE3)
DEVUELVE	  : 
FECHA		  : 06/10/2010
VERSION		  : 1.0
AUTOR		  : Paco Aznar
MODIFICACION  : Carlos H Camacho 04/08/2011 Modificación formato fechas
MODIFICACIÓN  : (14/10/2011) César Moreno. Se cruzan las tablas de mutuas por el campo CodMutua
MODIFICACIÓN  : (18/10/2011) Carlos H Camacho. Añadimos condición para número máximo de filas
MODIFICACION  : (22/11/2011) Miguel Angel Gómez. Se añade un nuevo parámetro de entrada, @spvar_Atendidas
MODIFICACION  : (28/11/2011) Jose Almela Pérez. Se añade el id sidra de la SIC
MODIFICACIÖN  : (13/12/2011) Adrián Puchades Olmos. Devuelvo la fecha de nacimiento del paciente
MODIFICACION  : (11/01/2012) Miguel Angel Gómez. Al sacar las propuestas eliminadas sacamos las de 
				                                 Consultas..EpisodioConsultasBorrados y Consultas..EpisodioConsultas con Estado = 'E'
				                                 Para el resto de casos buscamos con Estado = NULL
MODIFICACIÓN  : (28/02/2012) Alfredo Samper. CHC1236 - v4.28 - Se devuelven nuevos campos
MODIFICACIÓN  : (03/07/2012) César Moreno. CHC-1895 - v4.30 - Devolvemos el estado, por si tiene volor "e", indica egresada
MODIFICACIÓN  : (28/08/2012) Alberto Pagán CHC1921 - v4.32 - nueva columna Unidad en DataGrid
MODIFICACIÓN  : (22/11/2012) Enrique Sánchez - CHC2360 - Normalizacion del código de historia papel
MODIFICACIÓN  : CHC2567 - v4.34.12 - 18/01/2013 - Enrique Sánchez - Se incluye el uso de la constante m_intRowCount que establece un valor para el rowcount
MODIFICACIÓN  : CHC2610 - v4.34.13 - 29/01/2013 - Enrique Sánchez - Se comentan las llamadas a la función fnParFechaHoraUTC. Se devuelven los campos fecha en su tipo de datos original
																	La transformación en ticks corrige el ajuste por la diferencia de zona horaria
MODIFICACIÓN  : (09/03/2013) Enrique Sánchez - CHC2871 - v4.38.2 - Se recupera el teléfono del paciente
MODIFICACIÓN  : (14/05/2013) MAIPU CHC3029 V4.38 r7 FCB, Comunicar a SAP la confirmación de una reserva (de cita)
MODIFICACIÓN  : (26/07/2013) - Alfredo 4.40 CHC3061 - Añado el tiempo de espera
MODIFICACIÓN  : (30/10/2013) Enrique Sánchez - CHC2076 - Derivación SIC - v4.41 - Se recupera la columna DerivacionSIC
MODIFICACIÓN  : (11/11/2013) - MAIPU CHC3807 V4.40 R 16 FCB, Orden de Prioridad en la grilla del Gestor de lista de espera
MODIFICACIÓN  : (11/11/2013) - MAIPU CHC3817 V4.40 R17 FCB, Citas Atendidas
MODIFICACION  : (20/03/2014) - CHC4019 - v4.42 - MAIPU REQ 46859 HEC_CORRECTIVO_PROBLEMA EN BUSQUEDAS POR FILTRO
MODIFICACIÓN  : (10/04/2014) Alberto Pagán - v4.42 - MAIPU CHC3984 REQ 46118 Gestor de interconsultas no entrega información de NSP
MODIFICACION  : (09/07/2014) - v4.46 – 0001022: 10925 – JVT - Observaciones pendientes derivación entre instancias
MODIFICACIÓN  : (22/07/2014) - V4.46 - 1024 - ECR - Estado previo a confirmación de cita
MODIFICACIÓN  : (30/10/2014) - V4.48 - 1169 - VAS - Citas espontáneas
MODIFICACIÓN  : (20/11/2014) - V4.48 - 1489 - VAS - Iconos estado SIC en Gestor Interconsultas
MODIFICACIÓN  : (20/11/2014) Alberto Pagán Benedicto - V4.49 - 1440 - APB - Segunda parte Derivación entre instancias
MODIFICACION  : (24/12/2014) - v4.49 - 1439 - RRG - Transversalidad del caso GES - REQ 55104
MODIFICACION  : (01/04/2015) - v4.49r2 - 2031 - ACT - Problemas con IC Duplicadas en Florence
MODIFICACION  : (21/04/2015) - v4.49r2 - 1992 - APO - Si es derivación el servicio que remite se obtiene de la tabla servicios externos
MODIFICACION  : (22/06/2015) v4.52 - 1899 - SGN - Problema distribución cupos florence
MODIFICACION  : (16/11/2015) - v4.55r1 - 2696 - CCM - Impresión Multiple SIC
MODIFICACION  : (30/11/2015) - v4.55r2 - 2737 - CCM - Solicitudes interconsultas agregar columna
MODIFICACION  : (01/12/2015) - v4.57 - 2724 - CCM - Incorporar folio SIGGES a una solicitud de interconsulta
MODIFICACION  : (24/12/2015) - v4.58 - 2760 - SGN - Agregar prioridad en Gestor Interconsultas
MODIFICACION  : (09/05/2017) - 17.2 - 16146 - SGH - Incluir Nombre Social del Paciente
MODIFICACION  : (19/05/2017) - 17.2 - 16506 - SGH - Filtros Prais Listados Sol. Interconsultas e Intervenciones
MODIFICACION  : (26/05/2017) - 17.2 - 16112 - SGH - Modificar reporte de gestor de interconsultas
MODIFICACION  : (23/08/2017) - v17.3 – 18451 – FCB - Ingresar observación al motivo de egreso en SIC
***********************************************************************
*/

CREATE PROCEDURE [dbo].[SpConSPropuestasCCEEFechas3SinPac]
	 @spvar_Nombre char(20) = null
	,@spvar_Apell1 char(25) = null
	,@spvar_Apell2 char(25) = null
	,@spvar_CodServicio char(4) = null
	,@spvar_CodServicioRemite char(4) = null
	,@spvar_FecSolDesde smalldatetime = null
	,@spvar_FecSolHasta smalldatetime = null
	,@spvar_Citados bit = 0
	,@spvar_NoCitados bit = 0
	,@spvar_FecCita smalldatetime = null
	,@spvar_FecCitaDesde smalldatetime = null
	,@spvar_FecCitaHasta smalldatetime = null
	,@spvar_CodCentro char(5) = null
	,@spvar_CodTipoRemision char(1) = null
	,@spvar_Prioridad char(1) = null
	,@spvar_DniMedicoDestino char(8) = null
	,@spvar_BuscaPasivas bit = 0
	,@spvar_NumQuery int = 0
	,@spvar_FechaPrevistaDesde smalldatetime = null
	,@spvar_FechaPrevistaHasta smalldatetime = null
	,@spvar_AUGE bit = null
	,@spvar_Eliminadas bit = null
	,@spvar_Rechazadas bit = null
	,@spvar_CodColectivo varchar(5) = null
	,@spvar_codCentroDestino char(5) = null
	,@spvar_Reservadas bit = 0
	,@spvar_Confirmadas bit = 0
	,@spvar_PropConfirmadas bit = 0
	,@spvar_FecRecDesde smalldatetime = null
	,@spvar_FecRecHasta smalldatetime = null
	,@spvar_FecConfDesde smalldatetime = null
	,@spvar_FecConfHasta smalldatetime = null
	,@spvar_PropPendientes bit = 0
	,@spvar_idUnidad int = null
	,@spvar_Comunicadas bit = 0
	,@spvar_SinComunicar bit = 0
	,@spvar_LibreEleccion bit = null
	,@spvar_DniMedicoOrigen char(8) = null
	,@spvar_NumFilasCCEE int = null
	,@spvar_Atendidas bit = 0
	,@spvar_ConfAsistencia bit = 0 
	,@spvar_Espontanea bit = 0 
	,@spvar_PRAIS bit = null
AS

--Aplicamos máximo de filas si este parámetro trae algún valor.
if @spvar_NumFilasCCEE is not null
	set rowcount @spvar_NumFilasCCEE

else
	if Parametros.dbo.fnParValorConstante('m_intRowCount') is not null 
		BEGIN
			declare @intRC as int = CONVERT(int,Parametros.dbo.fnParValorConstante('m_intRowCount'))			
			set rowcount @intRC	
		END
--ESA CHC2567 FIN

--Busca las propuestas pasivas
if @spvar_BuscaPasivas = 1 
BEGIN
	select	p.CodHistoria,
			p.CodPaciente,
			'PacNombre'= rtrim(p.PacNombre), 
			'PacApell1' = rtrim(p.PacApell1),
			'PacApell2' = rtrim(p.PacApell2),
			e.CodEpisodio,
			e.FechaCPrimera,
			C.ConfAsistencia, 
			e.FechaConsulta,
			e.DictamenClinico as Juicio,
			e.CodCentroFinal,
			s.Codigo, 
			s.DescServicio ServicioDestino,
			case when e.DerivacionSIC = 1 then se1.DescServicio else s1.DescServicio end as ServicioRemite,		
			'0' as Pasiva,
			e.Solicitud,
			e.FechaPrevista,
			case
				when 
					isnull(
							e.IdGuiaClinica,
							(
								select MIN (I.CodProblema)
								from 	(
											SELECT 
												  ipd.CodPaciente
												, ipd.CodEpisodio
												, ipd.CodProblema
												, ipd.CodSubProblema
												, ipd.CodDiagnostico
												, ipd.IDInformeIPD					
											FROM HClinica..InformeIPD ipd 
											union
											select 
												  tcGES.CodPaciente
												, tcGES.CodEpisodio
												, ipd.CodProblema
												, ipd.CodSubProblema
												, ipd.CodDiagnostico
												, tcGES.IDInformeIPD	
											FROM Hclinica..TrazabilidadCasoGES tcges 
												inner join hclinica..informeipd ipd on tcges.idinformeipd=ipd.idinformeipd 
										) I 
										inner join Parametros..CIEDiagnostico CIEDiag on I.CodDiagnostico=CIEDiag.CodDiagnostico
								WHERE I.CodPaciente=e.CodPaciente
								  and I.CodEpisodio=e.CodEpisodio		
							)
						  ) is null then 0
				else 1
			end as TieneGuia,
			'' as MotivoPasiva,
			e.CodColectivo,
			MP.Entidad + '-' + MS.Entidad as Aseguradora,
			cs.HospitalRef,
			cs.DescCentro,
			0 as noDerecho,
			null as codConsulta,
			null as fechaCita,
			null as idCita,
			null as CodTipoConsulta,
			null as CodigoServicio,
			null as confirmada,
			null as CodTipoConsulta2, 
			p.NumTarjSanitaria,
			e.comunicada,
			e.CodigoRYF,
			e.CodCentroOrigen,
			COALESCE(cs1.DescCentro,DOC.NomCentro) as DescCentroRef	
			,(select top 1 ISNULL(ID_Sidra, '') from Parametros..[MotivosCitas] M where M.Codigo = e.IdMotivo) as IdMotivo,
			p.FecNac,
			RIGHT('00000000' + LTRIM (RTRIM(AHP.CodHistoriaPapel)),8 ) as CodHistoriaPapel,
			p.Genero,
			'Sexo' = COD.Descripcion,
			'RUT Profesional' = e.DniMedDestino,
			'Profesional' = PM.NomMedico + ' ' + PM.Apell1 + ' ' + PM.Apell2,
			'Citador' = COALESCE(PMcita.NomMedico, DEcita.NombreEnf, Acita.NomAdminis) + ' ' +
						COALESCE(PMcita.Apell1, DEcita.Apell1Enf, Acita.Apell1Administ) + ' ' +
						COALESCE(PMcita.Apell2, DEcita.Apell2Enf, Acita.Apell2Administ),
			'TipoConsulta' = TC.DescTipoCons,
			'Prioridad' = COD2.Descripcion	
		    ,e.Estado 
		    ,u.Descripcion as Unidad 
			,p.DirTelf
			,'TiempoEspera' = DATEDIFF(DD, e.FechaConsulta, ISNULL(e.FechaInicial, GETDATE()))
			,COD2.Posicion as OrdenPrioridad
			,e.DerivacionSIC
			,c.Asiste as AsisteCita
			,c.CitaEspontanea 
			,c.HoraInicial as FechaInicial
			,c.NoAtendido
			,null as FechaNoAtendida
			,e.NoAsistenciasCita
			, C.idOrigenCita
			, O.DescOrigenCitas
			,p.Email
			,p.Direccion 
			,p.DirNum
			 ,p.CodPostal 
			 ,L.NomPoblacion  
			 ,p1.Nombre as Provincia
			,L.NomPoblacion as Localidad
			,p.telf2
			,isNull(p.TarjSanitariaResp,'') as RutTutor
			,IsNull(PMRemite.NomMedico , '') as NombreMedicoRemi
			,IsNull(PMRemite.Apell1 , '') as Apel1MedicoRemi
			,IsNull(PMRemite.Apell2 , '') as Apel2MEdicoRemi
			,IsNull(PMRemite.Nif , '') as RutMedicoRemi
			,I.DescDiagnostico
			,CI.DescDiagnostico as DescDiagnosProvi
			,e.inspecciones 
			,e.IDProblemaSalud
			,gc.DescGuia as descProblema
			,gc1.DescGuia as descSubProblema
			,isnull(PMcita.Nif,isnull(DEcita.Nif,isnull(TD.Nif,Acita.nif))) as Nif
			,e.IdCausaInterconsulta
			,e.DescCausaInterconsulta
			,e.comentarios
			,e.TipoRemision
			,e.motivo
			,e.FolioSigges
			,e.PrioridadHosp
			,Cod3.Posicion as OrdenPrioridadHosp
			,p.AtiendeAlNombre as NombreSocial
			,CASE WHEN 
			(
				EXISTS (select * from Hclinica..MutuasSaludSecPaciente MSSP 
				INNER JOIN parametros..MutuasSalud MS on MS.Codigo = MSSP.CodColectivo
				where codpaciente = e.CodPaciente and MS.EsPrais = 1)
			) THEN 1 ELSE 0 END AS EsPRAIS,
			'' as ProfesionalAtiende,
			p.Telf3,
			p.TelfFijoUFamiliar  
			,e.RUNProfEgreso
			,e.NomProfEgreso
			,e.ObservacionEgreso
			,e.FechaCierre
	from	Consultas..EpisodioConsultas e with (nolock)
			inner join Hclinica..Pacientes p with (nolock) on p.CodPaciente = e.CodPaciente
			left join Parametros..Servicios s with (nolock) on s.Codigo = e.CodServicioFinal
			left join Parametros..Servicios s1 with (nolock) on s1.Codigo = e.CodServicioOrigen
			left join Parametros..ServiciosExternos se1 with (nolock) on se1.Codigo = e.CodServicioOrigen
			left join Parametros..CentrosSalud cs with (nolock) on cs.CodCentro = e.CodCentroFinal
			left join Parametros..CentrosSalud cs1 with (nolock) on cs1.CodCentro = e.CodCentroOrigen
			left join Parametros..DatosOtrosCentros DOC with (nolock) on DOC.CodCent = e.CodCentroOrigen
			left join Hclinica..Citas C on e.CodPaciente = c.CodPaciente and e.CodEpisodio = C.CodEpisodio and c.CodTipoConsulta = 0 
			                             AND ((e.FechaCPrimera IS NULL AND c.FechaEntrada = (SELECT MAX(c1.FechaEntrada) FROM Hclinica..Citas c1 WHERE c.codpaciente = c1.codpaciente AND c.codepisodio = c1.CodEpisodio AND c1.CodTipoConsulta=0)) 
											  OR e.FechaCPrimera = C.FechaCita) 
			left join Hclinica..ArchivoHistoriasPapel AHP on AHP.CodPaciente = P.CodPaciente and AHP.CodCentro = cs.CodCentro
			left join Parametros..Codigos COD on COD.Codigo = p.Genero and Tabla = 'EstGenero'
			left join Parametros..ParametrosMedicos PM on PM.DNIMedico = e.DniMedDestino
			left join Parametros..ParametrosMedicos PMcita on PMcita.DNIMedico = e.NIF
			left join Parametros..DatosEnfermeras DEcita on DEcita.DNIEnf = e.NIF
			left join Parametros..Administrativo Acita on Acita.DNIAdminist = e.NIF				
			left join Parametros..TiposConsultas TC on TC.CodTipoCons = c.CodTipoConsulta and TC.CodClaseCons = c.CodTipoConsulta2 and TC.CodServCons = s.Codigo
			left join Parametros..Codigos COD2 on COD2.Codigo = e.Solicitud and COD2.Tabla = 'EstTipoExamen'
			left join Parametros..Unidad u on e.IdUnidad = u.IdUnidad 
			left join Parametros..OrigenesCitas O on C.idOrigenCita = O.idOrigenCita
			LEFT JOIN parametros..DireccionLocalidad L ON p.DirCodLocalidad = L.CodPoblacion and p.dircodprov = l.codprovincia 		    
			LEFT JOIN parametros..codprovincias p1 on p1.codigo = p.dircodprov
			left join Parametros..ParametrosMedicos PMRemite on PMRemite.DNIMedico = e.DNIMedEpi
			LEFT JOIN Parametros..CIEDiagnostico I on e.CodDiagnosticoProvisional = I.CodDiagnostico
			LEFT JOIN Parametros..CIEDiagnostico CI on e.CodDiagnosticoPrimero = CI.CodDiagnostico
			left join  Parametros..GuiasClinicas gc on  gc.CodGuia = e.IDProblemaSalud 
			left join  Parametros..GuiasClinicas gc1 on  gc1.CodGuia = e.CodSubProblema 
			LEFT JOIN Parametros..TecnicosDatos TD on TD.DNITecnico = e.NIF
			LEFT JOIN Parametros..Codigos Cod3 ON (e.PrioridadHosp = Cod3.Codigo and cod3.Tabla = 'EstTipoExamen')
			LEFT JOIN Parametros..MutuasSalud MS ON e.CodColectivo = MS.Codigo
			LEFT JOIN Parametros..MutuaPrincipal MP ON MS.CodMutua = MP.Codigo						
	where  ((c.NoAtendido = 1 and c.Asiste = 1) or (c.Asiste = 0 and e.NoAsistenciasCita > 0))
		   	and e.Estado is null
			and (@spvar_Nombre is null or PacNombre like (rtrim(@spvar_Nombre) + '%') )
			and (@spvar_Apell1 is null or PacApell1 like (rtrim(@spvar_Apell1) + '%') )
			and (@spvar_Apell2 is null or PacApell2 like (rtrim(@spvar_Apell2) + '%') )
			and (@spvar_CodServicio is null or e.CodServicioFinal = @spvar_CodServicio)
			and (@spvar_CodServicioRemite is null or e.CodServicioOrigen = @spvar_CodServicioRemite)
			and (@spvar_FecSolDesde is null or datediff(d, @spvar_FecSolDesde, e.FechaConsulta) >= 0)
			and (@spvar_FecSolHasta is null or datediff(d, @spvar_FecSolHasta, e.FechaConsulta) <= 0)
			and (@spvar_FecCita is null or datediff(d, @spvar_FecCita, e.FechaCPrimera) = 0)
			and (@spvar_FecCitaDesde is null or datediff(d, @spvar_FecCitaDesde, e.FechaCPrimera) >= 0)
			and (@spvar_FecCitaHasta is null or datediff(d, @spvar_FecCitaHasta, e.FechaCPrimera) <= 0)
			and (@spvar_CodCentro is null or e.CodCentroOrigen = @spvar_CodCentro)
			and (@spvar_CodTipoRemision is null or e.TipoRemision = @spvar_CodTipoRemision)
			and (@spvar_Prioridad is null or e.Solicitud = @spvar_Prioridad)
			and (@spvar_DniMedicoDestino is null or e.DniMedDestino = @spvar_DniMedicoDestino)
			and (@spvar_FechaPrevistaDesde is null or e.FechaPrevista >= @spvar_FechaPrevistaDesde)
			and (@spvar_FechaPrevistaHasta is null or e.FechaPrevista <= @spvar_FechaPrevistaHasta)
			and (@spvar_AUGE is null or e.IdGuiaClinica is not null)
			and (@spvar_CodColectivo is null or e.CodColectivo = @spvar_CodColectivo)
			and (@spvar_codCentroDestino is null or e.CodCentroFinal = @spvar_codCentroDestino)
			and (@spvar_idUnidad is null or e.IdUnidad = @spvar_idUnidad)
			and (@spvar_DniMedicoOrigen is null or e.DNIMedEpi = @spvar_DniMedicoOrigen)
			and ((@spvar_LibreEleccion is null and (e.LibreEleccion is null or e.LibreEleccion = 0) or (e.LibreEleccion = 1)))
			and (@spvar_ConfAsistencia = 0 or (@spvar_ConfAsistencia = 1 and C.ConfAsistencia = 1)) 
			and (@spvar_PRAIS is null
				or 
				(@spvar_PRAIS = 1 and 
				EXISTS (select MS.EsPrais from 
				Hclinica..MutuasSaludSecPaciente MSSP 
				INNER JOIN parametros..MutuasSalud MS on MS.Codigo = MSSP.CodColectivo
				where codpaciente = e.CodPaciente and MS.EsPrais = 1))
				or 
				(@spvar_PRAIS = 0 and 
				NOT EXISTS (select MS.EsPrais from 
				Hclinica..MutuasSaludSecPaciente MSSP 
				INNER JOIN parametros..MutuasSalud MS on MS.Codigo = MSSP.CodColectivo
				where codpaciente = e.CodPaciente and MS.EsPrais = 1)))
END
ELSE
BEGIN
	if @spvar_Eliminadas = 1
	begin
		select	p.CodHistoria,
				p.CodPaciente,
				'PacNombre'= rtrim(p.PacNombre), 
				'PacApell1' = rtrim(p.PacApell1),
				'PacApell2' = rtrim(p.PacApell2),
				e.CodEpisodio,
				--ESA CHC2610 INI
				e.FechaCPrimera,
				--parametros.dbo.fnParFechaHoraUTC(e.FechaCPrimera) as FechaCPrimera____,
				C.ConfAsistencia, --V4.46 - 1024 - ECR
				e.FechaConsulta,
				--parametros.dbo.fnParFechaHoraUTC(e.FechaConsulta) as FechaConsulta____,
				--ESA CHC2610 FIN
				e.DictamenClinico as Juicio,
				e.CodCentroFinal,
				s.Codigo, 
				s.DescServicio ServicioDestino,
				--ESA CHC2076 INI
				case when e.DerivacionSIC = 1 then se1.DescServicio else s1.DescServicio end as ServicioRemite,		
				--ESA CHC2076 FIN	
				null as Pasiva,
				e.Solicitud, --RJF(13/05/09)
				--ESA CHC2610 INI
				e.FechaPrevista,
				case
					when 
						isnull(
								e.IdGuiaClinica,
								(
									select MIN (I.CodProblema)
									from 	(
												SELECT 
													  ipd.CodPaciente
													, ipd.CodEpisodio
													, ipd.CodProblema
													, ipd.CodSubProblema
													, ipd.CodDiagnostico
													, ipd.IDInformeIPD					
												FROM HClinica..InformeIPD ipd 
												union
												select 
													  tcGES.CodPaciente
													, tcGES.CodEpisodio
													, ipd.CodProblema
													, ipd.CodSubProblema
													, ipd.CodDiagnostico
													, tcGES.IDInformeIPD	
												FROM Hclinica..TrazabilidadCasoGES tcges 
													inner join hclinica..informeipd ipd on tcges.idinformeipd=ipd.idinformeipd 
											) I 
											inner join Parametros..CIEDiagnostico CIEDiag on I.CodDiagnostico=CIEDiag.CodDiagnostico
									WHERE I.CodPaciente=e.CodPaciente
									  and I.CodEpisodio=e.CodEpisodio		
								)
							  ) is null then 0
					else 1
				end as TieneGuia,
				-- 24/12/2014 - v4.49 - 1439 - RRG - Transversalidad del caso GES - REQ 55104  - FIN												
				DescMotivoPasiva as MotivoPasiva,
				e.CodColectivo,
				MP.Entidad + '-' + MS.Entidad as Aseguradora,
				cs.HospitalRef,
				cs.DescCentro,
				0 as noDerecho,
				null as codConsulta,
				null as fechaCita,
				null as idCita,
				null as CodTipoConsulta,
				null as CodigoServicio,
				null as confirmada,
				null as CodTipoConsulta2, --MAIPU CHC3029 V4.38 r7 FCB, Comunicar a SAP la confirmación de una reserva (de cita)
				p.NumTarjSanitaria,
				e.comunicada,
				e.CodigoRYF,
				e.CodCentroOrigen,
				--ESA CHC2076 INI
				COALESCE(cs1.DescCentro,DOC.NomCentro) as DescCentroRef
				--ESA CHC2076 FIN	
				,(select top 1 ISNULL(ID_Sidra, '') from Parametros..[MotivosCitas] M where M.Codigo = e.IdMotivo) as IdMotivo,
				p.FecNac,
				--ESA CHC2360 INI
				RIGHT('00000000' + LTRIM (RTRIM(AHP.CodHistoriaPapel)),8 ) as CodHistoriaPapel,
				--ESA CHC2360 FIN
				p.Genero,
				'Sexo' = COD.Descripcion,
				'RUT Profesional' = e.DniMedDestino,
				'Profesional' = PM.NomMedico + ' ' + PM.Apell1 + ' ' + PM.Apell2,
				'Citador' = COALESCE(PMcita.NomMedico, DEcita.NombreEnf, Acita.NomAdminis) + ' ' +
							COALESCE(PMcita.Apell1, DEcita.Apell1Enf, Acita.Apell1Administ) + ' ' +
							COALESCE(PMcita.Apell2, DEcita.Apell2Enf, Acita.Apell2Administ),
				'TipoConsulta' = TC.DescTipoCons,
				'Prioridad' = COD2.Descripcion	
			    ,e.Estado 
			    ,u.Descripcion as Unidad 
				,p.DirTelf
				--ESA CHC2871 FIN
				,'TiempoEspera' = DATEDIFF(DD, e.FechaConsulta, e.FechaBorrado) --Alfredo - CHC3061
				,COD2.Posicion as OrdenPrioridad --MAIPU CHC3807 V4.40 R 16 FCB, Orden de Prioridad en la grilla del Gestor de lista de espera
				--ESA CHC2076 INI
				,e.DerivacionSIC
				,c.Asiste as AsisteCita
				,c.CitaEspontanea 
				,c.HoraInicial as FechaInicial 
				,c.NoAtendido
				,null as FechaNoAtendida
				,e.NoAsistenciasCita
				, c.idOrigenCita 
				, O.DescOrigenCitas
				,p.Email
				,p.Direccion 
				,p.DirNum
				 ,p.CodPostal 
				 ,L.NomPoblacion  
				 ,p1.Nombre as Provincia
				,L.NomPoblacion as Localidad
				,p.telf2
				,isNull(p.TarjSanitariaResp,'') as RutTutor
				
				,IsNull(PMRemite.NomMedico , '') as NombreMedicoRemi
				,IsNull(PMRemite.Apell1 , '') as Apel1MedicoRemi
				,IsNull(PMRemite.Apell2 , '') as Apel2MEdicoRemi
				,IsNull(PMRemite.Nif , '') as RutMedicoRemi
				,I.DescDiagnostico
				,CI.DescDiagnostico as DescDiagnosProvi
				,e.inspecciones 
				,e.IDProblemaSalud
				,gc.DescGuia as descProblema
				,gc1.DescGuia as descSubProblema
				,isnull(PMcita.Nif,isnull(DEcita.Nif,isnull(TD.Nif,Acita.nif))) as Nif
				,e.IdCausaInterconsulta
				,e.DescCausaInterconsulta
				,e.comentarios
				,e.TipoRemision
				,e.motivo
				, null as FolioSigges
				,e.PrioridadHosp
				,Cod3.Posicion as OrdenPrioridadHosp
				,p.AtiendeAlNombre as NombreSocial
				,CASE WHEN 
				(
					EXISTS (select * from Hclinica..MutuasSaludSecPaciente MSSP 
					INNER JOIN parametros..MutuasSalud MS on MS.Codigo = MSSP.CodColectivo
					where codpaciente = e.CodPaciente and MS.EsPrais = 1)
				) THEN 1 ELSE 0 END AS EsPRAIS,
				'' as ProfesionalAtiende,
				p.Telf3,
				p.TelfFijoUFamiliar 
				,e.RUNProfEgreso
				,e.NomProfEgreso
				,e.ObservacionEgreso 
				,e.FechaBorrado as FechaCierre
		from	Consultas..EpisodioConsultasBorrados e with (nolock)
				inner join Hclinica..Pacientes p with (nolock) on p.CodPaciente = e.CodPaciente --v4.42 - MAIPU CHC4019
				left join Parametros..Servicios s with (nolock) on s.Codigo = e.CodServicioFinal
				left join Parametros..Servicios s1 with (nolock) on s1.Codigo = e.CodServicioOrigen
				--ESA CHC2076 INI
				left join Parametros..ServiciosExternos se1 with (nolock) on se1.Codigo = e.CodServicioOrigen
				--ESA CHC2076 FIN
				left join Parametros..CentrosSalud cs with (nolock) on cs.CodCentro = e.CodCentroFinal
				left join Parametros..CentrosSalud cs1 with (nolock) on cs1.CodCentro = e.CodCentroOrigen
				--ESA CHC2076 INI
				left join Parametros..DatosOtrosCentros DOC with (nolock) on DOC.CodCent = e.CodCentroOrigen
				--ESA CHC2076 FIN
				left join Hclinica..Citas C on e.CodPaciente = c.CodPaciente and e.CodEpisodio = c.CodEpisodio and c.CodTipoConsulta = 0 --MAIPU CHC3029 V4.38 r7 FCB, Comunicar a SAP la confirmación de una reserva (de cita)
							AND ((e.FechaCPrimera IS NULL AND c.FechaEntrada = (SELECT MAX(c1.FechaEntrada) FROM Hclinica..Citas c1 WHERE c.codpaciente = c1.codpaciente AND c.codepisodio = c1.CodEpisodio AND c1.CodTipoConsulta=0)) 
											  OR e.FechaCPrimera = C.FechaCita) --(01/04/2015) - v4.49 - 2031 - ACT - Problemas con IC Duplicadas en Florence
				left join Hclinica..ArchivoHistoriasPapel AHP on AHP.CodPaciente = P.CodPaciente and AHP.CodCentro = cs.CodCentro
				left join Parametros..Codigos COD on COD.Codigo = p.Genero and Tabla = 'EstGenero'
				left join Parametros..ParametrosMedicos PM on PM.DNIMedico = e.DniMedDestino
				left join Parametros..ParametrosMedicos PMcita on PMcita.DNIMedico = e.NIF
				left join Parametros..DatosEnfermeras DEcita on DEcita.DNIEnf = e.NIF
				left join Parametros..Administrativo Acita on Acita.DNIAdminist = e.NIF				
				left join Parametros..TiposConsultas TC on TC.CodTipoCons = c.CodTipoConsulta and TC.CodClaseCons = c.CodTipoConsulta2 and TC.CodServCons = s.Codigo
				left join Parametros..Codigos COD2 on COD2.Codigo = e.Solicitud and COD2.Tabla = 'EstTipoExamen'
				left join Parametros..Unidad u on e.IdUnidad = u.IdUnidad 
				left join Parametros..OrigenesCitas O on c.idOrigenCita = O.idOrigenCita
				LEFT JOIN parametros..DireccionLocalidad L ON p.DirCodLocalidad = L.CodPoblacion and p.dircodprov = l.codprovincia 		    
				LEFT JOIN parametros..codprovincias p1 on p1.codigo = p.dircodprov
				left join Parametros..ParametrosMedicos PMRemite on PMRemite.DNIMedico = e.DNIMedEpi
				LEFT JOIN Parametros..CIEDiagnostico I on e.CodDiagnosticoProvisional = I.CodDiagnostico
				LEFT JOIN Parametros..CIEDiagnostico CI on e.CodDiagnosticoPrimero = CI.CodDiagnostico
				left join  Parametros..GuiasClinicas gc on  gc.CodGuia = e.IDProblemaSalud 
				left join  Parametros..GuiasClinicas gc1 on  gc1.CodGuia = e.CodSubProblema 
				LEFT JOIN Parametros..TecnicosDatos TD on TD.DNITecnico = e.NIF
				LEFT JOIN Parametros..Codigos Cod3 ON (e.PrioridadHosp = Cod3.Codigo and cod3.Tabla = 'EstTipoExamen')
				LEFT JOIN Parametros..MutuasSalud MS ON e.CodColectivo = MS.Codigo
				LEFT JOIN Parametros..MutuaPrincipal MP ON MS.CodMutua = MP.Codigo			
		where	Asistido is null
				and (@spvar_Nombre is null or PacNombre like (rtrim(@spvar_Nombre) + '%') )
				and (@spvar_Apell1 is null or PacApell1 like (rtrim(@spvar_Apell1) + '%') )
				and (@spvar_Apell2 is null or PacApell2 like (rtrim(@spvar_Apell2) + '%') )
				and (@spvar_CodServicio is null or e.CodServicioFinal = @spvar_CodServicio)
				and (@spvar_CodServicioRemite is null or e.CodServicioOrigen = @spvar_CodServicioRemite)
				and (@spvar_FecSolDesde is null or datediff(d, @spvar_FecSolDesde, e.FechaConsulta) >= 0)
				and (@spvar_FecSolHasta is null or datediff(d, @spvar_FecSolHasta, e.FechaConsulta) <= 0)
				and (@spvar_FecCita is null or datediff(d, @spvar_FecCita, e.FechaCPrimera) = 0)
				and (@spvar_FecCitaDesde is null or datediff(d, @spvar_FecCitaDesde, e.FechaCPrimera) >= 0)
				and (@spvar_FecCitaHasta is null or datediff(d, @spvar_FecCitaHasta, e.FechaCPrimera) <= 0)
				and (@spvar_CodCentro is null or e.CodCentroOrigen = @spvar_CodCentro)
				and (@spvar_CodTipoRemision is null or e.TipoRemision = @spvar_CodTipoRemision)
				and (@spvar_Prioridad is null or e.Solicitud = @spvar_Prioridad)
				and (@spvar_DniMedicoDestino is null or e.DniMedDestino = @spvar_DniMedicoDestino)
				and (@spvar_FechaPrevistaDesde is null or e.FechaPrevista >= @spvar_FechaPrevistaDesde)
				and (@spvar_FechaPrevistaHasta is null or e.FechaPrevista <= @spvar_FechaPrevistaHasta)
				and (@spvar_AUGE is null or e.IdGuiaClinica is not null)
				and (@spvar_CodColectivo is null or e.CodColectivo = @spvar_CodColectivo)
				and (@spvar_codCentroDestino is null or e.CodCentroFinal = @spvar_codCentroDestino)
				and (@spvar_idUnidad is null or e.IdUnidad = @spvar_idUnidad)
				and (@spvar_DniMedicoOrigen is null or e.DNIMedEpi = @spvar_DniMedicoOrigen)
				and ((@spvar_LibreEleccion is null and (e.LibreEleccion is null or e.LibreEleccion = 0) or (e.LibreEleccion = 1)))
				and (@spvar_ConfAsistencia = 0 or (@spvar_ConfAsistencia = 1 and C.ConfAsistencia = 1)) --V4.46 - 1024 - ECR
				and (@spvar_PRAIS is null
					or 
					(@spvar_PRAIS = 1 and 
					EXISTS (select MS.EsPrais from 
					Hclinica..MutuasSaludSecPaciente MSSP 
					INNER JOIN parametros..MutuasSalud MS on MS.Codigo = MSSP.CodColectivo
					where codpaciente = e.CodPaciente and MS.EsPrais = 1))
					or 
					(@spvar_PRAIS = 0 and 
					NOT EXISTS (select MS.EsPrais from 
					Hclinica..MutuasSaludSecPaciente MSSP 
					INNER JOIN parametros..MutuasSalud MS on MS.Codigo = MSSP.CodColectivo
					where codpaciente = e.CodPaciente and MS.EsPrais = 1)))

--INI Miguel angel
		union
		
		select	p.CodHistoria,
				p.CodPaciente,
				--INI CHC-1236
				'PacNombre'= rtrim(p.PacNombre), 
				'PacApell1' = rtrim(p.PacApell1),
				'PacApell2' = rtrim(p.PacApell2),
				--FIN CHC-1236
				e.CodEpisodio,
				--ESA CHC2610 INI
				e.FechaCPrimera,
				--parametros.dbo.fnParFechaHoraUTC(e.FechaCPrimera) as FechaCPrimera____,
				C.ConfAsistencia, --V4.46 - 1024 - ECR
				e.FechaConsulta,
				--parametros.dbo.fnParFechaHoraUTC(e.FechaConsulta) as FechaConsulta____,
				--ESA CHC2610 FIN
				e.DictamenClinico as Juicio,
				e.CodCentroFinal,
				s.Codigo, 
				s.DescServicio ServicioDestino,
				--ESA CHC2076 INI
				case when e.DerivacionSIC = 1 then se1.DescServicio else s1.DescServicio end as ServicioRemite,		
				--ESA CHC2076 FIN
				null as Pasiva,
				e.Solicitud, --RJF(13/05/09)
				--ESA CHC2610 INI
				e.FechaPrevista,
				--parametros.dbo.fnParFechaHoraUTC(e.FechaPrevista) as FechaPrevista____,
				--ESA CHC2610 FIN
				-- 24/12/2014 - v4.49 - 1439 - RRG - Transversalidad del caso GES - REQ 55104  - INI
				case
					when 
						isnull(
								e.IdGuiaClinica,
								(
									select MIN (I.CodProblema)
									from 	(
												SELECT 
													  ipd.CodPaciente
													, ipd.CodEpisodio
													, ipd.CodProblema
													, ipd.CodSubProblema
													, ipd.CodDiagnostico
													, ipd.IDInformeIPD					
												FROM HClinica..InformeIPD ipd 
												union
												select 
													  tcGES.CodPaciente
													, tcGES.CodEpisodio
													, ipd.CodProblema
													, ipd.CodSubProblema
													, ipd.CodDiagnostico
													, tcGES.IDInformeIPD	
												FROM Hclinica..TrazabilidadCasoGES tcges 
													inner join hclinica..informeipd ipd on tcges.idinformeipd=ipd.idinformeipd 
											) I 
											inner join Parametros..CIEDiagnostico CIEDiag on I.CodDiagnostico=CIEDiag.CodDiagnostico
									WHERE I.CodPaciente=e.CodPaciente
									  and I.CodEpisodio=e.CodEpisodio		
								)
							  ) is null then 0
					else 1
				end as TieneGuia,
				-- 24/12/2014 - v4.49 - 1439 - RRG - Transversalidad del caso GES - REQ 55104  - FIN								
				(select top 1 M.Descripcion from Parametros..[MotivosCitas] M where M.Codigo = e.IdMotivo) as MotivoPasiva,
				e.CodColectivo,
				MP.Entidad + '-' + MS.Entidad as Aseguradora,
				cs.HospitalRef,
				cs.DescCentro,
				0 as noDerecho,
				null as codConsulta,
				null as fechaCita,
				null as idCita,
				null as CodTipoConsulta,
				null as CodigoServicio,
				null as confirmada,
				null as CodTipoConsulta, --MAIPU CHC3029 V4.38 r7 FCB, Comunicar a SAP la confirmación de una reserva (de cita)	
				p.NumTarjSanitaria,
				e.comunicada,
				e.CodigoRYF,
				e.CodCentroOrigen,
				--ESA CHC2076 INI
				COALESCE(cs1.DescCentro,DOC.NomCentro) as DescCentroRef,
				--ESA CHC2076 FIN	
				e.IdMotivo as IdMotivo,
				p.FecNac,
				--ESA CHC2360 INI
				RIGHT('00000000' + LTRIM (RTRIM(AHP.CodHistoriaPapel)),8 ) as CodHistoriaPapel,
				--ESA CHC2360 FIN
				p.Genero,
				'Sexo' = COD.Descripcion,
				'RUT Profesional' = e.DniMedDestino,
				'Profesional' = PM.NomMedico + ' ' + PM.Apell1 + ' ' + PM.Apell2,
				'Citador' = COALESCE(PMcita.NomMedico, DEcita.NombreEnf, Acita.NomAdminis) + ' ' +
							COALESCE(PMcita.Apell1, DEcita.Apell1Enf, Acita.Apell1Administ) + ' ' +
							COALESCE(PMcita.Apell2, DEcita.Apell2Enf, Acita.Apell2Administ),
				'TipoConsulta' = TC.DescTipoCons,
				'Prioridad' = COD2.Descripcion	
				--CHC-1895 INI
			    ,e.Estado 
			    --CHC-1895 FIN			
				--Alberto Pagán - CHC1921 - v4.32 - 28/08/2012 - INI
			    ,u.Descripcion as Unidad 
				--Alberto Pagán - CHC1921 - v4.32 - 28/08/2012 - FIN
				--ESA CHC2871 INI
				,p.DirTelf
				--ESA CHC2871 FIN	
				,'TiempoEspera' = DATEDIFF(DD, e.FechaConsulta, ISNULL(e.FechaInicial, GETDATE())) --Alfredo - CHC3061
				,COD2.Posicion as OrdenPrioridad --MAIPU CHC3807 V4.40 R 16 FCB, Orden de Prioridad en la grilla del Gestor de lista de espera
				--ESA CHC2076 INI
				,e.DerivacionSIC
				,c.Asiste as AsisteCita
				--ESA CHC2076 FIN
				,c.CitaEspontanea --(30/10/2014) - V4.48 - 1169 - VAS - Citas espontáneas
				,c.HoraInicial as FechaInicial --(20/11/2014) - V4.49 - 1489 - VAS - Iconos estado SIC en Gestor Interconsultas
				,c.NoAtendido
				,null as FechaNoAtendida
				,e.NoAsistenciasCita
				, c.idOrigenCita 
				, O.DescOrigenCitas
				,p.Email
				,p.Direccion 
				,p.DirNum
				 ,p.CodPostal 
				 ,L.NomPoblacion  
				 ,p1.Nombre as Provincia
				,L.NomPoblacion as Localidad
				,p.telf2
				,isNull(p.TarjSanitariaResp,'') as RutTutor
				
				,IsNull(PMRemite.NomMedico , '') as NombreMedicoRemi
				,IsNull(PMRemite.Apell1 , '') as Apel1MedicoRemi
				,IsNull(PMRemite.Apell2 , '') as Apel2MEdicoRemi
				,IsNull(PMRemite.Nif , '') as RutMedicoRemi
				,I.DescDiagnostico
				,CI.DescDiagnostico as DescDiagnosProvi
				,e.inspecciones 
				,e.IDProblemaSalud
				,gc.DescGuia as descProblema
				,gc1.DescGuia as descSubProblema
				,isnull(PMcita.Nif,isnull(DEcita.Nif,isnull(TD.Nif,Acita.nif))) as Nif
				,e.IdCausaInterconsulta
				,e.DescCausaInterconsulta
				,e.comentarios
				,e.TipoRemision
				,e.motivo
				,e.FolioSigges
				,e.PrioridadHosp
				,Cod3.Posicion as OrdenPrioridadHosp
    			,p.AtiendeAlNombre as NombreSocial
				,CASE WHEN 
				(
					EXISTS (select * from Hclinica..MutuasSaludSecPaciente MSSP 
					INNER JOIN parametros..MutuasSalud MS on MS.Codigo = MSSP.CodColectivo
					where codpaciente = e.CodPaciente and MS.EsPrais = 1)
				) THEN 1 ELSE 0 END AS EsPRAIS,
				'' as ProfesionalAtiende,
				p.Telf3,
				p.TelfFijoUFamiliar  
				,e.RUNProfEgreso
				,e.NomProfEgreso
				,e.ObservacionEgreso
				,e.FechaCierre				
		from	Consultas..EpisodioConsultas e with (nolock)
				--INI CHC-1236
				inner join Hclinica..Pacientes p with (nolock) on p.CodPaciente = e.CodPaciente --v4.42 - MAIPU CHC4019
				left join Parametros..Servicios s with (nolock) on s.Codigo = e.CodServicioFinal
				left join Parametros..Servicios s1 with (nolock) on s1.Codigo = e.CodServicioOrigen
				--ESA CHC2076 INI
				left join Parametros..ServiciosExternos se1 with (nolock) on se1.Codigo = e.CodServicioOrigen
				--ESA CHC2076 FIN
				left join Parametros..CentrosSalud cs with (nolock) on cs.CodCentro = e.CodCentroFinal
				left join Parametros..CentrosSalud cs1 with (nolock) on cs1.CodCentro = e.CodCentroOrigen
				--ESA CHC2076 INI
				left join Parametros..DatosOtrosCentros DOC with (nolock) on DOC.CodCent = e.CodCentroOrigen
				--ESA CHC2076 FIN
				left join Hclinica..Citas C on e.CodPaciente = c.CodPaciente and e.CodEpisodio = c.CodEpisodio and c.CodTipoConsulta = 0 --MAIPU CHC3029 V4.38 r7 FCB, Comunicar a SAP la confirmación de una reserva (de cita)
						AND ((e.FechaCPrimera IS NULL AND c.FechaEntrada = (SELECT MAX(c1.FechaEntrada) FROM Hclinica..Citas c1 WHERE c.codpaciente = c1.codpaciente AND c.codepisodio = c1.CodEpisodio AND c1.CodTipoConsulta=0)) 
											  OR e.FechaCPrimera = C.FechaCita) --(01/04/2015) - v4.49 - 2031 - ACT - Problemas con IC Duplicadas en Florence
				left join Hclinica..ArchivoHistoriasPapel AHP on AHP.CodPaciente = P.CodPaciente and AHP.CodCentro = cs.CodCentro
				left join Parametros..Codigos COD on COD.Codigo = p.Genero and Tabla = 'EstGenero'
				left join Parametros..ParametrosMedicos PM on PM.DNIMedico = e.DniMedDestino
				left join Parametros..ParametrosMedicos PMcita on PMcita.DNIMedico = e.NIF
				left join Parametros..DatosEnfermeras DEcita on DEcita.DNIEnf = e.NIF
				left join Parametros..Administrativo Acita on Acita.DNIAdminist = e.NIF				
				left join Parametros..TiposConsultas TC on TC.CodTipoCons = c.CodTipoConsulta and TC.CodClaseCons = c.CodTipoConsulta2 and TC.CodServCons = s.Codigo
				left join Parametros..Codigos COD2 on COD2.Codigo = e.Solicitud and COD2.Tabla = 'EstTipoExamen'
				left join Parametros..Unidad u on e.IdUnidad = u.IdUnidad 
				left join Parametros..OrigenesCitas O on c.idOrigenCita = O.idOrigenCita
				LEFT JOIN parametros..DireccionLocalidad L ON p.DirCodLocalidad = L.CodPoblacion and p.dircodprov = l.codprovincia 		    
				LEFT JOIN parametros..codprovincias p1 on p1.codigo = p.dircodprov
				left join Parametros..ParametrosMedicos PMRemite on PMRemite.DNIMedico = e.DNIMedEpi
				LEFT JOIN Parametros..CIEDiagnostico I on e.CodDiagnosticoProvisional = I.CodDiagnostico
				LEFT JOIN Parametros..CIEDiagnostico CI on e.CodDiagnosticoPrimero = CI.CodDiagnostico
				left join  Parametros..GuiasClinicas gc on  gc.CodGuia = e.IDProblemaSalud 
				left join  Parametros..GuiasClinicas gc1 on  gc1.CodGuia = e.CodSubProblema 
				LEFT JOIN Parametros..TecnicosDatos TD on TD.DNITecnico = e.NIF
				LEFT JOIN Parametros..Codigos Cod3 ON (e.PrioridadHosp = Cod3.Codigo and cod3.Tabla = 'EstTipoExamen')
				LEFT JOIN Parametros..MutuasSalud MS ON e.CodColectivo = MS.Codigo
				LEFT JOIN Parametros..MutuaPrincipal MP ON MS.CodMutua = MP.Codigo			
		where	e.Estado = 'E' 
				and (@spvar_Nombre is null or PacNombre like (rtrim(@spvar_Nombre) + '%') )
				and (@spvar_Apell1 is null or PacApell1 like (rtrim(@spvar_Apell1) + '%') )
				and (@spvar_Apell2 is null or PacApell2 like (rtrim(@spvar_Apell2) + '%') )
				and (@spvar_CodServicio is null or e.CodServicioFinal = @spvar_CodServicio)
				and (@spvar_CodServicioRemite is null or e.CodServicioOrigen = @spvar_CodServicioRemite)
				and (@spvar_FecSolDesde is null or datediff(d, @spvar_FecSolDesde, e.FechaConsulta) >= 0)
				and (@spvar_FecSolHasta is null or datediff(d, @spvar_FecSolHasta, e.FechaConsulta) <= 0)
				and (@spvar_FecCita is null or datediff(d, @spvar_FecCita, e.FechaCPrimera) = 0)
				and (@spvar_FecCitaDesde is null or datediff(d, @spvar_FecCitaDesde, e.FechaCPrimera) >= 0)
				and (@spvar_FecCitaHasta is null or datediff(d, @spvar_FecCitaHasta, e.FechaCPrimera) <= 0)
				and (@spvar_CodCentro is null or e.CodCentroOrigen = @spvar_CodCentro)
				and (@spvar_CodTipoRemision is null or e.TipoRemision = @spvar_CodTipoRemision)
				and (@spvar_Prioridad is null or e.Solicitud = @spvar_Prioridad)
				and (@spvar_DniMedicoDestino is null or e.DniMedDestino = @spvar_DniMedicoDestino)
				and (@spvar_FechaPrevistaDesde is null or e.FechaPrevista >= @spvar_FechaPrevistaDesde)
				and (@spvar_FechaPrevistaHasta is null or e.FechaPrevista <= @spvar_FechaPrevistaHasta)
				and (@spvar_AUGE is null or e.IdGuiaClinica is not null)
				and (@spvar_CodColectivo is null or e.CodColectivo = @spvar_CodColectivo)
				and (@spvar_codCentroDestino is null or e.CodCentroFinal = @spvar_codCentroDestino)
				and (@spvar_idUnidad is null or e.IdUnidad = @spvar_idUnidad)
				and (@spvar_DniMedicoOrigen is null or e.DNIMedEpi = @spvar_DniMedicoOrigen)
				and ((@spvar_LibreEleccion is null and (e.LibreEleccion is null or e.LibreEleccion = 0) or (e.LibreEleccion = 1)))
				and (@spvar_ConfAsistencia = 0 or (@spvar_ConfAsistencia = 1 and C.ConfAsistencia = 1)) --V4.46 - 1024 - ECR
				and (@spvar_PRAIS is null
					or 
					(@spvar_PRAIS = 1 and 
					EXISTS (select MS.EsPrais from 
					Hclinica..MutuasSaludSecPaciente MSSP 
					INNER JOIN parametros..MutuasSalud MS on MS.Codigo = MSSP.CodColectivo
					where codpaciente = e.CodPaciente and MS.EsPrais = 1))
					or 
					(@spvar_PRAIS = 0 and 
					NOT EXISTS (select MS.EsPrais from 
					Hclinica..MutuasSaludSecPaciente MSSP 
					INNER JOIN parametros..MutuasSalud MS on MS.Codigo = MSSP.CodColectivo
					where codpaciente = e.CodPaciente and MS.EsPrais = 1)))

--FIN Miguel Angel
				
	end
else
	begin
		if @spvar_Rechazadas = 1
		begin
			select	p.CodHistoria,
					p.CodPaciente,
					'PacNombre'= rtrim(p.PacNombre), 
					'PacApell1' = rtrim(p.PacApell1),
					'PacApell2' = rtrim(p.PacApell2),
					e.CodEpisodio,
					--ESA CHC2610 INI
					e.FechaCPrimera,
					C.ConfAsistencia, --V4.46 - 1024 - ECR
					e.FechaConsulta,
					e.DictamenClinico as Juicio,
					e.CodCentroFinal,
					s.Codigo, 
					s.DescServicio ServicioDestino,
					--ESA CHC2076 INI
				case when e.DerivacionSIC = 1 then se1.DescServicio else s1.DescServicio end as ServicioRemite,		
					'2' as Pasiva,
					e.Solicitud, 
					e.FechaPrevista,
					case
						when 
							isnull(
									e.IdGuiaClinica,
									(
										select MIN (I.CodProblema)
										from 	(
													SELECT 
														  ipd.CodPaciente
														, ipd.CodEpisodio
														, ipd.CodProblema
														, ipd.CodSubProblema
														, ipd.CodDiagnostico
														, ipd.IDInformeIPD					
													FROM HClinica..InformeIPD ipd 
													union
													select 
														  tcGES.CodPaciente
														, tcGES.CodEpisodio
														, ipd.CodProblema
														, ipd.CodSubProblema
														, ipd.CodDiagnostico
														, tcGES.IDInformeIPD	
													FROM Hclinica..TrazabilidadCasoGES tcges 
														inner join hclinica..informeipd ipd on tcges.idinformeipd=ipd.idinformeipd 
												) I 
												inner join Parametros..CIEDiagnostico CIEDiag on I.CodDiagnostico=CIEDiag.CodDiagnostico
										WHERE I.CodPaciente=e.CodPaciente
										  and I.CodEpisodio=e.CodEpisodio		
									)
								  ) is null then 0
						else 1
					end as TieneGuia,
					-- 24/12/2014 - v4.49 - 1439 - RRG - Transversalidad del caso GES - REQ 55104  - FIN									
					DescMotivoPasiva as MotivoPasiva,
					e.CodColectivo,
					MP.Entidad + '-' + MS.Entidad as Aseguradora,
					cs.HospitalRef,
					cs.DescCentro,
					0 as noDerecho,
					null as codConsulta,
					null as fechaCita,
					null as idCita,
					null as CodTipoConsulta,
					null as CodigoServicio,
					null as confirmada,
					null as CodTipoConsulta2, --MAIPU CHC3029 V4.38 r7 FCB, Comunicar a SAP la confirmación de una reserva (de cita)		
				    p.NumTarjSanitaria,
				    e.comunicada,
				    e.CodigoRYF,
					e.CodCentroOrigen,
					--ESA CHC2076 INI
					COALESCE(cs1.DescCentro,DOC.NomCentro) as DescCentroRef
					--ESA CHC2076 FIN	
					,(select top 1 ISNULL(ID_Sidra, '') from Parametros..[MotivosCitas] M where M.Codigo = e.IdMotivo) as IdMotivo,
					p.FecNac,
					--ESA CHC2360 INI
					RIGHT('00000000' + LTRIM (RTRIM(AHP.CodHistoriaPapel)),8 ) as CodHistoriaPapel,
					--ESA CHC2360 FIN
					p.Genero,
					'Sexo' = COD.Descripcion,
					'RUT Profesional' = e.DniMedDestino,
					'Profesional' = PM.NomMedico + ' ' + PM.Apell1 + ' ' + PM.Apell2,
					'Citador' = COALESCE(PMcita.NomMedico, DEcita.NombreEnf, Acita.NomAdminis) + ' ' +
								COALESCE(PMcita.Apell1, DEcita.Apell1Enf, Acita.Apell1Administ) + ' ' +
								COALESCE(PMcita.Apell2, DEcita.Apell2Enf, Acita.Apell2Administ),
					'TipoConsulta' = TC.DescTipoCons,
					'Prioridad' = COD2.Descripcion	
					--CHC-1895 INI
		            ,e.Estado 
		            --CHC-1895 FIN	
					--Alberto Pagán - CHC1921 - v4.32 - 28/08/2012 - INI
		            ,u.Descripcion as Unidad 
					--Alberto Pagán - CHC1921 - v4.32 - 28/08/2012 - FIN
					--ESA CHC2871 INI
					,p.DirTelf
					--ESA CHC2871 FIN
					,'TiempoEspera' = DATEDIFF(DD, e.FechaConsulta, e.FechaBorrado) --Alfredo - CHC3061
					,COD2.Posicion as OrdenPrioridad 
					--ESA CHC2076 INI
					,e.DerivacionSIC
					,c.Asiste as AsisteCita
					,c.CitaEspontanea 
					,c.HoraInicial as FechaInicial 
					,c.NoAtendido
					,null as FechaNoAtendida
					,e.NoAsistenciasCita
					, c.idOrigenCita 
					, O.DescOrigenCitas
					,p.Email
					,p.Direccion 
					,p.DirNum
					 ,p.CodPostal 
					 ,L.NomPoblacion  
					 ,p1.Nombre as Provincia
					,L.NomPoblacion as Localidad
					,p.telf2
					,isNull(p.TarjSanitariaResp,'') as RutTutor
					
					,IsNull(PMRemite.NomMedico , '') as NombreMedicoRemi
					,IsNull(PMRemite.Apell1 , '') as Apel1MedicoRemi
					,IsNull(PMRemite.Apell2 , '') as Apel2MEdicoRemi
					,IsNull(PMRemite.Nif , '') as RutMedicoRemi
					,I.DescDiagnostico
					,CI.DescDiagnostico as DescDiagnosProvi
					,e.inspecciones 
					,e.IDProblemaSalud
					,gc.DescGuia as descProblema
					,gc1.DescGuia as descSubProblema
					,isnull(PMcita.Nif,isnull(DEcita.Nif,isnull(TD.Nif,Acita.nif))) as Nif
					,e.IdCausaInterconsulta
					,e.DescCausaInterconsulta
					,e.comentarios
					,e.TipoRemision
					,e.motivo
					, null as FolioSigges
					,e.PrioridadHosp
					,Cod3.Posicion as OrdenPrioridadHosp
					,p.AtiendeAlNombre as NombreSocial
					,CASE WHEN 
					(
						EXISTS (select * from Hclinica..MutuasSaludSecPaciente MSSP 
						INNER JOIN parametros..MutuasSalud MS on MS.Codigo = MSSP.CodColectivo
						where codpaciente = e.CodPaciente and MS.EsPrais = 1)
					) THEN 1 ELSE 0 END AS EsPRAIS,
					'' as ProfesionalAtiende,
					p.Telf3,
					p.TelfFijoUFamiliar 
					,e.RUNProfEgreso
					,e.NomProfEgreso
					,e.ObservacionEgreso
					,e.FechaBorrado  as FechaCierre
			from	Consultas..EpisodioConsultasBorrados e with (nolock)
					inner join Hclinica..Pacientes p with (nolock) on p.CodPaciente = e.CodPaciente 
					left join Parametros..Servicios s with (nolock) on s.Codigo = e.CodServicioFinal
					left join Parametros..Servicios s1 with (nolock) on s1.Codigo = e.CodServicioOrigen
					left join Parametros..ServiciosExternos se1 with (nolock) on se1.Codigo = e.CodServicioOrigen
					left join Parametros..CentrosSalud cs with (nolock) on cs.CodCentro = e.CodCentroFinal
					left join Parametros..CentrosSalud cs1 with (nolock) on cs1.CodCentro = e.CodCentroOrigen
					left join Parametros..DatosOtrosCentros DOC with (nolock) on DOC.CodCent = e.CodCentroOrigen
					left join Parametros..DatosOtrosCentros do with (nolock) on do.CodCent = e.CodCentroFinal
				    left join Hclinica..Citas C on e.CodPaciente = c.CodPaciente and e.CodEpisodio = c.CodEpisodio and c.CodTipoConsulta = 0 
							AND ((e.FechaCPrimera IS NULL AND c.FechaEntrada = (SELECT MAX(c1.FechaEntrada) FROM Hclinica..Citas c1 WHERE c.codpaciente = c1.codpaciente AND c.codepisodio = c1.CodEpisodio AND c1.CodTipoConsulta=0)) 
											  OR e.FechaCPrimera = C.FechaCita)
					left join Hclinica..ArchivoHistoriasPapel AHP on AHP.CodPaciente = P.CodPaciente and AHP.CodCentro = cs.CodCentro
					left join Parametros..Codigos COD on COD.Codigo = p.Genero and Tabla = 'EstGenero'
					left join Parametros..ParametrosMedicos PM on PM.DNIMedico = e.DniMedDestino
					left join Parametros..ParametrosMedicos PMcita on PMcita.DNIMedico = e.NIF
					left join Parametros..DatosEnfermeras DEcita on DEcita.DNIEnf = e.NIF
					left join Parametros..Administrativo Acita on Acita.DNIAdminist = e.NIF				
					left join Parametros..TiposConsultas TC on TC.CodTipoCons = c.CodTipoConsulta and TC.CodClaseCons = c.CodTipoConsulta2 and TC.CodServCons = s.Codigo
					left join Parametros..Codigos COD2 on COD2.Codigo = e.Solicitud and COD2.Tabla = 'EstTipoExamen'
					left join Parametros..Unidad u on e.IdUnidad = u.IdUnidad 
					left join Parametros..OrigenesCitas O on c.idOrigenCita = O.idOrigenCita
					LEFT JOIN parametros..DireccionLocalidad L ON p.DirCodLocalidad = L.CodPoblacion and p.dircodprov = l.codprovincia 		    
					LEFT JOIN parametros..codprovincias p1 on p1.codigo = p.dircodprov
					left join Parametros..ParametrosMedicos PMRemite on PMRemite.DNIMedico = e.DNIMedEpi
					LEFT JOIN Parametros..CIEDiagnostico I on e.CodDiagnosticoProvisional = I.CodDiagnostico
					LEFT JOIN Parametros..CIEDiagnostico CI on e.CodDiagnosticoPrimero = CI.CodDiagnostico
					left join  Parametros..GuiasClinicas gc on  gc.CodGuia = e.IDProblemaSalud 
					left join  Parametros..GuiasClinicas gc1 on  gc1.CodGuia = e.CodSubProblema 
					LEFT JOIN Parametros..TecnicosDatos TD on TD.DNITecnico = e.NIF
					LEFT JOIN Parametros..Codigos Cod3 ON (e.PrioridadHosp = Cod3.Codigo and cod3.Tabla = 'EstTipoExamen')
					LEFT JOIN Parametros..MutuasSalud MS ON e.CodColectivo = MS.Codigo
					LEFT JOIN Parametros..MutuaPrincipal MP ON MS.CodMutua = MP.Codigo							
			where	Asistido = 'R'
					and (@spvar_Nombre is null or PacNombre like (rtrim(@spvar_Nombre) + '%') )
					and (@spvar_Apell1 is null or PacApell1 like (rtrim(@spvar_Apell1) + '%') )
					and (@spvar_Apell2 is null or PacApell2 like (rtrim(@spvar_Apell2) + '%') )
					and (@spvar_CodServicio is null or e.CodServicioFinal = @spvar_CodServicio)
					and (@spvar_CodServicioRemite is null or e.CodServicioOrigen = @spvar_CodServicioRemite)
					and (@spvar_FecSolDesde is null or datediff(d, @spvar_FecSolDesde, e.FechaConsulta) >= 0)
					and (@spvar_FecSolHasta is null or datediff(d, @spvar_FecSolHasta, e.FechaConsulta) <= 0)
					and (@spvar_FecCita is null or datediff(d, @spvar_FecCita, e.FechaCPrimera) = 0)
					and (@spvar_FecCitaDesde is null or datediff(d, @spvar_FecCitaDesde, e.FechaCPrimera) >= 0)
					and (@spvar_FecCitaHasta is null or datediff(d, @spvar_FecCitaHasta, e.FechaCPrimera) <= 0)
					and (@spvar_CodCentro is null or e.CodCentroOrigen = @spvar_CodCentro)
					and (@spvar_CodTipoRemision is null or e.TipoRemision = @spvar_CodTipoRemision)
					and (@spvar_Prioridad is null or e.Solicitud = @spvar_Prioridad)
					and (@spvar_DniMedicoDestino is null or e.DniMedDestino = @spvar_DniMedicoDestino)
					and (@spvar_FechaPrevistaDesde is null or e.FechaPrevista >= @spvar_FechaPrevistaDesde)
					and (@spvar_FechaPrevistaHasta is null or e.FechaPrevista <= @spvar_FechaPrevistaHasta)
					and (@spvar_AUGE is null or e.IdGuiaClinica is not null)
					and (@spvar_CodColectivo is null or e.CodColectivo = @spvar_CodColectivo)
					and (@spvar_codCentroDestino is null or e.CodCentroFinal = @spvar_codCentroDestino)
					and (@spvar_FecRecDesde is null or datediff(d, @spvar_FecRecDesde, e.FechaBorrado) >= 0)
					and (@spvar_FecRecHasta is null or datediff(d, @spvar_FecRecHasta, e.FechaBorrado) <= 0)
					and (@spvar_idUnidad is null or e.IdUnidad = @spvar_idUnidad)
					and (@spvar_DniMedicoOrigen is null or e.DNIMedEpi = @spvar_DniMedicoOrigen)
					and ((@spvar_LibreEleccion is null and (e.LibreEleccion is null or e.LibreEleccion = 0) or (e.LibreEleccion = 1)))
					and (@spvar_ConfAsistencia = 0 or (@spvar_ConfAsistencia = 1 and C.ConfAsistencia = 1)) --V4.46 - 1024 - ECR
					and (@spvar_PRAIS is null
						or 
						(@spvar_PRAIS = 1 and 
						EXISTS (select MS.EsPrais from 
						Hclinica..MutuasSaludSecPaciente MSSP 
						INNER JOIN parametros..MutuasSalud MS on MS.Codigo = MSSP.CodColectivo
						where codpaciente = e.CodPaciente and MS.EsPrais = 1))
						or 
						(@spvar_PRAIS = 0 and 
						NOT EXISTS (select MS.EsPrais from 
						Hclinica..MutuasSaludSecPaciente MSSP 
						INNER JOIN parametros..MutuasSalud MS on MS.Codigo = MSSP.CodColectivo
						where codpaciente = e.CodPaciente and MS.EsPrais = 1)))
		end
	else
		begin
			if @spvar_Reservadas = 1 or @spvar_Confirmadas = 1
			begin
			--Busca las propuestas normales
			select	p.CodHistoria,
					p.CodPaciente,
					'PacNombre'= rtrim(p.PacNombre), 
					'PacApell1' = rtrim(p.PacApell1),
					'PacApell2' = rtrim(p.PacApell2),
					e.CodEpisodio,
					e.FechaCPrimera,
					c.ConfAsistencia, 
					e.FechaConsulta,
					e.DictamenClinico as Juicio,
					e.CodCentroFinal,
					s.Codigo, 
					s.DescServicio ServicioDestino,
					case when e.DerivacionSIC = 1 then se1.DescServicio else s1.DescServicio end as ServicioRemite,		
					'0' as Pasiva,
					e.Solicitud, 
					e.FechaPrevista,
					case
						when 
							isnull(
									e.IdGuiaClinica,
									(
										select MIN (I.CodProblema)
										from 	(
													SELECT 
														  ipd.CodPaciente
														, ipd.CodEpisodio
														, ipd.CodProblema
														, ipd.CodSubProblema
														, ipd.CodDiagnostico
														, ipd.IDInformeIPD					
													FROM HClinica..InformeIPD ipd 
													union
													select 
														  tcGES.CodPaciente
														, tcGES.CodEpisodio
														, ipd.CodProblema
														, ipd.CodSubProblema
														, ipd.CodDiagnostico
														, tcGES.IDInformeIPD	
													FROM Hclinica..TrazabilidadCasoGES tcges 
														inner join hclinica..informeipd ipd on tcges.idinformeipd=ipd.idinformeipd 
												) I 
												inner join Parametros..CIEDiagnostico CIEDiag on I.CodDiagnostico=CIEDiag.CodDiagnostico
										WHERE I.CodPaciente=e.CodPaciente
										  and I.CodEpisodio=e.CodEpisodio		
									)
								  ) is null then 0
						else 1
					end as TieneGuia,							
					'' as MotivoPasiva,
					e.CodColectivo,
					MP.Entidad + '-' + MS.Entidad as Aseguradora,
					cs.HospitalRef,
					cs.DescCentro,
					c.NoDerecho,
					c.CodConsulta,
					c.FechaCita,
					c.IdCita,
					c.CodTipoConsulta,
					c.CodigoServicio,
					c.CodTipoConsulta2, 
					e.confirmada,
					p.NumTarjSanitaria,
					e.comunicada,
					e.CodigoRYF,
					e.CodCentroOrigen,
					COALESCE(cs1.DescCentro,DOC.NomCentro) as DescCentroRef
					,'' as IdMotivo,
					p.FecNac,
					RIGHT('00000000' + LTRIM (RTRIM(AHP.CodHistoriaPapel)),8 ) as CodHistoriaPapel,
					p.Genero,
					'Sexo' = COD.Descripcion,
					'RUT Profesional' = e.DniMedDestino,
					'Profesional' = PM.NomMedico + ' ' + PM.Apell1 + ' ' + PM.Apell2,
					'Citador' = COALESCE(PMcita.NomMedico, DEcita.NombreEnf, Acita.NomAdminis) + ' ' +
								COALESCE(PMcita.Apell1, DEcita.Apell1Enf, Acita.Apell1Administ) + ' ' +
								COALESCE(PMcita.Apell2, DEcita.Apell2Enf, Acita.Apell2Administ),
					'TipoConsulta' = TC.DescTipoCons,
					'Prioridad' = COD2.Descripcion	
		            ,e.Estado 
		            ,u.Descripcion as Unidad 
					,p.DirTelf
					,'TiempoEspera' = DATEDIFF(DD, e.FechaConsulta, ISNULL(e.FechaInicial, GETDATE())) 
					,COD2.Posicion as OrdenPrioridad 
					,e.DerivacionSIC
					,c.Asiste as AsisteCita
					,c.CitaEspontanea
					,c.HoraInicial as FechaInicial 
					,c.NoAtendido
					,null as FechaNoAtendida
					,e.NoAsistenciasCita
					, c.idOrigenCita 
					, O.DescOrigenCitas
					,p.Email
					,p.Direccion 
					,p.DirNum
					 ,p.CodPostal 
					 ,L.NomPoblacion  
					 ,p1.Nombre as Provincia
					,L.NomPoblacion as Localidad
					,p.telf2
					,isNull(p.TarjSanitariaResp,'') as RutTutor
					
					,IsNull(PMRemite.NomMedico , '') as NombreMedicoRemi
					,IsNull(PMRemite.Apell1 , '') as Apel1MedicoRemi
					,IsNull(PMRemite.Apell2 , '') as Apel2MEdicoRemi
					,IsNull(PMRemite.Nif , '') as RutMedicoRemi
					,I.DescDiagnostico
					,CI.DescDiagnostico as DescDiagnosProvi
					,e.inspecciones 
					,e.IDProblemaSalud
					,gc.DescGuia as descProblema
					,gc1.DescGuia as descSubProblema
					,isnull(PMcita.Nif,isnull(DEcita.Nif,isnull(TD.Nif,Acita.nif))) as Nif
					,e.IdCausaInterconsulta
					,e.DescCausaInterconsulta
					,e.comentarios
					,e.TipoRemision
					,e.motivo
					,e.FolioSigges
					,e.PrioridadHosp
					,Cod3.Posicion as OrdenPrioridadHosp
					,p.AtiendeAlNombre as NombreSocial
					,CASE WHEN 
					(
						EXISTS (select * from Hclinica..MutuasSaludSecPaciente MSSP 
						INNER JOIN parametros..MutuasSalud MS on MS.Codigo = MSSP.CodColectivo
						where codpaciente = e.CodPaciente and MS.EsPrais = 1)
					) THEN 1 ELSE 0 END AS EsPRAIS,
					'' as ProfesionalAtiende,
					p.Telf3,
					p.TelfFijoUFamiliar
					,e.RUNProfEgreso
					,e.NomProfEgreso
					,e.ObservacionEgreso  
					,e.FechaCierre
			from	Consultas..EpisodioConsultas e with (nolock)
					inner join Hclinica..Pacientes p with (nolock) on p.CodPaciente = e.CodPaciente 
					left join Parametros..Servicios s with (nolock) on s.Codigo = e.CodServicioFinal
					left join Parametros..Servicios s1 with (nolock) on s1.Codigo = e.CodServicioOrigen
					left join Parametros..ServiciosExternos se1 with (nolock) on se1.Codigo = e.CodServicioOrigen
					left join Parametros..CentrosSalud cs with (nolock) on cs.CodCentro = e.CodCentroFinal
					left join Parametros..CentrosSalud cs1 with (nolock) on cs1.CodCentro = e.CodCentroOrigen
					left join Parametros..DatosOtrosCentros DOC with (nolock) on DOC.CodCent = e.CodCentroOrigen
					left join Hclinica..Citas c with (nolock) on c.CodPaciente = e.CodPaciente and c.codepisodio = e.CodEpisodio and c.CodTipoConsulta = 0 
							AND ((e.FechaCPrimera IS NULL AND c.FechaEntrada = (SELECT MAX(c1.FechaEntrada) FROM Hclinica..Citas c1 WHERE c.codpaciente = c1.codpaciente AND c.codepisodio = c1.CodEpisodio AND c1.CodTipoConsulta=0)) 
											  OR e.FechaCPrimera = C.FechaCita) 
					left join Hclinica..ArchivoHistoriasPapel AHP on AHP.CodPaciente = P.CodPaciente and AHP.CodCentro = cs.CodCentro
					left join Parametros..Codigos COD on COD.Codigo = p.Genero and Tabla = 'EstGenero'
					left join Parametros..ParametrosMedicos PM on PM.DNIMedico = e.DniMedDestino
					left join Parametros..ParametrosMedicos PMcita on PMcita.DNIMedico = e.NIF
					left join Parametros..DatosEnfermeras DEcita on DEcita.DNIEnf = e.NIF
					left join Parametros..Administrativo Acita on Acita.DNIAdminist = e.NIF				
					left join Parametros..TiposConsultas TC on TC.CodTipoCons = c.CodTipoConsulta and TC.CodClaseCons = c.CodTipoConsulta2 and TC.CodServCons = s.Codigo
					left join Parametros..Codigos COD2 on COD2.Codigo = e.Solicitud and COD2.Tabla = 'EstTipoExamen'
					left join Parametros..Unidad u on e.IdUnidad = u.IdUnidad 
					left join Parametros..OrigenesCitas O on c.idOrigenCita = O.idOrigenCita
					LEFT JOIN parametros..DireccionLocalidad L ON p.DirCodLocalidad = L.CodPoblacion and p.dircodprov = l.codprovincia 		    
					LEFT JOIN parametros..codprovincias p1 on p1.codigo = p.dircodprov
					left join Parametros..ParametrosMedicos PMRemite on PMRemite.DNIMedico = e.DNIMedEpi
					LEFT JOIN Parametros..CIEDiagnostico I on e.CodDiagnosticoProvisional = I.CodDiagnostico
					LEFT JOIN Parametros..CIEDiagnostico CI on e.CodDiagnosticoPrimero = CI.CodDiagnostico
					left join  Parametros..GuiasClinicas gc on  gc.CodGuia = e.IDProblemaSalud 
					left join  Parametros..GuiasClinicas gc1 on  gc1.CodGuia = e.CodSubProblema 
					LEFT JOIN Parametros..TecnicosDatos TD on TD.DNITecnico = e.NIF
					LEFT JOIN Parametros..Codigos Cod3 ON (e.PrioridadHosp = Cod3.Codigo and cod3.Tabla = 'EstTipoExamen')
				    LEFT JOIN Parametros..MutuasSalud MS ON e.CodColectivo = MS.Codigo
				    LEFT JOIN Parametros..MutuaPrincipal MP ON MS.CodMutua = MP.Codigo							
			where	e.Estado is null
					and (@spvar_Nombre is null or PacNombre like (rtrim(@spvar_Nombre) + '%') )
					and (@spvar_Apell1 is null or PacApell1 like (rtrim(@spvar_Apell1) + '%') )
					and (@spvar_Apell2 is null or PacApell2 like (rtrim(@spvar_Apell2) + '%') )
					and (@spvar_CodServicio is null or e.CodServicioFinal = @spvar_CodServicio)
					and (@spvar_CodServicioRemite is null or e.CodServicioOrigen = @spvar_CodServicioRemite)
					and (@spvar_FecSolDesde is null or datediff(d, @spvar_FecSolDesde, e.FechaConsulta) >= 0)
					and (@spvar_FecSolHasta is null or datediff(d, @spvar_FecSolHasta, e.FechaConsulta) <= 0)
					and (@spvar_FecCita is null or datediff(d, @spvar_FecCita, e.FechaCPrimera) = 0)
					and (@spvar_FecCitaDesde is null or datediff(d, @spvar_FecCitaDesde, e.FechaCPrimera) >= 0)
					and (@spvar_FecCitaHasta is null or datediff(d, @spvar_FecCitaHasta, e.FechaCPrimera) <= 0)
					and (@spvar_CodCentro is null or e.CodCentroOrigen = @spvar_CodCentro)
					and (@spvar_CodTipoRemision is null or e.TipoRemision = @spvar_CodTipoRemision)
					and (@spvar_Prioridad is null or e.Solicitud = @spvar_Prioridad)
					and (@spvar_DniMedicoDestino is null or e.DniMedDestino = @spvar_DniMedicoDestino)
					and (@spvar_Citados = '0' or (@spvar_Citados = '1' and e.FechaCPrimera is not null))
                    and (@spvar_NoCitados = '0' or (@spvar_NoCitados = '1' and e.FechaCPrimera is null and e.confirmada = '1'))
					and (@spvar_FechaPrevistaDesde is null or e.FechaPrevista >= @spvar_FechaPrevistaDesde)
					and (@spvar_FechaPrevistaHasta is null or e.FechaPrevista <= @spvar_FechaPrevistaHasta)
					and (@spvar_AUGE is null or e.IdGuiaClinica is not null)
					and (@spvar_CodColectivo is null or e.CodColectivo = @spvar_CodColectivo)
					and (@spvar_codCentroDestino is null or e.CodCentroFinal = @spvar_codCentroDestino)
					and (@spvar_Reservadas = '0' or (@spvar_Reservadas = '1' and e.FechaCPrimera = c.FechaCita and c.NoDerecho = 1 ))
					and (@spvar_Confirmadas = '0' or (@spvar_Confirmadas = '1' and e.FechaCPrimera = c.FechaCita and (c.NoDerecho = 0 or c.NoDerecho is null)))
					and (@spvar_idUnidad is null or e.IdUnidad = @spvar_idUnidad)
					and (@spvar_DniMedicoOrigen is null or e.DNIMedEpi = @spvar_DniMedicoOrigen)
					and ((@spvar_LibreEleccion is null and (e.LibreEleccion is null or e.LibreEleccion = 0) or (e.LibreEleccion = 1)))
					and (@spvar_ConfAsistencia = 0 or (@spvar_ConfAsistencia = 1 and c.ConfAsistencia = 1)) 
					and (@spvar_PRAIS is null
						or 
						(@spvar_PRAIS = 1 and 
						EXISTS (select MS.EsPrais from 
						Hclinica..MutuasSaludSecPaciente MSSP 
						INNER JOIN parametros..MutuasSalud MS on MS.Codigo = MSSP.CodColectivo
						where codpaciente = e.CodPaciente and MS.EsPrais = 1))
						or 
						(@spvar_PRAIS = 0 and 
						NOT EXISTS (select MS.EsPrais from 
						Hclinica..MutuasSaludSecPaciente MSSP 
						INNER JOIN parametros..MutuasSalud MS on MS.Codigo = MSSP.CodColectivo
						where codpaciente = e.CodPaciente and MS.EsPrais = 1)))
			end
		else
			begin
				if @spvar_Atendidas = 1
				begin
					select	p.CodHistoria,
					p.CodPaciente,
					'PacNombre'= rtrim(p.PacNombre), 
					'PacApell1' = rtrim(p.PacApell1),
					'PacApell2' = rtrim(p.PacApell2),
					e.CodEpisodio,
					e.FechaCPrimera,
					c.ConfAsistencia,
					e.FechaConsulta,
					e.DictamenClinico as Juicio,
					e.CodCentroFinal,
					s.Codigo, 
					s.DescServicio ServicioDestino,
					case when e.DerivacionSIC = 1 then se1.DescServicio else s1.DescServicio end as ServicioRemite,		
					'0' as Pasiva,
					e.Solicitud, 
					e.FechaPrevista,
					case
						when 
							isnull(
									e.IdGuiaClinica,
									(
										select MIN (I.CodProblema)
										from 	(
													SELECT 
														  ipd.CodPaciente
														, ipd.CodEpisodio
														, ipd.CodProblema
														, ipd.CodSubProblema
														, ipd.CodDiagnostico
														, ipd.IDInformeIPD					
													FROM HClinica..InformeIPD ipd 
													union
													select 
														  tcGES.CodPaciente
														, tcGES.CodEpisodio
														, ipd.CodProblema
														, ipd.CodSubProblema
														, ipd.CodDiagnostico
														, tcGES.IDInformeIPD	
													FROM Hclinica..TrazabilidadCasoGES tcges 
														inner join hclinica..informeipd ipd on tcges.idinformeipd=ipd.idinformeipd 
												) I 
												inner join Parametros..CIEDiagnostico CIEDiag on I.CodDiagnostico=CIEDiag.CodDiagnostico
										WHERE I.CodPaciente=e.CodPaciente
										  and I.CodEpisodio=e.CodEpisodio		
									)
								  ) is null then 0
						else 1
					end as TieneGuia,								
					'' as MotivoPasiva,
					e.CodColectivo,
					MP.Entidad + '-' + MS.Entidad as Aseguradora,
					cs.HospitalRef,
					cs.DescCentro,
					c.NoDerecho,
					c.CodConsulta,
					c.FechaCita,
					c.IdCita,
					c.CodTipoConsulta,
					c.CodigoServicio,
					c.CodTipoConsulta2,
					e.confirmada,
					p.NumTarjSanitaria,
					e.comunicada,
					e.CodigoRYF,
					e.CodCentroOrigen,
					COALESCE(cs1.DescCentro,DOC.NomCentro) as DescCentroRef
					,'' as IdMotivo,
					p.FecNac,
					RIGHT('00000000' + LTRIM (RTRIM(AHP.CodHistoriaPapel)),8 ) as CodHistoriaPapel,
					p.Genero,
					'Sexo' = COD.Descripcion,
					'RUT Profesional' = e.DniMedDestino,
					'Profesional' = PM.NomMedico + ' ' + PM.Apell1 + ' ' + PM.Apell2,
					'Citador' = COALESCE(PMcita.NomMedico, DEcita.NombreEnf, Acita.NomAdminis) + ' ' +
								COALESCE(PMcita.Apell1, DEcita.Apell1Enf, Acita.Apell1Administ) + ' ' +
								COALESCE(PMcita.Apell2, DEcita.Apell2Enf, Acita.Apell2Administ),
					'TipoConsulta' = TC.DescTipoCons,
					'Prioridad' = COD2.Descripcion	
		            ,e.Estado 
		            ,u.Descripcion as Unidad 
					,p.DirTelf
					,'TiempoEspera' = DATEDIFF(DD, e.FechaConsulta, ISNULL(e.FechaInicial, GETDATE())) 
					,COD2.Posicion as OrdenPrioridad 
					,e.DerivacionSIC
					,c.Asiste as AsisteCita
					,c.CitaEspontanea 
					,c.HoraInicial as FechaInicial 
					,c.NoAtendido
					,null as FechaNoAtendida
					,e.NoAsistenciasCita
					, c.idOrigenCita 
					, O.DescOrigenCitas
					,p.Email
					,p.Direccion 
					,p.DirNum
					 ,p.CodPostal 
					 ,L.NomPoblacion  
					 ,p1.Nombre as Provincia
					,L.NomPoblacion as Localidad
					,p.telf2
					,isNull(p.TarjSanitariaResp,'') as RutTutor
					
					,IsNull(PMRemite.NomMedico , '') as NombreMedicoRemi
					,IsNull(PMRemite.Apell1 , '') as Apel1MedicoRemi
					,IsNull(PMRemite.Apell2 , '') as Apel2MEdicoRemi
					,IsNull(PMRemite.Nif , '') as RutMedicoRemi
					,I.DescDiagnostico
					,CI.DescDiagnostico as DescDiagnosProvi
					,e.inspecciones 
					,e.IDProblemaSalud
					,gc.DescGuia as descProblema
					,gc1.DescGuia as descSubProblema
					,isnull(PMcita.Nif,isnull(DEcita.Nif,isnull(TD.Nif,Acita.nif))) as Nif
					,e.IdCausaInterconsulta
					,e.DescCausaInterconsulta
					,e.comentarios
					,e.TipoRemision
					,e.motivo
					,e.FolioSigges
					,e.PrioridadHosp
					,Cod3.Posicion as OrdenPrioridadHosp
        			,p.AtiendeAlNombre as NombreSocial
					,CASE WHEN 
					(
						EXISTS (select * from Hclinica..MutuasSaludSecPaciente MSSP 
						INNER JOIN parametros..MutuasSalud MS on MS.Codigo = MSSP.CodColectivo
						where codpaciente = e.CodPaciente and MS.EsPrais = 1)
					) THEN 1 ELSE 0 END AS EsPRAIS,
					(
						SELECT 
						PMAten.NomMedico + ' ' + PMAten.Apell1 + ' ' + 	PMAten.Apell2 
						FROM  Parametros..ParametrosMedicos PMAten 
						WHERE PMAten.DNIMedico = c.NIFMedicoConsulta
					) 
					as ProfesionalAtiende,
					p.Telf3,
					p.TelfFijoUFamiliar   
					,e.RUNProfEgreso
					,e.NomProfEgreso
					,e.ObservacionEgreso  
					,e.FechaCierre
			from	Consultas..EpisodioConsultas e with (nolock)
					inner join Hclinica..Pacientes p with (nolock) on p.CodPaciente = e.CodPaciente 
					left join Parametros..Servicios s with (nolock) on s.Codigo = e.CodServicioFinal
					left join Parametros..Servicios s1 with (nolock) on s1.Codigo = e.CodServicioOrigen
					left join Parametros..ServiciosExternos se1 with (nolock) on se1.Codigo = e.CodServicioOrigen
					left join Parametros..CentrosSalud cs with (nolock) on cs.CodCentro = e.CodCentroFinal
					left join Parametros..CentrosSalud cs1 with (nolock) on cs1.CodCentro = e.CodCentroOrigen
					left join Parametros..DatosOtrosCentros DOC with (nolock) on DOC.CodCent = e.CodCentroOrigen
					left join Hclinica..Citas c with (nolock) on c.CodPaciente = e.CodPaciente and c.codepisodio = e.CodEpisodio
																 and c.FechaCita = e.FechaCPrimera and c.CodTipoConsulta = 0 
																AND ((e.FechaCPrimera IS NULL AND c.FechaEntrada = (SELECT MAX(c1.FechaEntrada) FROM Hclinica..Citas c1 WHERE c.codpaciente = c1.codpaciente AND c.codepisodio = c1.CodEpisodio AND c1.CodTipoConsulta=0)) 
											  OR e.FechaCPrimera = C.FechaCita)
					left join Hclinica..ArchivoHistoriasPapel AHP on AHP.CodPaciente = P.CodPaciente and AHP.CodCentro = cs.CodCentro
					left join Parametros..Codigos COD on COD.Codigo = p.Genero and Tabla = 'EstGenero'
					left join Parametros..ParametrosMedicos PM on PM.DNIMedico = e.DniMedDestino
					left join Parametros..ParametrosMedicos PMcita on PMcita.DNIMedico = e.NIF
					left join Parametros..DatosEnfermeras DEcita on DEcita.DNIEnf = e.NIF
					left join Parametros..Administrativo Acita on Acita.DNIAdminist = e.NIF				
					left join Parametros..TiposConsultas TC on TC.CodTipoCons = c.CodTipoConsulta and TC.CodClaseCons = c.CodTipoConsulta2 and TC.CodServCons = s.Codigo
					left join Parametros..Codigos COD2 on COD2.Codigo = e.Solicitud and COD2.Tabla = 'EstTipoExamen'
					left join Parametros..Unidad u on e.IdUnidad = u.IdUnidad 
					left join Parametros..OrigenesCitas O on c.idOrigenCita = O.idOrigenCita				
					LEFT JOIN parametros..DireccionLocalidad L ON p.DirCodLocalidad = L.CodPoblacion and p.dircodprov = l.codprovincia 		    
					LEFT JOIN parametros..codprovincias p1 on p1.codigo = p.dircodprov
					left join Parametros..ParametrosMedicos PMRemite on PMRemite.DNIMedico = e.DNIMedEpi
					LEFT JOIN Parametros..CIEDiagnostico I on e.CodDiagnosticoProvisional = I.CodDiagnostico
					LEFT JOIN Parametros..CIEDiagnostico CI on e.CodDiagnosticoPrimero = CI.CodDiagnostico
					left join  Parametros..GuiasClinicas gc on  gc.CodGuia = e.IDProblemaSalud 
					left join  Parametros..GuiasClinicas gc1 on  gc1.CodGuia = e.CodSubProblema 
					LEFT JOIN Parametros..TecnicosDatos TD on TD.DNITecnico = e.NIF
					LEFT JOIN Parametros..Codigos Cod3 ON (e.PrioridadHosp = Cod3.Codigo and cod3.Tabla = 'EstTipoExamen')
					LEFT JOIN Parametros..MutuasSalud MS ON e.CodColectivo = MS.Codigo
					LEFT JOIN Parametros..MutuaPrincipal MP ON MS.CodMutua = MP.Codigo				
			where	e.Estado is null
					and c.Asiste = 1
					and c.HoraInicial is not null 
					and (@spvar_Nombre is null or PacNombre like (rtrim(@spvar_Nombre) + '%') )
					and (@spvar_Apell1 is null or PacApell1 like (rtrim(@spvar_Apell1) + '%') )
					and (@spvar_Apell2 is null or PacApell2 like (rtrim(@spvar_Apell2) + '%') )
					and (@spvar_CodServicio is null or e.CodServicioFinal = @spvar_CodServicio)
					and (@spvar_CodServicioRemite is null or e.CodServicioOrigen = @spvar_CodServicioRemite)
					and (@spvar_FecSolDesde is null or datediff(d, @spvar_FecSolDesde, e.FechaConsulta) >= 0)
					and (@spvar_FecSolHasta is null or datediff(d, @spvar_FecSolHasta, e.FechaConsulta) <= 0)
					and (@spvar_FecCita is null or datediff(d, @spvar_FecCita, e.FechaCPrimera) = 0)
					and (@spvar_FecCitaDesde is null or datediff(d, @spvar_FecCitaDesde, e.FechaCPrimera) >= 0)
					and (@spvar_FecCitaHasta is null or datediff(d, @spvar_FecCitaHasta, e.FechaCPrimera) <= 0)
					and (@spvar_CodCentro is null or e.CodCentroOrigen = @spvar_CodCentro)
					and (@spvar_CodTipoRemision is null or e.TipoRemision = @spvar_CodTipoRemision)
					and (@spvar_Prioridad is null or e.Solicitud = @spvar_Prioridad)
					and (@spvar_DniMedicoDestino is null or e.DniMedDestino = @spvar_DniMedicoDestino)
                    and (@spvar_NoCitados = '0' or (@spvar_NoCitados = '1' and e.FechaCPrimera is null and e.confirmada = '1'))
					and (@spvar_FechaPrevistaDesde is null or e.FechaPrevista >= @spvar_FechaPrevistaDesde)
					and (@spvar_FechaPrevistaHasta is null or e.FechaPrevista <= @spvar_FechaPrevistaHasta)
					and (@spvar_AUGE is null or e.IdGuiaClinica is not null)
					and (@spvar_CodColectivo is null or e.CodColectivo = @spvar_CodColectivo)
					and (@spvar_codCentroDestino is null or e.CodCentroFinal = @spvar_codCentroDestino)
					and (@spvar_Reservadas = '0' or (@spvar_Reservadas = '1' and e.FechaCPrimera = c.FechaCita and c.NoDerecho = 1 ))
					and (@spvar_Confirmadas = '0' or (@spvar_Confirmadas = '1' and e.FechaCPrimera = c.FechaCita and (c.NoDerecho = 0 or c.NoDerecho is null)))
					and (@spvar_idUnidad is null or e.IdUnidad = @spvar_idUnidad)
					and (@spvar_DniMedicoOrigen is null or e.DNIMedEpi = @spvar_DniMedicoOrigen)
					and ((@spvar_LibreEleccion is null and (e.LibreEleccion is null or e.LibreEleccion = 0) or (e.LibreEleccion = 1)))
					and (@spvar_ConfAsistencia = 0 or (@spvar_ConfAsistencia = 1 and c.ConfAsistencia = 1))
					and (@spvar_PRAIS is null
						or 
						(@spvar_PRAIS = 1 and 
						EXISTS (select MS.EsPrais from 
						Hclinica..MutuasSaludSecPaciente MSSP 
						INNER JOIN parametros..MutuasSalud MS on MS.Codigo = MSSP.CodColectivo
						where codpaciente = e.CodPaciente and MS.EsPrais = 1))
						or 
						(@spvar_PRAIS = 0 and 
						NOT EXISTS (select MS.EsPrais from 
						Hclinica..MutuasSaludSecPaciente MSSP 
						INNER JOIN parametros..MutuasSalud MS on MS.Codigo = MSSP.CodColectivo
						where codpaciente = e.CodPaciente and MS.EsPrais = 1)))
				end
			else
				begin
					select 
					e.Codhistoria,
					e.CodPaciente,
					'PacNombre'= rtrim(p.Pacnombre),
					'PacApell1' = rtrim(p.PacApell1),
					'PacApell2' = rtrim(p.PacApell2),
					e.CodEpisodio,
					e.FechaCPrimera,
					c.ConfAsistencia,
					e.FechaConsulta,
					e.DictamenClinico as Juicio,
					e.CodCentroFinal,
					s.Codigo, 
					s.DescServicio ServicioDestino,
					case when e.DerivacionSIC = 1 then se1.DescServicio else s1.DescServicio end as ServicioRemite,		
					'0' as Pasiva,
					e.Solicitud,
					e.FechaPrevista,
					case
						when 
							isnull(
									e.IdGuiaClinica,
									(
										select MIN (I.CodProblema)
										from 	(
													SELECT 
														  ipd.CodPaciente
														, ipd.CodEpisodio
														, ipd.CodProblema
														, ipd.CodSubProblema
														, ipd.CodDiagnostico
														, ipd.IDInformeIPD					
													FROM HClinica..InformeIPD ipd 
													union
													select 
														  tcGES.CodPaciente
														, tcGES.CodEpisodio
														, ipd.CodProblema
														, ipd.CodSubProblema
														, ipd.CodDiagnostico
														, tcGES.IDInformeIPD	
													FROM Hclinica..TrazabilidadCasoGES tcges 
														inner join hclinica..informeipd ipd on tcges.idinformeipd=ipd.idinformeipd 
												) I 
												inner join Parametros..CIEDiagnostico CIEDiag on I.CodDiagnostico=CIEDiag.CodDiagnostico
										WHERE I.CodPaciente=e.CodPaciente
										  and I.CodEpisodio=e.CodEpisodio		
									)
								  ) is null then 0
						else 1
					end as TieneGuia,							
					'' as MotivoPasiva,
					e.CodColectivo,
					MP.Entidad + '-' + MS.Entidad as Aseguradora,
					cs.HospitalRef,
					cs.DescCentro,
					c.NoDerecho,
					c.CodConsulta,
					c.FechaCita,
					c.IdCita,
					c.CodTipoConsulta,
					c.CodigoServicio,
					c.CodTipoConsulta2, 
					e.Confirmada,
					p.NumTarjSanitaria,
					e.comunicada,
					e.CodigoRYF,
					e.CodCentroOrigen,
					COALESCE(cs1.DescCentro,DOC.NomCentro) as DescCentroRef
					,'' as IdMotivo,
					p.FecNac,
					RIGHT('00000000' + LTRIM (RTRIM(AHP.CodHistoriaPapel)),8 ) as CodHistoriaPapel,
					p.Genero,
					'Sexo' = COD.Descripcion,
					'RUT Profesional' = e.DniMedDestino,
					'Profesional' = PM.NomMedico + ' ' + PM.Apell1 + ' ' + PM.Apell2,
					'Citador' = COALESCE(PMcita.NomMedico, DEcita.NombreEnf, Acita.NomAdminis) + ' ' +
								COALESCE(PMcita.Apell1, DEcita.Apell1Enf, Acita.Apell1Administ) + ' ' +
								COALESCE(PMcita.Apell2, DEcita.Apell2Enf, Acita.Apell2Administ),
					'TipoConsulta' = TC.DescTipoCons,
					'Prioridad' = COD2.Descripcion	
		            ,e.Estado 
		            ,u.Descripcion as Unidad 
					,p.DirTelf
					,'TiempoEspera' = DATEDIFF(DD, e.FechaConsulta, ISNULL(e.FechaInicial, GETDATE())) 
					,COD2.Posicion as OrdenPrioridad 
					,e.DerivacionSIC
					,c.Asiste as AsisteCita
					,c.CitaEspontanea 
					,c.HoraInicial as FechaInicial 
					,c.NoAtendido
					,null as FechaNoAtendida
					,e.NoAsistenciasCita
					, c.idOrigenCita 
					, O.DescOrigenCitas
					,p.Email
					,p.Direccion 
					,p.DirNum
					 ,p.CodPostal 
					 ,L.NomPoblacion  
					 ,p1.Nombre as Provincia
					,L.NomPoblacion as Localidad
					,p.telf2
					,isNull(p.TarjSanitariaResp,'') as RutTutor
					
					,IsNull(PMRemite.NomMedico , '') as NombreMedicoRemi
					,IsNull(PMRemite.Apell1 , '') as Apel1MedicoRemi
					,IsNull(PMRemite.Apell2 , '') as Apel2MEdicoRemi
					,IsNull(PMRemite.Nif , '') as RutMedicoRemi
					,I.DescDiagnostico
					,CI.DescDiagnostico as DescDiagnosProvi
					,e.inspecciones 
					,e.IDProblemaSalud
					,gc.DescGuia as descProblema
					,gc1.DescGuia as descSubProblema
					,isnull(PMcita.Nif,isnull(DEcita.Nif,isnull(TD.Nif,Acita.nif))) as Nif
					,e.IdCausaInterconsulta
					,e.DescCausaInterconsulta
					,e.comentarios
					,e.TipoRemision
					,e.motivo
					,e.FolioSigges
					,e.PrioridadHosp
					,Cod3.Posicion as OrdenPrioridadHosp
					,p.AtiendeAlNombre as NombreSocial
					,CASE WHEN 
					(
						EXISTS (select * from Hclinica..MutuasSaludSecPaciente MSSP 
						INNER JOIN parametros..MutuasSalud MS on MS.Codigo = MSSP.CodColectivo
						where codpaciente = e.CodPaciente and MS.EsPrais = 1)
					) THEN 1 ELSE 0 END AS EsPRAIS,	
					'' as ProfesionalAtiende,
					p.Telf3,
					p.TelfFijoUFamiliar
					,e.RUNProfEgreso
					,e.NomProfEgreso
					,e.ObservacionEgreso    
					,e.FechaCierre   					
			from	Consultas..EpisodioConsultas e with (nolock)
					inner join Hclinica..Pacientes p with (nolock) on p.CodPaciente = e.CodPaciente 
					left join Parametros..Servicios s with (nolock) on s.Codigo = e.CodServicioFinal
					left join Parametros..Servicios s1 with (nolock) on s1.Codigo = e.CodServicioOrigen
					left join Parametros..ServiciosExternos se1 with (nolock) on se1.Codigo = e.CodServicioOrigen
					left join Hclinica..citas c with (nolock) on c.CodPaciente = e.CodPaciente and c.codepisodio = e.CodEpisodio
									                             and c.FechaCita = e.FechaCPrimera and c.CodTipoConsulta = 0 
									                            AND ((e.FechaCPrimera IS NULL AND c.FechaEntrada = (SELECT MAX(c1.FechaEntrada) FROM Hclinica..Citas c1 WHERE c.codpaciente = c1.codpaciente AND c.codepisodio = c1.CodEpisodio AND c1.CodTipoConsulta=0)) 
											  OR e.FechaCPrimera = C.FechaCita) 
					left join Parametros..CentrosSalud cs with (nolock) on cs.CodCentro = e.CodCentroFinal
					left join Parametros..CentrosSalud cs1 with (nolock) on cs1.CodCentro = e.CodCentroOrigen
					left join Parametros..DatosOtrosCentros DOC with (nolock) on DOC.CodCent = e.CodCentroOrigen
					left join Parametros..MutuasSalud m on e.CodColectivo = m.codigo
					left join Hclinica..ArchivoHistoriasPapel AHP on AHP.CodPaciente = P.CodPaciente and AHP.CodCentro = cs.CodCentro
					left join Parametros..Codigos COD on COD.Codigo = p.Genero and Tabla = 'EstGenero'
					left join Parametros..ParametrosMedicos PM on PM.DNIMedico = e.DniMedDestino
					left join Parametros..ParametrosMedicos PMcita on PMcita.DNIMedico = e.NIF
					left join Parametros..DatosEnfermeras DEcita on DEcita.DNIEnf = e.NIF
					left join Parametros..Administrativo Acita on Acita.DNIAdminist = e.NIF				
					left join Parametros..TiposConsultas TC on TC.CodTipoCons = c.CodTipoConsulta and TC.CodClaseCons = c.CodTipoConsulta2 and TC.CodServCons = s.Codigo
					left join Parametros..Codigos COD2 on COD2.Codigo = e.Solicitud and COD2.Tabla = 'EstTipoExamen'
					left join Parametros..Unidad u on e.IdUnidad = u.IdUnidad 
					left join Parametros..OrigenesCitas O on c.idOrigenCita = O.idOrigenCita  
					LEFT JOIN parametros..DireccionLocalidad L ON p.DirCodLocalidad = L.CodPoblacion and p.dircodprov = l.codprovincia 		    
					LEFT JOIN parametros..codprovincias p1 on p1.codigo = p.dircodprov
					left join Parametros..ParametrosMedicos PMRemite on PMRemite.DNIMedico = e.DNIMedEpi
					LEFT JOIN Parametros..CIEDiagnostico I on e.CodDiagnosticoProvisional = I.CodDiagnostico
					LEFT JOIN Parametros..CIEDiagnostico CI on e.CodDiagnosticoPrimero = CI.CodDiagnostico
					left join  Parametros..GuiasClinicas gc on  gc.CodGuia = e.IDProblemaSalud 
					left join  Parametros..GuiasClinicas gc1 on  gc1.CodGuia = e.CodSubProblema 
					LEFT JOIN Parametros..TecnicosDatos TD on TD.DNITecnico = e.NIF
					LEFT JOIN Parametros..Codigos Cod3 ON (e.PrioridadHosp = Cod3.Codigo and cod3.Tabla = 'EstTipoExamen')
					LEFT JOIN Parametros..MutuasSalud MS ON e.CodColectivo = MS.Codigo
					LEFT JOIN Parametros..MutuaPrincipal MP ON MS.CodMutua = MP.Codigo								
			where   e.Estado is null
					and (@spvar_Nombre is null or PacNombre like (rtrim(@spvar_Nombre) + '%') )
                    and (@spvar_Apell1 is null or PacApell1 like (rtrim(@spvar_Apell1) + '%') )
                    and (@spvar_Apell2 is null or PacApell2 like (rtrim(@spvar_Apell2) + '%') )
                    and (@spvar_CodServicio is null or e.CodServicioFinal = @spvar_CodServicio)
                    and (@spvar_CodServicioRemite is null or e.CodServicioOrigen = @spvar_CodServicioRemite)
                    and (@spvar_FecSolDesde is null or datediff(d, @spvar_FecSolDesde, e.FechaConsulta) >= 0)
                    and (@spvar_FecSolHasta is null or datediff(d, @spvar_FecSolHasta, e.FechaConsulta) <= 0)
                    and (@spvar_FecCita is null or datediff(d, @spvar_FecCita, e.FechaCPrimera) = 0)
                    and (@spvar_FecCitaDesde is null or datediff(d, @spvar_FecCitaDesde, e.FechaCPrimera) >= 0)
                    and (@spvar_FecCitaHasta is null or datediff(d, @spvar_FecCitaHasta, e.FechaCPrimera) <= 0)
                    and (@spvar_CodCentro is null or e.CodCentroOrigen = @spvar_CodCentro)
                    and (@spvar_CodTipoRemision is null or e.TipoRemision = @spvar_CodTipoRemision)
                    and (@spvar_Prioridad is null or e.Solicitud = @spvar_Prioridad)
                    and (@spvar_DniMedicoDestino is null or e.DniMedDestino = @spvar_DniMedicoDestino)
                    and (@spvar_Citados = '0' or (@spvar_Citados = '1' and e.FechaCPrimera is not null))
                    --09/07/2014 - v4.46 – 0001022: 10925 – JVT - Observaciones pendientes derivación entre instancias INI
                    --and (@spvar_NoCitados = '0' or (@spvar_NoCitados = '1' and e.FechaCPrimera is null))  
                    and (@spvar_NoCitados = '0' or (@spvar_NoCitados = '1' and e.FechaCPrimera is null and e.confirmada = '1'))
					--09/07/2014 - v4.46 – 0001022: 10925 – JVT - Observaciones pendientes derivación entre instancias FIN
                    and (@spvar_FechaPrevistaDesde is null or e.FechaPrevista >= @spvar_FechaPrevistaDesde)
                    and (@spvar_FechaPrevistaHasta is null or e.FechaPrevista <= @spvar_FechaPrevistaHasta)
                    and (@spvar_AUGE is null or e.IdGuiaClinica is not null)
                    and (@spvar_CodColectivo is null or e.CodColectivo = @spvar_CodColectivo)
                    and (@spvar_codCentroDestino is null or e.CodCentroFinal = @spvar_codCentroDestino)           
                   -- and (@spvar_PropConfirmadas = '0' or (@spvar_PropConfirmadas = '1' and (e.confirmada is null or e.confirmada = 1) and (m.autoConfirmar = 1 and cs.autoConfirmar = 1)))        
                    and (@spvar_PropConfirmadas = '0' or (@spvar_PropConfirmadas = '1' and ((e.confirmada = 1) or (e.confirmada is null and m.autoConfirmar = 1 and cs.autoConfirmar = 1))))              
                    and (@spvar_FecConfDesde is null or (datediff(d, @spvar_FecConfDesde, e.FechaConfirmacion) >= 0) or (e.fechaConfirmacion is null and (datediff(d, @spvar_FecConfDesde, e.FechaConsulta) >= 0)))
                    and (@spvar_FecConfHasta is null or (datediff(d, @spvar_FecConfHasta, e.FechaConfirmacion) <= 0) or (e.fechaConfirmacion is null and (datediff(d, @spvar_FecConfHasta, e.FechaConsulta) >= 0))) 
                    and (@spvar_PropPendientes = '0' or (@spvar_PropPendientes = '1' and e.confirmada = 0))
                    and (@spvar_idUnidad is null or e.IdUnidad = @spvar_idUnidad)
                    and (@spvar_Comunicadas = '0' or ((@spvar_Comunicadas = '1' and e.Comunicada = 1) and (m.autoConfirmar = 1 and cs.autoConfirmar = 1)))
                    and (@spvar_SinComunicar = '0' or (@spvar_SinComunicar = '1' and e.comunicada = 0 and e.confirmada = 1))
					and (@spvar_DniMedicoOrigen is null or e.DNIMedEpi = @spvar_DniMedicoOrigen)
					and ((@spvar_LibreEleccion is null and (e.LibreEleccion is null or e.LibreEleccion = 0) or (e.LibreEleccion = 1)))
					and (@spvar_ConfAsistencia = 0 or (@spvar_ConfAsistencia = 1 and c.ConfAsistencia = 1)) --V4.46 - 1024 - ECR
					and (@spvar_PRAIS is null
						or 
						(@spvar_PRAIS = 1 and 
						EXISTS (select MS.EsPrais from 
						Hclinica..MutuasSaludSecPaciente MSSP 
						INNER JOIN parametros..MutuasSalud MS on MS.Codigo = MSSP.CodColectivo
						where codpaciente = e.CodPaciente and MS.EsPrais = 1))
						or 
						(@spvar_PRAIS = 0 and 
						NOT EXISTS (select MS.EsPrais from 
						Hclinica..MutuasSaludSecPaciente MSSP 
						INNER JOIN parametros..MutuasSalud MS on MS.Codigo = MSSP.CodColectivo
						where codpaciente = e.CodPaciente and MS.EsPrais = 1)))
				end
			end
		end
	end

END

GO
GO



--dbo.SpConSQuiDatos.sql

USE [Consultas]
GO

/****** Object:  StoredProcedure [dbo].[SpConSQuiDatos]    Script Date: 11/25/2013 09:42:47 ******/
IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[SpConSQuiDatos]') AND type in (N'P', N'PC'))
DROP PROCEDURE [dbo].[SpConSQuiDatos]
GO

USE [Consultas]
GO

/****** Object:  StoredProcedure [dbo].[SpConSQuiDatos]    Script Date: 11/25/2013 09:42:48 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO




--	PROCEDIMIENTO		: 	SpConSQuiDatos
--	FUNCION                 		: 	Obtiene los datos de un informe quirrgico
--	DEVUELVE                		: 
--	FECHA                  		: 	22/12/2005
--	VERSION                 		: 	1.0
--	AUTOR               : 	Gerardo Prieto David (MECEMSA Consultores)
--  MODIFICACION		:   MPS 31/05/07 possum
--							Jorge Poveda SÃ¡ez 10/12/2007
--							He incluido los campos codExamInterv 1 y 2
--	APLICACIN ORIGEN   	: 	Informe quirurgico
--*******************************************************************
-- MODIFICACIÃ“N: Obtenemos tambiÃ©n la fecha de solicitud y el cÃ³digo del episodio del informe quirÃºrgico
-- FECHA		: 24/07/2008
-- AUTOR		: Oscar Vilella Alarcon
--*******************************************************************
-- MODIFICACIÃ“N: Obtenemos la informaciÃ³n del paciente a mostrar en kiosko
-- FECHA		: 19/08/2008
-- AUTOR		: Oscar Vilella Alarcon
--*******************************************************************
-- MODIFICACIÃ“N: La informaciÃ³n del kiosco la sacamos de la preoperatoria
-- FECHA		: 10/03/2009
-- AUTOR		: Pablo GonzÃ¡lez Moro
--*******************************************************************
-- MODIFICACIÃ“N: El nombre del anestesista se obtiene de la tabla InforeQuirurgico o de Infore Anestesico depeniendo del valor de la constante m_bolAnestesiologia
-- FECHA		: 25/11/2013
-- AUTOR		: CTF - 73569626D - CHC3335_ModificaciÃ³n Campo Analista en InfQuirurgico
--*******************************************************************
-- MODIFICACION:		: 17/05/2017 - v17.2 - 16381 - LMF - Filtrado de secciones y exÃ¡menes por centro
-- MODIFICACION         : 03/08/2017 - v17.3 - 16153 - MPR - Registro Quirurgico - Incorporar registro de Turno
--*******************************************************************

CREATE Proc [dbo].[SpConSQuiDatos]

	@spvar_CodIntervencion varchar(7)
	--CTF - 73569626D - CHC3335_ModificaciÃ³n Campo Analista en InfQuirurgico
	,@spvar_CodCentro char(5)
	
As


	--	Declaracin de variables.
	Declare @spvar_CodAntib int, @spvar_Antibiotico varchar(60), @spvar_DNICir Char(8)
	Declare @spvar_Cir VarChar(45), @spvar_DNIAnes Char(8), @spvar_Anes Varchar(45)
	Declare @spvar_DNIEnf Char(8), @Enf Varchar(45), @spvar_DNI1 Char(8), @spvar_Ayu1 Varchar(45)
	Declare @spvar_DNI2 Char(8), @spvar_Ayu2 Varchar(45), @spvar_DNI3 Char(8), @spvar_Ayu3 Varchar(45)
	Declare @spvar_CodCenRemite CHAR(5)
	declare @spvar_TasaMorbilidad float   --mps
	declare	@spvar_TasaMortalidad float    --mps
	declare @spvar_InfoPaciente varchar(4000)

	--	Valor inicial de las variables.
	Select @spvar_Antibiotico = ''
	Select @spvar_CodAntib = Null	
	Select @spvar_DNICir = ''
	Select @spvar_DNIAnes = ''
	Select @spvar_DNIEnf = ''
	Select @spvar_DNI1 = ''
	Select @spvar_DNI2 = ''
	Select @spvar_DNI3 = ''
	select @spvar_TasaMorbilidad = null
	select @spvar_TasaMortalidad = null

	--	Obtencin de los datos del antibitico empleado.	
	Select 
		@spvar_CodAntib = IQ.CodAntibioticos,
       	@spvar_Antibiotico = CF.DescEspecialidad + CF.DescPresentacion
	From 
		HClinica..InformeQuirurgico IQ,
       	Farmacias..Especialidad CF,
       	Farmacias..REspecialidad CFR
 	Where 
		IQ.CodIntervencion = @spvar_CodIntervencion And	
		CFR.IDEspecialidad = CodAntibioticos And
       	CF.codEspec = CFR.CodEspec And
       	CF.Tipo = CFR.Tipo

	--	Obtencin del DNI del cirujano, del instrumentista y de los ayudantes.	
	Select 
		@spvar_DNICir = CodCirujano,
		@spvar_DNIEnf = CodInstrumentista,
		@spvar_DNI1 = CodAyudante1,
		@spvar_DNI2 = CodAyudante2,
		@spvar_DNI3 = CodAyudante3
	From 
		HClinica..InformeQuirurgico
	Where 
		CodIntervencion = @spvar_CodIntervencion

	--	Obtencin del nombre del cirujano.
	Select 
		@spvar_Cir = Rtrim(parametros..ParametrosMedicos.NomMedico)+' '+RTrim(parametros..ParametrosMedicos.Apell1)+' '+RTrim(parametros..ParametrosMedicos.Apell2)
	From 
		Parametros..ParametrosMedicos
	Where 
		DNIMedico = @spvar_DNICir

	--	Obtencin del DNI del anestesista.
	Select 
		@spvar_DNIAnes = DNIAnestesista
	From 
		HClinica..InformeAnestesico
	Where 
		CodIntervencion = @spvar_CodIntervencion

	--	Obtencin del nombre del anestesista.
	--CTF - 73569626D - CHC3335_ModificaciÃ³n Campo Analista en InfQuirurgico - INI
	IF (SELECT ValorConstante FROM Parametros..constantes WHERE NombreConstante = 'm_bolAnestesiologia' and CentroRef=@spvar_CodCentro)=1
		BEGIN
	--CTF - 73569626D - CHC3335_ModificaciÃ³n Campo Analista en InfQuirurgico - FIN
			Select 
				@spvar_Anes = Rtrim(parametros..ParametrosMedicos.NomMedico)+' '+RTrim(parametros..ParametrosMedicos.Apell1)+' '+RTrim(parametros..ParametrosMedicos.Apell2)
			From 
				Parametros..ParametrosMedicos
			Where 
				DNIMedico = @spvar_DNIAnes
	--CTF - 73569626D - CHC3335_ModificaciÃ³n Campo Analista en InfQuirurgico - INI
		END	
	ELSE
		BEGIN
				Select 
					@spvar_Anes = RTRIM(NombreAnestesista)
				From 
					HClinica..InformeQuirurgico
				Where 
					CodIntervencion = @spvar_CodIntervencion
		END
	--CTF - 73569626D - CHC3335_ModificaciÃ³n Campo Analista en InfQuirurgico - FIN
	
	--	Obtencin del nombre del instrumentista.
	Select 
		@Enf = Rtrim(parametros..DatosEnfermeras.NombreEnf)+' '+RTrim(parametros..DatosEnfermeras.Apell1Enf)+' '+RTrim(parametros..DatosEnfermeras.Apell2Enf)
	From 
		Parametros..DatosEnfermeras
	Where 
		DNIEnf = @spvar_DNIEnf

	--	Obtencin del nombre del primer ayudante.
	Select 
		@spvar_Ayu1 = Rtrim(parametros..DatosEnfermeras.NombreEnf)+' '+RTrim(parametros..DatosEnfermeras.Apell1Enf)+' '+RTrim(parametros..DatosEnfermeras.Apell2Enf)
	From 
		Parametros..DatosEnfermeras
	Where 
		DNIEnf = @spvar_DNIEnf

	--	Obtencin del nombre del segundo ayudante.
	Select 
		@spvar_Ayu2 = Rtrim(parametros..DatosEnfermeras.NombreEnf)+' '+RTrim(parametros..DatosEnfermeras.Apell1Enf)+' '+RTrim(parametros..DatosEnfermeras.Apell2Enf)
	From 
		Parametros..DatosEnfermeras
	Where 
		DNIEnf = @spvar_DNIEnf

	--	Obtencin del nombre del tercer ayudante.
	Select 
		@spvar_Ayu3 = Rtrim(parametros..DatosEnfermeras.NombreEnf)+' '+RTrim(parametros..DatosEnfermeras.Apell1Enf)+' '+RTrim(parametros..DatosEnfermeras.Apell2Enf)
	From 
		Parametros..DatosEnfermeras
	Where 
		DNIEnf = @spvar_DNIEnf

	--	Obtencin del cdigo del centro remitente.
	SELECT 
		@spvar_CodCenRemite = CodCenRemite
	FROM 
		HClinica..Preoperatoria
	WHERE 
		CodIntervencion = @spvar_CodIntervencion

	 -- Datos del resultado del possum. EstÃ¡n en la preoperatoria
	-- MORBILIDAD
	SELECT 
		@spvar_TasaMorbilidad = TasaMorbilidad
	FROM
		HClinica..Preoperatoria
	WHERE
		CodIntervencion = @spvar_CodIntervencion

	-- MORTALIDAD e InfoPaciente
	SELECT 
		@spvar_TasaMortalidad = TasaMortalidad,
		@spvar_InfoPaciente = InfoPaciente
	FROM
		HClinica..Preoperatoria
	WHERE
		CodIntervencion = @spvar_CodIntervencion

	--	Obtencin del resto de valores.
	Select 
		@spvar_DNICir,
		@spvar_Cir, 
		@spvar_DNIAnes,
		@spvar_Anes, 
		@spvar_DNIEnf, 
		@Enf,
       	@spvar_DNI1, 
		@spvar_Ayu1, 
		@spvar_DNI2, 
		@spvar_Ayu2, 
		@spvar_DNI3, 
		@spvar_Ayu3,
       	a.CodMedInforma,
       	Medico = (
			Select 
				Rtrim(Parametros..ParametrosMedicos.NomMedico)+' '+RTrim(Parametros..ParametrosMedicos.Apell1)+' '+RTrim(Parametros..ParametrosMedicos.Apell2)
            From 
				Parametros..ParametrosMedicos
            Where 
				a.CodMedInforma = DNIMedico
		),
       	a.CodQuirofano,
       	a.PosicionInter,
       	Pos = (
			Select 
				Descripcion
            From 
				Parametros..Codigos
            Where 
				(Tabla = 'EstPosIntervencion' Or Tabla = 'N') And
                    			Codigo = IsNull(a.PosicionInter,'N')
		),
		a.CodVia,
      	Via = (
			Select 
				Descripcion
            From 
				Parametros..Codigos
			Where 
				(Tabla = 'EstDescripcionVia' Or Tabla = 'N') And
				Codigo = IsNull(a.CodVia,'N')
		),
		a.CodProcedimiento, 
		DescProced,
       	a.CodPostCIE,
		DescDiagnostico,
       	@spvar_CodAntib, 
		@spvar_Antibiotico,
       	a.TipoInter,
       	Interv = (
			Select 
				Descripcion
            From 
				Parametros..Codigos
            Where 
				(Tabla = 'EstDesIntervencion' Or Tabla = 'N') And
				Codigo = IsNull(a.TipoInter,'N')
		),
		a.DestinoInter,
		Destino = (
			Select 
				Descripcion
			From 
				Parametros..Codigos
			Where 
				(Tabla = 'EstDestIntervencion' Or Tabla = 'N') And
                        			Codigo = IsNull(a.DestinoInter,'N')
		),
       	a.Solicitudes,
       	a.Drenaje, 
       	a.DescOperatoria,
       	a.TecnicasEmpleadas,
       	a.TecnicaCierre,
       	a.PiezaExtirpada,
       	a.HInicioInter,
		a.HFinInter, 
       	a.FInforme,
       	a.CodMutua,
       	Entidad,
       	a.Facturable,
       	a.CantidadProcesos,
       	@spvar_CodCenRemite,
		a.SolBiopsia,
		a.SolLaboratorio,
		a.SolCitologias,
		a.SolHormonales,
		a.SolRadiologia,
		a.SolPostmortem,
		a.CodInforme,
		a.Firmado,
		a.NumCordales,
		a.CodExamInterven,
		a.CodExamInterven1, --Jorge
		a.CodExamInterven2, --Jorge
		@spvar_TasaMorbilidad as TasaMorbilidad,
		@spvar_TasaMortalidad as TasaMortalidad,
		a.FSolicitud,
		a.CodEpisodio,
		@spvar_InfoPaciente as InfoPaciente
		--(08/09/2015) - v4.53r1 - 2500 - VAS - Plano y extremidad de intervenciones quirÃºrgicas - INI
		, a.IdPlano
		, PL.DescPlano
		, a.IdCuadrante
		, CU.DescCuadrante
		--(08/09/2015) - v4.53r1 - 2500 - VAS - Plano y extremidad de intervenciones quirÃºrgicas - FIN
		, a.IdTurnoInfQuirurgico
		
	From 
		/*		/*HClinica..InformeQuirurgico  left join parametros..CIEDiagnostico
		on codpostcie = CodDiagnostico,*/
       	Parametros..Procedimientos P,
       	Parametros..MutuasSalud M left join HClinica..InformeQuirurgico a
		on a.CodMutua = m.codigo,
		parametros..CIEDiagnostico cie*/

			HClinica..InformeQuirurgico a left join Parametros..CIEDiagnostico C on CodPostCIE = c.CodDiagnostico
			right join Parametros..MutuasSalud M on M.Codigo = a.CodMutua--,
			--2500 - VAS prov - INI
			left join Parametros..Planos PL on a.IdPlano = PL.IdPlano
			left join Parametros..Cuadrantes CU on a.IdCuadrante = CU.IdCuadrante
			--2500 - VAS prov - FIN
       		, Parametros..Procedimientos p
 	Where 
		a.CodIntervencion = @spvar_CodIntervencion And
		a.CodProcedimiento = P.CodDiagnostico
		--and a.codpostcie = cie.CodDiagnostico



GO



GO



--dbo.SpConSResumenEpisodioCCWSHC.sql

USE [Consultas]
    GO
    IF EXISTS 
    (
        SELECT * 
            FROM sys.procedures 
            WHERE [object_id] = OBJECT_ID('[dbo].[SpConSResumenEpisodioCCWSHC]')
    )
    BEGIN
        DROP PROCEDURE [dbo].[SpConSResumenEpisodioCCWSHC];
    END
    GO
/*
PROCEDIMIENTO	: Consultas..SpConSResumenEpisodioCCWSHC
FUNCION			: Recupera todos los datos necesarios para la respuesta del método ObtenerResumenHistorialClinico para un episodio de Consulta Externa
ORIGEN          : WS Historial Clínico Florence - Método ObtenerResumenHistorialClinico
DEVUELVE		: Devuelve 11 tablas con los siguientes datos:
							  1. Datos del episodio
							  2. Datos del paciente 							  
							  3. Diagnósticos
							  4. Interconsultas
							  5. Citas	
							  6. Profesional prestador
							  7. Prestaciones y curas
							  8. Recetas
							  9. Prescripciones
							  10. Registro pruebas					  
							  11. Pruebas 
FECHA			: 16/08/2012
VERSION        	: 1.0
AUTOR			: Enrique Sánchez CHC-1919, v4.31.2
****************************************************
REVISIONES:
----------------------------------------------------
AUTOR			: Enrique Sánchez
FECHA			: 18/09/2012
VERSION			: WS Historial Clinico 2.03
INCIDENCIA		: CHC-2062
DESCRIPCION		: Se engloban en una cita ficticia todos los registros de actividades, recetas y pruebas cuya fecha de registro no casa con ninguna de las citas del episodio
----------------------------------------------------
AUTOR			: Enrique Sánchez
FECHA			: 02/11/2012
VERSION			: WS Historial Clinico 2.03
INCIDENCIA		: REQ14162
DESCRIPCION		: Se corrige la unidad temporal de la duración en las recetas prolongadas


MODIFICACION: 30/06/2016 v4.62 - 3009 - JMG - Actualizar PA Visor Historia Clínica Compartida		
MODIFICACION: 30/09/2016 v4.63r3 - 13578 - DVR - Observaciones VIsor H.Compartida 
MODIFICACION: 19/10/2016 v4.63r5 - 13825 - LMF - Descripcion prueba laboratorio(11) y obtencion de otras pruebas(11)	
MODIFICACION: 04/11/2016 v4.63r7 - 14026 - LMF - Se corrige problema de truncamiento al cargar las pruebas.	
MODIFICACION: 22/12/2016 v4.63r9 - 15006 - DVR - Observaciones visor clinico 
MODIFICACION: 30/12/2016 v4.63r9 - 15066 - DVR - Observacion visor clinico 
MODIFICACION: 11/01/2017 v4.63r10 - 15143 - DVR - Modificación de WS historial clínico
MODIFICACION: 23/01/2017 v4.63r12 - 15805 - DVR - Modificación estructura WS historial clínico
MODIFICACION: 12/06/2017 v4.68r4/17.1r4 - 18365 - SGH - Modificación representación de Motivo Consulta en Visor Clínico
*/

CREATE PROCEDURE [dbo].[SpConSResumenEpisodioCCWSHC] 
	@spvar_CodPaciente   CHAR(16),
	@spvar_CodEpisodio   CHAR(5)
AS
BEGIN

DECLARE @spvar_IdEspecialidadDEIS CHAR(10)=NULL
DECLARE @spvar_IdEpisodio CHAR(22) = NULL
DECLARE @spvar_FechaEpisodio DATETIME = NULL

/*---------------------------------------
DATOS COMUNES DEL EPISODIO
----------------------------------------*/

SET @spvar_IdEpisodio=@spvar_CodPaciente + '-' + @spvar_CodEpisodio

/*Datos episodio*/
SELECT @spvar_FechaEpisodio=E.FechaInicial  FROM Consultas..EpisodioConsultas E WHERE E.CodEpisodio=@spvar_CodEpisodio AND E.CodPaciente=@spvar_CodPaciente
SELECT
		'IdEpisodio' = @spvar_IdEpisodio,		
		'FechaHoraInicio' = E.FechaInicial,	
		'EstadoEpisodio' = CASE WHEN E.FechaCierre IS NULL THEN 'Abierto' ELSE 'Cerrado' END,
		'Establecimiento' = isnull(C.DescCentro,''),		
		'TipoEpisodio' = 'Consulta Externa'			  
FROM
		Consultas..EpisodioConsultas E
	    LEFT JOIN Parametros..CentrosSalud C ON E.CodCentroFinal=C.CodCentro		    
	    LEFT JOIN Parametros..Servicios S ON S.Codigo=E.CodServicioFinal
WHERE	
		E.CodEpisodio=@spvar_CodEpisodio AND E.CodPaciente=@spvar_CodPaciente
		
--Datos paciente
SELECT
		'RUT'= P.NumTarjSanitaria,
		'RUNResponsable' = isnull(P.TarjSanitariaResp,''),
		'OtraIdentificacion ' = isnull(P.Nif,''),
		'IdRyF' = ISNULL(P.SegSocial,''),
		'Sexo' = PC.Descripcion,
		'NombreCompleto' = RTRIM(P.PacNombre) + ' ' + RTRIM(P.PacApell1) + ' ' + RTRIM(P.pacapell2),
		'FechaNacimiento' = CONVERT(VARCHAR(10),P.fecnac,120)
FROM
		Hclinica..pacientes P
		LEFT JOIN Parametros..Codigos PC ON PC.Tabla='EstGenero' AND P.Genero=PC.Codigo
WHERE 
		P.CodPaciente=@spvar_CodPaciente

--Anamnesis
SELECT 
	'MotivoConsultaAnamnesis' = isnull(PV.CausaVisita,''),
	'IdEpisodio' = @spvar_IdEpisodio,
	'EnfermedadActual' = isnull(PV.MalActual,''),
	'Indicacion' = (CASE WHEN PV.ExplFisica ='2' THEN isnull(DC.Orientacion,'') --Especialidades
					WHEN PV.ExplFisica ='11' THEN isnull(DPV.PlanYtratamiento,'') --Ginecologia
					ELSE '' END) --Resto
FROM Consultas..PrimeraVisita PV
LEFT JOIN Consultas..DetallePrimeraVisita DPV on PV.CodPaciente = DPV.CodPaciente and PV.CodEpisodio = DPV.CodEpisodio
LEFT JOIN Consultas..DatosCirugiaGD DC on PV.CodPaciente = DC.CodPaciente and PV.CodEpisodio = DC.CodEpisodio
WHERE PV.CodEpisodio=@spvar_CodEpisodio AND PV.CodPaciente=@spvar_CodPaciente

--Diagnósticos
SELECT    
	'DescripcionDiagnostico' = DI.DescDiagnostico,		
	'IdEpisodio' = @spvar_IdEpisodio
FROM
	Hclinica..DiagnosticosCIE DC 
	INNER JOIN Parametros..CIEDiagnostico DI ON DI.CodDiagnostico=DC.CodDiag	 
WHERE
	DC.CodPaciente=@spvar_CodPaciente AND DC.CodEpisodio=@spvar_CodEpisodio
	AND DC.FecBorrado IS NULL

--Interconsultas
SELECT
	'IdSolicitudInterconsulta' = I.CodRegistro,	
	'NombreEspecialidadSolicitudInterconsulta' = SD.DescServicio,	
	'IdEpisodio' = @spvar_IdEpisodio
FROM 
	Hclinica..Interconsulta I	
	INNER JOIN Parametros..Servicios SD ON I.CodServSalida=SD.Codigo	
WHERE
	I.CodPaciente=@spvar_CodPaciente AND I.CodEpisodio=@spvar_CodEpisodio

/*------------------------------------------------
DATOS RELATIVOS A CADA CITA DENTRO DEL EPISODIO
-------------------------------------------------*/	
DECLARE @tmpCitas AS TABLE (
	IdAtencion INTEGER,	
	DescripcionEstablecimiento VARCHAR(250),	
	FechaHoraInicio CHAR(14),
	EstadoAtencion VARCHAR(50),	
	FechaCita SMALLDATETIME,
	NIFMedicoConsulta CHAR(8),
	IdEpisodio CHAR(22),
	CodConsulta CHAR(6)
	)
--Citas
INSERT @tmpCitas 
SELECT 
	'IdAtencion' = C.IdCita,
	'DescripcionEstablecimiento' = isnull(CS.DescCentro,''),
	'FechaHoraInicio' =  convert(CHAR(8), C.FechaCita,112) + ' ' + convert(CHAR(5), C.FechaCita,108),
	'EstadoAtencion' = CASE C.Asiste WHEN 1 THEN 'ASISTE' ELSE 'NO ASISTE' END,
	'FechaCita' = C.FechaCita,
	'NIFMedicoConsulta'= C.NIFMedicoConsulta,
	'IdEpisodio'=@spvar_IdEpisodio,
	'CodConsulta' = C.CodConsulta

FROM
	Hclinica..Citas C 
	INNER JOIN Consultas..EpisodioConsultas E ON E.CodEpisodio=C.CodEpisodio AND E.CodPaciente=C.CodPaciente
	LEFT JOIN parametros..Consultas CN ON CN.CodCons =  C.CodConsulta
	LEFT JOIN Parametros..UbicacionesConsulta UC ON UC.CodUbicCons = CN.CodLocaliz AND UC.CodCentro = CN.CodCentro
	LEFT JOIN Parametros..CentrosSalud CS ON CS.CodCentro=UC.CodCentro
WHERE
	C.CodPaciente=@spvar_CodPaciente AND C.CodEpisodio=@spvar_CodEpisodio and C.Asiste=1 and C.HoraInicial IS NOT NULL



--Profesional cita
DECLARE @tmpProfesionales AS TABLE (RUT VARCHAR(10), NombreCompleto VARCHAR(max),TipoProfesional VARCHAR(max), IdAtencion integer, CodConsulta CHAR(10))
INSERT @tmpProfesionales
SELECT
	'RUT'= isnull(COALESCE(PM.DNIMedico, DE.DNIEnf, A.DNIAdminist),''),
	'NombreCompleto' = isnull(RTRIM(COALESCE(PM.NomMedico,DE.NombreEnf,A.NomAdminis)) + ' ' + RTRIM(COALESCE(PM.Apell1,DE.Apell1Enf,A.Apell1Administ)) + ' ' + RTRIM(COALESCE(PM.Apell2,DE.Apell2Enf, A.Apell2Administ)),''),
	'TipoProfesional' = isnull(SM.DescServicio,''),
	'IdAtencion'=C.IdAtencion,
	'CodConsulta'=C.CodConsulta
FROM
	@tmpCitas C 
	LEFT JOIN parametros..Consultas CN ON CN.CodCons =  C.CodConsulta
	LEFT JOIN Parametros..ParametrosMedicos PM ON PM.DNIMedico=COALESCE(C.NIFMedicoConsulta, CN.nifmedcons)
	LEFT JOIN Parametros..DatosEnfermeras DE ON DE.DNIEnf = COALESCE(C.NIFMedicoConsulta, CN.nifmedcons)
	LEFT JOIN Parametros..Administrativo A ON A.DNIAdminist = COALESCE(C.NIFMedicoConsulta, CN.nifmedcons)
	LEFT JOIN Parametros..Servicios SM ON SM.Codigo=COALESCE(PM.CodServicioMedico,DE.codservicio,A.CodServicioAdminist)



---------------------
--  resumen FISIO ok
---------------------

INSERT @tmpCitas 
select
			fi.codregistro as IdAtencion,
			CS.DescCentro as DescripcionEstablecimiento,
			 convert(CHAR(8), citas.FechaCita,112) + ' ' + convert(CHAR(5), citas.FechaCita,108) as FechaHoraInicio,
			EstadoAtencion = CASE Citas.Asiste WHEN 1 THEN 'ASISTE' WHEN 0 THEN 'NO ASISTE' ELSE 'PENDIENTE' END,
			citas.FechaCita as FechaCita,
			FI.DNIMedico as NIFMedicoConsulta,
			FI.CodEpisodio as IdEpisodio,
			citas.CodGimnasio as CodConsulta
            
	from	HClinica.dbo.CitasFisioterapia citas
			inner join HClinica..Fisioterapia FI On				FI.CodRegistro = Citas.CodRegistro			
			
			left join Parametros..MutuasSalud MS on				citas.CodColectivo = MS.Codigo
	
			left join Ingresos..EpisodioHospitalizacion EH		On	EH.CodPaciente = FI.CodPaciente				And EH.CodEpisodio = FI.CodEpisodio
			left join consultas..Episodioconsultas EC			On	EC.CodPaciente = FI.CodPaciente				And EC.CodEpisodio = FI.CodEpisodio
			left join parametros..puestosfisioterapia agendas	On  agendas.CodAgenda = citas.CodAgenda
			left join parametros..Gimnasios gim					on  citas.CodGimnasio = gim.CodGimnasio
			left join parametros..CentrosSalud CS				on	CS.CodCentro = gim.CentroSalud
			inner join hclinica..pacientes p					on  FI.codPaciente=p.codPaciente
	where	FI.CodPaciente=@spvar_CodPaciente 
			AND FI.CodEpisodio=@spvar_CodEpisodio 
			AND citas.Asiste=1 and citas.Fechallegada is not null



--------------------
--  detalle FISIO profesional ok
---------------------
INSERT @tmpProfesionales
select	distinct
	MEd.nif as RUT,
	ltrim(rtrim(MEd.NomMedico))+' '+ltrim(rtrim(Med.Apell1))+' '+ltrim(rtrim(Med.Apell2)) as NombreCompleto,
    (select DescServicio from parametros..Servicios where Codigo = citas.CodServicio) as 'TipoProfesional',
    fi.codregistro as IdAtencion,
    citas.CodGimnasio as CodConsulta
from	
	HClinica.dbo.CitasFisioterapia citas
	inner join HClinica..Fisioterapia FI On				FI.CodRegistro = Citas.CodRegistro			
	inner join hclinica..pacientes p					on  FI.codPaciente=p.codPaciente
			
	left join Parametros..MutuasSalud MS on				citas.CodColectivo = MS.Codigo
	
	left join Ingresos..EpisodioHospitalizacion EH		On	EH.CodPaciente = FI.CodPaciente	And EH.CodEpisodio = FI.CodEpisodio
	left join consultas..Episodioconsultas EC			On	EC.CodPaciente = FI.CodPaciente	And EC.CodEpisodio = FI.CodEpisodio
			
	left join parametros..puestosfisioterapia agendas	On  agendas.CodAgenda = citas.CodAgenda

	left join parametros..Gimnasios gim					on  citas.CodGimnasio = gim.CodGimnasio
	left join parametros..CentrosSalud CS				on	CS.CodCentro = gim.CentroSalud
			
	left join PARAMETROS..PARAMETROSMEDICOS MED			on  FI.DNIMEdico=MED.DNIMedico
where	FI.CodPaciente  = @spvar_CodPaciente
		AND FI.CodEpisodio = @spvar_CodEpisodio
		AND  citas.Asiste=1  and citas.FechaLlegada IS NOT NULL 
		
		
		
	

--MOSTRAMOS LOS RESULTADOS
--Citas
SELECT 
	IdAtencion,	
	DescripcionEstablecimiento as Establecimiento,	
	FechaHoraInicio,
	EstadoAtencion,	
	IdEpisodio,
	CodConsulta,
	FechaCita
FROM 
	@tmpCitas

	

--Profesionales
SELECT * FROM @tmpProfesionales



--ACTIVIDADES
DECLARE @tmpActividades AS TABLE (IdActividad varchar(12), FechaRegistro DATETIME,Descripcion VARCHAR(max), IdAtencion integer, CodConsulta CHAR(6))
--PRESTACIONES SALUD
INSERT @tmpActividades
SELECT 
	'IdActividad' = PP.CodPrestacion,
	'FechaRegistro' = convert(CHAR(8), PP.FechaHoraRegistro,112) + ' ' + convert(CHAR(5), PP.FechaHoraRegistro,108),
	'Descripcion' = PS.Descripcion,
	'IdAtencion' =  '', --COALESCE(C1.IdAtencion,C2.IdAtencion,C3.IdAtencion) ,
	'CodConsulta' = '' -- COALESCE(C1.CodConsulta,C2.CodConsulta,C3.CodConsulta)	
FROM
	HClinica..PrestacionesPaciente PP
	INNER JOIN Parametros..PrestacionesSalud PS ON PS.CodPrestacion = PP.CodPrestacion
	--LEFT JOIN @tmpCitas C1 ON C1.IdAtencion=PP.IdCita AND PP.CodConsulta=C1.CodConsulta
	--LEFT JOIN @tmpCitas C2 ON C2.FechaCita=PP.FechaCita AND PP.CodConsulta=C2.CodConsulta
	--LEFT JOIN @tmpCitas C3 ON DateAdd(day,datediff(day,0, C3.FechaCita), 0) = DateAdd(day,datediff(day,0, PP.FechaHoraRegistro), 0) -- AND PP.CodConsulta=C3.CodConsulta
WHERE
	PP.CodPaciente = @spvar_CodPaciente	AND PP.CodEpisodio = @spvar_CodEpisodio

UNION	
--PRESTACIONES SALUD AUGE
SELECT
		'IdActividad' = PP.CodPrestacion,
		'FechaRegistro' = convert(CHAR(8), PP.FechaHoraRegistro,112) + ' ' + convert(CHAR(5), PP.FechaHoraRegistro,108),
		'Descripcion' = PSA.Descripcion,
		'IdAtencion' = '', --COALESCE(C1.IdAtencion,C2.IdAtencion,C3.IdAtencion),
		'CodConsulta' = '' --COALESCE(C1.CodConsulta,C2.CodConsulta,C3.CodConsulta)		
FROM
		HClinica..PrestacionesPaciente PP
		INNER JOIN Parametros..PrestacionesSaludAUGE PSA ON PSA.CodPrestacion = PP.CodPrestacion	
		--LEFT JOIN @tmpCitas C1 ON C1.IdAtencion =PP.IdCita AND PP.CodConsulta=C1.CodConsulta
		--LEFT JOIN @tmpCitas C2 ON C2.FechaCita=PP.FechaCita AND PP.CodConsulta=C2.CodConsulta
		--LEFT JOIN @tmpCitas C3 ON DateAdd(day,datediff(day,0, C3.FechaCita), 0) = DateAdd(day,datediff(day,0, PP.FechaHoraRegistro), 0) -- AND PP.CodConsulta=C3.CodConsulta	
WHERE
		PP.CodPaciente = @spvar_CodPaciente AND PP.CodEpisodio = @spvar_CodEpisodio
UNION
--CURAS Y PROCEDIMIENTOS
SELECT	
	'IdActividad' =PC.CodCura,
	'FechaRegistro' = convert(CHAR(8), PC.F_Consulta,112)  + ' ' +  convert(CHAR(5), PC.F_Consulta,108),	
	'Descripcion' = CU.Descripcion,
	'IdAtencion' = '', --COALESCE(C1.IdAtencion,C2.IdAtencion,C3.IdAtencion),
	'CodConsulta' =''  --COALESCE(C1.CodConsulta,C2.CodConsulta,C3.CodConsulta)
FROM
	Hclinica..ProcedimientosCitas PC
	--LEFT JOIN @tmpCitas C1 ON C1.IdAtencion=PC.IdCita AND PC.CodConsulta=C1.CodConsulta
	--LEFT JOIN @tmpCitas C2 ON C2.FechaCita=PC.FechaCita AND PC.CodConsulta=C2.CodConsulta
	--LEFT JOIN @tmpCitas C3 ON DateAdd(day,datediff(day,0, C3.FechaCita), 0) = DateAdd(day,datediff(day,0, PC.F_Consulta), 0) -- AND PC.CodConsulta=C3.CodConsulta	
	INNER JOIN Parametros..Curas CU ON CU.CodCura = PC.CodCura		
WHERE
	PC.CodPaciente = @spvar_CodPaciente AND PC.CodEpisodio = @spvar_CodEpisodio

--RECETAS
DECLARE @tmpRecetas AS TABLE (IdReceta integer, Fecha DATETIME,TipoReceta VARCHAR(250),Estado VARCHAR(20), IdAtencion integer, CodConsulta CHAR(6))
INSERT @tmpRecetas
SELECT 
	'IdReceta' = R.IDRecetaTratamiento,
	'FechaGeneracion' = T.FecConsulta,
	'TipoReceta' = TR.Descripcion,
	'Estado' = 'Entregada',
	'IdAtencion'= '', --C.IdAtencion,
	'CodConsulta' = '' -- C.CodConsulta
FROM	
	Consultas..Tratamiento T
	INNER JOIN Consultas..RecetaTratamientoMed R ON T.IdRecetaTratamiento=R.IDRecetaTratamiento
	LEFT JOIN Parametros..TipoRecetaTrat TR ON R.codTipoReceta=TR.IDTipoRecetaTrat
	--INNER JOIN @tmpCitas C ON DateAdd(day,datediff(day,0, C.FechaCita), 0) = DateAdd(day,datediff(day,0, T.FecConsulta), 0)  --AND C.CodConsulta=T.CodConsulta
WHERE	
	T.CodPaciente=@spvar_CodPaciente AND T.CodEpisodio=@spvar_CodEpisodio	
UNION	--Recetas prolongadas
SELECT 
	'IdReceta' = R.IDRecetaTratamiento,
	'FechaGeneracion' = TR.FecConsulta, 
	'TipoReceta' = TRT.Descripcion,
	'Estado' = 'Entregada',
	'IdAtencion'= '', --C.IdAtencion,
	'CodConsulta' = '' --C.CodConsulta
FROM	
	Consultas..RecetaTratamientoMed R	
	INNER JOIN  Consultas..Tratamiento TR ON TR.IdRecetaTratamiento = R.idRecetaTratamiento 
	INNER JOIN  Consultas..RecetaTtoProlongada RT ON RT.idRecetaTratamiento = R.IDRecetaTratamiento 
	INNER JOIN  Consultas..RecetaTtoMedicamentoProlongada RMP ON RMP.idRecetaProlongada = RT.idRecetaTtoProlongada
	LEFT JOIN Parametros..TipoRecetaTrat TRT ON R.codTipoReceta=TRT.IDTipoRecetaTrat
	--INNER JOIN @tmpCitas C ON DateAdd(day,datediff(day,0, C.FechaCita), 0) = DateAdd(day,datediff(day,0, R.Fecha), 0)  --AND C.CodConsulta=T.CodConsulta
WHERE	
	R.CodPaciente=@spvar_CodPaciente AND TR.CodEpisodio=@spvar_CodEpisodio AND TR.Receta=1

--PRESCRIPCIONES
DECLARE @tmpPrescripciones TABLE (IdPrescripcion INT, DescripcionPrescripcion VARCHAR(max),Entregado VARCHAR(10),FechaRegistro DATETIME,IdReceta INT)
INSERT @tmpPrescripciones
SELECT DISTINCT	
	IdPrescripcion=T.IdEspecialidad,
	DescripcionPrescripcion = (Case WHEN GC.NombreGuia IS NULL THEN RTRIM(CFE.DescEspecialidad) ELSE GC.NombreGuia END) + ': ' +
	(
		CASE When convert(INT,dosismed)=dosismed then convert(VARCHAR,dosismed) else convert(VARCHAR,convert(decimal(10,5),dosismed)) end +
		CASE isnull(DetalleDosis,'') WHEN '' THEN '' ELSE ' ' + RTRIM(DetalleDosis)  END +
		CASE WHEN T.DosisUnitaria=1 THEN ' Dosis única'
		ELSE
			CASE WHEN FrecDosis IS NOT NULL THEN			
				 ' C/' + RTRIM(CONVERT(VARCHAR,FrecDosis)) + ' ' + C1.Descripcion + ' durante ' + cast(T.TiempoTratam as varchar) + ' ' + codtmpTrat.Descripcion													
			ELSE
				' '	
			END
		END	
	),
	Entregado=isnull(convert(VARCHAR(10),D.Unidades),''),
	'FechaRegistro'=T.FecConsulta,
	'IdReceta' = T.idRecetaTratamientoMed	
FROM
	Consultas..HistTratamientoMedico T
LEFT JOIN
	Parametros..Codigos C1 ON T.UdTmpDosis=C1.Codigo AND C1.Tabla = 'EstTiempoDurac1'
LEFT JOIN  
	Parametros..Codigos codtmpTrat ON codtmpTrat.Tabla = 'EstTiempoDurac2' AND codtmpTrat.Codigo =T.UdTmpDuracion
INNER JOIN 
	Farmacias..REspecialidad CFRE ON CFRE.IdEspecialidad = T.IdEspecialidad AND (CFRE.Tipo = '1' OR CFRE.Tipo = '2')
INNER JOIN 
	Farmacias..GuiasCentro GC ON GC.idEspecialidad = CFRE.IdEspecialidad
INNER JOIN 
	Farmacias..Especialidad CFE ON CFRE.CodEspec=CFE.CodEspec 
								AND	CFE.Tipo=CFRE.Tipo 
								AND	CFE.FecBaja IS NULL 
								AND (CFRE.Tipo = '1' OR CFRE.Tipo = '2')
								AND (CFE.FecAlta=CFRE.FecAlta 
									OR (CFE.FecAlta IS NULL AND CFRE.FecAlta IS NULL) 
									AND CFRE.FecBaja = CFE.FecBaja 
									OR (CFRE.FecBaja IS NULL AND CFE.FecBaja IS NULL)
									)
LEFT JOIN Consultas..Dispensaciones D ON D.IdEspecialidad=T.IdEspecialidad AND T.CodEpisodio=D.CodEpisodio AND T.CodPaciente=D.CodPaciente AND T.FecConsulta=D.FecConsulta
INNER JOIN @tmpRecetas TR ON TR.IdReceta=T.idRecetaTratamientoMed
WHERE 
	T.CodPaciente = @spvar_CodPaciente AND
	T.CodEpisodio = @spvar_CodEpisodio	

UNION
SELECT DISTINCT
	IdPrescripcion=T.IdEspecialidad,
	DescripcionPrescripcion =  (Case WHEN GC.NombreGuia IS NULL THEN RTRIM(CFE.DescEspecialidad) ELSE GC.NombreGuia END) + ': ' +	
	(
		CASE When convert(INT,dosismed)=dosismed then convert(VARCHAR,dosismed) else convert(VARCHAR,convert(decimal(10,5),dosismed)) end +
		CASE isnull(DetalleDosis,'') WHEN '' THEN '' ELSE ' ' + RTRIM(DetalleDosis)  END +
		CASE WHEN T.DosisUnitaria=1 THEN ' Dosis única'
		ELSE
			CASE WHEN FrecDosis IS NOT NULL THEN			
				 ' C/' + RTRIM(CONVERT(VARCHAR,FrecDosis)) + ' ' + C1.Descripcion + ' durante ' + cast(T.TiempoTratam as varchar) + ' ' + codtmpTrat.Descripcion									
			ELSE
				' '	
			END
		END		
	),	
	Entregado=isnull(convert(VARCHAR(10),D.Unidades),''),
	'FechaRegistro'= T.FecConsulta,
	'IdReceta'=T.idRecetaTratamientoMed	
FROM
	Consultas..TratamientoMedico T
LEFT JOIN
	Parametros..Codigos C1 ON T.UdTmpDosis=C1.Codigo AND C1.Tabla = 'EstTiempoDurac1'
LEFT JOIN  
	Parametros..Codigos codtmpTrat ON codtmpTrat.Tabla = 'EstTiempoDurac2' AND codtmpTrat.Codigo =T.UdTmpDuracion
INNER JOIN 
	Farmacias..REspecialidad CFRE ON CFRE.IdEspecialidad = T.IdEspecialidad AND (CFRE.Tipo = '1' OR CFRE.Tipo = '2')
INNER JOIN 
	Farmacias..GuiasCentro GC ON GC.idEspecialidad = CFRE.IdEspecialidad
INNER JOIN 
	Farmacias..Especialidad CFE ON CFRE.CodEspec=CFE.CodEspec 
								AND	CFE.Tipo=CFRE.Tipo 
								AND	CFE.FecBaja IS NULL 
								AND (CFRE.Tipo = '1' OR CFRE.Tipo = '2')
								AND (CFE.FecAlta=CFRE.FecAlta 
									OR (CFE.FecAlta IS NULL AND CFRE.FecAlta IS NULL) 
									AND CFRE.FecBaja = CFE.FecBaja 
									OR (CFRE.FecBaja IS NULL AND CFE.FecBaja IS NULL)
									)
LEFT JOIN Consultas..Dispensaciones D ON D.IdEspecialidad=T.IdEspecialidad AND T.CodEpisodio=D.CodEpisodio AND T.CodPaciente=D.CodPaciente AND T.FecConsulta=D.FecConsulta
INNER JOIN @tmpRecetas TR ON TR.IdReceta=T.idRecetaTratamientoMed
WHERE 
	T.CodPaciente = @spvar_CodPaciente AND
	T.CodEpisodio = @spvar_CodEpisodio		
UNION
SELECT distinct 
	IdPrescripcion=RMP.IDEspecialidad,			
	DescripcionPrescripcion = (Case WHEN GC.NombreGuia IS NULL THEN RTRIM(CFE.DescEspecialidad) ELSE GC.NombreGuia END) + ': ' +
	(
	cast(RMP.unidadesDosis  as varchar) + ' ' + RMP.detalleDosis + 	
	CASE WHEN RMP.frecuenciaDosis IS NOT NULL THEN			
			' C/' + cast(RMP.frecuenciaDosis as varchar) + ' ' + codFrec.Descripcion + ' durante ' + cast(RMP.diasTotal as varchar) + ' ' + codtmpTrat.Descripcion					
	ELSE
			' '	
	END		
	),
	Entregado=isnull(convert(VARCHAR(10),D.Unidades),''),
	'FechaRegistro'= TR.FecConsulta,
	'IdReceta'=T.IDRecetaTratamiento	
FROM Consultas..RecetaTratamientoMed T
	INNER JOIN Consultas..Tratamiento TR ON TR.IdRecetaTratamiento = T.idRecetaTratamiento 
	INNER JOIN Consultas..RecetaTtoProlongada RT ON RT.idRecetaTratamiento = T.IDRecetaTratamiento 
	INNER JOIN Consultas..RecetaTtoMedicamentoProlongada RMP ON RMP.idRecetaProlongada = RT.idRecetaTtoProlongada
	INNER JOIN Farmacias..REspecialidad CFRE ON CFRE.IdEspecialidad  = RMP.IdEspecialidad
	LEFT JOIN  Parametros..Codigos codFrec ON codFrec.Tabla = 'EstTiempoDurac1' and codFrec.Codigo =RMP.UdTmpDosis
	LEFT JOIN  Parametros..Codigos codtmpTrat ON codtmpTrat.Tabla = 'EstTiempoDurac2' and codtmpTrat.Codigo =RMP.UdTmpDuracion
	INNER JOIN Farmacias..Especialidad CFE ON CFE.CodEspec = CFRE.CodEspec	
	LEFT JOIN  Consultas..Dispensaciones D ON D.IdEspecialidad=RMP.idEspecialidad AND TR.CodEpisodio=D.CodEpisodio AND TR.CodPaciente=D.CodPaciente AND TR.FecConsulta=D.FecConsulta
	INNER JOIN Farmacias..GuiasCentro GC ON GC.idEspecialidad = CFRE.IdEspecialidad
	INNER JOIN @tmpRecetas TMPR ON TMPR.IdReceta=T.idRecetaTratamiento	
WHERE	
	T.CodPaciente= @Spvar_CodPaciente AND
	TR.CodEpisodio=@spvar_CodEpisodio
	
--Actividades
SELECT * FROM @tmpActividades

--Recetas
SELECT * FROM @tmpRecetas TR1 


--Prescripciones
SELECT * FROM @tmpPrescripciones

END
GO



--dbo.SpConUCierrePaciente.sql

USE [Consultas];
GO
IF EXISTS (SELECT * FROM sys.procedures WHERE [object_id] = OBJECT_ID('[dbo].[SpConUCierrePaciente]'))
BEGIN
    DROP PROCEDURE [dbo].[SpConUCierrePaciente];
END
GO

/***********************************************************************
PROCEDIMIENTO: SpConUCierrePaciente
FUNCION: Realiza el cierre del paciente de consultas
DEVUELVE:
FECHA: 16/04/2008
VERSION: 2.20
AUTOR: MPS
APLICACIÓN ORIGEN: FCierrePac
COMENTARIOS: procede del antiguo SpConICierrePac. Se estandarizan los parámetros y se añade el borrar las citas que tenga pendientes el paciente
MODIFICACIÓN: Ismael Sampere (02/10/2009) - Incluido el motivo de eliminacion
MODIFICACIÓN: Ramón Jiménez (23/02/2011) - Actualizamos EstadoRCLE y desplanificamos
MODIFICACIÓN: Miguel Angel Gómez (11/01/2012) - Implementamos que si la propuesta tiene datos se cambie el estado y se inserte un motivo de egreso. Y si no tiene datos se elimine
MODIFICACIÓN: Miguel Angel Gómez (13/01/2012) - Colocamos después del cursor la actualización y borrado de episodios que no tienen fecha de inicio
MODIFICACIÓN: Enrique Sánchez (30/10/2012) - Añadimos los parámetros de entrada Puesto y Usuario. Recuperamos una tabla con los episodios egresados
MODIFICACIÓN: (20/11/2014) Alberto Pagán Benedicto - V4.49 - 1440 - APB - Segunda parte Derivación entre instancias
* MODIFICACION: v4.56 - 2647 - CCM - Parametrización de motivos de citas
* MODIFICACION: (16/03/2016) v4.60 - 3013 - SGN - Histórico datos de pacientes sidra II
* MODIFICACION: (17/08/2016) - V4.63 – 12711 – CCM – Auditoria SIC
* MODIFICACIÓN	: 05/09/2016 - v4.64 - 12771 - CCM - Repasar las tablas que tienen historificacion
* MODIFICACION: 15/05/2017 - v17.2 - 16142 - FCB - Solicitud de Pabellón - Registro de especialidad
* MODIFICACION: (23/08/2017) - v17.3 – 18451 – FCB - Ingresar observación al motivo de egreso en SIC
************************************************************************/

CREATE PROCEDURE [dbo].[SpConUCierrePaciente]
     @spvar_CodPaciente char(16)
    ,@spvar_Fecha smalldatetime
    ,@spvar_MedCierre char(8) = null
    ,@spvar_Puesto varchar(50) = ''
    ,@spvar_Usuario varchar(8) = ''
	,@spvar_FechaModificacion datetime  = null
	,@spvar_DNIProfModifica char(8) = null
	,@spvar_RUNProfesional varchar(9) = null
	,@spvar_NomProfesional varchar(80) = null
	,@spvar_Observacion varchar(500) = null
AS

--ESA CHC2038 INI
declare @tablaEpisodiosEgresados as table (
	 CodPaciente char(16)
	,CodEpisodio char(5)
	,IdMotivo int
	,DescMotivo varchar(500)
	,CodigoRyF varchar(20)
	,CodSistema tinyint --(20/11/2014) - V4.49 – 1440 – APB – Segunda parte Derivación entre instancias
)
--ESA CHC2038 FIN

declare @tablaEpisodios as table (
	 CodEpisodio char(5),
	 Motivo int,
	 DescMotivo varchar(500)
)

declare @spvar_CodEpisodio char(5)
       ,@Motivo int
       ,@CantDatosEpi int = 0
       ,@DescMotivo as varchar(500) --ESA CHC2038
       ,@CodCentro as char(5)
        
--select @Motivo = (SELECT TOP 1 Codigo
--				  FROM Parametros..MotivosCitas
--				  WHERE (Eliminado is null or Eliminado = 0) and MotivoEliPropuesta = 1 and Exitus = 1)

--ESA CHC2038 INI
--select @DescMotivo = (SELECT TOP 1 Descripcion
--				      FROM Parametros..MotivosCitas
--				      WHERE Codigo = @Motivo)
--ESA CHC2038 FIN

/*Actualizar Pacientes*/
update Hclinica..Pacientes
set FecFin = @spvar_Fecha
	,FechaModificacion = @spvar_FechaModificacion
	,DNIProfModifica = @spvar_DNIProfModifica
where CodPaciente = @spvar_CodPaciente


set @CodCentro = parametros.dbo.fnParHospitalReferencia()

--Actualizar EpisodioConsultas
if exists (select CodPaciente from Consultas..EpisodioConsultas 
           where CodPaciente = @spvar_CodPaciente and FechaInicial is not null)
begin
        --obtenemos los códigos de episodio que se van a cerrar para volcar sus tratamientos al histórico
        insert into @tablaEpisodios
        select ec.CodEpisodio, mc.Codigo, mc.Descripcion
        from Consultas..EpisodioConsultas AS ec LEFT OUTER JOIN
                      parametros..MotivosCitas AS mc ON mc.CodCentro = ISNULL(ec.CodCentroFinal, @CodCentro) AND (mc.Eliminado IS NULL OR
                      mc.Eliminado = 0) AND mc.MotivoEliPropuesta = 1 AND mc.Exitus = 1
        where ec.CodPaciente = @spvar_CodPaciente and ec.FechaInicial is not null

        DECLARE CursorEpi CURSOR FOR

        SELECT CodEpisodio, Motivo, DescMotivo
        FROM @tablaEpisodios

        OPEN CursorEpi

        FETCH NEXT FROM CursorEpi INTO @spvar_CodEpisodio, @Motivo, @DescMotivo
        WHILE @@FETCH_STATUS = 0
        BEGIN
             exec hclinica..SpHClUVolcadoTToConsultas @spvar_CodPaciente, @spvar_CodEpisodio
              
              -----------------------------------------------------------------------------------
              -------------------- HISTORIFICACION DE HOSPITAL DE DIA ---------------------------
              -----------------------------------------------------------------------------------

              /***************** Cerramos los tratamientos abiertos del episodio ***************/
              DECLARE @Tratamientos table (
                     IdTRatamiento int
                    ,MotivoEliminacion int
                    ,NifMedCierre char(8)
                    ,Cerrado bit
              )

              insert into @Tratamientos
              select IdTratamiento
                    ,(select Codigo from Farmacias..MotivosSuspension where CierreAuto = 1)
                    ,@spvar_MedCierre
                    ,0 
              from Consultas..TratamientoHDia
              where FecCierre is null and CodPaciente = @spvar_CodPaciente and CodEpisodio = @spvar_CodEpisodio

              DECLARE @IdTratamiento int
              DECLARE @MotivoEliminacion int
              DECLARE @NifMedCierre char(8)

              while exists(select * from @Tratamientos where Cerrado = 0)
              begin
                    select top(1)
                           @IdTratamiento = IdTRatamiento
                          ,@MotivoEliminacion = MotivoEliminacion
                          ,@NifMedCierre = NifMedCierre
                    from @Tratamientos 
                    where Cerrado = 0

                    exec Consultas..SpConUCierraTtoHDia @IdTratamiento, @MotivoEliminacion, @NifMedCierre
                    
                    update @Tratamientos
                    set Cerrado = 1
                    where IdTRatamiento = @IdTratamiento and MotivoEliminacion = @MotivoEliminacion and NifMedCierre = @NifMedCierre and Cerrado = 0
              end

              /***************** Volcamos al historico los tratamientos del episodio ***************/

              exec Consultas..SpConIHistorificacionTHDia @spvar_CodPaciente,@spvar_CodEpisodio

              -----------------------------------------------------------------------------------
              -------------------- HISTORIFICACION DE HOSPITAL DE DIA ---------------------------
              -----------------------------------------------------------------------------------
              
              --Actualizamos el episodio con Fecha de cierre
               update EpisodioConsultas
			   set FechaCierre = @spvar_Fecha
				  ,SalidaAlta = '8'
				  	,RUNProfEgreso = ISNULL(@spvar_RUNProfesional,RUNProfEgreso)
					,NomProfEgreso = ISNULL(@spvar_NomProfesional,NomProfEgreso)
					,ObservacionEgreso = ISNULL(@spvar_Observacion,ObservacionEgreso)
			   where CodPaciente = @spvar_CodPaciente and CodEpisodio = @spvar_CodEpisodio and FechaInicial is not null 
              
              --Comprobamos si el episodio tiene datos o no
              exec Consultas..SpConSCompruebaEpisodio @spvar_CodPaciente, @spvar_CodEpisodio, @CantDatosEpi output
              
              --ESA CHC2038 INI
              
              --Insertamos en la tabla de resultados @tablaEpisodiosBorrados los episodios que se egresan
              insert @tablaEpisodiosEgresados
              select @spvar_CodPaciente
				    ,@spvar_CodEpisodio
				    ,@Motivo
				    ,@DescMotivo
				    ,CodigoRyF
				    ,CodSistema --(20/11/2014) - V4.49 – 1440 – APB – Segunda parte Derivación entre instancias
              from Consultas..EpisodioConsultas
              where CodEpisodio = @spvar_CodEpisodio and CodPaciente = @spvar_CodPaciente
              
              --Insertamos la trazabilidad                  
			  INSERT INTO Consultas.dbo.TrazabilidadEpisodioConsultas
					   (CodPaciente
					   ,CodEpisodio
					   ,Usuario
					   ,Puesto
					   ,FCreacion
					   ,FPrevista
					   ,FModificacion
					   ,CodCentroAnterior
					   ,CodCentroNuevo
					   ,FCita
					   ,FCitacion
					   ,FEliminacion
					   ,FEliminacionCita
					   ,FPasiva
					   ,FActiva
					   ,FCierre
					   ,FAlta
					   ,Asiste
					   ,Motivo)
				 VALUES
					   (@spvar_CodPaciente --CodPaciente
					   ,@spvar_CodEpisodio --CodEpisodio
					   ,@spvar_Usuario --Usuario
					   ,@spvar_Puesto --Puesto
					   ,NULL --FCreacion
					   ,NULL --FPrevista
					   ,NULL --FModificacion
					   ,NULL --CodCentroAnterior
					   ,NULL --CodCentroNuevo
					   ,NULL --FCita
					   ,NULL --FCitacion
					   ,GETDATE() --FEliminacion
					   ,NULL --FEliminacionCita
					   ,NULL --FPasiva
					   ,NULL --FActiva
					   ,NULL --FCierre
					   ,NULL --FAlta
					   ,NULL --Asiste
					   ,@DescMotivo --Motivo
					   )
              
              --Cambiamos el estado a Egresado e insertamos el motivo de eliminación
              exec Consultas..SpConUEpisodioEgresado @spvar_CodPaciente, @spvar_CodEpisodio, @Motivo, NULL ,@spvar_Puesto ,@spvar_Usuario, NULL, NULL, @spvar_RUNProfesional, @spvar_NomProfesional, @spvar_Observacion
              
              --Si no tiene datos, cambiamos el estado y borramos la propuesta
              if @CantDatosEpi = 0
              begin
				   delete from Consultas..EpisodioConsultas
				   where CodPaciente = @spvar_CodPaciente and CodEpisodio = @spvar_CodEpisodio
              end                                
              --ESA CHC2038 FIN
              
              FETCH NEXT FROM CursorEpi
              INTO @spvar_CodEpisodio, @Motivo, @DescMotivo
        END -- WHILE FETCH

        CLOSE CursorEpi
        DEALLOCATE CursorEpi
end
   
--Actualizamos los episodios sin fecha de inicio y los borramos
if exists (select CodPaciente from Consultas..EpisodioConsultas 
           where CodPaciente = @spvar_CodPaciente and FechaInicial is null)
   begin
	    update EpisodioConsultas
		set FechaCierre = @spvar_Fecha
		   ,SalidaAlta = '8'
		   ,IdMotivo = (SELECT TOP(1) M.Codigo FROM Parametros.dbo.MotivosCitas AS M  WHERE M.CodCentro = ISNULL(EpisodioConsultas.CodCentroFinal, @CodCentro) AND (M.Eliminado IS NULL OR M.Eliminado = 0) AND M.MotivoEliPropuesta = 1 AND M.Exitus = 1)--@Motivo --ESA CHC2038
			,RUNProfEgreso = ISNULL(@spvar_RUNProfesional,RUNProfEgreso)
			,NomProfEgreso = ISNULL(@spvar_NomProfesional,NomProfEgreso)
			,ObservacionEgreso = ISNULL(@spvar_Observacion,ObservacionEgreso)
		where CodPaciente=@spvar_CodPaciente and  FechaInicial is null
	  
        --ESA CHC2038 INI         
                    
        --Insertamos en la tabla de resultados @tablaEpisodiosBorrados los episodios que se egresan
        insert @tablaEpisodiosEgresados 
		select @spvar_CodPaciente
		      ,ec.CodEpisodio
			-- ,@Motivo
			--  ,@DescMotivo
				,mc.Codigo
				,mc.Descripcion
			  ,ec.CodigoRyF
			  ,ec.CodSistema --(20/11/2014) - V4.49 – 1440 – APB – Segunda parte Derivación entre instancias
		from Consultas..EpisodioConsultas as ec LEFT OUTER JOIN
                      parametros..MotivosCitas AS mc ON mc.CodCentro = ISNULL(ec.CodCentroFinal, @CodCentro) AND (mc.Eliminado IS NULL OR
                      mc.Eliminado = 0) AND mc.MotivoEliPropuesta = 1 AND mc.Exitus = 1
		where CodPaciente = @spvar_CodPaciente and FechaInicial is null
          
        --Insertamos la trazabilidad                  
	    INSERT INTO Consultas.dbo.TrazabilidadEpisodioConsultas
			     (CodPaciente
			     ,CodEpisodio
			     ,Usuario
			     ,Puesto
			     ,FCreacion
			     ,FPrevista
			     ,FModificacion
			     ,CodCentroAnterior
			     ,CodCentroNuevo
			     ,FCita
			     ,FCitacion
			     ,FEliminacion
			     ,FEliminacionCita
			     ,FPasiva
			     ,FActiva
			     ,FCierre
			     ,FAlta
			     ,Asiste
			     ,Motivo)
		 
		 SELECT @spvar_CodPaciente --CodPaciente
			   ,CodEpisodio --CodEpisodio
			   ,@spvar_Usuario --Usuario
			   ,@spvar_Puesto --Puesto
			   ,NULL --FCreacion
			   ,NULL --FPrevista
			   ,NULL --FModificacion
			   ,NULL --CodCentroAnterior
			   ,NULL --CodCentroNuevo
			   ,NULL --FCita
			   ,NULL --FCitacion
			   ,GETDATE() --FEliminacion
			   ,NULL --FEliminacionCita
			   ,NULL --FPasiva
			   ,NULL --FActiva
			   ,NULL --FCierre
			   ,NULL --FAlta
			   ,NULL --Asiste
			   ,mc.Descripcion --Motivo				   
		 FROM Consultas..EpisodioConsultas as ec LEFT OUTER JOIN
                      parametros..MotivosCitas AS mc ON mc.CodCentro = ISNULL(ec.CodCentroFinal, @CodCentro) AND (mc.Eliminado IS NULL OR
                      mc.Eliminado = 0) AND mc.MotivoEliPropuesta = 1 AND mc.Exitus = 1
		 WHERE CodPaciente = @spvar_CodPaciente and FechaInicial is null
         
         --ESA CHC2038 FIN
                  	  
		 delete from Consultas..EpisodioConsultas
		 where CodPaciente = @spvar_CodPaciente and FechaInicial is null
   end

--Actualizamos las preoperatorias y su planificación
declare @tablaIntervenciones as table (
	  CodIntervencion varchar(7)
)

insert into @tablaIntervenciones
select CodIntervencion
from Hclinica..Preoperatoria P with(nolock)
where Fsuspendida is null --que no esté suspendida
      and feliminada is null --que no esté eliminada
      and fintervencion is null --que no esté intervenida
      and codpaciente = @spvar_CodPaciente

--Pasamos al estado de suspendida correcto

INSERT INTO Historificacion..HClinica_Preoperatoria
		   (CodHojaPreop, CodIntervencion, CodPaciente, CodEpisodio, CodProc,
			CodProtocolo, TipoAnestesia, JClinico, CodCIEPreop, RQuirurgico,
			ProfAntibiotica, ProfOtros, ProfTromboembolica, Region, FPreoperatoria,
			DNIMedicoPreop, DescPreop, TecPrevistas, CSuspendida, FPrevista,
			Ambulatoria, Tipo, PreopCompleto, FIntervencion, Autotransfusion,
			VistoBueno, MedicoRemite, CodMutua, Anestesista, FConsentInterv,
			FConsentProtesis, CodCenRemite, Preanestesia, FPasivo, DiasLEspera,
			NecesHemoderiv, UsuHemoderiv, CodHistoria, Eliminado, Servicio,
			FechaFirma, FechaUltimaAct, DescProtocolo, CiruMenor, TiempoOper,
			CodProtocolo2, DescProtocolo2, CodProtocolo3, DescProtocolo3, cma, 
			MotivoPreferente, Estado, JornadaExtra, DniASQ, FEliminada, FSuspendida,
			TasaMorbilidad, TasaMortalidad, Lateralidad, ResaltaPlaning, CodExamInterven,
			TieneImagen, Factivo, FultimoPasivo, JornadaExtraVali, DniASQVali,
			ObservacionesPreoper, Confirmacion, EliminadoPlan, CMAsinHDIA,
			CodigoGRD, PesoGRD, Complejidad, RequiereUvi, EstadoRCLE, InfoPaciente,
			dniInfoPacMed, dniInfoPacEnf, dniInfoPacAnes, FInfoPaciente, ObsEnfermeria,
			Neoplasia, DniCirujanoPrevisto, AvisadoPac, ObservacionesAvisadoPac,
			DniAvisadoPac, CodAvisoPac, ComplejidadPreop, IntervencionEspecial,
			UHD, TieneEquipo, CentroDestino, TipoCenRemite, ServicioOrigen,
			Ayudantes, AlergiaLatex, RequiereIngreso, TieneProtesis, Infeccioso,
			Preparatoria, DNISuspendida, DNIEliminada, FecModificacionPreop,
			CiruAUrgente, DniAyudantePrevisto, AvisoPlanificar, FPrevistaIntervencion,
			NumListaRCLE, EsSincronizadoRCLE, PacFirmaConsen, NumSuspensiones,
			Observaciones, Pagado, CodMotivoPreferente, IdPlano, IdCuadrante,
			EsReIntervencion, DescReIntervencion, Validado, FCreacionHistorico, DNIUsuarioModifica 
			,CodEspecialidadUrg )
	 SELECT Prp.CodHojaPreop, Prp.CodIntervencion, Prp.CodPaciente, Prp.CodEpisodio, Prp.CodProc,
			Prp.CodProtocolo, Prp.TipoAnestesia, Prp.JClinico, Prp.CodCIEPreop, Prp.RQuirurgico,
			Prp.ProfAntibiotica, Prp.ProfOtros, Prp.ProfTromboembolica, Prp.Region, Prp.FPreoperatoria,
			Prp.DNIMedicoPreop, Prp.DescPreop, Prp.TecPrevistas, Prp.CSuspendida, Prp.FPrevista,
			Prp.Ambulatoria, Prp.Tipo, Prp.PreopCompleto, Prp.FIntervencion, Prp.Autotransfusion,
			Prp.VistoBueno, Prp.MedicoRemite, Prp.CodMutua, Prp.Anestesista, Prp.FConsentInterv,
			Prp.FConsentProtesis, Prp.CodCenRemite, Prp.Preanestesia, Prp.FPasivo, Prp.DiasLEspera,
			Prp.NecesHemoderiv, Prp.UsuHemoderiv, Prp.CodHistoria, Prp.Eliminado, Prp.Servicio,
			Prp.FechaFirma, Prp.FechaUltimaAct, Prp.DescProtocolo, Prp.CiruMenor, Prp.TiempoOper,
			Prp.CodProtocolo2, Prp.DescProtocolo2, Prp.CodProtocolo3, Prp.DescProtocolo3, Prp.cma, 
			Prp.MotivoPreferente, Prp.Estado, Prp.JornadaExtra, Prp.DniASQ, Prp.FEliminada, Prp.FSuspendida,
			Prp.TasaMorbilidad, Prp.TasaMortalidad, Prp.Lateralidad, Prp.ResaltaPlaning, Prp.CodExamInterven,
			Prp.TieneImagen, Prp.Factivo, Prp.FultimoPasivo, Prp.JornadaExtraVali, Prp.DniASQVali,
			Prp.ObservacionesPreoper, Prp.Confirmacion, Prp.EliminadoPlan, Prp.CMAsinHDIA,
			Prp.CodigoGRD, Prp.PesoGRD, Prp.Complejidad, Prp.RequiereUvi, Prp.EstadoRCLE, Prp.InfoPaciente,
			Prp.dniInfoPacMed, Prp.dniInfoPacEnf, Prp.dniInfoPacAnes, Prp.FInfoPaciente, Prp.ObsEnfermeria,
			Prp.Neoplasia, Prp.DniCirujanoPrevisto, Prp.AvisadoPac, Prp.ObservacionesAvisadoPac,
			Prp.DniAvisadoPac, Prp.CodAvisoPac, Prp.ComplejidadPreop, Prp.IntervencionEspecial,
			Prp.UHD, Prp.TieneEquipo, Prp.CentroDestino, Prp.TipoCenRemite, Prp.ServicioOrigen,
			Prp.Ayudantes, Prp.AlergiaLatex, Prp.RequiereIngreso, Prp.TieneProtesis, Prp.Infeccioso,
			Prp.Preparatoria, Prp.DNISuspendida, Prp.DNIEliminada, Prp.FecModificacionPreop,
			Prp.CiruAUrgente, Prp.DniAyudantePrevisto, Prp.AvisoPlanificar, Prp.FPrevistaIntervencion,
			Prp.NumListaRCLE, Prp.EsSincronizadoRCLE, Prp.PacFirmaConsen, Prp.NumSuspensiones,
			Prp.Observaciones, Prp.Pagado, Prp.CodMotivoPreferente, Prp.IdPlano, Prp.IdCuadrante,
			Prp.EsReIntervencion, Prp.DescReIntervencion, Prp.Validado, GetDate(), @spvar_MedCierre 
			,Prp.CodEspecialidadUrg
	   FROM HClinica..Preoperatoria Prp
			,@tablaIntervenciones t
	   where Prp.CodIntervencion = t.CodIntervencion

update p
set CSuspendida='Cierre automático de la Historia por Exitus'
   ,FSuspendida = GETDATE()
   ,EstadoRCLE = parametros.dbo.fnParValorConstanteCentro('m_strEstadoRCLEExitus','')
from Hclinica..Preoperatoria p
    ,@tablaIntervenciones t
where p.CodIntervencion = t.CodIntervencion
		  
--Eliminamos las planificaciones que tenga pendientes
delete q
from Hclinica..QuirofanosPlanning q
	,@tablaIntervenciones t
where q.Fecha > GETDATE() and q.CodIntervencion = t.CodIntervencion

--Borramos todas las citas
delete from Hclinica..Citas
where CodPaciente = @spvar_CodPaciente and FechaCita >= @spvar_Fecha

update Hclinica..Eliminadas
set MotivoCancelacion = (SELECT TOP(1) M.Codigo FROM Parametros.dbo.MotivosCitas AS M INNER JOIN Parametros.dbo.Consultas AS C ON M.CodCentro = ISNULL(C.CodCentro, @CodCentro) AND C.CodCons = Eliminadas.CodConsul WHERE (M.Exitus = 1)),
   Usuario = @spvar_MedCierre
where CodPaciente = @spvar_CodPaciente and FecConsul >= @spvar_Fecha
        
delete from Hclinica..CitasPrimaria
where CodPaciente = @spvar_CodPaciente and FechaCita >= @spvar_Fecha
        
update Hclinica..EliminadasPrimaria
set MotivoCancelacion = (SELECT TOP(1) M.Codigo FROM Parametros.dbo.MotivosCitas AS M INNER JOIN Parametros.dbo.Consultas AS C ON M.CodCentro = ISNULL(C.CodCentro, @CodCentro) AND C.CodCons = EliminadasPrimaria.CodConsul WHERE (M.Exitus = 1)),
   Usuario = @spvar_MedCierre
where CodPaciente = @spvar_CodPaciente and FecConsul >= @spvar_Fecha

delete CF
from Hclinica..CitasFisioterapia CF
    ,Hclinica..Fisioterapia F
where F.CodPaciente = @spvar_CodPaciente and F.CodRegistro = CF.CodRegistro
      and convert(smalldatetime,convert(varchar,CF.FechaCita,101)) >= convert(smalldatetime,convert(varchar,@spvar_Fecha,101))

update Hclinica..Fisioterapia
set Cerrado = 1
where CodPaciente = @spvar_CodPaciente

--ESA CHC2038 INI
--Recuperamos la tabla de episodios egresados
select CodPaciente
	  ,CodEpisodio
	  ,IdMotivo
	  ,DescMotivo
	  ,CodigoRyF
	  ,CodSistema --(20/11/2014) - V4.49 – 1440 – APB – Segunda parte Derivación entre instancias
from @tablaEpisodiosEgresados
--ESA CHC2038 FIN

GO
GO



--dbo.SpConUEpisodioEgresado.sql

USE [Consultas]
GO
IF EXISTS 
  (
      SELECT * 
      FROM sys.procedures 
      WHERE [object_id] = OBJECT_ID('[dbo].[SpConUEpisodioEgresado]')
  )
BEGIN
    DROP PROCEDURE [dbo].[SpConUEpisodioEgresado];
END
GO
/****** Object:  StoredProcedure [dbo].[SpConUEpisodioEgresado]    Script Date: 28/08/2017 10:11:49 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
    -- =============================================
-- Author:		Miguel Angel Gómez
-- Create date: 11/01/2012
-- Description:	Actualiza el episodio poniendo el estado del mismo como Egresado 
--				y añadiendo el motivo de egreso
-- =============================================
-- MODIFICACIONES
------------------------------------------------
-- Autor:		Enrique Sánchez
-- Fecha:		19/11/2012
-- Incidencia:	CHC2249
-- Versión:		v4.32
-- Descripción: Añadimos la trazabilidad
-- MODIFICACION: (23/08/2017) - v17.3 – 18451 – FCB - Ingresar observación al motivo de egreso en SIC
-- =============================================
CREATE PROCEDURE [dbo].[SpConUEpisodioEgresado]
	@spvar_CodPaciente char(16),
	@spvar_CodEpisodio char(5),
	@spvar_IdMotivo int
	--ESA CHC2249 INI
	,@spvar_Motivo varchar(500) = NULL
	,@spvar_Puesto varchar(50) = ''
	,@spvar_Usuario varchar(8) = ''
	,@spvar_EliAutoAsist bit = NULL
	,@spvar_EliAutoRechazo bit = NULL
    --ESA CHC2249 FIN
	,@spvar_RUNProfesional varchar(9) = null
	,@spvar_NomProfesional varchar(80) = null
	,@spvar_Observacion varchar(500) = null
AS

BEGIN

DECLARE @Estado CHAR(1)


--- INI 106323
IF @spvar_Motivo='' or @spvar_Motivo is null
	BEGIN
	set @spvar_Motivo = (select Descripcion from Parametros..MotivosCitas where Codigo = @spvar_IdMotivo and Eliminado !=1)
	END
--- FIN 106323

IF  @spvar_Motivo is null
	SET @Estado = ''

ELSE
	BEGIN


	SET NOCOUNT ON;

	SELECT @Estado = (SELECT Codigo
					  FROM parametros..Codigos
					  WHERE Tabla = 'Estado Propuesta' AND Posicion = 0)

	UPDATE Consultas..EpisodioConsultas
	SET Estado = @Estado,
		IdMotivo = @spvar_IdMotivo
		,RUNProfEgreso = ISNULL(@spvar_RUNProfesional,RUNProfEgreso)
		,NomProfEgreso = ISNULL(@spvar_NomProfesional,NomProfEgreso)
		,ObservacionEgreso = ISNULL(@spvar_Observacion,ObservacionEgreso)
    WHERE CodPaciente = @spvar_CodPaciente AND CodEpisodio = @spvar_CodEpisodio
   
   
   --ESA CHC2249 INI
  INSERT INTO Consultas.dbo.TrazabilidadEpisodioConsultas
           (CodPaciente
           ,CodEpisodio
           ,Usuario
           ,Puesto
           ,FCreacion
           ,FPrevista
           ,FModificacion
           ,CodCentroAnterior
           ,CodCentroNuevo
           ,FCita
           ,FCitacion
           ,FEliminacion
           ,FEliminacionCita
           ,FPasiva
           ,FActiva
           ,FCierre
           ,FAlta
           ,Asiste
           ,Motivo
           ,EliAutomaticaAusencia
           ,EliAutomaticaRechazo
             --- INI 106323
			   ,NoAtendido
			   ,FechaConfirmacionAsistencia	
			   ,CitaEspontanea	
			   ,FechaCitaEspontanea
			   --- FIN 106323
           )
     VALUES
           (@spvar_CodPaciente --CodPaciente
           ,@spvar_CodEpisodio --CodEpisodio
           ,@spvar_Usuario --Usuario
           ,@spvar_Puesto --Puesto
           ,NULL --FCreacion
           ,NULL --FPrevista
           ,NULL --FModificacion
           ,NULL --CodCentroAnterior
           ,NULL --CodCentroNuevo
           ,NULL --FCita
           ,NULL --FCitacion
           ,GETDATE() --FEliminacion
           ,NULL --FEliminacionCita
           ,NULL --FPasiva
           ,NULL --FActiva
           ,NULL --FCierre
           ,NULL --FAlta
           ,NULL --Asiste
           ,@spvar_Motivo --Motivo
           ,@spvar_EliAutoAsist --EliAutomaticaAusencia
           ,@spvar_EliAutoRechazo -- EliAutomaticaRechazo
            --- INI 106323
			,0    -- NoAtendido
			,NULL -- FechaConfirmacionAsistencia
			,0    -- CitaEspontanea
			,NULL -- FechaCitaEspontanea 
			)  
			   --- FIN 106323 
   --ESA CHC2249 FIN
END

END
GO



--dbo.SpHCIIDocumentosEscaneados.sql

USE [Hclinica]
GO

IF EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[SpHCIIDocumentosEscaneados]') AND type in (N'P', N'PC'))
	DROP PROCEDURE [dbo].[SpHCIIDocumentosEscaneados]
GO
    
-- =============================================
-- Author:		Vicente Torres Talavera
-- Create date: 10/06/2015
-- (10/06/2015) - V4.52 – 1655 – VTT – Al escanear documento no guarda comentarios
-- MODIFICACION: (30/07/2015) Alberto Pagán Benedicto - V4.52r1 - 2419 - APB - Comentarios en escanear documentos
-- MODIFICACION: (31/03/2016) v4.60 - 2999 - SGN - Incorporar datos a funcionalidad de adjuntar documentos
-- MODIFICACION: (09/08/2017) - v17.3 - 15986 - MPR - Recoleccion de evidencia en documentos escaneados
--- =============================================
CREATE PROCEDURE [dbo].[SpHCIIDocumentosEscaneados]
	 @spvar_CodHistoria varchar(8)
	,@spvar_NombreDoc varchar(50)
	,@spvar_Comentario varchar(50) 
	,@spvar_IDOrigenDoc  integer = null
	,@spvar_IDReceptorDoc integer = null
	,@spvar_FechaFirmaDoc datetime = null
	,@spvar_DniUsuarioEscanea CHAR(8) = null
AS

BEGIN
	INSERT INTO Hclinica..DocumentosEscaneados
			   (CodHistoria
	           ,NombreDoc
	           ,Comentario
	           ,FCreacion
	           ,IDOrigenDoc
	           ,IDReceptorDoc
	           ,FechaFirmaDoc
			   ,DniUsuarioEscanea)
	VALUES (@spvar_CodHistoria
	       ,@spvar_NombreDoc
	       ,@spvar_Comentario
	       ,GETDATE()
	       ,@spvar_IDOrigenDoc
	       ,@spvar_IDReceptorDoc
	       ,@spvar_FechaFirmaDoc
		   ,@spvar_DniUsuarioEscanea)
END

GO
GO



--dbo.SpHCLDDetalleParto.sql

USE [Hclinica]
GO

IF EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[SpHCLDDetalleParto]') AND type in (N'P', N'PC'))
DROP PROCEDURE [dbo].[SpHCLDDetalleParto]
GO

/****************************************************
PROCEDIMIENTO	: SpHCLDDetalleParto
FUNCION			: Eliminar registro de DetalleParto
FECHA			: 24/08/2017
VERSION			: 17.3 - 15986 - Mejoras Urgencia Maternidad y Partograma
AUTOR			: Marco Polo Ruiz
****************************************************/

CREATE PROCEDURE [dbo].[SpHCLDDetalleParto]
    @spvar_CodPaciente VARCHAR(16),
	@spvar_CodEpisodio CHAR(5),
	@spvar_Fecha SMALLDATETIME,
	@spvar_Codigo CHAR(1),
	@spvar_Tipo CHAR(1)

AS 

BEGIN 
    IF EXISTS (SELECT CodPaciente FROM  DetalleParto 
				WHERE CodPaciente = @spvar_CodPaciente AND CodEpisodio = @spvar_CodEpisodio AND 
				Fecha = @spvar_Fecha AND Codigo = @spvar_Codigo AND Tipo=@spvar_Tipo)
	BEGIN
		DELETE	
			DetalleParto
		WHERE 	
			CodPaciente = @spvar_CodPaciente AND CodEpisodio = @spvar_CodEpisodio AND 
			Fecha = @spvar_Fecha AND Codigo = @spvar_Codigo AND Tipo=@spvar_Tipo
	END
END

GO

GO



--dbo.SpHClDEliminarCita.sql

    USE [HClinica];
    GO
    IF EXISTS 
    (
        SELECT * 
            FROM sys.procedures 
            WHERE [object_id] = OBJECT_ID('[dbo].[SpHClDEliminarCita]')
    )
    BEGIN
        DROP PROCEDURE [dbo].[SpHClDEliminarCita];
    END
    GO
    
-- *****************************************************************
-- PROCEDIMIENTO	: HClinica.SpHClDEliminarCita
-- FUNCION	: Elimina una cita 
-- FECHA	: 07/09/2005
-- VERSION	: 1.0
-- AUTOR	: azaragoza (Agensys Technology)
--*******************************************************************
-- REVISION : (27/08/07) Sonia Mateo (Agensys Technology)
--			Cambio el procedimiento para que no elimine la propuesta de consultas 
--			si existe una cita posterior para el servicio
--			  (27/11/2007) JPS 
--			Al eliminar la cita guardo el usuario y el puesto
-- Modificado: azaragoza. 30-11-07. Puestos valores por defecto a @spvar_Usuario y @spvar_Puesto
-- Modificado: azaragoza. 25-03-08. Llamo al procedure SpConDEliminaEpiCons para eliminar el episodio relacionado con la cita
-- Modificado: Ismael(03/06/2008) Corregida comprobacion para poner la fecha primera del episodio a null
-- Modificado: Cecilio(04/08/2008) Actualizada fecha inicial en episodioconsultas
-- Modificado: (11/05/2009) Sonia Mateo. Incluyo el campo IdCita en el delete de la tabla CITAS
-- Modificado: (11/06/2009) Sonia Mateo. Llamo al procedimiento de consultas llenas si se ha eliminado una cita de tipo primera.
-- Modificado: (25/09/2009) Ismael Sampere. Cambio el tipo del campo MotivoCancelacion
-- Modificado: (07/10/2009) Ismael Sampere. Trazabilidad de consultas externas
-- Modificado: (22/10/2009) Ismael Sampere. Añadido motivo a la trazabilidad de consultas externas
-- Modificado: (22/12/2009) Joaquín Aniorte. Descomentada llamada a procedimiento de citas llenas. (FLORENCECLI-738)
-- Modificado: (16/01/2012) Miguel Angel Gómez. Al eliminar la cita actualizamos el valor del cupo (restando una unidad)
-- Modificado: (01/03/2012) Miguel Angel Gómez. CHC-1469. Cuando elimino citas extraigo el mínimo idCupo para restarle una unidad
-- Modificado: (15/06/2012) César Moreno Moreno. CHC-1823. Cuando se elimina la cita, no se elimina la consulta.
-- Modificado: (12/11/2014) - v4.48 - 1169- JRP - Citas Espontaneas
-- Modificado: (22/06/2015) v4.52 - 1899 - SGN - Problema distribución cupos florence
-- Modificado: (10/06/2016) v4.55 - 3284 - LMF - Problema distribución cupos Rayen(Uso de cupos desde Rayen - Tarea de la version 4.60r3)
-- Modificado: (11/08/2016) v4.55 - PVC - se comenta linea de codigo que soluciona el Problema de perdida de Codigo de episodio.
-- Modificado: (05/09/2016) v4.62r3 - 12762 - DVR - Se pierde FechaInicial de episodio consultas
--*******************************************************************

CREATE proc [dbo].[SpHClDEliminarCita]
	@spvar_CodConsulta char(6),
	@spvar_Fecha smalldatetime,
	@spvar_CodPaciente char(16),
	@spvar_CodServicioHijo char(4),
	@spvar_ClaseConsulta varchar(7),
	@spvar_IdCita smallint=NULL,
	@spvar_PruebaPasiva bit = null,
	@spvar_MotivoCancelacion int = null,
	@spvar_Usuario char(9) = '',
	@spvar_Puesto varchar(50) = '',
	---12/11/2014 - v4.48 - 1169 - JRP - Citas Espontaneas - INI
	@spvar_CitaEspontanea bit = 0
	---12/11/2014 - v4.48 - 1169 - JRP - Citas Espontaneas - FIN
As

declare @codepisodio char(5),
		@cant int,
		@CodTipoConsulta char(7),
		@RequiereEpis bit,
		@N_Factura char(12),
		@FOtraCita smalldatetime,
		@CantProp tinyint,
		@NEpi char(5),
		@TIPOPRUEBA CHAR(1),
		@BITAUX BIT,
		@CodTipoConsulta2 char(7),
		@idCupo int
		
declare @Motivo varchar(500)

declare @EpiCons table
(
	CodCentro CHAR(5),
	CodCentroDesde CHAR(5),
	IdUnidad INT,
	CodServicio CHAR(4)
)

select @Motivo = Descripcion 
from parametros..MotivosCitas 
where Codigo = @spvar_MotivoCancelacion

If @spvar_IdCita is null
   SELECT	@spvar_IdCita=IdCita
     FROM	citas
    WHERE	CodConsulta = @spvar_CodConsulta and
			FechaCita = @spvar_Fecha and
			CodPaciente = @spvar_CodPaciente and
			CodTipoConsulta2 = @spvar_ClaseConsulta
            

SELECT @BITAUX =0
SELECT @TIPOPRUEBA='N' --NO ES PRUEBA, ES CONSULTA ORDINARIA
		
SELECT	@BITAUX = DiagnosticoPorImagen
FROM	PARAMETROS..SERVICIOS
WHERE	Codigo like @spvar_CodServicioHijo

IF @BITAUX=1 
	BEGIN
		SELECT @TIPOPRUEBA='R'
	END
	
SELECT @BITAUX = Endoscopia
FROM PARAMETROS..SERVICIOS
WHERE Codigo like @spvar_CodServicioHijo

IF @BITAUX=1 
	BEGIN
		SELECT @TIPOPRUEBA='E'
	END
	
/*
If @TIPOPRUEBA LIKE 'N' --sI NO ES TIPO PRUEBA 
 Begin
     Exec SpHClUPropuestaCita @spvar_CodPaciente,@spvar_CodServicioHijo,@spvar_Fecha,0,@FOtraCita output,@CantProp output,@NEpi output
 End
*/

--Es una prueba de rayos que se ha pasado a pasiva
If @spvar_PruebaPasiva = 1 
BEGIN

		-- Si la prueba no tiene descripción, se actualiza indicando que es pasiva
		if exists
			(	select Codpaciente
				from citas
				Where 	CodConsulta=@spvar_CodConsulta and
       					FechaCita=@spvar_Fecha and
						CodPaciente=@spvar_CodPaciente and
						CodTipoConsulta2=@spvar_ClaseConsulta
						and (Observaciones is null or rtrim(Observaciones) = '')
			)
		BEGIN
			update citas
			set Observaciones = 'Prueba pasada a Pasiva'
			Where 	CodConsulta=@spvar_CodConsulta and
       				FechaCita=@spvar_Fecha and
					CodPaciente=@spvar_CodPaciente and
					CodTipoConsulta2=@spvar_ClaseConsulta
					and (Observaciones is null or rtrim(Observaciones) = '')
		END
END

select	@codepisodio = codepisodio,
		@CodTipoConsulta = CodTipoConsulta,
		@CodTipoConsulta2 = CodTipoConsulta2,
		@idCupo = idcupo
from	citas
 Where 	CodConsulta=@spvar_CodConsulta and
       	FechaCita=@spvar_Fecha and
        CodPaciente=@spvar_CodPaciente and
      --CodTipoConsulta2=@spvar_ClaseConsulta and  ---Saydex
		IdCita = @spvar_IdCita

declare @CodServCons char(4)
declare @CodTipoCons char(7)
declare @CodClaseCons char(7)

select @CodServCons = c.CodigoServicio,
	   @CodTipoCons = c.CodTipoConsulta,
	   @CodClaseCons = c.CodTipoConsulta2
from HClinica..citas c
WHERE	CodConsulta = @spvar_CodConsulta
		AND	FechaCita = @spvar_Fecha
		AND	IdCita = @spvar_IdCita
		AND	CodPaciente = @spvar_CodPaciente
		
Delete 	citas
 Where 	CodConsulta=@spvar_CodConsulta and
       	FechaCita=@spvar_Fecha and
        CodPaciente=@spvar_CodPaciente and
        IdCita = @spvar_IdCita 


/* Guardamos el motivo de la cancelacion de la cita despues de eliminarla*/
/* 0 -> Peticion del Usuario 1-> Modificacion de Agenda*/
update	hclinica.dbo.eliminadas
set		MotivoCancelacion = @spvar_MotivoCancelacion,
		Usuario = @spvar_Usuario,
		Puesto = @spvar_Puesto,
		---12/11/2014 - v4.48 - 1169 - JRP - Citas Espontaneas - INI
		CitaEspontanea = @spvar_CitaEspontanea
		---12/11/2014 - v4.48 - 1169 - JRP - Citas Espontaneas - FIN
Where	FecConsul=@spvar_Fecha and
		IdConsul=@spvar_IdCita and
		CodPaciente=@spvar_CodPaciente

--CHC-1823 INI
---- (27/08/07) Sonia. Comprueba no existan citas en el futuro para ese servicio 
--if (@CodTipoConsulta = '0' or @spvar_ClaseConsulta = '0') 
--	and
--	(select CodDiagnosticoProvisional from
--			consultas..episodioconsultas
--		where
--			codpaciente = @spvar_codpaciente and
--			codepisodio = @codepisodio
--	) is null

--	and

--	not exists 
--	(
--		select	codpaciente 
--		from	hclinica..citas 
--		where	codpaciente = @spvar_CodPaciente
--				and codepisodio = @codepisodio
--				and codigoservicio = @spvar_CodServicioHijo
--				and fechacita > getdate()
--	)

--begin

--		select @cant = 0
--		Exec Consultas..SpConSCompruebaEpisodio @spvar_CodPaciente, @codepisodio, @cant

--		if @cant = 0
--		begin
--			-- Comprobamos si el episodio se ha creado desde una primera cita 
--			if (select PrimeraCita from consultas..episodioconsultas
--				where Codpaciente = @spvar_CodPaciente and
--					  CodEpisodio = @codepisodio) = 1
			
--			begin
--				exec consultas..SpConDEliminaEpiCons @spvar_codpaciente, @codepisodio,@spvar_Puesto,@spvar_Usuario,@Motivo
--			end
			
--		end
--end
--CHC-1823 FIN

-- Si la cita es primera ponemos a null la fecha de la cita

select	@RequiereEpis = RequiereEpis 
from	parametros.dbo.tiposconsultas
where	CodTipoCons = @CodTipoConsulta 
		and CodServCons = @spvar_CodServicioHijo
		and CodClaseCons = @spvar_ClaseConsulta

if @RequiereEpis = 0
begin

	--Insertar Log en trazas FechaInicial, info de episodios que tienen anamnesis o citas sucesivas y se habrian limpiado la FechaInicial de EpisodioConsultas
    DECLARE @Cont as int
	Select @Cont= count(*) from consultas..episodioconsultas
	where
		codpaciente = @spvar_codpaciente and
		codepisodio = @codepisodio
		and consultas.dbo.fnConSExistenAnam_o_Sucesivas(@spvar_codpaciente,@codepisodio)=1
	
	IF @Cont > 0 
	BEGIN
		declare @hoy as datetime
		set @hoy = GetDate()
		declare @_puesto as char(15)
		select @_puesto= substring(HOST_NAME(),1,15)
		
		
		DECLARE @ProcName nvarchar(128);
		SET @ProcName = LTrim(RTrim(OBJECT_NAME(@@PROCID)));  
		SET @ProcName += '  CodPaciente=' +@spvar_codpaciente + '  CodEpisodio='+@codepisodio
	

		EXEC HClinica..spHClRegistroAccesos 
 		 @FechaPc = @hoy,
 		 @Accion  = 'Actualizar', 
		 @ResultadoOperacion ='Correcto',
		 @SentenciaSql1 = 'fnConSExistenAnam_o_Sucesivas', 
		 @SentenciaSql2  = @ProcName, 
		 @Puesto  = @_puesto, 
		 @UsuarioWin  = null, 
		 @UsuarioAplicacion  = null,
		 @Aplicacion ='HistoriaClinica',  
		 @OpcionMenu  = null, 
		 @Formulario  = null,  
		 @Version = null
	END
	--Fin Insertar Log en trazas FechaInicial
	ELSE
	
		update consultas..episodioconsultas
		set FechaCPrimera = null,
			fechainicial = NULL
		where
			codpaciente = @spvar_codpaciente and
			codepisodio = @codepisodio
		
end


-- Si se ha eliminado una cita de tipo primera, se actualiza la tabla de consultas llenas
if @CodTipoConsulta = 0 and @CodTipoConsulta2 = 0
	Exec SpHClIConsLlena @spvar_CodConsulta, @spvar_Fecha

declare @Descripcion varchar(60)

select @Descripcion = DescTipoCons 
from parametros..TiposConsultas
where CodServCons = @CodServCons
	  and CodTipoCons = @CodTipoCons
	  and CodClaseCons = @CodClaseCons
	  
--Restamos una unidad al cupo del servicio y la fecha de la cita eliminada
--Para ello obtenemos los datos del episodio, buscamos el cupo y luego lo editamos

IF parametros.dbo.fnParValorConstante('m_bolComprobarCupos') = 1
BEGIN

	INSERT @EpiCons -- Recopilamos datos del episodio para buscar el cupo
	SELECT CodCentroFinal,CodCentroOrigen,IdUnidad,CodServicioFinal   
	FROM Consultas..EpisodioConsultas
	WHERE CodPaciente=@spvar_CodPaciente AND CodEpisodio=@codepisodio

	-- Comprobamos que exista un cupo de citas para el servicio, unidad, centro de destino y fecha
	IF EXISTS (SELECT 1 FROM parametros..CuposCitas CC 			
			   WHERE CC.CodServicio=(SELECT CodServicio FROM @EpiCons)
		         AND CC.CodUnidad=(SELECT IdUnidad FROM @EpiCons)
		         AND CC.codCentroOrigen = (SELECT CodCentro FROM @EpiCons)		        
		         AND @spvar_Fecha BETWEEN CC.FechaIni AND CC.FechaFin
		         AND CC.idCupo=@idCupo)
	BEGIN		
						
		-- En función del rango en que se encuentre la fecha de cita, el cupo está citado dentro de
		-- caducidad normal, primera caducidad o segunda caducidad. Si existe un registro así es ahí donde
		-- tenemos que editar y disminuir en uno la cantidad de cupos citados
		
		IF EXISTS (SELECT 1 FROM parametros..CuposCentro -- Si la fecha está en el primer intervalo 
				   WHERE idCupo = @IdCupo
					 AND codCentro = (SELECT CodCentroDesde FROM @EpiCons)
					 AND (@spvar_Fecha < fechaCad OR @spvar_Fecha = fechaCad)
					 AND cuposCitados > 0)
		BEGIN
			
			UPDATE parametros..CuposCentro 
			SET cuposCitados = cuposCitados - 1
			WHERE idCupo = @IdCupo
		      AND codCentro = (SELECT CodCentroDesde FROM @EpiCons)
			
		END
		
		IF EXISTS (SELECT 1 FROM parametros..CuposCentro -- Si la fecha está en el segundo intervalo
				   WHERE idCupo = @IdCupo
					 AND codCentro = (SELECT CodCentroDesde FROM @EpiCons)
					 AND (@spvar_Fecha BETWEEN fechaCad AND fechaCad1 OR @spvar_Fecha = fechaCad1)
					 AND cuposCitados1 > 0) 
		BEGIN
		
			UPDATE parametros..CuposCentro 
			SET cuposCitados1 = cuposCitados1 - 1
			WHERE idCupo = @IdCupo
		      AND codCentro = (SELECT CodCentroDesde FROM @EpiCons)
		
		END 
		
		IF EXISTS (SELECT 1 FROM parametros..CuposCentro -- Si la fecha está en el tercer intervalo
				   WHERE idCupo = @IdCupo
					 AND codCentro = (SELECT CodCentroDesde FROM @EpiCons)
					 AND (@spvar_Fecha BETWEEN fechaCad1 AND fechaCad2 OR @spvar_Fecha = fechaCad2)
					 AND cuposCitados2 > 0) 
		BEGIN
		
			UPDATE parametros..CuposCentro 
			SET cuposCitados2 = cuposCitados2 - 1
			WHERE idCupo = @IdCupo
		      AND codCentro = (SELECT CodCentroDesde FROM @EpiCons)
		
		END 
									
	END 

END
		  
-- Ismael(07/10/2009) Trazabilidad de consultas externas
INSERT INTO Consultas.dbo.TrazabilidadEpisodioConsultas
           (CodPaciente
           ,CodEpisodio
           ,Usuario
           ,Puesto
           ,FCreacion
           ,FPrevista
           ,FModificacion
           ,CodCentroAnterior
           ,CodCentroNuevo
           ,FCita
           ,FCitacion
           ,FEliminacion
           ,FEliminacionCita
           ,FPasiva
           ,FActiva
           ,FCierre
           ,FAlta
           ,Asiste
           ,Motivo
           ,TipoConsulta
            ---12/11/2014 - v4.48 - 1169 - JRP - Citas Espontaneas - INI
           ,CitaEspontanea)
           ---12/11/2014 - v4.48 - 1169 - JRP - Citas Espontaneas - FIN
VALUES
           (isnull(@spvar_CodPaciente,'') --CodPaciente
           ,isnull(@CodEpisodio,'') --CodEpisodio
           ,isnull(@spvar_Usuario,'') --Usuario
           ,isnull(@spvar_Puesto,'') --Puesto
           ,NULL --FCreacion
           ,NULL --FPrevista
           ,NULL --FModificacion
           ,NULL --CodCentroAnterior
           ,NULL --CodCentroNuevo
           ,@spvar_Fecha --FCita
           ,NULL --FCitacion
           ,NULL --FEliminacion
           ,GETDATE() --FEliminacionCita
           ,NULL --FPasiva
           ,NULL --FActiva
           ,NULL --FCierre
           ,NULL --FAlta
           ,NULL --Asiste
           ,@Motivo --Motivo
           ,@Descripcion --TipoConsulta
            ---12/11/2014 - v4.48 - 1169 - JRP - Citas Espontaneas - INI  
           ,@spvar_CitaEspontanea)--Cita Espontánea
			---12/11/2014 - v4.48 - 1169 - JRP - Citas Espontaneas - FIN
           

Select @N_Factura,@FOtraCita,@CantProp,@NEpi



GO



--dbo.SpHClICierrePac.sql

USE [Hclinica]
GO

IF EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[SpHClICierrePac]') AND type in (N'P', N'PC'))
	DROP PROCEDURE [dbo].[SpHClICierrePac]
GO
    
/*********************************************************************
* FUNCION: Guarda los datos del cierre del paciente
* DEVUELVE:
* FECHA: 23/09/2005
* VERSION: 1.0
* AUTOR: Desiderio Marti (Mecemsa)
* ORIGEN: Mantenimiento Pacientes
* MODIFICACIÓN: (08-01-2008) azaragoza. Modifico los codigos de destino de alta de Episodioconsultas y EpisodioHospitalizacion
* MODIFICACIÓN: (26/11/2008) MPS - Modificar preoperatorias pendientes y planificadas
* MODIFICACIÓN: (29/01/2009) MPS - Sólo se deja la inserción en la tabla Exitus
* MODIFICACIÓN: (01/06/2012) Alfredo - Añado Usuario a la inserción en la tabla Exitus
* MODIFICACIÓN: (19/11/2015) - 2652 - SGN - Incorporar médico cierre por defunción
* MODIFICACIÓN: (12/07/2016) - 3325 - DCR - Campo Control si se realiza Alta por Fallecimiento desde historia clinica
* MODIFICACIÓN: (10/07/2017) - V17.2r1 - 18466 - APB - Folio y Certificado de Defunción
* MODIFICACIÓN: V17.3 - 19364 - ASM - Revertir estado de fallecimiento del paciente
'*******************************************************************/

CREATE PROCEDURE [dbo].[SpHClICierrePac]
	 @spvar_CodPaciente char(16)
	,@spvar_Fec smalldatetime
	,@spvar_Fun char(6)
	,@spvar_Inm char(6)
	,@spvar_Int char(6)
	,@spvar_obs varchar(1000)
	,@Usuario char(8) = null
	,@spvar_DNIMedico char(8) = null
	,@spvar_RegistroHC bit = 0
	,@spvar_Folio bigint = null
	,@spvar_DniMedicoActivacion CHAR(8) = NULL
	,@spvar_F_Activacion SMALLDATETIME = NULL
AS

/*Actualizar Exitus*/
if exists(	select	* 
			from	Hclinica..Exitus 
			where	CodPaciente = @spvar_CodPaciente)

begin
	update	Hclinica..Exitus
	set		 MotivoFundamental = @spvar_Fun
			,MotivoInmediato = @spvar_Inm 
			,MotivoIntermedio = @spvar_Int
			,Obs = @spvar_obs
			,DNIMedico = @spvar_DNIMedico
			,RegistroHC = @spvar_RegistroHC
			,Folio = @spvar_Folio
			,DniMedicoActivacion = @spvar_DniMedicoActivacion
			,F_Activacion = @spvar_F_Activacion
	where	CodPaciente = @spvar_CodPaciente
end
else
begin
	insert	Hclinica..Exitus(
				 CodPaciente
				,MotivoFundamental
				,MotivoInmediato
				,MotivoIntermedio
				,Obs
				,Usuario
				,DNIMedico
				,RegistroHC
				,Folio)
	values(		@spvar_CodPaciente
				,@spvar_Fun
				,@spvar_Inm
				,@spvar_Int
				,@spvar_obs
				,@Usuario
				,@spvar_DNIMedico
				,@spvar_RegistroHC
				,@spvar_Folio)
end

GO
GO



--dbo.SpHclICtesFrec.sql

USE [Hclinica]
GO

IF EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[SpHclICtesFrec]') AND type in (N'P', N'PC'))
	DROP PROCEDURE [dbo].[SpHclICtesFrec]
GO

SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

/*****************************************************************************************************************
* FUNCION           : Inserta las constantes frecuentes en las tablas correspondientes
* DEVUELVE          :
* FECHA	            : 23-01-2006
* VERSION           : 1.0
* AUTOR	            : Manuel Mas Asencio (MECEMSA)
* APLICACION ORIGEN : FEnfHojaCtes
* MODIFICACION      : (27/01/2009) Ismael Sampere Ampliacion del campo CodHistoria
* MODIFICACION      : (14/12/2012) MAS - CHC2334 - V4.35 - Inserción del campo Temperatura Rectal		
* MODIFICACION      : CTF - 73569626D - CHC3184 - REQ27180 - v4.40 -  Modificacion de campo glicemia	
* MODIFICACION      : (16/01/2015) - V4.50 - 1623 - RRG - Oxigenoterapia - REQ 66276	
* MODIFICACION      : (02/05/2016) - V4.61 - 3128 - JMG - Fecha de Registro de constantes Vitales
* MODIFICACION      : (08/06/2016) - V4.61r1 - 3293 - SGN - Fecha de Registro de constantes Vitales
* MODIFICACION      : (29/08/2016) - V4.61r1 - 3293 - JMG - Fecha de Registro de constantes Vitales (correccion)
* MODIFICACION      : (12/12/2016) - V4.63r8 - 14826 - APB - Corrección Reevaluación DAU (incluir bloques BEGIN/END)
* MODIFICACION      : (21/08/2017) - V17.3 - 16489 - APB - Volumen ingerido de Control de Ingesta a Balances
*****************************************************************************************************************/

CREATE PROCEDURE [dbo].[SpHclICtesFrec]
	 @spvar_CodPaciente char(16)
	,@spvar_CodEpisodio char(5)
    ,@spvar_Fecha smalldatetime
    ,@spvar_Temp real
    ,@spvar_TAS smallint
    ,@spvar_TAD smallint
    ,@spvar_FCard tinyint
    ,@spvar_PVC int
    ,@spvar_FResp tinyint
    ,@spvar_Diuresis decimal(10,2)
	,@spvar_CodHistoria varchar(8)
	,@spvar_Glucemia varchar(8)
	,@spvar_EVA smallint = null
	,@spvar_Saturacion smallint = null
	,@spvar_TempRectal real = null
    ,@spvar_CodOxigeno char(5)= null
    ,@spvar_FechaRegistro datetime = null
AS

IF @spvar_FechaRegistro IS NULL
	SET @spvar_FechaRegistro = GETDATE()

-- MAS - CHC2334 - v4.35 - 14/12/2012 - Inserción de la constante Temperatura Rectal - INI
--IF @spvar_Temp IS NOT NULL
IF @spvar_Temp IS NOT NULL OR @spvar_TempRectal IS NOT NULL
-- MAS - CHC2334 - v4.35 - 14/12/2012 - Inserción de la constante Temperatura Rectal - FIN
BEGIN
	DECLARE @CountTemp as int = (SELECT COUNT(*) FROM Hclinica..ConstanteTemperatura WHERE CodPaciente = @spvar_CodPaciente AND CodEpisodio = @spvar_CodEpisodio AND Fecha = @spvar_Fecha)

	IF (@CountTemp = 0)
		BEGIN 
		   INSERT Hclinica..ConstanteTemperatura (codpaciente,
												  codepisodio,
												  codhistoria,
												  fecha,
												  temperatura,
												  -- MAS - CHC2334 - v4.35 - 14/12/2012 - Inserción de la constante Temperatura Rectal - INI
												  TemperaturaRectal
												  -- MAS - CHC2334 - v4.35 - 14/12/2012 - Inserción de la constante Temperatura Rectal - FIN
												  , FechaRegistro)
		   VALUES(@spvar_CodPaciente,
				  @spvar_CodEpisodio,
				  @spvar_CodHistoria,
				  @spvar_Fecha,
				  @spvar_Temp, 
				  -- MAS - CHC2334 - v4.35 - 14/12/2012 - Inserción de la constante Temperatura Rectal - INI		  
				  @spvar_TempRectal
				  -- MAS - CHC2334 - v4.35 - 14/12/2012 - Inserción de la constante Temperatura Rectal - FIN
				  , @spvar_FechaRegistro)
		  END
		ELSE
		  BEGIN 
			  UPDATE [dbo].[ConstanteTemperatura]
			   SET [Temperatura] = @spvar_Temp
				  ,[TemperaturaRectal] = @spvar_TempRectal
				  --,[FechaRegistro] = @spvar_FechaRegistro
			  WHERE Codpaciente = @spvar_CodPaciente 
				AND CodEpisodio = @spvar_CodEpisodio 
				AND Fecha = @spvar_Fecha
		  END
END

IF @spvar_TAS IS NOT NULL AND @spvar_TAD IS NOT NULL
BEGIN
  	DECLARE @CountTA as int = (SELECT COUNT(*) FROM Hclinica..TArterial WHERE CodPaciente = @spvar_CodPaciente AND CodEpisodio = @spvar_CodEpisodio AND Fecha = @spvar_Fecha)

	IF (@CountTA = 0)
		BEGIN
		   INSERT Hclinica..TArterial (codpaciente,
									   codepisodio,
									   fecha,
									   tas, 
									   tad,
									   codhistoria,
									   FechaRegistro)
		   VALUES(@spvar_CodPaciente,
				  @spvar_CodEpisodio,
				  @spvar_Fecha,
				  @spvar_TAS,
				  @spvar_TAD,
				  @spvar_CodHistoria,
				  @spvar_FechaRegistro)
		END
	ELSE
		BEGIN
			UPDATE [dbo].[TArterial]
			SET [TAS] = @spvar_TAS
			  ,[TAD] = @spvar_TAD
			  --,[FechaRegistro] = @spvar_FechaRegistro
			WHERE Codpaciente = @spvar_CodPaciente AND CodEpisodio = @spvar_CodEpisodio AND Fecha = @spvar_Fecha
		END
END

IF @spvar_FCard IS NOT NULL
BEGIN
  	DECLARE @CountFC as int = (SELECT COUNT(*) FROM Hclinica..ParametrosCardiacos WHERE CodPaciente = @spvar_CodPaciente AND CodEpisodio = @spvar_CodEpisodio AND FLecturaDatos = @spvar_Fecha)

	IF (@CountFC = 0)
		BEGIN
		   INSERT Hclinica..ParametrosCardiacos(codpaciente,
												codepisodio,
												codhistoria,
												flecturadatos,
												frecuencia,
												FechaRegistro)
		   VALUES(@spvar_CodPaciente,
				  @spvar_CodEpisodio,
				  @spvar_CodHistoria,
				  @spvar_Fecha,
				  @spvar_FCard,
				  @spvar_FechaRegistro)
		END
	ELSE
		BEGIN
			UPDATE [dbo].[ParametrosCardiacos]
			SET	[Frecuencia] = @spvar_FCard
			  --,[FechaRegistro] = @spvar_FechaRegistro
			WHERE Codpaciente = @spvar_CodPaciente AND CodEpisodio = @spvar_CodEpisodio AND FLecturaDatos = @spvar_Fecha
		END
END

IF @spvar_PVC IS NOT NULL
BEGIN
   DECLARE @CountPVC as int = (SELECT COUNT(*) FROM Hclinica..PVC WHERE CodPaciente = @spvar_CodPaciente AND CodEpisodio = @spvar_CodEpisodio AND Fecha = @spvar_Fecha)

   IF (@CountPVC = 0)
      BEGIN
		Insert Hclinica..PVC(codpaciente,
							 codepisodio,
							 codhistoria,
							 fecha,
							 pvc,
							 FechaRegistro)
		values(@spvar_CodPaciente,
			   @spvar_CodEpisodio,
		       @spvar_CodHistoria,
		       @spvar_Fecha,
		       @spvar_PVC,
		       @spvar_FechaRegistro)
	  END
	ELSE
	   BEGIN
	       UPDATE [dbo].[PVC]
		   SET [PVC] = @spvar_PVC
			  --,[FechaRegistro] = @spvar_FechaRegistro
		   WHERE Codpaciente = @spvar_CodPaciente AND CodEpisodio = @spvar_CodEpisodio AND Fecha = @spvar_Fecha
	   END
END

IF @spvar_FResp IS NOT NULL
BEGIN
	DECLARE @CountFR as int = (SELECT COUNT(*) FROM Hclinica..ParametrosRespiratorios WHERE CodPaciente = @spvar_CodPaciente AND CodEpisodio = @spvar_CodEpisodio AND FLecturaDatos = @spvar_Fecha)

	IF (@CountFR = 0)
		BEGIN
		   Insert Hclinica..ParametrosRespiratorios(codpaciente,
													codepisodio,
													flecturadatos,
													frecuencia,
													codhistoria,
													FechaRegistro)
		   values(@spvar_CodPaciente,	
				  @spvar_CodEpisodio,
				  @spvar_Fecha,
				  @spvar_FResp,
				  @spvar_CodHistoria,
				  @spvar_FechaRegistro)
		END
	ELSE
		BEGIN
		UPDATE [dbo].[ParametrosRespiratorios]
		SET [Frecuencia] = @spvar_FResp
			--,[FechaRegistro] = @spvar_FechaRegistro
		WHERE Codpaciente = @spvar_CodPaciente AND CodEpisodio = @spvar_CodEpisodio AND FLecturaDatos = @spvar_Fecha
		END
END

IF @spvar_Diuresis IS NOT NULL
BEGIN
	DECLARE @CountDiuresis as int = (SELECT COUNT(*) FROM Hclinica..Diuresis WHERE CodPaciente = @spvar_CodPaciente AND CodEpisodio = @spvar_CodEpisodio AND Fecha = @spvar_Fecha)

	IF (@CountDiuresis = 0)
		BEGIN
		   Insert Hclinica..Diuresis(codpaciente,
									 codepisodio,
									 codhistoria,
									 fecha,
									 diuresis,
									 FechaRegistro)
		   values(@spvar_CodPaciente,
				  @spvar_CodEpisodio,
				  @spvar_CodHistoria,
				  @spvar_Fecha,
				  @spvar_Diuresis,
				  @spvar_FechaRegistro)
		END
	ELSE
		BEGIN
			UPDATE [dbo].[Diuresis]
			   SET [Diuresis] = @spvar_Diuresis
				  --,[FechaRegistro] = @spvar_FechaRegistro
			WHERE Codpaciente = @spvar_CodPaciente AND CodEpisodio = @spvar_CodEpisodio AND Fecha = @spvar_Fecha
		END
END

IF @spvar_Glucemia IS NOT NULL
BEGIN
   DECLARE @CountGlucemia as int = (SELECT COUNT(*) FROM Hclinica..Glucemia WHERE CodPaciente = @spvar_CodPaciente AND CodEpisodio = @spvar_CodEpisodio AND Fecha = @spvar_Fecha)

   IF (@CountGlucemia = 0)
		BEGIN
		   Insert Hclinica..Glucemia(codpaciente,
									 codepisodio,
									 codhistoria,
									 fecha,
									 glucemia,
									 FechaRegistro)
		   values(@spvar_CodPaciente,
				  @spvar_CodEpisodio,
				  @spvar_CodHistoria,
				  @spvar_Fecha,
				  @spvar_Glucemia,
				  @spvar_FechaRegistro)
		END
	ELSE
		BEGIN
			UPDATE [dbo].[Glucemia]
			   SET [Glucemia] = @spvar_Glucemia
				  --,[FechaRegistro] = @spvar_FechaRegistro
			WHERE Codpaciente = @spvar_CodPaciente AND CodEpisodio = @spvar_CodEpisodio AND Fecha = @spvar_Fecha
		END
END

IF @spvar_EVA IS NOT NULL
BEGIN
   DECLARE @CountEVA as int = (SELECT COUNT(*) FROM Hclinica..EVA WHERE CodPaciente = @spvar_CodPaciente AND CodEpisodio = @spvar_CodEpisodio AND Fecha = @spvar_Fecha)
   
   IF (@CountEVA = 0)
		BEGIN
		   Insert Hclinica..EVA(codpaciente,
								codepisodio,
								codhistoria,
								fecha,
								EVA,
								FechaRegistro)
		   values(@spvar_CodPaciente,
				  @spvar_CodEpisodio,
				  @spvar_CodHistoria,
				  @spvar_Fecha,
				  @spvar_EVA,
				  @spvar_FechaRegistro)
		END
	ELSE
		BEGIN
			UPDATE [dbo].[EVA]
			   SET [EVA] = @spvar_EVA
				  --,[FechaRegistro] = @spvar_FechaRegistro
			WHERE Codpaciente = @spvar_CodPaciente AND CodEpisodio = @spvar_CodEpisodio AND Fecha = @spvar_Fecha
		END
END

IF @spvar_Saturacion IS NOT NULL
BEGIN
   DECLARE @CountSat as int = (SELECT COUNT(*) FROM Hclinica..Saturacion WHERE CodPaciente = @spvar_CodPaciente AND CodEpisodio = @spvar_CodEpisodio AND Fecha = @spvar_Fecha)
   
   IF (@CountSat = 0)
		BEGIN
		   Insert Hclinica..Saturacion(codpaciente,
									   codepisodio,
									   codhistoria,
									   fecha,
									   Saturacion,
									   FechaRegistro)
		   values(@spvar_CodPaciente,
				  @spvar_CodEpisodio,
				  @spvar_CodHistoria,
				  @spvar_Fecha,
				  @spvar_Saturacion,
				  @spvar_FechaRegistro)
		END
	ELSE
		BEGIN
			UPDATE [dbo].[Saturacion]
			   SET [Saturacion] = @spvar_Saturacion
				  --,[FechaRegistro] = @spvar_FechaRegistro
			WHERE Codpaciente = @spvar_CodPaciente AND CodEpisodio = @spvar_CodEpisodio AND Fecha = @spvar_Fecha
		END
END

-- 16/01/2015 - v4.50 - 1623 - RRG - Oxigenoterapia - REQ 66276 - INI
IF @spvar_CodOxigeno IS NOT NULL
BEGIN
   DECLARE @CountO2 as int = (SELECT COUNT(*) FROM Hclinica..ConstanteOxigenoterapia WHERE CodPaciente = @spvar_CodPaciente AND CodEpisodio = @spvar_CodEpisodio AND Fecha = @spvar_Fecha)
   
   IF (@CountO2 = 0)
		BEGIN
			INSERT INTO Hclinica..ConstanteOxigenoterapia
				(
					  CodPaciente
					, CodEpisodio
					, Fecha
					, CodOxigeno
					, FechaRegistro
				)
			VALUES
				(
					  @spvar_CodPaciente
					, @spvar_CodEpisodio
					, @spvar_Fecha
					, @spvar_CodOxigeno
					, @spvar_FechaRegistro
				)
			END
		ELSE
			BEGIN
				UPDATE [dbo].[ConstanteOxigenoterapia]
				   SET [CodOxigeno] = @spvar_CodOxigeno
					  --,[FechaRegistro] = @spvar_FechaRegistro
				WHERE Codpaciente = @spvar_CodPaciente AND CodEpisodio = @spvar_CodEpisodio AND Fecha = @spvar_Fecha
			END
END
-- 16/01/2015 - v4.50 - 1623 - RRG - Oxigenoterapia - REQ 66276 - FIN

GO
GO



--dbo.SpHCLIDatosCamas.sql

USE [Parametros];
GO
IF EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[SpHCLIDatosCamas]') AND type in (N'P', N'PC'))
	DROP PROCEDURE [dbo].[SpHCLIDatosCamas]
GO

/****************************************************
PROCEDIMIENTO	: SpHCLIDatosCamas
FUNCION			: Insertar una registro en Datos Cama
FECHA			: 18/07/2017
VERSION			: 17.3 - 18461
AUTOR			: Marco Polo Ruiz
****************************************************/

CREATE PROCEDURE [dbo].[SpHCLIDatosCamas]

@spvar_CodPlanta as char(2),
@spvar_NumHabit as char(10),
@spvar_NumCama as char(7),
@spvar_Borrado as char(1),
@spvar_CuentaOcupacion as bit,
@spvar_CodServ as char(4),
@spvar_ComplejidadCama as int,
@spvar_TipoCama as char(2),
@spvar_GrupoEtario as int,
@spvar_CodFacPernocta as char(10),
@spvar_CodFacNoPernocta as char(10),
@spvar_CodPrestacion as char(32),
@spvar_CodCentro as char(5),
@spvar_EstadoCama as char(1)

AS

BEGIN

INSERT INTO Parametros..DatosCamas
(
 NumCama,
 CodPlanta,
 CodServ,
 CodDep,
 CodTIngreso,
 CodOfic,
 CodCent,
 CodTipo,
 NumHabit,
 EstadoCama,
 Borrado,
 MotivoNoFunc,
 CuentaOcupacion,
 ColectivoDUE,
 TipoCama,
 tipoCamaHospitalizacion,
 CodCategorizacion,
 ComplejidadCama,
 GrupoEtario,
 CodFacPernocta,
 CodfacNoPernocta,
 CodPrestacion
)
 VALUES
( 
 @spvar_NumCama,
 @spvar_CodPlanta,
 @spvar_CodServ,
 NULL,
 NULL,
 NULL,
 @spvar_CodCentro,
 NULL,
 @spvar_NumHabit,
 @spvar_EstadoCama,
 @spvar_Borrado,
 NULL,
 @spvar_CuentaOcupacion,
 NULL,
 NULL,
 @spvar_TipoCama,
 NULL,
 @spvar_ComplejidadCama,
 @spvar_GrupoEtario,
 @spvar_CodFacPernocta,
 @spvar_CodFacNoPernocta,
 @spvar_CodPrestacion
) 
END

GO
GO



--dbo.spHClIDiuresis.sql

USE [Hclinica]
GO

IF EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[spHClIDiuresis]') AND type in (N'P', N'PC'))
	DROP PROCEDURE [dbo].[spHClIDiuresis]
GO

SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO
    
-- =============================================
-- Author:		Ismael Sampere Lillo
-- Create date: 20/06/2007
-- Description:	Inserta la constante diuresis que se recibe desde dragger
-- =============================================
-- Revision:	(07/11/2007) Sonia Mateo (Agensys Technology) 
--				Uso este procedimiento en los balances de enfermeria
-- =============================================
-- Revision:	(19/05/2009) Ismael Sampere 
--				Ampliacion del codigo de historia
-- =============================================
-- MODIFICACIÓN: (02/05/2016) - V4.61 - 3128 - JMG - Fecha de Registro de constantes Vitales
-- MODIFICACIÓN: (21/08/2017) - V17.3 - 16489 - APB - Volumen ingerido de Control de Ingesta a Balances

CREATE PROCEDURE [dbo].[spHClIDiuresis]
	 @spvar_CodigoPaciente as varchar(16)
	,@spvar_CodigoEpisodio as varchar(5)
	,@spar_NHistoria as varchar(8)
	,@spar_Fecha as smalldatetime
	,@spvar_Valor as decimal(10,2)
	,@spvar_FechaRegistro as datetime = null
AS

BEGIN
	SET NOCOUNT ON;
		
	if @spvar_FechaRegistro is null
		set @spvar_FechaRegistro = GetDate()

	if not exists (select CodPaciente from Hclinica..Diuresis 
				   where CodPaciente = @spvar_CodigoPaciente  
						 and CodEpisodio = @spvar_CodigoEpisodio 
						 and Fecha = @spar_Fecha)
	begin
		insert into Hclinica..Diuresis (CodPaciente,CodEpisodio,CodHistoria,Fecha,Diuresis,FechaRegistro)
		select @spvar_CodigoPaciente,@spvar_CodigoEpisodio,@spar_NHistoria,@spar_Fecha,@spvar_Valor,@spvar_FechaRegistro 	
	end
	else
	begin
		update	Hclinica..Diuresis
		set		Diuresis = 	@spvar_Valor
		       ,FechaRegistro = @spvar_FechaRegistro
		where	CodPaciente = @spvar_CodigoPaciente  
				and CodEpisodio = @spvar_CodigoEpisodio 
				and Fecha = @spar_Fecha
	end
END

GO
GO



--dbo.SpHClIObservacionesST.sql

USE [Hclinica]
GO

IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[SpHClIObservacionesST]') AND type in (N'P', N'PC'))
DROP PROCEDURE [dbo].[SpHClIObservacionesST]
GO

/****************************************************
PROCEDIMIENTO	: SpHClIObservacionesST
FUNCION			: Inserta registros en Observaciones
FECHA			: 23/08/2017
VERSION			: 17.3 - 19362 - Gestor de Solicitudes de Traslado
AUTOR			: Marco Polo Ruiz
MODIFICACIÓN	: ASM - 17.3 - 19362 - El IdEstado lo tomaremos del estado actual de la solicitud.
****************************************************/

CREATE PROCEDURE [dbo].[SpHClIObservacionesST]
	@spvar_IdSolicitudTraslado BIGINT, 
	@spvar_Observacion  VARCHAR (300),
	@spvar_DNIUsuario CHAR(8)
 
AS 

BEGIN 
	INSERT Hclinica..ObservacionesST(
		IdSolicitudTraslado, 
		FechaObservacion, 
		Descripcion, 
		DNIUsuario, 
		IdEstSolTrans
	)SELECT
		@spvar_IdSolicitudTraslado,  
		GETDATE(), 
		@spvar_Observacion, 
		@spvar_DNIUsuario,
		IdEstSolTrans 
			FROM SolicitudTraslado ST 
			where ST.IdSolicitudTraslado = @spvar_IdSolicitudTraslado

END
GO
GO



--dbo.SpHClIProtocoloCRM.sql

USE [Hclinica]
GO

/****** Object:  StoredProcedure [dbo].[SpHClIProtocoloCRM]    Script Date: 11/04/2013 17:10:16 ******/
IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[SpHClIProtocoloCRM]') AND type in (N'P', N'PC'))
DROP PROCEDURE [dbo].[SpHClIProtocoloCRM]
GO

USE [Hclinica]
GO

/****** Object:  StoredProcedure [dbo].[SpHClIProtocoloCRM]    Script Date: 11/04/2013 17:10:16 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO




/****************************************************
PROCEDIMIENTO	: SpHClIProtocoloCRM
FUNCION			: Inserta el diagrama de presentacion clinica utilizado para el triaje del paciente 
FECHA			: 23/04/2009
VERSION			: 1.0
AUTOR			: Oscar Vilella
APLICACIÓN ORIGEN	: FAsistProtocoloCRM
MODIFICACIONES : 25-05-2009 Oscar Vilella. Añadir Fecha Creacion y Usuario
MODIFICACIONES : 01-06-2009 Oscar Vilella. Comprobación código nulo
MODIFICACIONES : 30-07-2009 Oscar Vilella. Anyadir protocolo Gripe A
MODIFICAIONES  : 04-11-2013 CTF - 73569626D - CHC3426_REQ38254_Localizacion Protocolo de pertinencia
MODIFICACIONES : 19/07/2017 ASM - v17.2r1 - 18277 - Cuando se inserta en DiagramaTriaje se actualiza el campo Tipo de la
				 tabla Triajes a 1 (Manchester).
****************************************************/
CREATE PROCEDURE [dbo].[SpHClIProtocoloCRM]
			@spvar_CodProtocolo smallint,
			@spvar_Terminador smallint,
			@spvar_ExcepcionProt bit,
			@spvar_CodPaciente char(16),
			@spvar_CodEpisodio char(5)=NULL,					
			@spvar_Usuario char(8)='',			
			@spvar_Codigo varchar(14)=NULL OUTPUT						
AS

DECLARE @spvar_TablaProtocolo varchar(50)
DECLARE @spvar_TablaDiscriminadores varchar(50)
DECLARE @spvar_SQL varchar(max)

SELECT @spvar_TablaProtocolo=C.TablaProtocolo, @spvar_TablaDiscriminadores=C.TablaDiscriminadores
FROM Parametros..CRM C
	 INNER JOIN Parametros..ProtocolosCRM P
	 ON C.CodCRM = P.CodCRM 
WHERE P.CodProtocolo = @spvar_CodProtocolo


-- Insertamos el registro en la tabla indicada por el protocolo utilizado

IF @spvar_TablaProtocolo = 'Ingresos..DiagramaTriaje' -- PROTOCOLO TRIAJE MANCHESTER
BEGIN
	
	-- Borramos los registros que pudieran existir del episodio del paciente
	DELETE FROM Ingresos..PeakFlowDiagrama
	WHERE CodTriaje = @spvar_Codigo

	DELETE FROM Ingresos..DiscriminadoresTriaje
	WHERE CodTriaje = @spvar_Codigo
	
	DELETE FROM Ingresos..DiagramaTriaje
	WHERE CodTriaje = @spvar_Codigo
	
	-- Insertamos el registro
	INSERT 
	INTO Ingresos..DiagramaTriaje
		(CodTriaje, 
		CodDiagrama,
		CodPaciente,
		CodEpisodio)
	VALUES
		(@spvar_Codigo,
		@spvar_CodProtocolo,
		@spvar_CodPaciente,
		@spvar_CodEpisodio)
	
	UPDATE 
		Ingresos..Triajes
	SET
		Tipo = 1
	WHERE
		CodPaciente = @spvar_CodPaciente AND
		CodEpisodio = @spvar_CodEpisodio AND
		CodTriaje = @spvar_Codigo	
		
END
		
IF @spvar_TablaProtocolo = 'HClinica..CRMProtTrauma' -- PROTOCOLO TRAUMA
BEGIN
	IF NOT @spvar_Codigo IS NULL 
	BEGIN
		-- Borramos los registros que pudieran existir del protocolo
		SELECT @spvar_SQL = 'DELETE FROM ' + @spvar_TablaDiscriminadores
		SELECT @spvar_SQL = @spvar_SQL + ' WHERE Codigo = ' + @spvar_Codigo
		EXEC (@spvar_SQL)
	
		SELECT @spvar_SQL = 'DELETE FROM ' + @spvar_TablaProtocolo
		SELECT @spvar_SQL = @spvar_SQL + ' WHERE Codigo = ' + @spvar_Codigo		
		EXEC (@spvar_SQL)
	END
	
	-- Insertamos el registro
	SELECT @spvar_SQL = 'INSERT INTO ' + @spvar_TablaProtocolo
	SELECT @spvar_SQL = @spvar_SQL + ' (CodPaciente, CodProtocolo, Terminador, ExcepcionProt, FCreacion, Usuario)'	
	SELECT @spvar_SQL = @spvar_SQL + ' VALUES (''' + @spvar_CodPaciente + ''',' + CAST(@spvar_CodProtocolo as varchar) + ',' + CAST(@spvar_Terminador as varchar) + ',' + CAST(@spvar_ExcepcionProt as varchar) + ','
	SELECT @spvar_SQL = @spvar_SQL + ' ''' + CAST(GETDATE() as varchar) + ''',''' + @spvar_Usuario + ''')'	
	EXEC (@spvar_SQL)

	SELECT @spvar_Codigo = @@IDENTITY  -- devolvemos el código creado
END
	
IF @spvar_TablaProtocolo = 'HClinica..CRMProtGripeA' -- PROTOCOLO GRIPE A
BEGIN
	IF NOT @spvar_Codigo IS NULL 
	BEGIN
		-- Borramos los registros que pudieran existir del protocolo
		SELECT @spvar_SQL = 'DELETE FROM ' + @spvar_TablaDiscriminadores
		SELECT @spvar_SQL = @spvar_SQL + ' WHERE Codigo = ' + @spvar_Codigo
		EXEC (@spvar_SQL)
	
		SELECT @spvar_SQL = 'DELETE FROM ' + @spvar_TablaProtocolo
		SELECT @spvar_SQL = @spvar_SQL + ' WHERE Codigo = ' + @spvar_Codigo		
		EXEC (@spvar_SQL)
	END
	
	-- Insertamos el registro
	SELECT @spvar_SQL = 'INSERT INTO ' + @spvar_TablaProtocolo
	SELECT @spvar_SQL = @spvar_SQL + ' (CodProtocolo, Terminador, ExcepcionProt, FCreacion, Usuario)'	
	SELECT @spvar_SQL = @spvar_SQL + ' VALUES (' + CAST(@spvar_CodProtocolo as varchar) + ',' + CAST(@spvar_Terminador as varchar) + ',' + CAST(@spvar_ExcepcionProt as varchar) + ','
	SELECT @spvar_SQL = @spvar_SQL + ' ''' + CAST(GETDATE() as varchar) + ''',''' + @spvar_Usuario + ''')'	
	EXEC (@spvar_SQL)

	SELECT @spvar_Codigo = @@IDENTITY  -- devolvemos el código creado
END	


--CTF - 73569626D - CHC3426_REQ38254_Localizacion Protocolo de pertinencia - INI 
IF @spvar_TablaProtocolo = 'Consultas..ProtPertinencia'  -- PROTOCOLO PERTINENCIA
BEGIN

	SELECT @spvar_Codigo = Codigo 
	FROM Consultas..ProtPertinencia 
	WHERE CodEpisodio = @spvar_CodEpisodio AND CodPaciente = @spvar_CodPaciente  AND CodProtocolo = convert(varchar,@spvar_CodProtocolo)
	
	--CON EL CODIGO OBTENIDO
	IF NOT @spvar_Codigo IS NULL 
	BEGIN
		-- Borramos los registros que pudieran existir del protocolo
		SELECT @spvar_SQL = 'DELETE FROM ' + @spvar_TablaDiscriminadores
		SELECT @spvar_SQL = @spvar_SQL + ' WHERE Codigo = ' + @spvar_Codigo
		EXEC (@spvar_SQL)

		SELECT @spvar_SQL = 'DELETE FROM ' + @spvar_TablaProtocolo
		SELECT @spvar_SQL = @spvar_SQL + ' WHERE Codigo = ' + @spvar_Codigo		
		EXEC (@spvar_SQL)
	END
	
	-- Insertamos el registro
	SELECT @spvar_SQL = 'INSERT INTO ' + @spvar_TablaProtocolo
	SELECT @spvar_SQL = @spvar_SQL + ' (CodProtocolo,CodPaciente,CodEpisodio, ExcepcionProt, FCreacion, Usuario)'	
	SELECT @spvar_SQL = @spvar_SQL + ' VALUES (' + CAST(@spvar_CodProtocolo as varchar) + ',''' + @spvar_CodPaciente + ''',''' + @spvar_CodEpisodio + ''',' + CAST(@spvar_ExcepcionProt as varchar) + '	,'
	SELECT @spvar_SQL = @spvar_SQL + ' ''' + CAST(GETDATE() as varchar) + ''',''' + @spvar_Usuario + ''')'

	EXEC (@spvar_SQL)

	SELECT @spvar_Codigo = @@IDENTITY  -- devolvemos el código creado
END
--CTF - 73569626D - CHC3426_REQ38254_Localizacion Protocolo de pertinencia - FIN

GO



GO



--dbo.SpHClISolicitudTraslado.sql

USE [Hclinica]
GO

IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[SpHClISolicitudTraslado]') AND type in (N'P', N'PC'))
DROP PROCEDURE [dbo].[SpHClISolicitudTraslado]
GO

USE [Hclinica]
GO

SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

/*
PROCEDIMIENTO : SpHClISolicitudTraslado
FUNCION:  Inserta las solicitudes de traslado 
DEVUELVE:
FECHA: 24/07/2013
VERSION: 1.0
AUTOR: MAIPU CHC2503 V4.40 FCB, Solicitudes de traslado
MODIFICACION: MAIPU CHC3555 V4.40 R5 FCB, Observacion Sol. Traslado
MODIFICACION: 22/08/2017 - v17.3 - 19362 - MPR - Gestor de Solicitudes de Traslado
MODIFICACION: 24/08/2017 - v17.3 - 19248 - MPR - Modificaciones en Solicitud de Traslado Externa desde Admision e Historia Clinica
*/

CREATE PROCEDURE [dbo].[SpHClISolicitudTraslado]
	@spvar_IdEstSolTrans TinyInt = 1, --1 estado pendiente
	@spvar_FSolicitud datetime,
	@spvar_CodPaciente Char(16),
	@spvar_CodEpisodio Char(5),
	@spvar_IdPrioSolTrans TinyInt,
	@spvar_TipoTrasladoOri TinyInt,  
	@spvar_TipoTrasladoDes TinyInt, 
	@spvar_IdTipoVehiculoTras smallint,  
	@spvar_Retorno bit=0,
	@spvar_Medicalizado bit=0,
	@spvar_CodCentro char(5),
	@spvar_CodCentroOri char(5)=null,
	@spvar_CodAreaOri Varchar(3)=null,
	@spvar_CodPlantasOri Char(4)=null,
	@spvar_NumCamaOri Char(7)=null,
	@spvar_CodCamaOri Char(10)=null,
	@spvar_CodUbiConsOri Char(2)=null,
	@spvar_CodSalaOri Char(3)=null,
	@spvar_NumQuirofanoOri Char(2)=null,
	@spvar_CodServicioOri Char(4)=null,
	@spvar_CodCentroDes char(5)=null,
	@spvar_CodAreaDes Varchar(3)=null,
	@spvar_CodPlantasDes Char(4)=null,
	@spvar_NumCamaDes Char(7)=null,
	@spvar_CodCamaDes Char(10)=null,
	@spvar_CodUbiConsDes Char(2)=null,
	@spvar_CodSalaDes Char(3)=null,
	@spvar_NumQuirofanoDes Char(2)=null,
	@spvar_CodServicioDes Char(4)=null,
	@spvar_TrasExtOri Char(1)=null,
	@spvar_DesTrasExtOri Varchar(250)=null,
	@spvar_TrasExtDes Char(1)=null,
	@spvar_DesTrasExtDes Varchar(250)=null,
	@spvar_Observaciones Varchar(200)=null,
	@spvar_IdSolicitudTraslado bigint out,
	@spvar_DNIProfesional char(8) = NULL,
	@spvar_CodAcompanyante INT = NULL,
	@spvar_DNIMedicoTraslada CHAR(8) = NULL,
	@spvar_DNIEnfermeraTraslada CHAR(8) = NULL,
	@spvar_NombreMedicoRecibe VARCHAR(200) = NULL,
	@spvar_NombreEnfermeraRecibe VARCHAR(200) = NULL,
	@spvar_NombreMatronaRecibe VARCHAR(200) = NULL
AS 

BEGIN 
	INSERT Hclinica..SolicitudTraslado(FSolicitud,  CodPaciente, CodEpisodio, IdPrioSolTrans, TipoTrasladoOri, 
	TipoTrasladoDes,IdTipoVehiculoTras, Retorno, Medicalizado, IdEstSolTrans,  
	CodCentro,  --MAIPU CHC3555 V4.40 R5 FCB, Observacion Sol. Traslado
	CodCentroOri, CodAreaOri, CodPlantasOri, NumCamaOri, CodCamaOri, CodUbiConsOri, 
	CodSalaOri, NumQuirofanoOri, CodServicioOri, CodCentroDes, CodAreaDes, CodPlantasDes, 
	NumCamaDes, CodCamaDes, CodUbiConsDes, CodSalaDes, NumQuirofanoDes, 
	CodServicioDes, TrasExtOri, DesTrasExtOri, TrasExtDes, DesTrasExtDes, Observaciones, DNIProfesional,
	CodAcompanyante, DNIMedicoTraslada, DNIEnfermeraTraslada, NombreMedicoRecibe, NombreEnfermeraRecibe, NombreMatronaRecibe)
	Values 
	(@spvar_FSolicitud,  @spvar_CodPaciente, @spvar_CodEpisodio, @spvar_IdPrioSolTrans, @spvar_TipoTrasladoOri, 
	@spvar_TipoTrasladoDes,@spvar_IdTipoVehiculoTras, @spvar_Retorno, @spvar_Medicalizado, @spvar_IdEstSolTrans,@spvar_CodCentro,    
	@spvar_CodCentroOri, @spvar_CodAreaOri, @spvar_CodPlantasOri, @spvar_NumCamaOri, @spvar_CodCamaOri, @spvar_CodUbiConsOri, 
	@spvar_CodSalaOri, @spvar_NumQuirofanoOri, @spvar_CodServicioOri, @spvar_CodCentroDes, @spvar_CodAreaDes, @spvar_CodPlantasDes, 
	@spvar_NumCamaDes, @spvar_CodCamaDes, @spvar_CodUbiConsDes, @spvar_CodSalaDes, @spvar_NumQuirofanoDes, 
	@spvar_CodServicioDes, @spvar_TrasExtOri, @spvar_DesTrasExtOri, @spvar_TrasExtDes, @spvar_DesTrasExtDes, @spvar_Observaciones,
	@spvar_DNIProfesional, @spvar_CodAcompanyante, @spvar_DNIMedicoTraslada, @spvar_DNIEnfermeraTraslada, @spvar_NombreMedicoRecibe,
	@spvar_NombreEnfermeraRecibe, @spvar_NombreMatronaRecibe)
	
	SELECT @spvar_IdSolicitudTraslado=@@IDENTITY
END
GO



--dbo.SpHClITrazabilidadST.sql

USE [Hclinica]
GO

IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[SpHClITrazabilidadST]') AND type in (N'P', N'PC'))
DROP PROCEDURE [dbo].[SpHClITrazabilidadST]
GO

/****************************************************
PROCEDIMIENTO	: SpHClITrazabilidadST
FUNCION			: Inserta registros en TrazabilidadST y Actualiza  Solicitud de Traslado
FECHA			: 23/08/2017
VERSION			: 17.3 - 19362 - Gestor de Solicitudes de Traslado
AUTOR			: Marco Polo Ruiz
****************************************************/

CREATE PROCEDURE [dbo].[SpHClITrazabilidadST]
	@spvar_IdSolicitudTraslado BIGINT, 
	@spvar_FechaCambio SMALLDATETIME,
	@spvar_Descripcion  VARCHAR (300),
	@spvar_NIFUsuario CHAR(9),
	@spvar_IdEstado TINYINT
 
AS 

IF EXISTS (SELECT * FROM HClinica..SolicitudTraslado WHERE IdSolicitudTraslado=@spvar_IdSolicitudTraslado)
 BEGIN
  UPDATE HClinica..SolicitudTraslado 
  SET FModificacion = GETDATE(), IdEstSolTrans=@spvar_IdEstado
  WHERE IdSolicitudTraslado=@spvar_IdSolicitudTraslado
 END

BEGIN 
	INSERT Hclinica..TrazabilidadST(IdSolicitudTraslado, FechaCambio, FechaRegistro, Descripcion, NIFUsuario, IdEstSolTrans)
	VALUES 
	(@spvar_IdSolicitudTraslado, @spvar_FechaCambio, GETDATE(), @spvar_Descripcion, @spvar_NIFUsuario, @spvar_IdEstado)

END
GO
GO



--dbo.SpHClSBalancesEnf.sql

USE [Hclinica]
GO

IF EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[SpHClSBalancesEnf]') AND type in (N'P', N'PC'))
	DROP PROCEDURE [dbo].[SpHClSBalancesEnf]
GO
    
/*
PROCEDIMIENTO     : SpHClSBalancesEnf
FUNCION		      : Obtiene los balances de enfermeria del paciente indicado
DEVUELVE	      :
FECHA		      : 02/11/2007
VERSION		      : 1.0
AUTOR		      : Sonia Mateo (Agensys Technology)
APLICACIÓN ORIGEN : Balances Enfermeria
MODIFICACIÓN      : (28/11/2007) Sonia Mateo (Agensys Technology)
				    Modifico el procedimiento para que no devuelva 0 en los valores de los balances y
				    para que haga calcule los totales sin decimales
MODIFICACIÓN      : (01/06/2008) MPS - nuevo campo Restos
MODIFICACIÓN      : (30/04/2009) Teresa L Fabuel. Se modifica CodHistoria char(6) a varchar(8)
MODIFICACIÓN      : (21/08/2017) - V17.3 - 16489 - APB - Volumen ingerido de Control de Ingesta a Balances
*/

CREATE PROCEDURE [dbo].[SpHClSBalancesEnf]
	 @spvar_CodPaciente as char(16)
    ,@spvar_CodEpisodio as char(5) 
    ,@spvar_FechaDesde as smalldatetime
	,@spvar_FechaHasta as smalldatetime
AS

declare @tablaBalances as table
(
	FechaBalance smalldatetime,
	HoraBalance smalldatetime,
	CodHistoria varchar(8),
	IngestaOral varchar(14),--decimal(10,2),
	NutricionEnteral varchar(14),--decimal(10,2),
	NutricionPar varchar(14),--decimal(10,2),
	Fluidoterapia varchar(14),--decimal(10,2),
	FarmDilucion varchar(14),--decimal(10,2),
	Hemoderivado varchar(14),--decimal(10,2),
	CodLavadoEnt char(2),
	CantidadEnt varchar(14),--decimal(10,2),
	Diuresis varchar(14),--decimal(10,2),
	Deposiciones varchar(14),--decimal(10,2),
	WC bit,
	Sudoracion varchar(14),--decimal(10,2),
	Sangrado varchar(14),--decimal(10,2),
	Vomitos varchar(14),--decimal(10,2),
	CodLavadoSal char(2),
	CantidadSal varchar(14),--decimal(10,2),
	CodDrenajeUno char(2),
	CodDrenajeDos char(2),
	CodDrenajeTres char(2),
	CodDrenajeCuatro char(2),
	CantidadDreUno varchar(14),--decimal(10,2),
	CantidadDreDos varchar(14),--decimal(10,2),
	CantidadDreTres varchar(14),--decimal(10,2),
	CantidadDreCuatro varchar(14),--decimal(10,2),
	LavadoEnt varchar(50),
	LavadoSal varchar(50),
	DrenajeUno varchar(50),
	DrenajeDos varchar(50),
	DrenajeTres varchar(50),
	DrenajeCuatro varchar(50),
	TotalEntrada varchar(100),--decimal(10,2),
	TotalSalida  varchar(100),--decimal(10,2)
	Restos varchar(100) -- decimal(10,2)
)

	insert into @tablaBalances
	select  b.FechaBalance
		   ,b.HoraBalance
		   ,b.CodHistoria
		   ,b.IngestaOral
		   ,b.NutricionEnteral
		   ,b.NutricionPar
		   ,b.Fluidoterapia
		   ,b.FarmDilucion
		   ,b.Hemoderivado
		   ,b.CodLavadoEnt
		   ,b.CantidadEnt
		   ,d.Diuresis
		   ,b.Deposiciones
		   ,b.WC
		   ,b.Sudoracion
		   ,b.Sangrado
		   ,b.Vomitos
		   ,b.CodLavadoSal
		   ,b.CantidadSal
		   ,b.CodDrenajeUno
		   ,b.CodDrenajeDos
		   ,b.CodDrenajeTres
		   ,b.CodDrenajeCuatro
		   ,b.CantidadDreUno
		   ,b.CantidadDreDos
		   ,b.CantidadDreTres
		   ,b.CantidadDreCuatro
		   ,le.DesLavado as LavadoEnt
		   ,ls.DesLavado as LavadoSal
		   ,d1.desdrenaje as DrenajeUno
		   ,d2.desdrenaje as DrenajeDos
		   ,d3.desdrenaje as DrenajeTres
		   ,d4.desdrenaje as DrenajeCuatro
		   ,null
		   ,null
		   ,b.Restos
		   
	  from Hclinica.dbo.Balances b
		   left join Hclinica..Diuresis d on d.CodPaciente = b.CodPaciente and d.CodEpisodio = b.CodEpisodio and b.HoraBalance = d.Fecha
		   left join Parametros..Lavados le on le.CodLavado = b.CodLavadoEnt
		   left join Parametros..Lavados ls on ls.CodLavado = b.CodLavadoSal
		   left join Parametros..Drenajes d1 on d1.CodDrenaje = b.CodDrenajeUno
		   left join Parametros..Drenajes d2 on d2.CodDrenaje = b.CodDrenajeDos
		   left join Parametros..Drenajes d3 on d3.CodDrenaje = b.CodDrenajeTres
		   left join Parametros..Drenajes d4 on d4.CodDrenaje = b.CodDrenajeCuatro

	  where	b.CodPaciente = @spvar_CodPaciente 
			and b.CodEpisodio = @spvar_CodEpisodio 
			and b.FechaBalance between @spvar_FechaDesde and @spvar_FechaHasta

	  order by HoraBalance desc


update @tablaBalances
set TotalEntrada =	convert(decimal(10,2),isnull(IngestaOral,'0')) 
				  + convert(decimal(10,2),isnull(NutricionEnteral,'0'))
				  + convert(decimal(10,2),isnull(NutricionPar,'0'))
				  + convert(decimal(10,2),isnull(Fluidoterapia,'0'))
				  + convert(decimal(10,2),isnull(FarmDilucion,'0'))
				  + convert(decimal(10,2),isnull(Hemoderivado,'0'))
				  + convert(decimal(10,2),isnull(CantidadEnt,'0')),
	 TotalSalida =	convert(decimal(10,2),isnull(Diuresis,'0'))
				  + convert(decimal(10,2),isnull(Deposiciones,'0'))
				  + convert(decimal(10,2),isnull(Sudoracion,'0'))
				  + convert(decimal(10,2),isnull(Sangrado,'0'))
				  + convert(decimal(10,2),isnull(Vomitos,'0'))
				  + convert(decimal(10,2),isnull(CantidadSal,'0'))
				  + convert(decimal(10,2),isnull(CantidadDreUno,'0'))
				  + convert(decimal(10,2),isnull(CantidadDreDos,'0'))
				  + convert(decimal(10,2),isnull(CantidadDreTres,'0'))
				  + convert(decimal(10,2),isnull(CantidadDreCuatro,'0'))
				  + convert(decimal(10,2),isnull(Restos,'0'))

select * from @tablaBalances

GO
GO



--dbo.SpHClSBrazalete.sql

USE [Hclinica]

IF EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[SpHClSBrazalete]') AND type in (N'P', N'PC'))
	DROP PROCEDURE [dbo].[SpHClSBrazalete]
GO
    
/**************************************************************
PROCEDIMIENTO : SpHClSBrazalete
FUNCIÓN       : Devuelve datos para la impresión de brazaletes
FECHA         : 02/08/2012
VERSIÓN       : 1.0
AUTOR         : Francisco Cuenca Benítez
MODIFICACIÓN  : (08/01/2013) - V4.36 - Alberto Pagán MAIPU CHC2521 - REQ 11437 Impresión de brazalete por tipo de paciente
MODIFICACIÓN  : (15/07/2015) - V4.53 - 2346 - LMF - Impresión de pasaporte en Brazalete
MODIFICACIÓN  : (27/07/2015) - V4.53 - 2344 - SGN - Formato Brazalete recién nacido
MODIFICACIÓN  : (07/09/2015) - V4.53r1 - 2498 - LMF - Formato brazalete recién nacido
MODIFICACIÓN  : (19/11/2015) - Patrick Vicuña - se comenta AND(P.CodGrupProblem = '10' OR P.CodGrupProblem = '11'), para que no discrimine por grupo de problemas
MODIFICACIÓN  : (14/03/2016) - V4.55 - Patrick Vicuña - se comenta AND(P.CodGrupProblem = '10' OR P.CodGrupProblem = '11'),
                                                        para que no discrimine por grupo de problemas y se crea el nuevo filtro AND(A.Alergias  = 1 OR A.Medicamentos = 1 OR A.Ram = 1)
MODIFICACIÓN  : (09/05/2017) - V17.2 - 16146 - SGH - Incluir Nombre Social del Paciente
MODIFICACIÓN  : (28/06/2017) - V17.2r1 - APB - Corregido error en impresión de brazaletes de recién nacidos
*****************************************************************/

CREATE PROCEDURE [dbo].[SpHClSBrazalete]
	 @spvar_CodPaciente char(16)
	,@spvar_CodEpisodio char(5) = null
	,@spvar_CodPacienteHijo char(16) = null
AS

DECLARE @spvar_TipoEpisodio char(1)

IF NOT @spvar_CodEpisodio IS NULL
	SELECT @spvar_TipoEpisodio = SUBSTRING(@spvar_CodEpisodio,1,1)
ELSE
	SELECT @spvar_TipoEpisodio = ''

IF @spvar_TipoEpisodio = 'C' --Episodio de Consultas
	BEGIN
		SELECT
			   'NombreCompleto' = RTRIM(Pac.PacNombre) + ' ' + RTRIM(Pac.PacApell1) + ' ' + RTRIM(Pac.PacApell2)				 
			  -- 15/07/2015 - v4.53 - 2346 - LMF - Impresión de pasaporte en Brazalete - INI
			  -- Modificamos la obtencion del RUT segun tipo de identificacion si no tuviera RUT
			  ,'RUT' = CASE
						  WHEN ISNULL(Pac.NumTarjSanitaria,'') <> '' THEN Pac.NumTarjSanitaria
						  WHEN Pac.tipoIdentificacion = 2 THEN Pac.TarjSanitariaResp
						  WHEN Pac.tipoIdentificacion = 3 THEN Pac.Nif
						  ELSE 'Paciente Sin RUN'
					   END	
			  ,'EsPasaporte' = CASE 
								 WHEN ISNULL(Pac.NumTarjSanitaria,'') = '' AND Pac.tipoIdentificacion = 3 THEN 1
								 ELSE 0
							   END
				-- 15/07/2015 - v4.53 - 2346 - LMF - Impresión de pasaporte en Brazalete - FIN
			  
			  ,'FechaBrazalete' = EC.FechaBrazalete
			  ,'FechaNacimiento' = Pac.FecNac
			  --Alberto Pagán - MAIPU CHC2521 - v4.36 - 08/01/2013 - INI
			  ,'TieneAlergia' = (SELECT COUNT(1)
							     FROM Hclinica..Problemas P
							          INNER JOIN Parametros..Alarmas A ON P.CodGrupProblem = A.Codigo
							     WHERE P.CodPaciente = @spvar_CodPaciente
									   --AND(P.CodGrupProblem = '10' OR P.CodGrupProblem = '11')
									   AND(A.Alergias = 1 OR A.Medicamentos = 1 OR A.Ram = 1)
							           AND P.FecIni <= getdate()
							           AND(P.FecFin >= getdate()
							           OR P.FecFin IS NULL))
			  ,'NHC' = Pac.CodHistoria
			  ,'EdadReferenciaPed' = ISNULL(S.EdadReferenciaPed,0)
			  ,'EdadReferenciaRN' = ISNULL(S.EdadReferenciaRN,0)
			  --Alberto Pagán - MAIPU CHC2521 - v4.36 - 08/01/2013 - FIN
			  --Juan Ramon Pelegrina - 1454 - V4.48 - 27/10/2014 - INI
			  ,'Sexo' = Pac.Genero
			  --Juan Ramon Pelegrina - 1454 - V4.48 - 27/10/2014 - FIN				  
			   --(14/09/2015) - v4.53 - 2344 - SGN - Formato Brazalete recién nacido - INI
			  ,A.AlumbramientoUnico
			  ,Ges.CodGestacion
			  ,Ges.CodPacienteHijo
			  ,'RUN' = Pac.NumTarjSanitaria
			  ,Pac.Nif
			  ,'NombreMadre' = RTRIM(PacMadre.PacNombre) + ' ' + RTRIM(PacMadre.PacApell1) + ' ' + RTRIM(PacMadre.PacApell2)
			  ,'RUNMadre' = PacMadre.NumTarjSanitaria
			  --(14/09/2015) - v4.53 - 2344 - SGN - Formato Brazalete recién nacido - FIN
			  -- (07/09/2015) - v4.53r1 - 2498 - LMF - Formato brazalete recién nacido --INI
			  ,'TipoIdentificacion' = Pac.tipoIdentificacion
			  -- (07/09/2015) - v4.53r1 - 2498 - LMF - Formato brazalete recién nacido --FIN
			  ,'NombreSocial' = Pac.AtiendeAlNombre
			  ,'NombreSocialMadre' = PacMadre.AtiendeAlNombre
		FROM Consultas..EpisodioConsultas EC
			 --(14/09/2015) - v4.53 - 2344 - SGN - Formato Brazalete recién nacido - INI
		     INNER JOIN Hclinica..Pacientes Pac ON EC.CodPaciente = Pac.CodPaciente
		     LEFT JOIN Hclinica..Neonato Neo ON EC.CodPaciente = Neo.CodPacienteHijo
			 LEFT JOIN Hclinica..Pacientes PacMadre ON Neo.CodPaciente = PacMadre.CodPaciente
			 --Alberto Pagán - MAIPU CHC2521 - v4.36 - 08/01/2013 - INI
			 LEFT JOIN Parametros..Servicios S ON S.Codigo = EC.CodServicioFinal
			 --Alberto Pagán - MAIPU CHC2521 - v4.36 - 08/01/2013 - FIN
			 LEFT JOIN Hclinica..Alumbramiento A ON (Neo.CodPaciente = A.CodPaciente AND Neo.CodEpisodio = A.CodEpisodio)
			 LEFT JOIN (SELECT CodPacienteHijo, 'G' + CAST(ROW_NUMBER() OVER(ORDER BY FecNac ASC) AS char) AS CodGestacion, Neo.FecNac, CodEpisodio, CodEpisodioHijo
			            FROM Hclinica..Neonato Neo WHERE Neo.CodPaciente = (SELECT CodPaciente FROM Hclinica..Neonato WHERE CodPacienteHijo = @spvar_CodPaciente)
			            AND Neo.CodEpisodio IN (SELECT CodEpisodio FROM Hclinica..Neonato WHERE CodPacienteHijo = @spvar_CodPaciente)) Ges ON Neo.CodPacienteHijo = Ges.CodPacienteHijo
			 --(14/09/2015) - v4.53 - 2344 - SGN - Formato Brazalete recién nacido - FIN
		WHERE EC.CodPaciente = @spvar_CodPaciente AND EC.CodEpisodio = @spvar_CodEpisodio
	END

IF @spvar_TipoEpisodio = 'H' --Episodio de Hospitalización
	BEGIN
		SELECT 
			   'NombreCompleto' = RTRIM(Pac.PacNombre) + ' ' + RTRIM(Pac.PacApell1) + ' ' + RTRIM(Pac.PacApell2)
			  -- 15/07/2015 - v4.53 - 2346 - LMF - Impresión de pasaporte en Brazalete - INI
			  -- Modificamos la obtencion del RUT segun tipo de identificacion si no tuviera RUT
			  ,'RUT' = CASE
						  WHEN ISNULL(Pac.NumTarjSanitaria,'') <> '' THEN Pac.NumTarjSanitaria
						  WHEN Pac.tipoIdentificacion = 2 THEN Pac.TarjSanitariaResp
						  WHEN Pac.tipoIdentificacion = 3 THEN Pac.Nif
						  ELSE 'Paciente Sin RUN'
					   END	
			  ,'EsPasaporte' = CASE 
								  WHEN ISNULL(Pac.NumTarjSanitaria,'') = '' AND Pac.tipoIdentificacion = 3 THEN 1
							      ELSE 0
							   END
				-- 15/07/2015 - v4.53 - 2346 - LMF - Impresión de pasaporte en Brazalete - FIN
				
			  ,'FechaBrazalete' = EH.FechaBrazalete
			  ,'FechaNacimiento' = Pac.FecNac
			  --Alberto Pagán - MAIPU CHC2521 - v4.36 - 08/01/2013 - INI
			  ,'TieneAlergia' = (SELECT COUNT(1)
			  				     FROM Hclinica..Problemas P
									  INNER JOIN Parametros..Alarmas A ON P.CodGrupProblem = A.Codigo
							     WHERE P.CodPaciente = @spvar_CodPaciente
								       --AND(P.CodGrupProblem = '10' OR P.CodGrupProblem = '11')
								       AND(A.Alergias = 1 OR A.Medicamentos = 1 OR A.Ram = 1)
							           AND P.FecIni <= getdate()
							           AND(P.FecFin >= getdate()
 							           OR P.FecFin IS NULL))
			  ,'NHC' = Pac.CodHistoria
			  ,'EdadReferenciaPed' = ISNULL(S.EdadReferenciaPed,0)
			  ,'EdadReferenciaRN' = ISNULL(S.EdadReferenciaRN,0)
			  --Alberto Pagán - MAIPU CHC2521 - v4.36 - 08/01/2013 - FIN
			  --Juan Ramon Pelegrina - 1454 - V4.48 - 27/10/2014 - INI
			  ,'Sexo' = Pac.Genero
			  --Juan Ramon Pelegrina - 1454 - V4.48 - 27/10/2014 - FIN  
			  --(14/09/2015) - v4.53 - 2344 - SGN - Formato Brazalete recién nacido - INI
			  ,A.AlumbramientoUnico
			  ,Ges.CodGestacion
			  ,Ges.CodPacienteHijo
			  ,'RUN' = pac.NumTarjSanitaria
			  ,Pac.Nif
			  ,'NombreMadre' = RTRIM(PacMadre.PacNombre) + ' ' + RTRIM(PacMadre.PacApell1) + ' ' + RTRIM(PacMadre.PacApell2)
			  ,'RUNMadre' = PacMadre.NumTarjSanitaria
			  --(14/09/2015) - v4.53 - 2344 - SGN - Formato Brazalete recién nacido - FIN		  
			  -- (07/09/2015) - v4.53r1 - 2498 - LMF - Formato brazalete recién nacido --INI
			  ,'TipoIdentificacion' = Pac.tipoIdentificacion
			  -- (07/09/2015) - v4.53r1 - 2498 - LMF - Formato brazalete recién nacido --FIN
			  ,'NombreSocial' = Pac.AtiendeAlNombre
			  ,'NombreSocialMadre' = PacMadre.AtiendeAlNombre
		FROM Ingresos..EpisodioHospitalizacion EH
			 --(14/09/2015) - v4.53 - 2344 - SGN - Formato Brazalete recién nacido - INI
			 INNER JOIN Hclinica..Pacientes Pac ON EH.CodPaciente = Pac.CodPaciente
			 LEFT JOIN Hclinica..Neonato Neo ON EH.CodPaciente = Neo.CodPacienteHijo
			 LEFT JOIN Hclinica..Pacientes PacMadre ON Neo.CodPaciente = PacMadre.CodPaciente
			 --Alberto Pagán - MAIPU CHC2521 - v4.36 - 08/01/2013 - INI
			 LEFT JOIN Parametros..Servicios S ON S.Codigo = EH.CodigoServicioHospitaliza
			 --Alberto Pagán - MAIPU CHC2521 - v4.36 - 08/01/2013 - FIN
			 LEFT JOIN Hclinica..Alumbramiento A ON (Neo.CodPaciente = A.CodPaciente AND Neo.CodEpisodio = A.CodEpisodio)
			 LEFT JOIN (SELECT CodPacienteHijo, 'G' + CAST(ROW_NUMBER() OVER(ORDER BY FecNac ASC) AS char) AS CodGestacion, Neo.FecNac, CodEpisodio, CodEpisodioHijo
			            FROM Hclinica..Neonato Neo WHERE Neo.CodPaciente = (SELECT CodPaciente FROM Hclinica..Neonato WHERE CodPacienteHijo = @spvar_CodPaciente)
			            AND Neo.CodEpisodio IN (SELECT CodEpisodio FROM Hclinica..Neonato WHERE CodPacienteHijo = @spvar_CodPaciente)) Ges ON Neo.CodPacienteHijo = Ges.CodPacienteHijo
			 --(14/09/2015) - v4.53 - 2344 - SGN - Formato Brazalete recién nacido - FIN
		WHERE EH.CodPaciente = @spvar_CodPaciente AND EH.CodEpisodio = @spvar_CodEpisodio
	END

IF @spvar_TipoEpisodio = 'U' --Episodio de Urgencia
	BEGIN
		SELECT 
			   'NombreCompleto' = RTRIM(Pac.PacNombre) + ' ' + RTRIM(Pac.PacApell1) + ' ' + RTRIM(Pac.PacApell2)
			  -- 15/07/2015 - v4.53 - 2346 - LMF - Impresión de pasaporte en Brazalete - INI
			   -- Modificamos la obtencion del RUT segun tipo de identificacion si no tuviera RUT
			  ,'RUT' = CASE
						  WHEN ISNULL(Pac.NumTarjSanitaria,'') <> '' THEN Pac.NumTarjSanitaria
						  WHEN Pac.tipoIdentificacion = 2 THEN Pac.TarjSanitariaResp
						  WHEN Pac.tipoIdentificacion = 3 THEN Pac.Nif
						  ELSE 'Paciente Sin RUN'
					   END					
			  ,'EsPasaporte' = CASE 
								 WHEN ISNULL(Pac.NumTarjSanitaria,'') = '' AND Pac.tipoIdentificacion = 3 THEN 1
								 ELSE 0
							   END
				-- 15/07/2015 - v4.53 - 2346 - LMF - Impresión de pasaporte en Brazalete - FIN
			  ,'FechaBrazalete' = EU.FechaEntrada
			  ,'FechaNacimiento' = Pac.FecNac
			  --Alberto Pagán - MAIPU CHC2521 - v4.36 - 08/01/2013 - INI
			  ,'TieneAlergia' = (SELECT COUNT(1)
							     FROM Hclinica..Problemas P
							          INNER JOIN Parametros..Alarmas A ON P.CodGrupProblem = A.Codigo
							     WHERE P.CodPaciente = @spvar_CodPaciente
								       --AND(P.CodGrupProblem = '10' OR P.CodGrupProblem = '11')
								       AND(A.Alergias = 1 OR A.Medicamentos = 1 OR A.Ram = 1)
							           AND P.FecIni <= getdate()
							           AND(P.FecFin >= getdate()
							           OR P.FecFin IS NULL))
			  ,'NHC' = Pac.CodHistoria
			  ,'EdadReferenciaPed' = ISNULL(S.EdadReferenciaPed,0)
			  ,'EdadReferenciaRN' = ISNULL(S.EdadReferenciaRN,0)
			  --Alberto Pagán - MAIPU CHC2521 - v4.36 - 08/01/2013 - FIN
			  --Juan Ramon Pelegrina - 1454 - V4.48 - 27/10/2014 - INI
			  ,'Sexo' = Pac.Genero
			  --Juan Ramon Pelegrina - 1454 - V4.48 - 27/10/2014 - FIN 	  
			   --(14/09/2015) - v4.53 - 2344 - SGN - Formato Brazalete recién nacido - INI
			  ,A.AlumbramientoUnico
			  ,Ges.CodGestacion
			  ,Ges.CodPacienteHijo
			  ,'RUN' = Pac.NumTarjSanitaria
			  ,Pac.Nif
			  ,'NombreMadre' = RTRIM(PacMadre.PacNombre) + ' ' + RTRIM(PacMadre.PacApell1) + ' ' + RTRIM(PacMadre.PacApell2)
			  ,'RUNMadre' = PacMadre.NumTarjSanitaria
			  --(14/09/2015) - v4.53 - 2344 - SGN - Formato Brazalete recién nacido - FIN
			  -- (07/09/2015) - v4.53r1 - 2498 - LMF - Formato brazalete recién nacido --INI
			  ,'TipoIdentificacion' = Pac.tipoIdentificacion
			  -- (07/09/2015) - v4.53r1 - 2498 - LMF - Formato brazalete recién nacido --FIN
			  ,'NombreSocial' = Pac.AtiendeAlNombre
			  ,'NombreSocialMadre' = PacMadre.AtiendeAlNombre
		FROM Ingresos..EpisodioUrgencias EU
			 --(14/09/2015) - v4.53 - 2344 - SGN - Formato Brazalete recién nacido - INI
			 LEFT JOIN Hclinica..Neonato Neo ON EU.CodPaciente = Neo.CodPacienteHijo
			 LEFT JOIN Hclinica..Pacientes PacMadre ON Neo.CodPaciente = PacMadre.CodPaciente
			 INNER JOIN Hclinica..Pacientes Pac ON EU.CodPaciente = Pac.CodPaciente
			 --Alberto Pagán - MAIPU CHC2521 - v4.36 - 08/01/2013 - INI
			 LEFT JOIN Parametros..Servicios S ON S.Codigo = EU.CodigoServicioUrgenc
			 --Alberto Pagán - MAIPU CHC2521 - v4.36 - 08/01/2013 - FIN
			 LEFT JOIN Hclinica..Alumbramiento A ON (Neo.CodPaciente = A.CodPaciente AND Neo.CodEpisodio = A.CodEpisodio)
			 LEFT JOIN (SELECT CodPacienteHijo, 'G' + CAST(ROW_NUMBER() OVER(ORDER BY FecNac ASC) AS char) AS CodGestacion, Neo.FecNac, CodEpisodio, CodEpisodioHijo
			            FROM Hclinica..Neonato Neo WHERE Neo.CodPaciente = (SELECT CodPaciente FROM Hclinica..Neonato WHERE CodPacienteHijo = @spvar_CodPaciente)
			            AND Neo.CodEpisodio IN (SELECT CodEpisodio FROM Hclinica..Neonato WHERE CodPacienteHijo = @spvar_CodPaciente)) Ges ON Neo.CodPacienteHijo = Ges.CodPacienteHijo
			 --(14/09/2015) - v4.53 - 2344 - SGN - Formato Brazalete recién nacido - FIN
		WHERE EU.CodPaciente = @spvar_CodPaciente AND EU.CodEpisodio = @spvar_CodEpisodio
	END

--Alberto Pagán - MAIPU CHC2521 - v4.36 - 08/01/2013 - INI
IF @spvar_TipoEpisodio = '' --Sin Episodio: Recién Nacido
	BEGIN
		SELECT 
			   'NombreCompleto' = RTRIM(Pac.PacNombre) + ' ' + RTRIM(Pac.PacApell1) + ' ' + RTRIM(Pac.PacApell2)			 
			  ,'RUT' = PacMadre.NumTarjSanitaria
			   -- 15/07/2015 - v4.53 - 2346 - LMF - Impresión de pasaporte en Brazalete - INI
			   -- Para el recien nacido creamos el campo unicamente para que la SELECT sea igual que en el resto de casos
			  ,'EsPasaporte' = 0
			   -- 15/07/2015 - v4.53 - 2346 - LMF - Impresión de pasaporte en Brazalete - FIN		
			  ,'FechaBrazalete' = '' --No se especifica
			  ,'FechaNacimiento' = Pac.FecNac
			  ,'TieneAlergia' = (SELECT COUNT(1)
							     FROM Hclinica..Problemas P
							          INNER JOIN Parametros..Alarmas A ON P.CodGrupProblem = A.Codigo
							     WHERE P.CodPaciente = Neo.CodPaciente
								       --AND(P.CodGrupProblem = '10' OR P.CodGrupProblem = '11')
								       AND(A.Alergias = 1 OR A.Medicamentos = 1 OR A.Ram = 1)							     
							           AND P.FecIni <= getdate()
							           AND(P.FecFin >= getdate()
							           OR P.FecFin IS NULL))
			  ,'NHC' = Pac.CodHistoria
			  ,'EdadReferenciaPed' = 0 --No se especifica
			  ,'EdadReferenciaRN' = 0 --No se especifica
			  --Juan Ramon Pelegrina - 1454 - V4.48 - 27/10/2014 - INI
			  ,'Sexo' = Pac.Genero
			  --Juan Ramon Pelegrina - 1454 - V4.48 - 27/10/2014 - FIN			
			  --(29/07/2015) - v4.53 - 2344 - SGN - Formato Brazalete recién nacido - INI
			  ,A.AlumbramientoUnico
			  ,Ges.CodGestacion
			  ,Ges.CodPacienteHijo
			  ,'RUN' = Pac.NumTarjSanitaria
			  ,Pac.Nif
			  ,'NombreMadre' = RTRIM(PacMadre.PacNombre) + ' ' + RTRIM(PacMadre.PacApell1) + ' ' + RTRIM(PacMadre.PacApell2)
			  ,'RUNMadre' = PacMadre.NumTarjSanitaria
			  --(29/07/2015) - v4.53 - 2344 - SGN - Formato Brazalete recién nacido - FIN	  
			  -- (07/09/2015) - v4.53r1 - 2498 - LMF - Formato brazalete recién nacido --INI
			  ,'TipoIdentificacion' = Pac.tipoIdentificacion
			  -- (07/09/2015) - v4.53r1 - 2498 - LMF - Formato brazalete recién nacido --FIN
			  ,'NombreSocial' = Pac.AtiendeAlNombre
			  ,'NombreSocialMadre' = PacMadre.AtiendeAlNombre
		FROM Hclinica..Neonato Neo
			 LEFT JOIN Hclinica..Pacientes Pac ON Neo.CodPacienteHijo = Pac.CodPaciente
			 LEFT JOIN Hclinica..Pacientes PacMadre ON Neo.CodPaciente = PacMadre.CodPaciente
			 --(27/07/2015) - v4.53 - 2344 - SGN - Formato Brazalete recién nacido - INI
			 LEFT JOIN Hclinica..Alumbramiento A ON (Neo.CodPaciente = A.CodPaciente AND Neo.CodEpisodio = A.CodEpisodio)
			 LEFT JOIN (SELECT CodPacienteHijo, 'G' + CAST(ROW_NUMBER() OVER(ORDER BY FecNac ASC) AS char) AS CodGestacion, Neo.FecNac 
						FROM Hclinica..Neonato Neo WHERE Neo.CodPaciente = @spvar_CodPaciente AND Neo.CodEpisodio IN (SELECT CodEpisodio FROM Hclinica..Neonato WHERE CodPacienteHijo = @spvar_CodPacienteHijo)) Ges ON Neo.CodPacienteHijo = Ges.CodPacienteHijo
			 --(27/07/2015) - v4.53 - 2344 - SGN - Formato Brazalete recién nacido - FIN
		WHERE Neo.CodPaciente = @spvar_CodPaciente AND Neo.CodPacienteHijo = @spvar_CodPacienteHijo
	END
--Alberto Pagán - MAIPU CHC2521 - v4.36 - 08/01/2013 - FIN

GO
GO



--dbo.SpHClSBuscaPacienteDeTriaje.sql

    USE [HClinica];
    GO
    IF EXISTS 
    (
        SELECT * 
            FROM sys.procedures 
            WHERE [object_id] = OBJECT_ID('[dbo].[SpHClSBuscaPacienteDeTriaje]')
    )
    BEGIN
        DROP PROCEDURE [dbo].[SpHClSBuscaPacienteDeTriaje];
    END
    GO
    



/*********************************************************************
* FUNCION :[SpHClSBuscaPacienteDeTriaje]
* DEVUELVE : Datos para la pantalla de Triaje
* FECHA	: 06/07/07
* VERSION : 1.0
* AUTOR	: MPS
* ORIGEN : Triaje
* 
'*******************************************************************
* MODIFICACIÓN
* COMENTARIO: Obtengo la localización del paciente (para comprobaciones en asignación de médico)
* FECHA	: 23/02/09
* AUTOR	: Oscar Vilella
* Modificado: 21/11/2011 Jap. Añadido el tipo de urgencia desde el episodio
* Modificado: 22/11/2011 Jap. Añadido el motivo de la urgencia desde el episodio
* Modificado: 23/11/2011 JAp. Cambio los tipos de datos de la entrada a los mismos que corresponden a las tablas.
* Modificado: 29/06/2017 - V17.2r1 - 18277 - SGH - Triaje ESI 
'*******************************************************************/

CREATE  proc [dbo].[SpHClSBuscaPacienteDeTriaje]
			@spvar_CodPaciente char(16),
			@spvar_CodEpisodio char(5),
            @spvar_CodTriaje varchar(14)
as


select	ms.Entidad as DescColectivo,
		mp.Entidad as DescMutua, 
		eu.causaurgencias Observaciones,
		ms.DchoUrgencias TieneDerecho,
		IsNull(eu.Localizacion, 0) as Localizacion

from	ingresos..episodiourgencias eu,
		parametros..mutuassalud ms,
		parametros..mutuaprincipal mp

where	eu.codpaciente = @spvar_CodPaciente
		and eu.codepisodio = @spvar_CodEpisodio
		and eu.codcolectivo = ms.codigo
		and ms.CodMutua = mp.Codigo

/*
-- datos del paciente
select  ms.entidad DescMutua,
		ms.entidad DescColectivo,
		eu.causaurgencias Observaciones,
		ms.DchoUrgencias TieneDerecho

from ingresos..episodiourgencias eu,
	 parametros..mutuassalud ms	 
where	eu.codpaciente = @spvar_CodPaciente
		and eu.codepisodio = @spvar_CodEpisodio
		and eu.codcolectivo = ms.codigo
		
*/		
-- datos del triaje

	SELECT
		Id,
		FechaAlta,
		Nombre,
		Apellido1,
		Apellido2,
		Edad,
		Sexo,
		Prioridad,
		TUrgencia,
		Observaciones,
		CodTriaje,
		DniUsu,
		Tipo,
		ReqIntSalVid,
		AltoRiesgo,
		Recursos,
		SVAlterados,
		Alterados,
		AVDI,
		Distresado,
		EVAMenor,
		EVAMayor		 
	FROM 
		--ingresos..Triajes
		  ingresos..HistoricoTriajes
	where	codpaciente = @spvar_CodPaciente
			and codepisodio = @spvar_CodEpisodio
			--and codtriaje = @spvar_CodTriaje
			
SELECT 	ISNULL(e.Area,-1) Area
	,ISNULL(e.CausaUrgencias,'') CausaUrgencias
	 FROM Ingresos..EpisodioUrgencias e 
	WHERE	codpaciente = @spvar_CodPaciente
			and codepisodio = @spvar_CodEpisodio

GO
GO



--dbo.SpHClSBuscDietas.sql

USE [HClinica];
GO
IF EXISTS 
(
    SELECT * 
        FROM sys.procedures 
        WHERE [object_id] = OBJECT_ID('[dbo].[SpHClSBuscDietas]')
)
BEGIN
    DROP PROCEDURE [dbo].[SpHClSBuscDietas];
END
GO
    
/*
PROCEDIMIENTO  : SpHClSBuscDietas
FUNCION        : 
DEVUELVE       : 
FECHA          : 22/11/2005
VERSION        :
AUTOR          : Patricia Clemente (AGENSYS)
CUADERNO CARGA : Dietas por planta
*********************************************************************************************
MODIFICACION   : (14/03/2007) MPS. Incluir condicion fecha fin nula
MODIFICACION   : (26/08/2008) Hugo Pérez-Agensys Incluir la búsqueda de la dieta pediátrica.
MODIFICACION   : (19/05/2009) Ramon Jimenez. Le quito los convert para obtener la fecha de inicio con formato fecha/hora
MODIFICACION   : (01/07/2009) Oscar Vilella. Devolvemos tambien el código de historia
MODIFICACION   : (28/08/2009) Oscar Vilella. Le quito los convert para obtener la fecha de inicio con formato fecha/hora
										     No devuelvo las dietas eliminadas
										     Estandarización de variables
MODIFICACION   : (23/09/2009) Paco Aznar: Se filtran las pruebas que pertenecen a episodios del centro actual
MODIFICACION   : (30/10/2009) Paco Aznar: Se compatibiliza con los registros anteriores de episodio hospitalizacion
MODIFICACION   : (19/11/2009) Ramon Jimenez. Devolvemos tambien el código de paciente para la ocultacion de pacientes
MODIFICACION   : (21/12/2009) Paco Aznar. Se devuelven los pacientes en urgencias y se cambian los unions
MODIFICACION   : (23/12/2009) Paco Aznar. Se devuelve la ubicacion de los pacientes en urgencias
MODIFICACION   : (24/12/2009) Paco Aznar. Se devuelve solo la ubicación en camas o boxes
MODIFICACION   : (19/02/2010) Álvaro Díez. Se añade un campo para recoger las observaciones de la dieta
MODIFICACION   : (23/10/2013) Alberto Pagán - v4.41 Release 1 - MAIPU CHC2528 REQ 16475 HEC_PRESCRIPCION DE DIETAS Y CONTROL DE INGESTA
MODIFICACIÓN   : CHC4053 - v4.41 Release 8 - MAIPU REQ 16475 HEC_Importación e integración de dietas
NOTA: se incluye la claúsula distinct sólo en CEX (AMBULATORIO) para poder distinguir las citas de hospital de día
MODIFICACIÓN   : (13/09/2017) - V17.3 - 16489 - APB - Volumen ingerido de Control de Ingesta a Balances (se quitan tablas Parametros..DatosCamas y Parametros..CodigoPlantas no usadas y que devolvían datos duplicados)
*/

CREATE PROCEDURE [dbo].[SpHClSBuscDietas]
     @Oral char(1) = null
	,@Parenteral char(1) = null
	,@Enteral char(1) = null
	,@Ayuno char(1) = null
	,@Pediatrica char(1) = null
	,@spvar_Oral char(1)
	,@spvar_Parenteral char(1)
	,@spvar_Enteral char(1)
	,@spvar_Ayuno char(1)
	,@spvar_Pediatrica char(1)
	,@spvar_codCentro char(5) = null
	,@FechaNutriOral smalldatetime = null -- v4.41 Release 1 - MAIPU CHC2528 REQ 16475 HEC_PRESCRIPCION DE DIETAS Y CONTROL DE INGESTA
AS

if @spvar_codCentro IS NULL
begin
	set @spvar_codCentro = Parametros.dbo.fnParHospitalReferencia()
end

select @spvar_Oral = ISNULL(@Oral, @spvar_Oral)
select @spvar_Parenteral = ISNULL(@Parenteral, @spvar_Parenteral)
select @spvar_Enteral = ISNULL(@Enteral, @spvar_Enteral)
select @spvar_Ayuno = ISNULL(@Ayuno, @spvar_Ayuno)
select @spvar_Pediatrica = ISNULL(@Pediatrica, @spvar_Pediatrica)

declare @TabDietas TABLE (
        TipoDieta char(4)
       ,Paciente varchar(75)
       ,Cama char(30)
       ,DescPla varchar(30)
       ,ParenteralEnteralOral char(1)
       ,DescDieta varchar(100)
       ,FInicio smalldatetime
       ,FFin smalldatetime
       ,CodHistoria varchar(8)
       ,CodPaciente char(16)
       ,Observaciones varchar(255)
       -- v4.41 Release 1 - MAIPU CHC2528 REQ 16475 HEC_PRESCRIPCION DE DIETAS Y CONTROL DE INGESTA - INI
       ,Entidad char(30)
       ,BalanceHidrico bit
       ,BalanceCalProte bit
       ,IdNutricionValidada bigint
	   ,IdTipoPaciente smallint
	   ,CodEpisodio char(5)
	   ,FCreacion datetime --smalldatetime -- v4.41 Release 1 - MAIPU CHC2528 REQ 16475 HEC_PRESCRIPCION DE DIETAS Y CONTROL DE INGESTA
	   ,CodDieta char(3)
	   ,FDieta smalldatetime
       -- v4.41 Release 1 - MAIPU CHC2528 REQ 16475 HEC_PRESCRIPCION DE DIETAS Y CONTROL DE INGESTA - FIN
       )

/* PACIENTES HOSPITALIZADOS *******************************************************/
insert into @tabdietas
select AG.TipoDieta
	  ,Paciente = (rtrim(ltrim(P.PacNombre)) + ' ' + rtrim(ltrim(P.PacApell1)) + ' ' + rtrim(ltrim(P.PacApell2)))
	  ,H.NumCama Cama
	  ,CP.DescPla
	  ,AG.ParenteralEnteralOral
	  ,PN.DescDieta
	  ,AG.FInicio
	  ,AG.FFin
	  ,AG.CodHistoria
	  ,P.CodPaciente
	  ,AG.Observaciones
	  -- v4.41 Release 1 - MAIPU CHC2528 REQ 16475 HEC_PRESCRIPCION DE DIETAS Y CONTROL DE INGESTA - INI
	  ,MS.Entidad
	  ,ISNULL(NV.BalanceHidrico,0) as 'BalanceHidrico'
	  ,ISNULL(NV.BalanceCalProte,0) as 'BalanceCalProte'
	  ,ISNULL(NV.IdNutricionValidada,0) as 'IdNutricionValidada'
	  ,N.IdTipoPaciente
	  ,N.CodEpisodio
	  ,N.FCreacion
	  ,N.CodDieta
	  ,NV.FechaDieta
	  -- v4.41 Release 1 - MAIPU CHC2528 REQ 16475 HEC_PRESCRIPCION DE DIETAS Y CONTROL DE INGESTA - FIN
	 
from Hclinica..Pacientes P,
	 Ingresos..EpisodioHospitalizacion H
	 -- v4.41 Release 1 - MAIPU CHC2528 REQ 16475 HEC_PRESCRIPCION DE DIETAS Y CONTROL DE INGESTA - INI
	 LEFT JOIN Parametros..MutuasSalud MS ON MS.Codigo = H.CodColectivo,
	 -- v4.41 Release 1 - MAIPU CHC2528 REQ 16475 HEC_PRESCRIPCION DE DIETAS Y CONTROL DE INGESTA - FIN
	 Parametros..DatosCamas CC,
	 Parametros..CodigoPlantas CP,
	 Ingresos..AlimentacionGeneral AG,
	 Ingresos..Nutricion N
	 -- v4.41 Release 1 - MAIPU CHC2528 REQ 16475 HEC_PRESCRIPCION DE DIETAS Y CONTROL DE INGESTA - INI
	 LEFT JOIN Ingresos..NutricionValidada NV ON NV.CodPaciente = N.CodPaciente AND NV.CodEpisodio = N.CodEpisodio AND CONVERT(varchar,NV.FCreacion,20) = CONVERT(varchar,N.FCreacion,20)AND NV.CodDieta = N.CodDieta AND NV.FechaDieta = @FechaNutriOral AND NV.Eliminado = 0,
	 -- v4.41 Release 1 - MAIPU CHC2528 REQ 16475 HEC_PRESCRIPCION DE DIETAS Y CONTROL DE INGESTA - FIN
	 Parametros..Nutricion PN

where P.CodPaciente = H.CodPaciente AND
	  H.CodEpisodio = AG.CodEpisodio AND
	  H.NumCama = CC.NumCama AND
	  CC.CodPlanta = CP.CodPla AND
	  H.NumCama <> ' ' AND
	  H.FechaSalida IS NULL AND
	  P.CodPaciente = AG.CodPaciente AND
	  AG.CodPaciente = N.CodPaciente AND
	  AG.CodEpisodio = N.CodEpisodio AND
	  AG.FCreacion = N.FCreacion AND
	  AG.TipoDieta = N.TipoDieta AND
	  N.CodDieta = PN.CodDieta AND
	  AG.ParenteralEnteralOral = @spvar_Oral AND
	  --(AG.FFin > GETDATE() OR AG.FFin IS NULL) AND
	  @FechaNutriOral BETWEEN CONVERT(char(10),AG.FInicio,101) AND CONVERT(char(10),ISNULL(AG.FFin,@FechaNutriOral),101) AND
	  AG.FEliminacion IS NULL AND
	 (H.CentroIngreso = @spvar_codCentro OR H.CentroIngreso IS NULL) AND
	 (CC.CodCent = ISNULL(H.CentroIngreso,@spvar_codCentro))
	  
insert into @tabdietas
select AG.TipoDieta
	  ,Paciente = (rtrim(ltrim(P.PacNombre)) + ' ' + rtrim(ltrim(P.PacApell1)) + ' ' + rtrim(ltrim(P.PacApell2)))
	  ,H.NumCama Cama
	  ,CP.DescPla
	  ,AG.ParenteralEnteralOral
	  ,DescDieta = 'Absoluto'
	  ,AG.FInicio
	  ,AG.FFin
	  ,AG.CodHistoria
	  ,P.CodPaciente
	  ,AG.Observaciones
	  -- v4.41 Release 1 - MAIPU CHC2528 REQ 16475 HEC_PRESCRIPCION DE DIETAS Y CONTROL DE INGESTA - INI
	  ,NULL
	  ,0
	  ,0
	  ,0
	  ,NULL
	  ,H.CodEpisodio
	  ,NULL
	  ,NULL
	  ,NULL
	  -- v4.41 Release 1 - MAIPU CHC2528 REQ 16475 HEC_PRESCRIPCION DE DIETAS Y CONTROL DE INGESTA - FIN
			
from Hclinica..Pacientes P,
	 Ingresos..EpisodioHospitalizacion H, 
	 Parametros..DatosCamas CC, 
	 Parametros..CodigoPlantas CP,
	 Ingresos..AlimentacionGeneral AG, 
	 Ingresos..DietaAbsoluta DA

where P.CodPaciente = H.CodPaciente AND
	  H.CodEpisodio = AG.CodEpisodio AND
	  H.NumCama = CC.NumCama AND
	  CC.CodPlanta = CP.CodPla AND
	  H.NumCama <> ' ' AND
	  H.FechaSalida IS NULL AND
	  P.CodPaciente = AG.CodPaciente AND
	  AG.CodPaciente = DA.CodPaciente AND
	  AG.CodEpisodio = DA.CodEpisodio AND
	  AG.FCreacion = DA.FCreacion AND
	  AG.TipoDieta = DA.TipoDieta AND
	  AG.ParenteralEnteralOral = @spvar_Ayuno AND
	 (AG.FFin > GETDATE() OR AG.FFin IS NULL) AND
	  AG.FEliminacion IS NULL AND
	 (H.CentroIngreso = @spvar_codCentro OR H.CentroIngreso IS NULL) AND
	 (CC.CodCent = ISNULL(H.CentroIngreso,@spvar_codCentro))

insert into @tabdietas
select AG.TipoDieta
      ,Paciente = (rtrim(ltrim(P.PacNombre)) + ' ' + rtrim(ltrim(P.PacApell1)) + ' ' + rtrim(ltrim(P.PacApell2)))
	  ,H.NumCama Cama
	  ,CP.DescPla
	  ,AG.ParenteralEnteralOral
	  ,IP.DescDieta
	  ,AG.FInicio
	  ,AG.FFin
	  ,AG.CodHistoria
	  ,P.CodPaciente
	  ,AG.Observaciones
	  -- v4.41 Release 1 - MAIPU CHC2528 REQ 16475 HEC_PRESCRIPCION DE DIETAS Y CONTROL DE INGESTA - INI
	  ,NULL
	  ,0
	  ,0
	  ,0
	  ,NULL
	  ,H.CodEpisodio
	  ,NULL
	  ,NULL
	  ,NULL
	  -- v4.41 Release 1 - MAIPU CHC2528 REQ 16475 HEC_PRESCRIPCION DE DIETAS Y CONTROL DE INGESTA - FIN
		
from Hclinica..Pacientes P,
	 Ingresos..EpisodioHospitalizacion H, 
	 Parametros..DatosCamas CC, 
	 Parametros..CodigoPlantas CP,
	 Ingresos..AlimentacionGeneral AG, 
	 Ingresos..ParenteralIndiv IP

where P.CodPaciente = H.CodPaciente AND
	  H.CodEpisodio = AG.CodEpisodio AND
	  H.NumCama = CC.NumCama AND
	  CC.CodPlanta = CP.CodPla AND
	  H.NumCama <> ' ' AND
	  H.FechaSalida IS NULL AND
	  P.CodPaciente = AG.CodPaciente AND
	  AG.TipoDieta = IP.TipoDieta AND
	  AG.ParenteralEnteralOral = @spvar_Parenteral AND
	 (AG.FFin > GETDATE() OR AG.FFin IS NULL) AND
	  AG.FEliminacion IS NULL AND
	 (H.CentroIngreso = @spvar_codCentro OR H.CentroIngreso IS NULL) AND
	 (CC.CodCent = ISNULL(H.CentroIngreso,@spvar_codCentro))

insert into @tabdietas
select AG.TipoDieta
	  ,Paciente = (rtrim(ltrim(P.PacNombre)) + ' ' + rtrim(ltrim(P.PacApell1)) + ' ' + rtrim(ltrim(P.PacApell2)))
	  ,H.NumCama Cama
	  ,CP.DescPla
	  ,AG.ParenteralEnteralOral
	  ,IP.DescDieta
	  ,AG.FInicio
	  ,AG.FFin
	  ,AG.CodHistoria
	  ,P.CodPaciente
	  ,AG.Observaciones
	  -- v4.41 Release 1 - MAIPU CHC2528 REQ 16475 HEC_PRESCRIPCION DE DIETAS Y CONTROL DE INGESTA - INI
	  ,NULL
	  ,0
	  ,0
	  ,0
	  ,NULL
	  ,H.CodEpisodio
	  ,NULL
	  ,NULL
	  ,NULL
	  -- v4.41 Release 1 - MAIPU CHC2528 REQ 16475 HEC_PRESCRIPCION DE DIETAS Y CONTROL DE INGESTA - FIN
		
from Hclinica..Pacientes P,
	 Ingresos..EpisodioHospitalizacion H, 
	 Parametros..DatosCamas CC, 
	 Parametros..CodigoPlantas CP,
	 Ingresos..AlimentacionGeneral AG, 
	 Ingresos..ParenteralIndiv IP

where P.CodPaciente = H.CodPaciente AND
	  H.CodEpisodio = AG.CodEpisodio AND
	  H.NumCama = CC.NumCama AND
	  CC.CodPlanta = CP.CodPla AND
	  H.NumCama <> ' ' AND
	  H.FechaSalida IS NULL AND
	  P.CodPaciente = AG.CodPaciente AND
	  AG.TipoDieta = IP.TipoDieta AND
	  AG.ParenteralEnteralOral = @spvar_Enteral AND
	 (AG.FFin > GETDATE() OR AG.FFin IS NULL) AND
	  AG.FEliminacion IS NULL AND
	 (H.CentroIngreso = @spvar_codCentro OR H.CentroIngreso IS NULL) AND
	 (CC.CodCent = ISNULL(H.CentroIngreso,@spvar_codCentro))

insert into @tabdietas
select AG.TipoDieta
	  ,Paciente = (rtrim(ltrim(P.PacNombre)) + ' ' + rtrim(ltrim(P.PacApell1)) + ' ' + rtrim(ltrim(P.PacApell2)))
	  ,H.NumCama Cama
	  ,CP.DescPla
	  ,AG.ParenteralEnteralOral
	  ,PP.DescDieta
	  ,AG.FInicio
	  ,AG.FFin
	  ,AG.CodHistoria
	  ,P.CodPaciente
	  ,AG.Observaciones
	  -- v4.41 Release 1 - MAIPU CHC2528 REQ 16475 HEC_PRESCRIPCION DE DIETAS Y CONTROL DE INGESTA - INI
	  ,NULL
	  ,0
	  ,0
	  ,0
	  ,NULL
	  ,H.CodEpisodio
	  ,NULL
	  ,NULL
	  ,NULL
	  -- v4.41 Release 1 - MAIPU CHC2528 REQ 16475 HEC_PRESCRIPCION DE DIETAS Y CONTROL DE INGESTA - FIN
	
from Hclinica..Pacientes P,
	 Ingresos..EpisodioHospitalizacion H, 
	 Parametros..DatosCamas CC, 
	 Parametros..CodigoPlantas CP,
	 Ingresos..AlimentacionGeneral AG, 
	 Parametros..Parenteral PP

where P.CodPaciente = H.CodPaciente AND
	  H.CodEpisodio = AG.CodEpisodio AND
	  H.NumCama = CC.NumCama AND
	  CC.CodPlanta = CP.CodPla AND
	  H.NumCama <> ' ' AND
	  H.FechaSalida IS NULL AND
	  P.CodPaciente = AG.CodPaciente AND
	  AG.TipoDieta = PP.TipoDieta AND
	  AG.ParenteralEnteralOral = @spvar_Parenteral AND
	 (AG.FFin > GETDATE() OR AG.FFin IS NULL) AND
	  AG.FEliminacion IS NULL AND
	 (H.CentroIngreso = @spvar_codCentro OR H.CentroIngreso IS NULL) AND
	 (CC.CodCent = ISNULL(H.CentroIngreso,@spvar_codCentro))

insert into @tabdietas
select AG.TipoDieta
	  ,Paciente = (rtrim(ltrim(P.PacNombre)) + ' ' + rtrim(ltrim(P.PacApell1)) + ' ' + rtrim(ltrim(P.PacApell2)))
	  ,H.NumCama Cama
	  ,CP.DescPla
	  ,AG.ParenteralEnteralOral
	  ,PP.DescDieta
	  ,AG.FInicio
	  ,AG.FFin
	  ,AG.CodHistoria
	  ,P.CodPaciente
	  ,AG.Observaciones
	  -- v4.41 Release 1 - MAIPU CHC2528 REQ 16475 HEC_PRESCRIPCION DE DIETAS Y CONTROL DE INGESTA - INI
	  ,NULL
	  ,0
	  ,0
	  ,0
	  ,NULL
	  ,H.CodEpisodio
	  ,NULL
	  ,NULL
	  ,NULL
	  -- v4.41 Release 1 - MAIPU CHC2528 REQ 16475 HEC_PRESCRIPCION DE DIETAS Y CONTROL DE INGESTA - FIN

from Hclinica..Pacientes P,
	 Ingresos..EpisodioHospitalizacion H, 
	 Parametros..DatosCamas CC, 
	 Parametros..CodigoPlantas CP,
	 Ingresos..AlimentacionGeneral AG, 
	 Parametros..Parenteral PP

where P.CodPaciente = H.CodPaciente AND
	  H.CodEpisodio = AG.CodEpisodio AND
	  H.NumCama = CC.NumCama AND
	  CC.CodPlanta = CP.CodPla AND
	  H.NumCama <> ' ' AND
	  H.FechaSalida IS NULL AND
	  P.CodPaciente = AG.CodPaciente AND
	  AG.TipoDieta = PP.TipoDieta AND
	  AG.ParenteralEnteralOral = @spvar_Enteral AND
	 (AG.FFin > GETDATE() OR AG.FFin IS NULL) AND
	  AG.FEliminacion IS NULL AND
	 (H.CentroIngreso = @spvar_codCentro OR H.CentroIngreso IS NULL) AND
	 (CC.CodCent = ISNULL(H.CentroIngreso,@spvar_codCentro))

--Pediátrica
insert into @tabdietas
select AG.TipoDieta
	  ,Paciente = (rtrim(ltrim(P.PacNombre)) + ' ' + rtrim(ltrim(P.PacApell1)) + ' ' + rtrim(ltrim(P.PacApell2)))
	  ,H.NumCama Cama
	  ,CP.DescPla
	  ,AG.ParenteralEnteralOral
	  ,LP.Descripcion
	  ,AG.FInicio
	  ,AG.FFin
	  ,AG.CodHistoria
	  ,P.CodPaciente
	  ,AG.Observaciones
	  -- v4.41 Release 1 - MAIPU CHC2528 REQ 16475 HEC_PRESCRIPCION DE DIETAS Y CONTROL DE INGESTA - INI
	  ,NULL
	  ,0
	  ,0
	  ,0
	  ,NULL
	  ,H.CodEpisodio
	  ,NULL
	  ,NULL
	  ,NULL
	  -- v4.41 Release 1 - MAIPU CHC2528 REQ 16475 HEC_PRESCRIPCION DE DIETAS Y CONTROL DE INGESTA - FIN

from Hclinica..Pacientes P,
	 Ingresos..EpisodioHospitalizacion H, 
	 Parametros..DatosCamas CC, 
	 Parametros..CodigoPlantas CP,
	 Ingresos..AlimentacionGeneral AG, 
	 Ingresos..DietaPediatrica DP, 
	 Parametros..LechePediatria LP

where P.CodPaciente = H.CodPaciente AND
	  H.CodEpisodio = AG.CodEpisodio AND
	  H.NumCama = CC.NumCama AND
	  CC.CodPlanta = CP.CodPla AND
	  H.NumCama <> ' ' AND
	  H.FechaSalida IS NULL AND
	  P.CodPaciente = AG.CodPaciente AND
	  AG.CodPaciente = DP.CodPaciente AND
	  AG.CodEpisodio = DP.CodEpisodio AND
	  AG.FCreacion = DP.FCreacion AND
	  AG.TipoDieta = DP.TipoDieta AND
	  DP.TipoLeche = LP.Id AND
	  AG.ParenteralEnteralOral = @spvar_Pediatrica AND
	 (AG.FFin > GETDATE() OR AG.FFin IS NULL) AND
	  AG.FEliminacion IS NULL AND
	 (H.CentroIngreso = @spvar_codCentro OR H.CentroIngreso IS NULL) AND
	 (CC.CodCent = ISNULL(H.CentroIngreso,@spvar_codCentro))
/* FIN PACIENTES HOSPITALIZADOS ***************************************************/

/* PACIENTES URGENCIAS ************************************************************/
insert into @tabdietas
select AG.TipoDieta
	  ,Paciente = (rtrim(ltrim(P.PacNombre)) + ' ' + rtrim(ltrim(P.PacApell1)) + ' ' + rtrim(ltrim(P.PacApell2)))
	  ,case ISNULL(U.Localizacion,0)
			when 2 then Parametros.dbo.fnParSDescripcionCama(C.CodCama)
			when 3 then Parametros.dbo.fnParSDescripcionCamaIngresosCorto(CI.CodCama)
			when 4 then Parametros.dbo.fnParSDescripcionCama(C.CodCama)
			when 6 then Parametros.dbo.fnParSDescripcionCama(C.CodCama)
			else '' end as Cama
	  ,'URGENCIAS'
	  ,AG.ParenteralEnteralOral
	  ,PN.DescDieta
	  ,AG.FInicio
	  ,AG.FFin
	  ,AG.CodHistoria
	  ,P.CodPaciente
	  ,AG.Observaciones
	  -- v4.41 Release 1 - MAIPU CHC2528 REQ 16475 HEC_PRESCRIPCION DE DIETAS Y CONTROL DE INGESTA - INI
	  ,MS.Entidad
	  ,ISNULL(NV.BalanceHidrico,0) as 'BalanceHidrico'
	  ,ISNULL(NV.BalanceCalProte,0) as 'BalanceCalProte'
	  ,ISNULL(NV.IdNutricionValidada,0) as 'IdNutricionValidada'
	  ,N.IdTipoPaciente
	  ,N.CodEpisodio
	  ,N.FCreacion
	  ,N.CodDieta
	  ,NV.FechaDieta
	  -- v4.41 Release 1 - MAIPU CHC2528 REQ 16475 HEC_PRESCRIPCION DE DIETAS Y CONTROL DE INGESTA - FIN

from Hclinica..Pacientes P,
	 Ingresos..EpisodioUrgencias U
	 LEFT OUTER JOIN Parametros..CamasBoxesUrg C with (NOLOCK) ON U.CodPaciente = C.CodPaciente AND U.CodEpisodio = C.CodEpisodio
	 LEFT OUTER JOIN Parametros..CamasIngUrgencia CI with (NOLOCK) ON U.CodPaciente = CI.CodPaciente AND U.CodEpisodio = CI.CodEpisodio
	 -- v4.41 Release 1 - MAIPU CHC2528 REQ 16475 HEC_PRESCRIPCION DE DIETAS Y CONTROL DE INGESTA - INI
	 LEFT JOIN Parametros..MutuasSalud MS ON MS.Codigo = U.CodColectivo,
	 -- v4.41 Release 1 - MAIPU CHC2528 REQ 16475 HEC_PRESCRIPCION DE DIETAS Y CONTROL DE INGESTA - FIN
	 Ingresos..AlimentacionGeneral AG,
	 Ingresos..Nutricion N
	 -- v4.41 Release 1 - MAIPU CHC2528 REQ 16475 HEC_PRESCRIPCION DE DIETAS Y CONTROL DE INGESTA - INI
	 LEFT JOIN Ingresos..NutricionValidada NV ON NV.CodPaciente = N.CodPaciente AND NV.CodEpisodio = N.CodEpisodio AND CONVERT(varchar,NV.FCreacion,20) = CONVERT(varchar,N.FCreacion,20)AND NV.CodDieta = N.CodDieta AND NV.FechaDieta = @FechaNutriOral AND NV.Eliminado = 0,
	 -- v4.41 Release 1 - MAIPU CHC2528 REQ 16475 HEC_PRESCRIPCION DE DIETAS Y CONTROL DE INGESTA - FIN
	 Parametros..Nutricion PN

where P.CodPaciente = U.CodPaciente AND
	  U.CodEpisodio = AG.CodEpisodio AND
	  U.FechaSalida IS NULL AND
	  P.CodPaciente = AG.CodPaciente AND
	  AG.CodPaciente = N.CodPaciente AND
	  AG.CodEpisodio = N.CodEpisodio AND
	  AG.FCreacion = N.FCreacion AND
	  AG.TipoDieta = N.TipoDieta AND
	  N.CodDieta = PN.CodDieta AND
	  AG.ParenteralEnteralOral = @spvar_Oral AND
	  --(AG.FFin > GETDATE() OR AG.FFin IS NULL) AND
	  @FechaNutriOral BETWEEN CONVERT(char(10),AG.FInicio,101) AND CONVERT(char(10),ISNULL(AG.FFin,@FechaNutriOral),101) AND
	  AG.FEliminacion IS NULL AND
	 (U.CodigoCentUrg = @spvar_codCentro OR U.CodigoCentUrg IS NULL)
	
insert into @tabdietas
select AG.TipoDieta
	  ,Paciente = (rtrim(ltrim(P.PacNombre)) + ' ' + rtrim(ltrim(P.PacApell1)) + ' ' + rtrim(ltrim(P.PacApell2)))
	  ,case ISNULL(U.Localizacion,0)
			when 2 then Parametros.dbo.fnParSDescripcionCama(C.CodCama)
			when 3 then Parametros.dbo.fnParSDescripcionCamaIngresosCorto(CI.CodCama)
			when 4 then Parametros.dbo.fnParSDescripcionCama(C.CodCama)
			when 6 then Parametros.dbo.fnParSDescripcionCama(C.CodCama)
			else '' end as Cama
	  ,'URGENCIAS'
	  ,AG.ParenteralEnteralOral
	  ,DescDieta = 'Absoluto'
	  ,AG.FInicio
	  ,AG.FFin
	  ,AG.CodHistoria
	  ,P.CodPaciente
	  ,AG.Observaciones
	  -- v4.41 Release 1 - MAIPU CHC2528 REQ 16475 HEC_PRESCRIPCION DE DIETAS Y CONTROL DE INGESTA - INI
	  ,NULL
	  ,0
	  ,0
	  ,0
	  ,NULL
	  ,U.CodEpisodio
	  ,NULL
	  ,NULL
	  ,NULL
	  -- v4.41 Release 1 - MAIPU CHC2528 REQ 16475 HEC_PRESCRIPCION DE DIETAS Y CONTROL DE INGESTA - FIN

from Hclinica..Pacientes P,
	 Ingresos..EpisodioUrgencias U
	 LEFT OUTER JOIN Parametros..CamasBoxesUrg C with (NOLOCK) ON U.CodPaciente = C.CodPaciente AND U.CodEpisodio = C.CodEpisodio
	 LEFT OUTER JOIN Parametros..CamasIngUrgencia CI with (NOLOCK) ON U.CodPaciente = CI.CodPaciente AND U.CodEpisodio = CI.CodEpisodio, 
	 Ingresos..AlimentacionGeneral AG, 
	 Ingresos..DietaAbsoluta DA

where P.CodPaciente = U.CodPaciente AND
	  U.CodEpisodio = AG.CodEpisodio AND
	  U.FechaSalida IS NULL AND
	  P.CodPaciente = AG.CodPaciente AND
	  AG.CodPaciente = DA.CodPaciente AND
	  AG.CodEpisodio = DA.CodEpisodio AND
	  AG.FCreacion = DA.FCreacion AND
	  AG.TipoDieta = DA.TipoDieta AND
	  AG.ParenteralEnteralOral = @spvar_Ayuno AND
	 (AG.FFin > GETDATE() OR AG.FFin IS NULL) AND
	  AG.FEliminacion IS NULL AND
	 (U.CodigoCentUrg = @spvar_codCentro OR U.CodigoCentUrg IS NULL)
	
insert into @tabdietas
select AG.TipoDieta
	  ,Paciente = (rtrim(ltrim(P.PacNombre)) + ' ' + rtrim(ltrim(P.PacApell1)) + ' ' + rtrim(ltrim(P.PacApell2)))
	  ,case ISNULL(U.Localizacion,0)
			when 2 then Parametros.dbo.fnParSDescripcionCama(C.CodCama)
			when 3 then Parametros.dbo.fnParSDescripcionCamaIngresosCorto(CI.CodCama)
			when 4 then Parametros.dbo.fnParSDescripcionCama(C.CodCama)
			when 6 then Parametros.dbo.fnParSDescripcionCama(C.CodCama)
			else '' end as Cama
	  ,'URGENCIAS'
	  ,AG.ParenteralEnteralOral
	  ,IP.DescDieta
	  ,AG.FInicio
	  ,AG.FFin
	  ,AG.CodHistoria
	  ,P.CodPaciente
	  ,AG.Observaciones
	  -- v4.41 Release 1 - MAIPU CHC2528 REQ 16475 HEC_PRESCRIPCION DE DIETAS Y CONTROL DE INGESTA - INI
	  ,NULL
	  ,0
	  ,0
	  ,0
	  ,NULL
	  ,U.CodEpisodio
	  ,NULL
	  ,NULL
	  ,NULL
	  -- v4.41 Release 1 - MAIPU CHC2528 REQ 16475 HEC_PRESCRIPCION DE DIETAS Y CONTROL DE INGESTA - FIN

from Hclinica..Pacientes P,
	 Ingresos..EpisodioUrgencias U
	 LEFT OUTER JOIN Parametros..CamasBoxesUrg C with (NOLOCK) ON U.CodPaciente = C.CodPaciente AND U.CodEpisodio = C.CodEpisodio
	 LEFT OUTER JOIN Parametros..CamasIngUrgencia CI with (NOLOCK) ON U.CodPaciente = CI.CodPaciente AND U.CodEpisodio = CI.CodEpisodio, 
	 Ingresos..AlimentacionGeneral AG, 
	 Ingresos..ParenteralIndiv IP

where P.CodPaciente = U.CodPaciente AND
	  U.CodEpisodio = AG.CodEpisodio AND
	  U.FechaSalida IS NULL AND
	  P.CodPaciente = AG.CodPaciente AND
	  AG.TipoDieta = IP.TipoDieta AND
	  AG.ParenteralEnteralOral = @spvar_Parenteral AND
	 (AG.FFin > GETDATE() OR AG.FFin IS NULL) AND
	  AG.FEliminacion IS NULL AND
	 (U.CodigoCentUrg = @spvar_codCentro OR U.CodigoCentUrg IS NULL)
	
insert into @tabdietas
select AG.TipoDieta
	  ,Paciente = (rtrim(ltrim(P.PacNombre)) + ' ' + rtrim(ltrim(P.PacApell1)) + ' ' + rtrim(ltrim(P.PacApell2)))
	  ,case ISNULL(U.Localizacion,0)
			when 2 then Parametros.dbo.fnParSDescripcionCama(C.CodCama)
			when 3 then Parametros.dbo.fnParSDescripcionCamaIngresosCorto(CI.CodCama)
			when 4 then Parametros.dbo.fnParSDescripcionCama(C.CodCama)
			when 6 then Parametros.dbo.fnParSDescripcionCama(C.CodCama)
			else '' end as Cama
	  ,'URGENCIAS'
	  ,AG.ParenteralEnteralOral
	  ,IP.DescDieta
	  ,AG.FInicio
	  ,AG.FFin
	  ,AG.CodHistoria
	  ,P.CodPaciente
	  ,AG.Observaciones
	  -- v4.41 Release 1 - MAIPU CHC2528 REQ 16475 HEC_PRESCRIPCION DE DIETAS Y CONTROL DE INGESTA - INI
	  ,NULL
	  ,0
	  ,0
	  ,0
	  ,NULL
	  ,U.CodEpisodio
	  ,NULL
	  ,NULL
	  ,NULL
	  -- v4.41 Release 1 - MAIPU CHC2528 REQ 16475 HEC_PRESCRIPCION DE DIETAS Y CONTROL DE INGESTA - FIN

from Hclinica..Pacientes P,
	 Ingresos..EpisodioUrgencias U
	 LEFT OUTER JOIN Parametros..CamasBoxesUrg C with (NOLOCK) ON U.CodPaciente = C.CodPaciente AND U.CodEpisodio = C.CodEpisodio
	 LEFT OUTER JOIN Parametros..CamasIngUrgencia CI with (NOLOCK) ON U.CodPaciente = CI.CodPaciente AND U.CodEpisodio = CI.CodEpisodio, 
	 Ingresos..AlimentacionGeneral AG, 
	 Ingresos..ParenteralIndiv IP

where P.CodPaciente = U.CodPaciente AND
	  U.CodEpisodio = AG.CodEpisodio AND
	  U.FechaSalida IS NULL AND
	  P.CodPaciente = AG.CodPaciente AND
	  AG.TipoDieta = IP.TipoDieta AND
	  AG.ParenteralEnteralOral = @spvar_Enteral AND
	 (AG.FFin > GETDATE() OR AG.FFin IS NULL) AND
	  AG.FEliminacion IS NULL AND
	 (U.CodigoCentUrg = @spvar_codCentro OR U.CodigoCentUrg IS NULL)
	
insert into @tabdietas
select AG.TipoDieta
	  ,Paciente = (rtrim(ltrim(P.PacNombre)) + ' ' + rtrim(ltrim(P.PacApell1)) + ' ' + rtrim(ltrim(P.PacApell2)))
	  ,case ISNULL(U.Localizacion,0)
			when 2 then Parametros.dbo.fnParSDescripcionCama(C.CodCama)
			when 3 then Parametros.dbo.fnParSDescripcionCamaIngresosCorto(CI.CodCama)
			when 4 then Parametros.dbo.fnParSDescripcionCama(C.CodCama)
			when 6 then Parametros.dbo.fnParSDescripcionCama(C.CodCama)
			else '' end as Cama
	  ,'URGENCIAS'
	  ,AG.ParenteralEnteralOral
	  ,PP.DescDieta
	  ,AG.FInicio
	  ,AG.FFin
	  ,AG.CodHistoria
	  ,P.CodPaciente
	  ,AG.Observaciones
	  -- v4.41 Release 1 - MAIPU CHC2528 REQ 16475 HEC_PRESCRIPCION DE DIETAS Y CONTROL DE INGESTA - INI
	  ,NULL
	  ,0
	  ,0
	  ,0
	  ,NULL
	  ,U.CodEpisodio
	  ,NULL
	  ,NULL
	  ,NULL
	  -- v4.41 Release 1 - MAIPU CHC2528 REQ 16475 HEC_PRESCRIPCION DE DIETAS Y CONTROL DE INGESTA - FIN

from Hclinica..Pacientes P,
	 Ingresos..EpisodioUrgencias U
	 LEFT OUTER JOIN Parametros..CamasBoxesUrg C with (NOLOCK) ON U.CodPaciente = C.CodPaciente AND U.CodEpisodio = C.CodEpisodio
	 LEFT OUTER JOIN Parametros..CamasIngUrgencia CI with (NOLOCK) ON U.CodPaciente = CI.CodPaciente AND U.CodEpisodio = CI.CodEpisodio, 
	 Ingresos..AlimentacionGeneral AG, 
	 Parametros..Parenteral PP

where P.CodPaciente = U.CodPaciente AND
	  U.CodEpisodio = AG.CodEpisodio AND
	  U.FechaSalida IS NULL AND
	  P.CodPaciente = AG.CodPaciente AND
	  AG.TipoDieta = PP.TipoDieta AND
	  AG.ParenteralEnteralOral = @spvar_Parenteral AND
	 (AG.FFin > GETDATE() OR AG.FFin IS NULL) AND
	  AG.FEliminacion IS NULL AND
	 (U.CodigoCentUrg = @spvar_codCentro OR U.CodigoCentUrg IS NULL)
	
insert into @tabdietas
select AG.TipoDieta
	  ,Paciente = (rtrim(ltrim(P.PacNombre)) + ' ' + rtrim(ltrim(P.PacApell1)) + ' ' + rtrim(ltrim(P.PacApell2)))
	  ,case ISNULL(U.Localizacion,0)
			when 2 then Parametros.dbo.fnParSDescripcionCama(C.CodCama)
			when 3 then Parametros.dbo.fnParSDescripcionCamaIngresosCorto(CI.CodCama)
			when 4 then Parametros.dbo.fnParSDescripcionCama(C.CodCama)
			when 6 then Parametros.dbo.fnParSDescripcionCama(C.CodCama)
			else ''	end as Cama
	  ,'URGENCIAS'
	  ,AG.ParenteralEnteralOral
	  ,PP.DescDieta
	  ,AG.FInicio
	  ,AG.FFin
	  ,AG.CodHistoria
	  ,P.CodPaciente
	  ,AG.Observaciones
	  -- v4.41 Release 1 - MAIPU CHC2528 REQ 16475 HEC_PRESCRIPCION DE DIETAS Y CONTROL DE INGESTA - INI
	  ,NULL
	  ,0
	  ,0
	  ,0
	  ,NULL
	  ,U.CodEpisodio
	  ,NULL
	  ,NULL
	  ,NULL
	  -- v4.41 Release 1 - MAIPU CHC2528 REQ 16475 HEC_PRESCRIPCION DE DIETAS Y CONTROL DE INGESTA - FIN

from Hclinica..Pacientes P,
	 Ingresos..EpisodioUrgencias U
	 LEFT OUTER JOIN Parametros..CamasBoxesUrg C with (NOLOCK) ON U.CodPaciente = C.CodPaciente AND U.CodEpisodio = C.CodEpisodio
	 LEFT OUTER JOIN Parametros..CamasIngUrgencia CI with (NOLOCK) ON U.CodPaciente = CI.CodPaciente AND U.CodEpisodio = CI.CodEpisodio, 
	 Ingresos..AlimentacionGeneral AG, 
	 Parametros..Parenteral PP

where P.CodPaciente = U.CodPaciente AND
	  U.CodEpisodio = AG.CodEpisodio AND
	  U.FechaSalida IS NULL AND
	  P.CodPaciente = AG.CodPaciente AND
	  AG.TipoDieta = PP.TipoDieta AND
	  AG.ParenteralEnteralOral = @spvar_Enteral AND
	 (AG.FFin > GETDATE() OR AG.FFin IS NULL) AND
	  AG.FEliminacion IS NULL AND
	 (U.CodigoCentUrg = @spvar_codCentro OR U.CodigoCentUrg IS NULL)

--Pediátrica
insert into @tabdietas
select AG.TipoDieta
	  ,Paciente = (rtrim(ltrim(P.PacNombre)) + ' ' + rtrim(ltrim(P.PacApell1)) + ' ' + rtrim(ltrim(P.PacApell2)))
	  ,case ISNULL(U.Localizacion,0)
			when 2 then Parametros.dbo.fnParSDescripcionCama(C.CodCama)
			when 3 then Parametros.dbo.fnParSDescripcionCamaIngresosCorto(CI.CodCama)
			when 4 then Parametros.dbo.fnParSDescripcionCama(C.CodCama)
			when 6 then Parametros.dbo.fnParSDescripcionCama(C.CodCama)
			else '' end as Cama
	  ,'URGENCIAS'
	  ,AG.ParenteralEnteralOral
	  ,LP.Descripcion
	  ,AG.FInicio
	  ,AG.FFin
	  ,AG.CodHistoria
	  ,P.CodPaciente
	  ,AG.Observaciones
	  -- v4.41 Release 1 - MAIPU CHC2528 REQ 16475 HEC_PRESCRIPCION DE DIETAS Y CONTROL DE INGESTA - INI
	  ,NULL
	  ,0
	  ,0
	  ,0
	  ,NULL
	  ,U.CodEpisodio
	  ,NULL
	  ,NULL
	  ,NULL
	  -- v4.41 Release 1 - MAIPU CHC2528 REQ 16475 HEC_PRESCRIPCION DE DIETAS Y CONTROL DE INGESTA - FIN

from Hclinica..Pacientes P,
	 Ingresos..EpisodioUrgencias U
	 LEFT OUTER JOIN Parametros..CamasBoxesUrg C with (NOLOCK) ON U.CodPaciente = C.CodPaciente AND U.CodEpisodio = C.CodEpisodio
	 LEFT OUTER JOIN Parametros..CamasIngUrgencia CI with (NOLOCK) ON U.CodPaciente = CI.CodPaciente AND U.CodEpisodio = CI.CodEpisodio, 
	 Ingresos..AlimentacionGeneral AG, 
	 Ingresos..DietaPediatrica DP, 
	 Parametros..LechePediatria LP

where P.CodPaciente = U.CodPaciente AND
	  U.CodEpisodio = AG.CodEpisodio AND
	  U.FechaSalida IS NULL AND
	  P.CodPaciente = AG.CodPaciente AND
	  AG.CodPaciente = DP.CodPaciente AND
	  AG.CodEpisodio = DP.CodEpisodio AND
	  AG.FCreacion = DP.FCreacion AND
	  AG.TipoDieta = DP.TipoDieta AND
	  DP.TipoLeche = LP.Id AND
	  AG.ParenteralEnteralOral = @spvar_Pediatrica AND
	 (AG.FFin > GETDATE() OR AG.FFin IS NULL) AND
	  AG.FEliminacion IS NULL AND
	 (U.CodigoCentUrg = @spvar_codCentro OR U.CodigoCentUrg IS NULL)
/* FIN PACIENTES URGENCIAS ********************************************************/

/* PACIENTES CEX (AMBULATORIO) ****************************************************/
insert into @tabdietas
select distinct AG.TipoDieta
	  ,Paciente = (rtrim(ltrim(P.PacNombre)) + ' ' + rtrim(ltrim(P.PacApell1)) + ' ' + rtrim(ltrim(P.PacApell2)))
	  ,PHD.DescPuesto
	  ,PHD.DescSala
	  ,AG.ParenteralEnteralOral
	  ,PN.DescDieta
	  ,AG.FInicio
	  ,AG.FFin
	  ,AG.CodHistoria
	  ,P.CodPaciente
	  ,AG.Observaciones
	  ,MS.Entidad
	  ,ISNULL(NV.BalanceHidrico,0) as 'BalanceHidrico'
	  ,ISNULL(NV.BalanceCalProte,0) as 'BalanceCalProte'
	  ,ISNULL(NV.IdNutricionValidada,0) as 'IdNutricionValidada'
	  ,N.IdTipoPaciente
	  ,N.CodEpisodio
	  ,N.FCreacion
	  ,N.CodDieta
	  ,NV.FechaDieta

from Hclinica..Pacientes P,
	 Consultas..EpisodioConsultas EC
	 INNER JOIN HClinica..CitasHospitalDia CHD ON CHD.CodPaciente = EC.CodPaciente AND CHD.CodEpisodio = EC.CodEpisodio
	 INNER JOIN Parametros..PuestosHospitalDia PHD ON PHD.CodPuesto = CHD.CodCama
	 LEFT JOIN Parametros..MutuasSalud MS ON MS.Codigo = EC.CodColectivo,
	 Ingresos..AlimentacionGeneral AG,
	 Ingresos..Nutricion N
	 LEFT JOIN Ingresos..NutricionValidada NV ON NV.CodPaciente = N.CodPaciente AND NV.CodEpisodio = N.CodEpisodio AND CONVERT(varchar,NV.FCreacion,20) = CONVERT(varchar,N.FCreacion,20)AND NV.CodDieta = N.CodDieta AND NV.FechaDieta = @FechaNutriOral AND NV.Eliminado = 0,
	 Parametros..Nutricion PN

where P.CodPaciente = EC.CodPaciente AND
	  EC.CodEpisodio = AG.CodEpisodio AND
	  EC.FechaCierre IS NULL AND
	  P.CodPaciente = AG.CodPaciente AND
	  AG.CodPaciente = N.CodPaciente AND
	  AG.CodEpisodio = N.CodEpisodio AND
	  AG.FCreacion = N.FCreacion AND
	  AG.TipoDieta = N.TipoDieta AND
	  N.CodDieta = PN.CodDieta AND
	  AG.ParenteralEnteralOral = @spvar_Oral AND
	  --(AG.FFin > GETDATE() OR AG.FFin IS NULL) AND
	  @FechaNutriOral BETWEEN CONVERT(char(10),AG.FInicio,101) AND CONVERT(char(10),ISNULL(AG.FFin,@FechaNutriOral),101) AND
	  CONVERT(datetime,CONVERT(char(10),CHD.FechaCita,101)) BETWEEN CONVERT(datetime,CONVERT(char(10),AG.FInicio,101)) AND CONVERT(datetime,CONVERT(char(10),AG.FFin,101)) AND
	  AG.FEliminacion IS NULL AND
	 (EC.CodCentroFinal = @spvar_codCentro OR EC.CodCentroFinal IS NULL)
 
insert into @tabdietas
select distinct AG.TipoDieta
	  ,Paciente = (rtrim(ltrim(P.PacNombre)) + ' ' + rtrim(ltrim(P.PacApell1)) + ' ' + rtrim(ltrim(P.PacApell2)))
	  ,PHD.DescPuesto
	  ,PHD.DescSala
	  ,AG.ParenteralEnteralOral
	  ,DescDieta = 'Absoluto'
	  ,AG.FInicio
	  ,AG.FFin
	  ,AG.CodHistoria
	  ,P.CodPaciente
	  ,AG.Observaciones
	  ,NULL
	  ,0
	  ,0
	  ,0
	  ,NULL
	  ,EC.CodEpisodio
	  ,NULL
	  ,NULL
	  ,NULL

from Hclinica..Pacientes P,
	 Consultas..EpisodioConsultas EC
	 INNER JOIN HClinica..CitasHospitalDia CHD ON CHD.CodPaciente = EC.CodPaciente AND CHD.CodEpisodio = EC.CodEpisodio
	 INNER JOIN Parametros..PuestosHospitalDia PHD ON PHD.CodPuesto = CHD.CodCama,
	 Ingresos..AlimentacionGeneral AG,
	 Ingresos..DietaAbsoluta DA

where P.CodPaciente = EC.CodPaciente AND
	  EC.CodEpisodio = AG.CodEpisodio AND
	  EC.FechaCierre IS NULL AND
	  P.CodPaciente = AG.CodPaciente AND
	  AG.CodPaciente = DA.CodPaciente AND
	  AG.CodEpisodio = DA.CodEpisodio AND
	  AG.FCreacion = DA.FCreacion AND
	  AG.TipoDieta = DA.TipoDieta AND
	  AG.ParenteralEnteralOral = @spvar_Ayuno AND
	 (AG.FFin > GETDATE() OR AG.FFin IS NULL) AND
	  CONVERT(datetime,CONVERT(char(10),CHD.FechaCita,101)) BETWEEN CONVERT(datetime,CONVERT(char(10),AG.FInicio,101)) AND CONVERT(datetime,CONVERT(char(10),AG.FFin,101)) AND
	  AG.FEliminacion IS NULL AND
	 (EC.CodCentroFinal = @spvar_codCentro OR EC.CodCentroFinal IS NULL)
	
insert into @tabdietas
select distinct AG.TipoDieta
	  ,Paciente = (rtrim(ltrim(P.PacNombre)) + ' ' + rtrim(ltrim(P.PacApell1)) + ' ' + rtrim(ltrim(P.PacApell2)))
	  ,PHD.DescPuesto
	  ,PHD.DescSala
	  ,AG.ParenteralEnteralOral
	  ,IP.DescDieta
	  ,AG.FInicio
	  ,AG.FFin
	  ,AG.CodHistoria
	  ,P.CodPaciente
	  ,AG.Observaciones
	  ,NULL
	  ,0
	  ,0
	  ,0
	  ,NULL
	  ,EC.CodEpisodio
	  ,NULL
	  ,NULL
	  ,NULL

from Hclinica..Pacientes P,
	 Consultas..EpisodioConsultas EC
	 INNER JOIN HClinica..CitasHospitalDia CHD ON CHD.CodPaciente = EC.CodPaciente AND CHD.CodEpisodio = EC.CodEpisodio
	 INNER JOIN Parametros..PuestosHospitalDia PHD ON PHD.CodPuesto = CHD.CodCama,
	 Ingresos..AlimentacionGeneral AG, 
	 Ingresos..ParenteralIndiv IP

where P.CodPaciente = EC.CodPaciente AND
	  EC.CodEpisodio = AG.CodEpisodio AND
	  EC.FechaCierre IS NULL AND
	  P.CodPaciente = AG.CodPaciente AND
	  AG.TipoDieta = IP.TipoDieta AND
	  AG.ParenteralEnteralOral = @spvar_Parenteral AND	  
	 (AG.FFin > GETDATE() OR AG.FFin IS NULL) AND
	  CONVERT(datetime,CONVERT(char(10),CHD.FechaCita,101)) BETWEEN CONVERT(datetime,CONVERT(char(10),AG.FInicio,101)) AND CONVERT(datetime,CONVERT(char(10),AG.FFin,101)) AND
	  AG.FEliminacion IS NULL AND
	 (EC.CodCentroFinal = @spvar_codCentro OR EC.CodCentroFinal IS NULL)
	
insert into @tabdietas
select distinct AG.TipoDieta
	  ,Paciente = (rtrim(ltrim(P.PacNombre)) + ' ' + rtrim(ltrim(P.PacApell1)) + ' ' + rtrim(ltrim(P.PacApell2)))
	  ,PHD.DescPuesto
	  ,PHD.DescSala
	  ,AG.ParenteralEnteralOral
	  ,IP.DescDieta
	  ,AG.FInicio
	  ,AG.FFin
	  ,AG.CodHistoria
	  ,P.CodPaciente
	  ,AG.Observaciones
	  ,NULL
	  ,0
	  ,0
	  ,0
	  ,NULL
	  ,EC.CodEpisodio
	  ,NULL
	  ,NULL
	  ,NULL

from Hclinica..Pacientes P,
	 Consultas..EpisodioConsultas EC
	 INNER JOIN HClinica..CitasHospitalDia CHD ON CHD.CodPaciente = EC.CodPaciente AND CHD.CodEpisodio = EC.CodEpisodio
	 INNER JOIN Parametros..PuestosHospitalDia PHD ON PHD.CodPuesto = CHD.CodCama,
	 Ingresos..AlimentacionGeneral AG, 
	 Ingresos..ParenteralIndiv IP

where P.CodPaciente = EC.CodPaciente AND
	  EC.CodEpisodio = AG.CodEpisodio AND
	  EC.FechaCierre IS NULL AND
	  P.CodPaciente = AG.CodPaciente AND
	  AG.TipoDieta = IP.TipoDieta AND
	  AG.ParenteralEnteralOral = @spvar_Enteral AND	  
	 (AG.FFin > GETDATE() OR AG.FFin IS NULL) AND
	  CONVERT(datetime,CONVERT(char(10),CHD.FechaCita,101)) BETWEEN CONVERT(datetime,CONVERT(char(10),AG.FInicio,101)) AND CONVERT(datetime,CONVERT(char(10),AG.FFin,101)) AND
	  AG.FEliminacion IS NULL AND
	 (EC.CodCentroFinal = @spvar_codCentro OR EC.CodCentroFinal IS NULL)
	
insert into @tabdietas
select distinct AG.TipoDieta
	  ,Paciente = (rtrim(ltrim(P.PacNombre)) + ' ' + rtrim(ltrim(P.PacApell1)) + ' ' + rtrim(ltrim(P.PacApell2)))
	  ,PHD.DescPuesto
	  ,PHD.DescSala
	  ,AG.ParenteralEnteralOral
	  ,PP.DescDieta
	  ,AG.FInicio
	  ,AG.FFin
	  ,AG.CodHistoria
	  ,P.CodPaciente
	  ,AG.Observaciones
	  ,NULL
	  ,0
	  ,0
	  ,0
	  ,NULL
	  ,EC.CodEpisodio
	  ,NULL
	  ,NULL
	  ,NULL

from Hclinica..Pacientes P,
	 Consultas..EpisodioConsultas EC
	 INNER JOIN HClinica..CitasHospitalDia CHD ON CHD.CodPaciente = EC.CodPaciente AND CHD.CodEpisodio = EC.CodEpisodio
	 INNER JOIN Parametros..PuestosHospitalDia PHD ON PHD.CodPuesto = CHD.CodCama,
	 Ingresos..AlimentacionGeneral AG, 
	 Parametros..Parenteral PP

where P.CodPaciente = EC.CodPaciente AND
	  EC.CodEpisodio = AG.CodEpisodio AND
	  EC.FechaCierre IS NULL AND
	  P.CodPaciente = AG.CodPaciente AND
	  AG.TipoDieta = PP.TipoDieta AND
	  AG.ParenteralEnteralOral = @spvar_Parenteral AND	  
	 (AG.FFin > GETDATE() OR AG.FFin IS NULL) AND
	  CONVERT(datetime,CONVERT(char(10),CHD.FechaCita,101)) BETWEEN CONVERT(datetime,CONVERT(char(10),AG.FInicio,101)) AND CONVERT(datetime,CONVERT(char(10),AG.FFin,101)) AND
	  AG.FEliminacion IS NULL AND
	 (EC.CodCentroFinal = @spvar_codCentro OR EC.CodCentroFinal IS NULL)
	
insert into @tabdietas
select distinct AG.TipoDieta
	  ,Paciente = (rtrim(ltrim(P.PacNombre)) + ' ' + rtrim(ltrim(P.PacApell1)) + ' ' + rtrim(ltrim(P.PacApell2)))
	  ,PHD.DescPuesto
	  ,PHD.DescSala
	  ,AG.ParenteralEnteralOral
	  ,PP.DescDieta
	  ,AG.FInicio
	  ,AG.FFin
	  ,AG.CodHistoria
	  ,P.CodPaciente
	  ,AG.Observaciones
	  ,NULL
	  ,0
	  ,0
	  ,0
	  ,NULL
	  ,EC.CodEpisodio
	  ,NULL
	  ,NULL
	  ,NULL

from Hclinica..Pacientes P,
	 Consultas..EpisodioConsultas EC
	 INNER JOIN HClinica..CitasHospitalDia CHD ON CHD.CodPaciente = EC.CodPaciente AND CHD.CodEpisodio = EC.CodEpisodio
	 INNER JOIN Parametros..PuestosHospitalDia PHD ON PHD.CodPuesto = CHD.CodCama,
	 Ingresos..AlimentacionGeneral AG, 
	 Parametros..Parenteral PP

where P.CodPaciente = EC.CodPaciente AND
	  EC.CodEpisodio = AG.CodEpisodio AND
	  EC.FechaCierre IS NULL AND
	  P.CodPaciente = AG.CodPaciente AND
	  AG.TipoDieta = PP.TipoDieta AND
	  AG.ParenteralEnteralOral = @spvar_Enteral AND	  
	 (AG.FFin > GETDATE() OR AG.FFin IS NULL) AND
	  CONVERT(datetime,CONVERT(char(10),CHD.FechaCita,101)) BETWEEN CONVERT(datetime,CONVERT(char(10),AG.FInicio,101)) AND CONVERT(datetime,CONVERT(char(10),AG.FFin,101)) AND
	  AG.FEliminacion IS NULL AND
	 (EC.CodCentroFinal = @spvar_codCentro OR EC.CodCentroFinal IS NULL)

--Pediátrica
insert into @tabdietas
select distinct AG.TipoDieta
	  ,Paciente = (rtrim(ltrim(P.PacNombre)) + ' ' + rtrim(ltrim(P.PacApell1)) + ' ' + rtrim(ltrim(P.PacApell2)))
	  ,PHD.DescPuesto
	  ,PHD.DescSala
	  ,AG.ParenteralEnteralOral
	  ,LP.Descripcion
	  ,AG.FInicio
	  ,AG.FFin
	  ,AG.CodHistoria
	  ,P.CodPaciente
	  ,AG.Observaciones
	  ,NULL
	  ,0
	  ,0
	  ,0
	  ,NULL
	  ,EC.CodEpisodio
	  ,NULL
	  ,NULL
	  ,NULL

from Hclinica..Pacientes P,
	 Consultas..EpisodioConsultas EC
	 INNER JOIN HClinica..CitasHospitalDia CHD ON CHD.CodPaciente = EC.CodPaciente AND CHD.CodEpisodio = EC.CodEpisodio
	 INNER JOIN Parametros..PuestosHospitalDia PHD ON PHD.CodPuesto = CHD.CodCama,
	 Ingresos..AlimentacionGeneral AG, 
	 Ingresos..DietaPediatrica DP, 
	 Parametros..LechePediatria LP

where P.CodPaciente = EC.CodPaciente AND
	  EC.CodEpisodio = AG.CodEpisodio AND
	  EC.FechaCierre IS NULL AND
	  P.CodPaciente = AG.CodPaciente AND
	  AG.CodPaciente = DP.CodPaciente AND
	  AG.CodEpisodio = DP.CodEpisodio AND
	  AG.FCreacion = DP.FCreacion AND
	  AG.TipoDieta = DP.TipoDieta AND
	  DP.TipoLeche = LP.Id AND
	  AG.ParenteralEnteralOral = @spvar_Pediatrica AND	  
	 (AG.FFin > GETDATE() OR AG.FFin IS NULL) AND
	  CONVERT(datetime,CONVERT(char(10),CHD.FechaCita,101)) BETWEEN CONVERT(datetime,CONVERT(char(10),AG.FInicio,101)) AND CONVERT(datetime,CONVERT(char(10),AG.FFin,101)) AND
	  AG.FEliminacion IS NULL AND
	 (EC.CodCentroFinal = @spvar_codCentro OR EC.CodCentroFinal IS NULL)
/* FIN PACIENTES CEX (AMBULATORIO) ************************************************/

SELECT TipoDieta
      ,Paciente
      ,Cama
      ,DescPla
      ,ParenteralEnteralOral
      ,DescDieta
      ,FInicio
      ,FFin
      ,CodHistoria
      ,CodPaciente
      ,Observaciones
      -- v4.41 Release 1 - MAIPU CHC2528 REQ 16475 HEC_PRESCRIPCION DE DIETAS Y CONTROL DE INGESTA - INI
      ,Entidad
      ,BalanceHidrico
      ,BalanceCalProte
      ,IdNutricionValidada
      ,IdTipoPaciente
      ,CodEpisodio
      ,FCreacion
      ,CodDieta
      ,FDieta
      -- v4.41 Release 1 - MAIPU CHC2528 REQ 16475 HEC_PRESCRIPCION DE DIETAS Y CONTROL DE INGESTA - FIN
FROM @TabDietas
ORDER BY TipoDieta,Paciente

GO

GO



--dbo.SpHClSBuscDietasExport.sql

USE [HClinica];
GO
IF EXISTS 
(
    SELECT * 
        FROM sys.procedures 
        WHERE [object_id] = OBJECT_ID('[dbo].[SpHClSBuscDietasExport]')
)
BEGIN
    DROP PROCEDURE [dbo].[SpHClSBuscDietasExport];
END
GO
    
/*
PROCEDIMIENTO : SpHClSBuscDietasExport
FUNCION       : 
DEVUELVE      : 
FECHA         : 22/11/2005
VERSION       :
AUTOR         : Patricia Clemente (AGENSYS)
CUADERNO CARGA : Dietas por planta
*********************************************************************************************
MODIFICACION  : (14/03/2007) MPS. Incluir condicion fecha fin nula
MODIFICACION  : (28/08/2009) Oscar Vilella. No devolvemos aquellas que han sido eliminadas
MODIFICACION  : (23/09/2009) Paco Aznar: Se filtran las pruebas que pertenecen a episodios del centro actual
MODIFICACION  : (30/10/2009) Paco Aznar: Se compatibiliza con los registros anteriores de episodioHospitalizacion
MODIFICACION  : (07/01/2010) Paco Aznar: Se obtienen las dietas cuya fecha de inicio sea menor o igual a hoy
MODIFICACIÓN  : CHC4053 - v4.41 Release 8 - MAIPU REQ 16475 HEC_Importación e integración de dietas
MODIFICACIÓN  : (13/09/2017) - V17.3 - 16489 - APB - Volumen ingerido de Control de Ingesta a Balances (se completan todos campos con su alias correspondiente)
*/

CREATE PROCEDURE [dbo].[SpHClSBuscDietasExport]
    @spvar_codCentro as char(5) = null
AS

if @spvar_codCentro is null
begin
    set @spvar_codCentro = parametros.dbo.fnParHospitalReferencia()
end

/* HOSPITALIZACIÓN */
select distinct PN.CodDieta
      ,Paciente=(rtrim(ltrim(P.PacNombre)) + ' ' + rtrim(ltrim(P.PacApell1)) + ' ' + rtrim(ltrim(P.PacApell2)))
      ,H.NumCama Cama
      ,CP.DescPla
      ,AG.ParenteralEnteralOral
      ,PN.DescDieta
      ,convert(datetime,convert(char(10),AG.FInicio,101)) FInicio
      ,convert(datetime,convert(char(10),AG.FFin,101)) FFin
      ,P.CodHistoria 
      ,Observacion=isnull(AG.Observaciones, ' - ') 

from  Pacientes P,
      Ingresos..EpisodioHospitalizacion H,
      Parametros..DatosCamas CC,
      Parametros..CodigoPlantas CP,
      Ingresos..AlimentacionGeneral AG,
      Ingresos..Nutricion N,
      Parametros..Nutricion PN

where P.CodPaciente = H.CodPaciente
      and H.CodEpisodio = AG.CodEpisodio
      and H.NumCama = CC.NumCama
      and CC.CodPlanta = CP.CodPla
      and H.NumCama <> ' '
      and H.FechaSalida is null
      and P.CodPaciente = AG.CodPaciente
      and AG.CodPaciente = N.CodPaciente
      and AG.CodEpisodio = N.CodEpisodio
      and AG.FCreacion = N.FCreacion
      and AG.TipoDieta = N.TipoDieta
      and N.CodDieta = PN.CodDieta
      and AG.ParenteralEnteralOral = 'O'
      and (AG.FFin>getdate() or AG.FFin is null)
      and AG.FInicio<=getdate()
      and AG.FEliminacion is null
      and (H.CentroIngreso = @spvar_codCentro or H.CentroIngreso is null)
      and (CC.CodCent = isnull(H.centroIngreso,@spvar_codCentro))

union

select 'AA' 'CodDieta'
      ,Paciente=(rtrim(ltrim(P.PacNombre)) + ' ' + rtrim(ltrim(P.PacApell1)) + ' ' + rtrim(ltrim(P.PacApell2)))
      ,H.NumCama Cama
      ,CP.DescPla
      ,AG.ParenteralEnteralOral
      ,DescDieta='Absoluto'
      ,convert(datetime,convert(char(10),AG.FInicio,101)) FInicio
      ,convert(datetime,convert(char(10),AG.FFin,101)) FFin
      ,P.CodHistoria
      ,Observacion=isnull(AG.Observaciones, ' - ')

from Pacientes P,
     Ingresos..EpisodioHospitalizacion H,
     Parametros..DatosCamas CC,
     Parametros..CodigoPlantas CP,
     Ingresos..AlimentacionGeneral AG,
     Ingresos..DietaAbsoluta DA

where P.CodPaciente = H.CodPaciente
      and H.CodEpisodio = AG.CodEpisodio
      and H.NumCama = CC.NumCama
      and CC.CodPlanta = CP.CodPla
      and H.NumCama <> ' '
      and H.FechaSalida is null
      and P.CodPaciente = AG.CodPaciente
      and AG.CodPaciente = DA.CodPaciente
      and AG.CodEpisodio = DA.CodEpisodio
      and AG.FCreacion = DA.FCreacion
      and AG.TipoDieta = DA.TipoDieta
      and AG.ParenteralEnteralOral = 'A'
      and (AG.FFin>getdate() or AG.FFin is null)
      and AG.FInicio<=getdate()
      and AG.FEliminacion is null
      and (H.CentroIngreso = @spvar_codCentro or H.CentroIngreso is null)
      and (CC.CodCent = isnull(H.centroIngreso,@spvar_codCentro))

--v4.41 Release 8 - MAIPU CHC4053 - INI
/* URGENCIAS */
union

select distinct PN.CodDieta
      ,Paciente=(rtrim(ltrim(P.PacNombre)) + ' ' + rtrim(ltrim(P.PacApell1)) + ' ' + rtrim(ltrim(P.PacApell2)))
	  ,case ISNULL(U.Localizacion,0)
			when 2 then Parametros.dbo.fnParSDescripcionCama(C.CodCama)
			when 3 then Parametros.dbo.fnParSDescripcionCamaIngresosCorto(CI.CodCama)
			when 4 then Parametros.dbo.fnParSDescripcionCama(C.CodCama)
			when 6 then Parametros.dbo.fnParSDescripcionCama(C.CodCama)
			else '' end as Cama
	  ,'URGENCIAS'
      ,AG.ParenteralEnteralOral
      ,PN.DescDieta
      ,convert(datetime,convert(char(10),AG.FInicio,101)) FInicio
      ,convert(datetime,convert(char(10),AG.FFin,101)) FFin
      ,P.CodHistoria 
      ,Observacion=isnull(AG.Observaciones, ' - ') 

from  Pacientes P,
      Ingresos..EpisodioUrgencias U
	  LEFT OUTER JOIN Parametros..CamasBoxesUrg C with (NOLOCK) ON U.CodPaciente = C.CodPaciente AND U.CodEpisodio = C.CodEpisodio
	  LEFT OUTER JOIN Parametros..CamasIngUrgencia CI with (NOLOCK) ON U.CodPaciente = CI.CodPaciente AND U.CodEpisodio = CI.CodEpisodio,
      Ingresos..AlimentacionGeneral AG,
      Ingresos..Nutricion N,
      Parametros..Nutricion PN

where P.CodPaciente = U.CodPaciente
	  and U.CodEpisodio = AG.CodEpisodio
	  and U.FechaSalida is null
	  and P.CodPaciente = AG.CodPaciente
	  and AG.CodPaciente = N.CodPaciente
	  and AG.CodEpisodio = N.CodEpisodio
	  and AG.FCreacion = N.FCreacion
	  and AG.TipoDieta = N.TipoDieta
	  and N.CodDieta = PN.CodDieta
	  and AG.ParenteralEnteralOral = 'O'
	  and (AG.FFin>getdate() or AG.FFin is null)
	  and AG.FInicio<=getdate()
	  and AG.FEliminacion is null
	  and (U.CodigoCentUrg = @spvar_codCentro or U.CodigoCentUrg is null)

union

select 'AA' 'CodDieta'
      ,Paciente=(rtrim(ltrim(P.PacNombre)) + ' ' + rtrim(ltrim(P.PacApell1)) + ' ' + rtrim(ltrim(P.PacApell2)))
	  ,case ISNULL(U.Localizacion,0)
			when 2 then Parametros.dbo.fnParSDescripcionCama(C.CodCama)
			when 3 then Parametros.dbo.fnParSDescripcionCamaIngresosCorto(CI.CodCama)
			when 4 then Parametros.dbo.fnParSDescripcionCama(C.CodCama)
			when 6 then Parametros.dbo.fnParSDescripcionCama(C.CodCama)
			else '' end as Cama
	  ,'URGENCIAS'
      ,AG.ParenteralEnteralOral
      ,DescDieta='Absoluto'
      ,convert(datetime,convert(char(10),AG.FInicio,101)) FInicio
      ,convert(datetime,convert(char(10),AG.FFin,101)) FFin
      ,P.CodHistoria
      ,Observacion=isnull(AG.Observaciones, ' - ')

from Pacientes P,
     Ingresos..EpisodioUrgencias U
	 LEFT OUTER JOIN Parametros..CamasBoxesUrg C with (NOLOCK) ON U.CodPaciente = C.CodPaciente AND U.CodEpisodio = C.CodEpisodio
	 LEFT OUTER JOIN Parametros..CamasIngUrgencia CI with (NOLOCK) ON U.CodPaciente = CI.CodPaciente AND U.CodEpisodio = CI.CodEpisodio,
     Ingresos..AlimentacionGeneral AG,
     Ingresos..DietaAbsoluta DA

where P.CodPaciente = U.CodPaciente
      and U.CodEpisodio = AG.CodEpisodio
      and U.FechaSalida is null
      and P.CodPaciente = AG.CodPaciente
      and AG.CodPaciente = DA.CodPaciente
      and AG.CodEpisodio = DA.CodEpisodio
      and AG.FCreacion = DA.FCreacion
      and AG.TipoDieta = DA.TipoDieta
      and AG.ParenteralEnteralOral = 'A'
      and (AG.FFin>getdate() or AG.FFin is null)
      and AG.FInicio<=getdate()
      and AG.FEliminacion is null
      and (U.CodigoCentUrg = @spvar_codCentro or U.CodigoCentUrg is null)

/* CEX (AMBULATORIO) */
union

select distinct PN.CodDieta
      ,Paciente=(rtrim(ltrim(P.PacNombre)) + ' ' + rtrim(ltrim(P.PacApell1)) + ' ' + rtrim(ltrim(P.PacApell2)))
	  ,PHD.DescPuesto
	  ,PHD.DescSala
      ,AG.ParenteralEnteralOral
      ,PN.DescDieta
      ,convert(datetime,convert(char(10),AG.FInicio,101)) FInicio
      ,convert(datetime,convert(char(10),AG.FFin,101)) FFin
      ,P.CodHistoria 
      ,Observacion=isnull(AG.Observaciones, ' - ') 

from  Pacientes P,
      Consultas..EpisodioConsultas C
	  INNER JOIN HClinica..CitasHospitalDia CHD ON CHD.CodPaciente = C.CodPaciente AND CHD.CodEpisodio = C.CodEpisodio
	  INNER JOIN Parametros..PuestosHospitalDia PHD ON PHD.CodPuesto = CHD.CodCama,
      Ingresos..AlimentacionGeneral AG,
      Ingresos..Nutricion N,
      Parametros..Nutricion PN

where P.CodPaciente = C.CodPaciente
      and C.CodEpisodio = AG.CodEpisodio
      and C.FechaCierre is null
      and P.CodPaciente = AG.CodPaciente
      and AG.CodPaciente = N.CodPaciente
      and AG.CodEpisodio = N.CodEpisodio
      and AG.FCreacion = N.FCreacion
      and AG.TipoDieta = N.TipoDieta
      and N.CodDieta = PN.CodDieta
      and AG.ParenteralEnteralOral = 'O'
      and (AG.FFin>getdate() or AG.FFin is null)
      and AG.FInicio<=getdate()
      and AG.FEliminacion is null
      and CONVERT(datetime,CONVERT(char(10),CHD.FechaCita,101)) BETWEEN CONVERT(datetime,CONVERT(char(10),AG.FInicio,101)) AND CONVERT(datetime,CONVERT(char(10),AG.FFin,101))
      and (C.CodCentroFinal = @spvar_codCentro or C.CodCentroFinal is null)

union

select 'AA' 'CodDieta'
      ,Paciente=(rtrim(ltrim(P.PacNombre)) + ' ' + rtrim(ltrim(P.PacApell1)) + ' ' + rtrim(ltrim(P.PacApell2)))
	  ,PHD.DescPuesto
	  ,PHD.DescSala
      ,AG.ParenteralEnteralOral
      ,DescDieta='Absoluto'
      ,convert(datetime,convert(char(10),AG.FInicio,101)) FInicio
      ,convert(datetime,convert(char(10),AG.FFin,101)) FFin
      ,P.CodHistoria
      ,Observacion=isnull(AG.Observaciones, ' - ')

from Pacientes P,
     Consultas..EpisodioConsultas C
	 INNER JOIN HClinica..CitasHospitalDia CHD ON CHD.CodPaciente = C.CodPaciente AND CHD.CodEpisodio = C.CodEpisodio
	 INNER JOIN Parametros..PuestosHospitalDia PHD ON PHD.CodPuesto = CHD.CodCama,
     Ingresos..AlimentacionGeneral AG,
     Ingresos..DietaAbsoluta DA

where P.CodPaciente = C.CodPaciente
      and C.CodEpisodio = AG.CodEpisodio
      and C.FechaCierre is null
      and P.CodPaciente = AG.CodPaciente
      and AG.CodPaciente = DA.CodPaciente
      and AG.CodEpisodio = DA.CodEpisodio
      and AG.FCreacion = DA.FCreacion
      and AG.TipoDieta = DA.TipoDieta
      and AG.ParenteralEnteralOral = 'A'
      and (AG.FFin>getdate() or AG.FFin is null)
      and AG.FInicio<=getdate()
      and CONVERT(datetime,CONVERT(char(10),CHD.FechaCita,101)) BETWEEN CONVERT(datetime,CONVERT(char(10),AG.FInicio,101)) AND CONVERT(datetime,CONVERT(char(10),AG.FFin,101))
      and AG.FEliminacion is null
      and (C.CodCentroFinal = @spvar_codCentro or C.CodCentroFinal is null)
--v4.41 Release 8 - MAIPU CHC4053 - FIN

GO

GO



--dbo.SpHClSCargaHojaCtes.sql

USE [Hclinica]
GO

IF EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[SpHClSCargaHojaCtes]') AND type in (N'P', N'PC'))
	DROP PROCEDURE [dbo].[SpHClSCargaHojaCtes]
GO

SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO
   
/*********************************************************************
* FUNCION  : Devuelve los datos de la hoja de constantes
* DEVUELVE : 
* FECHA	   : 24-01-2006
* VERSION  : 1.0
* AUTOR	   : Manuel Mas Asencio (MECEMSA)
* APLICACION ORIGEN: FEnfHojaCtes
* MODIFICACIÓN : Ismael(08/04/2008): nuevo campo Apache
* MODIFICACIÓN : Añadir parametro @spvar_UCSI para borrar las constantes solo de la fecha/hora indicada (y no todas las del dia)
* FECHA	       : 28-08-2008
* AUTOR	       : Oscar Vilella
* MODIFICACIÓN : (11/01/2010) Teresa L Fabuel S. Se obtienen los datos de la base de datos de historificacion.
* MODIFICACIÓN : (19/12/2012) Alberto Pagán CHC2334 v4.35 Release 1, devolver el campo Temperatura Rectal
* MODIFICACIÓN : (25/02/2013) Alberto Pagán - MAIPU CHC2336 - v4.38 - nuevo campo Observaciones
* MODIFICACIÓN : (10/09/2013) CTF - 73569626D - CHC3184 - REQ27180  - v4.40 -  Modificacion de campo glicemia
* MODIFICACIÓN : (16/01/2015) - V4.50 - 1623 - RRG - Oxigenoterapia - REQ 66276
* MODIFICACIÓN : (21/08/2017) - V17.3 - 16489 - APB - Volumen ingerido de Control de Ingesta a Balances
********************************************************************/

CREATE PROCEDURE [dbo].[SpHClSCargaHojaCtes]
	 @spvar_strcodpaciente char(16)
    ,@spvar_strcodepisodio char(5)
    ,@spvar_fecha smalldatetime
	,@spvar_UCSI bit = 'False'
AS

Create Table #CFrecuentes (Fecha smalldatetime
						  ,Temperatura real null
						  ,TAS smallint null
  						  ,TAD smallint null
  						  ,FCard tinyint null
						  ,PVC int null
						  ,FResp tinyint null
						  ,Diuresis decimal(10,2) null
						  --CTF - 73569626D - CHC3184 - REQ27180  - v4.40 -  Modificacion de campo glicemia
						  --,Glucemia smallint null
						  ,Glucemia varchar(8) null						  
						  ,EVA smallint null
						  ,Saturacion smallint null
						  --CHC2334 v4.35 Release 1 Alberto Pagán, devolver el campo Temperatura Rectal
						  ,TemperaturaRectal real null
						  --CHC2334 v4.35 Release 1 Alberto Pagán, Fin
						  ,Observaciones varchar(200) null --Alberto Pagán - MAIPU CHC2336 - v4.38 - 25/02/2013
                          ,CodOxigeno    varchar(5) null   --16/01/2015 - v4.50 - 1623 - RRG - Oxigenoterapia - REQ 66276
						  )

If not exists (Select *
	           From Ingresos..ValoresDiarios VD
	           Where VD.CodPaciente=@spvar_strcodpaciente and VD.CodEpisodio=@spvar_strcodepisodio and convert(char(10),FecValDia,103)=convert(char(10),@spvar_fecha,103))
Begin
Select PesValDia,
       NutParenteral,
       NutOral,
       NutEnteral,
       CantAspira,
       CantVomito,
       CantDeposic,
       CantDrenaRedon,
       CantDrenaGast,
       CantDrenaTorac,
       FecValDia,
	   Talla,
	   CC,
	   isnull(Apache,0) as Apache,
	   VD.Observaciones --Alberto Pagán - MAIPU CHC2336 - v4.38 - 25/02/2013
From 
	   Historificacion..Ingresos_ValoresDiarios VD left join Ingresos.dbo.EpisodioHospitalizacion EH on VD.CodPaciente = EH.CodPaciente and VD.CodEpisodio = EH.CodEpisodio
Where 
	  VD.CodPaciente=@spvar_strcodpaciente And
      VD.CodEpisodio=@spvar_strcodepisodio And
      convert(char(10),FecValDia,103)=convert(char(10),@spvar_fecha,103) 

Insert 
		#CFrecuentes
Select	
		Fecha,null,null,null,null,null,null,null,null,null,null
		----CHC2334 v4.35 Release 1 Alberto Pagán, devolver el campo Temperatura Rectal
		,null
		----CHC2334 v4.35 Release 1 Alberto Pagán, Fin
		,null --Alberto Pagán - MAIPU CHC2336 - v4.38 - 25/02/2013
        ,null --16/01/2015 - v4.50 - 1623 - RRG - Oxigenoterapia - REQ 66276
From 
		Historificacion..HClinica_ConstanteTemperatura
Where 
		CodPaciente=@spvar_strcodpaciente And
		CodEpisodio=@spvar_strcodepisodio And
		convert(char(10),Fecha,103)=convert(char(10),@spvar_fecha,103) 
		and (fecha=@spvar_fecha OR @spvar_UCSI='False')
Union

Select 
		Fecha,null,null,null,null,null,null,null,null,null,null
		----CHC2334 v4.35 Release 1 Alberto Pagán, devolver el campo Temperatura Rectal
		,null
		----CHC2334 v4.35 Release 1 Alberto Pagán, Fin		
		,null --Alberto Pagán - MAIPU CHC2336 - v4.38 - 25/02/2013
        ,null --16/01/2015 - v4.50 - 1623 - RRG - Oxigenoterapia - REQ 66276
From 
		Historificacion..HClinica_TArterial
Where 
		CodPaciente=@spvar_strcodpaciente And
		CodEpisodio=@spvar_strcodepisodio And	
		convert(char(10),Fecha,103)=convert(char(10),@spvar_fecha,103)
		and (fecha=@spvar_fecha OR @spvar_UCSI='False')
Union

Select 
		FLecturaDatos,null,null,null,null,null,null,null,null,null,null
		----CHC2334 v4.35 Release 1 Alberto Pagán, devolver el campo Temperatura Rectal
		,null
		----CHC2334 v4.35 Release 1 Alberto Pagán, Fin
		,null --Alberto Pagán - MAIPU CHC2336 - v4.38 - 25/02/2013
        ,null --16/01/2015 - v4.50 - 1623 - RRG - Oxigenoterapia - REQ 66276
From 
		Historificacion..HClinica_ParametrosCardiacos
Where 
		CodPaciente=@spvar_strcodpaciente And
		CodEpisodio=@spvar_strcodepisodio And
		convert(char(10),FLecturaDatos,103)=convert(char(10),@spvar_fecha,103)
		and (FLecturaDatos=@spvar_fecha OR @spvar_UCSI='False')
Union

Select	
		Fecha,null,null,null,null,null,null,null,null,null,null
		----CHC2334 v4.35 Release 1 Alberto Pagán, devolver el campo Temperatura Rectal
		,null
		----CHC2334 v4.35 Release 1 Alberto Pagán, Fin
		,null --Alberto Pagán - MAIPU CHC2336 - v4.38 - 25/02/2013
        ,null --16/01/2015 - v4.50 - 1623 - RRG - Oxigenoterapia - REQ 66276
From 
		Historificacion..HClinica_PVC
Where 
		CodPaciente=@spvar_strcodpaciente And
		CodEpisodio=@spvar_strcodepisodio And
		convert(char(10),Fecha,103)=convert(char(10),@spvar_fecha,103)
		and (fecha=@spvar_fecha OR @spvar_UCSI='False')
Union
	
Select 
		FLecturaDatos,null,null,null,null,null,null,null,null,null,null
		----CHC2334 v4.35 Release 1 Alberto Pagán, devolver el campo Temperatura Rectal
		,null
		----CHC2334 v4.35 Release 1 Alberto Pagán, Fin
		,null --Alberto Pagán - MAIPU CHC2336 - v4.38 - 25/02/2013
        ,null --16/01/2015 - v4.50 - 1623 - RRG - Oxigenoterapia - REQ 66276
From  
		Historificacion..HClinica_ParametrosRespiratorios
Where 
		CodPaciente=@spvar_strcodpaciente And
		CodEpisodio=@spvar_strcodepisodio And
		convert(char(10),FLecturaDatos,103)=convert(char(10),@spvar_fecha,103)
		and (FLecturaDatos=@spvar_fecha OR @spvar_UCSI='False')
Union
		
Select	
		Fecha,null,null,null,null,null,null,null,null,null,null
		----CHC2334 v4.35 Release 1 Alberto Pagán, devolver el campo Temperatura Rectal
		,null
		----CHC2334 v4.35 Release 1 Alberto Pagán, Fin
		,null --Alberto Pagán - MAIPU CHC2336 - v4.38 - 25/02/2013
        ,null --16/01/2015 - v4.50 - 1623 - RRG - Oxigenoterapia - REQ 66276
From 
		Historificacion..HClinica_Diuresis
Where 
		CodPaciente=@spvar_strcodpaciente And
		CodEpisodio=@spvar_strcodepisodio And
		convert(char(10),Fecha,103)=convert(char(10),@spvar_fecha,103)
		and (fecha=@spvar_fecha OR @spvar_UCSI='False')
Union
		
Select	
		Fecha,null,null,null,null,null,null,null,null,null,null
		--CHC2334 v4.35 Release 1 Alberto Pagán, devolver el campo Temperatura Rectal
		,null
		--CHC2334 v4.35 Release 1 Alberto Pagán, Fin
		,null --Alberto Pagán - MAIPU CHC2336 - v4.38 - 25/02/2013
        ,null --16/01/2015 - v4.50 - 1623 - RRG - Oxigenoterapia - REQ 66276
From 
		Historificacion..HClinica_Glucemia
Where 
		CodPaciente=@spvar_strcodpaciente And
		CodEpisodio=@spvar_strcodepisodio And
		convert(char(10),Fecha,103)=convert(char(10),@spvar_fecha,103)
		and (fecha=@spvar_fecha OR @spvar_UCSI='False')

-- primer añadido para eva y saturacion

Union
		
Select	
		Fecha,null,null,null,null,null,null,null,null,null,null
		--CHC2334 v4.35 Release 1 Alberto Pagán, devolver el campo Temperatura Rectal
		,null
		--CHC2334 v4.35 Release 1 Alberto Pagán, Fin
		,null --Alberto Pagán - MAIPU CHC2336 - v4.38 - 25/02/2013
        ,null --16/01/2015 - v4.50 - 1623 - RRG - Oxigenoterapia - REQ 66276
From 
		Historificacion..HClinica_EVA
Where 
		CodPaciente=@spvar_strcodpaciente And
		CodEpisodio=@spvar_strcodepisodio And
		convert(char(10),Fecha,103)=convert(char(10),@spvar_fecha,103) 
		and (fecha=@spvar_fecha OR @spvar_UCSI='False')

Union
		
Select	
		Fecha,null,null,null,null,null,null,null,null,null,null
		--CHC2334 v4.35 Release 1 Alberto Pagán, devolver el campo Temperatura Rectal
		,null
		--CHC2334 v4.35 Release 1 Alberto Pagán, Fin
		,null --Alberto Pagán - MAIPU CHC2336 - v4.38 - 25/02/2013
        ,null --16/01/2015 - v4.50 - 1623 - RRG - Oxigenoterapia - REQ 66276
From 
		Historificacion..HClinica_Saturacion
Where 
		CodPaciente=@spvar_strcodpaciente And
		CodEpisodio=@spvar_strcodepisodio And
		convert(char(10),Fecha,103)=convert(char(10),@spvar_fecha,103)
		and (fecha=@spvar_fecha OR @spvar_UCSI='False')

-- fin de primer añadido para eva y saturacion

-- ahora empiezan los updates

Update 
		#CFrecuentes
Set 
		#CFrecuentes.Temperatura=T.Temperatura
		--CHC2334 v4.35 Release 1 Alberto Pagán, devolver el campo Temperatura Rectal
		,#CFrecuentes.TemperaturaRectal=T.TemperaturaRectal
		--CHC2334 v4.35 Release 1 Alberto Pagán, Fin
From 
		#CFrecuentes #CFrecuentes,
        Historificacion..HClinica_ConstanteTemperatura T
Where 
		T.CodPaciente=@spvar_strcodpaciente And
		T.CodEpisodio=@spvar_strcodepisodio And
		convert(char(10),T.Fecha,103)=convert(char(10),@spvar_fecha,103) And
		#CFrecuentes.Fecha=T.Fecha

Update 
		#CFrecuentes
Set 
		#CFrecuentes.TAS=TA.TAS,
		#CFrecuentes.TAD=TA.TAD
From 
		#CFrecuentes #CFrecuentes,
        Historificacion..HClinica_TArterial TA
Where 
		TA.CodPaciente=@spvar_strcodpaciente And
		TA.CodEpisodio=@spvar_strcodepisodio And
		convert(char(10),TA.Fecha,103)=convert(char(10),@spvar_fecha,103) And
		#CFrecuentes.Fecha=TA.Fecha

Update 
		#CFrecuentes
Set 
		#CFrecuentes.FCard=FC.Frecuencia
From 
		#CFrecuentes #CFrecuentes,
        Historificacion..HClinica_ParametrosCardiacos FC
Where 
		FC.CodPaciente=@spvar_strcodpaciente And
		FC.CodEpisodio=@spvar_strcodepisodio And
		convert(char(10),FC.FLecturaDatos,103)=convert(char(10),@spvar_fecha,103) And
		#CFrecuentes.Fecha=FC.FLecturaDatos

Update 
		#CFrecuentes
Set 
		#CFrecuentes.PVC=T.PVC
From 
		#CFrecuentes #CFrecuentes,
        Historificacion..HClinica_PVC T
Where 
		T.CodPaciente=@spvar_strcodpaciente And
		T.CodEpisodio=@spvar_strcodepisodio And
		convert(char(10),T.Fecha,103)=convert(char(10),@spvar_fecha,103) And
		#CFrecuentes.Fecha=T.Fecha

Update 
		#CFrecuentes
Set 
		#CFrecuentes.FResp=FR.Frecuencia
From 
		#CFrecuentes #CFrecuentes,
        Historificacion..HClinica_ParametrosRespiratorios FR
Where 
		FR.CodPaciente=@spvar_strcodpaciente And
		FR.CodEpisodio=@spvar_strcodepisodio And
		convert(char(10),FR.FLecturaDatos,103)=convert(char(10),@spvar_fecha,103) And
		#CFrecuentes.Fecha=FR.FLecturaDatos

Update	
		#CFrecuentes
Set  
		#CFrecuentes.Diuresis=D.Diuresis
From 
		#CFrecuentes #CFrecuentes,
        Historificacion..HClinica_Diuresis D
Where 
		D.CodPaciente=@spvar_strcodpaciente And
		D.CodEpisodio=@spvar_strcodepisodio And
		convert(char(10),D.Fecha,103)=convert(char(10),@spvar_fecha,103) And
		#CFrecuentes.Fecha=D.Fecha

Update	
		#CFrecuentes
Set  
		#CFrecuentes.Glucemia=G.Glucemia
From 
		#CFrecuentes #CFrecuentes,
        Historificacion..HClinica_Glucemia G
Where 
		G.CodPaciente=@spvar_strcodpaciente And
		G.CodEpisodio=@spvar_strcodepisodio And
		convert(char(10),G.Fecha,103)=convert(char(10),@spvar_fecha,103) And
		#CFrecuentes.Fecha=G.Fecha

-- segundo añadido para eva y saturacion

Update	
		#CFrecuentes
Set  
		#CFrecuentes.EVA=E.EVA
From 
		#CFrecuentes #CFrecuentes,
        Historificacion..HClinica_EVA E
Where 
		E.CodPaciente=@spvar_strcodpaciente And
		E.CodEpisodio=@spvar_strcodepisodio And
		convert(char(10),E.Fecha,103)=convert(char(10),@spvar_fecha,103) And
		#CFrecuentes.Fecha=E.Fecha

Update	
		#CFrecuentes
Set  
		#CFrecuentes.Saturacion=S.Saturacion
From 
		#CFrecuentes #CFrecuentes,
        Historificacion..HClinica_Saturacion S
Where 
		S.CodPaciente=@spvar_strcodpaciente And
		S.CodEpisodio=@spvar_strcodepisodio And
		convert(char(10),S.Fecha,103)=convert(char(10),@spvar_fecha,103) And
		#CFrecuentes.Fecha=S.Fecha

-- fin de segundo añadido para eva y saturacion

End
Else
Begin
Select PesValDia,
       NutParenteral,
       NutOral,
       NutEnteral,
       CantAspira,
       CantVomito,
       CantDeposic,
       CantDrenaRedon,
       CantDrenaGast,
       CantDrenaTorac,
       FecValDia,
	   Talla,
	   CC,
	   isnull(Apache,0) as Apache,
	   VD.Observaciones --Alberto Pagán - MAIPU CHC2336 - v4.38 - 25/02/2013
From 
	   Ingresos..ValoresDiarios VD left join Ingresos.dbo.EpisodioHospitalizacion EH on  VD.CodPaciente = EH.CodPaciente and VD.CodEpisodio = EH.CodEpisodio
Where 
	  VD.CodPaciente=@spvar_strcodpaciente And
      VD.CodEpisodio=@spvar_strcodepisodio And
      convert(char(10),FecValDia,103)=convert(char(10),@spvar_fecha,103) 
	  
Insert 
		#CFrecuentes
Select	
		Fecha,null,null,null,null,null,null,null,null,null,null
		--CHC2334 v4.35 Release 1 Alberto Pagán, devolver el campo Temperatura Rectal
		,null
		--CHC2334 v4.35 Release 1 Alberto Pagán, Fin
		,null --Alberto Pagán - MAIPU CHC2336 - v4.38 - 25/02/2013
        ,null --16/01/2015 - v4.50 - 1623 - RRG - Oxigenoterapia - REQ 66276
From 
		ConstanteTemperatura
Where 
		CodPaciente=@spvar_strcodpaciente And
		CodEpisodio=@spvar_strcodepisodio And
		convert(char(10),Fecha,103)=convert(char(10),@spvar_fecha,103) 
		and (fecha=@spvar_fecha OR @spvar_UCSI='False')
Union

Select 
		Fecha,null,null,null,null,null,null,null,null,null,null
		--CHC2334 v4.35 Release 1 Alberto Pagán, devolver el campo Temperatura Rectal
		,null
		--CHC2334 v4.35 Release 1 Alberto Pagán, Fin
		,null --Alberto Pagán - MAIPU CHC2336 - v4.38 - 25/02/2013
        ,null --16/01/2015 - v4.50 - 1623 - RRG - Oxigenoterapia - REQ 66276
From 
		TArterial
Where 
		CodPaciente=@spvar_strcodpaciente And
		CodEpisodio=@spvar_strcodepisodio And	
		convert(char(10),Fecha,103)=convert(char(10),@spvar_fecha,103)
		and (fecha=@spvar_fecha OR @spvar_UCSI='False')
Union

Select 
		FLecturaDatos,null,null,null,null,null,null,null,null,null,null
		--CHC2334 v4.35 Release 1 Alberto Pagán, devolver el campo Temperatura Rectal
		,null
		--CHC2334 v4.35 Release 1 Alberto Pagán, Fin
		,null --Alberto Pagán - MAIPU CHC2336 - v4.38 - 25/02/2013
        ,null --16/01/2015 - v4.50 - 1623 - RRG - Oxigenoterapia - REQ 66276
From 
		ParametrosCardiacos
Where 
		CodPaciente=@spvar_strcodpaciente And
		CodEpisodio=@spvar_strcodepisodio And
		convert(char(10),FLecturaDatos,103)=convert(char(10),@spvar_fecha,103)
		and (FLecturaDatos=@spvar_fecha OR @spvar_UCSI='False')
Union

Select	
		Fecha,null,null,null,null,null,null,null,null,null,null
		--CHC2334 v4.35 Release 1 Alberto Pagán, devolver el campo Temperatura Rectal
		,null
		--CHC2334 v4.35 Release 1 Alberto Pagán, Fin
		,null --Alberto Pagán - MAIPU CHC2336 - v4.38 - 25/02/2013
        ,null --16/01/2015 - v4.50 - 1623 - RRG - Oxigenoterapia - REQ 66276
From 
		PVC
Where 
		CodPaciente=@spvar_strcodpaciente And
		CodEpisodio=@spvar_strcodepisodio And
		convert(char(10),Fecha,103)=convert(char(10),@spvar_fecha,103)
		and (fecha=@spvar_fecha OR @spvar_UCSI='False')
Union
	
Select 
		FLecturaDatos,null,null,null,null,null,null,null,null,null,null
		--CHC2334 v4.35 Release 1 Alberto Pagán, devolver el campo Temperatura Rectal
		,null
		--CHC2334 v4.35 Release 1 Alberto Pagán, Fin
		,null --Alberto Pagán - MAIPU CHC2336 - v4.38 - 25/02/2013
        ,null --16/01/2015 - v4.50 - 1623 - RRG - Oxigenoterapia - REQ 66276
From  
		ParametrosRespiratorios
Where 
		CodPaciente=@spvar_strcodpaciente And
		CodEpisodio=@spvar_strcodepisodio And
		convert(char(10),FLecturaDatos,103)=convert(char(10),@spvar_fecha,103)
		and (FLecturaDatos=@spvar_fecha OR @spvar_UCSI='False')
Union
		
Select	
		Fecha,null,null,null,null,null,null,null,null,null,null
		--CHC2334 v4.35 Release 1 Alberto Pagán, devolver el campo Temperatura Rectal
		,null
		--CHC2334 v4.35 Release 1 Alberto Pagán, Fin
		,null --Alberto Pagán - MAIPU CHC2336 - v4.38 - 25/02/2013
        ,null --16/01/2015 - v4.50 - 1623 - RRG - Oxigenoterapia - REQ 66276
From 
		Diuresis
Where 
		CodPaciente=@spvar_strcodpaciente And
		CodEpisodio=@spvar_strcodepisodio And
		convert(char(10),Fecha,103)=convert(char(10),@spvar_fecha,103)
		and (fecha=@spvar_fecha OR @spvar_UCSI='False')
Union
		
Select	
		Fecha,null,null,null,null,null,null,null,null,null,null
		--CHC2334 v4.35 Release 1 Alberto Pagán, devolver el campo Temperatura Rectal
		,null
		--CHC2334 v4.35 Release 1 Alberto Pagán, Fin
		,null --Alberto Pagán - MAIPU CHC2336 - v4.38 - 25/02/2013
        ,null --16/01/2015 - v4.50 - 1623 - RRG - Oxigenoterapia - REQ 66276
From 
		Glucemia
Where 
		CodPaciente=@spvar_strcodpaciente And
		CodEpisodio=@spvar_strcodepisodio And
		convert(char(10),Fecha,103)=convert(char(10),@spvar_fecha,103)
		and (fecha=@spvar_fecha OR @spvar_UCSI='False')

-- primer añadido para eva y saturacion

Union
		
Select	
		Fecha,null,null,null,null,null,null,null,null,null,null
		--CHC2334 v4.35 Release 1 Alberto Pagán, devolver el campo Temperatura Rectal
		,null
		--CHC2334 v4.35 Release 1 Alberto Pagán, Fin
		,null --Alberto Pagán - MAIPU CHC2336 - v4.38 - 25/02/2013
        ,null --16/01/2015 - v4.50 - 1623 - RRG - Oxigenoterapia - REQ 66276
From 
		EVA
Where 
		CodPaciente=@spvar_strcodpaciente And
		CodEpisodio=@spvar_strcodepisodio And
		convert(char(10),Fecha,103)=convert(char(10),@spvar_fecha,103) 
		and (fecha=@spvar_fecha OR @spvar_UCSI='False')

Union
		
Select	
		Fecha,null,null,null,null,null,null,null,null,null,null
		--CHC2334 v4.35 Release 1 Alberto Pagán, devolver el campo Temperatura Rectal
		,null
		--CHC2334 v4.35 Release 1 Alberto Pagán, Fin
		,null --Alberto Pagán - MAIPU CHC2336 - v4.38 - 25/02/2013
        ,null --16/01/2015 - v4.50 - 1623 - RRG - Oxigenoterapia - REQ 66276
From 
		Saturacion
Where 
		CodPaciente=@spvar_strcodpaciente And
		CodEpisodio=@spvar_strcodepisodio And
		convert(char(10),Fecha,103)=convert(char(10),@spvar_fecha,103)
		and (fecha=@spvar_fecha OR @spvar_UCSI='False')
-- 16/01/2015 - v4.50 - 1623 - RRG - Oxigenoterapia - REQ 66276 - INI
UNION
SELECT
		Fecha,null,null,null,null,null,null,null,null,null,null
		,null
		,null 
		,null 
FROM HCLINICA..ConstanteOxigenoterapia
WHERE 
		CodPaciente=@spvar_strcodpaciente And
		CodEpisodio=@spvar_strcodepisodio And
		convert(char(10),Fecha,103)=convert(char(10),@spvar_fecha,103)
		and (fecha=@spvar_fecha OR @spvar_UCSI='False')
-- 16/01/2015 - v4.50 - 1623 - RRG - Oxigenoterapia - REQ 66276 - FIN
-- fin de primer añadido para eva y saturacion

-- ahora empiezan los updates

Update 
		#CFrecuentes
Set 
		#CFrecuentes.Temperatura=T.Temperatura
		--CHC2334 v4.35 Release 1 Alberto Pagán, devolver el campo Temperatura Rectal
		,#CFrecuentes.TemperaturaRectal=T.TemperaturaRectal
		--CHC2334 v4.35 Release 1 Alberto Pagán, Fin
From 
		#CFrecuentes #CFrecuentes,
        ConstanteTemperatura T
Where 
		T.CodPaciente=@spvar_strcodpaciente And
		T.CodEpisodio=@spvar_strcodepisodio And
		convert(char(10),T.Fecha,103)=convert(char(10),@spvar_fecha,103) And
		#CFrecuentes.Fecha=T.Fecha

Update 
		#CFrecuentes
Set 
		#CFrecuentes.TAS=TA.TAS,
		#CFrecuentes.TAD=TA.TAD
From 
		#CFrecuentes #CFrecuentes,
        TArterial TA
Where 
		TA.CodPaciente=@spvar_strcodpaciente And
		TA.CodEpisodio=@spvar_strcodepisodio And
		convert(char(10),TA.Fecha,103)=convert(char(10),@spvar_fecha,103) And
		#CFrecuentes.Fecha=TA.Fecha

Update 
		#CFrecuentes
Set 
		#CFrecuentes.FCard=FC.Frecuencia
From 
		#CFrecuentes #CFrecuentes,
        ParametrosCardiacos FC
Where 
		FC.CodPaciente=@spvar_strcodpaciente And
		FC.CodEpisodio=@spvar_strcodepisodio And
		convert(char(10),FC.FLecturaDatos,103)=convert(char(10),@spvar_fecha,103) And
		#CFrecuentes.Fecha=FC.FLecturaDatos

Update 
		#CFrecuentes
Set 
		#CFrecuentes.PVC=T.PVC
From 
		#CFrecuentes #CFrecuentes,
        PVC T
Where 
		T.CodPaciente=@spvar_strcodpaciente And
		T.CodEpisodio=@spvar_strcodepisodio And
		convert(char(10),T.Fecha,103)=convert(char(10),@spvar_fecha,103) And
		#CFrecuentes.Fecha=T.Fecha

Update 
		#CFrecuentes
Set 
		#CFrecuentes.FResp=FR.Frecuencia
From 
		#CFrecuentes #CFrecuentes,
        ParametrosRespiratorios FR
Where 
		FR.CodPaciente=@spvar_strcodpaciente And
		FR.CodEpisodio=@spvar_strcodepisodio And
		convert(char(10),FR.FLecturaDatos,103)=convert(char(10),@spvar_fecha,103) And
		#CFrecuentes.Fecha=FR.FLecturaDatos

Update	
		#CFrecuentes
Set  
		#CFrecuentes.Diuresis=D.Diuresis
From 
		#CFrecuentes #CFrecuentes,
        Diuresis D
Where 
		D.CodPaciente=@spvar_strcodpaciente And
		D.CodEpisodio=@spvar_strcodepisodio And
		convert(char(10),D.Fecha,103)=convert(char(10),@spvar_fecha,103) And
		#CFrecuentes.Fecha=D.Fecha

Update	
		#CFrecuentes
Set  
		#CFrecuentes.Glucemia=G.Glucemia
From 
		#CFrecuentes #CFrecuentes,
        Glucemia G
Where 
		G.CodPaciente=@spvar_strcodpaciente And
		G.CodEpisodio=@spvar_strcodepisodio And
		convert(char(10),G.Fecha,103)=convert(char(10),@spvar_fecha,103) And
		#CFrecuentes.Fecha=G.Fecha

-- segundo añadido para eva y saturacion

Update	
		#CFrecuentes
Set  
		#CFrecuentes.EVA=E.EVA
From 
		#CFrecuentes #CFrecuentes,
        EVA E
Where 
		E.CodPaciente=@spvar_strcodpaciente And
		E.CodEpisodio=@spvar_strcodepisodio And
		convert(char(10),E.Fecha,103)=convert(char(10),@spvar_fecha,103) And
		#CFrecuentes.Fecha=E.Fecha

Update	
		#CFrecuentes
Set  
		#CFrecuentes.Saturacion=S.Saturacion
From 
		#CFrecuentes #CFrecuentes,
        Saturacion S
Where 
		S.CodPaciente=@spvar_strcodpaciente And
		S.CodEpisodio=@spvar_strcodepisodio And
		convert(char(10),S.Fecha,103)=convert(char(10),@spvar_fecha,103) And
		#CFrecuentes.Fecha=S.Fecha

-- fin de segundo añadido para eva y saturacion
-- 16/01/2015 - v4.50 - 1623 - RRG - Oxigenoterapia - REQ 66276 - INI
Update	
		#CFrecuentes
Set  
		#CFrecuentes.codoxigeno=CO.CodOxigeno
From 
		#CFrecuentes #CFrecuentes,
        HCLINICA..ConstanteOxigenoterapia CO     
Where 
		CO.CodPaciente=@spvar_strcodpaciente And
		CO.CodEpisodio=@spvar_strcodepisodio And
		convert(char(10),CO.Fecha,103)=convert(char(10),@spvar_fecha,103) And
		#CFrecuentes.Fecha=CO.Fecha		
-- 16/01/2015 - v4.50 - 1623 - RRG - Oxigenoterapia - REQ 66276 - FIN

End

Select Fecha
	  ,Temperatura
	  ,TAS
	  ,TAD
	  ,FCard
	  ,PVC
	  ,FResp
	  ,Diuresis
	  ,Glucemia
	  ,EVA
	  ,Saturacion
	  --CHC2334 v4.35 Release 1 Alberto Pagán, devolver el campo Temperatura Rectal
	  ,TemperaturaRectal
	  --CHC2334 v4.35 Release 1 Alberto Pagán, Fin
	  ,Observaciones --Alberto Pagán - MAIPU CHC2336 - v4.38 - 25/02/2013
	  ,CodOxigeno	 -- 16/01/2015 - v4.50 - 1623 - RRG - Oxigenoterapia - REQ 66276
From 
	  #CFrecuentes

Order By 
	  Fecha

GO
GO



--dbo.SpHClSCargaHojaCtesTodas.sql

USE [Hclinica]
GO

IF EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[SpHClSCargaHojaCtesTodas]') AND type in (N'P', N'PC'))
	DROP PROCEDURE [dbo].[SpHClSCargaHojaCtesTodas]
GO

SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO
    
/*********************************************************************
* FUNCION  : Devuelve los datos de todas las hojas de constantes menos la seleccionada
* DEVUELVE : 
* FECHA	   : 16-11-2006
* VERSION  : 1.0
* AUTOR	   : Teresa L Fabuel Serrano
* APLICACION ORIGEN: FEnfHojaCtes
* MODIFICACIÓN : (11/01/2010) Teresa Lourdes Fabuel S. Se obtienen datos de base de datos de historificacion
* MODIFICACIÓN : (19/12/2012) Alberto Pagán CHC2334 v4.35 Release 1, devolver el campo Temperatura Rectal
* MODIFICACIÓN : (25/02/2013) Alberto Pagán - MAIPU CHC2336 - v4.38 - nuevo campo Observaciones
* MODIFICACIÓN : (10/09/2013) CTF - 73569626D - CHC3184 - REQ27180  - v4.40 -  Modificacion de campo glicemia
* MODIFICACIÓN : (21/08/2017) - V17.3 - 16489 - APB - Volumen ingerido de Control de Ingesta a Balances
*********************************************************************/ 

CREATE PROCEDURE [dbo].[SpHClSCargaHojaCtesTodas] 
	 @spvar_strcodpaciente char(16)
	,@spvar_strcodepisodio char(5)
	,@spvar_fecha smalldatetime
AS

Create Table #CFrecuentes (Fecha smalldatetime
						  ,Temperatura real null
						  ,TAS smallint null
						  ,TAD smallint null
						  ,FCard tinyint null
						  ,PVC int null
						  ,FResp tinyint null
						  ,Diuresis decimal(10,2) null
						  --CTF - 73569626D - CHC3184 - REQ27180  - v4.40 -  Modificacion de campo glicemia
						  --,Glucemia smallint null
						  ,Glucemia varchar(8) null				  
						  ,EVA smallint null
						  ,Saturacion smallint null 
						  --CHC2334 v4.35 Release 1 Alberto Pagán, devolver el campo Temperatura Rectal
						  ,TemperaturaRectal real null
						  --CHC2334 v4.35 Release 1 Alberto Pagán, Fin
						  ,Observaciones varchar(200) null --Alberto Pagán - MAIPU CHC2336 - v4.38 - 25/02/2013
						  )

If not exists (Select *
	           From Ingresos..ValoresDiarios VD
	           Where VD.CodPaciente=@spvar_strcodpaciente and VD.CodEpisodio=@spvar_strcodepisodio and convert(char(10),FecValDia,103)=convert(char(10),@spvar_fecha,103))

Begin
Select PesValDia,
       NutParenteral,
       NutOral,
       NutEnteral,
       CantAspira,
       CantVomito,
       CantDeposic,
       CantDrenaRedon,
       CantDrenaGast,
       CantDrenaTorac,
       FecValDia,
	   Talla,
	   CC,
	   Observaciones --Alberto Pagán - MAIPU CHC2336 - v4.38 - 25/02/2013
From 
	   Historificacion..Ingresos_ValoresDiarios
Where 
	  CodPaciente=@spvar_strcodpaciente And
      CodEpisodio=@spvar_strcodepisodio And
      convert(char(10),FecValDia,103)=convert(char(10),@spvar_fecha,103)

Insert 
		#CFrecuentes
Select	
		Fecha,null,null,null,null,null,null,null,null,null,null
		----CHC2334 v4.35 Release 1 Alberto Pagán, devolver el campo Temperatura Rectal
		,null
		----CHC2334 v4.35 Release 1 Alberto Pagán, Fin
		,null --Alberto Pagán - MAIPU CHC2336 - v4.38 - 25/02/2013
From 
		Historificacion..HClinica_ConstanteTemperatura
Where 
		CodPaciente=@spvar_strcodpaciente And
		CodEpisodio=@spvar_strcodepisodio

Union

Select 
		Fecha,null,null,null,null,null,null,null,null,null,null
		----CHC2334 v4.35 Release 1 Alberto Pagán, devolver el campo Temperatura Rectal
		,null
		----CHC2334 v4.35 Release 1 Alberto Pagán, Fin
		,null --Alberto Pagán - MAIPU CHC2336 - v4.38 - 25/02/2013
From 
		Historificacion..HClinica_TArterial
Where 
		CodPaciente=@spvar_strcodpaciente And
		CodEpisodio=@spvar_strcodepisodio

Union

Select 
		FLecturaDatos,null,null,null,null,null,null,null,null,null,null
		----CHC2334 v4.35 Release 1 Alberto Pagán, devolver el campo Temperatura Rectal
		,null
		----CHC2334 v4.35 Release 1 Alberto Pagán, Fin
		,null --Alberto Pagán - MAIPU CHC2336 - v4.38 - 25/02/2013
From 
		Historificacion..HClinica_ParametrosCardiacos
Where 
		CodPaciente=@spvar_strcodpaciente And
		CodEpisodio=@spvar_strcodepisodio

Union

Select	
		Fecha,null,null,null,null,null,null,null,null,null,null
		----CHC2334 v4.35 Release 1 Alberto Pagán, devolver el campo Temperatura Rectal
		,null
		----CHC2334 v4.35 Release 1 Alberto Pagán, Fin
		,null --Alberto Pagán - MAIPU CHC2336 - v4.38 - 25/02/2013
From 
		Historificacion..HClinica_PVC
Where 
		CodPaciente=@spvar_strcodpaciente And
		CodEpisodio=@spvar_strcodepisodio

Union
	
Select 
		FLecturaDatos,null,null,null,null,null,null,null,null,null,null
		----CHC2334 v4.35 Release 1 Alberto Pagán, devolver el campo Temperatura Rectal
		,null
		----CHC2334 v4.35 Release 1 Alberto Pagán, Fin
		,null --Alberto Pagán - MAIPU CHC2336 - v4.38 - 25/02/2013
From  
		Historificacion..HClinica_ParametrosRespiratorios
Where 
		CodPaciente=@spvar_strcodpaciente And
		CodEpisodio=@spvar_strcodepisodio

Union
		
Select	
		Fecha,null,null,null,null,null,null,null,null,null,null
		----CHC2334 v4.35 Release 1 Alberto Pagán, devolver el campo Temperatura Rectal
		,null
		----CHC2334 v4.35 Release 1 Alberto Pagán, Fin
		,null --Alberto Pagán - MAIPU CHC2336 - v4.38 - 25/02/2013
From 
		Historificacion..HClinica_Diuresis
Where 
		CodPaciente=@spvar_strcodpaciente And
		CodEpisodio=@spvar_strcodepisodio

Union
		
Select	
		Fecha,null,null,null,null,null,null,null,null,null,null
		----CHC2334 v4.35 Release 1 Alberto Pagán, devolver el campo Temperatura Rectal
		,null
		----CHC2334 v4.35 Release 1 Alberto Pagán, Fin
		,null --Alberto Pagán - MAIPU CHC2336 - v4.38 - 25/02/2013
From 
		Historificacion..HClinica_Glucemia
Where 
		CodPaciente=@spvar_strcodpaciente And
		CodEpisodio=@spvar_strcodepisodio

union

Select	
		Fecha,null,null,null,null,null,null,null,null,null,null
		----CHC2334 v4.35 Release 1 Alberto Pagán, devolver el campo Temperatura Rectal
		,null
		----CHC2334 v4.35 Release 1 Alberto Pagán, Fin
		,null --Alberto Pagán - MAIPU CHC2336 - v4.38 - 25/02/2013
From 
		Historificacion..HClinica_EVA
Where 
		CodPaciente=@spvar_strcodpaciente And
		CodEpisodio=@spvar_strcodepisodio

union

Select	
		Fecha,null,null,null,null,null,null,null,null,null,null
		----CHC2334 v4.35 Release 1 Alberto Pagán, devolver el campo Temperatura Rectal
		,null
		----CHC2334 v4.35 Release 1 Alberto Pagán, Fin
		,null --Alberto Pagán - MAIPU CHC2336 - v4.38 - 25/02/2013
From 
		Historificacion..HClinica_Saturacion
Where 
		CodPaciente=@spvar_strcodpaciente And
		CodEpisodio=@spvar_strcodepisodio

-----------------------------------
Update 
		#CFrecuentes
Set 
		#CFrecuentes.Temperatura=T.Temperatura
		--CHC2334 v4.35 Release 1 Alberto Pagán, devolver el campo Temperatura Rectal
		,#CFrecuentes.TemperaturaRectal=T.TemperaturaRectal
		--CHC2334 v4.35 Release 1 Alberto Pagán, Fin		
From 
		#CFrecuentes #CFrecuentes,
        Historificacion..HClinica_ConstanteTemperatura T
Where 
		T.CodPaciente=@spvar_strcodpaciente And
		T.CodEpisodio=@spvar_strcodepisodio
 And
		#CFrecuentes.Fecha=T.Fecha

Update 
		#CFrecuentes
Set 
		#CFrecuentes.TAS=TA.TAS,
		#CFrecuentes.TAD=TA.TAD
From 
		#CFrecuentes #CFrecuentes,
        Historificacion..HClinica_TArterial TA
Where 
		TA.CodPaciente=@spvar_strcodpaciente And
		TA.CodEpisodio=@spvar_strcodepisodio
 And
		#CFrecuentes.Fecha=TA.Fecha

Update 
		#CFrecuentes
Set 
		#CFrecuentes.FCard=FC.Frecuencia
From 
		#CFrecuentes #CFrecuentes,
        Historificacion..HClinica_ParametrosCardiacos FC
Where 
		FC.CodPaciente=@spvar_strcodpaciente And
		FC.CodEpisodio=@spvar_strcodepisodio
 And
		#CFrecuentes.Fecha=FC.FLecturaDatos

Update 
		#CFrecuentes
Set 
		#CFrecuentes.PVC=T.PVC
From 
		#CFrecuentes #CFrecuentes,
        Historificacion..HClinica_PVC T
Where 
		T.CodPaciente=@spvar_strcodpaciente And
		T.CodEpisodio=@spvar_strcodepisodio
 And
		#CFrecuentes.Fecha=T.Fecha

Update 
		#CFrecuentes
Set 
		#CFrecuentes.FResp=FR.Frecuencia
From 
		#CFrecuentes #CFrecuentes,
        Historificacion..HClinica_ParametrosRespiratorios FR
Where 
		FR.CodPaciente=@spvar_strcodpaciente And
		FR.CodEpisodio=@spvar_strcodepisodio
 And
		#CFrecuentes.Fecha=FR.FLecturaDatos

Update	
		#CFrecuentes
Set  
		#CFrecuentes.Diuresis=D.Diuresis
From 
		#CFrecuentes #CFrecuentes,
        Historificacion..HClinica_Diuresis D
Where 
		D.CodPaciente=@spvar_strcodpaciente And
		D.CodEpisodio=@spvar_strcodepisodio
 And
		#CFrecuentes.Fecha=D.Fecha

Update	
		#CFrecuentes
Set  
		#CFrecuentes.Glucemia=G.Glucemia
From 
		#CFrecuentes #CFrecuentes,
        Historificacion..HClinica_Glucemia G
Where 
		G.CodPaciente=@spvar_strcodpaciente And
		G.CodEpisodio=@spvar_strcodepisodio
 And
		#CFrecuentes.Fecha=G.Fecha

Update	
		#CFrecuentes
Set  
		#CFrecuentes.EVA=E.EVA
From 
		#CFrecuentes #CFrecuentes,
        Historificacion..HClinica_EVA E
Where 
		E.CodPaciente=@spvar_strcodpaciente And
		E.CodEpisodio=@spvar_strcodepisodio
 And
		#CFrecuentes.Fecha=E.Fecha

Update	
		#CFrecuentes
Set  
		#CFrecuentes.Saturacion=S.Saturacion
From 
		#CFrecuentes #CFrecuentes,
        Historificacion..HClinica_Saturacion S
Where 
		S.CodPaciente=@spvar_strcodpaciente And
		S.CodEpisodio=@spvar_strcodepisodio
 And
		#CFrecuentes.Fecha=S.Fecha

End

Else
Begin
Select PesValDia,
       NutParenteral,
       NutOral,
       NutEnteral,
       CantAspira,
       CantVomito,
       CantDeposic,
       CantDrenaRedon,
       CantDrenaGast,
       CantDrenaTorac,
       FecValDia,
	   Talla,
	   CC,
	   Observaciones --Alberto Pagán - MAIPU CHC2336 - v4.38 - 25/02/2013
From 
	   Ingresos..ValoresDiarios
Where 
	  CodPaciente=@spvar_strcodpaciente And
      CodEpisodio=@spvar_strcodepisodio And
      convert(char(10),FecValDia,103)=convert(char(10),@spvar_fecha,103)

Insert 
		#CFrecuentes
Select	
		Fecha,null,null,null,null,null,null,null,null,null,null
		----CHC2334 v4.35 Release 1 Alberto Pagán, devolver el campo Temperatura Rectal
		,null
		----CHC2334 v4.35 Release 1 Alberto Pagán, Fin
		,null --Alberto Pagán - MAIPU CHC2336 - v4.38 - 25/02/2013
From 
		ConstanteTemperatura
Where 
		CodPaciente=@spvar_strcodpaciente And
		CodEpisodio=@spvar_strcodepisodio

Union

Select 
		Fecha,null,null,null,null,null,null,null,null,null,null
		----CHC2334 v4.35 Release 1 Alberto Pagán, devolver el campo Temperatura Rectal
		,null
		----CHC2334 v4.35 Release 1 Alberto Pagán, Fin
		,null --Alberto Pagán - MAIPU CHC2336 - v4.38 - 25/02/2013
From 
		TArterial
Where 
		CodPaciente=@spvar_strcodpaciente And
		CodEpisodio=@spvar_strcodepisodio

Union

Select 
		FLecturaDatos,null,null,null,null,null,null,null,null,null,null
		----CHC2334 v4.35 Release 1 Alberto Pagán, devolver el campo Temperatura Rectal
		,null
		----CHC2334 v4.35 Release 1 Alberto Pagán, Fin
		,null --Alberto Pagán - MAIPU CHC2336 - v4.38 - 25/02/2013
From 
		ParametrosCardiacos
Where 
		CodPaciente=@spvar_strcodpaciente And
		CodEpisodio=@spvar_strcodepisodio

Union

Select	
		Fecha,null,null,null,null,null,null,null,null,null,null
		----CHC2334 v4.35 Release 1 Alberto Pagán, devolver el campo Temperatura Rectal
		,null
		----CHC2334 v4.35 Release 1 Alberto Pagán, Fin
		,null --Alberto Pagán - MAIPU CHC2336 - v4.38 - 25/02/2013
From 
		PVC
Where 
		CodPaciente=@spvar_strcodpaciente And
		CodEpisodio=@spvar_strcodepisodio

Union
	
Select 
		FLecturaDatos,null,null,null,null,null,null,null,null,null,null
		----CHC2334 v4.35 Release 1 Alberto Pagán, devolver el campo Temperatura Rectal
		,null
		----CHC2334 v4.35 Release 1 Alberto Pagán, Fin
		,null --Alberto Pagán - MAIPU CHC2336 - v4.38 - 25/02/2013
From  
		ParametrosRespiratorios
Where 
		CodPaciente=@spvar_strcodpaciente And
		CodEpisodio=@spvar_strcodepisodio

Union
		
Select	
		Fecha,null,null,null,null,null,null,null,null,null,null
		----CHC2334 v4.35 Release 1 Alberto Pagán, devolver el campo Temperatura Rectal
		,null
		----CHC2334 v4.35 Release 1 Alberto Pagán, Fin
		,null --Alberto Pagán - MAIPU CHC2336 - v4.38 - 25/02/2013
From 
		Diuresis
Where 
		CodPaciente=@spvar_strcodpaciente And
		CodEpisodio=@spvar_strcodepisodio

Union
		
Select	
		Fecha,null,null,null,null,null,null,null,null,null,null
		----CHC2334 v4.35 Release 1 Alberto Pagán, devolver el campo Temperatura Rectal
		,null
		----CHC2334 v4.35 Release 1 Alberto Pagán, Fin
		,null --Alberto Pagán - MAIPU CHC2336 - v4.38 - 25/02/2013
From 
		Glucemia
Where 
		CodPaciente=@spvar_strcodpaciente And
		CodEpisodio=@spvar_strcodepisodio

union

Select	
		Fecha,null,null,null,null,null,null,null,null,null,null
		----CHC2334 v4.35 Release 1 Alberto Pagán, devolver el campo Temperatura Rectal
		,null
		----CHC2334 v4.35 Release 1 Alberto Pagán, Fin
		,null --Alberto Pagán - MAIPU CHC2336 - v4.38 - 25/02/2013
From 
		EVA
Where 
		CodPaciente=@spvar_strcodpaciente And
		CodEpisodio=@spvar_strcodepisodio

union

Select	
		Fecha,null,null,null,null,null,null,null,null,null,null
		----CHC2334 v4.35 Release 1 Alberto Pagán, devolver el campo Temperatura Rectal
		,null
		----CHC2334 v4.35 Release 1 Alberto Pagán, Fin
		,null --Alberto Pagán - MAIPU CHC2336 - v4.38 - 25/02/2013
From 
		Saturacion
Where 
		CodPaciente=@spvar_strcodpaciente And
		CodEpisodio=@spvar_strcodepisodio

-----------------------------------
Update 
		#CFrecuentes
Set 
		#CFrecuentes.Temperatura=T.Temperatura
		--CHC2334 v4.35 Release 1 Alberto Pagán, devolver el campo Temperatura Rectal
		,#CFrecuentes.TemperaturaRectal=T.TemperaturaRectal
		--CHC2334 v4.35 Release 1 Alberto Pagán, Fin
From 
		#CFrecuentes #CFrecuentes,
        ConstanteTemperatura T
Where 
		T.CodPaciente=@spvar_strcodpaciente And
		T.CodEpisodio=@spvar_strcodepisodio
 And
		#CFrecuentes.Fecha=T.Fecha

Update 
		#CFrecuentes
Set 
		#CFrecuentes.TAS=TA.TAS,
		#CFrecuentes.TAD=TA.TAD
From 
		#CFrecuentes #CFrecuentes,
        TArterial TA
Where 
		TA.CodPaciente=@spvar_strcodpaciente And
		TA.CodEpisodio=@spvar_strcodepisodio
 And
		#CFrecuentes.Fecha=TA.Fecha

Update 
		#CFrecuentes
Set 
		#CFrecuentes.FCard=FC.Frecuencia
From 
		#CFrecuentes #CFrecuentes,
        ParametrosCardiacos FC
Where 
		FC.CodPaciente=@spvar_strcodpaciente And
		FC.CodEpisodio=@spvar_strcodepisodio
 And
		#CFrecuentes.Fecha=FC.FLecturaDatos

Update 
		#CFrecuentes
Set 
		#CFrecuentes.PVC=T.PVC
From 
		#CFrecuentes #CFrecuentes,
        PVC T
Where 
		T.CodPaciente=@spvar_strcodpaciente And
		T.CodEpisodio=@spvar_strcodepisodio
 And
		#CFrecuentes.Fecha=T.Fecha

Update 
		#CFrecuentes
Set 
		#CFrecuentes.FResp=FR.Frecuencia
From 
		#CFrecuentes #CFrecuentes,
        ParametrosRespiratorios FR
Where 
		FR.CodPaciente=@spvar_strcodpaciente And
		FR.CodEpisodio=@spvar_strcodepisodio
 And
		#CFrecuentes.Fecha=FR.FLecturaDatos

Update	
		#CFrecuentes
Set  
		#CFrecuentes.Diuresis=D.Diuresis
From 
		#CFrecuentes #CFrecuentes,
        Diuresis D
Where 
		D.CodPaciente=@spvar_strcodpaciente And
		D.CodEpisodio=@spvar_strcodepisodio
 And
		#CFrecuentes.Fecha=D.Fecha

Update	
		#CFrecuentes
Set  
		#CFrecuentes.Glucemia=G.Glucemia
From 
		#CFrecuentes #CFrecuentes,
        Glucemia G
Where 
		G.CodPaciente=@spvar_strcodpaciente And
		G.CodEpisodio=@spvar_strcodepisodio
 And
		#CFrecuentes.Fecha=G.Fecha

Update	
		#CFrecuentes
Set  
		#CFrecuentes.EVA=E.EVA
From 
		#CFrecuentes #CFrecuentes,
        EVA E
Where 
		E.CodPaciente=@spvar_strcodpaciente And
		E.CodEpisodio=@spvar_strcodepisodio
 And
		#CFrecuentes.Fecha=E.Fecha

Update	
		#CFrecuentes
Set  
		#CFrecuentes.Saturacion=S.Saturacion
From 
		#CFrecuentes #CFrecuentes,
        Saturacion S
Where 
		S.CodPaciente=@spvar_strcodpaciente And
		S.CodEpisodio=@spvar_strcodepisodio
 And
		#CFrecuentes.Fecha=S.Fecha

End

Select Fecha
	  ,Temperatura
	  ,TAS
	  ,TAD
	  ,FCard
	  ,PVC
	  ,FResp
	  ,Diuresis
	  ,Glucemia
	  ,EVA
	  ,Saturacion
	  --CHC2334 v4.35 Release 1 Alberto Pagán, devolver el campo Temperatura Rectal
	  ,TemperaturaRectal
	  --CHC2334 v4.35 Release 1 Alberto Pagán, Fin
	  ,Observaciones --Alberto Pagán - MAIPU CHC2336 - v4.38 - 25/02/2013

From 
	  #CFrecuentes

Order By 
	  Fecha

GO
GO



--dbo.SpHClSCMost.sql

USE [Hclinica]
GO

IF EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[SpHClSCMost]') AND type in (N'P', N'PC'))
	DROP PROCEDURE [dbo].[SpHClSCMost]
GO

/*********************************************************************
* FUNCION: Obtiene los datos del cierre del paciente
* DEVUELVE:
* FECHA: 23/09/2005
* VERSION: 1.0
* AUTOR: Desiderio Marti (Mecemsa)
* ORIGEN: Mantenimiento Pacientes, Antecedentes familiares
* MODIFICACIÓN: (18/11/2015) - V4.56 - 2652 - SGN - Incorporar médico cierre por defunción
* MODIFICACIÓN: (12/07/2016) - V4.59r8 - 3325 - DCR - Campo Control si se realiza Alta por Fallecimiento desde historia clinica
* MODIFICACIÓN: (29/03/2016) - V4.60 - 1970 - LMF - Se añaden los descriptivos de los motivos
* MODIFICACIÓN: (10/07/2017) - V17.2r1 - 18466 - APB - Folio y Certificado de Defunción
'*******************************************************************/

CREATE PROCEDURE [dbo].[SpHClSCMost]
	@spvar_CodPaciente char(16) 
AS

SELECT  P.FecFin
       ,E.MotivoFundamental
       ,E.MotivoInmediato
       ,E.MotivoIntermedio
       ,E.Obs
       ,E.DNIMedico
       ,RTRIM(USU.Nombre) + ' ' + RTRIM(USU.Apellido1) + ' ' + RTRIM(USU.Apellido2) as NombreMedico
	   ,E.RegistroHC
       ,CieInm.DescDiagnostico as DescMotivoInmediato
	   ,CieInt.DescDiagnostico as DescMotivoIntermedio
	   ,CieFun.DescDiagnostico as DescMotivoFundamental
	   ,E.Folio
	   ,'NombreUsuario' = USU.NombreCompleto
	   ,'RutMedico' = HClinica.dbo.fnHClFormatoRUNConDigitoControl(USU.NIF)
       ,'Paciente' = RTRIM(P.PacNombre) + ' ' + RTRIM(P.PacApell1) + ' ' + RTRIM(P.PacApell2)
	   ,P.FecNac
	   ,P.Genero
	   ,'Sexo' = Sexo.Descripcion
	   ,'RUN' = HClinica.dbo.fnHClFormatoRUNConDigitoControl(P.NumTarjSanitaria)

FROM	Hclinica..Pacientes P
		INNER JOIN Hclinica..Exitus E ON P.CodPaciente = E.CodPaciente
		LEFT JOIN Parametros..vParDatosUsuarios USU ON E.DNIMedico = USU.Dni
		LEFT JOIN Parametros..CIEDiagnostico CieInm On CieInm.CodDiagnostico = E.MotivoInmediato
		LEFT JOIN Parametros..CIEDiagnostico CieInt On CieInt.CodDiagnostico = E.MotivoIntermedio
		LEFT JOIN Parametros..CIEDiagnostico CieFun On CieFun.CodDiagnostico = E.MotivoFundamental
		LEFT JOIN Parametros..Codigos Sexo ON Sexo.Tabla = 'EstGenero' AND P.Genero = Sexo.Codigo

WHERE P.CodPaciente = @spvar_CodPaciente  
        
GO
GO



--dbo.SpHClSExistenOtrasCitasYaTratada.sql

 USE [HClinica];
    GO
    IF EXISTS 
    (
        SELECT * 
            FROM sys.procedures 
            WHERE [object_id] = OBJECT_ID('[dbo].[spHCISExistenOtrasCitasYaTratada]')
    )
    BEGIN
        DROP PROCEDURE [dbo].[spHCISExistenOtrasCitasYaTratada];
    END
    GO
-- =======================================================================================================================================
-- CREACION:		(18/07/2017) - v17.2r1 - 19238 - LMF - H.Papel con doble estado
-- FECHA CREACIÓN:	15/06/2015
-- DESCRIPCION:		Obiene los archivos fisicos de las citas ya tratadas 
-- ORIGEN:			FBusArchivoFisico
-- =======================================================================================================================================

CREATE PROCEDURE [dbo].[spHCISExistenOtrasCitasYaTratada]
	  @spvar_CodPaciente varchar(16)
	 ,@spvar_CodCentro varchar(5)
	 ,@spvar_CodHistoriaPapel varchar(10)
	 ,@spvar_FechaCita smalldatetime
	 ,@spvar_CodServicio char(4)
	 ,@spvar_Agenda varchar(50)
	 ,@spvar_Consulta char(30)

AS
BEGIN
	SELECT	 A.CodPaciente
			,A.CodEpisodio
			,A.CodCentro
			,A.CodConsulta
			,A.FechaCita
			,A.CodHistoriaPapel
			,A.Estado
			,S.DescServicio
			,A.Consulta
			,A.Agenda

	FROM Hclinica..ArchivoCitas A
	LEFT JOIN Parametros..Servicios S ON S.Codigo = A.CodServicio
	WHERE	A.CodPaciente = @spvar_CodPaciente
		AND A.CodCentro = @spvar_CodCentro
		AND A.CodHistoriaPapel = @spvar_CodHistoriaPapel
		AND A.Estado IN (1,2)
		AND (	( A.FechaCita <> @spvar_FechaCita  )  
			OR	( A.CodServicio <> @spvar_CodServicio )  
			OR	( A.Consulta <> @spvar_Consulta   )  
			OR	( A.Agenda <> @spvar_Agenda ) 
) 
		

END

GO



--dbo.SpHClSFolioEnUso.sql

USE [Hclinica]
GO

IF EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[SpHClSFolioEnUso]') AND type in (N'P', N'PC'))
	DROP PROCEDURE [dbo].[SpHClSFolioEnUso]
GO

/*********************************************************************
* FUNCION: Comprueba si el número de folio pasado por parámetro está siendo utilizado por otro paciente distinto
* DEVUELVE:	Nombre completo del paciente que usa el número de folio pasado por parámetro
* FECHA: 10/07/2017
* VERSION: V17.2r1 - 18466 - Folio y Certificado de Defunción
* AUTOR: Alberto Pagán Benedicto
'*******************************************************************/

CREATE PROCEDURE [dbo].SpHClSFolioEnUso
	 @spvar_CodPaciente char(16)
	,@spvar_Folio bigint
AS

SELECT RTRIM(P.PacNombre) + ' ' + RTRIM(P.PacApell1) + ' ' + RTRIM(P.PacApell2) AS Paciente
FROM Hclinica..Exitus E
     INNER JOIN Hclinica..Pacientes P ON E.CodPaciente = P.CodPaciente 
WHERE E.Folio = @spvar_Folio AND
	  E.CodPaciente <> @spvar_CodPaciente

GO
GO



--dbo.SpHClSListadoHojasPreoperatorias.sql

    USE [HClinica];
    GO
    IF EXISTS 
    (
        SELECT * 
            FROM sys.procedures 
            WHERE [object_id] = OBJECT_ID('[dbo].[SpHClSListadoHojasPreoperatorias]')
    )
    BEGIN
        DROP PROCEDURE [dbo].[SpHClSListadoHojasPreoperatorias];
    END
GO
    
/*
PROCEDIMIENTO	: SpHClSListadoHojasPreoperatorias
FUNCION			: 
DEVUELVE		: Las hojas preoperatorias de todos los pacientes.
FECHA			: 11/10/2006
VERSION			: 1.0
AUTOR			: Teresa L Fabuel Serrano
REVISION		: (06/11/2007) Teresa L F Serrano. Devuelve la jornada extra valida de Preoperatoria y Anestesia
				: (14/12/2007) Teresa L Fabuel S. Devuelve asq de enfermeria
				: (17/01/2008) azaragoza. Devuelve las observaciones de la preoperatoria.
-- ************************************************
-- Revision:	(26/02/08) Ismael Sampere 
--				añadido nuevo campo de observaciones(ObservPreAnestesia)
-- ************************************************
-- Revision:	(11/09/08) Ismael Sampere 
--				añadido nuevo campo Aseguradora
-- ************************************************
-- Revision:	(12/09/08) Ismael Sampere 
--				Añadido nuevo campo CMAsinHDIA para un nuevo tipo de intervencion
-- ************************************************
-- Revision:	(29/10/2008) Teresa L Fabuel Serrano. Se añade nuevo campo Complejidad.
-- ************************************************
-- Revision:	(28/01/2009) Ismael Sampere - Ampliacion del campo CodHistoria.
-- ************************************************
-- Revision:	(12/02/09) MPS Sacar la FActivo si no es nula. Si es nula, sacar la FPreoperatoria.
-- ************************************************
-- Revision:	(09/03/09) Ismael Sampere - Añadido el campo DniCirujanoPrevisto
-- ************************************************
-- Revision:	(25/03/09) Ismael Sampere - Añadidas las observaciones de enfermeria
-- ************************************************
-- Revision:	(31/03/09) Ismael Sampere - Corregido el filtro por fecha de preoperatoria
-- ************************************************
-- Revision:	(06/04/09) Ismael Sampere - Añadido el campo de observaciones de la preanestesia
-- ************************************************
-- Revision:    (08/04/09) Ismael Sampere - nuevo campo Neoplasia
-- ************************************************
-- Revision:    (03/06/09) Jesús Mañogil (Mecemsa)
--			    Nuevos campos: AvisadoPac, CodAvisoPac, ObservacionesAvisadoPac
-- ************************************************
-- Revision:    (22/06/09) Joaquín Aniorte
--			    Nuevos campos: DescComplejidad para complejidad preoperatoria
-- ************************************************
-- Revision:    (30/06/09) Joaquín Aniorte
--			    Corregido cruce de Servicio
-- ************************************************
-- Revision:    (02/09/09) Joaquín Aniorte
--			    Nuevo campo: Intervención Especial
-- ************************************************
-- Revision:    (03/09/09) Joaquín Aniorte
--			    Nuevo campo: UHD
-- ************************************************
-- Revision:    (07/09/09) Joaquín Aniorte
--			    Nuevos campos: Nombre y DNI del cirujano
--				que realiza la operación
-- ************************************************
-- Revision:    (28/09/09) Joaquín Aniorte
--				Resuelto error con cruce cuando el cirujano pasado
--				por parametro es el que realiza la intervención y no
--				el cirujano previsto.
-- ************************************************
-- Revision:    (18/01/2010) Joaquín Aniorte
				Se añade el campo Duracion del informe de preanestesia a la selección.
-- ************************************************
-- Revision:    (08/02/2010) Joaquín Aniorte
				Se añade la fecha de anestesia a la selección.
-- ************************************************
-- Revision:    (23/03/2010) Joaquín Aniorte
				Se cruza la fecha de anestesia con el código de intervención.				
-- ************************************************
-- Revision:    (23/03/2010) Joaquín Aniorte
				Añadadidos ProgManana, PrimeraHora y NoUCSI
-- ************************************************
-- Revision:    (30/03/2010) Joaquín Aniorte
				Añadadido Estado
-- ************************************************
-- MODIFICADO:  (21/09/2010) Teresa L Fabuel. Se añaden parametros @spvar_FDesdePrevInterv y @spvar_FHastaPrevInterv. Se obtiene el numero de ayudantes.
--							Por recomendacion de los dbas se quita el código de sql dinámico.
-- ************************************************
--  MODIFICACIÓN: Alfredo - CHC2053 - Se devuelven nuevos campos
--  MODIFICACION: 22/11/2012 Fran Cuenca CHC2360 - Normalizar el archivo historia en papel
--  MODIFICACION: Alfredo - chc2407 - añado el segundo apellido
--  MODIFICACION: 10/07/2013 25412344N - CHC2947 - REQ27104 - v4.40 - CREACIÓN DE COMBOBOX PREFERENTE MODULO QUIROFANO 	
--	MODIFICACION: MAJL CHC3301 v4.40 r2 (29/08/2013) Multicentro Quirófanos								
--	MODIFICACION: v4.55r6 - 3136 - CCM - Tooltip plano y extremidad intervenciones
--  MODIFICACION: (09/12/2015) César Moreno - V4.57 - 2721 - CMM - Requerimiento Pabellon(Validado)
--  MODIFICACION: v17.2 - 16143 - FCB - Quirófano – Listado de intervenciones
--  MODIFICACION: (19/05/2017) - 17.2 - 16506 - SGH - Filtros Prais Listados Sol. Interconsultas e Intervenciones
--  MODIFICACION: (03/07/2017) - 17.2r1 - 18844 - LMF - Error Filtros PRAIS_Listados Sol. Interconsultas e Intervenciones
*/

CREATE PROCEDURE [dbo].[SpHClSListadoHojasPreoperatorias]
		@spvar_finiprev smalldatetime = null, 
		@spvar_finipreo smalldatetime = null,
		@spvar_ffinprev smalldatetime = null, 
		@spvar_ffinpreo smalldatetime = null,
		@spvar_codhistoria varchar(8) = null,
		@spvar_episodio char(5) = null,
		@spvar_preanestesia char(1) = '',
		@spvar_progurg char(1)='',
		@spvar_medico char(8) = '',
		@spvar_servicio char(4) = '',
		@spvar_FDesdePrevInterv datetime = null,
		@spvar_FHastaPrevInterv datetime = null,
		@CodCentro CHAR(5) = NULL,
		@spvar_PRAIS bit = null,
		@spvar_CodColectivo varchar(5) = null
AS

select @CodCentro = ISNULL(@CodCentro, parametros.dbo.fnParHospitalReferencia()) 

Select @spvar_finiprev= CONVERT(smalldatetime, convert(varchar,@spvar_finiprev,101)+' 0:00')
Select @spvar_ffinprev= CONVERT(smalldatetime, convert(varchar,@spvar_ffinprev,101)+' 23:59:59')
Select @spvar_finipreo= CONVERT(smalldatetime, convert(varchar,@spvar_finipreo,101)+' 0:00')
Select @spvar_ffinpreo= CONVERT(smalldatetime, convert(varchar,@spvar_ffinpreo,101)+' 23:59:59')

DECLARE @ServicioAnestesia char(4)

SELECT @ServicioAnestesia = ValorConstante
FROM Parametros..Constantes
WHERE NombreConstante = 'm_strCodigoAnestesia'
						
SELECT	FPrevista, 
		coalesce(FActivo,FPreoperatoria) as FPreoperatoria, 
		PA.CodHistoria as NHistoria, 
		P.CodEpisodio, 
		P.CodIntervencion,
		COALESCE(PRO2.DESCPROCED, pro.DescProced) as DescProcedimiento,
		DescDiagnostico as DescDiagnostico,
		CodHojaPreop, 
		PA.PacNombre as Nombre, 
		PA.PacApell1 as Apellido1, 
		PA.PacApell2 as Apellido2, 
		COALESCE(iq.codprocedimiento, P.CodProc) as CodProc,
		P.Tipo as Tipo, 
		P.Preanestesia as Preanestesia, 
		COALESCE(PM2.NomMedico ,PM.NomMedico) as NombreM, 
		COALESCE(PM2.Apell1 ,PM.Apell1) as ApellidoM1, 
		COALESCE(PM2.Apell2 ,PM.Apell2)as ApellidoM2, 
		P.PreopCompleto, 
		P.VistoBueno, 
		P.cirumenor,
		P.CSuspendida,
		realizada = case isnull(IQ.CodIntervencion,0)
					 when '0' then 0 else '1' end,
		PQ.Numero as Quirofano,
		P.CiruMenor,
		P.cma,
		P.Tipo,
		P.CodPaciente,
		MotivoPreferente = MP.DESCRIPCION,
		rtrim(COALESCE(PM2.NomMedico, PM.NomMedico)) + ' ' + rtrim(COALESCE(PM2.Apell1, PM.Apell1)) + ' ' + rtrim(COALESCE(PM2.Apell2, PM.Apell2)) as NombreMedico ,
		P.Servicio as CodServicioMedico,
		S.DescServicio as DescServicio,
		rtrim(PA.PacNombre)+ ' ' + rtrim(PA.PacApell1) + ' ' + rtrim(PA.PacApell2) as Paciente, 
		COALESCE(IQ.codmedinforma, P.DniCirujanoPrevisto) as DniMedicoPreop, 
		FPrevista, 
		TiempoOper, 
		NecesHemoderiv,
		FPasivo, 
		P.JornadaExtra,
		IA.JornadaExtra as JornadaAnestesia,
		IA.HInicioAnestesia  as FecIncioAnest,
		IQ.HInicioInter as FechaInfQuir,
		IQ.FInforme as FechaInforme,
		P.JornadaExtraVali as JornadaEP,
		IA.JornadaExtraVali as JornadaEA,
		HE.Asq as AsqEnf,
		HE.JornadaExtraVali as AsqEnfVali,
		P.ObservacionesPreoper,
		IA.ObservPreAnestesia,
		MUP.Entidad + '-' + MS.Entidad  as Aseguradora,
		P.CMAsinHDIA,
		P.Complejidad,
		P.ObsEnfermeria,
		IA.Observaciones,
		isnull(P.Neoplasia,0) as Neoplasia,
		isnull(P.AvisadoPac, 0) as AvisadoPac,
		P.CodAvisoPac,
		P.ObservacionesAvisadoPac,
		CP.DescComplejidad,
		P.IntervencionEspecial,
		P.UHD,
		RTRIM(LTRIM(PM3.NomMedico)) + ' ' + RTRIM(LTRIM(PM3.Apell1)) + ' ' + RTRIM(LTRIM(PM3.Apell2)) as CirujanoInterv,
		IQ.CodCirujano,
		IA.Duracion as DuracionPreAnest,
		CitaAnestesia = (
			SELECT MIN
			  (FechaCita)
			FROM 
				  Consultas..EpisodioConsultas e,
				  HClinica..Citas c, 
				  parametros..tiposconsultas t
			WHERE
					e.CodPaciente = p.CodPaciente 
					and e.CodEpisodioOrigen = p.CodEpisodio
					and e.CodIntervencion = p.CodIntervencion
					and e.CodPaciente = c.CodPaciente 
					and e.CodEpisodio = c.CodEpisodio
					and e.CodServicioFinal = '' + @ServicioAnestesia + ''
					and c.Codigoservicio = e.CodServicioFinal
					and c.CodigoServicio = t.CodServCons
					and c.CodTipoConsulta = t.CodTipoCons
					and c.CodTipoConsulta2 = t.CodClaseCOns
					and t.RequiereEpis = 0
		),
		IA.ProgManana,
        IA.PrimeraHora,
        IA.NoUCSI,
        IA.Estado,
        isnull(P.Ayudantes,0) as Ayudantes
        ,'RUN' = PA.NumTarjSanitaria
		,RIGHT('00000000' + LTRIM(RTRIM(AHP.CodHistoriaPapel)),8) as CodHistoriaPapel
        ,PA.FecNac
        ,'GES' = COALESCE(EH.EstadoGES, EU.EstadoGES, EC.EstadoGES)
        ,P.FIntervencion
        ,P.Eliminado
        ,'NumSuspensiones' = ISNULL(P.NumSuspensiones, 0)
        ,'ObsRelevantes' = P.Observaciones
		,P.Validado	
        , PL.DescPlano
		, CU.DescCuadrante
		,SE.DescServicio as Especialidad
		,CASE WHEN 
		(
			EXISTS (select * from Hclinica..MutuasSaludSecPaciente MSSP 
			INNER JOIN parametros..MutuasSalud MS on MS.Codigo = MSSP.CodColectivo
			where codpaciente = p.CodPaciente and MS.EsPrais = 1)
		) THEN 1 ELSE 0 END AS EsPRAIS	

FROM	HClinica..Preoperatoria P		
			INNER JOIN Hclinica..Pacientes PA ON PA.CodPaciente = P.CodPaciente 
			left join parametros..ParametrosMedicos PM on P.DniCirujanoPrevisto = PM.DNIMedico
			left join HClinica..HistoriaEnfermeria HE on P.CodIntervencion = HE.CodIntervencion
			left join parametros..Procedimientos pro on P.CodProc = pro.CodDiagnostico
			left join parametros..CIEDiagnostico cie on P.CodCIEPreop = cie.CodDiagnostico  
			left join HClinica..InformeQuirurgico IQ on p.CodIntervencion = IQ.CodIntervencion
			LEFT JOIN PARAMETROS..PROCEDIMIENTOS PRO2 ON PRO2.CodDiagnostico = iq.codprocedimiento
			LEFT JOIN PARAMETROS..ParametrosMedicos PM2 ON IQ.codmedinforma = PM2.DNIMedico
			left join HClinica..QuirofanosPlanning PQ on pq.CodIntervencion = p.CodIntervencion
			left join hclinica..InformeAnestesico IA on P.CodIntervencion = ia.CodIntervencion		
			left join parametros..servicios S on s.codigo = P.Servicio
			left join parametros..ComplejidadPreoperatoria CP on P.Servicio = CP.CodServicio
									and P.ComplejidadPreop = CP.CodComplejidad
									and P.CentroDestino = CP.CodCentro
			left join parametros..ParametrosMedicos PM3 ON IQ.CodCirujano = PM3.DNIMedico
			LEFT JOIN Hclinica..ArchivoHistoriasPapel AHP ON AHP.CodPaciente = P.CodPaciente 
									AND	AHP.CodCentro = @CodCentro
			LEFT JOIN Ingresos..EpisodioHospitalizacion EH ON EH.CodPaciente = P.CodPaciente
									AND EH.CodEpisodio = P.CodEpisodio
			LEFT JOIN Ingresos..EpisodioUrgencias EU ON EU.CodPaciente = P.CodPaciente
									AND EU.CodEpisodio = P.CodEpisodio
			LEFT JOIN Consultas..EpisodioConsultas EC ON EC.CodPaciente = P.CodPaciente
									AND EC.CodEpisodio = P.CodEpisodio
			LEFT JOIN Parametros..MotivosIntervencionPreferente MP ON P.CodMotivoPreferente= MP.CodMotivo
			LEFT JOIN Parametros..Planos PL ON PL.IDPlano = P.IdPlano
			LEFT JOIN Parametros..Cuadrantes CU ON CU.IdCuadrante = P.IdCuadrante
			LEFT JOIN Parametros..Servicios SE on SE.Codigo=P.CodEspecialidadUrg
			LEFT JOIN Parametros..MutuasSalud MS ON P.CodMutua = MS.Codigo
			LEFT JOIN Parametros..MutuaPrincipal MUP ON MS.CodMutua = MUP.Codigo
WHERE	

	P.CodPaciente = PA.CodPaciente 
	And ((@spvar_finiprev is null or @spvar_ffinprev is null)
		or
		(FPrevista  between @spvar_finiprev and @spvar_ffinprev)
	)
	And ((@spvar_finipreo is null or @spvar_ffinpreo is null)
		or
		(coalesce(FActivo,FPreoperatoria) between @spvar_finipreo and @spvar_ffinpreo)
	)
	And ((@spvar_codhistoria is null or @spvar_codhistoria = '')
		or
		(PA.CodHistoria = LTRIM(RTRIM(@spvar_codhistoria)) )
	)
	And ((@spvar_episodio is null or @spvar_episodio = '')
		Or
		(P.CodEpisodio = LTRIM(RTRIM(@spvar_episodio)) )
	)
	And (@spvar_medico = ''
		Or
		(	(P.DniCirujanoPrevisto = @spvar_medico and isnull(IQ.CodIntervencion,0) = 0)
			OR
			(IQ.CodCirujano = @spvar_medico and isnull(IQ.CodIntervencion,0) <> 0)
		)
	)
	And (@spvar_servicio = ''
		Or
		P.Servicio = @spvar_servicio
	)
	And ((@spvar_FDesdePrevInterv is null or @spvar_FHastaPrevInterv is null)
		or
		(FPrevistaIntervencion  between @spvar_FDesdePrevInterv and @spvar_FHastaPrevInterv)
	)
	And (@CodCentro is null or p.CentroDestino = @CodCentro)
	And (
			@spvar_PRAIS is null
			Or 
			(
				@spvar_PRAIS = 1 and 
				EXISTS (select MS.EsPrais from 
						Hclinica..MutuasSaludSecPaciente MSSP 
						INNER JOIN parametros..MutuasSalud MS on MS.Codigo = MSSP.CodColectivo
						where codpaciente = p.CodPaciente and MS.EsPrais = 1)
			)
			Or 
			(
				@spvar_PRAIS = 0 and 
				NOT EXISTS (select MS.EsPrais from 
							Hclinica..MutuasSaludSecPaciente MSSP 
							INNER JOIN parametros..MutuasSalud MS on MS.Codigo = MSSP.CodColectivo
							where codpaciente = p.CodPaciente and MS.EsPrais = 1)
			)
		)
	And (@spvar_CodColectivo IS NULL OR P.CodMutua = @spvar_CodColectivo)

ORDER BY FPreoperatoria	

GO

GO



--dbo.SpHClSListIntercons.sql

 USE [HClinica];
    GO
    IF EXISTS 
    (
        SELECT * 
            FROM sys.procedures 
            WHERE [object_id] = OBJECT_ID('[dbo].[SpHClSListIntercons]')
    )
    BEGIN
        DROP PROCEDURE [dbo].[SpHClSListIntercons];
    END
    GO
    


/*
PROCEDIMIENTO : [SpHClSListIntercons]
FUNCION: Listado de Interconsultas
DEVUELVE:
FECHA:03/04/2006
VERSION: 1.0
AUTOR: Javier Martín  Martínez
APLICACIÓN ORIGEN   : HClinica.FIntenpend
COMENTARIOS:
	@Procede:
	indica de que tabla se tienen que obtener los datos de interconsultas:
	    Consulta = 1
	    Hospitalizacion = 2
	    Urgencias = 3

REVISION: (23/10/2006) sonia

		Incluyo la comprobacion de la fecha de la interconsulta
		para obtener solo las solicitudes pendientes

Modificado: 13-11-2007 Meto el codigo del centro para sacar solo el centro destino.
		    25/02/2008 Ismael Añadidas modificaciones para contemplar Comites y Unidades de trabajo
			11/08/08 MPS añado unions para la tabla de EpisodioAttPrimaria
			12/08/08 MPS optimización
			20/08/2008 Ismael corregido el valor por defecto de la fecha final
			21/08/2008 Ismael corregida optimizacion
			02/10/2008 Ismael Cambiado tamaño codhistoria	
			05/06/2009 Oscar Vilella. Se incluye comprobacion de servicios secundarios del médico			
			06/07/2009 Oscar Vilella. Cruzamos las interconsultas con enfermeras y no sólo con médicos
			03/12/2009 Paco Aznar. Se obtienen las interconsultas dirigidas al departamento logado
			29/01/2010 Teresa L Fabuel. Se inserta en tabla temporal de servicios el servicio principal en caso que se logue con el secundario. 
			02/11/2015 - v4.56 - SGN - 2646 - Parametrización de Interconsulta interna
MODIFICACIÓN: (21/09/2016) - V4.64 - 13211 - CCM - Extraer maestro de Tabla Prioridades
MODIFICACIÓN: (21/08/2017) - V17.3 - 18454 - MPR - Modificaciones a Interconsultas Internas
*/

CREATE PROCEDURE [dbo].[SpHClSListIntercons]
	@spvar_cod_consulta varchar(6),
	@spvar_fechacita smalldatetime,
	@spvar_ListarPacientes bit = 0x1,
	@spvar_Procede int = null,
	@spvar_fechaFinal smalldatetime = null,
	@spvar_CodCentro char(5) = null,
	@spvar_DniMedico as char(9) = null
AS

declare @spvar_fechaInicial as smalldatetime

-- Se inicializan las fechas  
if @spvar_fechaFinal is null 
BEGIN
	select @spvar_fechaFinal = dateadd(day,1,@spvar_fechacita) 
	select @spvar_fechaInicial = dateadd(mm, -1, @spvar_fechacita)
END
else
	select @spvar_fechaInicial = @spvar_fechacita
			

BEGIN

-- tabla de servicios secundarios del médico
declare @tablaSecundarios as table
(
	CodServicio char(4)
)

INSERT INTO @tablaSecundarios  (CodServicio)
VALUES (@spvar_cod_consulta)

--Se inserta el servicio principal si todavia no está en la tabla
If (Select COUNT(*)
	From @tablaSecundarios TS, Parametros..ParametrosMedicos PM
	Where TS.CodServicio = PM.CodServicioMedico
	And PM.DNIMedico = @spvar_DniMedico
	) =0
Begin
	Insert into @tablaSecundarios (CodServicio)
	SELECT CodServicioMedico FROM Parametros..ParametrosMedicos
	WHERE DNIMedico = @spvar_DniMedico
End

-- Se insertan servicios secundarios
INSERT INTO @tablaSecundarios  (CodServicio)
SELECT CodServicio FROM Parametros..ServiciosMedicos 
WHERE NIFMedico = @spvar_DniMedico

-- tabla variable para guardar los datos 
declare @spvar_tablaDatos as table
(
	CodPaciente  varchar(16),
	CodHistoria  varchar(8),
	Nombre_Paciente  varchar(20) ,
	Primer_Apellido_Paciente  varchar(25),
	Segundo_Apellido_Paciente  varchar(25),
	Nombre_Medico  varchar(15),
	Primer_Apellido_Medico  varchar(15),
	Segundo_Apellido_Medico  varchar(15),
	Servicio  varchar(40),
	FechaSolic  smalldatetime,
	Solicitud  varchar(50),
	N_Cama  char(7),
	CodEpisodio  varchar(5),
	NifMedConsulta  varchar(8),
	Peticion  varchar(50),
	FechaConsulta  smalldatetime,
	tipo  char(1),
	CodServicioSolicita  varchar(4),
	ServicioDestino  varchar(100), 
	CodServicioDestino  varchar(3),
	IntCodServSalida varchar(3),
	IntTipo char(1),
	NombreMedicoConsulta varchar(100)
)

/********************* EPISODIOS DE URGENCIAS ***********************************************/

			--Unidades de Trabajo
			insert into @spvar_tablaDatos
			SELECT 	distinct 
							P.CodPaciente,
							P.codhistoria, 
							Nombre_Paciente=p.PacNombre,
							Primer_Apellido_Paciente=p.PacApell1,
							Segundo_Apellido_Paciente=p.PacApell2, 
							Nombre_Medico=M.Nombre,
							Primer_Apellido_Medico=M.Apellido1,
							Segundo_Apellido_Medico=M.Apellido2,
							S.DescServicio Servicio,
							I.FechaSolic,
							Solicitud=C.Descripcion,
							N_Cama = null,
							urg.CodEpisodio,
							I.NifMedConsulta,
							Peticion=C.Descripcion,
							I.FechaConsulta,
							tipo ='U',
							I.CodServSolic as CodServicioSolicita,
							cut.DescUnidad as ServicioDestino,
							ut.CodUnidad as CodServicioDestino,
							I.codservsalida,
							I.Tipo,
							RTRIM(M.Nombre + ' ' + M.Apellido1 + ' ' + M.Apellido2) as NombreMedicoConsulta

						FROM 	ingresos..Episodiourgencias urg,
								HClinica..Interconsulta I
									left join parametros..vParDatosUsuarios M on i.NifMedConsulta = m.dni
									/*LEFT JOIN Parametros..ParametrosMedicos MC ON i.NifMedConsulta = MC.DNIMedico*/
									/*left join parametros..DatosEnfermeras Enf on i.nifmedsolic = Enf.dnienf and puedeingresar is not null*/
									LEFT join parametros..CentrosSalud cs on cs.CodCentro = I.CodCentroSalida,
								parametros..unidadestrabajo ut,
								parametros..CodigosUnidadesTrabajo cut,
								HClinica..Pacientes P,
								parametros..Servicios S,
								parametros..PrioridadesClinicas C
						WHERE i.fechaconsulta is null
							and urg.codpaciente = i.codpaciente
							and urg.codepisodio = i.codepisodio
							and p.codpaciente = i.codpaciente
							and urg.fechasalida is null
							and urg.FechaEntrada is not null
							and I.CodServSolic=S.Codigo 
							and I.FechaSolic between @spvar_fechaInicial And  @spvar_fechafinal
							and I.Pedido=C.Codigo
							and (@spvar_CodCentro is null or cs.HospitalRef = @spvar_CodCentro)
							and i.CodServSalida = ut.CodUnidad
							and i.Tipo = 'U'
							and @spvar_DniMedico is not null 
							and ut.nif = @spvar_DniMedico
							and cut.codunidad = ut.codunidad
			

			--Comites clinicos
			insert into @spvar_tablaDatos
			SELECT 	distinct 
							P.CodPaciente,
							P.codhistoria, 
							Nombre_Paciente=p.PacNombre,
							Primer_Apellido_Paciente=p.PacApell1,
							Segundo_Apellido_Paciente=p.PacApell2, 
							Nombre_Medico=M.Nombre,
							Primer_Apellido_Medico=M.Apellido1,
							Segundo_Apellido_Medico=M.Apellido2,
							S.DescServicio Servicio,
							I.FechaSolic,
							Solicitud=C.Descripcion,
							N_Cama = null,
							urg.CodEpisodio,
							I.NifMedConsulta,
							Peticion=C.Descripcion,
							I.FechaConsulta,
							tipo ='U',
							I.CodServSolic as CodServicioSolicita,
							cc.DescComision as ServicioDestino,
							mc.codigocomision as CodServicioDestino,
							I.codservsalida,
							I.Tipo,
							/*RTRIM(LTRIM(MedC.NomMedico) + ' ' + LTRIM(MedC.Apell1) + ' ' + LTRIM(MedC.Apell2)) as NombreMedicoConsulta*/
							RTRIM(M.Nombre + ' ' + M.Apellido1 + ' ' + M.Apellido2) as NombreMedicoConsulta

						FROM 	ingresos..Episodiourgencias urg,
								HClinica..Interconsulta I
								left join parametros..CentrosSalud cs
									on cs.CodCentro = I.CodCentroSalida
								/*LEFT JOIN Parametros..ParametrosMedicos MedC ON i.NifMedConsulta = MedC.DNIMedico*/,
								parametros..miembroscomite mc,
								HClinica..Pacientes P,
								parametros..vParDatosUsuarios M,
								parametros..Servicios S,
								parametros..PrioridadesClinicas C,
								parametros..codigocomision cc

						WHERE i.fechaconsulta is null
							and urg.codpaciente = i.codpaciente
							and urg.codepisodio = i.codepisodio
							and p.codpaciente = i.codpaciente
							and urg.fechasalida is null
							and urg.FechaEntrada is not null
							and i.nifmedsolic = m.dni
							and I.CodServSolic=S.Codigo 
							and I.FechaSolic between @spvar_fechaInicial And  @spvar_fechafinal
							and I.Pedido=C.Codigo
							and (@spvar_CodCentro is null or cs.HospitalRef = @spvar_CodCentro)
							and i.CodServSalida = mc.CodigoComision
							and i.Tipo = 'C'
							and @spvar_DniMedico is not null 
							and mc.nif = @spvar_DniMedico
							and cc.Codigocomis = mc.codigocomision


			--Servicios
			insert into @spvar_tablaDatos
			SELECT 	distinct
							P.CodPaciente,
							P.codhistoria, 
							Nombre_Paciente=p.PacNombre,
							Primer_Apellido_Paciente=p.PacApell1,
							Segundo_Apellido_Paciente=p.PacApell2, 
							Nombre_Medico=M.Nombre,
							Primer_Apellido_Medico=M.Apellido1,
							Segundo_Apellido_Medico=M.Apellido2,
							S.DescServicio Servicio,
							I.FechaSolic,
							Solicitud=C.Descripcion,
							N_Cama = null,
							urg.CodEpisodio,
							I.NifMedConsulta,
							Peticion=C.Descripcion,
							I.FechaConsulta,
							tipo ='U',
							I.CodServSolic as CodServicioSolicita,
							S1.DescServicio as ServicioDestino,
							S1.Codigo as CodServicioDestino,
							I.codservsalida,
							I.Tipo,
							/*RTRIM(LTRIM(MedC.NomMedico) + ' ' + LTRIM(MedC.Apell1) + ' ' + LTRIM(MedC.Apell2)) as NombreMedicoConsulta*/
							RTRIM(M.Nombre + ' ' + M.Apellido1 + ' ' + M.Apellido2) as NombreMedicoConsulta

						FROM 	ingresos..Episodiourgencias urg,
								HClinica..Interconsulta I
									left join parametros..servicios s1 on i.CodServSalida = s1.Codigo
									left join parametros..centrossalud cs on cs.CodCentro = I.CodCentroSalida
									/*LEFT JOIN Parametros..ParametrosMedicos MedC ON i.NifMedConsulta = MedC.DNIMedico*/,
								HClinica..Pacientes P,
								parametros..vParDatosUsuarios M,
								parametros..Servicios S,
								parametros..PrioridadesClinicas C

						WHERE i.fechaconsulta is null
							and urg.codpaciente = i.codpaciente
							and urg.codepisodio = i.codepisodio
							and (@spvar_cod_consulta is null or i.codservsalida IN (SELECT CodServicio FROM @tablaSecundarios))
							and p.codpaciente = i.codpaciente
							and urg.fechasalida is null
							and urg.FechaEntrada is not null
							and i.nifmedsolic = m.dni
							and I.CodServSolic=S.Codigo 
							and I.FechaSolic between @spvar_fechaInicial And  @spvar_fechafinal
							and I.Pedido=C.Codigo
							and(@spvar_CodCentro is null or cs.HospitalRef = @spvar_CodCentro)
							and i.Tipo = 'S'
							

/********************* EPISODIOS DE URGENCIAS ***********************************************/

/********************* EPISODIOS DE CONSULTAS **********************************************/

			--Unidades de Trabajo
			insert into @spvar_tablaDatos
			SELECT 	distinct 
							P.CodPaciente,
							P.CodHistoria,
							Nombre_Paciente = p.PacNombre,
							Primer_Apellido_Paciente = p.PacApell1,
							Segundo_Apellido_Paciente = p.PacApell2, 
							Nombre_Medico = M.Nombre,
							Primer_Apellido_Medico = M.Apellido1,
							Segundo_Apellido_Medico = M.Apellido2,
							S.DescServicio Servicio,
							I.FechaSolic,
							Solicitud = C.Descripcion,
							N_Cama = NULL,
							con.CodEpisodio,
							I.NifMedConsulta,
							Peticion = C.Descripcion,
							I.FechaConsulta,
							tipo = 'C',
							I.CodServSolic as CodServicioSolicita,
							cut.DescUnidad as ServicioDestino,
							ut.CodUnidad as CodServicioDestino,
							I.codservsalida,
							I.Tipo,
							/*RTRIM(LTRIM(MedC.NomMedico) + ' ' + LTRIM(MedC.Apell1) + ' ' + LTRIM(MedC.Apell2)) as NombreMedicoConsulta*/
							RTRIM(M.Nombre + ' ' + M.Apellido1 + ' ' + M.Apellido2) as NombreMedicoConsulta

						FROM 	consultas..EpisodioConsultas Con,
								HClinica..Interconsulta I
									left join parametros..CentrosSalud cs
										on cs.CodCentro = I.CodCentroSalida
									/*LEFT JOIN Parametros..ParametrosMedicos MedC ON i.NifMedConsulta = MedC.DNIMedico*/,
								parametros..unidadestrabajo ut,
								parametros..CodigosUnidadesTrabajo cut,
								HClinica..Pacientes P,
								parametros..vParDatosUsuarios M,
								parametros..Servicios S,
								parametros..PrioridadesClinicas C
						WHERE i.fechaconsulta is null
							and con.codpaciente = i.codpaciente
							and con.codepisodio = i.codepisodio
							and p.codpaciente = i.codpaciente
							and con.fechacierre is null
							and con.Fechainicial is not null 
							and i.nifmedsolic = m.dni
							and I.CodServSolic = S.Codigo 
							and I.FechaSolic between @spvar_fechaInicial And  @spvar_fechafinal
							and I.Pedido = C.Codigo
							and (@spvar_CodCentro is null or cs.hospitalRef = @spvar_CodCentro)
							and i.CodServSalida = ut.CodUnidad
							and i.Tipo = 'U'
							and @spvar_DniMedico is not null 
							and ut.nif = @spvar_DniMedico
							and cut.Codunidad = ut.codunidad

			--Comites clinicos
			insert into @spvar_tablaDatos
			SELECT 	distinct 
							P.CodPaciente,
							P.CodHistoria,
							Nombre_Paciente = p.PacNombre,
							Primer_Apellido_Paciente = p.PacApell1,
							Segundo_Apellido_Paciente = p.PacApell2, 
							Nombre_Medico = M.Nombre,
							Primer_Apellido_Medico = M.Apellido1,
							Segundo_Apellido_Medico = M.Apellido2,
							S.DescServicio Servicio,
							I.FechaSolic,
							Solicitud = C.Descripcion,
							N_Cama = NULL,
							con.CodEpisodio,
							I.NifMedConsulta,
							Peticion = C.Descripcion,
							I.FechaConsulta,
							tipo = 'C',
							I.CodServSolic as CodServicioSolicita,
							cc.DescComision as ServicioDestino,
							mc.codigocomision as CodServicioDestino,
							I.codservsalida,
							I.Tipo,
							/*RTRIM(LTRIM(MedC.NomMedico) + ' ' + LTRIM(MedC.Apell1) + ' ' + LTRIM(MedC.Apell2)) as NombreMedicoConsulta*/
							RTRIM(M.Nombre + ' ' + M.Apellido1 + ' ' + M.Apellido2) as NombreMedicoConsulta

						FROM 	consultas..EpisodioConsultas Con,
								HClinica..Interconsulta I
									left join parametros..vParDatosUsuarios M on i.NifMedConsulta = m.dni
									/*left join parametros..DatosEnfermeras Enf on i.nifmedsolic = Enf.dnienf and puedeingresar is not null*/
									LEFT join parametros..CentrosSalud cs on cs.CodCentro = I.CodCentroSalida
									/*LEFT JOIN Parametros..ParametrosMedicos MedC ON i.NifMedConsulta = MedC.DNIMedico*/,								
								parametros..miembroscomite mc,
								HClinica..Pacientes P,
								parametros..Servicios S,
								parametros..PrioridadesClinicas C,
								parametros..codigocomision cc

						WHERE i.fechaconsulta is null
							and con.codpaciente = i.codpaciente
							and con.codepisodio = i.codepisodio
							and p.codpaciente = i.codpaciente
							and con.fechacierre is null
							and con.Fechainicial is not null 
							and I.CodServSolic = S.Codigo 
							and I.FechaSolic between @spvar_fechaInicial And  @spvar_fechafinal
							and I.Pedido = C.Codigo
							and (@spvar_CodCentro is null or cs.hospitalRef = @spvar_CodCentro)
							and i.CodServSalida = mc.CodigoComision
							and i.Tipo = 'C'
							and @spvar_DniMedico is not null 
							and mc.nif = @spvar_DniMedico
							and cc.Codigocomis = mc.codigocomision
	

			--Servicios
			insert into @spvar_tablaDatos
			SELECT 	distinct 
							P.CodPaciente,
							P.CodHistoria,
							Nombre_Paciente = p.PacNombre,
							Primer_Apellido_Paciente = p.PacApell1,
							Segundo_Apellido_Paciente = p.PacApell2, 
							Nombre_Medico = M.Nombre,
							Primer_Apellido_Medico = M.Apellido1,
							Segundo_Apellido_Medico = M.Apellido2,
							S.DescServicio Servicio,
							I.FechaSolic,
							Solicitud = C.Descripcion,
							N_Cama = NULL,
							con.CodEpisodio,
							I.NifMedConsulta,
							Peticion = C.Descripcion,
							I.FechaConsulta,
							tipo = 'C',
							I.CodServSolic as CodServicioSolicita,
							S1.DescServicio as ServicioDestino,
							S1.Codigo as CodServicioDestino,
							I.codservsalida,
							I.Tipo,
							/*RTRIM(LTRIM(MedC.NomMedico) + ' ' + LTRIM(MedC.Apell1) + ' ' + LTRIM(MedC.Apell2)) as NombreMedicoConsulta*/
							RTRIM(M.Nombre + ' ' + M.Apellido1 + ' ' + M.Apellido2) as NombreMedicoConsulta

						FROM 	consultas..EpisodioConsultas Con,
								HClinica..Interconsulta I
									left join parametros..vParDatosUsuarios M on i.NifMedConsulta = m.dni
									/*left join parametros..DatosEnfermeras Enf on i.nifmedsolic = Enf.dnienf and puedeingresar is not null								*/
									left join parametros..servicios s1 on i.CodServSalida = s1.Codigo
									left join parametros..CentrosSalud cs
										on cs.CodCentro = I.CodCentroSalida
									/*LEFT JOIN Parametros..ParametrosMedicos MedC ON i.NifMedConsulta = MedC.DNIMedico*/,
								HClinica..Pacientes P,
								parametros..Servicios S,
								parametros..PrioridadesClinicas C

						WHERE i.fechaconsulta is null
							and con.codpaciente = i.codpaciente
							and con.codepisodio = i.codepisodio
							and (@spvar_cod_consulta is null or i.codservsalida IN (SELECT CodServicio FROM @tablaSecundarios))
							and p.codpaciente = i.codpaciente
							and con.fechacierre is null
							and con.Fechainicial is not null 
							and I.CodServSolic = S.Codigo 
							and I.FechaSolic between @spvar_fechaInicial And  @spvar_fechafinal
							and I.Pedido = C.Codigo
							and (@spvar_CodCentro is null or cs.hospitalRef = @spvar_CodCentro)
							and i.Tipo = 'S'

/********************* EPISODIOS DE CONSULTAS **********************************************/

/********************* EPISODIOS DE HOSPITALIZACION ****************************************/

		--Unidades de Trabajo
		insert into @spvar_tablaDatos
		SELECT 	distinct 
						P.CodPaciente,
						P.CodHistoria,
						Nombre_Paciente = p.PacNombre,
						Primer_Apellido_Paciente = p.PacApell1,
						Segundo_Apellido_Paciente = p.PacApell2, 
						Nombre_Medico = M.Nombre,
						Primer_Apellido_Medico = M.Apellido1,
						Segundo_Apellido_Medico = M.Apellido2,
						S.DescServicio Servicio,
						I.FechaSolic,
						Solicitud = C.Descripcion,
						N_Cama = hos.numcama,
						hos.CodEpisodio,
						I.NifMedConsulta,
						Peticion = C.Descripcion,
						I.FechaConsulta,
						tipo = 'H',
						I.CodServSolic as CodServicioSolicita,
						cut.DescUnidad as ServicioDestino,
						ut.CodUnidad as CodServicioDestino,
						I.codservsalida,
						I.Tipo,
						/*RTRIM(LTRIM(MedC.NomMedico) + ' ' + LTRIM(MedC.Apell1) + ' ' + LTRIM(MedC.Apell2)) as NombreMedicoConsulta*/
						RTRIM(M.Nombre + ' ' + M.Apellido1 + ' ' + M.Apellido2) as NombreMedicoConsulta

					FROM 	ingresos..EpisodioHospitalizacion Hos,
							HClinica..Interconsulta I
									left join parametros..vParDatosUsuarios M on i.NifMedConsulta = m.dni
									/*left join parametros..DatosEnfermeras Enf on i.nifmedsolic = Enf.dnienf and puedeingresar is not null*/
									LEFT join parametros..CentrosSalud CS on i.CodCentroSalida = CS.CodCentro
									/*LEFT JOIN Parametros..ParametrosMedicos MedC ON i.NifMedConsulta = MedC.DNIMedico*/,							
							parametros..unidadestrabajo ut,
							parametros..CodigosUnidadesTrabajo cut,
							HClinica..Pacientes P,
							parametros..Servicios S,
							parametros..PrioridadesClinicas C
					WHERE i.fechaconsulta is null
						and hos.codpaciente = i.codpaciente
						and hos.codepisodio = i.codepisodio
						and p.codpaciente = i.codpaciente
						and hos.fechasalida is null
						and hos.FechaHospitalizacion is not null
						and I.CodServSolic=S.Codigo 
						and I.FechaSolic between @spvar_fechaInicial And  @spvar_fechafinal
						and I.Pedido=C.Codigo
						and (@spvar_CodCentro is null or cs.hospitalRef = @spvar_CodCentro)
						and i.CodServSalida = ut.CodUnidad
						and i.Tipo = 'U'
						and @spvar_DniMedico is not null 
						and ut.nif = @spvar_DniMedico
						and cut.codunidad = ut.codunidad

		--Comites clinicos
		insert into @spvar_tablaDatos
		SELECT 	distinct 
						P.CodPaciente,
						P.CodHistoria,
						Nombre_Paciente=p.PacNombre,
						Primer_Apellido_Paciente=p.PacApell1,
						Segundo_Apellido_Paciente=p.PacApell2, 
						Nombre_Medico=M.Nombre,
						Primer_Apellido_Medico=M.Apellido1,
						Segundo_Apellido_Medico=M.Apellido2,
						S.DescServicio Servicio,
						I.FechaSolic,
						Solicitud=C.Descripcion,
						N_Cama = hos.numcama,
						hos.CodEpisodio,
						I.NifMedConsulta,
						Peticion=C.Descripcion,
						I.FechaConsulta,
						tipo = 'H',
						I.CodServSolic as CodServicioSolicita,
						cc.DescComision as ServicioDestino,
						mc.codigocomision as CodServicioDestino,
						I.codservsalida,
						I.Tipo,
						/*RTRIM(LTRIM(MedC.NomMedico) + ' ' + LTRIM(MedC.Apell1) + ' ' + LTRIM(MedC.Apell2)) as NombreMedicoConsulta*/
						RTRIM(M.Nombre + ' ' + M.Apellido1 + ' ' + M.Apellido2) as NombreMedicoConsulta

					FROM 	ingresos..EpisodioHospitalizacion Hos,
							HClinica..Interconsulta I
									left join parametros..vParDatosUsuarios M on i.NifMedConsulta = m.dni
									/*left join parametros..DatosEnfermeras Enf on i.nifmedsolic = Enf.dnienf and puedeingresar is not null*/
									LEFT join parametros..CentrosSalud CS on CS.CodCentro = I.CodCentroSalida
									/*LEFT JOIN Parametros..ParametrosMedicos MedC ON i.NifMedConsulta = MedC.DNIMedico*/,							
							parametros..miembroscomite mc,
							HClinica..Pacientes P,
							--parametros..ParametrosMedicos M,
							parametros..Servicios S,
							parametros..PrioridadesClinicas C,
							parametros..codigocomision cc

					WHERE i.fechaconsulta is null
						and hos.codpaciente = i.codpaciente
						and hos.codepisodio = i.codepisodio
						and p.codpaciente = i.codpaciente
						and hos.fechasalida is null
						and hos.FechaHospitalizacion is not null
						and I.CodServSolic=S.Codigo 
						and I.FechaSolic between @spvar_fechaInicial And  @spvar_fechafinal
						and I.Pedido=C.Codigo
						and (@spvar_CodCentro is null or cs.hospitalRef = @spvar_CodCentro)
						and i.CodServSalida = mc.CodigoComision
						and i.Tipo = 'C'
						and @spvar_DniMedico is not null 
						and mc.nif = @spvar_DniMedico
						and cc.Codigocomis = mc.codigocomision

		--Servicios
		insert into @spvar_tablaDatos
		SELECT 	distinct
						P.CodPaciente,
						P.CodHistoria,
						Nombre_Paciente=p.PacNombre,
						Primer_Apellido_Paciente=p.PacApell1,
						Segundo_Apellido_Paciente=p.PacApell2, 
						Nombre_Medico=M.Nombre,
						Primer_Apellido_Medico=M.Apellido1,
						Segundo_Apellido_Medico=M.Apellido2,
						S.DescServicio Servicio,
						I.FechaSolic,
						Solicitud=C.Descripcion,
						N_Cama = hos.numcama,
						hos.CodEpisodio,
						I.NifMedConsulta,
						Peticion=C.Descripcion,
						I.FechaConsulta,
						tipo = 'H',
						I.CodServSolic as CodServicioSolicita,
						S1.DescServicio as ServicioDestino,
						S1.Codigo as CodServicioDestino,
						I.codservsalida,
						I.Tipo,
						/*RTRIM(LTRIM(MedC.NomMedico) + ' ' + LTRIM(MedC.Apell1) + ' ' + LTRIM(MedC.Apell2)) as NombreMedicoConsulta*/
						RTRIM(M.Nombre + ' ' + M.Apellido1 + ' ' + M.Apellido2) as NombreMedicoConsulta

					FROM 	ingresos..EpisodioHospitalizacion Hos,
							HClinica..Interconsulta I
									left join parametros..vParDatosUsuarios M on i.NifMedConsulta = m.dni
									/*left join parametros..DatosEnfermeras Enf on i.nifmedsolic = Enf.dnienf and puedeingresar is not null*/
									left join parametros..servicios s1 on i.CodServSalida = s1.Codigo
									left join parametros..CentrosSalud cs on cs.CodCentro = I.CodCentroSalida
									/*LEFT JOIN Parametros..ParametrosMedicos MedC ON i.NifMedConsulta = MedC.DNIMedico*/,
							HClinica..Pacientes P,
							parametros..Servicios S,
							parametros..PrioridadesClinicas C

					WHERE i.fechaconsulta is null
						and hos.codpaciente = i.codpaciente
						and hos.codepisodio = i.codepisodio
						and (@spvar_cod_consulta is null or i.codservsalida IN (SELECT CodServicio FROM @tablaSecundarios))
						and p.codpaciente = i.codpaciente
						and hos.fechasalida is null
						and hos.FechaHospitalizacion is not null
						and I.CodServSolic=S.Codigo 
						and I.FechaSolic between @spvar_fechaInicial And  @spvar_fechafinal
						and I.Pedido=C.Codigo
						and (@spvar_CodCentro is null or cs.hospitalRef = @spvar_CodCentro)
						and i.Tipo = 'S'

/********************* EPISODIOS DE HOSPITALIZACION ****************************************/

/********************* EPISODIOS DE ATENCION PRIMARIA **************************************/

			--Unidades de Trabajo
			insert into @spvar_tablaDatos
			SELECT 	distinct 
							P.CodPaciente,
							P.CodHistoria,
							Nombre_Paciente = p.PacNombre,
							Primer_Apellido_Paciente = p.PacApell1,
							Segundo_Apellido_Paciente = p.PacApell2, 
							Nombre_Medico = M.Nombre,
							Primer_Apellido_Medico = M.Apellido1,
							Segundo_Apellido_Medico = M.Apellido2,
							S.DescServicio Servicio,
							I.FechaSolic,
							Solicitud = C.Descripcion,
							N_Cama = NULL,
							con.CodEpisodio,
							I.NifMedConsulta,
							Peticion = C.Descripcion,
							I.FechaConsulta,
							tipo = 'C',
							I.CodServSolic as CodServicioSolicita,
							cut.DescUnidad as ServicioDestino,
							ut.CodUnidad as CodServicioDestino,
							I.codservsalida,
							I.Tipo,
							/*RTRIM(LTRIM(MedC.NomMedico) + ' ' + LTRIM(MedC.Apell1) + ' ' + LTRIM(MedC.Apell2)) as NombreMedicoConsulta*/
							RTRIM(M.Nombre + ' ' + M.Apellido1 + ' ' + M.Apellido2) as NombreMedicoConsulta

						FROM 	consultas..EpisodioAttPrimaria Con,
								HClinica..Interconsulta I
									left join parametros..vParDatosUsuarios M on i.NifMedConsulta = m.dni
									/*left join parametros..DatosEnfermeras Enf on i.nifmedsolic = Enf.dnienf and puedeingresar is not null*/
									LEFT join parametros..CentrosSalud cs on cs.CodCentro = I.CodCentroSalida
									/*LEFT JOIN Parametros..ParametrosMedicos MedC ON i.NifMedConsulta = MedC.DNIMedico*/,								
								parametros..unidadestrabajo ut,
								parametros..CodigosUnidadesTrabajo cut,
								HClinica..Pacientes P,
								parametros..Servicios S,
								parametros..PrioridadesClinicas C
						WHERE i.fechaconsulta is null
							and con.codpaciente = i.codpaciente
							and con.codepisodio = i.codepisodio
							and p.codpaciente = i.codpaciente
							and con.fechacierre is null
							and con.fechaatencion is not null 
							and I.CodServSolic = S.Codigo 
							and I.FechaSolic between @spvar_fechaInicial And  @spvar_fechafinal
							and I.Pedido = C.Codigo
							and (@spvar_CodCentro is null or cs.hospitalRef = @spvar_CodCentro)
							and i.CodServSalida = ut.CodUnidad
							and i.Tipo = 'U'
							and @spvar_DniMedico is not null 
							and ut.nif = @spvar_DniMedico
							and cut.Codunidad = ut.codunidad
			
			--Comites clinicos
			insert into @spvar_tablaDatos
			SELECT 	distinct 
							P.CodPaciente,
							P.CodHistoria,
							Nombre_Paciente = p.PacNombre,
							Primer_Apellido_Paciente = p.PacApell1,
							Segundo_Apellido_Paciente = p.PacApell2, 
							Nombre_Medico = M.Nombre,
							Primer_Apellido_Medico = M.Apellido1,
							Segundo_Apellido_Medico = M.Apellido2,
							S.DescServicio Servicio,
							I.FechaSolic,
							Solicitud = C.Descripcion,
							N_Cama = NULL,
							con.CodEpisodio,
							I.NifMedConsulta,
							Peticion = C.Descripcion,
							I.FechaConsulta,
							tipo = 'C',
							I.CodServSolic as CodServicioSolicita,
							cc.DescComision as ServicioDestino,
							mc.codigocomision as CodServicioDestino,
							I.codservsalida,
							I.Tipo,
							/*RTRIM(LTRIM(MedC.NomMedico) + ' ' + LTRIM(MedC.Apell1) + ' ' + LTRIM(MedC.Apell2)) as NombreMedicoConsulta*/
							RTRIM(M.Nombre + ' ' + M.Apellido1 + ' ' + M.Apellido2) as NombreMedicoConsulta

						FROM 	consultas..EpisodioAttPrimaria Con,
								HClinica..Interconsulta I
									left join parametros..vParDatosUsuarios M on i.NifMedConsulta = m.dni
									/*left join parametros..DatosEnfermeras Enf on i.nifmedsolic = Enf.dnienf and puedeingresar is not null*/
									LEFT join parametros..CentrosSalud cs on cs.CodCentro = I.CodCentroSalida
									/*LEFT JOIN Parametros..ParametrosMedicos MedC ON i.NifMedConsulta = MedC.DNIMedico*/,								
								parametros..miembroscomite mc,
								HClinica..Pacientes P,
								parametros..Servicios S,
								parametros..PrioridadesClinicas C,
								parametros..codigocomision cc

						WHERE i.fechaconsulta is null
							and con.codpaciente = i.codpaciente
							and con.codepisodio = i.codepisodio
							and p.codpaciente = i.codpaciente
							and con.fechacierre is null
							and con.Fechaatencion is not null 
							and I.CodServSolic = S.Codigo 
							and I.FechaSolic between @spvar_fechaInicial And  @spvar_fechafinal
							and I.Pedido = C.Codigo
							and (@spvar_CodCentro is null or cs.hospitalRef = @spvar_CodCentro)
							and i.CodServSalida = mc.CodigoComision
							and i.Tipo = 'C'
							and @spvar_DniMedico is not null 
							and mc.nif = @spvar_DniMedico
							and cc.Codigocomis = mc.codigocomision

			--Servicios
			insert into @spvar_tablaDatos
			SELECT 	distinct 
							P.CodPaciente,
							P.CodHistoria,
							Nombre_Paciente = p.PacNombre,
							Primer_Apellido_Paciente = p.PacApell1,
							Segundo_Apellido_Paciente = p.PacApell2, 
							Nombre_Medico = M.Nombre,
							Primer_Apellido_Medico = M.Apellido1,
							Segundo_Apellido_Medico = M.Apellido2,
							S.DescServicio Servicio,
							I.FechaSolic,
							Solicitud = C.Descripcion,
							N_Cama = NULL,
							con.CodEpisodio,
							I.NifMedConsulta,
							Peticion = C.Descripcion,
							I.FechaConsulta,
							tipo = 'C',
							I.CodServSolic as CodServicioSolicita,
							S1.DescServicio as ServicioDestino,
							S1.Codigo as CodServicioDestino,
							I.codservsalida,
							I.Tipo,
							/*RTRIM(LTRIM(MedC.NomMedico) + ' ' + LTRIM(MedC.Apell1) + ' ' + LTRIM(MedC.Apell2)) as NombreMedicoConsulta*/
							RTRIM(M.Nombre + ' ' + M.Apellido1 + ' ' + M.Apellido2) as NombreMedicoConsulta

						FROM 	consultas..EpisodioAttPrimaria Con,
								HClinica..Interconsulta I
									left join parametros..vParDatosUsuarios M on i.NifMedConsulta = m.dni
									/*left join parametros..DatosEnfermeras Enf on i.nifmedsolic = Enf.dnienf and puedeingresar is not null								*/
									left join parametros..servicios s1 on i.CodServSalida = s1.Codigo
									left join parametros..CentrosSalud cs on cs.CodCentro = I.CodCentroSalida
									/*LEFT JOIN Parametros..ParametrosMedicos MedC ON i.NifMedConsulta = MedC.DNIMedico*/
									,
								HClinica..Pacientes P,
								parametros..Servicios S,
								parametros..PrioridadesClinicas C

						WHERE i.fechaconsulta is null
							and con.codpaciente = i.codpaciente
							and con.codepisodio = i.codepisodio
							and (@spvar_cod_consulta is null or i.codservsalida IN (SELECT CodServicio FROM @tablaSecundarios))
							and p.codpaciente = i.codpaciente
							and con.fechacierre is null
							and con.Fechaatencion is not null 
							and I.CodServSolic = S.Codigo 
							and I.FechaSolic between @spvar_fechaInicial And  @spvar_fechafinal
							and I.Pedido = C.Codigo
							and (@spvar_CodCentro is null or cs.hospitalRef = @spvar_CodCentro)
							and i.Tipo = 'S'

/********************* EPISODIOS DE ATENCION PRIMARIA **************************************/

select CodPaciente ,
	CodHistoria  ,
	Nombre_Paciente  ,
	Primer_Apellido_Paciente  ,
	Segundo_Apellido_Paciente ,
	Nombre_Medico ,
	Primer_Apellido_Medico ,
	Segundo_Apellido_Medico,
	Servicio,
	FechaSolic,
	Solicitud ,
	N_Cama ,
	CodEpisodio,
	NifMedConsulta ,
	Peticion,
	FechaConsulta ,
	tipo,
	CodServicioSolicita,
	ServicioDestino, 
	CodServicioDestino,
	IntCodServSalida,
	IntTipo,
	NombreMedicoConsulta
	
from @spvar_tablaDatos
order by FechaSolic desc


END



    GO

GO



--dbo.SpHClSObservacionesST.sql

USE [Hclinica]
GO

IF EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[SpHClSObservacionesST]') AND type in (N'P', N'PC'))
DROP PROCEDURE [dbo].[SpHClSObservacionesST]
GO

/****************************************************
PROCEDIMIENTO	: SpHClIObservacionesST
FUNCION			: Seleccionar la Observacion, Usuario, Estado y Descriptivo del estado de una Solicitud de Traslado
FECHA			: 23/08/2017
VERSION			: 17.3 - 19362 - Gestor de Solicitudes de Traslado
AUTOR			: Marco Polo Ruiz
****************************************************/

CREATE PROCEDURE [dbo].[SpHClSObservacionesST]
    @spvar_IdSolicitudTraslado BIGINT

AS 

BEGIN 
	SELECT OT.FechaObservacion, VDU.Usuario, EST.DesEstSolTran, OT.Descripcion
		  
	FROM Hclinica..ObservacionesST OT
	LEFT JOIN Parametros..vParDatosUsuarios VDU ON VDU.Dni = OT.DNIUsuario
	LEFT JOIN Parametros..EstSolTrans  EST ON OT.IdEstSolTrans = EST.IdEstSolTrans
	WHERE 
		(OT.IdSolicitudTraslado =@spvar_IdSolicitudTraslado)
	ORDER BY OT.FechaObservacion DESC
END

GO

GO



--dbo.SpHClSPacHospitaliFechas.sql

USE [Hclinica]
GO

/****** Object:  StoredProcedure [dbo].[SpHClSPacHospitaliFechas]    Script Date: 06/03/2013 14:03:59 ******/
IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[SpHClSPacHospitaliFechas]') AND type in (N'P', N'PC'))
DROP PROCEDURE [dbo].[SpHClSPacHospitaliFechas]
GO

USE [Hclinica]
GO

/****** Object:  StoredProcedure [dbo].[SpHClSPacHospitaliFechas]    Script Date: 06/03/2013 14:03:59 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO
   

/*
*******************************************************************************
PROCEDIMIENTO     : HClinica..SpHClSPacHospitali
FUNCION                 : Obtiene la lista de pacientes ingresados 
DEVUELVE          : 
FECHA             : 03/11/2005
VERSION                 : 1.0
AUTOR             : Sonia Mateo (Agensys Technology)
APLICACION ORIGEN : Lista de trabajo - HOSPITALIZACION
*******************************************************************************

REVISION    : 

(11/07/07) Sonia Mateo (Agensys Technology) Modifico el procedimiento para que o curce con la tabla TiposIngreso
(19/12/07) Sonia Mateo (Agensys Technology) Modifico el procedimiento para quitar el calculo de las pruebas del cursor
											y uso el codigo de ingreso para encontrar la fecha de ingreso.
(19/12/07) Sonia Mateo (Agensys Technology) Modifico el procedimiento para quitar el calculo de las pruebas del cursor
											y uso el codigo de ingreso para encontrar la fecha de ingreso.
(24/12/07) Sonia Mateo (Agensys Technology) Incluyo dos select para obtener las plantas en las que hay pacientes ingresados
(07/02/08) Sonia Mateo (Agensys Technology) Se excluyen los episodios de hospitalizacion domiciliaria para el calculo de la fecha de ingreso
(19/02/08) Javier Clavel (Servicom 2000) Se añade el "with (nolock)" en todas las selects donde es posible
(28/02/08) Sonia Mateo (Agensys Technology) Obtiene el codigo del servicio que hospitaliza de la tabla de servicios
(08/05/08) Sonia Mateo (Agensys Technology) Calculo las pruebas de laboratorio en el ingreso del paciente
(14/07/2008) Ismael Sampere Optimizacion
03/03/2009 Teresa L Fabuel S. Campo FBorrado de SolicitudesLaboratorio
04/03/2009 Ismael Sampere: Gestion de solicitudes eliminadas de AP
25/05/2009 Teresa L Fabuel. Se extraen datos de valores patologicos de Laboratorio para color bolitas. Se devuelve EstanciaTeorica.
05/06/2009 Oscar Vilella. Se compruba que el rango patológico sea MS o MI
21/08/2009 Ismael Sampere. Añadidos los campos de codigo y tipo de guia clinica.
21/09/2009 Paco Aznar. Filtro los pacientes del centro de ingreso compatibilizando con centro de ingreso vacío
22/09/2009 Paco Aznar. Se aumenta el tamaño de codPlanta
08/10/2009 Paco Aznar. Se cruza el centro de datosCamas con el centro de ingreso del episodio
19/10/2009 Paco Aznar. Se cambian la manera de cruzar con datosCamas
02/11/2009 Jesús Mañogil (Mecemsa): Añadimos el colectivo del episodio, el centro de salud del paciente y el tipo de cama             
09/12/2009 Jesús Mañogil (Mecemsa): Consultamos los campos Patologicos y PatologiaNoDemorable de rayos            
16/02/2010 Jesús Mañogil (Mecemsa): Corregimos error al comprobar ranto patológico en laboratorio
01/03/2010 Jesús Mañogil (Mecemsa): Campos para acceder a consumos: SIP, NIFMedSolic, CodCenSalud, DirCodLocalidad y CodigoGRD
26/04/2010 Jesús Mañogil (Mecemsa): Consultamos los campos Patologicos y PatologiaNoDemorable de AnatoPato
16/12/2010 Joaquín Aniorte: Se añade Categorización de la cama a la selección
23/12/2010 Ramón Jiménez : Se quita la select previa de los updates a '0' para que se muestren correctamente en (Chile).
30/08/2011 A. Zaragoza. Cambios fechas				  
05/03/2012 César Moreno : Se adapta la categorización al nuevo campo abreviado de dos posiciones - CHC-1451
23/10/2012 Enrique Sánchez: Se cambia el servicio de ingreso por el servicio en el que se encuentra acostado el paciente - CHC1850 - v4.33.1
*			: 13/12/2012 Alfredo chc2460. Devolvemos las pruebas de laboratorio con resultado
12/03/2013 MAIPU CHC2452 v4.38, FLORENCE SAP-SD (Facturación) desde Hospitalización 
07/05/2013 MODIFICACION: CTF - 73569626D - CHC2725_REQ22340_Nuevo estado de la solicitud de laboratorio - v4.39
03/06/2013 MODIFICACION: CTF - 73569626D - CHC3101_ Pacientes en Hospital Clínico Magallanes se visualizan en Hospital Puerto Natales
24/12/2014 MODIFICACION: - v4.49 - 1439 - RRG - Transversalidad del caso GES - REQ 55104
(20/07/2015) - v4.53 - 2336 - SGN - Traspaso de fichas entre servicios de hospitalización
(01/12/2015) - v4.57 - 2722 - SGN - Entrega de turno
(22/09/2016) - v4.64 - 13349 - AAP - Cambio de estado en Solicitudes de Radiología
(17/10/2016) - v4.64R1 - 13669 - FCB - Error Categorización Camas
(09/05/2017) - v17.2 - 16146 - SGH - Incluir Nombre Social del Paciente
(24/05/2017) - v17.2 - 16114 - LMF - Mejora en excel de entrega de turno
(01/08/2017) - v17.2r2 - 18836 - ASM - Error Mejora en Excel de entrega de turno
*/

CREATE Procedure [dbo].[SpHClSPacHospitaliFechas]
     @spvar_codCentro char(5)=null
     ,@spvar_FechaEntregaTurno smalldatetime = null
     
as

IF @spvar_FechaEntregaTurno IS NULL
BEGIN
	SET @spvar_FechaEntregaTurno = GETDATE()
END

--Definir Tabla
Declare @TabHospitali TABLE (
      CodPaciente char(16),
      CodEpisodio char(5),
      CodHistoria char(8),
      PacApell1 varchar(25),
      PacApell2 varchar(25),
      PacNombre varchar(20),
      Genero char(1),
      FecNac smalldatetime,
      NumCama char(7),
      CodPlanta char(2),
      Estadocama char(30),
      ServicioIngreso char(40),
      Cod_CIE char(6),
      Diagnostico varchar(500),
      fechaIngreso smalldatetime,
      PruebaAnaPato int,
      pruebaRad int,
      pruebaOtras int,
      pruebaEndos int,
      PruebaLab int,
      Interconsultas int,
      CodServicioIngreso char(4),
      NombreMedico varchar(100),
      DNIMedico char(8),
      MedInterna bit,
      CodIngreso int,
      FecCambioTratamiento smalldatetime,
      EstanciaTeorica float,
      CodGuia int,
      TipoGuia int,
      -- Añadimos el Colectivo del episodio
      CodColectivo char(5),
      Aseguradora varchar(100),
      -- Añadimos el centro de salud del paciente
      DescCentro varchar(30),
      -- Añadimos el tipo de cama
      CodTipoCama char(2),
	  -- Si tiene Patología en Anato pato
	  APPatologia bit,
      -- Si tiene Patología en rayos
      RadioPatologia bit,
	  -- Si tiene Patología en Otras Pruebas
	  OPPatologia bit,
      -- Jesús: para poder acceder a imputación de consumos desde la lista de hospitalización
	  SIP char(16),	  
      NIFMedSolic char(8),
	  CodCenSalud char(5),
	  DirCodLocalidad char(7),
	  CodigoGRD char(3),
	  Categorizacion varchar(2)
	  ,CodigoServicioSalida char(4)
	  ,FechaSolic smalldatetime
	  ,CodHistoriaPapel varchar(10)
	  ,EstadoHistoriaPapel tinyint
	  ,CentroIngreso char(5)
	  ,FechaTurno_med smalldatetime
	  ,TurnoEstadoPaciente varchar(50)
	  ,DescTurno_Med varchar(8000)
	  ,NifRegistro_Med char(8)
	  ,FechaTurno_Enf smalldatetime
	  ,DescTurno_Enf varchar(255)
	  ,NifRegistro_Enf char(8)
	  ,NombreSocial varchar(50)
	  ,NifInsercion_Med char(8)
	  ,NifInsercion_Enf char(8)
	  ,Registro_Med VARCHAR(47)
	  ,Registro_Enf VARCHAR(47)
	  ,Insercion_Med VARCHAR(47)
	  ,Insercion_Enf VARCHAR(47)
      )

if @spvar_codCentro is null
begin
      set @spvar_codCentro = parametros.dbo.fnParHospitalReferencia()
end

insert into @TabHospitali
Select  EH.CodPaciente,
            EH.CodEpisodio,
            P.CodHistoria,
            convert(char(25), P.PacApell1),
            convert(char(25), P.PacApell2),
            convert(char(20), P.PacNombre),
            Genero = P.Genero,
            P.FecNac,
            EH.NumCama,
            DC.CodPlanta,

            EstadoCama = case when rtrim(C0.Descripcion) ='Pre-asignada' 
                                   then 'Pre-alta' 
                                   else C0.Descripcion 
                              end,

            ServicioIngreso=S0.DescServicio,

            Cod_CIE = IsNull(CIE.CodDiag,EH.CodDiagnosticoProvisional),

            Diagnostico = Isnull(
                                          (    
                                               Select Top(1) C.DescDiagnostico 
                                               From parametros..CIEDiagnostico C with (nolock)
                                               Where C.CodDiagnostico = cie.CodDiag
                                          ),
                                          (
                                               Select Top(1) C.DescDiagnostico
                                               From parametros..CIEDiagnostico C with (nolock)
                                               Where C.CodDiagnostico = EH.CodDiagnosticoProvisional
                                           )
                                         ),

            fechaIngreso = EH.FechaHospitalizacion,

             -- Pruebas de Anatomia Patologica
            '2' as PruebaAnaPato,

            -- Pruebas de Radiologia
            '3' as PruebaRad,

            -- Pruebas Complementarias
            '2' as PruebaOtras,

            -- Pruebas de endoscopias
            '2' as PruebaEndos,
            
            -- Pruebas de Laboratorio
            '3' as PruebaLab,

            -- Interconsultas
            '3' as Interconsultas,

            CodServicioIngreso = S0.Codigo,

            '' as NombreMedico,          

            DNIMedico = EH.MedicoIngresa,

            S0.MedInterna,
            
            EH.CodIngreso,
            EH.FecCambioTratamiento,
            EH.EstanciaTeorica,
		    ISNULL(
			  	    EH.IdGuiaClinica,
				    (
					  select MIN (I.CodProblema)
					  from 	(
					  			SELECT 
									  ipd.CodPaciente
									, ipd.CodEpisodio
									, ipd.CodProblema
									, ipd.CodSubProblema
									, ipd.CodDiagnostico
									, ipd.IDInformeIPD					
								FROM HClinica..InformeIPD ipd 
								union
								select 
									  tcGES.CodPaciente
									, tcGES.CodEpisodio
									, ipd.CodProblema
									, ipd.CodSubProblema
									, ipd.CodDiagnostico
									, tcGES.IDInformeIPD	
								FROM Hclinica..TrazabilidadCasoGES tcges 
									inner join hclinica..informeipd ipd on tcges.idinformeipd=ipd.idinformeipd 
							) I 
							inner join Parametros..CIEDiagnostico CIEDiag on I.CodDiagnostico=CIEDiag.CodDiagnostico
					  WHERE I.CodPaciente=EH.CodPaciente
					    and I.CodEpisodio=EH.CodEpisodio		
				    )
			      ) CodGuia,
            EH.TipoGuia,
            EH.CodColectivo,

			  (select isnull(
	          
					(SELECT MS.Entidad + ' - ' + C.Descripcion
					FROM parametros.dbo.Colectivos C, parametros.dbo.MutuasSalud MS
					WHERE C.CodMutua = MS.Codigo 
						   and C.CodColectivo = EH.CodColectivo),       
	                                               
					(select Entidad from parametros.dbo.MutuasSalud where Codigo = EH.CodColectivo))
	                       
			  ) as Aseguradora,
                        
            cen.DescCentro as DescCentro,

            DC.tipoCamaHospitalizacion,
            
            0, -- RadioPatologia
            0, -- APPatologia            
            0,  -- OPPatologia
                        
            -- Jesús: Para acceder a imputación de consumos
            ISNULL(P.NumTarjSanitaria,'') as NumTarjSanitaria,
            isnull(EH.NIFMedSolic, '') as NIFMedSolic,
            p.CodCenSalud,
            P.DirCodLocalidad,
			EH.CodigoGRD,
 
			(SELECT top 1(CodCategorizacion )
					FROM Ingresos..CategorizacionCamas CC
					WHERE CodCent = @spvar_codCentro
						   AND EH.CodPaciente=CC.CodPaciente AND EH.CodEpisodio=CC.CodEpisodio
						   and convert(char(10),Fecha,103) = convert(char(10),GETDATE(),103)
						   order by IdCategorizacion desc)   
	                			   as  Categorizacion       
 
		  ,EH.CodigoServicioSalida
		  ,EH.FechaSolic
		  , AHP.CodHistoriaPapel
		  , (CASE WHEN Estado IS NULL THEN 4 ELSE Estado END) AS EstadoHistoriaPapel
		  ,EH.CentroIngreso
		  ,HET_MED.FechaInicio as FechaTurno_med
		  ,PU.DesPrioridad as TurnoEstadoPaciente
		  ,HET_MED.Observaciones as DescTurno_Med
		  ,HET_MED.NifRegistro as NifRegistro_Med
		  ,HET_ENF.Fecha as FechaTurno_Enf
		  ,HET_ENF.MedicacionAnt as DescTurno_Enf
		  ,HET_ENF.NifRegistro as NifRegistro_Enf
		  ,P.AtiendeAlNombre as NombreSocial
		  ,HET_MED.NifInsercion as NifInsercion_Med
		  ,HET_ENF.DNIENfermera  as NifInsercion_Enf
		  ,MedReg.NombreCompleto AS Registro_Med
	      ,EnfReg.NombreCompleto AS Registro_Enf
	      ,MedIns.NombreCompleto AS Insercion_Med
	      ,EnfIns.NombreCompleto AS Insercion_Enf
      From 
            Ingresos..EpisodioHospitalizacion EH with (nolock)
                  left join parametros..datoscamas DC 
                                         on (eh.numcama = DC.numcama    
                                         and DC.CodCent = @spvar_codCentro
										and EH.CentroIngreso=@spvar_codCentro)
					
				  --Se obtienen los datos de hoja de entrega de turno médico registrada dentro de las últimas 12 horas correspondientes al último registro realizado
			      LEFT JOIN Ingresos..HojasEntregaTurno HET_MED ON (EH.CodPaciente = HET_MED.CodPaciente AND EH.CodEpisodio = HET_MED.CodEpisodio AND HET_MED.FechaInicio = 
						(SELECT MAX(FechaInicio) From Ingresos..HojasEntregaTurno HEnt Where HEnt.CodPaciente = EH.CodPaciente AND HEnt.CodEpisodio = EH.CodEpisodio And
						 HEnt.FechaInicio > DATEADD(hour,-12,@spvar_FechaEntregaTurno)))
							
				  --Se obtienen los datos de hojas de entrega de turno de enfermería registrada dentro de las últimas 12 horas correspondientes al último registro realizado
				  LEFT JOIN Ingresos..DictamenEnf HET_ENF ON (EH.CodPaciente = HET_ENF.CodPaciente AND EH.CodEpisodio = HET_ENF.CodEpisodio AND HET_ENF.Fecha = 
							(SELECT MAX(Fecha) From Ingresos..DictamenEnf DEnf Where DEnf.CodPaciente = EH.CodPaciente AND DEnf.CodEpisodio = EH.CodEpisodio And 
							DEnf.Fecha > DATEADD(hour,-12,@spvar_FechaEntregaTurno)))
									
				  LEFT JOIN Parametros..PrioridadUrgencia PU ON HET_MED.CodEstadoPaciente = PU.CodPrioridad	AND PU.CodCentro = @spvar_codCentro				
										
                  left join Parametros..Codigos C0 
                                         on C0.Tabla = 'EstEstadoCama' 
                                         and C0.Codigo = DC.EstadoCama 
                  left join parametros..Servicios S0 
                                         on S0.Codigo = DC.CodServ
                  
                  left join hclinica..DiagnosticosCIE CIE 
                                         on    EH.CodPaciente = cie.CodPaciente 
                                               And EH.CodEpisodio = cie.CodEpisodio 
                                               And EsPrincipal = 1
                                               And cie.FecBorrado Is NULL  
				LEFT JOIN
				  Parametros..vParDatosUsuarios MedReg ON
					HET_MED.NifRegistro = MedReg.Dni
				LEFT JOIN
				  Parametros..vParDatosUsuarios MedIns ON
					HET_MED.NifInsercion = MedIns.Dni
				LEFT JOIN
				  Parametros..vParDatosUsuarios EnfReg ON
					HET_ENF.NifRegistro = EnfReg.Dni
				LEFT JOIN
				  Parametros..vParDatosUsuarios EnfIns ON
					HET_ENF.DNIENfermera = EnfIns.Dni      
                                               ,
                                     
            HClinica..Pacientes P with (nolock)
                          left join parametros..CentrosSalud cen on p.CodCenSalud = cen.CodCentro

            LEFT JOIN Hclinica..ArchivoHistoriasPapel AHP ON (p.CodPaciente = AHP.CodPaciente AND AHP.CodCentro = @spvar_codCentro)
             
      Where 
            
            EH.FechaHospitalizacion Is Not Null 
            And EH.FechaSalida Is Null 
            And P.CodPaciente = EH.CodPaciente 
                  And (EH.CentroIngreso = @spvar_codCentro or EH.CentroIngreso is null) 
            

      order by EH.NumCama asc


-- Realiza obtiene la fecha de ingreso del paciente
declare @tablaFechas as table (
                                               fechaingreso smalldatetime, 
                                               codpaciente char(16)
                                           )

-- Busca la fecha de ingreso excluyendo los episodios de hospital domiciliaria
insert into @tablaFechas
select  min(e1.fechahospitalizacion), e2.codpaciente
from  ingresos..episodiohospitalizacion e1 with (nolock), 
            ingresos..episodiohospitalizacion e2 with (nolock)
where e1.codingreso = e2.codingreso
            and e2.fechahospitalizacion is not null
            and e2.fechasalida is null
group by  e2.codingreso, e2.codpaciente


update t1
set fechaIngreso = t2.fechaingreso
from @Tabhospitali t1, 
       @tablafechas t2
where t1.codpaciente = t2.codpaciente

/****************************************RADIOLOGIA*****************************************/
-- Comprobamos si tiene el informe de rayos tiene activos los campos Patologico o PatologiaNoDemorable
update eh
set RadioPatologia = 1
from @Tabhospitali eh
where exists (select 1
              from HClinica..InformeRadiologico IR with (nolock)
                    Where IR.CodPaciente = EH.CodPaciente 
                     And IR.CodEpisodio = EH.CodEpisodio 
                              and (IR.Patologico = 1 or IR.PatologiaNoDemorable = 1) 
                        )




-- No tiene ninguna prueba pendiente de informar
if exists (select 1
	from HClinica..InformeRadiologico IR with (nolock)
		Inner Join HClinica..PruebasRadiologicas PR 
			On PR.CodInforme = IR.CodRegistro 
			And PR.Estado in ('0 ','1 ','2 ')
		,@Tabhospitali eh
	Where
		IR.CodPaciente = EH.CodPaciente
		And IR.CodEpisodio = EH.CodEpisodio 
)
begin

		update eh
		set PruebaRad = '2'
		from @Tabhospitali eh
		where not exists (select 1
			from HClinica..InformeRadiologico IR with (nolock)
				Inner Join HClinica..PruebasRadiologicas PR
				On PR.CodInforme = IR.CodRegistro 
					And PR.Estado in ('0 ','1 ','2 ','3')
					
			Where
				IR.CodPaciente = EH.CodPaciente
				And IR.CodEpisodio = EH.CodEpisodio 
		)

end


update eh
set PruebaRad = '1'
from @Tabhospitali eh
where not exists (
                             select 1 
                             from HClinica..InformeRadiologico IR with (nolock)
                                               Inner Join HClinica..PruebasRadiologicas PR 
                                                     On PR.CodInforme = IR.CodRegistro 
                                                        And PR.Estado in ('3 ','7 ','5 ')
                            Where IR.CodPaciente = eh.CodPaciente 
                                     And IR.CodEpisodio = eh.CodEpisodio 
                         ) 

update eh
set PruebaRad = '0'
from @Tabhospitali eh
where not exists (
                             select 1
                             From hclinica..informeRadiologico with (nolock)
                             Where CodPaciente = eh.CodPaciente 
                                   And CodEpisodio = eh.CodEpisodio
                         )


/****************************************RADIOLOGIA******************************************/

/************************************ANATOMIA PATOLOGICA*************************************/

-- Jesús - Anotamos las Patologias
update eh
set APPatologia = 1
from @Tabhospitali eh
where exists (select 1 
              from hclinica..AnatomiaPatologica ap with (nolock)
			  Where ap.CodPaciente = EH.CodPaciente 
                     And ap.CodEpisodio = EH.CodEpisodio 
					 and (ap.PatologiaNoDemorable = 1 or ap.Patologico = 1)
					 and ap.Firmado = 1
					 and ap.Eliminado is null
				)


update eh
set PruebaAnaPato = '1'
from @Tabhospitali eh
where not exists (
                             Select 1
                             From hclinica..AnatomiaPatologica with (nolock)
                             Where CodPaciente = eh.CodPaciente 
                                     And CodEpisodio = eh.CodEpisodio 
                                     and Firmado = 1
                                     and Eliminado is null
                         )

update eh
set PruebaAnaPato = '0'
from @Tabhospitali eh
where not exists (
                             Select      1 
                             From hclinica..AnatomiaPatologica  with (nolock)
                             Where CodPaciente = eh.CodPaciente 
                                   And CodEpisodio = eh.CodEpisodio
                                   and Eliminado is null
                          )

--end

/************************************ANATOMIA PATOLOGICA*************************************/

/****************************************LABORATORIO*****************************************/

      -- no hay pruebas pendientes
      -- y ninguno de los resultados tiene valores patologicos
      update eh
      set PruebaLab = '2'
      from @Tabhospitali eh
      -- que no exista ninguna prueba sin resultados
      where not exists (
                                   select 1 
                                   from hclinica..solicitudeslaboratorio s with (nolock), 
                                          hclinica..determinacionlaboratorio d with (nolock)
                                   where s.codpaciente = eh.codpaciente 
                                               and s.fSolicitud >= eh.fechaIngreso
                                               and s.codregistro = d.codregistro 
                                               and d.fresultados is null
                                               and s.CodEpisodio in (select epiH.CodEpisodio 
                                                                               from ingresos..episodiohospitalizacion epiH
                                                                               where epiH.codingreso = eh.CodIngreso)
                                               and s.FBorrado is null
                              )
      -- y ninguna de las pruebas tiene valores patologicos
      and not exists (
                                   select 1 
                                   from hclinica..solicitudeslaboratorio s with (nolock), 
                                          hclinica..determinacionlaboratorio d with (nolock)
                                   where s.codpaciente = eh.codpaciente 
                                               and s.fSolicitud >= eh.fechaIngreso
                                               and s.codregistro = d.codregistro 
                                                and d.fresultados is not null
                                               and s.CodEpisodio in (select epiH.CodEpisodio 
                                                                               from ingresos..episodiohospitalizacion epiH
                                                                               where epiH.codingreso = eh.CodIngreso)
                                               and s.FBorrado is null
                                               and d.Patologico in ('MS', 'MI') --is not null
       )
      
      -- hay pruebas con resultados pero no todas
      update eh
      set PruebaLab = '4'
      from @Tabhospitali eh
      -- que existan pruebas con resultados
      where exists (
                                   select 1 
                                   from hclinica..solicitudeslaboratorio s with (nolock), 
                                          hclinica..determinacionlaboratorio d with (nolock)
                                   where s.codpaciente = eh.codpaciente 
                                               and s.fSolicitud >= eh.fechaIngreso
                                               and s.codregistro = d.codregistro 
                                               and d.fresultados is not null
                                               and s.CodEpisodio in (select epiH.CodEpisodio 
                                                                               from ingresos..episodiohospitalizacion epiH
                                                                               where epiH.codingreso = eh.CodIngreso)
                                               and s.FBorrado is null
                              )
      -- y haya alguna prueba con valores patologicos
      and exists (
                        select 1 
                        from hclinica..solicitudeslaboratorio s with (nolock), 
                              hclinica..determinacionlaboratorio d with (nolock)
                        where s.codpaciente = eh.codpaciente 
                                   and s.fSolicitud >= eh.fechaIngreso
                                   and s.codregistro = d.codregistro 
                                    and d.fresultados is not null
                                   and s.CodEpisodio in (select epiH.CodEpisodio 
                                                                    from ingresos..episodiohospitalizacion epiH
                                                                    where epiH.codingreso = eh.CodIngreso)
                                   and s.FBorrado is null
                                   and d.Patologico in ('MS', 'MI') --is not null

            )

      -- no hay pruebas pendientes
      -- y alguno de los resultados tiene valores patologicos
      update eh
      set PruebaLab = '5'
      from @Tabhospitali eh
      -- que no exista ninguna prueba sin resultados
      where not exists (
                                   select 1 
                                   from hclinica..solicitudeslaboratorio s with (nolock), 
                                          hclinica..determinacionlaboratorio d with (nolock)
                                   where s.codpaciente = eh.codpaciente 
                                               and s.fSolicitud >= eh.fechaIngreso
                                               and s.codregistro = d.codregistro 
                                                and d.fresultados is null
                                               and s.CodEpisodio in (select epiH.CodEpisodio 
                                                                               from ingresos..episodiohospitalizacion epiH
                                                                               where epiH.codingreso = eh.CodIngreso)
                                               and s.FBorrado is null
                              )
      -- y haya alguna prueba con valores patologicos
      and exists (
                        select 1 
                        from hclinica..solicitudeslaboratorio s with (nolock), 
                              hclinica..determinacionlaboratorio d with (nolock)
                        where s.codpaciente = eh.codpaciente 
                                   and s.fSolicitud >= eh.fechaIngreso
                                   and s.codregistro = d.codregistro 
                                   and d.fresultados is not null
                                   and s.CodEpisodio in (select epiH.CodEpisodio 
                                                                    from ingresos..episodiohospitalizacion epiH
                                                                    where epiH.codingreso = eh.CodIngreso)
                                    and s.FBorrado is null
                                   and d.Patologico in ('MS', 'MI') --is not null
            )
            
      -- no hay pruebas con resultados
      update eh
      set PruebaLab = '1'
      from @Tabhospitali eh
      where not exists (
                                   select 1 
                                   from hclinica..solicitudeslaboratorio s with (nolock), 
                                          hclinica..determinacionlaboratorio d with (nolock)
                                   where s.codpaciente = eh.codpaciente 
                                               and s.fSolicitud >= eh.fechaIngreso
                                               and s.codregistro = d.codregistro 
                                               and d.fresultados is not null
                                               and s.CodEpisodio in (select epiH.CodEpisodio 
                                                                               from ingresos..episodiohospitalizacion epiH
                                                                               where epiH.codingreso = eh.CodIngreso)
                                               and s.FBorrado is null
                             )

-- Muestras tomadas pero sin resultados
      update eh
      set pruebaLab = '7'
      from @TabHospitali eh
      -- que no exista ninguna prueba sin resultados
      where not exists (
                                   select 1 
                                   from hclinica..solicitudeslaboratorio s with (nolock), 
                                          hclinica..determinacionlaboratorio d with (nolock)
                                   where s.codpaciente = eh.codpaciente 
                                               and s.fSolicitud >= eh.fechaIngreso
                                               and s.codregistro = d.codregistro 
                                               and d.FEntMuestra is null
                                               and s.CodEpisodio in (select epiH.CodEpisodio 
                                                                               from ingresos..episodiohospitalizacion epiH
                                                                               where epiH.codingreso = eh.CodIngreso)
                                               and s.FBorrado is null
                              )
         and not exists(
                                   select 1 
                                   from hclinica..solicitudeslaboratorio s with (nolock), 
                                          hclinica..determinacionlaboratorio d with (nolock)
                                   where s.codpaciente = eh.codpaciente 
                                               and s.fSolicitud >= eh.fechaIngreso
                                               and s.codregistro = d.codregistro 
                                               and d.FResultados is not null
                                               and s.CodEpisodio in (select epiH.CodEpisodio 
                                                                               from ingresos..episodiohospitalizacion epiH
                                                                               where epiH.codingreso = eh.CodIngreso)
                                               and s.FBorrado is null
                              )
      -- y ninguna de las pruebas tiene valores patologicos
      and not exists (
                                   select 1 
                                   from hclinica..solicitudeslaboratorio s with (nolock), 
                                          hclinica..determinacionlaboratorio d with (nolock)
                                   where s.codpaciente = eh.codpaciente 
                                               and s.fSolicitud >= eh.fechaIngreso
                                               and s.codregistro = d.codregistro 
                                                and d.fresultados is not null
                                               and s.CodEpisodio in (select epiH.CodEpisodio 
                                                                               from ingresos..episodiohospitalizacion epiH
                                                                               where epiH.codingreso = eh.CodIngreso)
                                               and s.FBorrado is null
                                               and d.Patologico in ('MS', 'MI') --is not null
       )

      -- no hay pruebas
      update eh
      set PruebaLab = '0'
      from @Tabhospitali eh
      where not exists (  select 1
                                   from hclinica..solicitudeslaboratorio sl  with (nolock)
                                   where sl.codpaciente = eh.codpaciente 
                                           and sl.fSolicitud >= eh.fechaIngreso
                                           and sl.CodEpisodio in (select epiH.CodEpisodio 
                                                                               from ingresos..episodiohospitalizacion epiH
                                                                               where epiH.codingreso = eh.CodIngreso)   
                                           and sl.FBorrado is null
                             )
      -- Esta en analisis si tiene pruebas aceptadas y ninguna con resultado.
      update eh
      set PruebaLab = '8'
      from @Tabhospitali eh
	  where exists (
					   select 1 
					   from hclinica..solicitudeslaboratorio s with (nolock), 
							Inter_his_consell..DeterminacionLaboratorio ihd with (nolock),
							Inter_his_consell..SolicitudLaboratorio ihs with (nolock),
							Hclinica..DeterminacionLaboratorio d with (nolock)
					   where s.codpaciente = eh.codpaciente 
							   and ihs.HFechaHoraSolicitud >= eh.fechaIngreso
							   and d.CodRegistro=s.CodRegistro
							   and ihd.HCodExamen=d.CodPrueba
							   and d.FResultados is NULL -- ninguna con resultado
							   and ihd.LFAceptacion is not NULL -- Pruebas aceptadas
							   and ihd.HCodSolicitud=ihs.HCodSolicitud 
							   and s.CodPaciente=ihs.HCodPaciente 
							   and s.CodRegistro=ihs.HCodSolicitud
							   and s.CodEpisodio in (select epiH.CodEpisodio 
													   from ingresos..episodiohospitalizacion epiH
													   where epiH.codingreso = eh.CodIngreso)
							   and ihs.HFBorrado is null                               
                      )
/****************************************LABORATORIO*****************************************/

/*************************************OTRAS PRUEBAS*****************************************/

-- Jesús: Anotamos las Patologias
update eh
set OPPatologia = 1
from @Tabhospitali eh
where exists (Select 1
				From hclinica..InformesComp ic with (nolock)
                Where ic.CodPaciente = eh.CodPaciente 
						And ic.CodEpisodio = eh.CodEpisodio
						and (ic.PatologiaNoDemorable = 1 or ic.Patologico = 1)
						and ic.Firmado = 1)

-- no existen pruebas firmadas
if exists (
                             Select 1 
                             From hclinica..InformesComp ic with (nolock),@Tabhospitali eh
                             Where ic.CodPaciente = EH.CodPaciente 
                                   And ic.CodEpisodio = EH.CodEpisodio 
                                     and ic.Firmado = 1
                         )
begin

update eh
set PruebaOtras = '1'
from @Tabhospitali eh
where not exists (
                             Select 1 
                             From hclinica..InformesComp with (nolock)
                             Where CodPaciente = EH.CodPaciente 
                                   And CodEpisodio = EH.CodEpisodio 
                                     and Firmado = 1
                         )

end

update eh
set PruebaOtras = '0'
from @Tabhospitali eh
where not exists (
                             Select 1 
                             From hclinica..InformesComp with (nolock)
                             Where CodPaciente = eh.CodPaciente 
                                     And CodEpisodio = eh.CodEpisodio
                         )

--end

/*************************************OTRAS PRUEBAS*****************************************/

/************************************ENDOSCOPIAS********************************************/

update eh
set PruebaEndos = '1'
from @Tabhospitali eh
where not exists (
                             Select 1 
                             From hclinica..InformeEndoscopia with (nolock)
                             Where CodPaciente = eh.CodPaciente 
                                     And CodEpisodio = eh.CodEpisodio 
                                     and Firmado = 1
                          )

update eh
set PruebaEndos = '0'
from @Tabhospitali eh
where not exists ( 
                             Select 1 
                             From hclinica..InformeEndoscopia with (nolock)
                             Where CodPaciente = eh.CodPaciente 
                                     And CodEpisodio = eh.CodEpisodio
                         )

--end
/************************************ENDOSCOPIAS********************************************/

/************************************INTERCONSULTAS*****************************************/

update eh
set Interconsultas = '2'
from @Tabhospitali eh
where exists (
                        select 1 
                        From hclinica..interconsulta with (nolock)
                        Where CodPaciente = EH.CodPaciente 
                              And CodEpisodio = EH.CodEpisodio 
                               and (firma = 0 or firma is null)
                  )

update eh
set Interconsultas = '1'
from @Tabhospitali eh
where not exists (
                             select 1 
                             From hclinica..interconsulta with (nolock)
                             Where CodPaciente = EH.CodPaciente 
                                         And CodEpisodio = EH.CodEpisodio 
                                         and (conclusion is not null 
                                                or 
                                                textoRevision is not null)
                         )

update eh
set Interconsultas = '0'
from @Tabhospitali eh
where not exists (
                             select 1 
                             From hclinica..interconsulta with (nolock)
                             Where CodPaciente = eh.CodPaciente 
                                   And CodEpisodio = eh.CodEpisodio
                         )

--end
/************************************INTERCONSULTAS*****************************************/

/************************************NOMBRE MEDICO******************************************/

update eh
set NombreMedico =  rtrim(m.nommedico) 
                             + ' ' 
                             + rtrim(m.apell1) 
                             + ' ' 
                             + rtrim(m.apell2) 
from @Tabhospitali eh, 
       parametros..parametrosmedicos m with (nolock)
where m.dnimedico = eh.DNIMedico

/************************************NOMBRE MEDICO******************************************/            



select
	  CodPaciente,
      CodEpisodio,
      CodHistoria,
      PacApell1,
      PacApell2,
      PacNombre,
      Genero,
      FecNac,
      NumCama,
      CodPlanta,
      Estadocama,
      ServicioIngreso,
      Cod_CIE,
      Diagnostico,
      fechaIngreso,
      PruebaAnaPato,
      pruebaRad,
      pruebaOtras,
      pruebaEndos,
      PruebaLab,
      Interconsultas,
      CodServicioIngreso,
      NombreMedico,
      DNIMedico,
      MedInterna,
      CodIngreso,
      FecCambioTratamiento,
      EstanciaTeorica,
      CodGuia,
      TipoGuia,
      CodColectivo,
      Aseguradora,
      DescCentro,
      CodTipoCama,
	  APPatologia,
      RadioPatologia,
	  OPPatologia,
	  SIP,	  
      NIFMedSolic,
	  CodCenSalud,
	  DirCodLocalidad,
	  CodigoGRD,
	  Categorizacion
	  ,CodigoServicioSalida
	  ,FechaSolic
	  ,CodHistoriaPapel
	  ,EstadoHistoriaPapel
	  ,FechaTurno_med 
	  ,TurnoEstadoPaciente 
	  ,DescTurno_Med 
	  ,NifRegistro_Med
	  ,FechaTurno_Enf 
	  ,DescTurno_Enf 
	  ,NifRegistro_Enf
	  ,NombreSocial
	  ,NifInsercion_Med
	  ,NifInsercion_Enf
	  ,Registro_Med 
	  ,Registro_Enf 
	  ,Insercion_Med
	  ,Insercion_Enf
	  
from
	@Tabhospitali eh
order
	by NumCama

select distinct CodPlanta 
from @Tabhospitali

select ASEC.CodPaciente,ASEC.Extraviada
from HClinica..ArchivoSecciones ASEC
inner join @Tabhospitali EH on
EH.CodPaciente=ASEC.CodPaciente and
RIGHT('00000000' + LTRIM (RTRIM(EH.CodHistoriaPapel)),8 )=RIGHT('00000000' + LTRIM (RTRIM(ASEC.CodHistoriaPapel)),8 ) AND
EH.CentroIngreso=ASEC.CodCentro
where Extraviada=1

GO

 
GO



--dbo.SpHClSPruebasExistentesProtocolo.sql

/*
PROCEDIMIENTO: SpHClSPruebasExistentesProtocolo
FUNCIÓN: 
DEVUELVE: Las solicitudes de pruebas creadas para un determinado paciente, episodio y protocolo de pruebas que no hayan recibido resultados
FECHA: 09/06/2014
VERSIÓN: 1.0
AUTOR: Ester Caballer 
TRAZABILIDAD: V4.45 - 876 - HUAP-HEC. Crear episodio de mortinato
MODIFICACIÓN: 20/06/2017 - ASM - v17.2r1 - 18428 - Protocolos por centro
*/

USE [HClinica];
GO
IF EXISTS 
(
	SELECT * 
	FROM sys.procedures 
	WHERE [object_id] = OBJECT_ID('[dbo].[SpHClSPruebasExistentesProtocolo]')
)
BEGIN
	DROP PROCEDURE [dbo].SpHClSPruebasExistentesProtocolo;
END
GO

CREATE PROCEDURE [dbo].SpHClSPruebasExistentesProtocolo
	@spvar_CodPaciente char(16),
	@spvar_CodEpisodio char(5),
	@spvar_IdProtocolo int,
	@spvar_CodCentro as CHAR(5) = NULL
AS

IF @spvar_CodCentro IS NULL
BEGIN
	SELECT @spvar_CodCentro = parametros.dbo.fnParHospitalReferencia()
END

--PP.TipoPrueba='R' Radiologia
SELECT
	PP.IdProtocolo,
	PP.CodPrueba,
	PP.TipoSolicitud,
	PP.CodSeccion,
	PP.TipoPrueba,
	'CodExamen' = IR.Cod_Examen,
	PP.TipoCitologia,
	PP.CodTopografia,
	PP.CodProcedimiento,
	PP.EsPerfil,	
	IR.CodRegistro AS CodRegistro

FROM
	Parametros..CodigosProtPruebasCentros PC
INNER JOIN
	Parametros..ProtocolosPruebas PP ON
		PC.IdCodigosProtPruebasCentros = PP.IdCodigoProtPruebasCentros	
INNER JOIN
	HClinica..InformeRadiologico IR ON IR.Cod_Examen = PP.CodPrueba AND (IR.CodPaciente = @spvar_CodPaciente AND IR.CodEpisodio = @spvar_CodEpisodio
	AND IR.F_Realizacion IS NULL )
WHERE 
	PC.CodigoProtocolo = @spvar_IdProtocolo AND
	PC.CodCentro = @spvar_CodCentro
	AND PP.EsPerfil=0

UNION	
--PP.TipoPrueba='C' Citologia
--PP.TipoPrueba='B' Biopsia
SELECT
	PP.IdProtocolo,
	PP.CodPrueba,
	PP.TipoSolicitud,
	PP.CodSeccion,
	PP.TipoPrueba,
	'CodExamen' = '',
	PP.TipoCitologia,
	PP.CodTopografia,
	PP.CodProcedimiento,
	PP.EsPerfil,
	AP.CodRegistro AS CodRegistro
	
FROM
	Parametros..CodigosProtPruebasCentros PC
INNER JOIN
	Parametros..ProtocolosPruebas PP ON
		PC.IdCodigosProtPruebasCentros = PP.IdCodigoProtPruebasCentros	
INNER JOIN
	HClinica..AnatomiaPatologica AP ON AP.CodProc = PP.CodPrueba AND (AP.CodPaciente = @spvar_CodPaciente AND AP.CodEpisodio = @spvar_CodEpisodio
	AND AP.FechaRealizacion IS NULL AND (AP.Eliminado IS NULL OR AP.Eliminado=0))
WHERE 
	PC.CodigoProtocolo = @spvar_IdProtocolo AND 
	PC.CodCentro = @spvar_CodCentro AND
	PP.EsPerfil=0

UNION	
--PP.TipoPrueba='E' Endoscopia
SELECT
	PP.IdProtocolo,
	PP.CodPrueba,
	PP.TipoSolicitud,
	PP.CodSeccion,
	PP.TipoPrueba,
	'CodExamen' = '',
	PP.TipoCitologia,
	PP.CodTopografia,
	PP.CodProcedimiento,
	PP.EsPerfil,	
	IE.CodRegistro AS CodRegistro

FROM
	Parametros..CodigosProtPruebasCentros PC
INNER JOIN
	Parametros..ProtocolosPruebas PP ON
		PC.IdCodigosProtPruebasCentros = PP.IdCodigoProtPruebasCentros	
INNER JOIN
	HClinica..InformeEndoscopia IE ON IE.CodPrueba = PP.CodPrueba AND (IE.CodPaciente = @spvar_CodPaciente AND IE.CodEpisodio = @spvar_CodEpisodio
	AND IE.FechaRealizacion IS NULL) 
WHERE 
	PC.CodigoProtocolo = @spvar_IdProtocolo AND 
	PC.CodCentro = @spvar_CodCentro AND
	PP.EsPerfil=0

UNION	
--PP.TipoPrueba='L' Laboratorio
SELECT
	PP.IdProtocolo,
	PP.CodPrueba,
	PP.TipoSolicitud,
	PP.CodSeccion,
	PP.TipoPrueba,
	'CodExamen' = '',
	PP.TipoCitologia,
	PP.CodTopografia,
	PP.CodProcedimiento,
	PP.EsPerfil,	
	SL.CodRegistro AS CodRegistro

FROM
	Parametros..CodigosProtPruebasCentros PC
INNER JOIN
	Parametros..ProtocolosPruebas PP ON
		PC.IdCodigosProtPruebasCentros = PP.IdCodigoProtPruebasCentros	
INNER JOIN
	HClinica..SolicitudesLaboratorio SL ON SL.CodPaciente = @spvar_CodPaciente AND SL.CodEpisodio = @spvar_CodEpisodio  AND SL.CodRegistro IS NOT NULL AND SL.FBorrado IS NULL
INNER JOIN
	HClinica..determinacionlaboratorio DL ON DL.CodRegistro = SL.CodRegistro  AND PP.CodPrueba = DL.CodPrueba 
WHERE 
	PC.CodigoProtocolo = @spvar_IdProtocolo AND 
	PC.CodCentro = @spvar_CodCentro AND
	PP.EsPerfil=0	

UNION	
--PP.TipoPrueba='O' Otras Pruebas
SELECT
	PP.IdProtocolo,
	PP.CodPrueba,
	PP.TipoSolicitud,
	PP.CodSeccion,
	PP.TipoPrueba,
	'CodExamen' = '',
	PP.TipoCitologia,
	PP.CodTopografia,
	PP.CodProcedimiento,
	PP.EsPerfil,	
	IC.CodRegistro AS CodRegistro

FROM
	Parametros..CodigosProtPruebasCentros PC
INNER JOIN
	Parametros..ProtocolosPruebas PP ON
		PC.IdCodigosProtPruebasCentros = PP.IdCodigoProtPruebasCentros	
INNER JOIN
	HClinica..InformesComp IC ON IC.CodPrueba = PP.CodPrueba AND (IC.CodPaciente = @spvar_CodPaciente AND IC.CodEpisodio = @spvar_CodEpisodio 
	AND IC.FecRealiz IS NULL )
WHERE 
	PC.CodigoProtocolo = @spvar_IdProtocolo AND 
	PC.CodCentro = @spvar_CodCentro AND
	PP.EsPerfil=0

UNION	
--PP.EsPerfil=1 --> Laboratorio
SELECT
	PP.IdProtocolo,
	PP.CodPrueba,
	PP.TipoSolicitud,
	PP.CodSeccion,
	PP.TipoPrueba,
	'CodExamen' = '',
	PP.TipoCitologia,
	PP.CodTopografia,
	PP.CodProcedimiento,
	PP.EsPerfil,	
	SL.CodRegistro AS CodRegistro

FROM
	Parametros..CodigosProtPruebasCentros PC
INNER JOIN
	Parametros..ProtocolosPruebas PP ON
		PC.IdCodigosProtPruebasCentros = PP.IdCodigoProtPruebasCentros	
INNER JOIN  
	Parametros..PerfilesLab PL ON PL.CodPerfil=PP.CodPrueba
INNER JOIN  
	Parametros..PerfilPruebaLab PPL ON PPL.CodPerfil=PL.CodPerfil 
INNER JOIN  
	Parametros..PruebasLab PruLab ON PruLab.CodPrueba=PPL.CodPrueba and PruLab.Estado<>'0'
INNER JOIN
	HClinica..determinacionlaboratorio DL ON PruLab.CodPrueba = DL.CodPrueba 
INNER JOIN
	HClinica..SolicitudesLaboratorio SL ON SL.CodPaciente = @spvar_CodPaciente AND SL.CodEpisodio = @spvar_CodEpisodio  AND SL.CodRegistro IS NOT NULL
	AND DL.CodRegistro = SL.CodRegistro
WHERE 
	PC.CodigoProtocolo = @spvar_IdProtocolo AND 
	PC.CodCentro = @spvar_CodCentro AND
	PP.EsPerfil=1
GO



--dbo.SpHClSSolicitudTraslado.sql

USE [Hclinica]
GO

IF EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[SpHClSSolicitudTraslado]') AND type in (N'P', N'PC'))
DROP PROCEDURE [dbo].[SpHClSSolicitudTraslado]
GO

USE [Hclinica]
GO

SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

/*
PROCEDIMIENTO: SpHClSSolicitudTraslado
FUNCION:  Obtiene las solicitudes de traslado por paciente-episodio
DEVUELVE:
FECHA: 24/07/2013
VERSION: 1.0
AUTOR: MAIPU CHC2503 V4.40 FCB, Solicitudes de traslado
MODIFICACION: MAIPU CHC3555 V4.40 R5 FCB, Observacion CHC2503
MODIFICACIÓN: 15/10/2013 Alberto Pagán - MAIPU CHC3617 - v4.40 Release 6 - Observaciones Solicitud de Traslado
MODIFICACIÓN: 08/04/2014 MAIPU CHC4283 v4.42 FCB, Integración con SAP se envié en el campo centro el valor que tenga el Episodio
MODIFICACION: 22/08/2017 - v17.3 - 19362 - MPR - Gestor de Solicitudes de Traslado
MODIFICACIÓN: 24/08/2017 - v17.3 - 19362 - ASM - Gestor de Solicitudes de Traslado - Añado CodPaciente y CodEpisodio a la select
MODIFICACIÓN: 31/08/2017 - v17.3 - 19362 - ASM - Gestor de Solicitudes de Traslado - Si traigo CodPaciente pero no CodEpisodio, nos traemos todas las solicitudes del paciente-centro.
*/

CREATE PROCEDURE [dbo].[SpHClSSolicitudTraslado]
     @spvar_CodPaciente CHAR(16)=NULL
	,@spvar_CodEpisodio CHAR(5)=NULL
	,@spvar_CodCentro CHAR(5)
	,@spvar_Tipo CHAR(1) = NULL
	,@spvar_Internos bit = NULL
	,@spvar_Externos bit = NULL
	,@spvar_FechaDesde smalldatetime = NULL
	,@spvar_FechaHasta smalldatetime = NULL

AS 

BEGIN 
	SELECT ST.IdSolicitudTraslado, ST.IdEstSolTrans, ST.FSolicitud, ST.FModificacion
	      ,ST.CodCentro --MAIPU CHC3555 V4.40 R5 FCB, Observacion CHC2503
	      ,ST.CodPaciente, ST.CodEpisodio, ST.IdPrioSolTrans, ST.TipoTrasladoOri, ST.TipoTrasladoDes, ST.IdTipoVehiculoTras, ST.Retorno
	      ,ST.Medicalizado, ST.CodCentroOri, ST.CodAreaOri, ST.CodPlantasOri, ST.NumCamaOri, ST.CodCamaOri, ST.CodUbiConsOri, ST.CodSalaOri
	      ,ST.NumQuirofanoOri, ST.CodServicioOri, ST.CodCentroDes, ST.CodAreaDes, ST.CodPlantasDes, ST.NumCamaDes, ST.CodCamaDes, ST.CodUbiConsDes
	      ,ST.CodSalaDes, ST.NumQuirofanoDes, ST.CodServicioDes, ST.TrasExtOri, ST.DesTrasExtOri, ST.TrasExtDes, ST.DesTrasExtDes, ST.Observaciones
	      ,TVT.DesTipoVehiculoTras --Alberto Pagán - MAIPU CHC3617 - v4.40 Release 6 - 15/10/2013
	      ,PST.DesPrioSolTrans
		  ,P.NumTarjSanitaria as RUN
		  ,P.CodHistoria
		  ,RTRIM(P.PacNombre) + ' ' + RTRIM(P.PacApell1) + ' ' + RTRIM(P.PacApell2) as NomCompletoPaciente
		  ,RIGHT('00000000' + LTRIM(RTRIM(AHP.[CodHistoriaPapel])),8) AS NHistPapel
		  ,ST.DNIProfesional 
		  ,RTRIM(VDU.Nombre) + ' ' + RTRIM(VDU.Apellido1) + ' ' + RTRIM(VDU.Apellido2) as NomCompletoFuncionario
		  ,ST.CodPaciente
		  ,ST.CodEpisodio		  
		  ,EST.DesEstSolTran
		  ,ST.CodAcompanyante
		  ,ST.DNIMedicoTraslada
		  ,MedTras.NombreCompleto AS 'MedicoTraslada'
		  ,ST.DNIEnfermeraTraslada
		  ,EnfTras.NombreCompleto AS 'EnfermeraTraslada'
		  ,ST.NombreMedicoRecibe
		  ,ST.NombreEnfermeraRecibe
		  ,ST.NombreMatronaRecibe
		  ,STA.DescAcompanyante AS 'Acompanyante'
		  ,RTRIM(P.PacNombre) AS 'PacNombre'
		  ,RTRIM(P.PacApell1) AS 'PacApellido1'
		  ,RTRIM(P.PacApell2) AS 'PacApellido2'
	FROM Hclinica..SolicitudTraslado ST
	LEFT JOIN Parametros..TipoVehiculoTras TVT ON ST.IdTipoVehiculoTras = TVT.IdTipoVehiculoTras --Alberto Pagán - MAIPU CHC3617 - v4.40 Release 6 - 15/10/2013
	LEFT JOIN Parametros..PrioSolTrans PST ON PST.IdPrioSolTrans=ST.IdPrioSolTrans --MAIPU CHC4283 v4.42 FCB, Integración con SAP se envié en el campo centro el valor que tenga el Episodio
	LEFT JOIN HClinica..Pacientes P ON P.CodPaciente = ST.CodPaciente --V17.3 - 19362
	LEFT JOIN HClinica..ArchivoHistoriasPapel AHP ON AHP.CodPaciente = ST.CodPaciente AND AHP.CodCentro = ST.CodCentro --V17.3 - 19362
	LEFT JOIN Parametros..vParDatosUsuarios VDU ON VDU.Dni = ST.DNIProfesional --V17.3 - 19362
	LEFT JOIN Parametros..EstSolTrans EST ON ST.IdEstSolTrans = EST.IdEstSolTrans
	LEFT JOIN Parametros..vParDatosUsuarios MedTras ON ST.DNIMedicoTraslada = MedTras.Dni
	LEFT JOIN Parametros..vParDatosUsuarios EnfTras ON ST.DNIEnfermeraTraslada = EnfTras.Dni
	LEFT JOIN Parametros..SolicitudTrasladoAcompanyante STA ON ST.CodAcompanyante = STA.CodAcompanyante AND @spvar_CodCentro = STA.CodCentro
	WHERE 
		(@spvar_CodPaciente IS NOT NULL AND
			ST.CodPaciente = @spvar_CodPaciente AND 
			ST.CodEpisodio = ISNULL(@spvar_CodEpisodio, ST.CodEpisodio) AND 
			ST.CodCentro = @spvar_CodCentro
		)OR
		(@spvar_CodPaciente IS NULL AND
			ST.CodCentro = @spvar_CodCentro AND 
			SUBSTRING(ST.CodEpisodio,1,1) = ISNULL(@spvar_Tipo,SUBSTRING(ST.CodEpisodio,1,1)) AND 
			((@spvar_Internos = 1 AND TipoTrasladoOri = 0 AND TipoTrasladoDes = 0 AND CodAreaOri IS NOT NULL AND CodAreaDes IS NOT NULL) OR
			 (@spvar_Externos = 1 AND (TipoTrasladoOri = 1 OR TipoTrasladoDes = 1 OR CodAreaOri IS NULL OR CodAreaDes IS NULL)))
			AND
			ST.FSolicitud BETWEEN ISNULL(@spvar_FechaDesde, ST.FSolicitud) AND ISNULL(@spvar_FechaHasta, ST.FSolicitud)
		)
END

GO

GO



--dbo.SpHClSTrazabilidadST.sql

USE [Hclinica]
GO

IF EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[SpHClSTrazabilidadST]') AND type in (N'P', N'PC'))
DROP PROCEDURE [dbo].[SpHClSTrazabilidadST]
GO

/****************************************************
PROCEDIMIENTO	: SpHClSTrazabilidadST
FUNCION			: *Seleccionar el Descriptivo del estado de una Solicitud de Traslado
FECHA			: 23/08/2017
VERSION			: 17.3 - 19362 - Gestor de Solicitudes de Traslado
AUTOR			: Marco Polo Ruiz
MODIFICACIÓN	: ASM - 17.3 - 19362 - Cambio el Substring
****************************************************/

CREATE PROCEDURE [dbo].[SpHClSTrazabilidadST]
    @spvar_IdSolicitudTraslado BIGINT

AS 

BEGIN 
	SELECT EST.DesEstSolTran, TT.FechaCambio, TT.FechaRegistro, TT.Descripcion, TT.NIFUsuario, RTRIM(VDU.NombreCompleto) AS Usuario
		  
	FROM Hclinica..TrazabilidadST TT
	LEFT JOIN Parametros..vParDatosUsuarios VDU ON VDU.Dni = SUBSTRING(TT.NIFUsuario,1,8)
	LEFT JOIN Parametros..EstSolTrans  EST ON TT.IdEstSolTrans = EST.IdEstSolTrans
	WHERE 
		(TT.IdSolicitudTraslado =@spvar_IdSolicitudTraslado)
	ORDER BY TT.FechaCambio DESC
END

GO

GO



--dbo.SpHClUEstadoSolicitudTraslado.sql

USE [Hclinica]
GO

IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[SpHClUEstadoSolicitudTraslado]') AND type in (N'P', N'PC'))
DROP PROCEDURE [dbo].[SpHClUEstadoSolicitudTraslado]
GO

USE [Hclinica]
GO

SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

/*
PROCEDIMIENTO : [SpHClUEstadoSolicitudTraslado]
FUNCION:  Modifica el estado de las solicitudes de traslado 
DEVUELVE:
FECHA: 24/07/2013
VERSION: 1.0
AUTOR: MAIPU CHC2503 V4.40 FCB, Solicitudes de traslado
MODIFICACIÓN: ASM - 17.3 - 19362
*/

CREATE PROCEDURE [dbo].[SpHClUEstadoSolicitudTraslado]
	@spvar_IdSolicitudTraslado bigint,
	@spvar_IdEstSolTrans tinyint,
	@spvar_FModificacion SMALLDATETIME = NULL
AS 
BEGIN 
	UPDATE Hclinica..SolicitudTraslado
	   SET IdEstSolTrans=@spvar_IdEstSolTrans,
	       FModificacion = ISNULL(@spvar_FModificacion, FModificacion)
		WHERE IdSolicitudTraslado=@spvar_IdSolicitudTraslado
END
GO



--dbo.spHClUPaciente_Activar.sql

USE HClinica
GO

/****** Object:  StoredProcedure [dbo].[spHClUPaciente_Activar]    Script Date: 08/10/2017 13:08:41 ******/
IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[spHClUPaciente_Activar]') AND type in (N'P', N'PC'))
DROP PROCEDURE [dbo].spHClUPaciente_Activar
GO

USE HClinica
GO

/****** Object:  StoredProcedure [dbo].[spHClUPaciente_Activar]    Script Date: 08/10/2017 13:08:41 ******/
SET ANSI_NULLS OFF
GO

SET QUOTED_IDENTIFIER OFF
GO



/*********************************************************************
* NOMBRE:		spHClUPaciente_Activar
* DESCRIPCION:	Activa el paciente poniendo FecFin a NULL
* FECHA:		10/08/2017
* AUTOR:		V17.3 - 19364 - ASM - Revertir estado de fallecimiento del paciente
'*******************************************************************/

CREATE PROC [dbo].spHClUPaciente_Activar
	@spvar_CodPaciente CHAR(16)
AS
	UPDATE
		Pacientes
	SET
		FecFin = NULL
	WHERE
		CodPaciente = @spvar_CodPaciente



GO



GO



--dbo.SpHClUPreoperatoriaHemo.sql

USE [HClinica];
GO
IF EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[SpHClUPreoperatoriaHemo]') AND type in (N'P', N'PC'))
	DROP PROCEDURE [dbo].[SpHClUPreoperatoriaHemo]
GO

/****************************************************
PROCEDIMIENTO	: SpHClUPreoperatoriaHemo
FUNCION			: Actualizar la necesidad de hemoderivados
FECHA			: 08/08/2017
VERSION			: 17.2r3 - 19504
AUTOR			: Marco Polo Ruiz
****************************************************/
CREATE PROCEDURE [dbo].[SpHClUPreoperatoriaHemo]

@spvar_CodIntervencion char(7)
AS

IF EXISTS (SELECT * FROM HClinica..Preoperatoria WHERE CodHojaPreop=@spvar_CodIntervencion)
 BEGIN
  UPDATE HClinica..Preoperatoria 
  SET NecesHemoderiv = 0
  WHERE CodHojaPreop=@spvar_CodIntervencion
 END
GO
GO



--dbo.SpHClUProcEstSolicitudTraslado.sql

USE [Hclinica]
GO
    IF EXISTS 
    (
        SELECT * 
            FROM sys.procedures 
            WHERE [object_id] = OBJECT_ID('[dbo].[SpHClUProcEstSolicitudTraslado]')
    )
    BEGIN
        DROP PROCEDURE SpHClUProcEstSolicitudTraslado
    END   
GO

/****** Object:  StoredProcedure [dbo].[SpIHCUEstadoSolicitudTraslado]    Script Date: 08/13/2013 11:10:11 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO
   
/***********************************************************************
PROCEDIMIENTO: SpHClUProcEstSolicitudTraslado
FUNCION: Procesa y notifica mensajes de solicitud de tralado del WS SAP-SD
FECHA: 01/08/2013
VERSION: 1.0
AUTOR: CMM 
ID CREACIÓN: CHC2450 - v4.40 Release 1 - MAIPU
MODIFICACION: 22/08/2017 - v17.3 - 19362 - MPR - Gestor de Solicitudes de Traslado
***********************************************************************/

CREATE PROCEDURE [dbo].SpHClUProcEstSolicitudTraslado
	@spvar_IdMensaje bigint
   ,@spvar_IdSolicitud bigint
   ,@spvar_EstadoOrden int
AS

DECLARE @Error bit=null
DECLARE @CodError char(5)='00000'
DECLARE @DescError varchar(100)=null
DECLARE @FLeidoFlorence smalldatetime=getdate()
DECLARE @IdSolicitudOrigen int = null


IF ((@spvar_EstadoOrden <> 2) AND (@spvar_EstadoOrden <> 3) AND (@spvar_EstadoOrden <> 4) AND (@spvar_EstadoOrden <> 5) AND (@spvar_EstadoOrden <> 6))
BEGIN
--El código de actualización no es correcto.
	SELECT @Error = 1
	SELECT @CodError = '00021'
END

IF  @Error is NULL AND NOT EXISTS(SELECT * 
                                    FROM Hclinica..SolicitudTraslado
                                   WHERE IdSolicitudTraslado  = @spvar_IdSolicitud)
BEGIN
	--No existe la solicitud a actualizar
	SELECT @Error = 1
	SELECT @CodError = '00022'
END

--Si no hay errores recuperamos el estado de la solicitud
IF @Error is NULL AND (SELECT IdEstSolTrans 
                         FROM Hclinica..SolicitudTraslado  
                        WHERE IdSolicitudTraslado  = @spvar_IdSolicitud) <> 1

BEGIN
--El estado actual de la solicitud no se puede modificar
	SELECT @Error = 1
	SELECT @CodError = '00023'

END
  
--Si no hay error procedemos a actualizar
IF @Error is NULL
	BEGIN
		EXEC HClinica..SpHClUEstadoSolicitudTraslado @spvar_IdSolicitud, @spvar_EstadoOrden
	END
 
EXEC Inter_his_consell..SpIHCUNotificacionSolTraslado 
												 @spvar_IdMensaje
												,@Error
												,@DescError
												,@CodError
												,@FLeidoFlorence
 
--Se devuelven las variables de error
SELECT @Error AS Error,@DescError AS DescError,@CodError AS CodError


GO



GO



--dbo.SpHClUSolicitudTraslado.sql

USE [Hclinica]
GO

IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[SpHClUSolicitudTraslado]') AND type in (N'P', N'PC'))
DROP PROCEDURE [dbo].[SpHClUSolicitudTraslado]
GO

USE [Hclinica]
GO

SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

/*
PROCEDIMIENTO : [SpHClUSolicitudTraslado]
FUNCION:  Modifica las solicitudes de traslado 
DEVUELVE:
FECHA: 24/07/2013
VERSION: 1.0
AUTOR: MAIPU CHC2503 V4.40 FCB, Solicitudes de traslado
MODIFICACION: 24/08/2017 - v17.3 - 19248 - MPR - Modificaciones en Solicitud de Traslado Externa desde Admision e Historia Clinica
*/

CREATE PROCEDURE [dbo].[SpHClUSolicitudTraslado]
	@spvar_IdSolicitudTraslado bigint,
	@spvar_FSolicitud datetime=NULL,
	@spvar_FModificacion datetime,
	@spvar_IdEstSolTrans TinyInt=1,
	@spvar_IdPrioSolTrans TinyInt=NULL,
	@spvar_TipoTrasladoOri TinyInt=NULL,  
	@spvar_TipoTrasladoDes TinyInt=NULL, 
	@spvar_IdTipoVehiculoTras smallint=NULL,  
	@spvar_Retorno bit=0,
	@spvar_Medicalizado bit=0,
	@spvar_CodCentro char(5)=NULL,
	@spvar_CodCentroOri char(5)=NULL,
	@spvar_CodAreaOri Varchar(3)=NULL,
	@spvar_CodPlantasOri Char(4)=NULL,
	@spvar_NumCamaOri Char(7)=NULL,
	@spvar_CodCamaOri Char(10)=NULL,
	@spvar_CodUbiConsOri Char(2)=NULL,
	@spvar_CodSalaOri Char(3)=NULL,
	@spvar_NumQuirofanoOri Char(2)=NULL,
	@spvar_CodServicioOri Char(4)=NULL,
	@spvar_CodCentroDes char(5)=NULL,
	@spvar_CodAreaDes Varchar(3)=NULL,
	@spvar_CodPlantasDes Char(4)=NULL,
	@spvar_NumCamaDes Char(7)=NULL,
	@spvar_CodCamaDes Char(10)=NULL,
	@spvar_CodUbiConsDes Char(2)=NULL,
	@spvar_CodSalaDes Char(3)=NULL,
	@spvar_NumQuirofanoDes Char(2)=NULL,
	@spvar_CodServicioDes Char(4)=NULL,
	@spvar_TrasExtOri Char(1)=NULL,
	@spvar_DesTrasExtOri Varchar(250)=NULL,
	@spvar_TrasExtDes Char(1)=NULL,
	@spvar_DesTrasExtDes Varchar(250)=NULL,
	@spvar_Observaciones Varchar(200)=NULL,
	@spvar_CodAcompanyante INT = NULL,
	@spvar_DNIMedicoTraslada CHAR(8) = NULL,
	@spvar_DNIEnfermeraTraslada CHAR(8) = NULL,
	@spvar_NombreMedicoRecibe VARCHAR(200) = NULL,
	@spvar_NombreEnfermeraRecibe VARCHAR(200) = NULL,
	@spvar_NombreMatronaRecibe VARCHAR(200) = NULL
	
AS 

BEGIN 
	IF @spvar_IdEstSolTrans=3 --Si se elimina solo se modifica la fecha de modificacion y el estado 
		BEGIN
			UPDATE Hclinica..SolicitudTraslado
			   SET FModificacion = @spvar_FModificacion,IdEstSolTrans=@spvar_IdEstSolTrans
			WHERE IdSolicitudTraslado=@spvar_IdSolicitudTraslado
		END
	ELSE
		BEGIN
			UPDATE Hclinica..SolicitudTraslado
			   SET FSolicitud= @spvar_FSolicitud,FModificacion = @spvar_FModificacion,IdEstSolTrans=@spvar_IdEstSolTrans
				  ,IdPrioSolTrans = @spvar_IdPrioSolTrans,IdTipoVehiculoTras = @spvar_IdTipoVehiculoTras
				  ,TipoTrasladoOri = @spvar_TipoTrasladoOri ,TipoTrasladoDes = @spvar_TipoTrasladoDes
				  ,Retorno = @spvar_Retorno,Medicalizado = @spvar_Medicalizado,CodCentro= @spvar_CodCentro
				  ,CodCentroOri = @spvar_CodCentroOri, CodAreaOri = @spvar_CodAreaOri
				  ,CodPlantasOri = @spvar_CodPlantasOri ,NumCamaOri = @spvar_NumCamaOri
				  ,CodCamaOri = @spvar_CodCamaOri, CodUbiConsOri = @spvar_CodUbiConsOri
				  ,CodSalaOri = @spvar_CodSalaOri, NumQuirofanoOri =@spvar_NumQuirofanoOri
				  ,CodServicioOri = @spvar_CodServicioOri, CodCentroDes = @spvar_CodCentroDes
				  ,CodAreaDes = @spvar_CodAreaDes, CodPlantasDes = @spvar_CodPlantasDes
				  ,NumCamaDes =@spvar_NumCamaDes, CodCamaDes = @spvar_CodCamaDes
				  ,CodUbiConsDes = @spvar_CodUbiConsDes, CodSalaDes = @spvar_CodSalaDes
				  ,NumQuirofanoDes =@spvar_NumQuirofanoDes, CodServicioDes = @spvar_CodServicioDes
				  ,TrasExtOri = @spvar_TrasExtOri, DesTrasExtOri = @spvar_DesTrasExtOri
				  ,TrasExtDes = @spvar_TrasExtDes, DesTrasExtDes = @spvar_DesTrasExtDes
				  ,Observaciones = @spvar_Observaciones
				  ,CodAcompanyante = @spvar_CodAcompanyante
				  ,DNIMedicoTraslada = @spvar_DNIMedicoTraslada
				  ,DNIEnfermeraTraslada = @spvar_DNIEnfermeraTraslada
				  ,NombreMedicoRecibe = @spvar_NombreMedicoRecibe
				  ,NombreEnfermeraRecibe = @spvar_NombreEnfermeraRecibe
				  ,NombreMatronaRecibe = @spvar_NombreMatronaRecibe
				WHERE IdSolicitudTraslado=@spvar_IdSolicitudTraslado
		END
END
GO



--dbo.spHistIExitus.sql

USE Historificacion
GO

/****** Object:  StoredProcedure [dbo].[spHistIExitus]    Script Date: 08/10/2017 13:08:41 ******/
IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[spHistIExitus]') AND type in (N'P', N'PC'))
DROP PROCEDURE [dbo].spHistIExitus
GO

USE Historificacion
GO

/****** Object:  StoredProcedure [dbo].[spHistIExitus]    Script Date: 08/10/2017 13:08:41 ******/
SET ANSI_NULLS OFF
GO

SET QUOTED_IDENTIFIER OFF
GO



/*********************************************************************
* NOMBRE:		spHistIExitus
* DESCRIPCION:	Inserta una nueva fila en la historificación del Exitus a partir de la fila de Exitus a la que hemos cambiado el estado
* FECHA:		10/08/2017
* AUTOR:		V17.3 - 19364 - ASM - Revertir estado de fallecimiento del paciente
'*******************************************************************/

CREATE PROC [dbo].spHistIExitus
	@spvar_CodPaciente CHAR(16)
AS
	INSERT INTO HClinica_Exitus
	(
		CodPaciente,
		CodHistoria,
		MotivoInmediato,
		MotivoIntermedio,
		MotivoFundamental,
		Obs,
		Usuario,
		DNIMedico,
		RegistroHC,
		Folio,
		DniMedicoActivacion,
		F_Activacion,
		F_Historificacion
	)
	SELECT
		CodPaciente,
		CodHistoria,
		MotivoInmediato,
		MotivoIntermedio,
		MotivoFundamental,
		Obs,
		Usuario,
		DNIMedico,
		RegistroHC,
		Folio,
		DniMedicoActivacion,
		F_Activacion,
		GETDATE()
	FROM
		HClinica..Exitus
	WHERE
		CodPaciente = @spvar_CodPaciente



GO



GO



--dbo.SpIHCIPropuestasEliminadas.sql

USE [Inter_his_consell];
GO
IF EXISTS (SELECT * FROM sys.procedures WHERE [object_id] = OBJECT_ID('[dbo].[SpIHCIPropuestasEliminadas]'))
BEGIN
    DROP PROCEDURE [dbo].[SpIHCIPropuestasEliminadas];
END
GO
    
/*********************************************************************
* FUNCION  : Inserta el registro para ser comunicado
* DEVUELVE :
* FECHA	   : 15/11/2010
* VERSION  : 1.0
* AUTOR	   : Paco Aznar
* ORIGEN   : Servicio Intercomunicacion Chile
*********************************************************************
* MODIFICACION: (20/11/2014) Alberto Pagán Benedicto - V4.49 - 1440 - APB - Segunda parte Derivación entre instancias
* MODIFICACION: (20/04/2015) - V4.49r2 – 1992 – APB – Observaciones Derivación SIC
* MODIFICACION: (17/08/2016) - V4.63 – 12711 – CCM – Auditoria SIC
* MODIFICACION: (23/08/2017) - v17.3 – 18451 – FCB - Ingresar observación al motivo de egreso en SIC
*********************************************************************/

CREATE PROCEDURE [dbo].[SpIHCIPropuestasEliminadas]
	@spvar_codPaciente char(16)
   ,@spvar_codEpisodio char(5)
   ,@spvar_Fecha smalldatetime
   ,@spvar_Observaciones varchar(500)
   ,@spvar_Motivo int
   ,@spvar_codCentro char(5)
   ,@spvar_CodSistema tinyint = null 
   ,@spvar_CodCentroOrigen char(5) = null 
   ,@spvar_Puesto varchar(50) = ''
   ,@spvar_Usuario varchar(8) = ''
	,@spvar_RUNProfesional varchar(9) = null
	,@spvar_NomProfesional varchar(80) = null
	,@spvar_Observacion varchar(500) = null
AS

begin
	insert into Inter_His_Consell..PropuestasEliminadas
		(CodPaciente
		,CodEpisodio
		,FechaEvento
		,Observaciones
		,Motivo
		,CodCentro
		,CodSistema 
		,CodCentroOrigen
		,Usuario
		,Puesto
		,RUNProfEgreso
		,NomProfEgreso
		,ObservacionEgreso
		) 
	values
		(@spvar_codPaciente
		,@spvar_codEpisodio
		,@spvar_Fecha
		,@spvar_Observaciones
		,@spvar_Motivo
		,@spvar_codCentro
		,@spvar_CodSistema 
		,@spvar_CodCentroOrigen
		,@spvar_Usuario
		,@spvar_Puesto
		,@spvar_RUNProfesional
		,@spvar_NomProfesional
		,@spvar_Observacion
		) 
end

GO

GO



--dbo.SpIHCSPropuestasEliminadas.sql

USE [Inter_his_consell];
GO
IF EXISTS (SELECT * FROM sys.procedures WHERE [object_id] = OBJECT_ID('[dbo].[SpIHCSPropuestasEliminadas]'))
BEGIN
    DROP PROCEDURE [dbo].[SpIHCSPropuestasEliminadas];
END
GO
    
/*********************************************************************
* FUNCION  : Obtiene los registros a comunicar
* DEVUELVE :
* FECHA	   : 29/12/2010
* VERSION  : 1.0
* AUTOR	   : Paco Aznar
* ORIGEN   : Servicio Intercomunicacion Chile
*********************************************************************
* MODIFICACION: (20/11/2014) - V4.49 - 1440 - APB - Segunda parte Derivación entre instancias
* MODIFICACION: (20/04/2015) - V4.49r2 – 1992 – APB – Observaciones Derivación SIC
* MODIFICACION: (21/09/2016) - V4.59r10 - 13071 - APB - Error integración Florence - Rayen (campo IdSIC)
* MODIFICACION: (17/08/2016) - V4.63 – 12711 – CCM – Auditoria SIC
* MODIFICACION: (19/04/2017) - V4.64r10 – PVC – Se agrega cruce con EpisodioConsultas
* MODIFICACION: (23/08/2017) - v17.3 – 18451 – FCB - Ingresar observación al motivo de egreso en SIC
*********************************************************************/

CREATE PROCEDURE [dbo].[SpIHCSPropuestasEliminadas]
	@spvar_CodSistema tinyint = null 
AS

begin
	declare @MaxIntentos as int
	set @MaxIntentos = Parametros.dbo.fnParValorConstanteCentro('m_intMaxIntentosNotificaciones','')

	select pe.IDRegistro
		  ,pe.CodPaciente
		  ,pe.CodEpisodio
		  ,pe.FechaEvento
		  ,pe.Observaciones
		  ,mc.ID_Sidra as Motivo
		  ,pe.CodCentro
		  ,pe.CodSistema
		  ,mc.Descripcion as DescMotivo
		  ,mc.MotivoEliAusencias as EliAutoAsist
		  ,mc.MotivoEliRechazoCita as EliAutoRechazo
		  ,pe.CodCentroOrigen 
		  ,pe.Usuario
		  ,pe.Puesto
		  ,isnull(EC.IdSIC,E.IdSIC) as IdSIC
		  ,pe.RUNProfEgreso
		  ,pe.NomProfEgreso
		  ,pe.ObservacionEgreso
	from Inter_His_Consell..PropuestasEliminadas pe
		 LEFT JOIN Parametros..MotivosCitas mc on mc.Codigo = pe.Motivo
		 LEFT JOIN Consultas..EpisodioConsultasBorrados EC ON EC.CodPaciente = pe.CodPaciente AND EC.CodEpisodio = pe.CodEpisodio
		 LEFT JOIN Consultas..EpisodioConsultas E ON E.CodPaciente = pe.CodPaciente AND E.CodEpisodio = pe.CodEpisodio
	where pe.FechaNotificacion is null and (pe.Intentos is null or pe.Intentos < @MaxIntentos)
		  and pe.CodSistema = ISNULL(@spvar_CodSistema,pe.CodSistema) 
		
	update Inter_His_Consell..PropuestasEliminadas
	set Intentos = ISNULL(Intentos,0) + 1
	where FechaNotificacion is null and (Intentos is null or Intentos < @MaxIntentos)
	      and CodSistema = ISNULL(@spvar_CodSistema,CodSistema) 
end

GO
GO



--dbo.SpIHCUNotificarSolicitudEgresada.sql

USE [Inter_his_consell]
GO

/****** Object:  StoredProcedure [dbo].[SpIHCUNotificarSolicitudEgresada]    Script Date: 01/15/2015 12:56:22 ******/
IF EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[SpIHCUNotificarSolicitudEgresada]') AND type in (N'P', N'PC'))
	DROP PROCEDURE [dbo].[SpIHCUNotificarSolicitudEgresada]
GO

/****** Object:  StoredProcedure [dbo].[SpIHCUNotificarSolicitudEgresada]    Script Date: 01/15/2015 12:56:22 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

/************************************************************************
PROCEDIMIENTO     : SpIHCUNotificarSolicitudEgresada
FUNCION		      : Pasa a egresada una consulta derivaciÃ³n
DEVUELVE	      :
FECHA		      : 22/12/2014
VERSION		      : 1.0
AUTOR		      : Ana Castillo Torrent
APLICACIÃ“N ORIGEN : Florence ClÃ­nico - WS Interconsultas
ID CREACIÃ“N       : (22/12/2014) - V4.49 â€“ 1440 â€“ ACT â€“ Segunda parte DerivaciÃ³n entre instancias
MODIFICACION      : (20/04/2015) - V4.49r2 â€“ 1992 â€“ APB â€“ Observaciones DerivaciÃ³n SIC
MODIFICACION      : (30/04/2015) - v4.49r3 â€“ 2156 â€“ APO â€“ DerivaciÃ³n SIC
MODIFICACION      : (23/08/2017) - v17.3 â€“ 18451 â€“ FCB - Ingresar observaciÃ³n al motivo de egreso en SIC
************************************************************************/

CREATE PROCEDURE [dbo].[SpIHCUNotificarSolicitudEgresada]
	 @spvar_CodPaciente char(16)
	,@spvar_CodEpisodio char(5)
	,@spvar_IdMotivo int
	,@spvar_Motivo varchar(500) = null
	,@spvar_Puesto varchar(50) = null
	,@spvar_Usuario varchar(8) = null
	,@spvar_EliAutoAsist bit = null
	,@spvar_EliAutoRechazo bit = null
	,@spvar_FechaEgresada smalldatetime
	,@spvar_RUNProfesional varchar(9) = null
	,@spvar_NomProfesional varchar(80) = null
	,@spvar_Observacion varchar(500) = null
AS

BEGIN
	declare @Estado char(1)
	declare @CodMotivo int, @DescMotivo varchar(300)
	declare @CodDerivacion char(5), @CodPaciente char(16)
	
	select @Estado = (select Codigo
					  from Parametros..Codigos
					  where Tabla = 'Estado Propuesta' and Posicion = 0)
			
	
	IF not exists(SELECT CodPaciente FROM Consultas..DerivacionConsultas
							WHERE CodPacienteDestino = @spvar_CodPaciente AND CodEpisodioDestino = @spvar_CodEpisodio)
			BEGIN
			
			--v4.49r3 â€“ 2156 â€“ APO â€“ DerivaciÃ³n SIC INI
			
			SELECT @CodDerivacion = CodDerivacion
				  ,@CodPaciente = CodPaciente
			FROM Consultas..DerivacionConsultasBorrados 
			WHERE CodPacienteDestino = @spvar_CodPaciente AND CodEpisodioDestino = @spvar_CodEpisodio
			
			select @CodMotivo = MC.codigo, @DescMotivo = Descripcion
							from parametros..MotivosCitas MC
							inner join Consultas..DerivacionConsultasBorrados DC on CodPacienteDestino = @spvar_CodPaciente 
																		AND CodEpisodioDestino = @spvar_CodEpisodio 
																		AND DC.CodCentroOrigen = MC.CodCentro
							where MC.ID_Sidra = @spvar_IdMotivo
							
			--v4.49r3 â€“ 2156 â€“ APO â€“ DerivaciÃ³n SIC FIN
			update Consultas..DerivacionConsultasBorrados
			set Estado = @Estado
			   ,IdMotivo = @CodMotivo --v4.49r3 â€“ 2156 â€“ APO â€“ DerivaciÃ³n SIC
			   ,Asistido = null --v4.49r3 â€“ 2156 â€“ APO â€“ DerivaciÃ³n SIC
			   ,DescMotivoPasiva = @DescMotivo --v4.49r3 â€“ 2156 â€“ APO â€“ DerivaciÃ³n SIC
			   ,RUNProfEgreso = @spvar_RUNProfesional
			   ,NomProfEgreso = @spvar_NomProfesional
			   ,ObservacionEgreso = @spvar_Observacion
			where CodPacienteDestino = @spvar_CodPaciente and CodEpisodioDestino = @spvar_CodEpisodio
			
			END
	
	ELSE
			
			BEGIN
			
			--(20/04/2015) - V4.49r2 â€“ 1992 â€“ APB â€“ Observaciones DerivaciÃ³n SIC - INI
			SELECT @CodDerivacion = CodDerivacion
				  ,@CodPaciente = CodPaciente
			FROM Consultas..DerivacionConsultas
			WHERE CodPacienteDestino = @spvar_CodPaciente AND CodEpisodioDestino = @spvar_CodEpisodio
			--(20/04/2015) - V4.49r2 â€“ 1992 â€“ APB â€“ Observaciones DerivaciÃ³n SIC - FIN		
	
			--v4.49r3 â€“ 2156 â€“ APO â€“ DerivaciÃ³n SIC INI
			select @CodMotivo = (select MC.codigo 
							from parametros..MotivosCitas MC
							inner join Consultas..DerivacionConsultas DC on CodPacienteDestino = @spvar_CodPaciente 
																		AND CodEpisodioDestino = @spvar_CodEpisodio 
																		AND DC.CodCentroOrigen = MC.CodCentro
							where MC.ID_Sidra = @spvar_IdMotivo)
			--v4.49r3 â€“ 2156 â€“ APO â€“ DerivaciÃ³n SIC FIN
			update Consultas..DerivacionConsultas
			set Estado = @Estado
			   ,IdMotivo = @CodMotivo --v4.49r3 â€“ 2156 â€“ APO â€“ DerivaciÃ³n SIC
			   ,RUNProfEgreso = @spvar_RUNProfesional
			   ,NomProfEgreso = @spvar_NomProfesional
			   ,ObservacionEgreso = @spvar_Observacion
			where CodPacienteDestino = @spvar_CodPaciente and CodEpisodioDestino = @spvar_CodEpisodio
			
			END
	 
		   	
	INSERT INTO Consultas.dbo.TrazabilidadDerivacionConsultas
       (CodPaciente
       ,CodDerivacion
       ,Usuario
       ,Puesto          
       ,FEliminacion        
       ,Motivo           
       ,EliAutomaticaAusencia
       ,EliAutomaticaRechazo)
	VALUES
	   (isnull(@CodPaciente,'') --CodPaciente --(20/04/2015) - V4.49r2 â€“ 1992 â€“ APB â€“ Observaciones DerivaciÃ³n SIC
       ,isnull(@CodDerivacion,'') --CodDerivacion
       ,isnull(@spvar_Usuario,'') --Usuario
       ,isnull(@spvar_Puesto,'') --Puesto
       ,@spvar_FechaEgresada --FEliminacion
       ,@spvar_Motivo --Motivo
       ,@spvar_EliAutoAsist --EliAutomaticaAusencia
       ,@spvar_EliAutoRechazo) -- EliAutomaticaRechazo
END



GO
GO



--dbo.SpIngIAsociarTriaje.sql

    USE [Ingresos];
    GO
    IF EXISTS 
    (
        SELECT * 
            FROM sys.procedures 
            WHERE [object_id] = OBJECT_ID('[dbo].[SpIngIAsociarTriaje]')
    )
    BEGIN
        DROP PROCEDURE [dbo].[SpIngIAsociarTriaje];
    END
    GO
    

/*********************************************************************
PROCEDIMIENTO : [SpIngIAsociarTriaje]
FUNCION: Asocia un triaje a una hoja de urgencias
DEVUELVE:
FECHA:21/07/2006
VERSION: 1.0
AUTOR: Javier Mart¡n  Mart¡nez
APLICACIàN ORIGEN   : Admision.FBusTriaje
Modificacion: azaragoza 13-12-07 Quito el campo CodRegistro de la insert
Modificacion: 29/06/2017 - V17.2r1 - 18277 - SGH - Triaje ESI 
'********************************************************************/


CREATE PROCEDURE  [dbo].[SpIngIAsociarTriaje]
	@Id int,
	@CodUrgencia char(7) = NULL
AS
IF NOT EXISTS (SELECT ID
				FROM HISTORICOTRIAJES
				WHERE ID = @ID)
	BEGIN
			INSERT INTO 
				HistoricoTriajes(
					Id,
					FechaAlta,
					Nombre,
					Apellido1,
					Apellido2,
					Prioridad,
					TUrgencia,
					Observaciones,
					CodTriaje,
					DniUsu,
					Sexo,
					Edad,
					Tipo,
					ReqIntSalVid,
					AltoRiesgo,
					Recursos,
					SVAlterados,
					Alterados,
					AVDI,
					Distresado,
					EVAMenor,
					EVAMayor
					)					
				SELECT
					Id,
					FechaAlta,
					Nombre,
					Apellido1,
					Apellido2,
					Prioridad,
					TUrgencia,
					Observaciones,
					CodTriaje,
					DniUsu,
					Sexo,
					Edad,
					Tipo,
					ReqIntSalVid,
					AltoRiesgo,
					Recursos,
					SVAlterados,
					Alterados,
					AVDI,
					Distresado,
					EVAMenor,
					EVAMayor
				FROM
					Triajes
				WHERE
					Id=@Id
		SELECT '1'
	END
ELSE
	BEGIN

		SELECT '0'
	END
GO
GO



--dbo.SpIngIAsociarTriajeNuevo.sql

    USE [Ingresos];
    GO
    IF EXISTS 
    (
        SELECT * 
            FROM sys.procedures 
            WHERE [object_id] = OBJECT_ID('[dbo].[SpIngIAsociarTriajeNuevo]')
    )
    BEGIN
        DROP PROCEDURE [dbo].[SpIngIAsociarTriajeNuevo];
    END
    GO
    
/*
PROCEDIMIENTO : [SpIngIAsociarTriajeNuevo]
FUNCION: Asocia un triaje a una hoja de urgencias
DEVUELVE:
FECHA: 09/07/2007
VERSION: 1.0
AUTOR:MPS
APLICACIàN ORIGEN   : Triaje

Modificado: azaragoza. 13-12-2007. Elimino el campo CodUrgencia de la insert
Modificado: 29/06/2017 - V17.2r1 - 18277 - SGH - Triaje ESI 
*/


CREATE PROCEDURE  [dbo].[SpIngIAsociarTriajeNuevo]
	@spvar_idTriaje int,
	@spvar_CodUrgencia char(7) = NULL
AS
IF NOT EXISTS (SELECT ID
				FROM HISTORICOTRIAJES
				WHERE ID = @spvar_idTriaje)
	BEGIN
			INSERT INTO 
				HistoricoTriajes(
					Id,
					FechaAlta,
					Nombre,
					Apellido1,
					Apellido2,
					Prioridad,
					TUrgencia,
					Observaciones,
					CodTriaje,
					DniUsu,
					Sexo,
					Edad,
					CodPaciente,
					CodEpisodio,
					Tipo,
					ReqIntSalVid,
					AltoRiesgo,
					Recursos,
					SVAlterados,
					Alterados,
					AVDI,
					Distresado,
					EVAMenor,
					EVAMayor)
				SELECT
					Id,
					FechaAlta,
					Nombre,
					Apellido1,
					Apellido2,
					Prioridad,
					TUrgencia,
					Observaciones,
					CodTriaje,
					DniUsu,
					Sexo,
					Edad,
					codpaciente,
					codepisodio,
					Tipo,
					ReqIntSalVid,
					AltoRiesgo,
					Recursos,
					SVAlterados,
					Alterados,
					AVDI,
					Distresado,
					EVAMenor,
					EVAMayor
				FROM
					Triajes
				WHERE
					Id=@spvar_idTriaje
		SELECT '1'
	END
ELSE
	BEGIN

		SELECT '0'
	END
GO
GO



--dbo.SpIngINuevoTriaje.sql

    USE [Ingresos];
    GO
    IF EXISTS 
    (
        SELECT * 
            FROM sys.procedures 
            WHERE [object_id] = OBJECT_ID('[dbo].[SpIngINuevoTriaje]')
    )
    BEGIN
        DROP PROCEDURE [dbo].[SpIngINuevoTriaje];
    END
    GO
    

/*********************************************************************
* FUNCION :[SpIngINuevoTriaje]
* DEVUELVE : inserta los datos del triaje en la tabla y modifica el campo CausaUrgencias de la tabla
*				EpisodioUrgencias del paciente 
* FECHA	: 06/07/07
* VERSION : 1.0
* AUTOR	: MPS
* ORIGEN : Triaje
'*******************************************************************
* MODIFICACION: 09/07/2009 Oscar Vilella. Actualizamos el Area del EpisodioUrgencia con el tipo del triaje
* MODIFICACIÓN : 29/06/2017 - V17.2r1 - 18277 - SGH - Triaje ESI 
'*******************************************************************/

CREATE PROCEDURE  [dbo].[SpIngINuevoTriaje]
	@spvar_FechaAlta datetime,
	@spvar_Nombre char(15),
	@spvar_Apellido1 char(15),
	@spvar_Apellido2 char(15)='',
	@spvar_Prioridad TinyInt,
	@spvar_TUrgencia TinyInt,
	@spvar_Observ varchar(4000)='',
	@spvar_CodTriaje varchar(14),
	@spvar_DniUsu char(9),
	@spvar_Edad tinyint,
	@spvar_Sexo char(1),
	@spvar_CodPaciente char(16) = null,
	@spvar_CodEpisodio char(5)= null,
	@spvar_Tipo tinyint = NULL,
	@spvar_ReqIntSalVid bit = NULL,
	@spvar_AltoRiesgo bit = NULL,
	@spvar_Recursos tinyint = NULL,
	@spvar_SVAlterados bit = NULL,
	@spvar_Alterados char (73) = NULL,
	@spvar_AVDI tinyint = NULL,
	@spvar_Distresado bit = NULL,
	@spvar_EVAMenor bit = NULL,
	@spvar_EVAMayor bit = NULL
		
AS
declare @fecha_triaje smalldatetime

INSERT INTO Triajes(FechaAlta,
					Nombre,
					Apellido1,
					Apellido2,
					Prioridad,
					TUrgencia,
					Observaciones,
					CodTriaje,
					DniUsu,
					Edad,
					Sexo,
					CodPaciente,
					CodEpisodio,
					Tipo,
					ReqIntSalVid,
					AltoRiesgo,
					Recursos,
					SVAlterados,
					Alterados,
					AVDI,
					Distresado,
					EVAMenor,
					EVAMayor
					)
			VALUES(	@spvar_FechaAlta,
					@spvar_Nombre,
					@spvar_Apellido1,
					@spvar_Apellido2,
					@spvar_Prioridad,
					@spvar_TUrgencia,
					@spvar_Observ,
					@spvar_CodTriaje,
					@spvar_DniUsu,
					@spvar_Edad,
					@spvar_Sexo,
					@spvar_CodPaciente,
					@spvar_CodEpisodio,
					@spvar_Tipo,
					@spvar_ReqIntSalVid,
					@spvar_AltoRiesgo,
					@spvar_Recursos,
					@spvar_SVAlterados,
					@spvar_Alterados,
					@spvar_AVDI,
					@spvar_Distresado,
					@spvar_EVAMenor,
					@spvar_EVAMayor)

-- actualizamos el campo CausaUrgencias y la prioridad de la urgencia del Episodio de urgencias del paciente
if @spvar_CodPaciente is not null and @spvar_CodEpisodio is not null 
	update ingresos..episodiourgencias
	set causaurgencias = @spvar_Observ, 
		preferencia = @spvar_Prioridad,
		preferenciaini = @spvar_Prioridad,
		Area = @spvar_TUrgencia 
	where codpaciente = @spvar_CodPaciente
			and codepisodio = @spvar_CodEpisodio

-- si la fecha de triaje es nula, la actualizamos
select @fecha_triaje = ftriaje 
from ingresos..episodiourgencias
where codpaciente = @spvar_CodPaciente
    	and codepisodio = @spvar_CodEpisodio 

if @fecha_triaje is null and @spvar_CodPaciente is not null and @spvar_CodEpisodio is not null 
	update ingresos..episodiourgencias
	set ftriaje = getdate()
	where codpaciente = @spvar_CodPaciente
			and codepisodio = @spvar_CodEpisodio 

-- devolvermos el id del triaje creado
--if @spvar_CodPaciente is not null and @spvar_CodEpisodio is not null 
select id from triajes
where codtriaje = @spvar_CodTriaje
--	and codpaciente = @spvar_CodPaciente
--	and codepisodio = @spvar_CodEpisodio
GO
GO



--dbo.SpIngIQuiNuevo.sql

USE [Ingresos]
GO
/****** Object:  StoredProcedure [dbo].[SpIngIQuiNuevo]    Script Date: 03/08/2017 9:39:49 ******/
IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[SpIngIQuiNuevo]') AND type in (N'P', N'PC'))
DROP PROCEDURE [dbo].[SpIngIQuiNuevo]
GO

USE [Ingresos]
GO

SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


--	PROCEDIMIENTO		: 	SpIngIQuiNuevo
--	FUNCION             : 	Inserta un nuevo informe quirÃºrgico
--	DEVUELVE            : 
--	FECHA               : 	21/12/2005
--	VERSION             : 	1.0
--	AUTOR               : 	Gerardo Prieto David (MECEMSA Consultores)
--  MODIFICACION		:   MPS 31/05/07 aÃ±adir parametros para possum
--							Jorge Poveda SÃ¡ez 10/12/2007 AÃ±ado dos campos CodExamInterven 1 y 2
--							Ismael 14/12/2007 AÃ±adido el parametro ActualizaIngreso para actualizar la fecha de
--							hospitalizacion con respecto a la de inicio de la intervencion
--							Ismael 18/12/2007 valor por defecto a los parametros por compatibilidad
--							Oscar 19/08/2008 se guarda la informaciÃ³n del paciente para kiosko
--							Pablo GonzÃ¡lez 31/12/2008 aumentado tamaÃ±o descOperatoria
--							Ismael 27/01/2009 Actualizacion de estados de la preoperatoria para RCLE
--							Pablo GonzÃ¡lez 10/03/2009 InfoPaciente en preoperatoria
--							Teresa L F 29/05/2009 Se actualiza el tiempo teorico de la estancia segÃºn el procedimiento realizado menos episodios de UHD o UCSI.
--							CTF - 73569626D - CHC3335_ModificaciÃ³n Campo Analista en InfQuirurgico
--	APLICACIÃ“N ORIGEN   : 	Informe quirÃºrgico
--  MODIFICACIÃ“N		: (04/09/2015) - v4.53r1 - SGN - 2500 - Plano y extremidad de intervenciones quirÃºrgicas
--	MODIFICACIÃ“N		: 05/09/2016 - v4.64 - 12771 - CCM - Repasar las tablas que tienen historificacion
--  MODIFICACIÃ“N : 18/10/2016 - v4.64r1 - 13674 - CCM - Repasar las tablas que tienen historificacion
--  MODIFICACION: 15/05/2017 - v17.2 - 16142 - FCB - Solicitud de PabellÃ³n - Registro de especialidad
--  MODIFICACION: 02/08/2017 v17.3 - 16153 - MPR - Registro Quirurgico - Incorporar registro de Turno

CREATE Procedure [dbo].[SpIngIQuiNuevo]
	
	@spvar_CodInforme Varchar(7) = NULL,
	@spvar_CodIntervencion Varchar(7),
	@spvar_CodPaciente Char(16), 
	@spvar_CodEpisodio Char(5), 
	@spvar_FSolicitud Smalldatetime, 
	@spvar_CodCirujano Char(8), 
	@spvar_CodInstrumentista Char(8), 
	@spvar_CodAyuda1 Char(8),
	@spvar_CodAyuda2 Char(8), 
	@spvar_CodAyuda3 Char(8), 
	@spvar_CodMedInforma Char(8), 
	@spvar_CodQuirofano Char(2),
	@spvar_Posicion Char(2), 
	@spvar_CodVia Char(2), 
	@spvar_CodProcedimiento Char(6), 
	@spvar_CodCIE Char(6), 
	@spvar_CodAntibiotico int,
	@spvar_TipoIntervencion Char(1), 
	@spvar_Destino Char(1), 
	@spvar_Drenaje Bit, 
	@spvar_TecnicaEmpleada Varchar(100),
	@spvar_TecnicaCierre Varchar(100), 
	@spvar_Pieza Varchar(40), 
	@spvar_HoraInicio Smalldatetime, 
	@spvar_HoraFin Smalldatetime,
	@spvar_FInforme Smalldatetime, 
	@spvar_CodMutua Char(5), 
	@spvar_Facturable Bit = 0,
	@spvar_CantidadProcesos Tinyint = 1,
	@spvar_DescOperatoria varchar(max),
	@spvar_SolBiopsia char(10),
	@spvar_SolLaboratorio char(10),
	@spvar_SolCitologias char(10),
	@spvar_SolHormonales bit,
	@spvar_SolRadiologia char(10),
	@spvar_SolPostmortem bit,
	@spvar_Firmado bit = 0,
	@spvar_NumCordales char(2) = null,
	@spvar_CodExamInterv char(7) = null,         
	@spvar_CodExamInterv1 char(7) = null,
	@spvar_CodExamInterv2 char(7) = null,
	@spvar_TasaMorbilidad float = null,  -- mps 
	@spvar_TasaMortalidad float = null,   -- mps 
	@spvar_ActualizaIngreso as bit = '0',
	@spvar_InfoPaciente as varchar(4000) = null
	,@spvar_NombreAnestesista as varchar(70)=null
	,@spvar_CodCentro as varchar(5)
	,@spvar_IdPlano tinyint =NULL
	,@spvar_IdCuadrante tinyint =NULL
	,@spvar_DNIUsuarioModifica varchar(8) = NULL
	,@spvar_idTurnoInfQuirurgico int
	
As
	if @spvar_DNIUsuarioModifica  is NULL
	BEGIN
		SET @spvar_DNIUsuarioModifica = ''
	END

	Exec SpIngSQuiSusp @spvar_CodIntervencion

	If @@RowCount = 0

		Begin
		
			If (Select CodPaciente From HClinica..Preoperatoria Where CodIntervencion = @spvar_CodIntervencion) Is Null
			
				--	Se borrÃ³ desde otro sitio la hoja de preoperatorio.
				Select 2

			Else

				Begin
		
					-- mps guardar los datos del possum 
					if exists(select * from hclinica..preoperatoria
								where CodIntervencion = @spvar_CodIntervencion)
					begin
					
						INSERT INTO Historificacion..HClinica_Preoperatoria
						   (CodHojaPreop, CodIntervencion, CodPaciente, CodEpisodio, CodProc,
							CodProtocolo, TipoAnestesia, JClinico, CodCIEPreop, RQuirurgico,
							ProfAntibiotica, ProfOtros, ProfTromboembolica, Region, FPreoperatoria,
							DNIMedicoPreop, DescPreop, TecPrevistas, CSuspendida, FPrevista,
							Ambulatoria, Tipo, PreopCompleto, FIntervencion, Autotransfusion,
							VistoBueno, MedicoRemite, CodMutua, Anestesista, FConsentInterv,
							FConsentProtesis, CodCenRemite, Preanestesia, FPasivo, DiasLEspera,
							NecesHemoderiv, UsuHemoderiv, CodHistoria, Eliminado, Servicio,
							FechaFirma, FechaUltimaAct, DescProtocolo, CiruMenor, TiempoOper,
							CodProtocolo2, DescProtocolo2, CodProtocolo3, DescProtocolo3, cma, 
							MotivoPreferente, Estado, JornadaExtra, DniASQ, FEliminada, FSuspendida,
							TasaMorbilidad, TasaMortalidad, Lateralidad, ResaltaPlaning, CodExamInterven,
							TieneImagen, Factivo, FultimoPasivo, JornadaExtraVali, DniASQVali,
							ObservacionesPreoper, Confirmacion, EliminadoPlan, CMAsinHDIA,
							CodigoGRD, PesoGRD, Complejidad, RequiereUvi, EstadoRCLE, InfoPaciente,
							dniInfoPacMed, dniInfoPacEnf, dniInfoPacAnes, FInfoPaciente, ObsEnfermeria,
							Neoplasia, DniCirujanoPrevisto, AvisadoPac, ObservacionesAvisadoPac,
							DniAvisadoPac, CodAvisoPac, ComplejidadPreop, IntervencionEspecial,
							UHD, TieneEquipo, CentroDestino, TipoCenRemite, ServicioOrigen,
							Ayudantes, AlergiaLatex, RequiereIngreso, TieneProtesis, Infeccioso,
							Preparatoria, DNISuspendida, DNIEliminada, FecModificacionPreop,
							CiruAUrgente, DniAyudantePrevisto, AvisoPlanificar, FPrevistaIntervencion,
							NumListaRCLE, EsSincronizadoRCLE, PacFirmaConsen, NumSuspensiones,
							Observaciones, Pagado, CodMotivoPreferente, IdPlano, IdCuadrante,
							EsReIntervencion, DescReIntervencion, Validado, FCreacionHistorico, DNIUsuarioModifica 
							,CodEspecialidadUrg )
					 SELECT Prp.CodHojaPreop, Prp.CodIntervencion, Prp.CodPaciente, Prp.CodEpisodio, Prp.CodProc,
							Prp.CodProtocolo, Prp.TipoAnestesia, Prp.JClinico, Prp.CodCIEPreop, Prp.RQuirurgico,
							Prp.ProfAntibiotica, Prp.ProfOtros, Prp.ProfTromboembolica, Prp.Region, Prp.FPreoperatoria,
							Prp.DNIMedicoPreop, Prp.DescPreop, Prp.TecPrevistas, Prp.CSuspendida, Prp.FPrevista,
							Prp.Ambulatoria, Prp.Tipo, Prp.PreopCompleto, Prp.FIntervencion, Prp.Autotransfusion,
							Prp.VistoBueno, Prp.MedicoRemite, Prp.CodMutua, Prp.Anestesista, Prp.FConsentInterv,
							Prp.FConsentProtesis, Prp.CodCenRemite, Prp.Preanestesia, Prp.FPasivo, Prp.DiasLEspera,
							Prp.NecesHemoderiv, Prp.UsuHemoderiv, Prp.CodHistoria, Prp.Eliminado, Prp.Servicio,
							Prp.FechaFirma, Prp.FechaUltimaAct, Prp.DescProtocolo, Prp.CiruMenor, Prp.TiempoOper,
							Prp.CodProtocolo2, Prp.DescProtocolo2, Prp.CodProtocolo3, Prp.DescProtocolo3, Prp.cma, 
							Prp.MotivoPreferente, Prp.Estado, Prp.JornadaExtra, Prp.DniASQ, Prp.FEliminada, Prp.FSuspendida,
							Prp.TasaMorbilidad, Prp.TasaMortalidad, Prp.Lateralidad, Prp.ResaltaPlaning, Prp.CodExamInterven,
							Prp.TieneImagen, Prp.Factivo, Prp.FultimoPasivo, Prp.JornadaExtraVali, Prp.DniASQVali,
							Prp.ObservacionesPreoper, Prp.Confirmacion, Prp.EliminadoPlan, Prp.CMAsinHDIA,
							Prp.CodigoGRD, Prp.PesoGRD, Prp.Complejidad, Prp.RequiereUvi, Prp.EstadoRCLE, Prp.InfoPaciente,
							Prp.dniInfoPacMed, Prp.dniInfoPacEnf, Prp.dniInfoPacAnes, Prp.FInfoPaciente, Prp.ObsEnfermeria,
							Prp.Neoplasia, Prp.DniCirujanoPrevisto, Prp.AvisadoPac, Prp.ObservacionesAvisadoPac,
							Prp.DniAvisadoPac, Prp.CodAvisoPac, Prp.ComplejidadPreop, Prp.IntervencionEspecial,
							Prp.UHD, Prp.TieneEquipo, Prp.CentroDestino, Prp.TipoCenRemite, Prp.ServicioOrigen,
							Prp.Ayudantes, Prp.AlergiaLatex, Prp.RequiereIngreso, Prp.TieneProtesis, Prp.Infeccioso,
							Prp.Preparatoria, Prp.DNISuspendida, Prp.DNIEliminada, Prp.FecModificacionPreop,
							Prp.CiruAUrgente, Prp.DniAyudantePrevisto, Prp.AvisoPlanificar, Prp.FPrevistaIntervencion,
							Prp.NumListaRCLE, Prp.EsSincronizadoRCLE, Prp.PacFirmaConsen, Prp.NumSuspensiones,
							Prp.Observaciones, Prp.Pagado, Prp.CodMotivoPreferente, Prp.IdPlano, Prp.IdCuadrante,
							Prp.EsReIntervencion, Prp.DescReIntervencion, Prp.Validado, GetDate(), @spvar_DNIUsuarioModifica 
							,Prp.CodEspecialidadUrg
					   FROM HClinica..Preoperatoria Prp
					   WHERE CodIntervencion = @spvar_CodIntervencion
										
						update hclinica..preoperatoria
						set TasaMorbilidad = @spvar_TasaMorbilidad,
							TasaMortalidad = @spvar_TasaMortalidad
						where CodIntervencion = @spvar_CodIntervencion
					end

					--Ismael(27/01/2009) Actualizacion de estados de la preoperatoria para RCLE
					if @spvar_Firmado = '1'
					begin
						declare @Tipo as char(1)
						
						select @Tipo = Tipo 
						from hclinica..preoperatoria
						where CodIntervencion = @spvar_CodIntervencion
					
						if @Tipo = parametros.dbo.fnParValorConstante('m_strCodTipoUrgente')
						begin							
							update hclinica..preoperatoria
							set EstadoRCLE = parametros.dbo.fnParValorConstante('m_strEstadoRCLEFirmaU')
							where CodIntervencion = @spvar_CodIntervencion							
						end
						else
						begin
						
							update hclinica..preoperatoria
							set EstadoRCLE = parametros.dbo.fnParValorConstante('m_strEstadoRCLEFirmaPP')
							where CodIntervencion = @spvar_CodIntervencion
						end
 					end

					--	Si no se facilita el cÃ³digo de informe (informe nuevo), se genera un cÃ³digo nuevo.
					If @spvar_CodInforme Is Null

						Begin

							--	Obtener el nuevo cÃ³digo de informe.
							Declare @Numero Varchar(5)
							Declare @Anyo Varchar(2)

							Select @Anyo = substring(convert(varchar(4),datepart(yy,getdate())),3,2)

							Select 
								@Numero =convert(varchar(5), IsNull(Max(convert(int,SubString(CodInforme,3,5)))+1,1))
							From 
								HClinica..InformeQuirurgico		
							Where
								CodInforme Like @Anyo + '%'

							Select @spvar_CodInforme = convert(varchar(7), @Anyo + stuff('00000', 6-DataLength(@Numero), DataLength(@Numero), @Numero))	

						End								

					--	Borrado de cualquier informe previo.
					Delete From HClinica..InformeQuirurgico
					Where 
						CodIntervencion = @spvar_CodIntervencion

					-- Para asegurarnos de que no inserta un Codigo de Mutua null
					If @spvar_CodMutua is null
					begin
						Select @spvar_CodMutua = CodMutua
						From HClinica..Preoperatoria
						Where CodIntervencion = @spvar_CodIntervencion
					end

					-- Para asegurarnos de que no inserta un Codigo de Procedimiento null
					If @spvar_CodProcedimiento is null
					begin
						Select @spvar_CodProcedimiento = CodProc
						From HClinica..Preoperatoria
						Where CodIntervencion = @spvar_CodIntervencion
					end
					
					--CTF - 73569626D - CHC3335_ModificaciÃ³n Campo Analista en InfQuirurgico - INI
					IF (SELECT ValorConstante FROM Parametros..constantes WHERE NombreConstante = 'm_bolAnestesiologia' and CentroRef=@spvar_CodCentro)=1 
						BEGIN
							Select @spvar_NombreAnestesista = null
						END
					--CTF - 73569626D - CHC3335_ModificaciÃ³n Campo Analista en InfQuirurgico - FIN
					

					--	InserciÃ³n de los datos en la tabla.
					Insert HClinica..InformeQuirurgico (
						CodIntervencion,
						CodInforme,
						CodPaciente, 
						CodEpisodio, 
						FSolicitud, 
                        CodCirujano,
						CodInstrumentista,
                        CodAyudante1, 
						CodAyudante2, 
						CodAyudante3, 
                        CodMedInforma, 
						CodQuirofano, 
						PosicionInter,
                        CodVia, 
						CodProcedimiento, 
						CodPostCIE,
                        CodAntibioticos, 
						TipoInter, 
						DestinoInter,
						Drenaje, 
						TecnicasEmpleadas, 
                        TecnicaCierre, 
						PiezaExtirpada, 
						HInicioInter,
                        HFinInter, 
						FInforme,
						CodMutua, 
						Facturable,
                        CantidadProcesos,
						DescOperatoria,
						SolBiopsia,
						SolLaboratorio,
						SolCitologias,
						SolHormonales,
						SolRadiologia,
						SolPostmortem,
						Firmado,
						NumCordales,
						CodExamInterven,
						CodExamInterven1,
						CodExamInterven2
						--InfoPaciente
						--CTF - 73569626D - CHC3335_ModificaciÃ³n Campo Analista en InfQuirurgico 
						,NombreAnestesista
						--(04/09/2015) - v4.53r1 - SGN - 2500 - Plano y extremidad de intervenciones quirÃºrgicas - INI
					    ,IdPlano 
					    ,IdCuadrante 
					    --(04/09/2015) - v4.53r1 - SGN - 2500 - Plano y extremidad de intervenciones quirÃºrgicas - FIN
						,IdTurnoInfQuirurgico 
					)  
                   	Values (
						@spvar_CodIntervencion,
						@spvar_CodInforme,
						@spvar_CodPaciente, 
						@spvar_CodEpisodio, 
						@spvar_FSolicitud, 
						@spvar_CodCirujano, 
						@spvar_CodInstrumentista, 
                        @spvar_CodAyuda1, 
						@spvar_CodAyuda2, 
						@spvar_CodAyuda3, 
						@spvar_CodMedInforma, 
                        @spvar_CodQuirofano, 
						@spvar_Posicion, 
						@spvar_CodVia, 
						@spvar_CodProcedimiento, 
						@spvar_CodCIE, 	
						@spvar_CodAntibiotico,
                        @spvar_TipoIntervencion, 
						@spvar_Destino, 
						@spvar_Drenaje, 
						@spvar_TecnicaEmpleada, 
						@spvar_TecnicaCierre, 
                        @spvar_Pieza, 
						@spvar_HoraInicio, 
						@spvar_HoraFin, 
						@spvar_FInforme,
						@spvar_CodMutua, 
						@spvar_Facturable,
                        @spvar_CantidadProcesos,
						@spvar_DescOperatoria,
						@spvar_SolBiopsia,
						@spvar_SolLaboratorio,
						@spvar_SolCitologias,
						@spvar_SolHormonales,
						@spvar_SolRadiologia,
						@spvar_SolPostmortem,
						@spvar_Firmado,
						@spvar_NumCordales,
					    @spvar_CodExamInterv,
						@spvar_CodExamInterv1,
						@spvar_CodExamInterv2
						--@spvar_InfoPaciente
						--CTF - 73569626D - CHC3335_ModificaciÃ³n Campo Analista en InfQuirurgico 
						,@spvar_NombreAnestesista
						--(04/09/2015) - v4.53r1 - SGN - 2500 - Plano y extremidad de intervenciones quirÃºrgicas - INI
						,@spvar_IdPlano
						,@spvar_IdCuadrante
						--(04/09/2015) - v4.53r1 - SGN - 2500 - Plano y extremidad de intervenciones quirÃºrgicas - FIN
						,@spvar_idTurnoInfQuirurgico
					)

					--	Actualizar la fecha de la intervenciÃ³n en la hoja preoperatoria.
							
					Update 
						HClinica..Preoperatoria
					Set 
						FIntervencion = @spvar_HoraInicio
					Where 
						CodIntervencion = @spvar_CodIntervencion

					-- Actualizamos la fecha de ingreso si es posterior al inicio de la intervencion
					if @spvar_ActualizaIngreso = '1'
					begin
						declare @FechaMinHospi as smalldatetime 						

						select @FechaMinHospi = min(fechahospitalizacion) from ingresos..episodiohospitalizacion 
						where codingreso = (select codingreso from ingresos..episodiohospitalizacion 
												where CodPaciente = @spvar_CodPaciente 
													  and CodEpisodio = @spvar_CodEpisodio)

						update ingresos..episodiohospitalizacion
						set FechaHospitalizacion = @spvar_HoraInicio
						where CodPaciente = @spvar_CodPaciente --and CodEpisodio = @spvar_CodEpisodio
							  and FechaHospitalizacion = @FechaMinHospi
							  
					end
					
					-- Se actualiza el tiempo teorico de la estancia segÃºn el procedimiento realizado
					if @spvar_Firmado = '1'
					Begin
						Update Ingresos..EpisodioHospitalizacion
						set estanciaTeorica = PO.EstanciaTeorica
						from Ingresos..EpisodioHospitalizacion EH, parametros..Procedimientos PO,
						parametros..DatosCamas DC, parametros..CodigoPlantas CP
						where EH.CodPaciente = @spvar_CodPaciente
						and EH.CodEpisodio = @spvar_CodEpisodio
						and PO.CodDiagnostico = @spvar_CodProcedimiento
						and replace(EH.numcama,'*','') = replace(DC.numcama,'*','') 
						and DC.CodPlanta = CP.CodPla
						and CP.EsUcsi = 0
						and CP.EsUHD = 0					
					End
					
					Select 0

				End

		End

	Else

		Select 1



GO



--dbo.SpIngITriaje.sql

    USE [Ingresos];
    GO
    IF EXISTS 
    (
        SELECT * 
            FROM sys.procedures 
            WHERE [object_id] = OBJECT_ID('[dbo].[SpIngITriaje]')
    )
    BEGIN
        DROP PROCEDURE [dbo].[SpIngITriaje];
    END
    GO
        
 /* MODIFICACIÓN : 29/06/2017 - V17.2r1 - 18277 - SGH - Triaje ESI */
     
CREATE procEDURE  [dbo].[SpIngITriaje]
	@FechaAlta datetime,
	@Nombre char(15),
	@Apellido1 char(15),
	@Apellido2 char(15)='',
	@Prioridad TinyInt,
	@TUrgencia TinyInt,
	@Observ varchar(4000)='',
	@CodTriaje varchar(14),
	@DniUsu char(9),
	@Edad tinyint,
	@Sexo char(1),
	@spvar_Tipo tinyint = NULL,
	@spvar_ReqIntSalVid bit = NULL,
	@spvar_AltoRiesgo bit = NULL,
	@spvar_Recursos tinyint = NULL,
	@spvar_SVAlterados bit = NULL,
	@spvar_Alterados char (73) = NULL,
	@spvar_AVDI tinyint = NULL,
	@spvar_Distresado bit = NULL,
	@spvar_EVAMenor bit = NULL,
	@spvar_EVAMayor bit = NULL
AS

INSERT INTO Triajes
(
			FechaAlta,
			Nombre,
			Apellido1,
			Apellido2,
			Prioridad,
			TUrgencia,
			Observaciones,
			CodTriaje,
			DniUsu,
			Edad,
			Sexo,
			Tipo,
			ReqIntSalVid,
			AltoRiesgo,
			Recursos,
			SVAlterados,
			Alterados,
			AVDI,
			Distresado,
			EVAMenor,
			EVAMayor
)
VALUES
(
			@FechaAlta,
			@Nombre,
			@Apellido1,
			@Apellido2,
			@Prioridad,
			@TUrgencia,
			@Observ,
			@CodTriaje,
			@DniUsu,
			@Edad,
			@Sexo,
			@spvar_Tipo,
			@spvar_ReqIntSalVid,
			@spvar_AltoRiesgo,
			@spvar_Recursos,
			@spvar_SVAlterados,
			@spvar_Alterados,
			@spvar_AVDI,
			@spvar_Distresado,
			@spvar_EVAMenor,
			@spvar_EVAMayor
)

GO
GO



--dbo.SpIngITriajesAnteriores.sql

    USE [Ingresos];
    GO
    IF EXISTS 
    (
        SELECT * 
            FROM sys.procedures 
            WHERE [object_id] = OBJECT_ID('[dbo].[SpIngITriajesAnteriores]')
    )
    BEGIN
        DROP PROCEDURE [dbo].[SpIngITriajesAnteriores];
    END
    GO
    

/*********************************************************************
* FUNCION		: Inserta en TriajesAnteriores a partir del Id de un HistoricoTriajes
* DEVUELVE		: 
* FECHA			: 07/05/2012
* VERSION		: 4.29
* AUTOR			: Alfredo Samper
* COMENTARIO	: Se crea a partir de un triaje ya existente
******************************************************************
* MODIFICACIÓN  : 29/06/2017 - V17.2r1 - 18277 - SGH - Triaje ESI 
******************************************************************/

CREATE PROCEDURE [dbo].[SpIngITriajesAnteriores]
	@IdTriaje [int]
AS

INSERT INTO TriajesAnteriores
(
	IdTriaje,
	FechaAlta,
	Nombre,
	Apellido1,
	Apellido2,
	Edad,
	Sexo,
	Prioridad,
	TUrgencia,
	Observaciones,
	CodTriaje,
	DniUsu,
	CodPaciente,
	CodEpisodio,
	Tipo,
	ReqIntSalVid,
	AltoRiesgo,
	Recursos,
	SVAlterados,
	Alterados,
	AVDI,
	Distresado,
	EVAMenor,
	EVAMayor
) 
SELECT
	Id,
	FechaAlta,
	Nombre,
	Apellido1,
	Apellido2,
	Edad,
	Sexo,
	Prioridad,
	TUrgencia,
	Observaciones,
	CodTriaje,
	DniUsu,
	CodPaciente,
	CodEpisodio,
	Tipo,
	ReqIntSalVid,
	AltoRiesgo,
	Recursos,
	SVAlterados,
	Alterados,
	AVDI,
	Distresado,
	EVAMenor,
	EVAMayor
FROM HistoricoTriajes
WHERE Id = @IdTriaje

GO
GO



--dbo.SpIngSControlIngesta.sql

USE [Ingresos]
GO

IF EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[SpIngSControlIngesta]') AND type in (N'P', N'PC'))
	DROP PROCEDURE [dbo].[SpIngSControlIngesta]
GO

SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

/***********************************
PROCEDIMIENTO: SpIngSControlIngesta
FUNCIÓN: Recuperar el contenido de la tabla ControlIngesta filtrando por CodPaciente y CodEpisodio / Obtener Total Ingerido para Hoja de Balances
FECHA: 02/03/2015
VERSION: 1.0
AUTOR: Ana Castillo Torrent
APLICACIÓN ORIGEN: Florence Clínico
ID CREACIÓN: v4.50 - 1403 - ACT/APB - Control Nutrición e Ingesta
MODIFICACIÓN: (21/08/2017) - V17.3 - 16489 - APB - Volumen ingerido de Control de Ingesta a Balances
***********************************/

CREATE PROCEDURE [dbo].[SpIngSControlIngesta]
	@spvar_CodPaciente as char(16)
   ,@spvar_CodEpisodio as char(5)
   ,@spvar_EnBalance as bit = 0
AS

BEGIN
	IF @spvar_EnBalance = 0
	BEGIN
		SELECT CI.IdControlIngesta
			  ,CI.CodPaciente
			  ,CI.CodEpisodio
			  ,CI.FechaControlIngesta
			  ,CI.ExtrasVolIngerido
			  ,CI.VolIngeridoRegimen
			  ,CI.Calorias
			  ,CI.Proteinas
		      ,CI.HdeC
		      ,CI.Lipidos
		      ,ISNULL(CI.EnBalance,0) AS EnBalance
		FROM Ingresos..ControlIngesta CI
		WHERE CI.CodPaciente = @spvar_CodPaciente AND CI.CodEpisodio = @spvar_CodEpisodio
		ORDER BY CI.IdControlIngesta DESC
	END
ELSE --@spvar_EnBalance = 1
	BEGIN
		DECLARE @FechaControlIngesta smalldatetime = (SELECT TOP 1 FechaControlIngesta FROM Ingresos..ControlIngesta WHERE CodPaciente = @spvar_CodPaciente AND CodEpisodio = @spvar_CodEpisodio ORDER BY FechaControlIngesta DESC)
		SELECT SUM(CI.ExtrasVolIngerido+CI.VolIngeridoRegimen) AS TotalIngesta
		FROM Ingresos..ControlIngesta CI
		WHERE CI.CodPaciente = @spvar_CodPaciente AND CI.CodEpisodio = @spvar_CodEpisodio AND CI.FechaControlIngesta = @FechaControlIngesta
		SELECT CI.IdControlIngesta
		FROM Ingresos..ControlIngesta CI
		WHERE CI.CodPaciente = @spvar_CodPaciente AND CI.CodEpisodio = @spvar_CodEpisodio AND CI.FechaControlIngesta = @FechaControlIngesta
	END
END

GO
GO



--dbo.SpIngSDauImpresionPruebasYTratamiento.sql

   USE [Ingresos];
    GO
    IF EXISTS 
    (
        SELECT * 
            FROM sys.procedures 
            WHERE [object_id] = OBJECT_ID('[dbo].[SpIngSDauImpresionPruebasYTratamiento]')
    )
    BEGIN
        DROP PROCEDURE [dbo].[SpIngSDauImpresionPruebasYTratamiento];
    END
    GO
/********************************************************************
* PROCEDIMIENTO     : [SpIngSDauImpresionPruebasYTratamiento]
* FUNCION           : Obtiene el tratamiento del paciente y las pruebas que se le han solicitado en un episodio de urgencias.
* DEVUELVE			: 
* FECHA				: 13/07/2012
* VERSION			: 4.30
* AUTOR				: Alfredo Sampers
*********************************************************************
*  MODIFICACIONES
*********************************************************************
--  AUTOR:			Enrique Sánchez	
--  INCIDENCIA:		CHC2241
--  VERSION:		v4.33.3
--  FECHA:			05/11/2012
--  DESCRIPCIÓN:	Se recupera las indicaciones
*********************************************************************
--  AUTOR:			Enrique Sánchez	
--  INCIDENCIA:		CHC3488
--  VERSION:		v4.40.5
--  FECHA:			24/09/2013
--  DESCRIPCIÓN:	Se revisa la composición de MedicamentoPrueba con las indicaciones al paciente
********************************************************************/
/*********************************************************************
--  AUTOR:			Roberto Ramón García -25412344N	
--  INCIDENCIA:		CHC3488
--  VERSION:		v4.40.8
--  FECHA:			23/10/2013
--  DESCRIPCIÓN:	Prescripción por unidad de Administración
--  Trazabilidad:	RRG - 25412344N - 23/10/2013 - CHC3488 - REQ40008 - V4.40r8 - Prescripción por unidad de Administración
********************************************************************
MODIFICACION	   : 29/01/2015 - V4.47R8 - 1779 - APO, Solicitud exámenes laboratorio integración
MODIFICACION	   : 05/10/2015 - V.4.55 - 2449 - RGG - Filtrar por receta null
MODIFICACION	   : 26/04/2016 - V.4.59r2 - 3146 - LMF - Se añaden los campos Estado y causa
MODIFICACIÓN	   : (27/04/2016) - v4.59r2 - 3145 - AAP - Presentación de medicamento en DAU e Informe de alta	
MODIFICACIÓN	   : (18/05/2016) - v4.59r5 - 3224 - CCM - Presentación de medicamento en DAU e Informe de alta
MODIFICACIÓN	   : (29/08/2017) - v17.3 - 16156 - MMM - Constante a los estados del tratamiento farmacológico en el DAU validado
*****************************************************************************************/

CREATE PROCEDURE [dbo].[SpIngSDauImpresionPruebasYTratamiento]
@CodPaciente as char(16),
	@CodEpisodio as char(5),
	@IntegracionLISActiva as bit = 0,
	@CodCentro as char (5)

AS

BEGIN
DECLARE	@m_bolVerEstadoFarmacosDAU as bit =0
 SET @m_bolVerEstadoFarmacosDAU = (Select ValorConstante from Parametros..Constantes where NombreConstante = 'm_bolVerEstadoFarmacosDAU' and CentroRef = @CodCentro)
	DECLARE @Medicamentos AS TABLE
	(
		CodPaciente char(16),
		CodEpisodio char(5),
		IdEspecialidad int,
		FecConsulta SmallDateTime,
		Medicamento varchar(1000),
		MedicamentoComparador varchar(1000), 
		Estado varchar(50),
		Causa varchar(200)
	)
	
	--MEDICMENTOS EN EL HISTORICO
	INSERT INTO @Medicamentos
	SELECT DISTINCT
		T.CodPaciente,
		T.CodEpisodio,
		T.IdEspecialidad,
		T.FecConsulta,
		MedicamentoPrueba = 'Medicamento: ' + (Case WHEN GC.NombreGuia is NULL THEN RTRIM(CFE.DescEspecialidad) + Case WHEN CFE.DescPresentacion is NULL THEN '' ELSE ' (' + RTRIM(CFE.DescPresentacion)+ ')' END ELSE GC.NombreGuia END) + ' - Posología: ' +
             (
                    CASE When convert(int,dosismed)=dosismed then convert(varchar,dosismed) else convert(varchar,convert(decimal(10,5),dosismed)) end +
                    CASE DetalleDosis WHEN NULL THEN '' ELSE ' ' + RTRIM(DetalleDosis)  END +
                    CASE when FrecDosis is not null then ' C/' + RTRIM(CONVERT(VARCHAR,FrecDosis)) + ' ' + C1.Descripcion else ' ' End       
             )      + case when @m_bolVerEstadoFarmacosDAU =1 then
                           CASE g.Administrado               
                                  WHEN 0X1 THEN ' (Administrado)' 
                                  ELSE CASE WHEN g.MotivoNoAdmon IS NULL THEN ' (Indicado)'
                                                 ELSE ' (No administrado' 
                                         END 
                             END 
							 + CASE WHEN ISNULL(CAUSA.Descripcion,'')='' THEN '' ELSE ', ' + CAUSA.Descripcion + ')' END
							+ char(10) + char(9) +  'Indicaciones: ' + isnull(T.InstPac,'')

                    ELSE ''
                    END,
					
		-- Creamos campo auxiliar para despues poder comparar
		MedicamentoComparador = 'Medicamento: ' + (Case WHEN GC.NombreGuia is NULL THEN RTRIM(CFE.DescEspecialidad) + Case WHEN CFE.DescPresentacion is NULL THEN '' ELSE ' (' + RTRIM(CFE.DescPresentacion)+ ')' END ELSE GC.NombreGuia END) + ' - Posología: ' +
		(
			CASE When convert(int,dosismed)=dosismed then convert(varchar,dosismed) else convert(varchar,convert(decimal(10,5),dosismed)) end +
			CASE DetalleDosis WHEN NULL THEN '' ELSE ' ' + RTRIM(DetalleDosis)  END +
			CASE when FrecDosis is not null then ' C/' + RTRIM(CONVERT(VARCHAR,FrecDosis)) + ' ' + C1.Descripcion else ' ' End		
		),
		
		CASE g.Administrado 			
			WHEN 0X1 THEN 'ADMINISTRADO' 
			ELSE CASE WHEN g.MotivoNoAdmon IS NULL THEN 'INDICADO'
					  ELSE 'NO ADMINISTRADO' 
				 END 
		END As ESTADO, 
		CAUSA.Descripcion As CAUSA		
	
	FROM
		Ingresos..HistTratamientoMedico T
	LEFT JOIN
		Parametros..Codigos C1 ON T.UdTmpDosis=C1.Codigo AND C1.Tabla = 'EstTiempoDurac1'
	INNER JOIN 
		Farmacias..REspecialidad CFRE ON CFRE.IdEspecialidad = T.IdEspecialidad AND (CFRE.Tipo = '1' or CFRE.Tipo = '2')
	LEFT OUTER JOIN
        Ingresos.dbo.EpisodioUrgencias AS eu ON eu.CodPaciente = T.CodPaciente AND eu.CodEpisodio = T.CodEpisodio 
	LEFT OUTER JOIN
        Ingresos.dbo.EpisodioHospitalizacion AS eh ON eh.CodPaciente = T.CodPaciente AND eh.CodEpisodio = T.CodEpisodio
	INNER JOIN 
		Farmacias..GuiasCentro GC ON GC.idEspecialidad = CFRE.IdEspecialidad and (GC.codCentro =  ISNULL(eu.CodigoCentUrg, eh.CodCentroOrigen))
	INNER JOIN 
		Farmacias..Especialidad CFE ON CFRE.CodEspec=CFE.CodEspec  
									AND	CFE.Tipo=CFRE.Tipo 
									--AND	CFE.FecBaja is NULL 
									AND (CFRE.Tipo = '1' or CFRE.Tipo = '2')
									AND (CFE.FecAlta=CFRE.FecAlta 
										OR (CFE.FecAlta IS NULL AND CFRE.FecAlta IS NULL) 
										AND CFRE.FecBaja = CFE.FecBaja 
										OR (CFRE.FecBaja IS NULL AND CFE.FecBaja IS NULL)
										)
	LEFT JOIN Ingresos..HistGestionMedicamentos g 
		On	g.codpaciente = t.codpaciente
		and g.codepisodio = t.codepisodio
		and g.fecconsulta = t.fecconsulta
		and g.CodIndicado = t.idespecialidad
	
	LEFT JOIN Parametros..Codigos CAUSA 
		ON	g.MotivoNoAdmon=CAUSA.Codigo 
		AND CAUSA.Tabla = 'EstCausaNoAdmin'	
		
	WHERE 
		T.CodPaciente = @CodPaciente AND
		T.CodEpisodio = @CodEpisodio AND
		IdRecetaTratamientoMed is NULL	
		
	--MEDICMENTOS 
	INSERT INTO @Medicamentos
	SELECT DISTINCT
		T.CodPaciente,
		T.CodEpisodio,
		T.IdEspecialidad,
		T.FecConsulta,
		MedicamentoPrueba = 'Medicamento: ' + (Case WHEN GC.NombreGuia is NULL THEN RTRIM(CFE.DescEspecialidad) + Case WHEN CFE.DescPresentacion is NULL THEN '' ELSE ' (' + RTRIM(CFE.DescPresentacion)+ ')' END ELSE GC.NombreGuia END) + ' - Posología: ' +
             (
                    CASE When convert(int,dosismed)=dosismed then convert(varchar,dosismed) else convert(varchar,convert(decimal(10,5),dosismed)) end +
                    CASE DetalleDosis WHEN NULL THEN '' ELSE ' ' + RTRIM(DetalleDosis)  END +
                    CASE when FrecDosis is not null then ' C/' + RTRIM(CONVERT(VARCHAR,FrecDosis)) + ' ' + C1.Descripcion else ' ' End       
             )      + case when @m_bolVerEstadoFarmacosDAU =1 then
                           CASE g.Administrado               
                                  WHEN 0X1 THEN ' (Administrado)' 
                                  ELSE CASE WHEN g.MotivoNoAdmon IS NULL THEN ' (Indicado)'
                                                 ELSE ' (No administrado' 
                                         END 
                             END 
							 + CASE WHEN ISNULL(CAUSA.Descripcion,'')='' THEN '' ELSE ', ' + CAUSA.Descripcion + ')' END
							+ char(10) + char(9) +  'Indicaciones: ' + isnull(T.InstPac,'')

                    ELSE ''
                    END,
							
		-- Creamos campo auxiliar para despues poder comparar
		MedicamentoComparador = 'Medicamento: ' + (Case WHEN GC.NombreGuia is NULL THEN RTRIM(CFE.DescEspecialidad) + Case WHEN CFE.DescPresentacion is NULL THEN '' ELSE ' (' + RTRIM(CFE.DescPresentacion)+ ')' END ELSE GC.NombreGuia END) + ' - Posología: ' +
		(
			CASE When convert(int,dosismed)=dosismed then convert(varchar,dosismed) else convert(varchar,convert(decimal(10,5),dosismed)) end +
			CASE DetalleDosis WHEN NULL THEN '' ELSE ' ' + RTRIM(DetalleDosis)  END +
			CASE when FrecDosis is not null then ' C/' + RTRIM(CONVERT(VARCHAR,FrecDosis)) + ' ' + C1.Descripcion else ' ' End		
		),
		
		CASE g.Administrado 			
			WHEN 0X1 THEN 'ADMINISTRADO' 
			ELSE CASE WHEN g.MotivoNoAdmon IS NULL THEN 'INDICADO'
					  ELSE 'NO ADMINISTRADO' 
				 END 
		END As ESTADO, 
		CAUSA.Descripcion As CAUSA		
		
	FROM
		Ingresos..TratamientoMedico T
	LEFT JOIN
		Parametros..Codigos C1 ON T.UdTmpDosis=C1.Codigo AND C1.Tabla = 'EstTiempoDurac1'
	INNER JOIN 
		Farmacias..REspecialidad CFRE ON CFRE.IdEspecialidad = T.IdEspecialidad AND (CFRE.Tipo = '1' or CFRE.Tipo = '2')
	LEFT OUTER JOIN
        Ingresos.dbo.EpisodioUrgencias AS eu ON eu.CodPaciente = T.CodPaciente AND eu.CodEpisodio = T.CodEpisodio 
	LEFT OUTER JOIN
        Ingresos.dbo.EpisodioHospitalizacion AS eh ON eh.CodPaciente = T.CodPaciente AND eh.CodEpisodio = T.CodEpisodio
	INNER JOIN 
		Farmacias..GuiasCentro GC ON GC.idEspecialidad = CFRE.IdEspecialidad and (GC.codCentro =  ISNULL(eu.CodigoCentUrg, eh.CodCentroOrigen))
	INNER JOIN 
		Farmacias..Especialidad CFE ON CFRE.CodEspec=CFE.CodEspec 
									AND	CFE.Tipo=CFRE.Tipo 
									--AND	CFE.FecBaja is NULL 
									AND (CFRE.Tipo = '1' or CFRE.Tipo = '2')
									AND (CFE.FecAlta=CFRE.FecAlta 
										OR (CFE.FecAlta IS NULL AND CFRE.FecAlta IS NULL) 
										AND CFRE.FecBaja = CFE.FecBaja 
										OR (CFRE.FecBaja IS NULL AND CFE.FecBaja IS NULL)
										)
	LEFT JOIN Ingresos..GestionMedicamentos g 
		On	g.codpaciente = t.codpaciente
		and g.codepisodio = t.codepisodio
		and g.fecconsulta = t.fecconsulta
		and g.CodIndicado = t.idespecialidad
	
	LEFT JOIN Parametros..Codigos CAUSA 
		ON	g.MotivoNoAdmon=CAUSA.Codigo 
		AND CAUSA.Tabla = 'EstCausaNoAdmin'
	
	WHERE 
		T.CodPaciente = @CodPaciente AND
		T.CodEpisodio = @CodEpisodio AND				
		IdRecetaTratamientoMed is NULL	
		
	-- EN EL ESTADO, LA JERARQUIA QUE SIGUE ES LA SIGUIENTE: ADMINISTRADO,NO ADMINISTRADO y INDICADO
	
	-- BORRAMOS LOS CASOS EN QUE HAY UNA ADMINISTRACION RECHAZADA SI ESTE MEDICAMENTO TIENE OTRA DISPENSACION REALIZADA
	DELETE T1
	FROM @Medicamentos T1
	WHERE Estado='NO ADMINISTRADO' 
	AND EXISTS (SELECT * 
				FROM @Medicamentos T2 
				WHERE	T1.CodPaciente =T2.CodPaciente
					AND T1.CodEpisodio =T2.CodEpisodio
					AND T1.IdEspecialidad =T2.IdEspecialidad
					AND T1.MedicamentoComparador =T2.MedicamentoComparador
					AND Estado = 'ADMINISTRADO' )	
			
	-- BORRAMOS LOS CASOS EN QUE UN MEDICAMENTO SIN DISPENSACION SI ESTE MEDICAMENTO TIENE OTRA DISPENSACION REALIZADA O NO REALIZADA		
	DELETE T1
	FROM @Medicamentos T1
	WHERE Estado='INDICADO' 
	AND ( EXISTS (SELECT * 
				FROM @Medicamentos T2 
				WHERE	T1.CodPaciente =T2.CodPaciente
					AND T1.CodEpisodio =T2.CodEpisodio
					AND T1.IdEspecialidad =T2.IdEspecialidad
					And T1.MedicamentoComparador = T2.MedicamentoComparador
					AND Estado = 'ADMINISTRADO' )	
		OR 
		EXISTS (SELECT * 
				FROM @Medicamentos T2 
				WHERE	T1.CodPaciente =T2.CodPaciente
					AND T1.CodEpisodio =T2.CodEpisodio
					AND T1.IdEspecialidad =T2.IdEspecialidad
					And T1.MedicamentoComparador = T2.MedicamentoComparador
					AND Estado = 'NO ADMINISTRADO' )
		)
		
		
	SELECT DISTINCT	Medicamento As MedicamentoPrueba
	FROM @Medicamentos
	
	UNION
	
	SELECT
		MedicamentoPrueba = 'Imagenología: ' + DX.Examen		
	FROM
		Hclinica..informeRadiologico IR
	INNER JOIN 
		HClinica..PruebasRadiologicas PR ON PR.CodInforme = IR.CodRegistro
	LEFT JOIN 
		Parametros..DictamenesX DX ON DX.Cod_Examen = PR.CodPrueba
	WHERE
		CodPaciente = @CodPaciente AND
		CodEpisodio = @CodEpisodio 
		
	UNION
		
	Select 		
		MedicamentoPrueba = 'Laboratorio: ' +  C.DesPrueba
	From 
		HClinica..solicitudeslaboratorio LS
	INNER JOIN 
		HClinica..DeterminacionLaboratorio LE ON LE.CodRegistro = LS.CodRegistro
	INNER JOIN 
		parametros..PruebasLAb C ON C.CodPrueba = LE.CodPrueba 
	WHERE
		LS.CodPaciente = @CodPaciente AND
		LS.CodEpisodio = @CodEpisodio AND
		LS.FBorrado IS NULL AND
		(@IntegracionLISActiva = 0 OR (@IntegracionLISActiva = 1 AND LE.CodPerfil = ''))

	UNION

	Select 		
		MedicamentoPrueba = 'Laboratorio: ' +  pl.DesPerfil
	From 
		HClinica..solicitudeslaboratorio LS
	INNER JOIN 
		HClinica..DeterminacionLaboratorio LE ON LE.CodRegistro = LS.CodRegistro
	INNER JOIN 
		Parametros..PerfilesLab PL on PL.CodPerfil = LE.Codperfil
	WHERE
		@IntegracionLISActiva = 1 AND
		LS.CodPaciente = @CodPaciente AND
		LS.CodEpisodio = @CodEpisodio AND
		LS.FBorrado IS NULL

	UNION

	SELECT
		MedicamentoPrueba = 'Endoscopia: ' + XCE.Examen
	FROM	
		hclinica..InformeEndoscopia E
	INNER JOIN
		parametros..DictamenesX XCE ON XCE.Cod_Examen = E.CodPrueba 

	WHERE
		CodPaciente = @CodPaciente AND 
		CodEpisodio = @CodEpisodio

	UNION

	SELECT
		MedicamentoPrueba = 'Otras Pruebas: ' + C.Examen
	FROM
		HCLINICA..informesComp E
	INNER JOIN 
		parametros..DictamenesX C ON C.Cod_Examen=E.CodPrueba
	INNER JOIN 
		parametros..CodSecciones S ON S.CodSec=C.Cod_Seccion AND S.CodMDiagnostico Not In ('0','1','9') 
	WHERE 		
		E.CodPaciente=@CodPaciente and					
		E.CodEpisodio = @CodEpisodio 
	        				
	UNION

	SELECT
		MedicamentoPrueba = 'Citologías: ' + SN.Caracteristicas
	FROM 
		hclinica..AnatomiaPatologica AP
	INNER JOIN 
		Parametros..SNOMED SN ON SN.CodigoSNOMED = AP.CodProc
	WHERE 
		CodPaciente=@CodPaciente and
		 CodEpisodio=@CodEpisodio and
		 (CodRegistro like '%CI%' or CodRegistro like '%PU%' or CodRegistro like '%PG%' or CodRegistro like '%CG%') and
		 Eliminado is null

	UNION

	SELECT
		MedicamentoPrueba = 'Biopsias: ' + SN.Caracteristicas
	FROM
		hclinica..AnatomiaPatologica AP
	LEFT JOIN 
		parametros..SNOMED SN ON AP.CodProc=SN.CodigoSNOMED
	WHERE 
		CodPaciente=@CodPaciente AND
		CodEpisodio=@CodEpisodio AND
		CodRegistro LIKE '%EA%' AND
		Eliminado IS NULL	

 END
 
 GO
GO



--dbo.SpIngSDauTriaje.sql

USE [Ingresos]
GO

IF EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[SpIngSDauTriaje]') AND type in (N'P', N'PC'))
	DROP PROCEDURE [dbo].[SpIngSDauTriaje]
GO

SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

/***********************************************************************************************
* PROCEDIMIENTO : SpIngSDauTriaje
* FUNCION       : Obtiene los datos de impresión del Triaje
* DEVUELVE		:
* FECHA			: 17/08/2016
* VERSION		: 4.63
* AUTOR			: FCB
* MODIFICACIÓN  : (08/03/2017) - V4.68r1 - 16564 - APB - Categorización sin nombre del profesional
* MODIFICACIÓN  : (29/06/2017) - V17.2r1 - 18277 - SGH/APB - Triaje ESI
************************************************************************************************/

CREATE PROCEDURE [dbo].[SpIngSDauTriaje]
	 @CodPaciente as char(16)
	,@CodEpisodio as char(5)
AS

SELECT T.FechaAlta AS FechaTriaje
      ,DU.NombreCompleto AS Profesional
      ,'C' + CAST(T.Prioridad+1 AS VARCHAR) + ' ' + P.DesPrioridad AS Categorizacion
      ,DU.RolUsuario AS RolProfesional
	  ,T.Tipo
FROM Ingresos..TriajesAnteriores T
	 LEFT JOIN Parametros..vParDatosUsuarios DU ON DU.Dni = T.DniUsu
	 LEFT JOIN Ingresos..EpisodioUrgencias EP ON EP.CodPaciente = T.CodPaciente AND EP.CodEpisodio = T.CodEpisodio
	 LEFT JOIN Parametros..PrioridadUrgencia P ON P.CodPrioridad = T.Prioridad AND EP.CodigoCentUrg = P.CodCentro
WHERE T.CodPaciente = @CodPaciente AND T.CodEpisodio = @CodEpisodio

UNION

SELECT HT.FechaAlta AS FechaTriaje
      ,DU.NombreCompleto AS Profesional
      ,'C' + CAST(HT.Prioridad+1 AS VARCHAR) + ' ' + P.DesPrioridad AS Categorizacion
      ,DU.RolUsuario AS RolProfesional
	  ,HT.Tipo
FROM Ingresos..HistoricoTriajes HT
	 LEFT JOIN Parametros..vParDatosUsuarios DU ON DU.Dni = HT.DniUsu
	 LEFT JOIN Ingresos..EpisodioUrgencias EP ON EP.CodPaciente = HT.CodPaciente AND EP.CodEpisodio = HT.CodEpisodio
	 LEFT JOIN Parametros..PrioridadUrgencia P ON P.CodPrioridad = HT.Prioridad AND EP.CodigoCentUrg = P.CodCentro
WHERE HT.CodPaciente = @CodPaciente AND HT.CodEpisodio = @CodEpisodio
	
GO
GO



--dbo.SpIngSHistTriaje.sql

    USE [Ingresos];
    GO
    IF EXISTS 
    (
        SELECT * 
            FROM sys.procedures 
            WHERE [object_id] = OBJECT_ID('[dbo].[SpIngSHistTriaje]')
    )
    BEGIN
        DROP PROCEDURE [dbo].[SpIngSHistTriaje];
    END
    GO
    


/*********************************************************************
* FUNCION :Obtiene los datos del Triaje
* DEVUELVE : 
* FECHA	: 17/10/2005
* VERSION : 1.0
* AUTOR	: Desiderio Marti (Mecemsa)
* ORIGEN : Hoja de Urgencias
* 
'*******************************************************************
* REVISION		: (24/02/09) Oscar Vilella - Estandarización de variables
* MODIFICACIÓN  : 29/06/2017 - V17.2r1 - 18277 - SGH - Triaje ESI 
*******************************************************************/
CREATE PROCEDURE [dbo].[SpIngSHistTriaje]
	@CodId int=-1,
	@spvar_CodId int = NULL
AS

SELECT @CodId = Isnull(@spvar_CodId, @CodId) -- utilizo el valor del nuevo parámetro en caso de que se pase algun valor

IF (@CodId=-1) 
	SELECT	Id,
			FechaAlta,
			Nombre,
			Apellido1,
			Apellido2, 
			Edad, 
			Sexo,
			Prioridad,
			TUrgencia,
			Observaciones,
			CodTriaje,
			DniUsu,
			Tipo,
			ReqIntSalVid,
			AltoRiesgo,
			Recursos,
			SVAlterados,
			Alterados,
			AVDI,
			Distresado,
			EVAMenor,
			EVAMayor
	FROM	HistoricoTriajes

ELSE 

	SELECT	Id,
			FechaAlta,
			Nombre,
			Apellido1,
			Apellido2,
			Edad, 
			Sexo,
			Prioridad,
			TUrgencia,
			Observaciones,
			CodTriaje,
			DniUsu,
			Tipo,
			ReqIntSalVid,
			AltoRiesgo,
			Recursos,
			SVAlterados,
			Alterados,
			AVDI,
			Distresado,
			EVAMenor,
			EVAMayor
	FROM	HistoricoTriajes 

	WHERE	Id=@CodId

GO
GO



--dbo.SpIngSInfoPaciente.sql

    USE [Ingresos];
    GO
    IF EXISTS 
    (
        SELECT * 
            FROM sys.procedures 
            WHERE [object_id] = OBJECT_ID('[dbo].[SpIngSInfoPaciente]')
    )
    BEGIN
        DROP PROCEDURE [dbo].[SpIngSInfoPaciente];
    END
    GO
    

-- *****************************************************************
-- FUNCION	: SpIngSInfoPaciente
-- DESCRIPCIÓN	: Obtiene la información del campo InfoPaciente
-- FECHA	: 18/06/2008
-- VERSION	: 1.0
-- AUTOR	: Oscar Vilella Alarcon
--*******************************************************************
--MODIFICACION: (03/08/2016) - V4.62r1 - 12915 - SGH - Proteger identidad paciente
--MODIFICACION: (14/06/2017) - v17.3 - 18463 - SGH - Información de Pacientes en Episodio de Hospitalizado (igual a POC)
--*******************************************************************

CREATE PROCEDURE [dbo].[SpIngSInfoPaciente]
	@spvar_CodPaciente Char(16), 
	@spvar_CodEpisodio Varchar(5),
	@spvar_InfoPaciente Varchar(4000) = '' OUTPUT,
	@spvar_dniInfoPacMed Char(8) = '' OUTPUT,
	@spvar_dniInfoPacEnf Char(8) = '' OUTPUT,
	@spvar_FInfoPaciente DateTime = '' OUTPUT
AS

if substring(@spvar_CodEpisodio,1,1) = 'U'
begin
	SELECT  
		@spvar_InfoPaciente = InfoPaciente,
		@spvar_dniInfoPacMed = dniInfoPacMed,
		@spvar_dniInfoPacEnf = dniInfoPacEnf,
		@spvar_FInfoPaciente = FInfoPaciente 
		FROM EpisodioUrgencias
		WHERE CodPaciente = @spvar_CodPaciente
		AND CodEpisodio = @spvar_CodEpisodio
end

if substring(@spvar_CodEpisodio,1,1) = 'H'
begin
	SELECT  
		@spvar_InfoPaciente = InfoPaciente,
		@spvar_dniInfoPacMed = dniInfoPacMed,
		@spvar_dniInfoPacEnf = dniInfoPacEnf,
		@spvar_FInfoPaciente = FInfoPaciente 
		FROM EpisodioHospitalizacion
		WHERE CodPaciente = @spvar_CodPaciente
		AND CodEpisodio = @spvar_CodEpisodio
end
GO

GO



--dbo.SpIngSListaUrgenciasFechas.sql

USE [Ingresos]
GO

IF EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[SpIngSListaUrgenciasFechas]') AND type in (N'P', N'PC'))
	DROP PROCEDURE [dbo].[SpIngSListaUrgenciasFechas]
GO

SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

/*********************************************************************
* PROCEDIMIENTO   : SpIngSListaUrgenciasFechas
* DEVUELVE        : Devuelve los pacientes en urgencias según el centro 
* FECHA           : 21/09/2007
* VERSION         : 1.0
* AUTOR           : Sonia Mateo (Agensys Technology)
* ORIGEN          : Lista de Trabajo de Urgencias
**********************************************************************
* MODIFICACIÓN    : (03/10/2007) Sonia Mateo (Agensys Technology) - Descomento las uniones para que el listado aparezca ordenado
* MODIFICACIÓN    : (20/02/2008) Jaume Milián (MECEMSA) - Se utiliza la funcion fnParHospitalReferencia para obtener el código de centro
* MODIFICACIÓN    : (12/05/2008) Sonia Mateo (Agensys Technology) - Modifico el calculo de las pruebas de rayos realizadas con informe para que tenga en cuenta aquellas pruebas que no necesitan informe
* MODIFICACIÓN    : (12/05/2008) Cecilio Méndez - No Lock en rayos
* MODIFICACIÓN    : (22/05/2008) Jaume Milián - No se extraen las citas de primaria de agendas de urgencias que tengan un cita
* MODIFICACIÓN    : (26/05/2008) Jaume Milián - Se realizan las mejoras que aconsejan los DBAs:
*                                             - Si se utiliza el With (nolock), se debe aplicar sobre todas las tablas, si no no tiene sentido
*                                             - Evitar los Converts de fechas para comparar y utilizar DateDiffs
*                                             - Eliminamos cases que no tenían sentido
* MODIFICACIÓN    : (04/03/2009 Teresa L F Serrano. Se añade FBorrado is null de SolicitudesLaboratorio
* MODIFICACIÓN    : (25/05/2009 Teresa L F Serrano. Se devuelve el valor de laboratorio rango Patologico. Se arreglan las bolas de rayos
* MODIFICACIÓN    : (05/06/2009 Oscar Vilella. Patológico si MS o MI
* MODIFICACIÓN    : (21/08/2009 Ismael Sampere. Añadidos los campos de codigo y tipo de guia clinica
* MODIFICACIÓN    : (13/10/2009 Oscar Vilella. Devolver código servicio de la unidad asistencial
* MODIFICACIÓN    : (19/10/2009 Oscar Vilella. Cruzamos la tabla Triajes con el código del centro
* MODIFICACIÓN    : (10/12/2009 Jesús Mañogil (Mecemsa). Consultamos los campos Patologicos y PatologiaNoDemorable de rayos
* MODIFICACIÓN    : (19/12/2010 Jose Almela (Agensys). Añadimos el RUT del paciente
* MODIFICACIÓN    : (05/08/2010 Carlos H Camacho. Añadimos la Previsión (Colectivo)
* MODIFICACIÓN    : (25/08/2011 Optimizado el código.
* MODIFICACIÓN    : (12/09/2011 Stijn René Cumps. Usar fnParFechaHoraUT.
* MODIFICACIÓN    : (27/01/2012 Miguel Angel Gómez. Extraemos el campo FinEnfermeria de EpisodioUrgencias
* MODIFICACIÓN    : (12/11/2012 Alfredo. CHC2132. Devolvemos el campo Triaje (EsBoxTriaje) de Parametros.CamasBoxesUrg
* MODIFICACIÓN    : (13/12/2012 Alfredo chc2460. Devolvemos las pruebas de laboratorio con resultado
* MODIFICACIÓN    : (14/01/2013 Alfredo 4.36 CHC2352.
* MODIFICACIÓN    : (05-02-2013) César Moreno Moreno CHC-2612 v 4.37, devolvemos si está pagado
* MODIFICACIÓN    : (08-04-2013) César Moreno Moreno CHC-2858 v 4.38, se recupera la previsión del episodio, no del paciente
* MODIFICACIÓN    : Alfredo - CHC2848 (V4.38) - Devuelvo los campos U.FechaAltaPostTratamiento y U.DniFirmaAltaPostTratamiento
* MODIFICACIÓN    : (07/05/2013) - V4.39 - CTF - 73569626D - CHC2725_REQ22340_Nuevo estado de la solicitud de laboratorio
* MODIFICACIÓN    : (15/05/2013) - V4.37r10 - CHC3044 - MAJL - Modificación para que aparezcan los semaforos de las solicitudes de
*                                                              pruebas en la lista de trabajo de urgencias cuando se trata de otro centro distinto del centro de referencia
* MODIFICACIÓN    : (25/10/2013) - V4.41 - CTF - 73569626D - CHC3303_REQ34864_Campo Nombre a que responde
* MODIFICACIÓN    : Patrick Vicuña REQ_68046 - 1466 V4.47r2 - Se agregan las ENFERMERAS para que aparezcan en la lista de trabajo
* MODIFICACIÓN	  : (24/12/2014) - V4.49 - 1439 - RRG - Transversalidad del caso GES - REQ 55104
* MODIFICACIÓN    : (12/08/2015) - V4.54 - 2396 - SGN - Tooltip lista trabajo urgencias
* MODIFICACIÓN	  : (28/09/2015) - V4.54r1 - 2603 - SGN - Tooltip lista trabajo urgencias
* MODFICIACIÓN    : (23/11/2015) - V4.56 - 2648 - CCM - Lista urgencias
* MODFICIACIÓN    : (01/12/2015) - V4.57 - 2722 - SGN - Entrega de turno
* MODIFICACIÓN	  :	(11/12/2015) - V4.57 - 2722 - ASM - Añado última evolución y si existe preoperatoria pendiente
* MODIFICACIÓN	  :	(26/05/2016) - V4.57r6 - 3255 - JMG - Tooltip lista trabajo urgencias incompleto
* MODIFICACIÓN    : (21/06/2016) - V4.62 - 3218 - APB - Registro Confidencial
* MODIFICACIÓN    : (20/10/2016) - V4.65 - 13504 - MMM - Mejora performance Paginación en lista de urgencias
* MODIFICACIÓN    : (10/01/2017) - V4.65r2 - 15099 - APB - Observación modificar mensaje por NSP (filtros por paciente en mejora de performance/rendimiento)
* MODIFICACIÓN    : (24/05/2017) - v17.2 - 16114 - LMF - Mejora en excel de entrega de turno
* MODIFICACIÓN    : (28/06/2017) - v17.2r1 - 18845 - ASM - Carga de estado de paciente en entrega de turno
* MODIFICACIÓN    : (28/06/2017) - v17.2r1 - 18836 - ASM - Citas en Espera de Control Observación asociada 
*********************************************************************/

CREATE PROCEDURE [dbo].[SpIngSListaUrgenciasFechas]
      @spvar_CodCentro char(5)
     ,@spvar_FechaEntregaTurno smalldatetime = null
     ,@spvar_FechaDesde smalldatetime = null
     ,@spvar_FechaHasta smalldatetime = null
     ,@spvar_PacHC varchar(8) = null
     ,@spvar_PacNombre varchar(20) = null
     ,@spvar_PacApell1 varchar(25) = null
     ,@spvar_PacApell2 varchar(25) = null
AS

IF @spvar_FechaEntregaTurno IS NULL
BEGIN
	SET @spvar_FechaEntregaTurno = GETDATE()
END

DECLARE @bolFiltrarPorPaciente bit = 1
IF @spvar_PacHC IS NULL AND @spvar_PacNombre IS NULL AND @spvar_PacApell1 IS NULL AND @spvar_PacApell2 IS NULL
BEGIN
	SET @bolFiltrarPorPaciente = 0
END

select
      Prioridad as PrioridadTri,
      '' as PrioridadUrg,
      '0' as Triaje,
      Parametros.dbo.fnParFechaHoraUTC(FechaAlta) as FIngreso____,
      Parametros.dbo.fnParFechaHoraUTC(FechaAlta) as FTriaje____,
      null as FechaEntrada____,                
      TUrgencia as Tipo,                                   
      isnull(T.Localizacion,0) as  Localizacion, 
      Parametros.dbo.fnParFechaHoraUTC(isnull(T.FechaLocalizacion,getdate())) as FechaLocalizacion____, 
      T.Sexo as Genero,
      Edad,  
      T.Nombre as PacNombre,
      T.Apellido1 as PacApell1,
      T.Apellido2 as PacApell2,
      '' as PAsistencial, 
      isnull(RTRIM(M.NomMedico) + ' ' + RTRIM(M.Apell1) + ' ' + RTRIM(M.Apell2),RTRIM(enf.NombreEnf) + ' ' + RTRIM(enf.Apell1Enf) + ' ' + RTRIM(enf.Apell2Enf)) as Medico,
      coalesce(M.DNIMedico,enf.DNIEnf) as DNIMedico,  
      '' as CodPaciente, 
      '' as CodEpisodio, 
      '' as CodHistoria,
      T.CodTriaje,
      T.ID as ID, 
      case when T.Localizacion = 2 or T.Localizacion = 4 or T.Localizacion = 6 then C.CodCama else CI.CodCama end as Cama, 
      null as FechaUrgencia____,
      -1 as RadioInformadas,
      -1 as RadioSinRealizar,
      -1 as RadioRealizadas,
      -1 as RadioPatologicas,
      0 as labTotales,
      0 as labRealizadas,
      0 as InterConsTotales,
      0 as InterConsFirmadas,
      0 as InterConsRealizadas,
      '' as DesLocalizacion,
      0 as labPatologico,
      NULL as CodGuia,
      NULL as TipoGuia,
      NULL as CodigoServicioUrgenc
      ,P.[NumTarjSanitaria] AS RutPac
      ,ms.Entidad as Prevision,
      NULL as FinEnfermeria,
      0 as EsBoxTriaje
      ,'LabResultados' = 0
      ,'' as CausaUrgencias 
      ,0 as Pagado
      ,U.FechaAltaPostTratamiento 
      ,U.DniFirmaAltaPostTratamiento
      ,0 as labAceptadas
      ,P.AtiendeAlNombre
      , 0 as TratamientoEnf    
      ,IndicacionesAlta = (Case when (isnull(PV.ExplFisica,'0') = 11) then PlanYTratamiento Else IndicacionesAltaDAU2012 End)
      ,T1.DescDiagnostico
      ,PV.CausaVisita    
      ,REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(P.PacNombre, 'á', 'a'), 'é','e'), 'í', 'i'), 'ó', 'o'), 'ú','u') as PacNombreAI
      ,REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(P.PacApell1, 'á', 'a'), 'é','e'), 'í', 'i'), 'ó', 'o'), 'ú','u') as PacApell1AI
      ,REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(P.PacApell2, 'á', 'a'), 'é','e'), 'í', 'i'), 'ó', 'o'), 'ú','u') as PacApell2AI
      ,HET_MED.FechaInicio as FechaTurno_Med
      ,PU.DesPrioridad as TurnoEstadoPaciente
      ,HET_MED.Observaciones as DescTurno_Med
      ,HET_MED.NifRegistro as NifRegistro_Med
      ,HET_ENF.Fecha as FechaTurno_Enf
      ,HET_ENF.MedicacionAnt as DescTurno_Enf
      ,HET_ENF.NifRegistro as NifRegistro_Enf
      ,(CASE WHEN EH.CodEpisodio IS NULL THEN '0' ELSE '1' END) as TieneSolHospitalizacion
      , CASE WHEN HET_MED.CodPaciente IS NULL THEN CEvo2.DesPrioridad ELSE CEvo.DesPrioridad END AS UltimaEvolucion
      ,CASE WHEN EXISTS(SELECT * FROM Hclinica..Preoperatoria Preop WHERE T.CodPaciente = Preop.CodPaciente AND Preop.eliminado IS NULL AND Preop.FPasivo IS NULL AND Preop.CSuspendida IS NULL)
		THEN 1
		ELSE 0
	   END AS TienePreoperatoriaPendiente
	   ,HET_MED.NifInsercion as NifInsercion_Med
	   ,HET_ENF.DNIENfermera as NifInsercion_Enf
	   ,MedReg.NombreCompleto AS Registro_Med
	   ,EnfReg.NombreCompleto AS Registro_Enf
	   ,MedIns.NombreCompleto AS Insercion_Med
	   ,EnfIns.NombreCompleto AS Insercion_Enf

from  Ingresos..Triajes T with (NOLOCK)
      LEFT OUTER JOIN Parametros..CamasBoxesUrg C with (NOLOCK) ON C.CodTriaje = T.CodTriaje
      LEFT OUTER JOIN Parametros..CamasIngUrgencia CI with (NOLOCK) ON CI.CodTriaje = T.CodTriaje
      LEFT OUTER JOIN Parametros..ParametrosMedicos M with (NOLOCK) ON M.DNIMedico = T.DNIUsu
      LEFT OUTER JOIN Parametros..DatosEnfermeras enf with (NOLOCK) ON T.DNIUsu = enf.DNIEnf
      LEFT JOIN [Hclinica]..[Pacientes] AS P ON P.[CodPaciente] = T.[CodPaciente]
      LEFT JOIN Ingresos..EpisodioUrgencias U ON U.CodPaciente = T.CodPaciente AND U.CodEpisodio = T.CodEpisodio
      LEFT OUTER JOIN Parametros..MutuasSalud as ms ON U.CodColectivo = ms.codigo
      LEFT JOIN Parametros..Servicios S ON U.CodigoServicioUrgenc = S.Codigo
      LEFT JOIN Ingresos..PrimeraVisita PV ON (U.CodPaciente = PV.CodPaciente AND U.CodEpisodio = PV.CodEpisodio)
      LEFT JOIN Ingresos..DetallePrimeraVisita DPV ON (U.CodPaciente = DPV.CodPaciente AND U.CodEpisodio = DPV.CodEpisodio)
      LEFT JOIN Hclinica..DiagnosticosCIE DIA ON DIA.CodPaciente = T.CodPaciente AND DIA.CodEpisodio = T.CodEpisodio AND EsPrincipal = 1 AND DIA.FecBorrado IS NULL		
	  LEFT JOIN Parametros..CIEDiagnostico T1 ON T1.CodDiagnostico = DIA.CodDiag
	  --Se obtienen los datos de hoja de entrega de turno médico registrada dentro de las últimas 12 horas correspondientes al último registro realizado
	  LEFT JOIN Ingresos..HojasEntregaTurno HET_MED ON (T.CodPaciente = HET_MED.CodPaciente AND T.CodEpisodio = HET_MED.CodEpisodio AND HET_MED.FechaInicio = 
				(SELECT MAX(FechaInicio) from Ingresos..HojasEntregaTurno HEnt where HEnt.CodPaciente = T.CodPaciente AND HEnt.CodEpisodio = T.CodEpisodio AND
				 HEnt.FechaInicio > DATEADD(hour,-12,@spvar_FechaEntregaTurno)))
	  --Se obtienen los datos de hojas de entrega de turno de enfermería registrada dentro de las últimas 12 horas correspondientes al último registro realizado
	  LEFT JOIN Ingresos..DictamenEnf HET_ENF ON (T.CodPaciente = HET_ENF.CodPaciente AND T.CodEpisodio = HET_ENF.CodEpisodio AND HET_ENF.Fecha = 
				(SELECT MAX(Fecha) from Ingresos..DictamenEnf DEnf where DEnf.CodPaciente = T.CodPaciente AND DEnf.CodEpisodio = T.CodEpisodio AND
				 DEnf.Fecha > DATEADD(hour,-12,@spvar_FechaEntregaTurno)))
	  LEFT JOIN Parametros..PrioridadUrgencia PU ON HET_MED.CodEstadoPaciente = PU.CodPrioridad AND PU.CodCentro = @spvar_codCentro 
	  LEFT JOIN Ingresos..EpisodioHospitalizacion EH ON U.CodEpisodio = EH.CodEpisodioOrigen AND EH.CodPaciente = T.CodPaciente
	  LEFT JOIN InformesProgreso IP ON
			    T.CodPaciente = IP.CodPaciente AND
			    T.CodEpisodio = IP.CodEpisodio AND
			    IP.HComienzo = (SELECT MAX(IP2.HComienzo) from InformesProgreso IP2 where IP.CodPaciente = IP2.CodPaciente AND IP.CodEpisodio = IP2.CodEpisodio)
	  LEFT JOIN Parametros..PrioridadUrgencia CEvo ON HET_MED.CodEstadoPaciente = CEvo.CodPrioridad AND CEvo.CodCentro = @spvar_CodCentro				   
	  LEFT JOIN Parametros..PrioridadUrgencia CEvo2 ON IP.Situacion = CEvo2.CodPrioridad AND CEvo2.CodCentro = @spvar_CodCentro		
	  LEFT JOIN
		Parametros..vParDatosUsuarios MedReg ON
			HET_MED.NifRegistro = MedReg.Dni
	  LEFT JOIN
		Parametros..vParDatosUsuarios MedIns ON
			HET_MED.NifInsercion = MedIns.Dni
	  LEFT JOIN
		Parametros..vParDatosUsuarios EnfReg ON
			HET_ENF.NifRegistro = EnfReg.Dni
	  LEFT JOIN
		Parametros..vParDatosUsuarios EnfIns ON
			HET_ENF.DNIENfermera = EnfIns.Dni

where T.CodTriaje = 'a' 
      AND U.FechaEntrada >= ISNULL(@spvar_FechaDesde,U.FechaEntrada) AND U.FechaEntrada <= ISNULL(@spvar_FechaHasta,U.FechaEntrada)
      AND (@bolFiltrarPorPaciente = 0 OR (@bolFiltrarPorPaciente = 1
		   AND (RTRIM(P.CodHistoria) COLLATE Modern_Spanish_CI_AI LIKE RTRIM(@spvar_PacHC) + '%'
           AND RTRIM(P.PacNombre) COLLATE Modern_Spanish_CI_AI LIKE RTRIM(@spvar_PacNombre) + '%'
           AND RTRIM(P.PacApell1) COLLATE Modern_Spanish_CI_AI LIKE RTRIM(@spvar_PacApell1) + '%'
           AND RTRIM(P.PacApell2) COLLATE Modern_Spanish_CI_AI LIKE RTRIM(@spvar_PacApell2) + '%')))
	  
union

select 
      U.PreferenciaIni as PrioridadTri,
      Preferencia as PrioridadUrg, 
      '1' as Triaje,
      Parametros.dbo.fnParFechaHoraUTC(FechaEntrada) as FIngreso____,
      Parametros.dbo.fnParFechaHoraUTC(FTriaje) as FTriaje____,
      Parametros.dbo.fnParFechaHoraUTC(FechaEntrada) as FechaEntrada____,
      Area as Tipo,                
      isnull(U.Localizacion,0) as Localizacion,
      Parametros.dbo.fnParFechaHoraUTC(isnull(FechaLocalizacion,FechaEntrada)) as FechaLocalizacion____,
      P.Genero as Genero, 
      P.FecNac as Edad,
      P.PacNombre,
      P.PacApell1,
      P.PacApell2,
      U.CausaUrgencias as PAsistencial,
      isnull(RTRIM(M.NomMedico) + ' ' + RTRIM(M.Apell1) + ' ' + RTRIM(M.Apell2),RTRIM(enf.NombreEnf) + ' ' + RTRIM(enf.Apell1Enf) + ' ' + RTRIM(enf.Apell2Enf)) as Medico,
      coalesce(M.DNIMedico,enf.DNIEnf) as DNIMedico, 
      U.CodPaciente, 
      U.CodEpisodio as CodEpisodio, 
      P.CodHistoria as CodHistoria, 
      '' as CodTriaje,
      '' as ID, 
      case when U.Localizacion = 2 or U.Localizacion = 4 or U.Localizacion = 6 then C.CodCama else CI.CodCama end as Cama,  --mps 
      Parametros.dbo.fnParFechaHoraUTC(FechaUrgencia) as FechaUrgencia____,
      (Select count(1) From Hclinica..InformeRadiologico IR with (NOLOCK)
        Inner Join Hclinica..PruebasRadiologicas PR with (NOLOCK)
         On PR.CodInforme = IR.CodRegistro 
        Where IR.CodPaciente = U.CodPaciente
        AND IR.CodEpisodio = U.CodEpisodio
        AND ((informerequerido = 1 AND IR.F_Realizacion is Not Null) 
            or (informerequerido = 0 AND frealizsinInf is not null)))  
      as RadioInformadas,
      
      -- estados 0 (solicitado), 1 (paciente ha llegado), 2 (asignada sala), 6 (pendiente de realizar),
      --  8 (pruebas anuladas) y 10 (pasiva)
      (Select count(1) From Hclinica..InformeRadiologico IR with (NOLOCK)
      Inner Join Hclinica..PruebasRadiologicas PR with (NOLOCK)
        On PR.CodInforme = IR.CodRegistro
        Where IR.CodPaciente = U.CodPaciente
         AND IR.CodEpisodio = U.CodEpisodio
         AND Convert(int, PR.Estado) in (0,1,2,6,8,10)
         )
      as RadioSinRealizar,

      -- estados 3 (realizada sin informe) y 4 (realizada con informe sin firma)
      (Select count(1) From Hclinica..InformeRadiologico IR with (NOLOCK)
       Inner Join Hclinica..PruebasRadiologicas PR with (NOLOCK)
        On PR.CodInforme = IR.CodRegistro
        Where IR.CodPaciente = U.CodPaciente
          AND IR.CodEpisodio = U.CodEpisodio
          AND Convert(int, PR.Estado) in (3,4) 
          )
      as RadioRealizadas,
      
      -- Buscamos si el informe tiene los campos de patología marcados
      (select count(1)
            from Hclinica..InformeRadiologico IR with (NOLOCK)
            where IR.CodPaciente = U.CodPaciente 
      AND IR.CodEpisodio = U.CodEpisodio
      AND (IR.Patologico = 1 or IR.PatologiaNoDemorable = 1)
      ) as RadioPatologicas,
      
      (select count(1) from Hclinica..SolicitudesLaboratorio L with (NOLOCK), Hclinica..DeterminacionLaboratorio D with (NOLOCK) where L.CodPaciente = U.CodPaciente AND L.CodEpisodio = U.CodEpisodio AND L.CodRegistro = D.CodRegistro AND L.FBorrado is null) 
            as labTotales,
      (select count(1) from Hclinica..SolicitudesLaboratorio L with (NOLOCK), Hclinica..DeterminacionLaboratorio D with (NOLOCK) where L.CodPaciente = U.CodPaciente AND L.CodEpisodio = U.CodEpisodio AND L.CodRegistro = D.CodRegistro AND D.FRealizacion is not null) 
            as labRealizadas,

      (select count(1) From Hclinica..Interconsulta i where i.CodPaciente = U.CodPaciente AND i.CodEpisodio = U.CodEpisodio) 
            as InterConsTotales,
      (select count(1) From Hclinica..Interconsulta i where i.CodPaciente = U.CodPaciente AND i.CodEpisodio = U.CodEpisodio AND Firma = 1)
            as InterConsFirmadas,
      (select count(1) From Hclinica..Interconsulta i where i.CodPaciente = U.CodPaciente AND i.CodEpisodio = U.CodEpisodio AND (Conclusion is not null or TextoRevision is not null)) 
            as InterConsRealizadas,

      case isnull(U.Localizacion,0)
            when 0 then 'Espera'
            when 1 then 'Esp.Proceso'
            when 2 then Parametros.dbo.fnParSDescripcionCama(C.CodCama)
            when 3 then Parametros.dbo.fnParSDescripcionCamaIngresos(CI.CodCama)
            when 4 then Parametros.dbo.fnParSDescripcionCama(C.CodCama)
            when 5 then 'Posible Fugado'
            when 6 then Parametros.dbo.fnParSDescripcionCama(C.CodCama)
      end as DesLocalizacion,
      
      (select count(1) from Hclinica..SolicitudesLaboratorio L with (NOLOCK), Hclinica..DeterminacionLaboratorio D with (NOLOCK) where L.CodPaciente = U.CodPaciente AND L.CodEpisodio = U.CodEpisodio AND L.CodRegistro = D.CodRegistro AND D.Patologico in ('MS', 'MI')) --is not null) 
            as labPatologico,
	  ISNULL(
			  U.IdGuiaClinica,
			  (
				select MIN (I.CodProblema)
				from 	(
							select
								  ipd.CodPaciente
								, ipd.CodEpisodio
								, ipd.CodProblema
								, ipd.CodSubProblema
								, ipd.CodDiagnostico
								, ipd.IDInformeIPD					
							from Hclinica..InformeIPD ipd 
							union
							select 
								  tcGES.CodPaciente
								, tcGES.CodEpisodio
								, ipd.CodProblema
								, ipd.CodSubProblema
								, ipd.CodDiagnostico
								, tcGES.IDInformeIPD	
							from Hclinica..TrazabilidadCasoGES tcges 
								inner join Hclinica..informeipd ipd on tcges.idinformeipd = ipd.idinformeipd 
						) I 
						inner join Parametros..CIEDiagnostico CIEDiag on I.CodDiagnostico = CIEDiag.CodDiagnostico
				where I.CodPaciente = U.CodPaciente AND I.CodEpisodio = U.CodEpisodio		
			  )
		    ) CodGuia,
      U.TipoGuia,
      U.CodigoServicioUrgenc
      ,P.[NumTarjSanitaria] AS RutPac
      ,ms.Entidad as Prevision,
      U.FinEnfermeria as FinEnfermeria,
      case ISNULL(U.Localizacion, 0)
            when 2 then Parametros.dbo.fnParSEsCamaIngresosDeTriaje(C.CodCama)
            when 4 then Parametros.dbo.fnParSEsCamaIngresosDeTriaje(C.CodCama)
            when 6 then Parametros.dbo.fnParSEsCamaIngresosDeTriaje(C.CodCama)
            else 0
      end as EsBoxTriaje
      ,'LabResultados' = (SELECT COUNT(*) FROM Hclinica..solicitudeslaboratorio SL INNER JOIN Hclinica..determinacionlaboratorio DL ON SL.CodPaciente = U.CodPaciente AND SL.CodEpisodio = U.CodEpisodio AND SL.CodRegistro = DL.CodRegistro AND DL.FResultados IS NOT NULL)
      ,U.CausaUrgencias 
      ,U.Pagado
      ,U.FechaAltaPostTratamiento 
      ,U.DniFirmaAltaPostTratamiento
      ,(select count(1) from Hclinica..solicitudeslaboratorio s with (nolock), 
                             Inter_his_consell..DeterminacionLaboratorio ihd with (nolock),
                             Inter_his_consell..SolicitudLaboratorio ihs with (nolock)
                        where s.CodPaciente = U.CodPaciente 
                                AND s.CodEpisodio = U.CodEpisodio
                                AND ihd.LFAceptacion is not null -- Pruebas aceptadas
                                AND ihd.HCodSolicitud = ihs.HCodSolicitud 
                                AND s.CodPaciente = ihs.HCodPaciente 
                                AND s.CodRegistro = ihs.HCodSolicitud
                                AND ihs.HFBorrado is null                               
          )
            as labAceptadas
      ,P.AtiendeAlNombre
      ,Case 
            WHEN  U.TratamientoEnfAsignado IS null THEN
            CASE 
                 WHEN U.TratamientoEnfRealizado IS NULL THEN NULL
                 WHEN U.TratamientoEnfRealizado = 0 THEN 0
                 WHEN U.TratamientoEnfRealizado = 1 THEN 1
            END
            WHEN U.TratamientoEnfAsignado = 0 THEN
            CASE 
                 WHEN U.TratamientoEnfRealizado IS NULL THEN NULL
                 WHEN U.TratamientoEnfRealizado = 0 THEN 0
                 WHEN U.TratamientoEnfRealizado = 1 THEN 1
            END
            WHEN U.TratamientoEnfAsignado = 1 THEN
            CASE 
                 WHEN U.TratamientoEnfRealizado IS NULL THEN 0
                 WHEN U.TratamientoEnfRealizado = 0 THEN 0
                 WHEN U.TratamientoEnfRealizado = 1 THEN 1
            END
      END
      as TratamientoEnf
      ,IndicacionesAlta = (Case when (isnull(PV.ExplFisica,'0') = 11) then PlanYTratamiento Else IndicacionesAltaDAU2012 End)
      ,T1.DescDiagnostico    
      ,PV.CausaVisita
      ,REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(P.PacNombre, 'á', 'a'), 'é','e'), 'í', 'i'), 'ó', 'o'), 'ú','u') as PacNombreAI
      ,REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(P.PacApell1, 'á', 'a'), 'é','e'), 'í', 'i'), 'ó', 'o'), 'ú','u') as PacApell1AI
      ,REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(P.PacApell2, 'á', 'a'), 'é','e'), 'í', 'i'), 'ó', 'o'), 'ú','u') as PacApell2AI
      ,HET_MED.FechaInicio as FechaTurno_Med
      ,PU.DesPrioridad as TurnoEstadoPaciente
      ,HET_MED.Observaciones as DescTurno_Med
      ,HET_MED.NifRegistro as NifRegistro_Med
      ,HET_ENF.Fecha as FechaTurno_Enf
      ,HET_ENF.MedicacionAnt as DescTurno_Enf
      ,HET_ENF.NifRegistro as NifRegistro_Enf
      ,(CASE WHEN EH.CodEpisodio IS NULL THEN '0' ELSE '1' END) as TieneSolHospitalizacion
      , CASE WHEN HET_MED.CodPaciente IS NULL THEN CEvo2.DesPrioridad ELSE CEvo.DesPrioridad END AS UltimaEvolucion
      ,CASE WHEN EXISTS(SELECT * FROM Hclinica..Preoperatoria Preop WHERE U.CodPaciente = Preop.CodPaciente AND Preop.eliminado IS NULL AND Preop.FPasivo IS NULL AND Preop.CSuspendida IS NULL)
		THEN 1
		ELSE 0
	   END AS TienePreoperatoriaPendiente
	   ,HET_MED.NifInsercion as NifInsercion_Med
	   ,HET_ENF.DNIENfermera as NifInsercion_Enf
	   ,MedReg.NombreCompleto AS Registro_Med
	   ,EnfReg.NombreCompleto AS Registro_Enf
	   ,MedIns.NombreCompleto AS Insercion_Med
	   ,EnfIns.NombreCompleto AS Insercion_Enf
       
from  Ingresos..EpisodioUrgencias U With (NOLOCK)
      LEFT OUTER JOIN Hclinica..Pacientes P with (NOLOCK) ON P.CodPaciente = U.CodPaciente
      LEFT OUTER JOIN Parametros..CamasBoxesUrg C with (NOLOCK) ON U.CodPaciente = C.CodPaciente AND U.CodEpisodio = C.CodEpisodio
      LEFT OUTER JOIN Parametros..CamasIngUrgencia CI with (NOLOCK) ON U.CodPaciente = CI.CodPaciente AND U.CodEpisodio = CI.CodEpisodio
      LEFT OUTER JOIN Parametros..ParametrosMedicos M with (NOLOCK) ON M.DNIMedico = U.NIFMedUrgencia
      LEFT OUTER JOIN Parametros..DatosEnfermeras enf with (NOLOCK) ON U.NIFMedUrgencia = enf.DNIEnf
      LEFT OUTER JOIN Parametros..MutuasSalud ms on U.CodColectivo = ms.codigo
      LEFT JOIN Parametros..Servicios S ON U.CodigoServicioUrgenc = S.Codigo
      LEFT JOIN Ingresos..PrimeraVisita PV ON (U.CodPaciente = PV.CodPaciente AND U.CodEpisodio = PV.CodEpisodio)
      LEFT JOIN Ingresos..DetallePrimeraVisita DPV ON (U.CodPaciente = DPV.CodPaciente AND U.CodEpisodio = DPV.CodEpisodio)
      LEFT JOIN Hclinica..DiagnosticosCIE DIA ON DIA.Codpaciente = U.Codpaciente
                                             AND DIA.CodEpisodio = U.CodEpisodio 
						                     AND EsPrincipal = 1 AND DIA.FecBorrado IS NULL		
	  LEFT JOIN Parametros..CIEDiagnostico T1 ON T1.CodDiagnostico = DIA.CodDiag
	  --Se obtienen los datos de hoja de entrega de turno médico registrada dentro de las últimas 12 horas correspondientes al último registro realizado
	  LEFT JOIN Ingresos..HojasEntregaTurno HET_MED ON (U.CodPaciente = HET_MED.CodPaciente AND U.CodEpisodio = HET_MED.CodEpisodio AND HET_MED.FechaInicio = 
				(SELECT MAX(FechaInicio) from Ingresos..HojasEntregaTurno HEnt where HEnt.CodPaciente = U.CodPaciente AND HEnt.CodEpisodio = U.CodEpisodio AND 
				HEnt.FechaInicio > DATEADD(hour,-12,@spvar_FechaEntregaTurno)))
	  --Se obtienen los datos de hojas de entrega de turno de enfermería registrada dentro de las últimas 12 horas correspondientes al último registro realizado
	  LEFT JOIN Ingresos..DictamenEnf HET_ENF ON (U.CodPaciente = HET_ENF.CodPaciente AND U.CodEpisodio = HET_ENF.CodEpisodio AND HET_ENF.Fecha = 
				(SELECT MAX(Fecha) from Ingresos..DictamenEnf DEnf where DEnf.CodPaciente = U.CodPaciente AND DEnf.CodEpisodio = U.CodEpisodio AND 
				DEnf.Fecha > DATEADD(hour,-12,@spvar_FechaEntregaTurno)))
	  LEFT JOIN Parametros..PrioridadUrgencia PU ON HET_MED.CodEstadoPaciente = PU.CodPrioridad AND PU.CodCentro = @spvar_codCentro 
	  LEFT JOIN Ingresos..EpisodioHospitalizacion EH ON U.CodEpisodio = EH.CodEpisodioOrigen AND EH.CodPaciente = U.CodPaciente
	  LEFT JOIN InformesProgreso IP ON
			U.CodPaciente = IP.CodPaciente AND
			U.CodEpisodio = IP.CodEpisodio AND
			IP.HComienzo = (SELECT MAX(IP2.HComienzo) from InformesProgreso IP2 where IP.CodPaciente = IP2.CodPaciente AND IP.CodEpisodio = IP2.CodEpisodio)
	  LEFT JOIN Parametros..PrioridadUrgencia CEvo ON HET_MED.CodEstadoPaciente = CEvo.CodPrioridad AND CEvo.CodCentro = @spvar_CodCentro				   
	  LEFT JOIN Parametros..PrioridadUrgencia CEvo2 ON IP.Situacion = CEvo2.CodPrioridad AND CEvo2.CodCentro = @spvar_CodCentro			
	  LEFT JOIN
		Parametros..vParDatosUsuarios MedReg ON
			HET_MED.NifRegistro = MedReg.Dni
	  LEFT JOIN
		Parametros..vParDatosUsuarios MedIns ON
			HET_MED.NifInsercion = MedIns.Dni
	  LEFT JOIN
		Parametros..vParDatosUsuarios EnfReg ON
			HET_ENF.NifRegistro = EnfReg.Dni
	  LEFT JOIN
		Parametros..vParDatosUsuarios EnfIns ON
			HET_ENF.DNIENfermera = EnfIns.Dni	
	  
where U.FechaSalida is null
      AND (@spvar_CodCentro is null OR U.CodigoCentUrg = @spvar_CodCentro) AND U.FechaEntrada >= ISNULL(@spvar_FechaDesde,U.FechaEntrada) AND U.FechaEntrada <= ISNULL(@spvar_FechaHasta,U.FechaEntrada)
      AND (@bolFiltrarPorPaciente = 0 OR (@bolFiltrarPorPaciente = 1
		   AND (RTRIM(P.CodHistoria) COLLATE Modern_Spanish_CI_AI LIKE RTRIM(@spvar_PacHC) + '%'
           AND RTRIM(P.PacNombre) COLLATE Modern_Spanish_CI_AI LIKE RTRIM(@spvar_PacNombre) + '%'
           AND RTRIM(P.PacApell1) COLLATE Modern_Spanish_CI_AI LIKE RTRIM(@spvar_PacApell1) + '%'
           AND RTRIM(P.PacApell2) COLLATE Modern_Spanish_CI_AI LIKE RTRIM(@spvar_PacApell2) + '%')))

order by Triaje

GO



--dbo.SpIngSQuiDatos.sql

USE [Ingresos]
GO

/****** Object:  StoredProcedure [dbo].[SpIngSQuiDatos]    Script Date: 10/24/2014 13:30:02 ******/
IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[SpIngSQuiDatos]') AND type in (N'P', N'PC'))
DROP PROCEDURE [dbo].[SpIngSQuiDatos]
GO

USE [Ingresos]
GO

/****** Object:  StoredProcedure [dbo].[SpIngSQuiDatos]    Script Date: 10/24/2014 13:30:02 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

--	PROCEDIMIENTO		: 	SpIngSQuiDatos
--	FUNCION          	: 	Obtiene los datos de un informe quirrgico
--	DEVUELVE          	: 
--	FECHA             	: 	22/12/2005
--	VERSION             : 	1.0
--	AUTOR             	: 	Gerardo Prieto David (MECEMSA Consultores)
--  MODIFICACION		:   MPS 31/05/07 possum
--							Jorge Poveda SÃ¡ez 10/12/2007
--							He incluido los campos CodExamInterv 1 y 2
--	APLICACIN ORIGEN   	: 	Informe quirrgico
--*******************************************************************
-- MODIFICACIÃ“N: Obtenemos tambiÃ©n la fecha de solicitud y el cÃ³digo del episodio del informe quirÃºrgico
-- FECHA		: 24/07/2008
-- AUTOR		: Oscar Vilella Alarcon
--*******************************************************************
-- MODIFICACIÃ“N: Obtenemos la informaciÃ³n del paciente a mostrar en kiosko
-- FECHA		: 19/08/2008
-- AUTOR		: Oscar Vilella Alarcon
--*******************************************************************
-- MODIFICACIÃ“N: La informaciÃ³n del kiosco la sacamos de la preoperatoria
-- FECHA		: 10/03/2009
-- AUTOR		: Pablo GonzÃ¡lez Moro
--*******************************************************************
-- MODIFICACIÃ“N : Ampliamos  de tamaÃ±o la variable local @spvar_Antibiotico
-- FECHA		: 13/06/2011
-- AUTOR		: Jose Almela
--*******************************************************************
-- MODIFICACIÃ“N: El nombre del anestesista se obtiene de la tabla InforeQuirurgico o de Infore Anestesico depeniendo del valor de la constante m_bolAnestesiologia
-- FECHA		: 25/11/2013
-- AUTOR		: CTF - 73569626D - CHC3335_ModificaciÃ³n Campo Analista en InfQuirurgico
--*******************************************************************
-- MODIFICACIÃ“N : Se agrega la Enfermera Matrona como cirujano previsto al informe quirurgico.
-- FECHA		: 24/09/2014
-- AUTOR		: Req. 68579 v4.46r2 - 1466 - Patrick VicuÃ±a
--*******************************************************************
--MODIFICACIÃ“N	: (04/09/2015) - v4.53r1 - SGN - 2500 - Plano y extremidad de intervenciones quirÃºrgicas
--*******************************************************************
-- MODIFICACION:		: 17/05/2017 - v17.2 - 16381 - LMF - Filtrado de secciones y exÃ¡menes por centro
-- MODIFICACION         : 03/08/2017 - v17.3 - 16153 - MPR - Registro Quirurgico - Incorporar registro de Turno

CREATE Proc [dbo].[SpIngSQuiDatos]

	@spvar_CodIntervencion varchar(7)
	--CTF - 73569626D - CHC3335_ModificaciÃ³n Campo Analista en InfQuirurgico
	,@spvar_CodCentro char(5)

As

	--	Declaracin de variables.
	Declare @spvar_CodAntib int,
			@spvar_Antibiotico varchar(222), 
			@spvar_DNICir Char(8),
			@spvar_Cir VarChar(45), 
			@spvar_DNIAnes Char(8), 
			@spvar_Anes Varchar(45),
			@spvar_DNIEnf Char(8), 
			@spvar_Enf Varchar(45), 
			@spvar_DNI1 Char(8), 
			@spvar_Ayu1 Varchar(45),
			@spvar_DNI2 Char(8),
			@spvar_Ayu2 Varchar(45), 
			@spvar_DNI3 Char(8), 
			@spvar_Ayu3 Varchar(45),
			@spvar_CodCenRemite CHAR(5), 
			@spvar_TasaMorbilidad float ,  --mps
			@spvar_TasaMortalidad float ,   --mps
			@spvar_InfoPaciente varchar(4000)

	--	Valor inicial de las variables.
	Select @spvar_Antibiotico = ''
	Select @spvar_CodAntib = Null	
	Select @spvar_DNICir = ''
	Select @spvar_DNIAnes = ''
	Select @spvar_DNIEnf = ''
	Select @spvar_DNI1 = ''
	Select @spvar_DNI2 = ''
	Select @spvar_DNI3 = ''
	select @spvar_TasaMorbilidad = null
	select @spvar_TasaMortalidad = null

	--	Obtencin de los datos del antibitico empleado.	
	Select 
		@spvar_CodAntib = IQ.CodAntibioticos,
       		@spvar_Antibiotico = CF.DescEspecialidad + CF.DescPresentacion
	From 
		HClinica..InformeQuirurgico IQ,
       		Farmacias..Especialidad CF,
       		Farmacias..REspecialidad CFR
 	Where 
		IQ.CodIntervencion = @spvar_CodIntervencion And	
		CFR.IDEspecialidad = CodAntibioticos And
       		CF.CodEspec = CFR.CodEspec And
       		CF.Tipo = CFR.Tipo

	--	Obtencin del DNI del cirujano, del instrumentista y de los ayudantes.	
	Select 
		@spvar_DNICir = CodCirujano,
		@spvar_DNIEnf = CodInstrumentista,
		@spvar_DNI1 = CodAyudante1,
		@spvar_DNI2 = CodAyudante2,
		@spvar_DNI3 = CodAyudante3
	From 
		HClinica..InformeQuirurgico
	Where 
		CodIntervencion = @spvar_CodIntervencion

	--	Obtencin del nombre del cirujano.
	-- v4.47r2 - 1466 - Req. 68579 - ActualizaciÃ³n SP  INI 
	 IF EXISTS (SELECT * From Parametros..ParametrosMedicos  Where DNIMedico = @spvar_DNICir)
		  BEGIN
			 Select   
			  @spvar_Cir = Rtrim(parametros..ParametrosMedicos.NomMedico)+' '+RTrim(parametros..ParametrosMedicos.Apell1)+' '+RTrim(parametros..ParametrosMedicos.Apell2)  
			 From   
			  Parametros..ParametrosMedicos  
			 Where   
			  DNIMedico = @spvar_DNICir  
		  END
	 ELSE
		BEGIN
			 Select   
			  @spvar_Cir = Rtrim(parametros..DatosEnfermeras.NombreEnf)+' '+RTrim(parametros..DatosEnfermeras.Apell1Enf)+' '+RTrim(parametros..DatosEnfermeras.Apell2Enf)  
			 From   
			  Parametros..DatosEnfermeras 
			 Where   
			  DNIEnf = @spvar_DNICir   AND CodRol = '4'
		END
	 -- v4.47r2 - 1466 - Req. 68579 - ActualizaciÃ³n SP FIN

	--	Obtencin del DNI del anestesista.
	Select 
		@spvar_DNIAnes = DNIAnestesista
	From 
		HClinica..InformeAnestesico
	Where 
		CodIntervencion = @spvar_CodIntervencion

	--	Obtencin del nombre del anestesista.
	--CTF - 73569626D - CHC3335_ModificaciÃ³n Campo Analista en InfQuirurgico - INI
	IF (SELECT ValorConstante FROM Parametros..constantes WHERE NombreConstante = 'm_bolAnestesiologia' and CentroRef=@spvar_CodCentro)=1 
		BEGIN
	--CTF - 73569626D - CHC3335_ModificaciÃ³n Campo Analista en InfQuirurgico - FIN
			Select 
				@spvar_Anes = Rtrim(parametros..ParametrosMedicos.NomMedico)+' '+RTrim(parametros..ParametrosMedicos.Apell1)+' '+RTrim(parametros..ParametrosMedicos.Apell2)
			From 
				Parametros..ParametrosMedicos
			Where 
				DNIMedico = @spvar_DNIAnes
	--CTF - 73569626D - CHC3335_ModificaciÃ³n Campo Analista en InfQuirurgico - INI
		END	
	ELSE
		BEGIN
				Select 
					@spvar_Anes = RTRIM(NombreAnestesista)
				From 
					HClinica..InformeQuirurgico
				Where 
					CodIntervencion = @spvar_CodIntervencion
		END
	--CTF - 73569626D - CHC3335_ModificaciÃ³n Campo Analista en InfQuirurgico - FIN
				

	--	Obtencin del nombre del instrumentista.
	Select 
		@spvar_Enf = Rtrim(parametros..DatosEnfermeras.NombreEnf)+' '+RTrim(parametros..DatosEnfermeras.Apell1Enf)+' '+RTrim(parametros..DatosEnfermeras.Apell2Enf)
	From 
		Parametros..DatosEnfermeras
	Where 
		DNIEnf = @spvar_DNIEnf

	--	Obtencin del nombre del primer ayudante.
	Select 
		@spvar_Ayu1 = Rtrim(parametros..DatosEnfermeras.NombreEnf)+' '+RTrim(parametros..DatosEnfermeras.Apell1Enf)+' '+RTrim(parametros..DatosEnfermeras.Apell2Enf)
	From 
		Parametros..DatosEnfermeras
	Where 
		DNIEnf = @spvar_DNIEnf

	--	Obtencin del nombre del segundo ayudante.
	Select 
		@spvar_Ayu2 = Rtrim(parametros..DatosEnfermeras.NombreEnf)+' '+RTrim(parametros..DatosEnfermeras.Apell1Enf)+' '+RTrim(parametros..DatosEnfermeras.Apell2Enf)
	From 
		Parametros..DatosEnfermeras
	Where 
		DNIEnf = @spvar_DNIEnf

	--	Obtencin del nombre del tercer ayudante.
	Select 
		@spvar_Ayu3 = Rtrim(parametros..DatosEnfermeras.NombreEnf)+' '+RTrim(parametros..DatosEnfermeras.Apell1Enf)+' '+RTrim(parametros..DatosEnfermeras.Apell2Enf)
	From 
		Parametros..DatosEnfermeras
	Where 
		DNIEnf = @spvar_DNIEnf

	--	Obtencin del cdigo del centro remitente.
	SELECT 
		@spvar_CodCenRemite = CodCenRemite
	FROM 
		HClinica..Preoperatoria
	WHERE 
		CodIntervencion = @spvar_CodIntervencion

    -- Datos del resultado del possum. EstÃ¡n en la preoperatoria
	-- MORBILIDAD
	SELECT 
		@spvar_TasaMorbilidad = TasaMorbilidad
	FROM
		HClinica..Preoperatoria
	WHERE
		CodIntervencion = @spvar_CodIntervencion

	-- MORTALIDAD e InfoPaciente
	SELECT 
		@spvar_TasaMortalidad = TasaMortalidad,
		@spvar_InfoPaciente = InfoPaciente
	FROM
		HClinica..Preoperatoria
	WHERE
		CodIntervencion = @spvar_CodIntervencion
		
		
	
	--	Obtencin del resto de valores.
	Select 
		@spvar_DNICir, 
		@spvar_Cir, 
		@spvar_DNIAnes, 
		@spvar_Anes, 
		@spvar_DNIEnf, 
		@spvar_Enf,
       	@spvar_DNI1, 
		@spvar_Ayu1, 
		@spvar_DNI2, 
		@spvar_Ayu2, 
		@spvar_DNI3, 
		@spvar_Ayu3,
       	CodMedInforma,
       	Medico = (
			Select 
				Rtrim(Parametros..ParametrosMedicos.NomMedico)+' '+RTrim(Parametros..ParametrosMedicos.Apell1)+' '+RTrim(Parametros..ParametrosMedicos.Apell2)
                 		From 
				Parametros..ParametrosMedicos
                		Where 
				I.CodMedInforma = DNIMedico
		),
       		CodQuirofano,
       		PosicionInter,
       		Pos = (
			Select 
				Descripcion
              		From 
				Parametros..Codigos
             			Where 
				(Tabla = 'EstPosIntervencion' Or Tabla = 'N') And
                    			Codigo = IsNull(I.PosicionInter,'N')
		),
		CodVia,
      	Via = (
			Select 
				Descripcion
              		From 
				Parametros..Codigos
			Where 
				(Tabla = 'EstDescripcionVia' Or Tabla = 'N') And
				Codigo = IsNull(I.CodVia,'N')
		),
		CodProcedimiento, 
		DescProced,
       	CodPostCIE, 
		DescDiagnostico,
       	@spvar_CodAntib, 
		@spvar_Antibiotico,
       	TipoInter,
       	Interv = (
			Select 
				Descripcion
                 		From 
				Parametros..Codigos
                		Where 
				(Tabla = 'EstDesIntervencion' Or Tabla = 'N') And
				Codigo = IsNull(I.TipoInter,'N')
		),
		DestinoInter,
		Destino = (
			Select 
				Descripcion
			From 
				Parametros..Codigos
			Where 
				(Tabla = 'EstDestIntervencion' Or Tabla = 'N') And
                        			Codigo = IsNull(I.DestinoInter,'N')
		),
       	Solicitudes,
       	Drenaje,
       	DescOperatoria,
       	TecnicasEmpleadas,
       	TecnicaCierre,
       	PiezaExtirpada,
       	HInicioInter, 
		HFinInter, 
       	FInforme,
       	I.CodMutua,
       	Entidad,
       	Facturable,
       	CantidadProcesos,
       	@spvar_CodCenRemite,
		SolBiopsia,
		SolLaboratorio,
		SolCitologias,
		SolHormonales,
		SolRadiologia,
		SolPostmortem,
		CodInforme,
		Firmado,
		NumCordales,
		CodExamInterven,
		CodExamInterven1,
		CodExamInterven2,
		@spvar_TasaMorbilidad as TasaMorbilidad,
		@spvar_TasaMortalidad as TasaMortalidad,
		FSolicitud,
		I.CodEpisodio,
		@spvar_InfoPaciente as InfoPaciente
		--(04/09/2015) - v4.53r1 - SGN - 2500 - Plano y extremidad de intervenciones quirÃºrgicas - INI
		,I.IdPlano
		,I.IdCuadrante
		,Pl.DescPlano
		,Cd.DescCuadrante
		--(04/09/2015) - v4.53r1 - SGN - 2500 - Plano y extremidad de intervenciones quirÃºrgicas - FIN
		,I.IdTurnoInfQuirurgico
		
		From 
			HClinica..InformeQuirurgico I left join Parametros..CIEDiagnostico C on CodPostCIE = c.CodDiagnostico
			LEFT JOIN Parametros..Procedimientos P ON I.CodProcedimiento = P.CodDiagnostico
			--04/09/2015 - v4.53r1 - SGN - 2500 - Plano y extremidad de intervenciones quirÃºrgicas - INI
			LEFT JOIN Parametros..Planos Pl ON I.IdPlano = Pl.IdPlano
			LEFT JOIN Parametros..Cuadrantes Cd ON I.IdCuadrante = Cd.IdCuadrante
			--04/09/2015 - v4.53r1 - SGN - 2500 - Plano y extremidad de intervenciones quirÃºrgicas - FIN
			right join Parametros..MutuasSalud M on M.Codigo = I.CodMutua

 	Where 
		CodIntervencion = @spvar_CodIntervencion 
		 
GO

GO



--dbo.SpIngSTriaje.sql

USE [Ingresos]
GO

IF EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[SpIngSTriaje]') AND type in (N'P', N'PC'))
	DROP PROCEDURE [dbo].[SpIngSTriaje]
GO
    
/*******************************************************************
* FUNCION	   : Obtiene los datos del Triaje
* DEVUELVE	   :
* FECHA		   : 17/10/2005
* VERSION	   : 1.0
* AUTOR		   : Desiderio Marti (Mecemsa)
* ORIGEN	   : Hoja de Urgencias
********************************************************************
* MODIFICACION : (23/07/2007) MPS obtenemos la descripcion de la prioridad del triaje
* MODIFICACION : (24/07/2007) Sonia Mateo (Agensys Technology)
*				 Modifico los cruces para que use la tabla PrioridadUrgencia en lugar de la de codigos
* MODIFICACION : (14/09/2016) - V4.63r1 - 13314 - SGH - Diferencias en datos de la categorización
* MODIFICACION : (29/06/2017) - V17.2r1 - 18277 - SGH/APB - Triaje ESI
*******************************************************************/

CREATE PROCEDURE [dbo].[SpIngSTriaje]
	@CodId int = -1
AS

IF (@CodId = -1)
BEGIN
	SELECT
		 T.Id
		,T.FechaAlta
		,T.Nombre
		,T.Apellido1
		,T.Apellido2
		,T.Edad
		,T.Sexo
		,T.Prioridad
		,T.TUrgencia
		,T.Observaciones
		,T.CodTriaje
		,T.DniUsu
		,EU.Localizacion
		,EU.FechaLocalizacion
		,PU.DesPrioridad AS Descripcion
		,T.Tipo
	FROM 
		Ingresos..Triajes T
		LEFT JOIN Ingresos..EpisodioUrgencias EU ON EU.CodPaciente = T.CodPaciente AND EU.CodEpisodio = T.CodEpisodio
		LEFT JOIN Parametros..PrioridadUrgencia PU ON PU.CodPrioridad = T.Prioridad AND EU.CodigoCentUrg = PU.CodCentro
	WHERE
		PU.CodPrioridad = T.Prioridad
END
ELSE
BEGIN
	SELECT
		 T.Id
		,T.FechaAlta
		,T.Nombre
		,T.Apellido1
		,T.Apellido2
		,T.Edad
		,T.Sexo
		,T.Prioridad
		,T.TUrgencia
		,T.Observaciones
		,T.CodTriaje
		,T.DniUsu
		,EU.Localizacion
		,EU.FechaLocalizacion
		,PU.DesPrioridad AS Descripcion
		,T.Tipo
	FROM 
		Ingresos..Triajes T
		LEFT JOIN Ingresos..EpisodioUrgencias EU ON EU.CodPaciente = T.CodPaciente AND EU.CodEpisodio = T.CodEpisodio
		LEFT JOIN Parametros..PrioridadUrgencia PU ON PU.CodPrioridad = T.Prioridad AND EU.CodigoCentUrg = PU.CodCentro
	WHERE
		Id = @CodId AND PU.CodPrioridad = @CodId
END

GO

GO



--dbo.SpIngSTriajesAnteriores.sql

USE [Ingresos]
GO

IF EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[SpIngSTriajesAnteriores]') AND type in (N'P', N'PC'))
	DROP PROCEDURE [dbo].[SpIngSTriajesAnteriores]
GO

/*********************************************************************
* FUNCION	   : Obtiene los datos de los Triajes Anteriores que se corresponden con el parámetro ID
* DEVUELVE	   : 
* FECHA		   : 07/05/2012
* VERSION      : 4.29
* AUTOR		   : Alfredo Samper
* COMENTARIO   : Paso CodId e Id a null, de forma que, si se quiere obtener un Triaje anterior concreto, le
*				 pasaré el Id, mientras que si quiero todos los triajes anteriores a un triaje concreto, le
*				 pasaré el CodId
* MODIFICACION : (18/09/2016) - V4.63 - 12758 - FCB - Reevaluación-DAU
* MODIFICACION : (29/06/2017) - V17.2r1 - 18277 - SGH/APB - Triaje ESI
*******************************************************************/

CREATE PROCEDURE [dbo].[SpIngSTriajesAnteriores]
	 @CodId int = null
	,@Id int = null
AS

SELECT
		 T.Id
		,T.IdTriaje
		,T.CodPaciente
		,T.CodEpisodio
		,T.Nombre
		,T.Apellido1
		,T.Apellido2
		,T.Edad
		,T.Sexo
		,T.FechaAlta
		,T.Prioridad
		,'PrioridadDesc' = P.DesPrioridad 
		,T.TUrgencia
		,'TUrgenciaDesc' = TU.Descripcion
		,T.Observaciones
		,T.CodTriaje
		,T.DniUsu
		,CASE T.Tipo
			  WHEN 2 THEN 1
			  ELSE 0
		 END AS ESI
		,T.Tipo
		,T.ReqIntSalVid
		,T.AltoRiesgo
		,T.Recursos
		,T.SVAlterados
		,T.Alterados
		,T.AVDI
		,T.Distresado
		,T.EVAMenor
		,T.EVAMayor
		,CASE T.Prioridad
			  WHEN 0 THEN 'Inmediato'
			  WHEN 1 THEN 'Muy Urgente'
			  WHEN 2 THEN 'Urgente'
			  WHEN 3 THEN 'Normal'
			  WHEN 4 THEN 'Consulta'
		 END AS Categorizacion
		,DU.NombreCompleto
		,DU.TipoUsuario
FROM 
	Ingresos..TriajesAnteriores T 
	LEFT JOIN Ingresos..EpisodioUrgencias EP ON EP.CodPaciente = T.CodPaciente AND EP.CodEpisodio = T.CodEpisodio
	INNER JOIN Parametros..PrioridadUrgencia P ON P.CodPrioridad = T.Prioridad AND EP.CodigoCentUrg = P.CodCentro
	INNER JOIN Parametros..Codigos TU ON TU.Tabla = 'EstTipoUrgencia' AND TU.Codigo = T.TUrgencia
	INNER JOIN Parametros..vParDatosUsuarios DU ON DU.Dni = T.DniUsu
WHERE
	T.IdTriaje = ISNULL(@CodId,T.IdTriaje) AND
	T.Id = ISNULL(@Id,T.Id)

GO
GO



--dbo.SpIngSTriajeUrgPrimaria.sql

USE [Ingresos]
GO

IF EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[SpIngSTriajeUrgPrimaria]') AND type in (N'P', N'PC'))
	DROP PROCEDURE [dbo].[SpIngSTriajeUrgPrimaria]
GO

/*********************************************************************
* FUNCION      : SpIngSTriajeUrgPrimaria
* DEVUELVE     : Obtiene los datos del triaje del ultimo episodio de urgencias con destino al hospital del paciente
* FECHA        : 13/07/2009
* VERSION      : 1.0
* AUTOR        : Oscar Vilella
* ORIGEN       : Urgencias
* MODIFICACION : (23/11/2016) - V4.66 - 13886 - CCM - Unificación de tablas de Alta administrativa y reportes
* MODIFICACION : (29/06/2017) - V17.2r1 - 18277 - APB - Triaje ESI
'*******************************************************************/
CREATE PROCEDURE [dbo].[SpIngSTriajeUrgPrimaria]
	@spvar_CodPaciente char(16)
AS

SELECT TOP 1 HT.Prioridad
		    ,HT.TUrgencia
		    ,HT.CodTriaje
		    ,DT.CodDiagrama 
		    ,HT.Tipo
		    ,HT.ReqIntSalVid
		    ,HT.AltoRiesgo
		    ,HT.Recursos
		    ,HT.SVAlterados
		    ,HT.Alterados
		    ,HT.AVDI
		    ,HT.Distresado
		    ,HT.EVAMenor
		    ,HT.EVAMayor
FROM Hclinica..Reportes R
    ,Ingresos..EpisodioUrgencias EU
	INNER JOIN Ingresos..HistoricoTriajes HT ON EU.CodPaciente = HT.CodPaciente AND EU.CodEpisodio = HT.CodEpisodio
	LEFT JOIN Ingresos..DiagramaTriaje DT ON DT.CodTriaje = HT.CodTriaje
	,Parametros..CentrosSalud CS with (nolock)
WHERE R.CodDestAlta = '11' --H de TV  
	  AND R.CodPaciente = EU.CodPaciente
      AND R.CodEpisodio = EU.CodEpisodio
      AND R.RegistroClinico = 1 
      AND EU.CodigoCentUrg = CS.CodCentro
      AND EU.CodPaciente = @spvar_CodPaciente
ORDER BY R.FecAlta DESC

GO
GO



--dbo.SpIngSUbicacionPaciente.sql

USE [Ingresos];
GO
IF EXISTS (SELECT * FROM sys.procedures WHERE [object_id] = OBJECT_ID('[dbo].[SpIngSUbicacionPaciente]'))
BEGIN
	DROP PROCEDURE [dbo].[SpIngSUbicacionPaciente];
END
GO
    
-- *****************************************************************
-- FUNCION	: SpIngSUbicacionPaciente  
-- DESCRIPCIÃ“N	: cargar el formulario de ubicaciones de paciente
-- FECHA	: 06/06/2016
-- VERSION	: 1.0
-- AUTOR	: CCM
--(06/06/2016) - V4.62 - 3247 - CCM - Proteger identidad paciente a peticiÃ³n
--*******************************************************************
--MODIFICACION: (03/08/2016) - V4.62r1 - 12915 - SGH - Proteger identidad paciente
--MODIFICACION: (10/07/2017) - v17.2r1 - 18463 - SGH - InformaciÃ³n de Pacientes en Episodio de Hospitalizado (igual a POC)
--MODIFICACION: (31/07/2017) - v17.3 -   18703 - MPR - Filtro de fechas en Informe de ubicacion de paciente
--*******************************************************************

CREATE PROCEDURE [dbo].[SpIngSUbicacionPaciente]
	@spvar_NumTarjSanitaria Char(16), 
	@spvar_CodHistoriaPapel Varchar(10),
	@spvar_CodHistoria varchar(8),
	@spvar_PacNombre varchar(20),
	@spvar_PacApell1 varchar(25),
	@spvar_PacApell2 varchar(25),
	@spvar_FDesde SmallDateTime,
	@spvar_FHasta SmallDateTime,
	@spvar_CodCentro char(5)
AS
BEGIN


	IF @spvar_codCentro is null
	BEGIN
		  SET @spvar_codCentro = parametros.dbo.fnParHospitalReferencia()
	END
	
	IF  @spvar_PacNombre is null and @spvar_PacApell1 is null and  @spvar_PacApell2 is null
	BEGIN
 
		SELECT  EH.AdmiteVisita,
				ISNULL(UPPER(P.PAcNombre), '') as Nombre,
				ISNULL(UPPER(P.PacApell1), '') as Apell1,
				ISNULL(UPPER(P.PAcApell2), '') as Apell2,
				EH.NumCama as Cama,
				C.DescPla as Planta,
				SE.DescServicio as Servicio,
				CASE EH.AdmiteVisita WHEN 0 THEN ISNULL(EH.MotivoNoAdmiteVisitas, '') ELSE ISNULL(EH.InfoPaciente, '') END AS Observaciones,
				'H' as tipo
		FROM EpisodioHospitalizacion AS EH LEFT OUTER JOIN
			 Hclinica.dbo.Pacientes AS P ON P.CodPaciente = EH.CodPaciente INNER JOIN
			 Parametros.dbo.DatosCamas AS DC ON DC.NumCama = EH.NumCama AND DC.CodCent = @spvar_CodCentro INNER JOIN
			 Parametros.dbo.CodigoPlantas AS C ON DC.CodPlanta = C.CodPla AND C.Centro = @spvar_CodCentro INNER JOIN
			 Parametros.dbo.Plantas AS P1 ON C.codPlanta = P1.CodPlanta INNER JOIN
			 Parametros.dbo.Servicios AS SE ON DC.CodServ = SE.Codigo LEFT JOIN
			 Hclinica.dbo.ArchivoHistoriasPapel AS AHP ON AHP.CodPaciente = EH.CodPaciente AND AHP.CodCentro = @spvar_CodCentro
		WHERE ( @spvar_CodHistoria IS NULL or P.CodHistoria = @spvar_CodHistoria )
			and ( @spvar_NumTarjSanitaria is null or P.NumTarjSanitaria = @spvar_NumTarjSanitaria)
			and ( @spvar_CodCentro is null or EH.CentroIngreso = @spvar_CodCentro ) 
			and ( @spvar_CodHistoriaPapel is null or AHP.CodHistoriaPapel = @spvar_CodHistoriaPapel)
			AND (EH.FechaHospitalizacion <= @spvar_FHasta)
			AND (EH.FechaSalida IS NULL OR EH.FechaSalida > @spvar_FHasta)
			
			
		UNION
		
		SELECT  EU.AdmiteVisita,
				ISNULL(UPPER(P.PAcNombre), '') as Nombre,
				ISNULL(UPPER(P.PacApell1), '') as Apell1,
				ISNULL(UPPER(P.PAcApell2), '') as Apell2,
			  case isnull(EU.Localizacion,0)
							when 0 then 'Espera'
							when 1 then 'Esp.Proceso'
							when 2 then parametros.dbo.fnParSDescripcionCama(C.CodCama)
							when 3 then parametros.dbo.fnParSDescripcionCamaIngresos(CI.CodCama)
							when 4 then parametros.dbo.fnParSDescripcionCama(C.CodCama)
							when 5 then 'Posible Fugado'
							when 6 then parametros.dbo.fnParSDescripcionCama(C.CodCama)
					  end as Cama,
						EU.Area as Planta,
				'URGENCIAS' as Servicio,
				CASE EU.AdmiteVisita WHEN 0 THEN ISNULL(EU.MotivoNoAdmiteVisitas, '') ELSE ISNULL(EU.InfoPaciente, '') END AS Observaciones,
				'U' as tipo
		FROM Ingresos..episodioUrgencias EU LEFT JOIN
			 HClinica..Pacientes P on P.CodPaciente = EU.CodPaciente LEFT JOIN	
			 Parametros..CamasBoxesUrg C On EU.CodPaciente = C.CodPaciente And EU.CodEpisodio = C.CodEpisodio and C.CodCentro = @spvar_CodCentro LEFT JOIN
			 Parametros..CamasIngUrgencia CI On EU.CodPaciente = CI.CodPaciente And EU.CodEpisodio = CI.CodEpisodio and C.CodCentro = @spvar_CodCentro LEFT JOIN 
			 HClinica..ArchivoHistoriasPapel AHP ON AHP.codpaciente = EU.CodPaciente and AHP.CodCentro = @spvar_CodCentro
			 
		WHERE (@spvar_CodHistoria IS NULL OR P.CodHistoria = @spvar_CodHistoria) 
			AND (@spvar_NumTarjSanitaria IS NULL OR P.NumTarjSanitaria = @spvar_NumTarjSanitaria) 
			AND (@spvar_CodHistoriaPapel IS NULL OR AHP.CodHistoriaPapel = @spvar_CodHistoriaPapel) 
			AND (@spvar_CodCentro IS NULL OR  EU.CodigoCentUrg = @spvar_CodCentro)
			AND (EU.FechaUrgencia <= @spvar_FHasta)
			AND (EU.FechaSalida IS NULL OR EU.FechaSalida > @spvar_FHasta)
		
		ORDER BY Apell1, Apell2, Nombre 
	END
	ELSE
	BEGIN
		SELECT  EH.AdmiteVisita,
				ISNULL(UPPER(P.PAcNombre), '') as Nombre,
				ISNULL(UPPER(P.PacApell1), '') as Apell1,
				ISNULL(UPPER(P.PAcApell2), '') as Apell2,
				EH.NumCama as Cama,
				C.DescPla as Planta,
				SE.DescServicio as Servicio,
				CASE EH.AdmiteVisita WHEN 0 THEN ISNULL(EH.MotivoNoAdmiteVisitas, '') ELSE ISNULL(EH.InfoPaciente, '') END AS Observaciones,
				'H' as tipo
		FROM EpisodioHospitalizacion AS EH LEFT OUTER JOIN
			 Hclinica.dbo.Pacientes AS P ON P.CodPaciente = EH.CodPaciente INNER JOIN
			 Parametros.dbo.DatosCamas AS DC ON DC.NumCama = EH.NumCama AND DC.CodCent = @spvar_CodCentro INNER JOIN
			 Parametros.dbo.CodigoPlantas AS C ON DC.CodPlanta = C.CodPla AND C.Centro = @spvar_CodCentro INNER JOIN
			 Parametros.dbo.Plantas AS P1 ON C.codPlanta = P1.CodPlanta INNER JOIN
			 Parametros.dbo.Servicios AS SE ON DC.CodServ = SE.Codigo LEFT JOIN
			 Hclinica.dbo.ArchivoHistoriasPapel AS AHP ON AHP.CodPaciente = EH.CodPaciente AND AHP.CodCentro = @spvar_CodCentro
		WHERE ( @spvar_CodHistoria IS NULL or P.CodHistoria = @spvar_CodHistoria )
			and ( @spvar_NumTarjSanitaria is null or P.NumTarjSanitaria = @spvar_NumTarjSanitaria)
			and ( @spvar_PacNombre is null or P.PacNombre like ('%' + @spvar_PacNombre + '%') )
			and ( @spvar_PacApell1 is null or P.PacApell1 like ('%' + @spvar_PacApell1 + '%' ))
			and ( @spvar_PacApell2 is null or P.PacApell2 like ('%' + @spvar_PacApell2 + '%'))
			and ( @spvar_CodCentro is null or EH.CentroIngreso = @spvar_CodCentro ) 
			and ( @spvar_CodHistoriaPapel is null or AHP.CodHistoriaPapel = @spvar_CodHistoriaPapel)
			AND (EH.FechaHospitalizacion <= @spvar_FHasta)
			AND (EH.FechaSalida IS NULL OR EH.FechaSalida > @spvar_FHasta)

			
		UNION
		
		SELECT  EU.AdmiteVisita,
				ISNULL(UPPER(P.PAcNombre), '') as Nombre,
				ISNULL(UPPER(P.PacApell1), '') as Apell1,
				ISNULL(UPPER(P.PAcApell2), '') as Apell2,
			  case isnull(EU.Localizacion,0)
							when 0 then 'Espera'
							when 1 then 'Esp.Proceso'
							when 2 then parametros.dbo.fnParSDescripcionCama(C.CodCama)
							when 3 then parametros.dbo.fnParSDescripcionCamaIngresos(CI.CodCama)
							when 4 then parametros.dbo.fnParSDescripcionCama(C.CodCama)
							when 5 then 'Posible Fugado'
							when 6 then parametros.dbo.fnParSDescripcionCama(C.CodCama)
					  end as Cama,
						EU.Area as Planta,
				'URGENCIAS' as Servicio,
				CASE EU.AdmiteVisita WHEN 0 THEN ISNULL(EU.MotivoNoAdmiteVisitas, '') ELSE ISNULL(EU.InfoPaciente, '') END AS Observaciones,
				'U' as tipo
		FROM Ingresos..episodioUrgencias EU LEFT JOIN
			 HClinica..Pacientes P on P.CodPaciente = EU.CodPaciente LEFT JOIN	
			 Parametros..CamasBoxesUrg C On EU.CodPaciente = C.CodPaciente And EU.CodEpisodio = C.CodEpisodio and C.CodCentro = @spvar_CodCentro LEFT JOIN
			 Parametros..CamasIngUrgencia CI On EU.CodPaciente = CI.CodPaciente And EU.CodEpisodio = CI.CodEpisodio and C.CodCentro = @spvar_CodCentro LEFT JOIN 
			 HClinica..ArchivoHistoriasPapel AHP ON AHP.codpaciente = EU.CodPaciente and AHP.CodCentro = @spvar_CodCentro
			 
		WHERE (@spvar_CodHistoria IS NULL OR P.CodHistoria = @spvar_CodHistoria) 
			AND (@spvar_NumTarjSanitaria IS NULL OR P.NumTarjSanitaria = @spvar_NumTarjSanitaria) 
			AND (@spvar_PacNombre IS NULL OR P.PacNombre LIKE '%' + @spvar_PacNombre + '%') 
			AND (@spvar_PacApell1 IS NULL OR P.PacApell1 LIKE '%' + @spvar_PacApell1 + '%') 
			AND (@spvar_PacApell2 IS NULL OR P.PacApell2 LIKE '%' + @spvar_PacApell2 + '%') 
			AND (@spvar_CodHistoriaPapel IS NULL OR AHP.CodHistoriaPapel = @spvar_CodHistoriaPapel) 
			AND (@spvar_CodCentro IS NULL OR  EU.CodigoCentUrg = @spvar_CodCentro)
			AND (EU.FechaUrgencia <= @spvar_FHasta)
			AND (EU.FechaSalida IS NULL OR EU.FechaSalida > @spvar_FHasta)
		
		ORDER BY Apell1, Apell2, Nombre 
	END
END
GO



--dbo.SpIngTriajeAnteriorImpresion.sql

USE [Ingresos];
GO
IF EXISTS 
(
    SELECT * 
        FROM sys.procedures 
        WHERE [object_id] = OBJECT_ID('[dbo].[SpIngTriajeAnteriorImpresion]')
)
BEGIN
    DROP PROCEDURE [dbo].[SpIngTriajeAnteriorImpresion];
END
GO

/********************************************************************
* PROCEDIMIENTO     : SpIngTriajeAnteriorImpresion
* FUNCION           : Obtiene los datos necesarios para la impresión del triaje
* DEVUELVE			: 
* FECHA				: 07/05/2012
* VERSION			: 4.29
* AUTOR				: Alfredo Samper
* MODIFICACION      : 22/11/2012 Fran Cuenca CHC2360 - Normalizar el archivo historia en papel
* MODIFICACION      : 19/12/2012 Alberto Pagán CHC2334 y CHC2490 v4.35 Release 1, devolver el campo Temperatura Rectal
* MODIFICACION      : 19/07/2013 Alberto Pagán CHC3310 v4.40
* MODIFICACION      : 14/09/2016 v4.63r1 - 13314 - SGH - Diferencias en datos de la categorización
* MODIFICACIÓN		: 29/06/2017 - V17.2r1 - 18277 - SGH - Triaje ESI 
********************************************************************/
CREATE PROCEDURE [dbo].[SpIngTriajeAnteriorImpresion]
	 @IdTriaje int
	,@CodCentro char(5)
AS

SELECT 
	 'RUN'				      = HClinica.dbo.fnHClFormatoRUNConDigitoControl(P.NumTarjSanitaria)
	,'Historia'			      = P.CodHistoria
	,'Paciente'			      = RTRIM(P.PacNombre) + ' ' + RTRIM(P.PacApell1) + ' ' + RTRIM(P.PacApell2)
	,'Edad'				      = T.Edad
	,'Domicilio' 		      = RTRIM(P.Direccion) + ' ' + RTRIM(P.DirNum) + ' ' + RTRIM(P.DirBloque) + ' ' + RTRIM(P.DirPorteria) + ' ' + RTRIM(P.DirPlanta) + ' ' + RTRIM(P.DirLetra)
	,'Ciudad'			      = RTRIM(DL.NomPoblacion)
	,'Telefono'			      = COALESCE(P.DirTelf, P.Telf2, P.Telf3, P.TelfFijoUFamiliar, P.Telf2Contacto)
	--CHC2360 - Normalizar el archivo historia en papel
	--,'NHistPapel'		      = AHP.CodHistoriaPapel
	,'NHistPapel'		      = RIGHT('00000000' + LTRIM(RTRIM(AHP.[CodHistoriaPapel])),8)
	--CHC2360 - Fin
	,'Sexo'				      = P.Genero
	,'SexoDesc'			      = CSex.Descripcion
	,'FNacimiento'		      = P.FecNac
	,'CodColectivo'		      = P.CodColectivo
	,'Financiador'		      = MP.Entidad
	,'Prevision'			  = MS.Entidad
	,'FLlegada'			      = EU.FechaEntrada
	,'CausaUrgencia' 	      = T.Observaciones
	,'HoraAtencion'		      = T.FechaAlta
	,'DNIUsuarioTriaje'	      = COALESCE(PM.DNIMedico, DE.DNIEnf, A.DNIAdminist, TE.DNITecnico) --Alberto Pagán - CHC3310 - v4.40 - 19/07/2013
	,'UsuarioTriaje'		  = COALESCE(
									     RTRIM(PM.NomMedico) + ' ' + RTRIM(PM.Apell1) + ' ' + RTRIM(PM.Apell2),
									     RTRIM(DE.NombreEnf) + ' ' + RTRIM(DE.Apell1Enf) + ' ' + RTRIM(DE.Apell2Enf),
									     RTRIM(A.NomAdminis) + ' ' + RTRIM(A.Apell1Administ) + ' ' + RTRIM(A.Apell2Administ),
									     RTRIM(TE.NombreTecnico) + ' ' + RTRIM(TE.Apell1Tecnico) + ' ' + RTRIM(TE.Apell2Tecnico) --Alberto Pagán - CHC3310 - v4.40 - 19/07/2013
										)
	,'Categorizacion'	      = 'C' + CONVERT(VARCHAR, T.Prioridad+1) + ' - ' + PU.DesPrioridad
	,'ServicioSalud'		  = CS.RazonSocial
	--Alberto Pagán - CHC2007 - v4.33 Release 2 - 29/10/2012 - INI
    ,'Peso'				      = COALESCE(VD.PesValDia, HVD.PesValDia)
    ,'FrecuenciaCardiaca'     = COALESCE(CCard.Frecuencia, HCard.Frecuencia)
    ,'FrecuenciaRespiratoria' = COALESCE(CResp.Frecuencia, HResp.Frecuencia)
    ,'TAxilar'			      = COALESCE(CTemp.Temperatura, HTemp.Temperatura)
    --CHC2334 y CHC2490 v4.35 Alberto Pagán Release 1, devolver el campo Temperatura Rectal	
    ,'TRectal'			      = COALESCE(CTemp.TemperaturaRectal, HTemp.TemperaturaRectal)
    --CHC2334 y CHC2490 v4.35 Alberto Pagán Release 1, Fin
    ,'Saturometria'           = COALESCE(CSat.Saturacion, HSat.Saturacion)
    ,'PresionArterialTAD'     = COALESCE(CTension.TAD, HCTension.TAD)
    ,'PresionArterialTAS'     = COALESCE(CTension.TAS, HCTension.TAS)
    --Alberto Pagán - CHC2007 - v4.33 Release 2 - 29/10/2012 - FIN
    ,'Tipo'					  = T.Tipo
	,'ReqIntSalVid'			  = T.ReqIntSalVid
	,'AltoRiesgo'             = T.AltoRiesgo
	,'Recursos'               = T.Recursos
	,'SVAlterados'            = T.SVAlterados
	,'Alterados'              = T.Alterados
	,'AVDI'                   = T.AVDI
	,'Distresado'             = T.Distresado
	,'EVAMenor'               = T.EVAMenor
	,'EVAMayor'               = T.EVAMayor
FROM TriajesAnteriores T
	 INNER JOIN Hclinica..Pacientes P ON T.CodPaciente = P.CodPaciente
	 INNER JOIN EpisodioUrgencias EU ON EU.CodPaciente = P.CodPaciente AND EU.CodEpisodio = T.CodEpisodio
	 INNER JOIN Parametros..Codigos CSex ON CSex.Tabla = 'EstGenero' AND P.Genero = CSex.Codigo
	 LEFT JOIN Parametros..DireccionLocalidad DL ON P.DirCodLocalidad = DL.CodPoblacion
	 --Alberto Pagán - CHC2007 - v4.33 Release 2 - 29/10/2012 - INI
	 --LEFT JOIN Hclinica..ArchivoHistoriasPapel AHP ON P.CodPaciente = AHP.CodPaciente AND EU.CodCentroDestino = AHP.CodCentro
	 LEFT JOIN Hclinica..ArchivoHistoriasPapel AHP ON P.CodPaciente = AHP.CodPaciente AND AHP.CodCentro = @CodCentro
	 --Alberto Pagán - CHC2007 - v4.33 Release 2 - 29/10/2012 - FIN
	 LEFT JOIN Parametros..MutuasSalud MS ON EU.CodColectivo = MS.Codigo
	 LEFT JOIN Parametros..MutuaPrincipal MP ON MS.CodMutua = MP.Codigo
	 LEFT JOIN Parametros..ParametrosMedicos PM ON T.DniUsu = PM.DNIMedico
	 LEFT JOIN Parametros..DatosEnfermeras DE ON T.DniUsu = DE.DNIEnf
 	 LEFT JOIN Parametros..Administrativo A ON T.DniUsu = A.DNIAdminist
 	 LEFT JOIN Parametros..TecnicosDatos TE on T.DniUsu = TE.DNITecnico --Alberto Pagán - CHC3310 - v4.40 - 19/07/2013
	 LEFT JOIN Parametros..PrioridadUrgencia PU ON PU.CodPrioridad  = T.Prioridad and PU.CodCentro = @Codcentro
	 LEFT JOIN Parametros..CentrosSalud CS ON CS.CodCentro = @CodCentro
	 --Alberto Pagán - CHC2007 - v4.33 Release 2 - 29/10/2012 - INI
	 LEFT JOIN Ingresos..ValoresDiarios VD ON VD.CodPaciente = P.CodPaciente AND VD.CodEpisodio = T.CodEpisodio 
			   AND VD.FecValDia = (SELECT MAX(VD2.FecValDia) FROM Ingresos..ValoresDiarios VD2 WHERE VD2.CodPaciente = VD.CodPaciente AND VD2.CodEpisodio = VD.CodEpisodio)
	 LEFT JOIN Historificacion..Ingresos_ValoresDiarios HVD ON HVD.CodPaciente = P.CodPaciente AND HVD.CodEpisodio = T.CodEpisodio 
			   AND HVD.FecValDia = (SELECT MAX(HVD2.FecValDia) FROM Historificacion..Ingresos_ValoresDiarios HVD2 WHERE HVD2.CodPaciente = HVD.CodPaciente AND HVD2.CodEpisodio = HVD.CodEpisodio)
	 LEFT JOIN Hclinica..TArterial CTension ON CTension.CodPaciente = P.CodPaciente AND CTension.CodEpisodio = T.CodEpisodio
			   AND CTension.Fecha = (SELECT MAX(CTension2.Fecha) FROM Hclinica..TArterial CTension2 WHERE CTension2.CodPaciente = CTension.CodPaciente AND CTension2.CodEpisodio = CTension.CodEpisodio)
	 LEFT JOIN Historificacion..HClinica_TArterial HCTension ON HCTension.CodPaciente = P.CodPaciente AND HCTension.CodEpisodio = T.CodEpisodio
			   AND HCTension.Fecha = (SELECT MAX(HCTension2.Fecha) FROM Historificacion..HClinica_TArterial HCTension2 WHERE HCTension2.CodPaciente = HCTension.CodPaciente AND HCTension2.CodEpisodio = HCTension.CodEpisodio)
	 LEFT JOIN Hclinica..ParametrosCardiacos CCard ON CCard.CodPaciente = P.CodPaciente AND CCard.CodEpisodio = T.CodEpisodio
			   AND CCard.FLecturaDatos = (SELECT MAX(CCard2.FLecturaDatos) FROM Hclinica..ParametrosCardiacos CCard2 WHERE CCard2.CodPaciente = CCard.CodPaciente AND CCard2.CodEpisodio = CCard.CodEpisodio)
     LEFT JOIN Historificacion..HClinica_ParametrosCardiacos HCard ON HCard.CodPaciente = P.CodPaciente AND HCard.CodEpisodio = T.CodEpisodio	
	           AND HCard.FLecturaDatos = (SELECT MAX(HCard2.FLecturaDatos) FROM Historificacion..HClinica_ParametrosCardiacos HCard2 WHERE HCard2.CodPaciente = HCard.CodPaciente AND HCard2.CodEpisodio = HCard.CodEpisodio)
 	 LEFT JOIN HClinica..ParametrosRespiratorios CResp ON CResp.CodPaciente = P.CodPaciente AND CResp.CodEpisodio = T.CodEpisodio
	           AND CResp.FLecturaDatos = (SELECT MAX(CResp2.FLecturaDatos) FROM Hclinica..ParametrosRespiratorios CResp2 WHERE CResp2.CodPaciente = CResp.CodPaciente AND CResp2.CodEpisodio = CResp.CodEpisodio)
	 LEFT JOIN Historificacion..HClinica_ParametrosRespiratorios HResp ON HResp.CodPaciente = P.CodPaciente AND HResp.CodEpisodio = T.CodEpisodio
	           AND HResp.FLecturaDatos = (SELECT MAX(HResp2.FLecturaDatos) FROM Historificacion..HClinica_ParametrosRespiratorios HResp2 WHERE HResp2.CodPaciente = HResp.CodPaciente AND HResp2.CodEpisodio = HResp.CodEpisodio)
	 LEFT JOIN Hclinica..ConstanteTemperatura CTemp ON CTemp.CodPaciente = P.CodPaciente AND CTemp.CodEpisodio = T.CodEpisodio
	 --CHC2334 v4.35 Alberto Pagán Release 1, devolver el campo Temperatura Rectal
				--AND CTemp.Fecha = (SELECT MAX(CTemp2.Fecha) FROM Hclinica..ConstanteTemperatura CTemp2 WHERE CTemp2.CodPaciente = CTemp.CodPaciente AND CTemp2.CodEpisodio = CTemp.CodEpisodio)
				AND CTemp.Fecha = (SELECT MAX(CTemp2.Fecha) FROM Hclinica..ConstanteTemperatura CTemp2 WHERE CTemp2.CodPaciente = EU.CodPaciente AND CTemp2.CodEpisodio = EU.CodEpisodio and CTemp2.Temperatura is not null)--ultima temperatura alterial con valor no nulo
	 LEFT JOIN Hclinica..ConstanteTemperatura CTemp3 ON CTemp3.CodPaciente = EU.CodPaciente AND CTemp3.CodEpisodio = EU.CodEpisodio
				AND CTemp3.Fecha = (SELECT MAX(CTemp4.Fecha) FROM Hclinica..ConstanteTemperatura CTemp4 WHERE CTemp4.CodPaciente = EU.CodPaciente AND CTemp4.CodEpisodio = EU.CodEpisodio and CTemp4.TemperaturaRectal is not null)--ultima temperatura rectal con valor no nulo
	 --CHC2334 v4.35 Alberto Pagán Release 1, Fin	 
	 LEFT JOIN Historificacion..HClinica_ConstanteTemperatura HTemp ON HTemp.CodPaciente = P.CodPaciente AND HTemp.CodEpisodio = T.CodEpisodio
	 --CHC2334 v4.35 Alberto Pagán Release 1, devolver el campo Temperatura Rectal
	           --AND HTemp.Fecha = (SELECT MAX(HTemp2.Fecha) FROM Historificacion..HClinica_ConstanteTemperatura HTemp2 WHERE HTemp2.CodPaciente = HTemp.CodPaciente AND HTemp2.CodEpisodio = HTemp.CodEpisodio)
	           AND HTemp.Fecha = (SELECT MAX(HTemp2.Fecha) FROM Historificacion..HClinica_ConstanteTemperatura HTemp2 WHERE HTemp2.CodPaciente = EU.CodPaciente AND HTemp2.CodEpisodio = EU.CodEpisodio and HTemp2.Temperatura is not null)
	 LEFT JOIN Historificacion..HClinica_ConstanteTemperatura HTemp3 ON HTemp3.CodPaciente = P.CodPaciente AND HTemp3.CodEpisodio = T.CodEpisodio
	            AND HTemp3.Fecha = (SELECT MAX(HTemp4.Fecha) FROM Historificacion..HClinica_ConstanteTemperatura HTemp4 WHERE HTemp4.CodPaciente = EU.CodPaciente AND HTemp4.CodEpisodio = EU.CodEpisodio and HTemp4.TemperaturaRectal is not null)
	 --CHC2334 v4.35 Alberto Pagán Release 1, Fin    	           
	 LEFT JOIN Hclinica..Saturacion CSat ON CSat.CodPaciente = P.CodPaciente AND CSat.CodEpisodio = T.CodEpisodio
	           AND CSat.Fecha = (SELECT MAX(CSat2.Fecha) FROM Hclinica..Saturacion CSat2 WHERE CSat2.CodPaciente = CSat.CodPaciente AND CSat2.CodEpisodio = CSat.CodEpisodio)
	 LEFT JOIN Historificacion..HClinica_Saturacion HSat ON HSat.CodPaciente = P.CodPaciente AND HSat.CodEpisodio = T.CodEpisodio
	           AND HSat.Fecha = (SELECT MAX(HSat2.Fecha) FROM Historificacion..HClinica_Saturacion HSat2 WHERE HSat2.CodPaciente = HSat.CodPaciente AND HSat2.CodEpisodio = HSat.CodEpisodio)
	 --Alberto Pagán - CHC2007 - v4.33 Release 2 - 29/10/2012 - FIN

WHERE 
	  T.Id = @IdTriaje
	  	  
GO
GO



--dbo.SpIngTriajeImpresion.sql

USE [Ingresos];
GO
IF EXISTS 
(
    SELECT * 
        FROM sys.procedures 
        WHERE [object_id] = OBJECT_ID('[dbo].[SpIngTriajeImpresion]')
)
BEGIN
    DROP PROCEDURE [dbo].[SpIngTriajeImpresion];
END
GO

/********************************************************************
* PROCEDIMIENTO     : SpIngTriajeImpresion
* FUNCION           : Obtiene los datos necesarios para la impresión del triaje
* DEVUELVE			: 
* FECHA				: 07/05/2012
* VERSION			: 4.29
* AUTOR				: Alfredo Samper
* MODIFICACION      : 22/11/2012 Fran Cuenca CHC2360 - Normalizar el archivo historia en papel
* MODIFICACION      : 19/12/2012 Alberto Pagán CHC2334 y CHC2490 v4.35 Release 1, devolver el campo Temperatura Rectal
* MODIFICACION      : 19/07/2013 Alberto Pagán CHC3310 v4.40
* MODIFICACION      : 14/09/2016 v4.63r1 - 13314 - SGH - Diferencias en datos de la categorización
* MODIFICACIÓN		: 29/06/2017 - V17.2r1 - 18277 - SGH - Triaje ESI 
********************************************************************/

CREATE PROCEDURE [dbo].[SpIngTriajeImpresion]
	 @CodPaciente as char(16)
	,@CodEpisodio as char(5)
	,@CodCentro as char(5)
AS

SELECT 
	 'RUN'				      = HClinica.dbo.fnHClFormatoRUNConDigitoControl(P.NumTarjSanitaria)
	,'Historia'			      = P.CodHistoria
	,'Paciente'			      = RTRIM(P.PacNombre) + ' ' + RTRIM(P.PacApell1) + ' ' + RTRIM(P.PacApell2)
	,'Edad'				      = T.Edad
	,'Domicilio' 		      = RTRIM(P.Direccion) + ' ' + RTRIM(P.DirNum) + ' ' + RTRIM(P.DirBloque) + ' ' + RTRIM(P.DirPorteria) + ' ' + RTRIM(P.DirPlanta) + ' ' + RTRIM(P.DirLetra)
	,'Ciudad'			      = RTRIM(DL.NomPoblacion)
	,'Telefono'			      = COALESCE(P.DirTelf, P.Telf2, P.Telf3, P.TelfFijoUFamiliar, P.Telf2Contacto)
	--CHC2360 - Normalizar el archivo historia en papel
	--,'NHistPapel'		      = AHP.CodHistoriaPapel
	,'NHistPapel'		      = RIGHT('00000000' + LTRIM(RTRIM(AHP.[CodHistoriaPapel])),8)
	--CHC2360 - Fin
	,'Sexo'				      = P.Genero
	,'SexoDesc'			      = CSex.Descripcion
	,'FNacimiento'		      = P.FecNac
	,'CodColectivo'		      = P.CodColectivo
	,'Financiador'		      = MP.Entidad
	,'Prevision'		      = MS.Entidad
	,'FLlegada'			      = EU.FechaEntrada
	,'CausaUrgencia' 	      = EU.CausaUrgencias
	,'HoraAtencion'		      = T.FechaAlta
	,'DNIUsuarioTriaje'	      = COALESCE(PM.DNIMedico, DE.DNIEnf, A.DNIAdminist, TE.DNITecnico) --Alberto Pagán - CHC3310 - v4.40 - 19/07/2013
	,'UsuarioTriaje'	      = COALESCE(
									     RTRIM(PM.NomMedico) + ' ' + RTRIM(PM.Apell1) + ' ' + RTRIM(PM.Apell2),
									     RTRIM(DE.NombreEnf) + ' ' + RTRIM(DE.Apell1Enf) + ' ' + RTRIM(DE.Apell2Enf),
									     RTRIM(A.NomAdminis) + ' ' + RTRIM(A.Apell1Administ) + ' ' + RTRIM(A.Apell2Administ),
									     RTRIM(TE.NombreTecnico) + ' ' + RTRIM(TE.Apell1Tecnico) + ' ' + RTRIM(TE.Apell2Tecnico) --Alberto Pagán - CHC3310 - v4.40 - 19/07/2013
										)
	,'Categorizacion'	      = 'C' + CONVERT(VARCHAR, T.Prioridad+1) + ' - ' + PU.DesPrioridad

	,'ServicioSalud'	      = CS.RazonSocial
	--Alberto Pagán - CHC2007 - v4.33 Release 2 - 29/10/2012 - INI
    ,'Peso'				      = COALESCE(VD.PesValDia, HVD.PesValDia)
    ,'FrecuenciaCardiaca'     = COALESCE(CCard.Frecuencia, HCard.Frecuencia)
    ,'FrecuenciaRespiratoria' = COALESCE(CResp.Frecuencia, HResp.Frecuencia)
    ,'TAxilar'			      = COALESCE(CTemp.Temperatura, HTemp.Temperatura)
    --CHC2334 y CHC2490 v4.35 Release 1 Alberto Pagán, devolver el campo Temperatura Rectal	
    ,'TRectal'			      = COALESCE(CTemp.TemperaturaRectal, HTemp.TemperaturaRectal)
    --CHC2334 y CHC2490 v4.35 Release 1 Alberto Pagán, Fin
    ,'Saturometria'           = COALESCE(CSat.Saturacion, HSat.Saturacion)
    ,'PresionArterialTAD'     = COALESCE(CTension.TAD, HCTension.TAD)
    ,'PresionArterialTAS'     = COALESCE(CTension.TAS, HCTension.TAS)
    --Alberto Pagán - CHC2007 - v4.33 Release 2 - 29/10/2012 - FIN
	,'Tipo'					  = T.Tipo
	,'ReqIntSalVid'			  = T.ReqIntSalVid
	,'AltoRiesgo'             = T.AltoRiesgo
	,'Recursos'               = T.Recursos
	,'SVAlterados'            = T.SVAlterados
	,'Alterados'              = T.Alterados
	,'AVDI'                   = T.AVDI
	,'Distresado'             = T.Distresado
	,'EVAMenor'               = T.EVAMenor
	,'EVAMayor'               = T.EVAMayor
FROM HistoricoTriajes T
	 INNER JOIN Hclinica..Pacientes P ON T.CodPaciente = P.CodPaciente
	 INNER JOIN EpisodioUrgencias EU ON EU.CodPaciente = P.CodPaciente AND EU.CodEpisodio = T.CodEpisodio
	 INNER JOIN Parametros..Codigos CSex ON CSex.Tabla = 'EstGenero' AND P.Genero = CSex.Codigo
	 LEFT JOIN Parametros..DireccionLocalidad DL ON P.DirCodLocalidad = DL.CodPoblacion
	 --Alberto Pagán - CHC2007 - v4.33 Release 2 - 29/10/2012 - INI
	 --LEFT JOIN Hclinica..ArchivoHistoriasPapel AHP ON P.CodPaciente = AHP.CodPaciente AND EU.CodCentroDestino = AHP.CodCentro
	 LEFT JOIN Hclinica..ArchivoHistoriasPapel AHP ON P.CodPaciente = AHP.CodPaciente AND AHP.CodCentro = @CodCentro
	 --Alberto Pagán - CHC2007 - v4.33 Release 2 - 29/10/2012 - FIN
	 LEFT JOIN Parametros..MutuasSalud MS ON EU.CodColectivo = MS.Codigo
	 LEFT JOIN Parametros..MutuaPrincipal MP ON MS.CodMutua = MP.Codigo
	 LEFT JOIN Parametros..ParametrosMedicos PM ON T.DniUsu = PM.DNIMedico
	 LEFT JOIN Parametros..DatosEnfermeras DE ON T.DniUsu = DE.DNIEnf
	 LEFT JOIN Parametros..Administrativo A ON T.DniUsu = A.DNIAdminist
	 LEFT JOIN Parametros..TecnicosDatos TE ON T.DniUsu = TE.DNITecnico --Alberto Pagán - CHC3310 - v4.40 - 19/07/2013
	 
	 LEFT JOIN Parametros..PrioridadUrgencia PU ON PU.CodPrioridad  = T.Prioridad and PU.CodCentro = @Codcentro

	 LEFT JOIN Parametros..CentrosSalud CS ON CS.CodCentro = @CodCentro
	 --Alberto Pagán - CHC2007 - v4.33 Release 2 - 29/10/2012 - INI
	 LEFT JOIN Ingresos..ValoresDiarios VD ON VD.CodPaciente = P.CodPaciente AND VD.CodEpisodio = T.CodEpisodio 
			   AND VD.FecValDia = (SELECT MAX(VD2.FecValDia) FROM Ingresos..ValoresDiarios VD2 WHERE VD2.CodPaciente = VD.CodPaciente AND VD2.CodEpisodio = VD.CodEpisodio)
	 LEFT JOIN Historificacion..Ingresos_ValoresDiarios HVD ON HVD.CodPaciente = P.CodPaciente AND HVD.CodEpisodio = T.CodEpisodio 
			   AND HVD.FecValDia = (SELECT MAX(HVD2.FecValDia) FROM Historificacion..Ingresos_ValoresDiarios HVD2 WHERE HVD2.CodPaciente = HVD.CodPaciente AND HVD2.CodEpisodio = HVD.CodEpisodio)
	 LEFT JOIN Hclinica..TArterial CTension ON CTension.CodPaciente = P.CodPaciente AND CTension.CodEpisodio = T.CodEpisodio
			   AND CTension.Fecha = (SELECT MAX(CTension2.Fecha) FROM Hclinica..TArterial CTension2 WHERE CTension2.CodPaciente = CTension.CodPaciente AND CTension2.CodEpisodio = CTension.CodEpisodio)
	 LEFT JOIN Historificacion..HClinica_TArterial HCTension ON HCTension.CodPaciente = P.CodPaciente AND HCTension.CodEpisodio = T.CodEpisodio
			   AND HCTension.Fecha = (SELECT MAX(HCTension2.Fecha) FROM Historificacion..HClinica_TArterial HCTension2 WHERE HCTension2.CodPaciente = HCTension.CodPaciente AND HCTension2.CodEpisodio = HCTension.CodEpisodio)
	 LEFT JOIN Hclinica..ParametrosCardiacos CCard ON CCard.CodPaciente = P.CodPaciente AND CCard.CodEpisodio = T.CodEpisodio
			   AND CCard.FLecturaDatos = (SELECT MAX(CCard2.FLecturaDatos) FROM Hclinica..ParametrosCardiacos CCard2 WHERE CCard2.CodPaciente = CCard.CodPaciente AND CCard2.CodEpisodio = CCard.CodEpisodio)
     LEFT JOIN Historificacion..HClinica_ParametrosCardiacos HCard ON HCard.CodPaciente = P.CodPaciente AND HCard.CodEpisodio = T.CodEpisodio	
	           AND HCard.FLecturaDatos = (SELECT MAX(HCard2.FLecturaDatos) FROM Historificacion..HClinica_ParametrosCardiacos HCard2 WHERE HCard2.CodPaciente = HCard.CodPaciente AND HCard2.CodEpisodio = HCard.CodEpisodio)
 	 LEFT JOIN HClinica..ParametrosRespiratorios CResp ON CResp.CodPaciente = P.CodPaciente AND CResp.CodEpisodio = T.CodEpisodio
	           AND CResp.FLecturaDatos = (SELECT MAX(CResp2.FLecturaDatos) FROM Hclinica..ParametrosRespiratorios CResp2 WHERE CResp2.CodPaciente = CResp.CodPaciente AND CResp2.CodEpisodio = CResp.CodEpisodio)
	 LEFT JOIN Historificacion..HClinica_ParametrosRespiratorios HResp ON HResp.CodPaciente = P.CodPaciente AND HResp.CodEpisodio = T.CodEpisodio
	           AND HResp.FLecturaDatos = (SELECT MAX(HResp2.FLecturaDatos) FROM Historificacion..HClinica_ParametrosRespiratorios HResp2 WHERE HResp2.CodPaciente = HResp.CodPaciente AND HResp2.CodEpisodio = HResp.CodEpisodio)
	 LEFT JOIN Hclinica..ConstanteTemperatura CTemp ON CTemp.CodPaciente = P.CodPaciente AND CTemp.CodEpisodio = T.CodEpisodio
	 --CHC2334 v4.35 Alberto Pagán Release 1, devolver el campo Temperatura Rectal
				--AND CTemp.Fecha = (SELECT MAX(CTemp2.Fecha) FROM Hclinica..ConstanteTemperatura CTemp2 WHERE CTemp2.CodPaciente = CTemp.CodPaciente AND CTemp2.CodEpisodio = CTemp.CodEpisodio)
				AND CTemp.Fecha = (SELECT MAX(CTemp2.Fecha) FROM Hclinica..ConstanteTemperatura CTemp2 WHERE CTemp2.CodPaciente = EU.CodPaciente AND CTemp2.CodEpisodio = EU.CodEpisodio and CTemp2.Temperatura is not null)--ultima temperatura alterial con valor no nulo
	 LEFT JOIN Hclinica..ConstanteTemperatura CTemp3 ON CTemp3.CodPaciente = EU.CodPaciente AND CTemp3.CodEpisodio = EU.CodEpisodio
				AND CTemp3.Fecha = (SELECT MAX(CTemp4.Fecha) FROM Hclinica..ConstanteTemperatura CTemp4 WHERE CTemp4.CodPaciente = EU.CodPaciente AND CTemp4.CodEpisodio = EU.CodEpisodio and CTemp4.TemperaturaRectal is not null)--ultima temperatura rectal con valor no nulo
	 --CHC2334 v4.35 Alberto Pagán Release 1, Fin	 
	 LEFT JOIN Historificacion..HClinica_ConstanteTemperatura HTemp ON HTemp.CodPaciente = P.CodPaciente AND HTemp.CodEpisodio = T.CodEpisodio
	 --CHC2334 v4.35 Alberto Pagán Release 1, devolver el campo Temperatura Rectal
	           --AND HTemp.Fecha = (SELECT MAX(HTemp2.Fecha) FROM Historificacion..HClinica_ConstanteTemperatura HTemp2 WHERE HTemp2.CodPaciente = HTemp.CodPaciente AND HTemp2.CodEpisodio = HTemp.CodEpisodio)
	           AND HTemp.Fecha = (SELECT MAX(HTemp2.Fecha) FROM Historificacion..HClinica_ConstanteTemperatura HTemp2 WHERE HTemp2.CodPaciente = EU.CodPaciente AND HTemp2.CodEpisodio = EU.CodEpisodio and HTemp2.Temperatura is not null)
	 LEFT JOIN Historificacion..HClinica_ConstanteTemperatura HTemp3 ON HTemp3.CodPaciente = P.CodPaciente AND HTemp3.CodEpisodio = T.CodEpisodio
	            AND HTemp3.Fecha = (SELECT MAX(HTemp4.Fecha) FROM Historificacion..HClinica_ConstanteTemperatura HTemp4 WHERE HTemp4.CodPaciente = EU.CodPaciente AND HTemp4.CodEpisodio = EU.CodEpisodio and HTemp4.TemperaturaRectal is not null)
	 --CHC2334 v4.35 Alberto Pagán Release 1, Fin
	 LEFT JOIN Hclinica..Saturacion CSat ON CSat.CodPaciente = P.CodPaciente AND CSat.CodEpisodio = T.CodEpisodio
	           AND CSat.Fecha = (SELECT MAX(CSat2.Fecha) FROM Hclinica..Saturacion CSat2 WHERE CSat2.CodPaciente = CSat.CodPaciente AND CSat2.CodEpisodio = CSat.CodEpisodio)
	 LEFT JOIN Historificacion..HClinica_Saturacion HSat ON HSat.CodPaciente = P.CodPaciente AND HSat.CodEpisodio = T.CodEpisodio
	           AND HSat.Fecha = (SELECT MAX(HSat2.Fecha) FROM Historificacion..HClinica_Saturacion HSat2 WHERE HSat2.CodPaciente = HSat.CodPaciente AND HSat2.CodEpisodio = HSat.CodEpisodio)
	 --Alberto Pagán - CHC2007 - v4.33 Release 2 - 29/10/2012 - FIN

WHERE 
	  T.CodPaciente = @CodPaciente AND
	  T.CodEpisodio = @CodEpisodio

GO
GO



--dbo.SpIngUControlIngesta.sql

USE [Ingresos]
GO

IF EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[SpIngUControlIngesta]') AND type in (N'P', N'PC'))
	DROP PROCEDURE [dbo].[SpIngUControlIngesta]
GO

SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

/***********************************
PROCEDIMIENTO: SpIngUControlIngesta
FUNCIÓN: Update sobre la tabla ControlIngesta
FECHA: 02/03/2015
VERSION: 1.0
AUTOR: Ana Castillo Torrent
APLICACIÓN ORIGEN: Florence Clínico
ID CREACIÓN: v4.50 - 1403 - ACT/APB - Control Nutrición e Ingesta
MODIFICACIÓN: (16/04/2015) - V4.50r2 - 1403 - APB - Control Nutrición e Ingesta (eliminado @spvar_CodPaciente/@spvar_CodEpisodio y @spvar_FechaControlIngesta)
MODIFICACIÓN: (21/08/2017) - V17.3 - 16489 - APB - Volumen ingerido de Control de Ingesta a Balances
***********************************/

CREATE PROCEDURE [dbo].[SpIngUControlIngesta]
	 @spvar_IdControlIngesta as bigint
	,@spvar_ExtrasVolIngerido as decimal(6,2) = null
	,@spvar_VolIngeridoRegimen as decimal(6,2) = null
	,@spvar_Calorias as decimal(6,2) = null
	,@spvar_Proteinas as decimal(6,2) = null
	,@spvar_HdeC as decimal(6,2) = null
	,@spvar_Lipidos as decimal(6,2) = null
	,@spvar_EnBalance as bit = null
AS

BEGIN
	UPDATE Ingresos..ControlIngesta
	SET ExtrasVolIngerido = ISNULL(@spvar_ExtrasVolIngerido,ExtrasVolIngerido)
       ,VolIngeridoRegimen = ISNULL(@spvar_VolIngeridoRegimen,VolIngeridoRegimen)
       ,Calorias = ISNULL(@spvar_Calorias,Calorias)
       ,Proteinas = ISNULL(@spvar_Proteinas,Proteinas)
       ,HdeC = ISNULL(@spvar_HdeC,HdeC)
       ,Lipidos = ISNULL(@spvar_Lipidos,Lipidos)
       ,EnBalance = ISNULL(@spvar_EnBalance,EnBalance)
    WHERE IdControlIngesta = @spvar_IdControlIngesta
END

GO
GO



--dbo.SpIngUHistoricoTriajes.sql

    USE [Ingresos];
    GO
    IF EXISTS 
    (
        SELECT * 
            FROM sys.procedures 
            WHERE [object_id] = OBJECT_ID('[dbo].[SpIngUHistoricoTriajes]')
    )
    BEGIN
        DROP PROCEDURE [dbo].[SpIngUHistoricoTriajes];
    END
    GO
    

/*********************************************************************
* FUNCION		: Actualiza los datos de los Triajes Anteriores que se corresponden con el parámetro ID 
* DEVUELVE		: 
* FECHA			: 15/05/2012
* VERSION		: 4.29
* AUTOR			: Alfredo Samper
* COMENTARIO	: Se actualiza la tabla HistoricoTriajes
******************************************************************
* MODIFICACIÓN  : 29/06/2017 - V17.2r1 - 18277 - SGH - Triaje ESI 
******************************************************************/

CREATE PROCEDURE [dbo].[SpIngUHistoricoTriajes]
	@IdTriaje int,
	@FechaAlta datetime,
	@Nombre char(15),
	@Apellido1 char(15),
	@Apellido2 char(15)='',
	@Prioridad TinyInt,
	@TUrgencia TinyInt,
	@Observaciones varchar(4000)='',
	@CodTriaje varchar(14),
	@DniUsu char(9),
	@Edad tinyint,
	@Sexo char(1),
	@spvar_Tipo tinyint = NULL,
	@spvar_ReqIntSalVid bit = NULL,
	@spvar_AltoRiesgo bit = NULL,
	@spvar_Recursos tinyint = NULL,
	@spvar_SVAlterados bit = NULL,
	@spvar_Alterados char (73) = NULL,
	@spvar_AVDI tinyint = NULL,
	@spvar_Distresado bit = NULL,
	@spvar_EVAMenor bit = NULL,
	@spvar_EVAMayor bit = NULL
AS

UPDATE HistoricoTriajes
SET				
	FechaAlta		= @FechaAlta,
	Nombre			= @Nombre,
	Apellido1		= @Apellido1,
	Apellido2		= @Apellido2,
	Prioridad		= @Prioridad,
	TUrgencia		= @TUrgencia,
	Observaciones	= @Observaciones,
	CodTriaje		= @CodTriaje,
	DniUsu			= @DniUsu,
	Sexo			= @Sexo,
	Edad			= @Edad,
	Tipo			= @spvar_Tipo,
	ReqIntSalVid	= @spvar_ReqIntSalVid,
	AltoRiesgo		= @spvar_AltoRiesgo,
	Recursos		= @spvar_Recursos,
	SVAlterados		= @spvar_SVAlterados,
	Alterados		= @spvar_Alterados,
	AVDI			= @spvar_AVDI,
	Distresado		= @spvar_Distresado,
	EVAMenor		= @spvar_EVAMenor,
	EVAMayor		= @spvar_EVAMayor
WHERE 
	Id = @IdTriaje
	
DECLARE @CodPaciente AS CHAR(16)
DECLARE @CodEpisodio AS CHAR(5)
DECLARE @fecha_triaje SMALLDATETIME

SELECT 
	@CodPaciente = CodPaciente,
	@CodEpisodio = CodEpisodio
FROM HistoricoTriajes
WHERE Id =  @IdTriaje

-- actualizamos el campo CausaUrgencias y la prioridad de la urgencia del Episodio de urgencias del paciente
if @CodPaciente is not null and @CodEpisodio is not null 
	update ingresos..episodiourgencias
	set causaurgencias = @Observaciones, 
		preferencia = @Prioridad,
		preferenciaini = @Prioridad,
		Area = @TUrgencia 
	where codpaciente = @CodPaciente
			and codepisodio = @CodEpisodio

-- si la fecha de triaje es nula, la actualizamos
select @fecha_triaje = ftriaje 
from ingresos..episodiourgencias
where codpaciente = @CodPaciente
    	and codepisodio = @CodEpisodio 

if @fecha_triaje is null and @CodPaciente is not null and @CodEpisodio is not null 
	update ingresos..episodiourgencias
	set ftriaje = getdate()
	where codpaciente = @CodPaciente
			and codepisodio = @CodEpisodio 
    GO

GO



--dbo.SpIngUInfoPaciente.sql

    USE [Ingresos];
    GO
    IF EXISTS 
    (
        SELECT * 
            FROM sys.procedures 
            WHERE [object_id] = OBJECT_ID('[dbo].[SpIngUInfoPaciente]')
    )
    BEGIN
        DROP PROCEDURE [dbo].[SpIngUInfoPaciente];
    END
    GO
    

-- *****************************************************************
-- FUNCION	: SpIngUInfoPaciente
-- DESCRIPCIÓN	: Actualiza la información del capo InfoPaciente
-- FECHA	: 18/06/2008
-- VERSION	: 1.0
-- AUTOR	: Oscar Vilella Alarcon
-- REVISIONES :
--				16/03/2009 Pablo González. Almacenmos dni del usuario
--				                           que lo modifica 
--				16/04/2009 Luis Merle Actualizamos el campo FInfoPaciente con la fecha del sistema
--*******************************************************************
--MODIFICACION: (03/08/2016) - V4.62r1 - 12915 - SGH - Proteger identidad paciente
--MODIFICACION: (14/06/2017) - v17.3 - 18463 - SGH - Información de Pacientes en Episodio de Hospitalizado (igual a POC)
--*******************************************************************

CREATE PROCEDURE [dbo].[SpIngUInfoPaciente]
	@spvar_CodPaciente Char(16), 
	@spvar_CodEpisodio Varchar(5),
	@spvar_InfoPaciente Varchar(4000),
	@spvar_DniMed char(8) = null,
	@spvar_DniEnf char(8) = null,
	@spvar_FInfoPaciente DateTime = null
AS

if substring(@spvar_CodEpisodio,1,1) = 'U'
begin
	UPDATE EpisodioUrgencias
	SET InfoPaciente = @spvar_InfoPaciente,
		dniInfoPacMed = @spvar_DniMed,
		dniInfoPacEnf = @spvar_DniEnf,
		FInfoPaciente = @spvar_FInfoPaciente
	WHERE CodPaciente = @spvar_CodPaciente
	AND CodEpisodio = @spvar_CodEpisodio
end

if substring(@spvar_CodEpisodio,1,1) = 'H'
begin
	UPDATE EpisodioHospitalizacion
	SET InfoPaciente = @spvar_InfoPaciente,
		dniInfoPacMed = @spvar_DniMed,
		dniInfoPacEnf = @spvar_DniEnf,
		FInfoPaciente = @spvar_FInfoPaciente
	WHERE CodPaciente = @spvar_CodPaciente
	AND CodEpisodio = @spvar_CodEpisodio
end


GO

GO



--dbo.SpParComplejidadCama.sql

USE [Parametros];
GO
IF EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[SpParComplejidadCama]') AND type in (N'P', N'PC'))
	DROP PROCEDURE [dbo].[SpParComplejidadCama]
GO

/****************************************************
PROCEDIMIENTO	: SpParComplejidadCama
FUNCION			: Obtener los tipos de complejidad de la cama
FECHA			: 14/07/2017
VERSION			: 17.3 - 18461
AUTOR			: Marco Polo Ruiz
****************************************************/
CREATE PROCEDURE [dbo].[SpParComplejidadCama]
AS

SELECT Codigo,
       Descripcion,
       PosicionX
FROM Parametros..ComplejidadCama
ORDER BY Descripcion

GO
GO



--dbo.SpParDBloqueoQuirofano.sql

    USE [Parametros];
    GO
    IF EXISTS 
    (
        SELECT * 
            FROM sys.procedures 
            WHERE [object_id] = OBJECT_ID('[dbo].[SpParDBloqueoQuirofano]')
    )
    BEGIN
        DROP PROCEDURE [dbo].[SpParDBloqueoQuirofano];
    END
    GO
    


/*********************************************************************
* FUNCION	:Borra el bloqueo de un quirofano
* DEVUELVE	: 1 ó 0 indicando si se ha borrado o no el bloqueo
* FECHA		: 21/09/2009
* VERSION	: 1.0
* AUTOR		: Jesús Mañogil (Mecemsa)
* MODIF		: MAJL CHC3301 v4.40.2 (05/09/2013) Multicentro Quirofanos
* MODIF		: v17.3 - 16148 - ASM - Bloqueo de pabellón por intervalos de horarios
'*******************************************************************/

CREATE PROCEDURE [dbo].[SpParDBloqueoQuirofano] 
	@spvar_NumQuirofano as char(2),
	@spvar_FechaDesde as smalldatetime,
	@spvar_FechaHasta as smalldatetime	
AS

-- Comprobamos si existe un bloqueo de ese quirófano antes de intentar borrarlo
if exists(select NumQuirofano from parametros..BloqueoQuirofanos 
		  where NumQuirofano = @spvar_NumQuirofano and 
				FechaDesde <= @spvar_FechaHasta and FechaHasta >= @spvar_FechaDesde)

	begin		  
		delete from parametros..BloqueoQuirofanos 
		where NumQuirofano = @spvar_NumQuirofano and
				FechaDesde <= @spvar_FechaHasta and FechaHasta >= @spvar_FechaDesde

		if @@ROWCOUNT = 1
			select 1		  
		else
			select 0		  
	end
else
	select 0		  











    GO

GO



--dbo.SpParDDiagnosticosFrec.sql

    USE [Parametros];
    GO
    IF EXISTS 
    (
        SELECT * 
            FROM sys.procedures 
            WHERE [object_id] = OBJECT_ID('[dbo].[SpParDDiagnosticosFrec]')
    )
    BEGIN
        DROP PROCEDURE [dbo].[SpParDDiagnosticosFrec];
    END
    GO
    


/*********************************************************************
* FUNCION	: Borrado de los diagnosticos frecuentes
* DEVUELVE	: 
* FECHA		: 03/04/2009t
* VERSION	: 1.0
* AUTOR		: Jesús Mañogil (Mecemsa)
--Mod.		* (01/09/2014) - v4.47 - 1176 - RRG - OCIS como frecuentes - REQ 62757
MODIFICACIÓN: v17.2r1 - 18866 - ASM - No se puede eliminar un diagnostico frecuente (No se estaban eliminando los
				diagnósticos frecuentes que no tenían CodDiagnostico)
'*******************************************************************/

create  Procedure [dbo].[SpParDDiagnosticosFrec]
	@spvar_DNI char(8),
	@spvar_CodOfic varchar(7)
	,@spvar_CodDiagnostico varchar(6)='' --(01/09/2014) - v4.47 - 1176 - RRG - OCIS como frecuentes - REQ 62757
AS

delete from MDiagnosticos 
where nif = @spvar_DNI and CodOfic = @spvar_CodOfic
--(01/09/2014) - v4.47 - 1176 - RRG - OCIS como frecuentes - REQ 62757 - INI
  and (RTRIM(CodDiagnostico) = '' or CodDiagnostico = @spvar_CodDiagnostico)
--(01/09/2014) - v4.47 - 1176 - RRG - OCIS como frecuentes - REQ 62757 - FIN

    GO

GO



--dbo.SpParDMantProtocoloPruGuias.sql

 /******************************************************************
* FUNCION			 : SpParDMantProtocolosPruGuias
* DEVUELVE			 :
* FECHA				 : 21/09/2016
* VERSION			 : 1.0
* AUTOR				 : Santiago Gimenez Hernandez
* APLICACIÓN ORIGEN  : Florence Gestion Mantenimiento de protocolos de pruebas para guias clinicas
* MODIFICACIÓN		 : 20/06/2017 - ASM - v17.2r1 - 18428 - Protocolos por centro
********************************************************************/
   
USE [Parametros];
GO
IF EXISTS 
(
		SELECT * 
        FROM sys.procedures 
        WHERE [object_id] = OBJECT_ID('[dbo].[SpParDMantProtocolosPruGuias]')
)
BEGIN
    DROP PROCEDURE [dbo].[SpParDMantProtocolosPruGuias];
END
GO    

CREATE PROCEDURE [dbo].[SpParDMantProtocolosPruGuias]
@spvar_CodigoProtocolo as int,
@spvar_BorradoCompleto as bit,
@spvar_CodCentro as CHAR(5) = NULL
AS

IF @spvar_CodCentro IS NULL
BEGIN
	SELECT @spvar_CodCentro = dbo.fnParHospitalReferencia()
END

--DECLARE @NumeroPruebas as INT 
--Select @NumeroPruebas=COUNT(*) From ProtocolosPruebas where IdProtocolo = @spvar_CodigoProtocolo

DECLARE @IdProtocoloCentro as INTEGER
SELECT @IdProtocoloCentro = (SELECT IdCodigosProtPruebasCentros FROM CodigosProtPruebasCentros WHERE CodigoProtocolo = @spvar_CodigoProtocolo AND CodCentro = @spvar_CodCentro)

--Eliminamos las pruebas asociadas al PROTOCOLO
--If @NumeroPruebas > 0
--	BEGIN

DELETE FROM ProtocolosPruebas
where IdCodigoProtPruebasCentros = @IdProtocoloCentro 

--	END

--Eliminamos el PROTOCOLO
If @spvar_BorradoCompleto = 1
BEGIN

	DELETE CodigosProtPruebasCentros WHERE IdCodigosProtPruebasCentros = @IdProtocoloCentro
	
	IF NOT EXISTS (SELECT * FROM CodigosProtPruebasCentros WHERE CodigoProtocolo = @spvar_CodigoProtocolo)
	BEGIN
		DELETE CodigosProtPruebas Where CodigoProtocolo = @spvar_CodigoProtocolo
	END		
	
END




GO



--dbo.SpParGrupoEtario.sql

USE [Parametros];
GO
IF EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[SpParGrupoEtario]') AND type in (N'P', N'PC'))
	DROP PROCEDURE [dbo].[SpParGrupoEtario]
GO

/****************************************************
PROCEDIMIENTO	: SpParGrupoEtario
FUNCION			: Obtener los tipos de grupo etario
FECHA			: 14/07/2017
VERSION			: 17.3 - 18461
AUTOR			: Marco Polo Ruiz
****************************************************/
CREATE PROCEDURE [dbo].[SpParGrupoEtario]
AS

SELECT Codigo,
       Descripcion,
       Posiciony
FROM Parametros..GrupoEtarioCama
ORDER BY Descripcion

GO
GO



--dbo.SpParIArchivoSecciones.sql

    USE [Parametros];
    GO
    IF EXISTS 
    (
        SELECT * 
            FROM sys.procedures 
            WHERE [object_id] = OBJECT_ID('[dbo].[SpParIArchivoSecciones]')
    )
    BEGIN
        DROP PROCEDURE [dbo].[SpParIArchivoSecciones];
    END
    GO
    
/*********************************************************************
* PROCEDIMIENTO		: SpParIArchivoSecciones
* DEVUELVE			: Inserta una nueva seccion de un servicio de archivo papel.
* FECHA				: 30/04/2010
* VERSION			: 1.0
* AUTOR				: Ramón Jiménez
* APLICACION ORIGEN	: FManArchivoParamSeccion (Archivo Papel)
* MODIFICACIÓN      : v17.3 - 18433 - MMM - Modificación checklist 
*******************************************************************/
CREATE PROCEDURE [dbo].[SpParIArchivoSecciones]
            
            @spvar_CodCentro varchar(5),
            @spvar_CodServicio varchar(5),
            @spvar_Nombre varchar(40),
            @spvar_Tipo int
            
AS

BEGIN

declare @spvar_NuevaSeccion varchar(5)

set @spvar_NuevaSeccion = isnull((select max(cast(CodSeccion as int)) 
								  from parametros.dbo.SeccionesArchivoFisico
								where @spvar_CodCentro=CodCentro 
									  and @spvar_CodServicio=CodServicio) +1
								,1)

INSERT INTO parametros.dbo.SeccionesArchivoFisico
		   (CodSeccion
		   ,CodServicio
		   ,Descripcion
		   ,Eliminada
		   ,FechaCreacion
		   ,TipoSeccion
		   ,CodCentro)
	 VALUES
		   (@spvar_NuevaSeccion
		   ,@spvar_CodServicio
		   ,@spvar_Nombre
		   ,null
		   ,GETDATE()
		   ,@spvar_Tipo
		   ,@spvar_CodCentro)
		   
END


    GO

GO



--dbo.SpParIBloqueoQuirofano.sql

    USE [Parametros];
    GO
    IF EXISTS 
    (
        SELECT * 
            FROM sys.procedures 
            WHERE [object_id] = OBJECT_ID('[dbo].[SpParIBloqueoQuirofano]')
    )
    BEGIN
        DROP PROCEDURE [dbo].[SpParIBloqueoQuirofano];
    END
    GO
    


/*********************************************************************
* FUNCION	: Inserta un bloqueo de quirofano
* DEVUELVE	: 1 ó 0 indicando si se ha realizado correctamente
* FECHA		: 21/09/2009
* VERSION	: 1.0
* AUTOR		: Jesús Mañogil (Mecemsa)
* MODIF		: v17.3 - 16148 - ASM - Bloqueo de pabellón por intervalos de horarios
'*******************************************************************/

CREATE PROCEDURE [dbo].[SpParIBloqueoQuirofano] 
	@spvar_NumQuirofano as char(2),
	@spvar_FechaDesde as smalldatetime,
	@spvar_FechaHasta as smalldatetime,
	@spvar_CodMotivo as int,
	@spvar_DNI as char(9),
	@spvar_Intervalo as BIT = 0
AS

-- Comprobamos no exista un bloqueo de ese quirófano antes de intentar insertar
if not exists(select NumQuirofano from parametros..BloqueoQuirofanos 
		  where NumQuirofano = @spvar_NumQuirofano and 
				FechaDesde = @spvar_FechaDesde and 
				FechaHasta = @spvar_FechaHasta) 
	-- Actualizamos
	begin		  
		insert into parametros..BloqueoQuirofanos (NumQuirofano, FechaDesde, FechaHasta, DNI, CodMotivo, FechaBloqueo, Intervalos)
		values (@spvar_NumQuirofano, @spvar_FechaDesde, @spvar_FechaHasta, @spvar_DNI, @spvar_CodMotivo, GETDATE(), @spvar_intervalo)		
		
		if @@ROWCOUNT = 1
			select 1		  
		else
			select 0		  		
	end
else
	select 0




    GO

GO



--dbo.SpParIMantProtocolosPruGuias.sql

    USE [Parametros];
    GO
    IF EXISTS 
    (
        SELECT * 
            FROM sys.procedures 
            WHERE [object_id] = OBJECT_ID('[dbo].[SpParIMantProtocolosPruGuias]')
    )
    BEGIN
        DROP PROCEDURE [dbo].[SpParIMantProtocolosPruGuias];
    END
    GO
    

/******************************************************************
* FUNCION			 : SpParIMantProtocolosPruGuias
* DEVUELVE			 :
* FECHA				 : 19/11/2008
* VERSION			 : 1.0
* AUTOR				 : Teresa L Fabuel Serrano
* APLICACIÓN ORIGEN  : Florence Gestion Mantenimiento de protocolos de pruebas para guias clinicas
********************************************************************
* MANTENIMIENTO:	RRG - 25412344N - 08/10/2013 - CHC3575 - REQ34681 - V4.40 - HEC Requerimiento GES Normativo
* MANTENIMIENTO:	(26/09/2016) v4.64 - 13035 - SGH - Mejorar protocolo de pruebas
* MANTENIMIENTO:	(11/10/2016) v4.64r1 - 13650 - SGH - Observaciones Mejora en mantenimiento de protocolos de pruebas
* MODIFICACIONES:	20/06/2017 - v17.2r1 - 18428 - ASM - Protocolos por centros.
*/


CREATE PROCEDURE [dbo].[SpParIMantProtocolosPruGuias]
@spvar_CodigoProtocolo as int,
@spvar_DescripcionProtocolo as varchar(60),
@spvar_SolicitaHemoderivados as bit,
@spvar_EpisodioC as bit,
@spvar_EpisodioH as bit,
@spvar_EpisodioU as bit,
@spvar_TipoPrioridad as char(1),
@spvar_Juicio_Clinico as text,
@spvar_SolicitaJuicio as bit,
@spvar_DiaPrevisto as int,
@spvar_FechaPrevista as bit,
@spvar_ImprimeSolicitud as bit,
@spvar_CodSeccion as char(2),
@spvar_CodPrueba as char(21),
@spvar_TipoPrueba as char(1),
@spvar_EsPerfil as bit,
@spvar_TipoCitologia as char(1),
@spvar_CodTopografia as char(6),
@spvar_Borrado as bit = 0,
@spvar_CodCentro AS CHAR(5) = NULL
AS

IF @spvar_CodCentro IS NULL
BEGIN
	SELECT @spvar_CodCentro = dbo.fnParHospitalReferencia()
END

Declare @CodProt as int

If @spvar_CodigoProtocolo = 0
BEGIN
	Insert into CodigosProtPruebas
	(
	DescProtocolo
/*	Borrado, 
	Consultas, 
	Hospitalizacion,
	Urgencias, 
	SolicitaHemoDeriv
*/	)
	Values 
	(
	@spvar_DescripcionProtocolo
/*	@spvar_Borrado,
	@spvar_EpisodioC, 
	@spvar_EpisodioH,
	@spvar_EpisodioU, 
	@spvar_SolicitaHemoderivados
*/	)

	Select @spvar_CodigoProtocolo = max(CodigoProtocolo) From CodigosProtPruebas
	
	INSERT INTO CodigosProtPruebasCentros
	(
		CodigoProtocolo,
		CodCentro,
		Borrado,
		Consultas,
		Hospitalizacion,
		Urgencias, 
		SolicitaHemoderiv
	) VALUES (
		@spvar_CodigoProtocolo,
		@spvar_CodCentro,
		@spvar_Borrado,
		@spvar_EpisodioC, 
		@spvar_EpisodioH,
		@spvar_EpisodioU, 
		@spvar_SolicitaHemoderivados
	)
	Select @spvar_CodigoProtocolo 
END
ELSE
BEGIN
	UPDATE CodigosProtPruebas
	SET 
		DescProtocolo = @spvar_DescripcionProtocolo
/*		Borrado = @spvar_Borrado,
		Consultas=@spvar_EpisodioC, 
		Hospitalizacion=@spvar_EpisodioH,
		Urgencias = @spvar_EpisodioU, 
		SolicitaHemoDeriv=@spvar_SolicitaHemoderivados
*/	WHERE 
		CodigoProtocolo=@spvar_CodigoProtocolo

	UPDATE 
		CodigosProtPruebasCentros
	SET
		Borrado				=	@spvar_Borrado,
		Consultas			=	@spvar_EpisodioC, 
		Hospitalizacion		=	@spvar_EpisodioH,
		Urgencias			=	@spvar_EpisodioU, 
		SolicitaHemoDeriv	=	@spvar_SolicitaHemoderivados
	WHERE
		CodigoProtocolo = @spvar_CodigoProtocolo AND
		CodCentro = @spvar_CodCentro

	Select @spvar_CodigoProtocolo 
END

DECLARE @IdProtocoloCentro AS INTEGER
SELECT @IdProtocoloCentro = (SELECT IdCodigosProtPruebasCentros FROM CodigosProtPruebasCentros WHERE CodigoProtocolo = @spvar_CodigoProtocolo AND CodCentro = @spvar_CodCentro)
		
If NOT EXISTS 
(
	Select top 1 *
	From ProtocolosPruebas
	Where IdProtocolo = @spvar_CodigoProtocolo
	And CodPrueba = @spvar_CodPrueba
	And DiaPrevisto = @spvar_DiaPrevisto
	AND IdCodigoProtPruebasCentros = @IdProtocoloCentro
)	
	BEGIN
		
	-- Es nuevo
		Insert into ProtocolosPruebas 
		(
			IdProtocolo, 
			TipoSolicitud, 
			Juicio_Clinico,
			SolicitaJC,
			DiaPrevisto, 
			FechaPrevista,
			ImprimeSolic, 
			CodSeccion, 
			CodPrueba,
			TipoPrueba, 
			EsPerfil, 
			TipoCitologia,
			CodTopografia,
			EsPruebaGES,
			IdCodigoProtPruebasCentros
		)
		values 
		(
			@spvar_CodigoProtocolo, 
			@spvar_TipoPrioridad, 
			@spvar_Juicio_Clinico,
			@spvar_SolicitaJuicio, 
			@spvar_DiaPrevisto, 
			@spvar_FechaPrevista,
			@spvar_ImprimeSolicitud, 
			@spvar_CodSeccion, 
			@spvar_CodPrueba,
			@spvar_TipoPrueba, 
			@spvar_EsPerfil, 
			@spvar_TipoCitologia,
			@spvar_CodTopografia
			,0,
			@IdProtocoloCentro
		)
		Select @spvar_CodigoProtocolo
	END
ELSE
	BEGIN
		Select '-1'
	END



GO



--dbo.SpParINuevoAdminis.sql

USE [Parametros];
    GO
    IF EXISTS 
    (
        SELECT * 
            FROM sys.procedures 
            WHERE [object_id] = OBJECT_ID('[dbo].[SpParINuevoAdminis]')
    )
    BEGIN
        DROP PROCEDURE [dbo].[SpParINuevoAdminis];
    END
    GO
    
/*********************************************************************
* FUNCION : Inserta un nuevo Administrativo
* DEVUELVE : 
* FECHA	: 29/07/2008
* VERSION : 1.0
* AUTOR	: Joaquín Gras Gómez (Agensys)
* ORIGEN : Gestión de usuario
* FECHA : 18/09/2008
* MODIFICACION: se añade parametro perfil
*				Se añade llamada al procedimiento que inserta los permisos según perfil
*******************************************************************
* AUTOR	: Manuel Mas Asencio
* FECHA : 19/11/2008
* MODIFICACION: Si no es un usuario de sólo lectura 
*				se le añade el servicio '01'
*******************************************************************
* FECHA : 09/12/2008
* AUTOR	: Ramon Jimenez (Mecemsa)
* MODIFICACION: Se añade a la insert los campos 'Foto' y 'Rol'.
**************************************************************************************
* FECHA : 08/01/2010
* AUTOR	: Miguel Ángel Utiel
* MODIFICACION: Cambio en la gestion de los permisos y añadido el nif
**************************************************************************************
* FECHA : 09/02/2010
* AUTOR	: Miguel Ángel Utiel
* MODIFICACION: Añadido el campo OcultaPac
**************************************************************************************
* FECHA : 18/03/2010
* AUTOR	: Miguel Ángel Utiel
* MODIFICACION: Añadido el campo Documentalista
**************************************************************************************
* FECHA : 14/05/2010
* AUTOR	: Luis Merle
* MODIFICACION: Añadido el campo PermisosIndicadores
**************************************************************************************
* MODIFICACION: 29/11/2010 Miguel Ángel Utiel. Se guarde el servicio del administrativo seleccionado desde Florence
**************************************************************************************
* FECHA : 18/02/2011
* AUTOR	: Alejandro Palazon
* MODIFICACION: Añadido el campo ConsultorExterno
**************************************************************************************
* FECHA : 24/02/2011
* AUTOR	: Alejandro Palazon
* MODIFICACION: Añadido el campo CodMutua

**************************************************************************************
-- MODIFICACION : (05/10/2012) Fran Cuenca MAIPU -- CHC-2024 -- V4.33, Registro atenciones profesionales no médicos
* MODIFICACIÓN : 21/05/2013 Alfredo - CHC3064 4.37 - Modifico la fecha de alta para poder pasarla como parámetro.
* MODIFICACIÓN : Alfredo - CHC3064 - 4.38 - 30/05/2013. Ahora se comprobará por centro
* MODIFICACIÓN : Alfredo - CHC3363 - 4.39 - Se inserta en ServiciosMedicos como solución temporal para el multicentro
* MODIFICACIÓN: (01/07/2014) - V4.46 - 997 - ECR - Observaciones FG
* MODIFICACIÓN : 29/09/2016 - v4.65 - 13406 - MMM - Acceso medicante lista blanca Florence
* MODIFICACIÓN : 09/02/2017 - v4.68 - 15136 - DVR - Auditoría de cambio de contraseñas y comunicación al usuario mediante mail 
* MODIFICACIÓN : 29/06/2017 - V17.2r1 - 18277 - SGH - Triaje ESI 
**************************************************************************************/

CREATE PROCEDURE [dbo].[SpParINuevoAdminis]
	@spvar_DNI			char(8),
	@spvar_Llave		varchar(50),
	@spvar_Nombre		char(15),
	@spvar_Apell1		char(15),
	@spvar_Apell2		char(15),
	@spvar_TipoPersona	char(1),
	@spvar_Login		varchar(30),
	@spvar_CodPerfil	char(4),
	@spvar_Nivel		tinyint,
	@spvar_CodCentro	char(5),
	@spvar_Idioma		char(5),
	@spvar_CodPerfilPermisos	int,
	--MAIPU -- CHC-2024 -- V4.33, Registro atenciones profesionales no médicos
	@spvar_Rol varchar(25)=null, -- RJF (09/12/08) 
	@spvar_CodRol char (2)=null,
	--MAIPU -- CHC-2024 -- V4.33, Fin
	@spvar_Foto image=null,	-- RJF (09/12/08)
	@spvar_CodDepart	int = 0,
	@spvar_nif			char(9) = null,
	@spvar_Oculta		bit = 0,
	@spvar_Documentalista	bit = 0,
	@spvar_PermisosIndicadores int = 0,
	@spvar_CodServicioAdminist char(4) = null,
	@spvar_ConsultorExterno bit = 0,
	@spvar_CodMutua char(5)=null
	,@FAlta SMALLDATETIME = NULL --Alfredo CHC3064
	,@spvar_UsuGenerico bit = 0
	,@spvar_Email varchar(100)= null
	,@spvar_TriajeESI bit = 0
	
AS


BEGIN

	declare @spvar_PermiteCrearRayos bit

	if @spvar_CodServicioAdminist is null begin
		if @spvar_CodPerfilPermisos <> '47'
			select @spvar_CodServicioAdminist = '01'
		else
			select @spvar_CodServicioAdminist = null
	end


	if @spvar_CodPerfilPermisos = '49' -- Si es administrativo de rayos, poner el bit en la tabla a 1
		select @spvar_PermiteCrearRayos = 1
	else
		select @spvar_PermiteCrearRayos = 0
--Alfredo - CHC3064 - inicio
IF NOT EXISTS(
	SELECT 
		DNIAdminist
	FROM
		Administrativo
	WHERE
		DNIAdminist = @spvar_DNI
)
BEGIN
--Alfredo - CHC3064 - fin
		-- Insertar en la tabla de administrativos
		INSERT PARAMETROS..Administrativo(
				
			DNIAdminist,
			LlaveAdminist,
			NomAdminis,
			Apell1Administ,
			Apell2Administ,
			TipPersonAdminist,
			FLlaveAdminist,
			UsuarioAdminis, 
			CodPerfAdminist,
			FAltaAdminist,
			NivelAdminist,
			CodCentroAdminist,
			Idioma,
			Perfil,
			PermiteCrearRayos,
			CodServicioAdminist,
			--MAIPU -- CHC-2024 -- V4.33, Registro atenciones profesionales no médicos
			Rol, -- RJF (09/12/08)
			CodRol,
			--MAIPU -- CHC-2024 -- V4.33, Fin
			Foto, -- RJF (09/12/08)
       		CodDepartamento,
       		Nif,
       		CambioClave,
       		OcultaPac,
       		Documentacion,
       		PermisosIndicadores,
       		ConsultorExterno,
       		CodMutua,
			UsuGenerico,
			Email,
			TriajeESI
       	)
		VALUES(

			@spvar_DNI,
			@spvar_Llave,
			@spvar_Nombre,
			@spvar_Apell1,
			@spvar_Apell2,
			@spvar_TipoPersona,
			getdate(),
			@spvar_Login,
			@spvar_CodPerfil,
			ISNULL(@FAlta, getdate()), --Alfredo CHC3064
			@spvar_Nivel,
			@spvar_CodCentro,
			@spvar_Idioma,
			@spvar_CodPerfilPermisos,
			@spvar_PermiteCrearRayos,
			@spvar_CodServicioAdminist,
			--MAIPU -- CHC-2024 -- V4.33, Registro atenciones profesionales no médicos
			@spvar_Rol, -- RJF (09/12/08) 
			@spvar_CodRol,
			--MAIPU -- CHC-2024 -- V4.33, Fin
			@spvar_Foto, -- RJF (09/12/08)
			@spvar_CodDepart,
			@spvar_nif,
			1,
			@spvar_Oculta,
			@spvar_Documentalista ,
			@spvar_PermisosIndicadores,
			@spvar_ConsultorExterno,
			@spvar_CodMutua,
			@spvar_UsuGenerico,
			@spvar_Email,
			@spvar_TriajeESI
		)	
	END
	--Alfredo - CHC3064 - inicio
	IF NOT EXISTS(
		SELECT 
			DNI
		FROM
			UsuariosCentros
		WHERE
			DNI = @spvar_DNI AND
			CodCentro = @spvar_CodCentro
	)
	BEGIN
		INSERT INTO UsuariosCentros
		(
			DNI,
			CodCentro,
			NIF,
			Activo,
			Bloqueado
		) VALUES (
			@spvar_DNI,
			@spvar_CodCentro,
			@spvar_nif,
			1,
			0
		)
	END		
	--Alfredo - CHC3064 fin
	
		--if @@error = 0 	
		--begin
		--	--Insertar los permisos correspondientes al perfil seleccionado
		--	EXEC SpParIPermisosPerfil @spvar_CodPerfilPermisos, @spvar_DNI, @spvar_Login 
		--end
	--Alfredo - CHC3363 - inicio
	-- (01/07/2014) - V4.46 - 997 - ECR - Observaciones FG - INI
	/*
	IF NOT EXISTS(
		SELECT *
		FROM
			ServiciosMedicos
		WHERE
			CodCentro = @spvar_CodCentro AND
			CodServicio = @spvar_CodServicioAdminist AND
			NIFMedico = @spvar_DNI
	)
	BEGIN
		INSERT INTO ServiciosMedicos
		(
			CodCentro,
			CodServicio,
			NIFMedico
		) VALUES (
			@spvar_CodCentro,
			@spvar_CodServicioAdminist,
			@spvar_DNI
		)
	END
	*/
	-- (01/07/2014) - V4.46 - 997 - ECR - Observaciones FG - FIN
	--Alfredo - CHC3363 - fin

END

GO



--dbo.SpParINuevoEnferm.sql

USE [Parametros];
    GO
    IF EXISTS 
    (
        SELECT * 
            FROM sys.procedures 
            WHERE [object_id] = OBJECT_ID('[dbo].[SpParINuevoEnferm]')
    )
    BEGIN
        DROP PROCEDURE [dbo].[SpParINuevoEnferm];
    END
    GO
    
/*********************************************************************
* FUNCION : Inserta un nuevo Enfermero
* DEVUELVE : 
* FECHA	: 29/07/2008
* VERSION : 1.0
* AUTOR	: Joaquín Gras Gómez (Agensys)
* ORIGEN : Gestión de usuario
* FECHA : 18/09/2008
* MODIFICACION: se añade parametro perfil
*				Se añade llamada al procedimiento que inserta los permisos según perfil
*******************************************************************
* FECHA : 09/12/2008
* AUTOR	: Ramon Jimenez (Mecemsa)
* MODIFICACION: Se añade a la insert los campos 'Foto' y 'Rol'.
*******************************************************************
* FECHA : 08/05/2009
* AUTOR	: Curro Rosado (Agensys)
* MODIFICACION: Se añade a la insert el campo Codigo Servicio.
*******************************************************************
* FECHA : 30/07/2009
* AUTOR	: Joaquín Aniorte Mora
* MODIFICACION: Se añade a la insert los campos Codigo ColectivoDue e
*               Incentivos
**************************************************************************************
'* FECHA : 08/01/2010
'* AUTOR	: Miguel Ángel Utiel
'* MODIFICACION: Cambio en la gestion de los permisos
'**************************************************************************************
'* FECHA : 03/02/2010
'* AUTOR	: Miguel Ángel Utiel
'* MODIFICACION: Asignación de Matrona o Fisioterapeuta
'**************************************************************************************
'* FECHA : 09/02/2010
'* AUTOR	: Miguel Ángel Utiel
'* MODIFICACION: Añadido el campo OcultaPac
'**************************************************************************************
* FECHA : 18/03/2010
* AUTOR	: Miguel Ángel Utiel
* MODIFICACION: Añadido el campo Documentalista
**************************************************************************************
* FECHA : 14/05/2010
* AUTOR	: Luis Merle
* MODIFICACION: Añadido el campo PermisosIndicadores
**************************************************************************************
* FECHA : 22/06/2010
* AUTOR	: Paco Aznar
* MODIFICACION: Se añade el campo porcenJornada
**************************************************************************************
* MODIFICACION : (05/10/2012) Fran Cuenca MAIPU -- CHC-2024 -- V4.33, Registro atenciones profesionales no médicos
* MODIFICACIÓN : 21/05/2013 Alfredo - CHC3064 4.37 - Modifico la fecha de alta para poder pasarla como parámetro.
* MODIFICACIÓN : Alfredo - CHC3064 - 4.38 - 30/05/2013. Ahora se comprobará por centro
* MODIFICACIÓN : Alfredo - CHC3363 - 4.39 - Se inserta en ServiciosMedicos como solución temporal para el multicentro
* MODIFICACIÓN: (01/07/2014) - V4.46 - 997 - ECR - Observaciones FG
* MODIFICACIÓN : 14/06/2016 - v4.62 - 3218 - SGN - Registro Confidencial
* MODIFICACIÓN : 29/09/2016 - v4.65 - 13406 - MMM - Acceso medicante lista blanca Florence
* MODIFICACIÓN : 09/02/2017 - v4.68 - 15136 - DVR - Auditoría de cambio de contraseñas y comunicación al usuario mediante mail 
* MODIFICACIÓN : 29/06/2017 - V17.2r1 - 18277 - SGH - Triaje ESI 
**************************************************************************************/

CREATE PROCEDURE [dbo].[SpParINuevoEnferm]
	@spvar_DNI as char(8),
	@spvar_Llave		varchar(50),
	@spvar_Nombre		char(15),
	@spvar_Apell1		char(15),
	@spvar_Apell2		char(15),
	@spvar_DirigEnf		bit,
	@spvar_Login		varchar(30),
	@spvar_CodCentro	char(5),
	@spvar_Nivel		tinyint,
	@spvar_Idioma		char(5),
	@spvar_PermiteCrearProp bit,
	@spvar_CodPerfilPermisos	int,
	--MAIPU -- CHC-2024 -- V4.33, Registro atenciones profesionales no médicos
	@spvar_Rol varchar(25)=null, -- RJF (09/12/08) 
	@spvar_CodRol char (2)=null,
	--MAIPU -- CHC-2024 -- V4.33, Fin
	@spvar_Foto image=null,	-- RJF (09/12/08)
	@spvar_CodServicio varchar(4),
	@spvar_CodColectivoDUE varchar(3) = NULL,
	@spvar_Incentivos bit = NULL,
	@spvar_CodDepart	int = 0,
	@spvar_nif			char(9) = null,
	@spvar_esfisio		bit = 0,
	@spvar_esmatrona	bit = 0,
	@spvar_Oculta		bit = 0,
	@spvar_Documentalista	bit = 0,
	@spvar_PermisosIndicadores int = 0,
	@spvar_PorcenJornada decimal(5,2) = null
	,@FAlta SMALLDATETIME = NULL --Alfredo CHC3064
	,@spvar_RCC tinyint = 0
	,@spvar_UsuGenerico bit = 0
	,@spvar_Email varchar(100)= null
	,@spvar_TriajeESI bit = 0

AS
BEGIN

	DECLARE @spvar_CodPerfil varchar(4)

	SET @spvar_CodPerfil = null

	IF @spvar_CodCentro= parametros.dbo.fnParHospitalReferencia()
	BEGIN
		SET @spvar_CodPerfil = 'per'
	END

--Alfredo - CHC3064 - inicio
IF NOT EXISTS(
	SELECT 
		DniEnf
	FROM
		DatosEnfermeras
	WHERE
		DniEnf = @spvar_DNI
)
BEGIN
--Alfredo - CHC3064 - fin
	--Insertar datos en tabla enfermeras
	INSERT INTO DatosEnfermeras(

		DNIEnf,
        LlaveEnf,
		FechaLlaveEnf,
        NombreEnf,
        Apell1Enf,
        Apell2Enf,
		DirigenteEnf,
		UsuarioEnf,
		CodigoPerfilEnf,
		CodCentroEnf,
		FechaAltaEnf,
		NivelEnf,
		Idioma,
		PermiteCrearPropuesta,
		Perfil,
		Tiporadiologo,
		EsFisio,
		--MAIPU -- CHC-2024 -- V4.33, Registro atenciones profesionales no médicos
		Rol, -- RJF (09/12/08)
		CodRol,
		--MAIPU -- CHC-2024 -- V4.33, Fin
		Foto, -- RJF (09/12/08)
		CodServicio,
		ColectivoDUE,
		IncentivosEnf,
		CodDepartamento,
		Nif,
		CambioClave,
		OcultaPac,
		Documentacion ,
		PermisosIndicadores,
		PorcenJornada,
		RCC,
		UsuGenerico,
		Email,
		TriajeESI
	)
     VALUES(
		@spvar_DNI,
		@spvar_Llave,
		getdate(),
		@spvar_Nombre,
		@spvar_Apell1,
		@spvar_Apell2,
		@spvar_DirigEnf,
		@spvar_Login,
		@spvar_CodPerfil,
		@spvar_Codcentro,
		ISNULL(@FAlta, getdate()), --Alfredo CHC3064
		@spvar_Nivel,
		@spvar_Idioma,
		@spvar_esmatrona,
		@spvar_CodPerfilPermisos,
		'1',
		@spvar_EsFisio,
		--MAIPU -- CHC-2024 -- V4.33, Registro atenciones profesionales no médicos
		@spvar_Rol, -- RJF (09/12/08) 
		@spvar_CodRol,
		--MAIPU -- CHC-2024 -- V4.33, Fin
		@spvar_Foto, -- RJF (09/12/08)
		@spvar_CodServicio,
		@spvar_CodColectivoDue,
		@spvar_Incentivos,
		@spvar_CodDepart,
		@spvar_nif,
		1,
		@spvar_Oculta,
		@spvar_Documentalista,
		@spvar_PermisosIndicadores,
		@spvar_PorcenJornada,
		@spvar_RCC,
		@spvar_UsuGenerico,
		@spvar_Email,
		@spvar_TriajeESI
	)

	IF @spvar_EsMatrona = 1
		BEGIN
			UPDATE DatosEnfermeras 
			SET	   PuedeIngresar = 1, CodigoPerfilEnf = 'E019' 
			WHERE  DNIEnf = @spvar_DNI	
		END
		
	--IF @@error = 0 	
	--BEGIN
	--	--Insertar los permisos correspondientes al perfil seleccionado
	--	EXEC SpParIPermisosPerfil @spvar_CodPerfilPermisos, @spvar_DNI, @spvar_Login 
	--END
	END
	--Alfredo - CHC3064 - inicio
	IF NOT EXISTS(
		SELECT 
			DNI
		FROM
			UsuariosCentros
		WHERE
			DNI = @spvar_DNI AND
			CodCentro = @spvar_CodCentro
	)
	BEGIN
		INSERT INTO UsuariosCentros
		(
			DNI,
			CodCentro,
			NIF,
			Activo,
			Bloqueado
		) VALUES (
			@spvar_DNI,
			@spvar_CodCentro,
			@spvar_nif,
			1,
			0
		)
	END		
	--Alfredo - CHC3064 - fin
	--Alfredo - CHC3363 - inicio
	-- (01/07/2014) - V4.46 - 997 - ECR - Observaciones FG - INI
	/*
	IF NOT EXISTS(
		SELECT *
		FROM
			ServiciosMedicos
		WHERE
			CodCentro = @spvar_CodCentro AND
			CodServicio = @spvar_CodServicio AND
			NIFMedico = @spvar_DNI
	)
	BEGIN
		INSERT INTO ServiciosMedicos
		(
			CodCentro,
			CodServicio,
			NIFMedico
		) VALUES (
			@spvar_CodCentro,
			@spvar_CodServicio,
			@spvar_DNI
		)
	END
	*/
	-- (01/07/2014) - V4.46 - 997 - ECR - Observaciones FG - FIN
	--Alfredo - CHC3363 - fin
END

GO



--dbo.SpParINuevoMedico.sql

USE [Parametros];
    GO
    IF EXISTS 
    (
        SELECT * 
            FROM sys.procedures 
            WHERE [object_id] = OBJECT_ID('[dbo].[SpParINuevoMedico]')
    )
    BEGIN
        DROP PROCEDURE [dbo].[SpParINuevoMedico];
    END
    GO
    /*************************************************************************************
* FUNCION : Inserta un nuevo Medico
* DEVUELVE : 
* FECHA	: 29/07/2008
* VERSION : 1.0
* AUTOR	: Joaquín Gras Gómez (Agensys)
* ORIGEN : Gestión de usuario
* FECHA : 18/09/2008
* MODIFICACION: se añade parametro perfil
**************************************************************************************
*				Se añade llamada al procedimiento que inserta los permisos según perfil
* FECHA : 09/12/2008
* AUTOR	: Ramon Jimenez (Mecemsa)
* MODIFICACION: Se añade a la insert los campos 'Foto' y 'Rol'.
*********************************************************************************************
* AUTOR:	Curro Rosado (Agensys)
* FECHA: 06/05/2009/
* MODIFICACIÓN: Se modifica el Insert, para que inserte el campo ConsultorExterno
*********************************************************************************************
* AUTOR:	Curro Rosado (Agensys)
* FECHA: 12/05/2009/
* MODIFICACIÓN: Se modifica el Insert, para que inserte el campo Clave Medica
*********************************************************************************************
* AUTOR:	Joaquín Aniorte
* FECHA: 30/07/2009/
* MODIFICACIÓN: Se añade el campo Incentivos al conjunto de datos insertado
*******************************************************************
* FECHA : 08/01/2010
* AUTOR	: Miguel Ángel Utiel
* MODIFICACION: Cambio en la gestion de los permisos y añadido el nif
**************************************************************************************
* FECHA : 09/02/2010
* AUTOR	: Miguel Ángel Utiel
* MODIFICACION: Añadido el campo OcultaPac
**************************************************************************************
* FECHA : 18/03/2010
* AUTOR	: Miguel Ángel Utiel
* MODIFICACION: Añadido el campo Documentalista
**************************************************************************************
--* FECHA : 18/03/2010
--* AUTOR	: Miguel Ángel Utiel
--* MODIFICACION: Añadido el AvisoHemo para avisos del modulo de Banco de Sangre
**************************************************************************************
* FECHA : 22/04/2010
* AUTOR	: Joaquín Aniorte Mora
* MODIFICACION: Añadido el campo NumColegMed
**************************************************************************************
* FECHA : 14/05/2010
* AUTOR	: Luis Merle
* MODIFICACION: Añadido el campo PermisosIndicadores
**************************************************************************************
* FECHA : 16/06/2010
* AUTOR	: Paco Aznar
* MODIFICACION: Se inserta si el medico es residente
**************************************************************************************
* MODIFICACION: 27/10/2010 Teresa L Fabuel S. Se actualiza el campo NifCrc
**************************************************************************************
*^FECHA : 18/01/2010
* AUTOR	: Alejandro Palazon
* MODIFICACION: Se inserta la mutua del medico
**************************************************************************************
-- MODIFICACION : (05/10/2012) Fran Cuenca MAIPU -- CHC-2024 -- V4.33, Registro atenciones profesionales no médicos
**************************************************************************************
* MODIFICACIÓN : 21/05/2013 Alfredo - CHC3064 4.37 - Modifico la fecha de alta para poder pasarla como parámetro.
**************************************************************************************
* MODIFICACIÓN : Alfredo - CHC3064 - 4.38 - 30/05/2013. Ahora se comprobará por centro
**************************************************************************************
* MODIFICACIÓN : Alfredo - CHC3363 - 4.39 - Se inserta en ServiciosMedicos como solución temporal para el multicentro
**************************************************************************************
* MODIFICACIÓN : 14/06/2016 - v4.62 - 3218 - SGN - Registro Confidencial
**************************************************************************************
* MODIFICACIÓN : 29/09/2016 - v4.65 - 13406 - MMM - Acceso medicante lista blanca Florence
* MODIFICACIÓN : 09/02/2017 - v4.68 - 15136 - DVR - Auditoría de cambio de contraseñas y comunicación al usuario mediante mail 
* MODIFICACIÓN : 29/06/2017 - V17.2r1 - 18277 - SGH - Triaje ESI 
**************************************************************************************/

CREATE PROCEDURE [dbo].[SpParINuevoMedico]
	@spvar_DNI			as char(8),
	@spvar_Llave		varchar(50),
	@spvar_Nombre		char(15),
	@spvar_Apell1		char(15),
	@spvar_Apell2		char(15),
	@spvar_Login		char(15),
	@spvar_CodServ		char(4),
	@spvar_CodCentro	char(5),
	@spvar_CodPerfil	varchar(4),
	@spvar_EspeciCupo	bit,
	@spvar_Nivel		tinyint,
	@spvar_Idioma1		char(5),
	@spvar_Idioma2		char(5),
	@spvar_CodPerfilPermisos	int,
	--MAIPU -- CHC-2024 -- V4.33, Registro atenciones profesionales no médicos
	@spvar_Rol varchar(25)=null, -- RJF (09/12/08) 
	@spvar_CodRol char (2)=null,
	--MAIPU -- CHC-2024 -- V4.33, Fin
	@spvar_Foto image=null,	-- RJF (09/12/08)
	@spvar_ConsExt bit,
	@spvar_ClaveMed char(7),
	@spvar_Incentivos bit = NULL,
	@spvar_CodDepart	int = 0,
	@spvar_nif			char(9) = null,
	@spvar_Oculta		bit = 0,
	@spvar_Documentalista	bit = 0,
	@spvar_AvisoHemo	bit = 0,
	@spvar_NumColegiado char(12) = NULL,
	@spvar_PermisosIndicadores int = 0,
	@spvar_Residente bit = NULL,
	@spvar_NifCrc char(9) = Null,
	@spvar_CodMutua char(5) = NULL
	,@FAlta SMALLDATETIME = NULL --Alfredo CHC3064
	,@spvar_RCC tinyint = 0
	,@spvar_UsuGenerico bit = 0
	,@spvar_Email varchar(100)= null
	,@spvar_TriajeESI bit = 0
 
AS
BEGIN
--Alfredo - CHC3064 - inicio
IF NOT EXISTS(
	SELECT 
		DniMedico
	FROM
		parametrosMedicos
	WHERE
		DniMedico = @spvar_DNI
)
--Alfredo - CHC3064 - fin
BEGIN
	--Insertar los datos del medico
	INSERT INTO parametrosMedicos(

		DNIMedico,
		LlaveMedico,
        NomMedico,
		Apell1,
        Apell2,
		AliasMedico,
		CodServicioMedico,
		CodCentroMed,
		CodigoPerfilMed,
		EspeciCupoMedico,
		FechaLlaveMed,
		FAltaMedico,
		UsuarioMedico,
		NivelMedico,
		Idioma1,
		Idioma2,
		Perfil,
		--MAIPU -- CHC-2024 -- V4.33, Registro atenciones profesionales no médicos
		Rol, -- RJF (09/12/08)
		CodRol,
		--MAIPU -- CHC-2024 -- V4.33, Fin
		Foto, -- RJF (09/12/08)
		ConsultorExterno,
		ClaveMed,
		IncentivosMed,
		CodDepartamento,
		Nif,
		CambioClave,
		OcultaPac,
		Documentacion,
		AvisoHemo,
		NumColegMed,
		PermisosIndicadores,
		Residente,
		NIFCRC,
		CodMutua,
		RCC,
		UsuGenerico,
		Email,
		TriajeESI
	)
     VALUES(
		
		@spvar_DNI,
		@spvar_Llave,
		@spvar_Nombre,
		@spvar_Apell1,
		@spvar_Apell2,
		substring(@spvar_Login,1,15),
		@spvar_CodServ,
		@spvar_CodCentro,
		@spvar_CodPerfil,
		@spvar_EspeciCupo,
		getdate(),
		ISNULL(@FAlta, getdate()), --Alfredo CHC3064
		@spvar_Login,
		@spvar_Nivel,
		@spvar_Idioma1,
		@spvar_Idioma2,
		@spvar_CodPerfilPermisos,
		--MAIPU -- CHC-2024 -- V4.33, Registro atenciones profesionales no médicos
		@spvar_Rol, -- RJF (09/12/08) 
		@spvar_CodRol,
		--MAIPU -- CHC-2024 -- V4.33, Fin
		@spvar_Foto, -- RJF (09/12/08)
		@spvar_ConsExt,
		@spvar_ClaveMed,
		case @spvar_Incentivos 
			when 1 then 'S'
			else 'N'
		end,
		@spvar_CodDepart,
		@spvar_nif,
		1,
		@spvar_Oculta,
		@spvar_Documentalista,
		@spvar_AvisoHemo,
		@spvar_NumColegiado,
		@spvar_PermisosIndicadores,
		@spvar_Residente,
		isnull(@spvar_NifCrc,@spvar_nif),
		@spvar_CodMutua,
		@spvar_RCC,
		@spvar_UsuGenerico,
		@spvar_Email,
		@spvar_TriajeESI
	)
	END
	--Alfredo - CHC3064 - inicio
	IF NOT EXISTS(
		SELECT 
			DNI
		FROM
			UsuariosCentros
		WHERE
			DNI = @spvar_DNI AND
			CodCentro = @spvar_CodCentro
	)
	BEGIN
		INSERT INTO UsuariosCentros
		(
			DNI,
			CodCentro,
			NIF,
			Activo,
			Bloqueado
		) VALUES (
			@spvar_DNI,
			@spvar_CodCentro,
			@spvar_nif,
			1,
			0
		)
	END		
	--Alfredo - CHC3064 - inicio
	--IF @@error = 0 	
	--BEGIN
	--	--Insertar los permisos correspondientes al perfil seleccionado
	--	EXEC SpParIPermisosPerfil @spvar_CodPerfilPermisos, @spvar_DNI, @spvar_Login 
	--END
	--Alfredo - CHC3363 - inicio
	IF NOT EXISTS(
		SELECT *
		FROM
			ServiciosMedicos
		WHERE
			CodCentro = @spvar_CodCentro AND
			CodServicio = @spvar_CodServ AND
			NIFMedico = @spvar_DNI
	)
	BEGIN
		INSERT INTO ServiciosMedicos
		(
			CodCentro,
			CodServicio,
			NIFMedico
		) VALUES (
			@spvar_CodCentro,
			@spvar_CodServ,
			@spvar_DNI
		)
	END
	--Alfredo - CHC3363 - fin
END
GO



--dbo.SpParINuevoTecnico.sql

   USE [Parametros];
    GO
    IF EXISTS 
    (
        SELECT * 
            FROM sys.procedures 
            WHERE [object_id] = OBJECT_ID('[dbo].[SpParINuevoTecnico]')
    )
    BEGIN
        DROP PROCEDURE [dbo].[SpParINuevoTecnico];
    END
    GO
    /*********************************************************************
* FUNCION : Inserta un nuevo Tecnico
* DEVUELVE : 
* FECHA	: 29/07/2008
* VERSION : 1.0
* AUTOR	: Joaquín Gras Gómez (Agensys)
* ORIGEN : Gestión de usuario
* MODIFICACION: se añade parametro perfil
*				Se añade llamada al procedimiento que inserta los permisos según perfil
*******************************************************************
* FECHA : 09/12/2008
* AUTOR	: Ramon Jimenez (Mecemsa)
* MODIFICACION: Se añade a la insert los campos 'Foto' y 'Rol'.
*******************************************************************
* FECHA : 30/07/2009
* AUTOR	: Joaquín Aniorte
* MODIFICACION: Se añade a la insert los campos del código del colectivo técnico,
*				y los de incentivos tecnicos y de enfermeria
*******************************************************************
* FECHA : 08/01/2010
* AUTOR	: Miguel Ángel Utiel
* MODIFICACION: Cambio en la gestion de los permisos y añadido el nif
**************************************************************************************
* FECHA : 09/02/2010
* AUTOR	: Miguel Ángel Utiel
* MODIFICACION: Añadido el campo OcultaPac
**************************************************************************************
* FECHA : 14/05/2010
* AUTOR	: Luis Merle
* MODIFICACION: Añadido el campo PermisosIndicadores
**************************************************************************************
* FECHA : 06/04/2011. Teresa L Fabuel. Por defecto se pone campo TipoRadiologo a 1. Se arregla error en el caso que la tabla esté vacia. Y se graba el servicio.
-- MODIFICACION : (05/10/2012) Fran Cuenca MAIPU -- CHC-2024 -- V4.33, Registro atenciones profesionales no médicos
* MODIFICACIÓN : 21/05/2013 Alfredo - CHC3064 4.37 - Modifico la fecha de alta para poder pasarla como parámetro.
* MODIFICACIÓN : Alfredo - CHC3064 - 4.38 - 30/05/2013. Ahora se comprobará por centro
* MODIFICACIÓN : Alfredo - CHC3363 - 4.39 - Se inserta en ServiciosMedicos como solución temporal para el multicentro
* MODIFICACIÓN: (01/07/2014) - V4.46 - 997 - ECR - Observaciones FG
* MODIFICACIÓN : 29/09/2016 - v4.65 - 13406 - MMM - Acceso medicante lista blanca Florence
* MODIFICACIÓN : 09/02/2017 - v4.68 - 15136 - DVR - Auditoría de cambio de contraseñas y comunicación al usuario mediante mail 
* MODIFICACIÓN : 29/06/2017 - V17.2r1 - 18277 - SGH - Triaje ESI 
**************************************************************************************/

CREATE PROCEDURE [dbo].[SpParINuevoTecnico]
	@spvar_DNI as char(8),
	@spvar_Llave	varchar(50),
	@spvar_Nombre	char(15),
	@spvar_Apell1	char(15),
	@spvar_Apell2	char(15),
	@spvar_Login	varchar(30),
	@spvar_CodServicio	char(4),
	@spvar_CodCentroTecnico	char(5),
	@spvar_NivelTecnico	tinyint,
	@spvar_Idioma	char(5),
	@spvar_CodPerfilPermisos	int,
	--MAIPU -- CHC-2024 -- V4.33, Registro atenciones profesionales no médicos
	@spvar_Rol varchar(25)=null, -- RJF (09/12/08) 
	@spvar_CodRol char (2)=null,
	--MAIPU -- CHC-2024 -- V4.33, Fin
	@spvar_Foto image=null,	-- RJF (09/12/08)	
	@spvar_CodColectivoTec varchar(3) = null,
	@spvar_IncentivosEnf bit = NULL,
	@spvar_IncentivosTec bit = NULL,
	@spvar_CodDepart	int = 0,
	@spvar_nif			char(9) = null,
	@spvar_Oculta		bit,
	@spvar_PermisosIndicadores int = 0
	,@FAlta SMALLDATETIME = NULL --Alfredo CHC3064
	,@spvar_UsuGenerico bit = 0
	,@spvar_Email varchar(100)= null
	,@spvar_TriajeESI bit = 0

AS
BEGIN
	DECLARE @spvar_orden int
	
	SELECT @spvar_orden= max(isnull(orden,0))
		FROM tecnicosDatos

	IF @spvar_orden is Null
		Select @spvar_orden = 0
--Alfredo - CHC3064 - inicio
IF NOT EXISTS(
	SELECT 
		DNITecnico
	FROM
		TecnicosDatos
	WHERE
		DNITecnico = @spvar_DNI
)
BEGIN
--Alfredo - CHC3064 - fin
	--insertar en tabla de tecnicos
	INSERT INTO TecnicosDatos(
		DNITecnico,
		LlaveTecnico,
		NombreTecnico,
        Apell1Tecnico,
        Apell2Tecnico,
		UsuarioTecnico,
		CodSeccionTecnico,
		CodCentroTecnico,
		FechaLlaveTecn,
		FAltaTecnico,
		NivelTecnico,
		Idioma,
		Orden,
		Perfil,
		--MAIPU -- CHC-2024 -- V4.33, Registro atenciones profesionales no médicos
		Rol, -- RJF (09/12/08)
		CodRol,
		--MAIPU -- CHC-2024 -- V4.33, Fin
		Foto, -- RJF (09/12/08)
		ColectivoTEC,
		IncentivosEnf,
		IncentivosTec,
		CodDepartamento,
		Nif,
		CambioClave,
		OcultaPac ,
		PermisosIndicadores,
		tiporadiologo,
		CodServicioTecnico,
		UsuGenerico,
		Email,
		TriajeESI
	)
     VALUES(

		@spvar_DNI,
		@spvar_Llave,
		@spvar_Nombre,
		@spvar_Apell1,
		@spvar_Apell2,
		@spvar_Login,
		@spvar_CodServicio,
		@spvar_CodCentroTecnico,
		getdate(),
		ISNULL(@FAlta, getdate()), --Alfredo CHC3064
		@spvar_NivelTecnico,
		@spvar_Idioma,
		@spvar_Orden,
		@spvar_CodPerfilPermisos,
		--MAIPU -- CHC-2024 -- V4.33, Registro atenciones profesionales no médicos
		@spvar_Rol, -- RJF (09/12/08) 
		@spvar_CodRol,
		--MAIPU -- CHC-2024 -- V4.33, Fin
		@spvar_Foto, -- RJF (09/12/08)
		@spvar_CodColectivoTec,
		@spvar_IncentivosEnf,
		@spvar_IncentivosTec,
		@spvar_CodDepart,
		@spvar_nif,
		1,
		@spvar_Oculta,
		@spvar_PermisosIndicadores,
		'1',
		@spvar_CodServicio,
		@spvar_UsuGenerico,
		@spvar_Email,
		@spvar_TriajeESI
	)
	END
	--Alfredo - CHC3064 - inicio
	IF NOT EXISTS(
		SELECT 
			DNI
		FROM
			UsuariosCentros
		WHERE
			DNI = @spvar_DNI AND
			CodCentro = @spvar_CodCentroTecnico
	)
	BEGIN
		INSERT INTO UsuariosCentros
		(
			DNI,
			CodCentro,
			NIF,
			Activo,
			Bloqueado
		) VALUES (
			@spvar_DNI,
			@spvar_CodCentroTecnico,
			@spvar_nif,
			1,
			0
		)
	END		
	--Alfredo - CHC3064 - fin
	--IF @@error = 0 	
	--BEGIN
	--	--Insertar los permisos correspondientes al perfil seleccionado
	--	EXEC SpParIPermisosPerfil @spvar_CodPerfilPermisos, @spvar_DNI, @spvar_Login 
	--END
	--Alfredo - CHC3363 - inicio
	-- (01/07/2014) - V4.46 - 997 - ECR - Observaciones FG - INI
	/*
	IF NOT EXISTS(
		SELECT *
		FROM
			ServiciosMedicos
		WHERE
			CodCentro = @spvar_CodCentroTecnico AND
			CodServicio = @spvar_CodServicio AND
			NIFMedico = @spvar_DNI
	)
	BEGIN
		INSERT INTO ServiciosMedicos
		(
			CodCentro,
			CodServicio,
			NIFMedico
		) VALUES (
			@spvar_CodCentroTecnico,
			@spvar_CodServicio,
			@spvar_DNI
		)
	END
	*/
	-- (01/07/2014) - V4.46 - 997 - ECR - Observaciones FG - FIN
	--Alfredo - CHC3363 - fin

END
GO



--dbo.SpParSBloqueoQuirofano.sql

USE [Parametros];
GO
IF EXISTS 
(
    SELECT * 
        FROM sys.procedures 
        WHERE [object_id] = OBJECT_ID('[dbo].[SpParSBloqueoQuirofano]')
)
BEGIN
    DROP PROCEDURE [dbo].[SpParSBloqueoQuirofano];
END
GO
    
/*********************************************************************
* FUNCION	: Obtiene los datos de la tabla BloqueoQuirofanos y MotivoBloqueoQuirofano
* DEVUELVE	: 
* FECHA		: 21/09/2009
* VERSION	: 1.0
* AUTOR		: Jesús Mañogil (Mecemsa)
* MODIF		: MAJL CHC2867 v4.38.2 Bloqueo Quirofanos (04/04/2013)
* MODIF		: MAJL CHC3301 v4.40.2 Multicentro Quirofanos (29/08/2013)
* MODIF		: v17.3 - 16148 - ASM - Bloqueo de pabellón por intervalos de horarios
'*******************************************************************/

CREATE PROCEDURE [dbo].[SpParSBloqueoQuirofano]
	 @spvar_NumQuirofano as char(2) = null
	,@spvar_FechaDesde as smalldatetime = null
	,@spvar_FechaHasta as smalldatetime = null
	,@spvar_CodMotivo as integer = null
	,@spvar_CodCentro as char(5) = null
AS

SELECT blo.NumQuirofano
	  ,blo.FechaDesde
	  ,blo.FechaHasta
	  ,blo.CodMotivo
	  ,mot.Descripcion as DescMotivo
	  ,blo.DNI
	  ,blo.FechaBloqueo
	  ,qui.Descripcion as DescQuirofano
	  ,CAST(blo.FechaDesde as Date) as FechaDesdeDia
	  ,CAST(blo.FechaHasta as Date) as FechaHastaDia
	  ,blo.FechaDesde AS FechaHoraDesde
	  ,blo.FechaHasta AS FechaHoraHasta
	  ,blo.Intervalos

FROM Parametros..BloqueoQuirofanos blo
	 left join Parametros..MotivoBloqueoQuirofano mot on mot.CodMotivo = blo.CodMotivo
	 left join Parametros..CodQuirofanos qui on qui.NumQuirofano = blo.NumQuirofano

WHERE blo.Intervalos = 1 and
	 (@spvar_NumQuirofano is null or blo.NumQuirofano = @spvar_NumQuirofano) and
	 (@spvar_FechaDesde is null or (blo.FechaDesde <= @spvar_FechaHasta and blo.FechaHasta >= @spvar_FechaDesde)) and
	 (@spvar_CodMotivo is null or blo.CodMotivo = @spvar_CodMotivo) and
	 (@spvar_codCentro is null or qui.CodCentro = @spvar_CodCentro)

UNION

SELECT blo.NumQuirofano
	  ,blo.FechaDesde
	  ,blo.FechaHasta
	  ,blo.CodMotivo
	  ,mot.Descripcion as DescMotivo
	  ,blo.DNI
	  ,blo.FechaBloqueo
	  ,qui.Descripcion as DescQuirofano
	  ,CAST(blo.FechaDesde as Date) as FechaDesdeDia
	  ,CAST(blo.FechaHasta as Date) as FechaHastaDia
	  ,blo.FechaDesde AS FechaHoraDesde
	  ,blo.FechaHasta AS FechaHoraHasta
	  ,blo.Intervalos

FROM Parametros..BloqueoQuirofanos blo
	 left join Parametros..MotivoBloqueoQuirofano mot on mot.CodMotivo = blo.CodMotivo
	 left join Parametros..CodQuirofanos qui on qui.NumQuirofano = blo.NumQuirofano

WHERE blo.Intervalos = 0 and
	 (@spvar_NumQuirofano is null or blo.NumQuirofano = @spvar_NumQuirofano) and
	 (@spvar_FechaDesde is null or (cast(blo.FechaDesde as date) <= @spvar_FechaHasta and cast(blo.FechaHasta as date) >= @spvar_FechaDesde)) and
	 (@spvar_CodMotivo is null or blo.CodMotivo = @spvar_CodMotivo) and
	 (@spvar_codCentro is null or qui.CodCentro = @spvar_CodCentro)
	
GO
GO



--dbo.SpParSBuscaPersonal.sql

USE [Parametros]
GO
/****** Object:  StoredProcedure [dbo].[SpParSBuscaPersonal]    Script Date: 05/30/2013 11:52:07 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
    
/*********************************************************************
* FUNCION : Nos busca el personal con un determinado DNI
* DEVUELVE : 
* FECHA	: 26/01/2010
* VERSION : 1.0
* AUTOR	: Miguel Ángel Utiel (Agensys)
* ORIGEN : Buscar Usuario
* MODIFICACION: 18/03/2010 (Miguel Ángel Utiel)
				Añadido Documentalista
* MODIFICACION: 22/04/2010 (Joaquín Aniorte)
				Añadido NumColegMed
* MODIFICACION:	29/04/2010 (Teresa L Fabuel). Añado parametro @spvar_login
* MODIFICACION: 18/01/2011 (Alejandro Palazón García). Devuelve CodMutua 
* MODIFICACION: 18/02/2011 (Alejandro Palazón García). Devuelve si el Administrativo es C. Externo 
* MODIFICACION: 24/02/2011 (Alejandro Palazón García). Devuelve  el CodMutua de Administrativo
**************************************************************************************
-- MODIFICACION : (05/10/2012) Fran Cuenca MAIPU -- CHC-2024 -- V4.33, Registro atenciones profesionales no médicos
				  (27/12/2012) Juan Manuel Cobaleda CHC 2484 -- V4.34, Error al extraer informe de todas las consultas JCT 
-- Modificación : 02/05/2013 Alfredo - CHC2983 - V4.38 - Añado los campos inactivo y bloqueado
-- Modificación : 30/05/2013 Alfredo - CHC3064 - V4.38 - se modifica el origen de activo y bloqueado
-- MODIFICACIÓN : 14/06/2016 - v4.62 - 3218 - SGN - Registro Confidencial
-- MODIFICACIÓN : 31/10/2017 - v4.68 - 15135 - LMF - Se añade el campo BloqueadoFL
-- MODIFICACIÓN : 09/02/2017 - v4.68 - 15136 - DVR - Auditoría de cambio de contraseñas y comunicación al usuario mediante mail 
-- MODIFICACIÓN : 29/06/2017 - V17.2r1 - 18277 - SGH - Triaje ESI
**************************************************************************************/

ALTER PROCEDURE [dbo].[SpParSBuscaPersonal]
	@spvar_documento		varchar(8),
	@spvar_login			varchar(30) = null
	,@CodCentro CHAR(5) = NULL --Alfredo - CHC3064
AS

declare @Uno as bit
declare @Cero as bit
set @Uno = 1
set @Cero = 0

SELECT	A.NomAdminis as NomUsuario,
		A.Apell1Administ as Apell1Usuario,
		A.Apell2Administ as Apell2Usuario,
		A.CodServicioAdminist	as CodServicioUsuario,
		A.DNIAdminist as DNIUsuario,
		upper(LTrim(RTrim(A.NomAdminis)) + ' ' + RTrim(LTrim(A.Apell1Administ)) + ' ' + Rtrim(LTrim(A.Apell2Administ))) as NombreCompleto,
		A.CodCentroAdminist as CodCentroUsuario,
		'a' as Tipo,
		A.UsuarioAdminis as LoginUsuario,
		A.FAltaAdminist as FechaAlta,
		A.FBajaAdminist as FechaBaja,
		A.TipPersonAdminist as TipoPerson,
		A.PermiteCrearRayos as PermiteCrearRayos,
		A.Idioma as Idioma,
		S.DescServicio as DescServicio,
		CS.DescCentro as DescCentro,
		isnull(A.Perfil,'-1') as CodPerfil,
		A.LlaveAdminist as Llave,
		--MAIPU -- CHC-2024 -- V4.33, Registro atenciones profesionales no médicos
		-- CHC 2484 -- V4.34, Error al extraer informe de todas las consultas JCT 448702384K INI
		--A.Rol, -- RJF (10/12/08)
		C.Descripcion as Rol,
		-- CHC 2484 -- V4.34, Error al extraer informe de todas las consultas JCT 448702384K FIN
		A.CodRol as CodRol,
		--MAIPU -- CHC-2024 -- V4.33, Fin	
		@Cero as TieneIncentivo,
		'' as Colectivo,
		'' as CodColectivo,
		A.CodDepartamento as CodDepart,
		A.Nif as NIF,
		A.Documentacion as Documentalista,
		A.ConsultorExterno,
		A.CodMutua
		--Alfredo - CHC3064 - inicio
		,UC.Bloqueado
		,UC.Activo
		--Alfredo - CHC3064 - fin
		,NULL as RCC
		,ISNULL(Bloqueo.Bloqueado,0) AS BloqueadoFL
		,A.Email
		,A.TriajeESI
FROM	PARAMETROS..Administrativo A
	--Alfredo - CHC3064 - inicio
	INNER JOIN
		UsuariosCentros UC ON
			A.DNIAdminist = UC.DNI AND
			UC.CodCentro = ISNULL(@CodCentro, A.CodCentroAdminist)
	--Alfredo - CHC3064 - inicio
		left join PARAMETROS..Servicios S
			on A.CodServicioAdminist = S.Codigo
		left join PARAMETROS..CentrosSalud CS
			on A.CodCentroAdminist = CS.CodCentro
		--MAIPU -- CHC-2024 -- V4.33, Registro atenciones profesionales no médicos
		left join Parametros..Codigos C
			on C.Codigo	=A.CodRol And C.Tabla='ROLUSUARIO'
		--MAIPU -- CHC-2024 -- V4.33, Fin
		left join Parametros..UsuariosBloqueo Bloqueo
				on Bloqueo.DNI = A.DNIAdminist
				
where A.DNIAdminist = @spvar_documento
And (@spvar_login is null or A.UsuarioAdminis = @spvar_login)

SELECT	T.Nombretecnico	as NomUsuario,
		T.Apell1Tecnico	as Apell1Usuario,
		T.Apell2Tecnico	as Apell2Usuario,
		T.CodSeccionTecnico 	as CodServicioUsuario,
		T.DNITecnico		as DNIUsuario,
		upper(LTrim(RTrim(T.Nombretecnico)) + ' ' + RTrim(LTrim(T.Apell1Tecnico)) + ' ' + Rtrim(LTrim(T.Apell2Tecnico))) as NombreCompleto,
		T.CodCentroTecnico as CodCentroUsuario,
		't' as Tipo,
		T.UsuarioTecnico as LoginUsuario,
		T.FAltaTecnico as FechaAlta,
		T.FBajaTecnico as FechaBaja,
		T.Orden as Orden,
		T.Idioma as Idioma,
		S.DescServicio as DescServicio,
		CS.DescCentro as DescCentro,
		isnull(T.Perfil,'-1') as CodPerfil,
		T.LlaveTecnico as Llave,
		--MAIPU -- CHC-2024 -- V4.33, Registro atenciones profesionales no médicos
		-- CHC 2484 -- V4.34, Error al extraer informe de todas las consultas JCT 448702384K INI
		--T.Rol, -- RJF (10/12/08)
		C.Descripcion as Rol,
		-- CHC 2484 -- V4.34, Error al extraer informe de todas las consultas JCT 448702384K FIN
		T.CodRol as CodRol,
		--MAIPU -- CHC-2024 -- V4.33, Fin			
		isnull(T.IncentivosEnf,0) | isnull(T.IncentivosTec, 0) as TieneIncentivo,
		CT.Descripcion as Colectivo,
		T.ColectivoTEC as CodColectivo,
		T.CodDepartamento as CodDepart,
		T.Nif as NIF,
		@Cero as Documentalista
		--Alfredo - CHC3064 - inicio
		,UC.Bloqueado
		,UC.Activo
		--Alfredo - CHC3064 - fin
		,NULL as RCC
		,ISNULL(Bloqueo.Bloqueado,0) AS BloqueadoFL
		,T.Email
		,T.TriajeESI
FROM	PARAMETROS..TecnicosDatos T
		--Alfredo - CHC3064 - inicio
		INNER JOIN
			UsuariosCentros UC ON
				T.DNITecnico = UC.DNI AND
				UC.CodCentro = ISNULL(@CodCentro, T.CodCentroTecnico)
		--Alfredo - CHC3064 - inicio
		left join PARAMETROS..Servicios S
			on T.CodServicioTecnico= S.Codigo
		left join PARAMETROS..CentrosSalud CS
			on T.CodCentroTecnico = CS.CodCentro
		left join Parametros..ColectivoTec CT
			on T.ColectivoTEC = CT.ColectivoTEC
		--MAIPU -- CHC-2024 -- V4.33, Registro atenciones profesionales no médicos
		left join Parametros..Codigos C
			on C.Codigo	=T.CodRol And C.Tabla='ROLUSUARIO'
		--MAIPU -- CHC-2024 -- V4.33, Fin
		left join Parametros..UsuariosBloqueo Bloqueo
				on Bloqueo.DNI = T.DNITecnico
where T.DNITecnico = @spvar_documento
And (@spvar_login is null or T.UsuarioTecnico = @spvar_login)


SELECT	M.NomMedico	as NomUsuario,
		M.Apell1		as Apell1Usuario,
		M.Apell2		as Apell2Usuario,
		M.CodServicioMedico	as CodServicioUsuario,
		M.DNIMedico			as DNIUsuario,
		upper(LTrim(RTrim(M.NomMedico)) + ' ' + RTrim(LTrim(M.Apell1)) + ' ' + Rtrim(LTrim(M.Apell2))) as NombreCompleto,
		M.CodCentroMed as CodCentroUsuario,
		'm' as Tipo,
		M.UsuarioMedico as LoginUsuario,
		M.FAltaMedico as FechaAlta,
		M.FBajaMedico as FechaBaja,
		M.CodServicioMedico as CodServicio,
		M.EspeciCupoMedico as EspeciCupo,
		M.ImprimeInforme as ImprimeInforme,
		M.Idioma1 as Idioma,
		S.DescServicio as DescServicio,
		CS.DescCentro as DescCentro,
		M.Idioma2 as Idioma2,
		isnull(M.Perfil,'-1') as CodPerfil,
		M.LlaveMedico as Llave,
		--MAIPU -- CHC-2024 -- V4.33, Registro atenciones profesionales no médicos
		-- CHC 2484 -- V4.34, Error al extraer informe de todas las consultas JCT 448702384K INI
		--M.Rol, -- RJF (10/12/08)
		C.Descripcion as Rol,
		-- CHC 2484 -- V4.34, Error al extraer informe de todas las consultas JCT 448702384K FIN
		M.CodRol as CodRol,
		--MAIPU -- CHC-2024 -- V4.33, Fin	
		case M.IncentivosMed 
			when 's' then @Uno
			when 'S' then @Uno
			else @Cero
		end as TieneIncentivo,
		'' as Colectivo,
		'' as CodColectivo,
		M.ConsultorExterno,
		M.ClaveMed,
		M.CodDepartamento as CodDepart,
		M.Nif as NIF,
		M.Documentacion as Documentalista,
		--M.AvisoHemo as AvisoHemo,
		M.NumColegMed,
		M.CodMutua
		--Alfredo - CHC3064 - inicio
		,UC.Bloqueado
		,UC.Activo
		--Alfredo - CHC3064 - fin
		,M.RCC
		,ISNULL(Bloqueo.Bloqueado,0) AS BloqueadoFL
		,M.Email
		,M.TriajeESI
FROM	PARAMETROS..ParametrosMedicos M
		--Alfredo - CHC3064 - inicio
		INNER JOIN
			UsuariosCentros UC ON
				M.DNIMedico = UC.DNI AND
				UC.CodCentro = ISNULL(@CodCentro, M.CodCentroMed)
		--Alfredo - CHC3064 - inicio
		left join PARAMETROS..Servicios S
			on M.CodServicioMedico= S.Codigo
		left join PARAMETROS..CentrosSalud CS
			on M.CodCentroMed = CS.CodCentro
		--MAIPU -- CHC-2024 -- V4.33, Registro atenciones profesionales no médicos
		left join Parametros..Codigos C
			on C.Codigo	=M.CodRol And C.Tabla='ROLUSUARIO'
		--MAIPU -- CHC-2024 -- V4.33, Fin
		left join Parametros..UsuariosBloqueo Bloqueo
				on Bloqueo.DNI = M.DNIMedico
				
where M.DNIMedico = @spvar_documento
And (@spvar_login is null or M.UsuarioMedico = @spvar_login)


SELECT	E.NombreEnf	as NomUsuario,
		E.Apell1Enf	as Apell1Usuario,
		E.Apell2Enf	as Apell2Usuario,
		E.CodServicio	as CodServicioUsuario,
		E.DNIEnf		as DNIUsuario,
		upper(LTrim(RTrim(E.NombreEnf)) + ' ' + RTrim(LTrim(E.Apell1Enf)) + ' ' + Rtrim(LTrim(E.Apell2Enf))) as NombreCompleto,
		E.CodCentroEnf as CodCentroUsuario,
		'e'	as Tipo,
		E.UsuarioEnf as LoginUsuario,
		E.FechaAltaEnf as FechaAlta,
		E.FechaBajaEnf as FechaBaja,
		E.DirigenteEnf as Dirigente,
		E.IncentivosEnf as Incentivos,
		E.PermiteCrearPropuesta as PermiteCrearPropuesta,
		E.EsFisio as EsFisio,
		E.Idioma as Idioma,
		S.DescServicio as DescServicio,
		CS.DescCentro as DescCentro,
		isnull(E.Perfil,'-1') as CodPerfil,
		E.LlaveEnf as Llave,
		--MAIPU -- CHC-2024 -- V4.33, Registro atenciones profesionales no médicos
		-- CHC 2484 -- V4.34, Error al extraer informe de todas las consultas JCT 448702384K INI
		--E.Rol, -- RJF (10/12/08)
		C.Descripcion as Rol,
		-- CHC 2484 -- V4.34, Error al extraer informe de todas las consultas JCT 448702384K FIN
		E.CodRol as CodRol,
		--MAIPU -- CHC-2024 -- V4.33, Fin	
		E.IncentivosEnf as TieneIncentivo,
		CD.Descripcion as Colectivo,
		E.ColectivoDUE as CodColectivo,
		E.CodDepartamento as CodDepart,
		E.Nif as NIF,
		E.Documentacion as Documentalista
		--Alfredo - CHC3064 - inicio
		,UC.Bloqueado
		,UC.Activo
		--Alfredo - CHC3064 - fin
		,E.RCC
		,ISNULL(Bloqueo.Bloqueado,0) AS BloqueadoFL
		,E.Email
		,E.TriajeESI
FROM	PARAMETROS..DatosEnfermeras E
		--Alfredo - CHC3064 - inicio
		INNER JOIN
			UsuariosCentros UC ON
				E.DNIEnf = UC.DNI AND
				UC.CodCentro = ISNULL(@CodCentro, E.CodCentroEnf)
		--Alfredo - CHC3064 - inicio
		left join PARAMETROS..Servicios S
			on E.CodServicio = S.Codigo
		left join PARAMETROS..CentrosSalud CS
			on E.CodCentroEnf = CS.CodCentro
		left join Parametros..ColectivoDUE CD
			on E.ColectivoDUE = CD.ColectivoDUE
		--MAIPU -- CHC-2024 -- V4.33, Registro atenciones profesionales no médicos
		left join Parametros..Codigos C
			on C.Codigo	=E.CodRol And C.Tabla='ROLUSUARIO'
		--MAIPU -- CHC-2024 -- V4.33, Fin
		left join Parametros..UsuariosBloqueo Bloqueo
				on Bloqueo.DNI = E.DNIEnf
				
where E.DNIEnf = @spvar_documento
And (@spvar_login is null or E.UsuarioEnf = @spvar_login)

ORDER BY NombreCompleto
GO



--dbo.SpParSCentrosSalud.sql

USE [Parametros]
GO

IF EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[SpParSCentrosSalud]') AND type in (N'P', N'PC'))
	DROP PROCEDURE [dbo].[SpParSCentrosSalud]
GO
  
/*********************************************************************
* FUNCION : Prepara la tabla de CCache CentrosSalud
* DEVUELVE :
* FECHA	: 07/08/2007
* VERSION : 1.0
* AUTOR	: azaragoza (Revision de estandares)
* MODIFICACIÓN: 29/05/2008. Jaume Milián (MECEMSA).
*				Se devuelve el campo EsUrgencias.
* MODIFICACIÓN: 12/01/2009. Jesús Mañogil (Mecemsa).
*				Se devuelve el campo TienePrimaria.
* MODIFICACIÓN: 27/05/2009. Paco Aznar
*				Se devuelven los campos de imagenes de cabecera.
* MODIFICACIÓN: 08/06/2009. Paco Aznar
*				Se devuelve si el centro de salud es de referencia.
* MODIFICACIÓN: 29/07/2009. Paco Aznar
*				Se devuelve el centro de referencia al que pertenece.
* MODIFICACIÓN: 15/09/2009. Paco Aznar
*				Se devuelve la descripción corta del centro.
* MODIFICACIÓN: 12/01/2010. Miguel Angel Utiel
*				Se devuelve los logos de las tarjetas.
* MODIFICACIÓN: 14/01/2010. Joaquín Aniorte
*				Se sustituye el valor especifico de Codigo de zona por una constante.
* MODIFICACIÓN: 20/01/2010. Paco Aznar
*				Se devuelve el campo guiaFarmaciaPropia.
* MODIFICACIÓN: 22/04/2010. Miguel Ángel
*				Se pueda seleccionar un centro en concreto.
* MODIFICACIÓN: (12/01/2015) - V4.50 - 1402 - VAS - Modulo de esterilización Fase 2
* MODIFICACIÓN: (15/05/2015) - v4.51 - 1620 - APB - Integración LME
* MODIFICACIÓN: (21/06/2017) - v17.3 - 18485 - MPR - Seguridad en adjuntar documentos
'*******************************************************************/

CREATE PROCEDURE [dbo].[SpParSCentrosSalud]
	 @spvar_CodZona as char(5) = null
	,@spvar_CodCentro as char(5) = null
AS

DECLARE @m_strCodZona char(5)

SELECT @m_strCodZona = ValorConstante 
FROM Parametros..Constantes 
WHERE NombreConstante = 'm_strCodZona'

SET @spvar_CodZona = ISNULL(@spvar_CodZona, @m_strCodZona)

IF @spvar_CodCentro is null
	SELECT	 CodCentro
			,DescCentro
			,ISNULL(UrgenciaPrimaria, 0) AS UrgenciaPrimaria
			,TienePrimaria
			,ImagenCabecera1
			,ImagenCabecera2
			,EsHospitalReferencia
			,HospitalRef
			,DescCorta
			,guiaFarmaciaPropia
			--,ImageLogoTarjeta
			--,ImageLogoTarjeta2	
			,TipoEstablecimiento --(12/01/2015) - V4.50 - 1402 - VAS - Modulo de esterilización Fase 2
			,RUTCentro --(15/05/2015) - v4.51 - 1620 - APB - Integración LME
			,RutaHPrevia 
			,Usuario 
			,Password 
			,Dominio 
			,RequiereCredenciales 
	FROM	CentrosSalud
	WHERE	Borrado IS NULL
			AND CodZona = @spvar_CodZona
	ORDER BY DescCentro
ELSE
	SELECT	 CodCentro
			,DescCentro
			,ISNULL(UrgenciaPrimaria, 0) AS UrgenciaPrimaria
			,TienePrimaria
			,ImagenCabecera1
			,ImagenCabecera2
			,EsHospitalReferencia
			,HospitalRef
			,DescCorta
			,guiaFarmaciaPropia
			--,ImageLogoTarjeta
			--,ImageLogoTarjeta2	
			,TipoEstablecimiento --(12/01/2015) - V4.50 - 1402 - VAS - Modulo de esterilización Fase 2
			,RUTCentro --(15/05/2015) - v4.51 - 1620 - APB - Integración LME
			,RutaHPrevia 
			,Usuario 
			,Password 
			,Dominio 
			,RequiereCredenciales 
	FROM	CentrosSalud
	WHERE	Borrado IS NULL
			AND CodZona = @spvar_CodZona
			AND CodCentro = @spvar_CodCentro 
	ORDER BY DescCentro

 GO
GO



--dbo.SpParSCodConse.sql

USE [Parametros]
GO

IF EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[SpParSCodConse]') AND type in (N'P', N'PC'))
	DROP PROCEDURE [dbo].[SpParSCodConse]
GO

/**********************************************************************************************
PROCEDIMIENTO : SpParSCodConse
FUNCION		  : Nos devuelve el código de prestación asociado a una prueba o un perfil
DEVUELVE	  :
FECHA		  : 26/02/2010
VERSION		  : 1.0
AUTOR		  : Miguel Ángel Utiel
MODIFICACION  : (20/07/2017) - V17.2r1 - 19256 - APB - Integración Prestaciones de Laboratorio
**********************************************************************************************/

CREATE PROCEDURE [dbo].[SpParSCodConse]
	 @spvar_Prueba varchar(21) = null
	,@spvar_CodPerfil char(10) = null
AS

BEGIN
	IF NOT @spvar_Prueba IS NULL
		BEGIN
			SELECT TOP 1 CodConsejeria
			FROM Parametros..PruebasLab
			WHERE CodPrueba = @spvar_Prueba
		END
	ELSE
		BEGIN
			SELECT TOP 1 CodConsejeria
			FROM Parametros..PerfilesLab
			WHERE CodPerfil = @spvar_CodPerfil
		END
END

GO
GO



--dbo.SpParSConfiguracionSMTP.sql

USE [Parametros]
GO

IF EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[SpParSConfiguracionSMTP]') AND type in (N'P', N'PC'))
	DROP PROCEDURE [dbo].[SpParSConfiguracionSMTP]
GO

/**********************************************************************************************
* FUNCION      : SpParSConfiguracionSMTP
* DEVUELVE     : Devuelve la lista de configuracion de correo para envio de mail tras operaciones de contraseñas de usuarios
* FECHA        : 09/02/2017
* VERSION      : 4.68
* AUTOR        : David Vázquez Roca
* ORIGEN       : Auditoría de cambio de contraseñas y comunicación al usuario mediante mail
* MODIFICACION : (13/07/2017) - APB - Se quita el filtro por centro
**************************************************************************************/

CREATE PROCEDURE [dbo].[SpParSConfiguracionSMTP]
	@SpVar_CodCentro char(5) = null
AS

SELECT CodCentro
	  ,DireccionSMTP
	  ,Puerto
	  ,Usuario
	  ,Contrasenya
	  ,Remitente
	  ,PieCorreo

FROM Parametros..ConfiguracionSMTP

WHERE CodCentro = ISNULL(@SpVar_CodCentro,CodCentro)

ORDER BY CodCentro

GO
GO



--dbo.SpParSCuposCitasFechas.sql

    USE [Parametros];
    GO
    IF EXISTS 
    (
        SELECT * 
            FROM sys.procedures 
            WHERE [object_id] = OBJECT_ID('[dbo].[SpParSCuposCitasFechas]')
    )
    BEGIN
        DROP PROCEDURE [dbo].[SpParSCuposCitasFechas];
    END
    GO
    /**************************************************
--	PROCEDIMIENTO	 :  SpParSCuposCitas
--	FUNCION          :  Procedimiento para cargar los datos de los cupos
--	DEVUELVE         : 
--	FECHA            :  24/02/2010
--	VERSION          :  1.0
--	AUTOR            :  Paco Aznar
--	APLICACION ORIGEN:  Buscador de cupos
************************************************
MODIFICACION:	(28/04/2010) Paco Aznar. Se obtienen los bits de citaPrimera y citaSucesiva
************************************************
MODIFICACION:	(06/09/2010) Paco Aznar. Se obtiene el centro origen del cupo
************************************************
MODIFICACION:	(14/01/2011) Paco Aznar. Se elimina ambigüedad del campo CupoMaximo
************************************************
MODIFICACION:	(14/07/2011) A. Zaragoza. No estaba haciendo bien el cruce por fechas
				25/08/2011 A. Zaragoza. Cambios fecha
				20111124 A. Zaragoza. Modifico cruces con fechas para evitar redondeos de BD
				
MODIFICACIÓN:   (03/10/2012) Alberto Pagán CHC2117 - v4.32 Release 3 - Exportar Cupos
************************************************
MODIFICACIÓN:	(22/06/2015) v4.52 - 1899 - SGN - Problema distribución cupos florence
MODIFICACIÓN:	(04/08/2017) v17.3 - 18705 - MPR - Filtrado fechas cupos por centro
************************************************/

CREATE PROCEDURE [dbo].[SpParSCuposCitasFechas]
	@spvar_CodCentro as char(5) = NULL,
	@spvar_FechaIni as smalldatetime = NULL,
	@spvar_FechaFin as smalldatetime = NULL,
	@spvar_CodServicio as char(4) = NULL,
	@spvar_codUnidad as int = NULL,
	@spvar_NomCupo varchar(100) = NULL --Alberto Pagán - CHC2117 - v4.32 Release 3 - 03/10/2012	
	
AS

BEGIN
	
	SELECT DISTINCT
		  --cc.FechaIni
		  parametros.dbo.fnParFechaHoraUTC(cc.FechaIni) as FechaIni____,
		  --,cc.FechaFin
		  parametros.dbo.fnParFechaHoraUTC(cc.FechaFin) as FechaFin____,
		  --cc.fechaCaducidad
		  parametros.dbo.fnParFechaHoraUTC(cc.fechaCaducidad) as fechaCaducidad____,
		  cc.CupoTotal as cupoMaximo
		  ,cc.CodServicio
		  ,s.DescServicio
		  ,cc.CodUnidad
		  ,u.Descripcion
		  ,cc.NomCupo
		  ,cc.idCupo
		  ,(select top 1 cu1.fechaCad1 from parametros..cuposCentro cu1 where cu1.idCupo = cu.idCupo and cu1.fechaCad1 is not null) as fechaCad1
		  ,(select top 1 cu2.fechaCad2 from parametros..cuposCentro cu2 where cu2.idCupo = cu.idCupo and cu2.fechaCad2 is not null) as fechaCad2
		  ,cc.citaPrimera
		  ,cc.citaSucesiva
		  ,cc.codCentroOrigen
			-- (22/06/2015) v4.52 - 1899 - SGN - Problema distribución cupos florence - INI
			, cc.UsuCreacion
			, cc.FecCreacion
			-- (22/06/2015) v4.52 - 1899 - SGN - Problema distribución cupos florence - FIN
			
	FROM parametros.dbo.CuposCitas cc
		left join parametros..CuposCentro cu
			on cu.idCupo = cc.idCupo
		left join parametros..Servicios s
			on s.Codigo = cc.CodServicio
		left join parametros..Unidad u
			on u.IdUnidad = cc.CodUnidad
		
	WHERE (@spvar_CodCentro is null or @spvar_CodCentro = cc.codCentroOrigen)
  	    and (@spvar_codUnidad is null or cc.codUnidad = @spvar_codUnidad)
   	    and (@spvar_FechaIni is null or (convert(char(8), FechaIni, 112)> convert(char(8), @spvar_FechaIni, 112)))
   	    and (@spvar_FechaFin is null or (convert(char(8), FechaFin, 112)< convert(char(8), @spvar_FechaFin, 112)))
	    and (@spvar_CodServicio is null or @spvar_CodServicio = CodServicio)
		and (cu.fechaCad is not null or cu.fechaCad1 is not null or cu.fechaCad2 is not null)
		AND (cc.NomCupo LIKE '%' + @spvar_NomCupo + '%' OR @spvar_NomCupo IS NULL) --Alberto Pagán - CHC2117 - v4.32 Release 3 - 03/10/2012
END
    GO

GO



--dbo.SpParSDatosTodosLosUsuarios.sql

USE [Parametros];
    GO
    IF EXISTS 
    (
        SELECT * 
            FROM sys.procedures 
            WHERE [object_id] = OBJECT_ID('[dbo].[SpParSDatosTodosLosUsuarios]')
    )
    BEGIN
        DROP PROCEDURE [dbo].[SpParSDatosTodosLosUsuarios];
    END
    GO

-- ================================================================================================================
-- CREACION:		(14/01/2016) - v4.56r2 - 2820 - LMF - Permisos Florence Gestión
-- FECHA CREACIÓN:	15/06/2015
-- DESCRIPCION:		Obtiene los datos de todos los usuarios
-- ORIGEN:			Florence Gestion - Cache
-- MODIFICACION: 05/09/2017 - v17.2r5 - 147108 - 19833 - FCB - Observación en gestion de permisos por centro
-- ================================================================================================================
CREATE PROCEDURE [dbo].[SpParSDatosTodosLosUsuarios] 
AS

BEGIN
	SELECT 
		M.DNIMedico AS RUN,
		M.NomMedico AS Nombre,
		M.Apell1 AS Apellido1,
		M.Apell2 AS Apellido2,
		'M' AS TipoUsuario,
		C.Codigo AS CodRol,
		C.Descripcion As Rol
		,ISNULL(UC.CodCentro,M.CodCentroMed) as CodCentro
	FROM 
		ParametrosMedicos M
		LEFT JOIN Parametros..Codigos C
			ON  C.Codigo = M.CodRol 
			AND C.Tabla='ROLUSUARIO'
		LEFT JOIN Parametros..UsuariosCentros UC ON UC.DNI=M.DNIMedico
	WHERE ISNULL(M.EliminadoMed,0) <> 1
		
	UNION

	SELECT
		E.DNIEnf AS RUN,
		E.NombreEnf AS Nombre,
		E.Apell1Enf AS Apellido1,
		E.Apell2Enf AS Apellido2,
		'E' AS TipoUsuario,
		C.Codigo AS CodRol,
		C.Descripcion As DescripcionRol
		,ISNULL(UC.CodCentro,E.CodCentroEnf) as CodCentro
	FROM
		DatosEnfermeras E
		LEFT JOIN Parametros..Codigos C
			ON  C.Codigo = E.CodRol 
			AND C.Tabla='ROLUSUARIO'
		LEFT JOIN Parametros..UsuariosCentros UC ON UC.DNI=E.DNIEnf
	WHERE ISNULL(E.EliminadoEnf,0) <> 1

	UNION

	SELECT
		T.DNITecnico AS RUN,
		T.NombreTecnico AS Nombre,
		T.Apell1Tecnico AS Apellido1,
		T.Apell2Tecnico AS Apellido2,
		'T' AS TipoUsuario,
		C.Codigo AS CodRol,
		C.Descripcion As DescripcionRol
		,ISNULL(UC.CodCentro, T.CodCentroTecnico) as CodCentro
	FROM
		TecnicosDatos T
		LEFT JOIN Parametros..Codigos C
			ON  C.Codigo = T.CodRol 
			AND C.Tabla='ROLUSUARIO'
		LEFT JOIN Parametros..UsuariosCentros UC ON UC.DNI=T.DNITecnico
	WHERE ISNULL(T.EliminadoTecnico,0) <> 1
		
	UNION

	SELECT
		A.DNIAdminist AS RUN,
		A.NomAdminis AS Nombre,
		A.Apell1Administ AS Apellido1,
		A.Apell2Administ AS Apellido2,
		'A' AS TipoUsuario,
		C.Codigo AS CodRol,
		C.Descripcion As DescripcionRol
		,ISNULL(UC.CodCentro,A.CodCentroAdminist) as CodCentro
	FROM
		Administrativo A
		LEFT JOIN Parametros..Codigos C
			ON  C.Codigo = A.CodRol 
			AND C.Tabla='ROLUSUARIO'
		LEFT JOIN Parametros..UsuariosCentros UC ON UC.DNI=A.DNIAdminist
	WHERE ISNULL(A.EliminadoAdminist,0) <> 1


END



GO



--dbo.SpParSListaTodoUsuario.sql

USE [Parametros]
GO

/****** Object:  StoredProcedure [dbo].[SpParSListaTodoUsuario]    Script Date: 05/30/2013 09:26:46 ******/
IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[SpParSListaTodoUsuario]') AND type in (N'P', N'PC'))
DROP PROCEDURE [dbo].[SpParSListaTodoUsuario]
GO

USE [Parametros]
GO

/****** Object:  StoredProcedure [dbo].[SpParSListaTodoUsuario]    Script Date: 05/30/2013 09:26:46 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO
   


/**********************************************************************************************
* FUNCION:  SpParSListaTodoUsuario
* DEVUELVE: Devuelve la lista de Administrativos, Técnicos, enfermeras y medicos (altas y bajas)
* FECHA:    24/07/2008
* VERSION:  1.0
* AUTOR:    Joaquín Gras Gómez-Agensys
* ORIGEN :  FBuscaUsuario
* FECHA: 19/09/2008
* MODIFICACIÓN: Se añaden campos: Idioma, DescServicio, DescCentro, Idioma2, Perfil
*********************************************************************************************
* AUTOR:    Ramon Jimenez (Mecemsa)
* FECHA: 10/12/2008
* MODIFICACIÓN: Se añade campo: Rol.
*********************************************************************************************
* AUTOR:    Curro Rosado (Agensys)
* FECHA: 06/05/2009/
* MODIFICACIÓN: Se modifica  de isnull(T.Perfil,'0') as CodPerfil a 
*               isnull(T.Perfil,'-1') as CodPerfil, para que no seleccione ningún elemento 
*               en la combo de perfiles del detalle de usuario.
*                       Que seleccione el campo consultor externo
*                       12/05/2009 - Se añade el campo ClaveMed
*********************************************************************************************
* MODIFICACIONES: 
Joaquín Aniorte (29/07/2009): Se añaden campos TieneIncentivo y Colectivo
Jesús Mañogil (30/11/2009): El campo TieneIncentivo se devuelve en formato bit no 'True/False'
Jesús Mañogil (28/12/2009): El Nombre completo lo devolvemos en mayúsculas
Miguel Ángel Utiel (20/01/2010): Nos devuelva el nif
Miguel Ángel Utiel (09/02/2010): Nos devuelva el campo OcultaPac
Miguel Ángel Utiel (18/03/2010): Nos devuelva si es Documentalista
Luis Merle (14/05/2010): Se añade el Campo PermisosIndicadores
Paco Aznar  (16/06/2010): Se devuelve el campo Residente
Paco Aznar  (22/06/2010): Se devuelve el campo Residente PorcenJornada
Teresa L Fabuel (27/10/2010): Se obtiene el campo NifCrc de ParametrosMedicos.
Ramón Jiménez (21/12/2010): Se hace el CAST a Residente y PorcenJornada para que sean del mismo tipo todos.
Alejandro Palazón (18/01/2010): Nos devuelve el codMutua
Alejandro Palazón (18/02/2010): Nos devuelve si los Administrativos son Consultores Externos
Alejandro Palazón (24/02/2010): Nos devuelve el CodMutua de los Administrativos que son Consultores Externos
**************************************************************************************
-- MODIFICACION : (05/10/2012) Fran Cuenca MAIPU -- CHC-2024 -- V4.33, Registro atenciones profesionales no médicos
				  (27/12/2012) Juan Manuel Cobaleda CHC 2484 -- V4.34, Error al extraer informe de todas las consultas JCT 448702384K
-- MODIFICACIÓN : (26/04/2013) Alfredo - CHC2901 - Gestión 4.38 - Se devuelven también los nuevos campos bloqueado e inactivo
-- MODIFICACIÓN : 30/05/2013 Alfredo - CHC3064 - Ahora los campos Activo y Bloqueado van por centro (se cruza con UsuariosCentros)
-- MODIFICACIÓN : 14/06/2016 - v4.62 - 3218 - SGN - Registro Confidencial
-- MODIFICACIÓN : 03/10/2016 - v4.65 - 13406 - MMM - Acceso mediante lista blanca
-- MODIFICACIÓN : 31/10/2017 - v4.68 - 15135 - LMF - Se añade el campo BloqueadoFL
-- MODIFICACIÓN : 09/02/2017 - v4.68 - 15136 - DVR - Auditoría de cambio de contraseñas y comunicación al usuario mediante mail
-- MODIFICACIÓN : 29/06/2017 - V17.2r1 - 18277 - SGH - Triaje ESI 
**************************************************************************************/

CREATE PROCEDURE [dbo].[SpParSListaTodoUsuario]
      @CodCentro CHAR(5) = NULL 
AS

declare @Uno as bit
declare @Cero as bit
set @Uno = 1
set @Cero = 0

SELECT      A.NomAdminis as NomUsuario,
            A.Apell1Administ as Apell1Usuario,
            A.Apell2Administ as Apell2Usuario,
            A.CodServicioAdminist   as CodServicioUsuario,
            A.DNIAdminist as DNIUsuario,
            upper(LTrim(RTrim(A.NomAdminis)) + ' ' + RTrim(LTrim(A.Apell1Administ)) + ' ' + Rtrim(LTrim(A.Apell2Administ))) as NombreCompleto,
            A.CodCentroAdminist as CodCentroUsuario,
            'a' as Tipo,
            A.UsuarioAdminis as LoginUsuario,
            A.FAltaAdminist as FechaAlta,
            A.FBajaAdminist as FechaBaja,
            A.TipPersonAdminist as TipoPerson,
            A.PermiteCrearRayos as PermiteCrearRayos,
            A.Idioma as Idioma,
            S.DescServicio as DescServicio,
            CS.DescCentro as DescCentro,
            isnull(A.Perfil,'-1') as CodPerfil,
            A.LlaveAdminist as Llave,
            --MAIPU -- CHC-2024 -- V4.33, Registro atenciones profesionales no médicos
            -- CHC 2484 -- V4.34, Error al extraer informe de todas las consultas JCT 448702384K INI
			--A.Rol, -- RJF (10/12/08)
			C.Descripcion as Rol,
			-- CHC 2484 -- V4.34, Error al extraer informe de todas las consultas JCT 448702384K FIN
			A.CodRol as CodRol,
			--MAIPU -- CHC-2024 -- V4.33, Fin	
            @Cero as TieneIncentivo,
            '' as Colectivo,
            '' as CodColectivo,
            A.CodDepartamento as CodDepart,
            A.Nif as NIF,
            A.oldUsuario as OldUser,
            A.OcultaPac as Oculta,
            A.Documentacion as Documentalista,
            A.PermisosIndicadores,
            CAST(Null as bit) as Residente,
            CAST(Null as decimal) as PorcenJornada,
            A.ConsultorExterno,
            A.CodMutua
            --Alfredo - CHC3064 - inicio
            ,UC.Bloqueado
            ,UC.Activo
            --Alfredo - CHC3064 - fin
            ,NULL as RCC
			,A.UsuGenerico
			,ISNULL(Bloqueo.Bloqueado,0) AS BloqueadoFL
			,A.Email
			,A.TriajeESI
FROM  PARAMETROS..Administrativo A
			--Alfredo - CHC3064 - inicio
			INNER JOIN
				UsuariosCentros UC ON
					A.DNIAdminist = UC.DNI AND
					UC.CodCentro = ISNULL(@CodCentro, A.CodCentroAdminist)
			--Alfredo - CHC3064 - fin
            left join PARAMETROS..Servicios S
                  on A.CodServicioAdminist = S.Codigo
            left join PARAMETROS..CentrosSalud CS
                  on A.CodCentroAdminist = CS.CodCentro
			--MAIPU -- CHC-2024 -- V4.33, Registro atenciones profesionales no médicos
			left join Parametros..Codigos C
				on C.Codigo	=A.CodRol And C.Tabla='ROLUSUARIO'
			--MAIPU -- CHC-2024 -- V4.33, Fin
			left join Parametros..UsuariosBloqueo Bloqueo
				on Bloqueo.DNI = A.DNIAdminist

SELECT      T.Nombretecnico   as NomUsuario,
            T.Apell1Tecnico   as Apell1Usuario,
            T.Apell2Tecnico   as Apell2Usuario,
            T.CodSeccionTecnico     as CodServicioUsuario,
            T.DNITecnico            as DNIUsuario,
            upper(LTrim(RTrim(T.Nombretecnico)) + ' ' + RTrim(LTrim(T.Apell1Tecnico)) + ' ' + Rtrim(LTrim(T.Apell2Tecnico))) as NombreCompleto,
            T.CodCentroTecnico as CodCentroUsuario,
            't' as Tipo,
            T.UsuarioTecnico as LoginUsuario,
            T.FAltaTecnico as FechaAlta,
            T.FBajaTecnico as FechaBaja,
            T.Orden as Orden,
            T.Idioma as Idioma,
            S.DescServicio as DescServicio,
            CS.DescCentro as DescCentro,
            isnull(T.Perfil,'-1') as CodPerfil,
            T.LlaveTecnico as Llave,
            --MAIPU -- CHC-2024 -- V4.33, Registro atenciones profesionales no médicos
			-- CHC 2484 -- V4.34, Error al extraer informe de todas las consultas JCT 448702384K INI
			--T.Rol, -- RJF (10/12/08) 
			C.Descripcion as Rol,
			-- CHC 2484 -- V4.34, Error al extraer informe de todas las consultas JCT 448702384K FIN
			T.CodRol as CodRol,
			--MAIPU -- CHC-2024 -- V4.33, Fin	                
            isnull(T.IncentivosEnf,0) | isnull(T.IncentivosTec, 0) as TieneIncentivo,
            CT.Descripcion as Colectivo,
            T.ColectivoTEC as CodColectivo,
            T.CodDepartamento as CodDepart,
            T.Nif as NIF,
            T.oldUsuario as OldUser,
            T.OcultaPac as Oculta,
            @Cero as Documentalista,
            T.PermisosIndicadores,
            CAST(Null as bit) as Residente,
            CAST(Null as decimal) as PorcenJornada   
            --Alfredo - CHC3064 - inicio
            ,UC.Bloqueado
            ,UC.Activo
            --Alfredo - CHC3064 - fin
			,NULL as RCC
			,T.UsuGenerico
			,ISNULL(Bloqueo.Bloqueado,0) AS BloqueadoFL
			,T.Email
			,T.TriajeESI
FROM  PARAMETROS..TecnicosDatos T
			--Alfredo - CHC3064 - inicio
			INNER JOIN
				UsuariosCentros UC ON
					T.DNITecnico = UC.DNI AND
					UC.CodCentro = ISNULL(@CodCentro, T.CodCentroTecnico)
			--Alfredo - CHC3064 - fin
            left join PARAMETROS..Servicios S
                  on T.CodServicioTecnico= S.Codigo
            left join PARAMETROS..CentrosSalud CS
                  on T.CodCentroTecnico = CS.CodCentro
            left join Parametros..ColectivoTec CT
                  on T.ColectivoTEC = CT.ColectivoTEC
			--MAIPU -- CHC-2024 -- V4.33, Registro atenciones profesionales no médicos
			left join Parametros..Codigos C
				on C.Codigo	=T.CodRol And C.Tabla='ROLUSUARIO'
			--MAIPU -- CHC-2024 -- V4.33, Fin
			left join Parametros..UsuariosBloqueo Bloqueo
				on Bloqueo.DNI = T.DNITecnico
				

SELECT      M.NomMedico as NomUsuario,
            M.Apell1          as Apell1Usuario,
            M.Apell2          as Apell2Usuario,
            M.CodServicioMedico     as CodServicioUsuario,
            M.DNIMedico             as DNIUsuario,
            upper(LTrim(RTrim(M.NomMedico)) + ' ' + RTrim(LTrim(M.Apell1)) + ' ' + Rtrim(LTrim(M.Apell2))) as NombreCompleto,
            M.CodCentroMed as CodCentroUsuario,
            'm' as Tipo,
            M.UsuarioMedico as LoginUsuario,
            M.FAltaMedico as FechaAlta,
            M.FBajaMedico as FechaBaja,
            M.CodServicioMedico as CodServicio,
            M.EspeciCupoMedico as EspeciCupo,
            M.ImprimeInforme as ImprimeInforme,
            M.Idioma1 as Idioma,
            S.DescServicio as DescServicio,
            CS.DescCentro as DescCentro,
            M.Idioma2 as Idioma2,
            isnull(M.Perfil,'-1') as CodPerfil,
            M.LlaveMedico as Llave,
			--MAIPU -- CHC-2024 -- V4.33, Registro atenciones profesionales no médicos
			-- CHC 2484 -- V4.34, Error al extraer informe de todas las consultas JCT 448702384K INI
			--M.Rol, -- RJF (10/12/08)
			C.Descripcion as Rol,
			-- CHC 2484 -- V4.34, Error al extraer informe de todas las consultas JCT 448702384K FIN
			M.CodRol as CodRol,
			--MAIPU -- CHC-2024 -- V4.33, Fin	
            case M.IncentivosMed 
                  when 's' then @Uno
                  when 'S' then @Uno
                  else @Cero
            end as TieneIncentivo,
            '' as Colectivo,
            '' as CodColectivo,
            M.ConsultorExterno,
            M.ClaveMed,
            M.CodDepartamento as CodDepart,
            M.Nif as NIF,
            M.oldUsuario as OldUser,
            M.OcultaPac as Oculta,
            M.Documentacion as Documentalista,
            M.AvisoHemo as AvisoHemo,
            M.PermisosIndicadores,
            M.Residente,
            CAST(Null as decimal) as PorcenJornada,
            M.NIFCRC,
            M.CodMutua
            --Alfredo - CHC3064 - inicio
            ,UC.Bloqueado
            ,UC.Activo
            --Alfredo - CHC3064 - fin
            ,M.RCC
			,M.UsuGenerico
			,ISNULL(Bloqueo.Bloqueado,0) AS BloqueadoFL
			,M.Email
			,M.TriajeESI
FROM  PARAMETROS..ParametrosMedicos M
			--Alfredo - CHC3064 - inicio
			INNER JOIN
				UsuariosCentros UC ON
					M.DNIMedico = UC.DNI AND
					UC.CodCentro = ISNULL(@CodCentro, M.CodCentroMed)
			--Alfredo - CHC3064 - fin
            left join PARAMETROS..Servicios S
                  on M.CodServicioMedico= S.Codigo
            left join PARAMETROS..CentrosSalud CS
                  on M.CodCentroMed = CS.CodCentro
			--MAIPU -- CHC-2024 -- V4.33, Registro atenciones profesionales no médicos
			left join Parametros..Codigos C
				on C.Codigo	=M.CodRol And C.Tabla='ROLUSUARIO'
			--MAIPU -- CHC-2024 -- V4.33, Fin
			left join Parametros..UsuariosBloqueo Bloqueo
				on Bloqueo.DNI = M.DNIMedico

SELECT      E.NombreEnf as NomUsuario,
            E.Apell1Enf as Apell1Usuario,
            E.Apell2Enf as Apell2Usuario,
            E.CodServicio     as CodServicioUsuario,
            E.DNIEnf          as DNIUsuario,
            upper(LTrim(RTrim(E.NombreEnf)) + ' ' + RTrim(LTrim(E.Apell1Enf)) + ' ' + Rtrim(LTrim(E.Apell2Enf))) as NombreCompleto,
            E.CodCentroEnf as CodCentroUsuario,
            'e'   as Tipo,
            E.UsuarioEnf as LoginUsuario,
            E.FechaAltaEnf as FechaAlta,
            E.FechaBajaEnf as FechaBaja,
            E.DirigenteEnf as Dirigente,
            E.IncentivosEnf as Incentivos,
            E.PermiteCrearPropuesta as PermiteCrearPropuesta,
            E.EsFisio as EsFisio,
            E.Idioma as Idioma,
            S.DescServicio as DescServicio,
            CS.DescCentro as DescCentro,
            isnull(E.Perfil,'-1') as CodPerfil,
            E.LlaveEnf as Llave,
            --MAIPU -- CHC-2024 -- V4.33, Registro atenciones profesionales no médicos
			-- CHC 2484 -- V4.34, Error al extraer informe de todas las consultas JCT 448702384K INI
			--E.Rol, -- RJF (10/12/08)
			C.Descripcion as Rol,
			-- CHC 2484 -- V4.34, Error al extraer informe de todas las consultas JCT 448702384K FIN
			E.CodRol as CodRol,
			--MAIPU -- CHC-2024 -- V4.33, Fin	
            E.IncentivosEnf as TieneIncentivo,
            CD.Descripcion as Colectivo,
            E.ColectivoDUE as CodColectivo,
            E.CodDepartamento as CodDepart,
            E.Nif as NIF,
            E.oldUsuario as OldUser,
            E.OcultaPac as Oculta,
            E.Documentacion as Documentalista,
            E.PermisosIndicadores,
            CAST(Null as bit) as Residente,
            E.PorcenJornada
            --Alfredo - CHC3064 - inicio
            ,UC.Bloqueado
            ,UC.Activo
            --Alfredo - CHC3064 - fin
            ,E.RCC
			,E.UsuGenerico
			,ISNULL(Bloqueo.Bloqueado,0) AS BloqueadoFL
			,E.Email
			,E.TriajeESI
FROM  PARAMETROS..DatosEnfermeras E
			--Alfredo - CHC3064 - inicio
			INNER JOIN
				UsuariosCentros UC ON
					E.DNIEnf = UC.DNI AND
					UC.CodCentro = ISNULL(@CodCentro, E.CodCentroEnf)
			--Alfredo - CHC3064 - fin
            left join PARAMETROS..Servicios S
                  on E.CodServicio = S.Codigo
            left join PARAMETROS..CentrosSalud CS
                  on E.CodCentroEnf = CS.CodCentro
            left join Parametros..ColectivoDUE CD
                  on E.ColectivoDUE = CD.ColectivoDUE
			--MAIPU -- CHC-2024 -- V4.33, Registro atenciones profesionales no médicos
			left join Parametros..Codigos C
				on C.Codigo	=E.CodRol And C.Tabla='ROLUSUARIO'
			--MAIPU -- CHC-2024 -- V4.33, Fin
			left join Parametros..UsuariosBloqueo Bloqueo
				on Bloqueo.DNI = E.DNIEnf

ORDER BY NombreCompleto
GO
GO



--dbo.SpParSListaUsuarioByDNI.sql

USE [Parametros]; 
GO
IF EXISTS 
(
    SELECT * 
        FROM sys.procedures 
        WHERE [object_id] = OBJECT_ID('[dbo].[SpParSListaUsuarioByDNI]')
)
BEGIN
    DROP PROCEDURE [dbo].[SpParSListaUsuarioByDNI];
END

GO

/**********************************************************************************************
* FUNCION:	SpParSListaUsuarioByDNI
* DEVUELVE:	Devuelve todos los datos de un determinado usuario
* FECHA:	05/02/2010
* VERSION:	1.0
* AUTOR:	Miguel Angel Utiel
* ORIGEN :	FBuscaUsuario
* MODIFICACION:	09/02/2010 - Miguel Ángel Utiel - Añadido el campo OcultaPac
*				30/04/2010 - Sonia. documentalista
*				27/10/2010 - Teresa L Fabuel S. Obtengo el campo NifCrc en ParametrosMedicos
**************************************************************************************
-- MODIFICACION : (05/10/2012) Fran Cuenca MAIPU -- CHC-2024 -- V4.33, Registro atenciones profesionales no médicos
				  (27/12/2012) CHC 2484 -- V4.34, Error al extraer informe de todas las consultas JCT 448702384K INI
				  *				27/10/2010 - Teresa L Fabuel S. Obtengo el campo NifCrc en ParametrosMedicos
-- MODIFICACIÓN : 14/06/2016 - v4.62 - 3218 - SGN - Registro Confidencial
-- MODIFICACIÓN : 09/02/2017 - v4.68 - 15136 - DVR - Auditoría de cambio de contraseñas y comunicación al usuario mediante mail 
-- MODIFICACIÓN : 29/06/2017 - V17.2r1 - 18277 - SGH - Triaje ESI 
**************************************************************************************/

CREATE PROCEDURE [dbo].[SpParSListaUsuarioByDNI]
		@spvar_Dni	char(8) = Null
AS

declare @Uno as bit
declare @Cero as bit
set @Uno = 1
set @Cero = 0


SELECT	A.NomAdminis as NomUsuario,
		A.Apell1Administ as Apell1Usuario,
		A.Apell2Administ as Apell2Usuario,
		A.CodServicioAdminist	as CodServicioUsuario,
		A.DNIAdminist as DNIUsuario,
		upper(LTrim(RTrim(A.NomAdminis)) + ' ' + RTrim(LTrim(A.Apell1Administ)) + ' ' + Rtrim(LTrim(A.Apell2Administ))) as NombreCompleto,
		A.CodCentroAdminist as CodCentroUsuario,
		'a' as Tipo,
		A.UsuarioAdminis as LoginUsuario,
		A.FAltaAdminist as FechaAlta,
		A.FBajaAdminist as FechaBaja,
		A.TipPersonAdminist as TipoPerson,
		A.PermiteCrearRayos as PermiteCrearRayos,
		A.Idioma as Idioma,
		S.DescServicio as DescServicio,
		CS.DescCentro as DescCentro,
		isnull(A.Perfil,'-1') as CodPerfil,
		A.LlaveAdminist as Llave,
		--MAIPU -- CHC-2024 -- V4.33, Registro atenciones profesionales no médicos
		-- CHC 2484 -- V4.34, Error al extraer informe de todas las consultas JCT 448702384K INI
		---A.Rol, -- RJF (10/12/08)
		C.Descripcion as Rol,
		-- CHC 2484 -- V4.34, Error al extraer informe de todas las consultas JCT 448702384K FIN
		A.CodRol as CodRol,
		--MAIPU -- CHC-2024 -- V4.33, Fin	
		@Cero as TieneIncentivo,
		'' as Colectivo,
		'' as CodColectivo,
		A.CodDepartamento as CodDepart,
		A.Nif as NIF,
		A.oldUsuario as OldUser,
		A.OcultaPac as Oculta,
		A.Documentacion as Documentalista,
		-- CHC 2484 -- V4.34, Error al extraer informe de todas las consultas JCT 448702384K INI
		A.CodMutua
		-- CHC 2484 -- V4.34, Error al extraer informe de todas las consultas JCT 448702384K FIN
		,NULL as RCC
		,A.Email
		,A.TriajeESI
FROM	PARAMETROS..Administrativo A
		left join PARAMETROS..Servicios S
			on A.CodServicioAdminist = S.Codigo
		left join PARAMETROS..CentrosSalud CS
			on A.CodCentroAdminist = CS.CodCentro
		--MAIPU -- CHC-2024 -- V4.33, Registro atenciones profesionales no médicos
		left join Parametros..Codigos C
			on C.Codigo	=A.CodRol And C.Tabla='ROLUSUARIO'
		--MAIPU -- CHC-2024 -- V4.33, Fin
		

where  DNIAdminist = @spvar_Dni 	



SELECT	T.Nombretecnico	as NomUsuario,
		T.Apell1Tecnico	as Apell1Usuario,
		T.Apell2Tecnico	as Apell2Usuario,
		T.CodSeccionTecnico 	as CodServicioUsuario,
		T.DNITecnico		as DNIUsuario,
		upper(LTrim(RTrim(T.Nombretecnico)) + ' ' + RTrim(LTrim(T.Apell1Tecnico)) + ' ' + Rtrim(LTrim(T.Apell2Tecnico))) as NombreCompleto,
		T.CodCentroTecnico as CodCentroUsuario,
		't' as Tipo,
		T.UsuarioTecnico as LoginUsuario,
		T.FAltaTecnico as FechaAlta,
		T.FBajaTecnico as FechaBaja,
		T.Orden as Orden,
		T.Idioma as Idioma,
		S.DescServicio as DescServicio,
		CS.DescCentro as DescCentro,
		isnull(T.Perfil,'-1') as CodPerfil,
		T.LlaveTecnico as Llave,
		--MAIPU -- CHC-2024 -- V4.33, Registro atenciones profesionales no médicos
		-- CHC 2484 -- V4.34, Error al extraer informe de todas las consultas JCT 448702384K INI
		--T.Rol, -- RJF (10/12/08)
		C.Descripcion as Rol,
		-- CHC 2484 -- V4.34, Error al extraer informe de todas las consultas JCT 448702384K FIN
		T.CodRol as CodRol,
		--MAIPU -- CHC-2024 -- V4.33, Fin	
		isnull(T.IncentivosEnf,0) | isnull(T.IncentivosTec, 0) as TieneIncentivo,
		CT.Descripcion as Colectivo,
		T.ColectivoTEC as CodColectivo,
		T.CodDepartamento as CodDepart,
		T.Nif as NIF,
		T.oldUsuario as OldUser,
		T.OcultaPac as Oculta,
		-- CHC 2484 -- V4.34, Error al extraer informe de todas las consultas JCT 448702384K INI
		'' as CodMutua
		-- CHC 2484 -- V4.34, Error al extraer informe de todas las consultas JCT 448702384K FIN
		,NULL as RCC
		,T.Email
		,T.TriajeESI
FROM	PARAMETROS..TecnicosDatos T
		left join PARAMETROS..Servicios S
			on T.CodServicioTecnico= S.Codigo
		left join PARAMETROS..CentrosSalud CS
			on T.CodCentroTecnico = CS.CodCentro
		left join Parametros..ColectivoTec CT
			on T.ColectivoTEC = CT.ColectivoTEC
		--MAIPU -- CHC-2024 -- V4.33, Registro atenciones profesionales no médicos
		left join Parametros..Codigos C
			on C.Codigo	=T.CodRol And C.Tabla='ROLUSUARIO'
		--MAIPU -- CHC-2024 -- V4.33, Fin	
where DNITecnico = @spvar_Dni			



SELECT	M.NomMedico	as NomUsuario,
		M.Apell1		as Apell1Usuario,
		M.Apell2		as Apell2Usuario,
		M.CodServicioMedico	as CodServicioUsuario,
		M.DNIMedico			as DNIUsuario,
		upper(LTrim(RTrim(M.NomMedico)) + ' ' + RTrim(LTrim(M.Apell1)) + ' ' + Rtrim(LTrim(M.Apell2))) as NombreCompleto,
		M.CodCentroMed as CodCentroUsuario,
		'm' as Tipo,
		M.UsuarioMedico as LoginUsuario,
		M.FAltaMedico as FechaAlta,
		M.FBajaMedico as FechaBaja,
		M.CodServicioMedico as CodServicio,
		M.EspeciCupoMedico as EspeciCupo,
		M.ImprimeInforme as ImprimeInforme,
		M.Idioma1 as Idioma,
		S.DescServicio as DescServicio,
		CS.DescCentro as DescCentro,
		M.Idioma2 as Idioma2,
		isnull(M.Perfil,'-1') as CodPerfil,
		M.LlaveMedico as Llave,
		--MAIPU -- CHC-2024 -- V4.33, Registro atenciones profesionales no médicos
		-- CHC 2484 -- V4.34, Error al extraer informe de todas las consultas JCT 448702384K INI
		--M.Rol, -- RJF (10/12/08)
		C.Descripcion as Rol,
		-- CHC 2484 -- V4.34, Error al extraer informe de todas las consultas JCT 448702384K FIN
		M.CodRol as CodRol,
		--MAIPU -- CHC-2024 -- V4.33, Fin	
		case M.IncentivosMed 
			when 's' then @Uno
			when 'S' then @Uno
			else @Cero
		end as TieneIncentivo,
		'' as Colectivo,
		'' as CodColectivo,
		M.ConsultorExterno,
		M.ClaveMed,
		M.CodDepartamento as CodDepart,
		M.Nif as NIF,
		M.oldUsuario as OldUser,
		M.OcultaPac as Oculta,
		M.AvisoHemo as AvisoHemo,
		M.Documentacion as Documentalista,
		M.NIFCRC,
		-- CHC 2484 -- V4.34, Error al extraer informe de todas las consultas JCT 448702384K INI
		M.CodMutua
		-- CHC 2484 -- V4.34, Error al extraer informe de todas las consultas JCT 448702384K FIN
		,M.RCC
		,M.Email
		,M.TriajeESI
FROM	PARAMETROS..ParametrosMedicos M
		left join PARAMETROS..Servicios S
			on M.CodServicioMedico= S.Codigo
		left join PARAMETROS..CentrosSalud CS
			on M.CodCentroMed = CS.CodCentro
		--MAIPU -- CHC-2024 -- V4.33, Registro atenciones profesionales no médicos
		left join Parametros..Codigos C
			on C.Codigo	=M.CodRol And C.Tabla='ROLUSUARIO'
		--MAIPU -- CHC-2024 -- V4.33, Fin	
where DNIMedico = @spvar_Dni



SELECT	E.NombreEnf	as NomUsuario,
		E.Apell1Enf	as Apell1Usuario,
		E.Apell2Enf	as Apell2Usuario,
		E.CodServicio	as CodServicioUsuario,
		E.DNIEnf		as DNIUsuario,
		upper(LTrim(RTrim(E.NombreEnf)) + ' ' + RTrim(LTrim(E.Apell1Enf)) + ' ' + Rtrim(LTrim(E.Apell2Enf))) as NombreCompleto,
		E.CodCentroEnf as CodCentroUsuario,
		'e'	as Tipo,
		E.UsuarioEnf as LoginUsuario,
		E.FechaAltaEnf as FechaAlta,
		E.FechaBajaEnf as FechaBaja,
		E.DirigenteEnf as Dirigente,
		E.IncentivosEnf as Incentivos,
		E.PermiteCrearPropuesta as PermiteCrearPropuesta,
		E.EsFisio as EsFisio,
		E.Idioma as Idioma,
		S.DescServicio as DescServicio,
		CS.DescCentro as DescCentro,
		isnull(E.Perfil,'-1') as CodPerfil,
		E.LlaveEnf as Llave,
		--MAIPU -- CHC-2024 -- V4.33, Registro atenciones profesionales no médicos
		-- CHC 2484 -- V4.34, Error al extraer informe de todas las consultas JCT 448702384K INI
		--E.Rol, -- RJF (10/12/08)
		C.Descripcion as Rol,
		-- CHC 2484 -- V4.34, Error al extraer informe de todas las consultas JCT 448702384K INI
		E.CodRol as CodRol,
		--MAIPU -- CHC-2024 -- V4.33, Fin	
		E.IncentivosEnf as TieneIncentivo,
		CD.Descripcion as Colectivo,
		E.ColectivoDUE as CodColectivo,
		E.CodDepartamento as CodDepart,
		E.Nif as NIF,
		E.oldUsuario as OldUser,
		E.OcultaPac as Oculta,
		E.Documentacion as Documentalista,
		-- CHC 2484 -- V4.34, Error al extraer informe de todas las consultas JCT 448702384K INI
		'' as CodMutua
		-- CHC 2484 -- V4.34, Error al extraer informe de todas las consultas JCT 448702384K FIN
		,E.RCC
		,E.Email
		,E.TriajeESI
FROM	PARAMETROS..DatosEnfermeras E
		left join PARAMETROS..Servicios S
			on E.CodServicio = S.Codigo
		left join PARAMETROS..CentrosSalud CS
			on E.CodCentroEnf = CS.CodCentro
		left join Parametros..ColectivoDUE CD
			on E.ColectivoDUE = CD.ColectivoDUE
		--MAIPU -- CHC-2024 -- V4.33, Registro atenciones profesionales no médicos
		left join Parametros..Codigos C
			on C.Codigo	=E.CodRol And C.Tabla='ROLUSUARIO'
		--MAIPU -- CHC-2024 -- V4.33, Fin	
where DNIEnf = @spvar_Dni

GO
GO



--dbo.SpParSMedEnfRol.sql

USE [Parametros]
GO

IF EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[SpParSMedEnfRol]') AND type in (N'P', N'PC'))
DROP PROCEDURE [dbo].[SpParSMedEnfRol]
GO

SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

/****************************************************
PROCEDIMIENTO	: SpParSMedEnfRol
FUNCION			: Seleccionar los Medicos y Enfermeras de acuerdo a su Rol
FECHA			: 25/08/2017
VERSION			: 17.3 - 19248 - Modificaciones en Solicitud de Traslado Externa desde Admision e Historia Clinica
AUTOR			: Marco Polo Ruiz
MODIFICACIÓN	: ASM - 17.3 - 19248 - Pongo RTRIM a nombre y apellidos
****************************************************/

CREATE PROCEDURE [dbo].[SpParSMedEnfRol]

AS 

BEGIN 
	SELECT PM.DNIMedico
		  ,RTRIM(PM.NomMedico) + ' ' + RTRIM(PM.Apell1) + ' ' + RTRIM(PM.Apell2) AS NombreCompletoMed 
		  ,C.Codigo AS CodRol
		  ,C.Descripcion AS Rol
		  ,PM.CodCentroMed AS CodCentro
		  
	FROM Parametros..ParametrosMedicos  PM
	LEFT JOIN Parametros..Codigos C ON C.Codigo = PM.CodRol 
	WHERE 
		C.Tabla='RolUsuario' AND (PM.EliminadoMed IS NULL OR PM.EliminadoMed = 0) AND PM.FBajaMedico IS NULL
	
	SELECT DE.DNIEnf
		  ,RTRIM(DE.NombreEnf) + ' ' + RTRIM(DE.Apell1Enf) + ' ' + RTRIM(DE.Apell2Enf) AS NombreCompletoEnf  
		  ,C.Codigo AS CodRol
		  ,C.Descripcion AS Rol
		  ,DE.CodCentroEnf AS CodCentro
		  
	FROM Parametros..DatosEnfermeras DE
	LEFT JOIN Parametros..Codigos C ON C.Codigo = DE.CodRol 
	WHERE 
		C.Tabla='RolUsuario' AND (DE.EliminadoEnf IS NULL OR DE.EliminadoEnf = 0) AND DE.FechaBajaEnf IS NULL
END

GO

GO



--dbo.SpParSProtocoloPruCodigos.sql

    USE [Parametros];
    GO
    IF EXISTS 
    (
        SELECT * 
            FROM sys.procedures 
            WHERE [object_id] = OBJECT_ID('[dbo].[SpParSProtocoloPruCodigos]')
    )
    BEGIN
        DROP PROCEDURE [dbo].[SpParSProtocoloPruCodigos];
    END
    GO
    

/******************************************************************
* FUNCION			 : SpParSProtocoloPruCodigos
* DEVUELVE			 :
* FECHA				 : 12/11/2008
* VERSION			 : 1.0
* AUTOR				 : Teresa L Fabuel Serrano
* APLICACIÓN ORIGEN  : Florence Gestion Mantenimiento de guias
* MODIFICACIÓN		 : 20/06/2017 - ASM - v17.2r1 - 18428 - Protocolos por centro
********************************************************************/

CREATE PROCEDURE [dbo].[SpParSProtocoloPruCodigos]
	@spvar_CodCentro as CHAR(5) = NULL
AS

IF @spvar_CodCentro IS NULL
BEGIN
	SELECT @spvar_CodCentro = dbo.fnParHospitalReferencia()
END

SELECT 
	CP.CodigoProtocolo, 
	CP.DescProtocolo
FROM 
	CodigosProtPruebas CP
INNER JOIN
	CodigosProtPruebasCentros CPC ON
		CP.CodigoProtocolo = CPC.CodigoProtocolo
Where 
	CPC.CodCentro = @spvar_CodCentro AND
	ISNULL(CPC.Borrado, 0) = 0
 








    GO

GO



--dbo.SpParSProtocolosDiagnostico.sql

USE [Parametros]
GO


IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[SpParSProtocolosDiagnostico]') AND type in (N'P', N'PC'))
DROP PROCEDURE [dbo].[SpParSProtocolosDiagnostico]
GO


SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

/*
PROCEDIMIENTO	: SpParSProtocolosDiagnostico
FUNCION    		: Protocolos asociados a un diagnostico por edad y genero
DEVUELVE		: 
PARAMETRO		: Gnero-> 0 = Mujer, 1= Hombre , 2 = Ambos
				  Edad -> Va configurada de la siguiente manera: 3 primeros caracteres = años, 2 caracteres = meses
				  2 caracteres = dias y 2 caracteres = horas
FECHA			: 04/03/2016
VERSION			: v4.60
AUTOR			: Santiago Gómez Navarro

**************************************************
MODIFICACION	: (22/05/2014) - LMF - v4.60r1 - 3176 - Se modifica la forma de filtrar el genero y la edad	
MODIFICACIÓN	: 20/06/2017 - ASM - v17.2r1 - 18428 - Protocolos por centro
*/

CREATE proc [dbo].[SpParSProtocolosDiagnostico] 
	@spvar_CodDiagnostico as char(6),
	@spvar_TipoEpisodio as int,		
	@spvar_Edad as varchar(9),
	@spvar_Genero as char(1),
	@spvar_CodCentro as CHAR(5) = NULL
AS

IF @spvar_CodCentro IS NULL
BEGIN
	SELECT @spvar_CodCentro = dbo.fnParHospitalReferencia()
END

	BEGIN
	
	-- Convertimos la edad en numero
	SELECT @spvar_Edad = CAST(@spvar_Edad AS INT)
	
	declare @TablaPruebas as table
			(IdProtocolo char(6)
			 ,DiaPrevisto int 
			 ,CodPrueba char(21)
			 ,TipoSolicitud char(1)
			 ,Juicio_Clinico text
			 ,CodSeccion char(2)
			 ,TipoPrueba char(1)
			 ,Examen text
			 ,TipoCitologia char(1)
			 ,CodTopografia char(6)
			 ,CodProcedimiento char(6)
			 ,EsPerfil bit
			 ,CodPerfil char(10)
			 ,FechaPrevista bit
			 ,SolicitaJC bit
			 ,ImprimeSolic bit
			 ,AltoCoste bit
			 ,CodDiagnostico char(6))

	INSERT INTO @TablaPruebas
	SELECT	   IdProtocolo
			  ,DiaPrevisto
			  ,PP.CodPrueba
			  ,TipoSolicitud
			  ,Juicio_Clinico
			  ,CodSeccion
			  ,PP.TipoPrueba
			  ,isnull(Examen,isnull(DesPrueba,AP1.Caracteristicas+', '+AP2.Caracteristicas)) as Examen
			  ,TipoCitologia
			  ,CodTopografia
			  ,CodProcedimiento
			  ,EsPerfil
			  ,NULL
			  ,FechaPrevista
			  ,SolicitaJC	
			  ,ImprimeSolic
			  ,PL.AltoCoste
			  ,@spvar_CodDiagnostico as CodDiagnostico
	FROM 
		CodigosProtPruebasCentros PC
	INNER JOIN
		ProtocolosPruebas PP ON
			PC.IdCodigosProtPruebasCentros = PP.IdCodigoProtPruebasCentros	
			AND (PP.EsPruebaGES = 0 or PP.EsPruebaGES is null)
			AND ((PP.TipoPrueba = 'L' AND PP.EsPerfil = 1) or (PP.TipoPrueba <> 'L'))
	LEFT JOIN 
		DictamenesX DX on DX.Cod_Examen = PP.CodPrueba
	LEFT JOIN 
		PruebasLab PL on PP.CodPrueba = PL.CodPrueba
	LEFT JOIN 
		SNOMED AP1 on AP1.CodigoSNOMED = PP.CodTopografia
	LEFT JOIN 
		SNOMED AP2 on AP2.CodigoSNOMED = PP.CodProcedimiento
	WHERE 
		PC.CodCentro = @spvar_CodCentro AND
		PC.Urgencias = (case when @spvar_TipoEpisodio = 3 then '1' else PC.Urgencias end)
		AND PC.Hospitalizacion = (case when @spvar_TipoEpisodio = 2 then '1' else PC.Hospitalizacion end)
		AND PC.Consultas = (case when @spvar_TipoEpisodio = 1 then '1' else PC.Consultas end)
end

/**************************************************************************************/	
--Actualizamos los perfiles para laboratorio
INSERT INTO @TablaPruebas
SELECT tp.IdProtocolo 
	  ,tp.DiaPrevisto 
	  ,pp.CodPrueba
	  ,tp.TipoSolicitud
	  ,tp.Juicio_Clinico
	  ,NULL
	  ,'L'
	  ,pl.desprueba
	  ,NULL
	  ,NULL
	  ,NULL
	  ,0
	  ,pp.CodPerfil
	  ,tp.FechaPrevista
	  ,tp.SolicitaJC
	  ,tp.ImprimeSolic
	  ,tp.AltoCoste
	  ,@spvar_CodDiagnostico as CodDiagnostico
FROM  @TablaPruebas tp
	 ,PerfilPruebaLab PP
	 ,PruebasLab PL
WHERE tp.EsPerfil = '1'
	  AND (TP.TipoPrueba  <> 'L' OR (TP.TipoPrueba = 'L' AND (TP.EsPerfil = 1 OR (TP.EsPerfil = 0 AND PP.CodPerfil IS NULL))))
	  AND tp.codprueba = pp.codperfil
	  AND pl.codprueba = pp.codprueba
	  AND pl.Estado <> '0'
	  AND pp.Estado <> '0'

UPDATE tp
SET tp.Examen = pl.DesPerfil
FROM @TablaPruebas tp, perfileslab pl
WHERE tp.EsPerfil = '1'
	  AND tp.codprueba = pl.codperfil
/****************************************************************************************************/		  

--Pruebas protocolo de examen
SELECT * FROM @TablaPruebas TP
	INNER JOIN CriteriosInclusionProtocolo CIP ON TP.IdProtocolo = CIP.IdProtocolo
	WHERE CIP.EsExamen = 1
	AND (CAST(CIP.EdadMin AS INT) <= @spvar_Edad AND CAST(CIP.EdadMax AS INT) >= @spvar_Edad)
	AND (CIP.Genero = @spvar_Genero OR CIP.Genero = '2')
	AND CIP.CodDiagnostico = @spvar_CodDiagnostico
	--AND (TP.TipoPrueba  <> 'L' OR (TP.TipoPrueba = 'L' AND (TP.EsPerfil = 1 OR (TP.EsPerfil = 0 AND TP.CodPerfil IS NULL))))
ORDER BY TipoPrueba

/****************************************************************************************************/

--Protocolo de examen
SELECT C.CodigoProtocolo,
       C.DescProtocolo,
       PC.Borrado,
       PC.SolicitaHemoderiv,
       @spvar_CodDiagnostico as CodDiagnostico       
FROM CodigosProtPruebas C
	INNER JOIN
		CodigosProtPruebasCentros PC ON
			C.CodigoProtocolo = PC.CodigoProtocolo AND
			PC.CodCentro = @spvar_CodCentro
	INNER JOIN 
		CriteriosInclusionProtocolo CIP ON 
			C.CodigoProtocolo = CIP.idProtocolo -- CodigoProtocolo = idProtocolo????????
			AND (CAST(CIP.EdadMin AS INT) <= @spvar_Edad AND CAST(CIP.EdadMax AS INT) >= @spvar_Edad)
			AND CIP.EsExamen = 1
			AND (CIP.Genero = @spvar_Genero OR CIP.Genero = '2')
			AND CIP.CodDiagnostico = @spvar_CodDiagnostico
WHERE 
	PC.Urgencias = (case when @spvar_TipoEpisodio = 3 then '1' else PC.Urgencias end)
	AND PC.Hospitalizacion = (case when @spvar_TipoEpisodio = 2 then '1' else PC.Hospitalizacion end)
	AND PC.Consultas = (case when @spvar_TipoEpisodio = 1 then '1' else PC.Consultas end)
	AND exists(SELECT PP.* FROM ProtocolosPruebas PP WHERE PP.IdCodigoProtPruebasCentros = PC.IdCodigosProtPruebasCentros AND PP.EsPruebaGES = 0 or PP.EsPruebaGES is null)
	
/****************************************************************************************************/	
	
	declare @TablaProtocolos as table
			(IdProtocolo varchar(6)
			 ,DescProtocolo varchar(100)
			 ,CodDiagnostico char(6))
	
	INSERT INTO @TablaProtocolos
	SELECT PM.IdProtocolo, PM.DescProtocolo, @spvar_CodDiagnostico as CodDiagnostico
	FROM Farmacias..ProtocoloMed PM
		INNER JOIN CriteriosInclusionProtocolo CIP ON PM.IdProtocolo = CIP.idProtocolo
		LEFT JOIN Oxigenometria O ON PM.CodOxigeno = O.CodOxigeno 
	WHERE CIP.EsExamen = 0
	AND (CAST(CIP.EdadMin AS INT) <= @spvar_Edad AND CAST(CIP.EdadMax AS INT) >= @spvar_Edad )
	AND (CIP.Genero = @spvar_Genero OR CIP.Genero = '2')
	AND CIP.CodDiagnostico = @spvar_CodDiagnostico
		
--Protocolos de Farmacos
	SELECT * FROM @TablaProtocolos	
	
/****************************************************************************************************/	
	
--Cuidados
	
	SELECT
		PC.CodCura As CodCura,
		C. Descripcion As Descripcion
		,Codigo AS IdProtocolo
		,@spvar_CodDiagnostico as CodDiagnostico
	FROM
		Farmacias..FMProtocoloCuras PC
		LEFT JOIN Curas C ON C.CodCura = PC.CodCura
	WHERE
		PC.Codigo IN (SELECT idProtocolo FROM @TablaProtocolos)


	
/****************************************************************************************************/	

--Farmacos
	SELECT
		PF.CodEspecial As IdEspecialidad,
		E.DescEspecialidad + ' (' + rtrim(E.DescPresentacion) + ')' As Medicamento
		,CodProtoFarmaco AS IdProtocolo
		,@spvar_CodDiagnostico as CodDiagnostico
		,E.FecBaja
	FROM
		Farmacias..ProtoMed PF
		INNER JOIN Farmacias..REspecialidad R ON R.IdEspecialidad = PF.CodEspecial	
		INNER JOIN Farmacias..Especialidad E ON E.CodEspec = R.CodEspec
	WHERE
		PF.CodProtoFarmaco IN (SELECT idProtocolo FROM @TablaProtocolos)


	
GO




GO



--dbo.SpParSProtocolosPruebas.sql

    USE [Parametros];
    GO
    IF EXISTS 
    (
        SELECT * 
            FROM sys.procedures 
            WHERE [object_id] = OBJECT_ID('[dbo].[SpParSProtocolosPruebas]')
    )
    BEGIN
        DROP PROCEDURE [dbo].[SpParSProtocolosPruebas];
    END
    GO
    

--	PROCEDIMIENTO	:  SpParSProtocolosPruebas
--	FUNCION			:  Devuelve los datos del protocolo de pruebas para una guia clinica
--	DEVUELVE        :  
--	FECHA           :  08/02/2008
--	VERSION         :  1.0
--	AUTOR           :  Ismael Sampere (Agensys Technology)
--	APLICACIÓN ORIGEN  :  FSelecGuia
--  MODIFICACIONES : Corregida la devolucion de las pruebas del protocolo para guias
--                   Añadida la fecha prevista de la prueba a la descripcion
--					: 02/12/2008 Teresa L . Se cambia IdProtocolo a int, se cruzan procedimientos con CodPrueba y se devuelven Consultas, Urgencias e Ingresos.
--                  : 06/06/2013  MAIPU CHC3115 V4.39 R1 FCB, Comunica a SAP solicitud prueba de Laboratorio de alto coste en urgencias
--	MODIFICACIÓN	:	RRG - 25412344N - 19/08/2013 - CHC3296 - REQ34681 - V4.40 - HEC Requerimiento GES Normativo
--  MODIFICACIÓN	: 20/06/2017 - ASM - v17.2r1 - 18428 - Protocolos por centro

CREATE PROCEDURE [dbo].[SpParSProtocolosPruebas] 
	@spvar_IdProtocolo as int,
	@spvar_CodCentro as CHAR(5) = NULL
AS

IF @spvar_CodCentro IS NULL
BEGIN
	SELECT @spvar_CodCentro = dbo.fnParHospitalReferencia()
END
BEGIN

declare @TablaPruebas as table
		(
		   IdProtocolo int
		  ,DiaPrevisto int 
		  ,CodPrueba char(21)
		  ,TipoSolicitud char(1)
		  ,Juicio_Clinico text
		  ,CodSeccion char(2)
		  ,TipoPrueba char(1)
		  ,Examen text
		  ,TipoCitologia char(1)
		  ,CodTopografia char(6)
		  ,CodProcedimiento char(6)
		  ,EsPerfil bit
		  ,CodPerfil char(10)
		  ,FechaPrevista bit
		  ,SolicitaJC bit
		  ,ImprimeSolic bit
		  ,AltoCoste bit--MAIPU CHC3115 V4.39 R1 FCB, Comunica a SAP solicitud prueba de Laboratorio de alto coste en urgencias
		  --RRG - 25412344N - 19/08/2013 - CHC3296 - REQ34681 - V4.40 - HEC Requerimiento GES Normativo - INI
		  ,MicroLab int
 		  ,ExtracFueraCentro bit
		  ,CodCentroExtrac char(5)
		  ,DescTopografia varchar(100)
		  --RRG - 25412344N - 19/08/2013 - CHC3296 - REQ34681 - V4.40 - HEC Requerimiento GES Normativo - FIN		  
		)


	insert into @TablaPruebas
	SELECT	   IdProtocolo
			  ,DiaPrevisto
			  ,PP.CodPrueba
			  ,TipoSolicitud
			  ,Juicio_Clinico
			  ,CodSeccion
			  ,PP.TipoPrueba
			  ,isnull(Examen,isnull(DesPrueba,AP1.Caracteristicas + ', ' + AP2.Caracteristicas)) + '(' + convert(varchar(10),Dateadd(dd,DiaPrevisto,getdate()),103) + ')' as Examen
			  ,TipoCitologia
			  ,CodTopografia
			  ,CodProcedimiento
			  ,EsPerfil
			  ,NULL
			  ,FechaPrevista
			  ,SolicitaJC	
			  ,ImprimeSolic
			  ,PL.AltoCoste --MAIPU CHC3115 V4.39 R1 FCB, Comunica a SAP solicitud prueba de Laboratorio de alto coste en urgencias
			  ,pp.MicroLab
 			  ,pp.ExtracFueraCentro
			  ,pp.CodCentroExtrac 
			  ,AP1.Caracteristicas  
	FROM 
		CodigosProtPruebasCentros PC
	INNER JOIN
		ProtocolosPruebas PP ON
			PC.IdCodigosProtPruebasCentros = PP.IdCodigoProtPruebasCentros	
	left join 
		dictamenesX DX on DX.Cod_Examen = PP.CodPrueba
	left join 
		PruebasLab PL on PP.CodPrueba = PL.CodPrueba
	left join 
		SNOMED AP1 on AP1.CodigoSNOMED = CodTopografia
	left join 
		SNOMED AP2 on AP2.CodigoSNOMED = PP.CodPrueba
	Where 
		PC.CodigoProtocolo = @spvar_IdProtocolo AND
		PC.CodCentro = @spvar_CodCentro		

/**************************************************************************************/	
--Actualizamos los perfiles para laboratorio

	insert into @TablaPruebas
	select tp.IdProtocolo 
		  ,tp.DiaPrevisto 
		  ,pp.CodPrueba
		  ,tp.TipoSolicitud
		  ,tp.Juicio_Clinico
		  ,NULL
		  ,'L'
		  ,pl.desprueba
		  ,NULL
		  ,NULL
		  ,NULL
		  ,0
		  ,pp.CodPerfil
		  ,tp.FechaPrevista
		  ,tp.SolicitaJC
		  ,tp.ImprimeSolic
		  ,tp.AltoCoste --MAIPU CHC3115 V4.39 R1 FCB, Comunica a SAP solicitud prueba de Laboratorio de alto coste en urgencias
          --RRG - 25412344N - 19/08/2013 - CHC3296 - REQ34681 - V4.40 - HEC Requerimiento GES Normativo - INI
		  ,tp.MicroLab
		  ,tp.ExtracFueraCentro
		  ,tp.CodCentroExtrac
		  ,tp.DescTopografia
		  --RRG - 25412344N - 19/08/2013 - CHC3296 - REQ34681 - V4.40 - HEC Requerimiento GES Normativo - FIN		  
	from @TablaPruebas tp, 
		 PerfilPruebaLab pp,
		 PruebasLab pl
	where tp.EsPerfil = '1'
		  and tp.codprueba = pp.codperfil
		  and pl.codprueba = pp.codprueba
		  and pl.Estado <> '0'
		  and pp.Estado <> '0'

	update tp
	set Examen = DesPerfil
	from @TablaPruebas tp, perfileslab pl
	where EsPerfil = '1'
		  and tp.codprueba = pl.codperfil
/****************************************************************************************************/		  

	select * from @TablaPruebas
	order by TipoPrueba

	SELECT 
		CP.CodigoProtocolo, 
		CP.DescProtocolo, 
		CPC.Borrado,
		CPC.SolicitaHemoderiv, 
		CPC.Consultas, 
		CPC.Urgencias,
		CPC.Hospitalizacion as Ingresos
	FROM 
		CodigosProtPruebas CP
	INNER JOIN
		CodigosProtPruebasCentros CPC ON
			CP.CodigoProtocolo = CPC.CodigoProtocolo AND
			CPC.CodCentro = @spvar_CodCentro
	Where 
		CP.CodigoProtocolo = @spvar_IdProtocolo

			
END


    GO

GO



--dbo.SpParSProtocolosPruebasGES.sql

    USE [Parametros];
    GO
    IF EXISTS 
    (
        SELECT * 
            FROM sys.procedures 
            WHERE [object_id] = OBJECT_ID('[dbo].[SpParSProtocolosPruebasGES]')
    )
    BEGIN
        DROP PROCEDURE [dbo].[SpParSProtocolosPruebasGES];
    END
    GO
    

--	PROCEDIMIENTO		:	SpParSProtocolosPruebasGES
--	FUNCION				:	Devuelve los datos del protocolo de pruebas GES para una guia clinica
--	DEVUELVE			:	 
--	FECHA				:	11/10/2013
--	VERSION				:	1.0
--	AUTOR				:	25412344N Roberto Ramón García
--	APLICACIÓN ORIGEN	:	FAsigPrestacionesGES
--	TRAZABILIDAD		:	RRG - 25412344N - 19/08/2013 - CHC3296 - REQ34681 - V4.40 - HEC Requerimiento GES Normativo
--  MODIFICACIÓN		: 20/06/2017 - ASM - v17.2r1 - 18428 - Protocolos por centro


CREATE PROCEDURE [dbo].[SpParSProtocolosPruebasGES] 
	@spvar_IdProtocolo as int,
	@spvar_CodCentro as CHAR(5) = NULL
AS

IF @spvar_CodCentro IS NULL
BEGIN
	SELECT @spvar_CodCentro = dbo.fnParHospitalReferencia()
END
BEGIN

declare @TablaPruebas as table
		(
		   IdProtocolo int
		  ,DiaPrevisto int 
		  ,CodPrueba char(21)
		  ,TipoSolicitud char(1)
		  ,Juicio_Clinico text
		  ,CodSeccion char(2)
		  ,TipoPrueba char(1)
		  ,Examen text
		  ,TipoCitologia char(1)
		  ,CodTopografia char(6)
		  ,CodProcedimiento char(6)
		  ,EsPerfil bit
		  ,CodPerfil char(10)
		  ,FechaPrevista bit
		  ,SolicitaJC bit
		  ,ImprimeSolic bit
		  ,AltoCoste bit--MAIPU CHC3115 V4.39 R1 FCB, Comunica a SAP solicitud prueba de Laboratorio de alto coste en urgencias
		  --RRG - 25412344N - 19/08/2013 - CHC3296 - REQ34681 - V4.40 - HEC Requerimiento GES Normativo - INI
		  ,MicroLab int
 		  ,ExtracFueraCentro bit
		  ,CodCentroExtrac char(5)
		  ,DescTopografia varchar(100)
		  --RRG - 25412344N - 19/08/2013 - CHC3296 - REQ34681 - V4.40 - HEC Requerimiento GES Normativo - FIN		  
		)


	insert into @TablaPruebas
	SELECT	   IdProtocolo
			  ,DiaPrevisto
			  ,PP.CodPrueba
			  ,TipoSolicitud
			  ,Juicio_Clinico
			  ,CodSeccion
			  ,PP.TipoPrueba
			  ,isnull(Examen,isnull(DesPrueba,AP1.Caracteristicas + ', ' + AP2.Caracteristicas)) + '(' + convert(varchar(10),Dateadd(dd,DiaPrevisto,getdate()),103) + ')' as Examen
			  ,TipoCitologia
			  ,CodTopografia
			  ,CodProcedimiento
			  ,EsPerfil
			  ,NULL
			  ,FechaPrevista
			  ,SolicitaJC	
			  ,ImprimeSolic
			  ,PL.AltoCoste --MAIPU CHC3115 V4.39 R1 FCB, Comunica a SAP solicitud prueba de Laboratorio de alto coste en urgencias
	  		  --RRG - 25412344N - 19/08/2013 - CHC3296 - REQ34681 - V4.40 - HEC Requerimiento GES Normativo - INI
			  ,pp.MicroLab
 			  ,pp.ExtracFueraCentro
			  ,pp.CodCentroExtrac 
			  ,AP1.Caracteristicas
		  --RRG - 25412344N - 19/08/2013 - CHC3296 - REQ34681 - V4.40 - HEC Requerimiento GES Normativo - FIN		  
	FROM 
		CodigosProtPruebasCentros PC
	INNER JOIN
		ProtocolosPruebas PP ON
			PC.IdCodigosProtPruebasCentros = PP.IdCodigoProtPruebasCentros	
	left join 
		dictamenesX DX on DX.Cod_Examen = PP.CodPrueba
	left join 
		PruebasLab PL on PP.CodPrueba = PL.CodPrueba
	left join 
		SNOMED AP1 on AP1.CodigoSNOMED = CodTopografia
	left join 
		SNOMED AP2 on AP2.CodigoSNOMED = PP.CodPrueba
	Where 
		PP.IdProtocolo = @spvar_IdProtocolo   
		AND PC.CodCentro = @spvar_CodCentro			
		AND PP.EsPruebaGES = 1


/**************************************************************************************/	
--Actualizamos los perfiles para laboratorio

	insert into @TablaPruebas
	select tp.IdProtocolo 
		  ,tp.DiaPrevisto 
		  ,pp.CodPrueba
		  ,tp.TipoSolicitud
		  ,tp.Juicio_Clinico
		  ,NULL
		  ,'L'
		  ,pl.desprueba
		  ,NULL
		  ,NULL
		  ,NULL
		  ,0
		  ,pp.CodPerfil
		  ,tp.FechaPrevista
		  ,tp.SolicitaJC
		  ,tp.ImprimeSolic
		  ,tp.AltoCoste --MAIPU CHC3115 V4.39 R1 FCB, Comunica a SAP solicitud prueba de Laboratorio de alto coste en urgencias
		  ,tp.MicroLab
		  ,tp.ExtracFueraCentro
		  ,tp.CodCentroExtrac
		  ,tp.DescTopografia	  
	from @TablaPruebas tp, 
		 PerfilPruebaLab pp,
		 PruebasLab pl
	where tp.EsPerfil = '1'
		  and tp.codprueba = pp.codperfil
		  and pl.codprueba = pp.codprueba
		  and pl.Estado <> '0'
		  and pp.Estado <> '0'
		  
	update tp
	set Examen = DesPerfil
	from @TablaPruebas tp, perfileslab pl
	where EsPerfil = '1'
		  and tp.codprueba = pl.codperfil
/****************************************************************************************************/		  

	select * from @TablaPruebas
	order by TipoPrueba

	SELECT 
		CP.CodigoProtocolo, 
		CP.DescProtocolo, 
		CPC.Borrado,
		CPC.SolicitaHemoderiv, 
		CPC.Consultas, 
		CPC.Urgencias,
		CPC.Hospitalizacion as Ingresos
	FROM 
		CodigosProtPruebas CP
	INNER JOIN
		CodigosProtPruebasCentros CPC ON
			CP.CodigoProtocolo = CPC.CodigoProtocolo AND
			CPC.CodCentro = @spvar_CodCentro
	Where 
		CP.CodigoProtocolo = @spvar_IdProtocolo
		AND EXISTS(SELECT PP.* FROM ProtocolosPruebas PP WHERE PP.IdCodigoProtPruebasCentros=CPC.IdCodigosProtPruebasCentros and PP.EsPruebaGES=1)
			
END


    GO

GO



--dbo.SpParSProtocolosPruebasGuiasCodigos.sql

    USE [Parametros];
    GO
    IF EXISTS 
    (
        SELECT * 
            FROM sys.procedures 
            WHERE [object_id] = OBJECT_ID('[dbo].[SpParSProtocolosPruebasGuiasCodigos]')
    )
    BEGIN
        DROP PROCEDURE [dbo].[SpParSProtocolosPruebasGuiasCodigos];
    END
    GO
    

/******************************************************************
* FUNCION			 : SpParSProtocolosPruebasGuiasCodigos
* DEVUELVE			 :
* FECHA				 : 25/11/2008
* VERSION			 : 1.0
* AUTOR				 : Teresa L Fabuel Serrano
* APLICACIÓN ORIGEN  : Florence Gestion Mantenimiento de guias
********************************************************************/
/*
* MODIFICACION:	(26/09/2016) v4.64 - 13035 - SGH - Mejorar protocolo de pruebas
* MODIFICACIÓN: 20/06/2017 - ASM - v17.2r1 - 18428 - Protocolos por centro
*/

CREATE PROCEDURE [dbo].[SpParSProtocolosPruebasGuiasCodigos]

@spvar_CodCentro AS CHAR(5) = NULL
AS

IF @spvar_CodCentro IS NULL
BEGIN
	SELECT @spvar_CodCentro = dbo.fnParHospitalReferencia()
END

SELECT 
	P.CodigoProtocolo as Codigo, 
	P.DescProtocolo as Descripcion, 
	PC.Consultas,
	PC.Hospitalizacion, 
	PC.Urgencias
FROM 
	CodigosProtPruebas P
INNER JOIN
	CodigosProtPruebasCentros PC ON
		P.CodigoProtocolo = PC.CodigoProtocolo AND
		PC.CodCentro = @spvar_CodCentro














    GO

GO



--dbo.SpParSProtocolosPruebasTodos.sql

USE [Parametros]
GO
IF EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[SpParSProtocolosPruebasTodos]') AND type in (N'P', N'PC'))
	DROP PROCEDURE [dbo].[SpParSProtocolosPruebasTodos]
GO
    
-- PROCEDIMIENTO	 : SpParSProtocolosPruebasTodos
-- FUNCION			 : Devuelve los datos de los protocolos de pruebas
-- DEVUELVE          :
-- FECHA             : 17/07/2008
-- VERSION           : 1.0
-- AUTOR             : Ismael Sampere (Agensys Technology)
-- APLICACIÓN ORIGEN : HClinica.FProtocolPruebas
-- MODIFICACION      : (23/07/2008) Ismael Filtro por tipo de episodio
-- MODIFICACION		 : (24/07/2008) Ismael Filtro para abrir solicitud de hemoderivados
-- MODIFICACION	     : (11/08/2008) Ismael Filtro para imprimir solicitudes
-- MODIFICACION      : (06/06/2013) MAIPU CHC3115 V4.39 R1 FCB, Comunica a SAP solicitud prueba de Laboratorio de alto coste en urgencias (entregada en CHC3298 v4.40)
-- MODIFICACION		 : (08/10/2013) RRG - 25412344N - CHC3575 - REQ34681 - V4.40 - HEC Requerimiento GES Normativo
-- MODIFICACION      : (12/11/2015) Alberto Pagán Benedicto - V4.56 - 2640 - APB - Modificación de Módulo de Laboratorio
-- MODIFICACION	     : (26/09/2016) v4.64 - 13035 - SGH - Mejorar protocolo de pruebas
-- MODIFICACION	     : (14/10/2016) v4.64r1 - 13650 - SGH - Observaciones Mejora en mantenimiento de protocolos de pruebas
-- MODIFICACIÓN		 : 20/06/2017 - ASM - v17.2r1 - 18428 - Protocolos por centro

CREATE PROCEDURE [dbo].[SpParSProtocolosPruebasTodos]
	@spvar_TipoEpisodio as int, --(3) Urgencias - (2) Hospitalizacion - (1) Consultas
	@spvar_CodCentro as CHAR(5) = NULL
AS

IF @spvar_CodCentro IS NULL
BEGIN
	SELECT @spvar_CodCentro = dbo.fnParHospitalReferencia()
END

BEGIN
	declare @TablaPruebas as table
			(IdProtocolo char(6)
			 ,DiaPrevisto int 
			 ,CodPrueba char(21)
			 ,TipoSolicitud char(1)
			 ,Juicio_Clinico text
			 ,CodSeccion char(2)
			 ,TipoPrueba char(1)
			 ,Examen text
			 ,TipoCitologia char(1)
			 ,CodTopografia char(6)
			 ,CodProcedimiento char(6)
			 ,EsPerfil bit
			 ,CodPerfil char(10)
			 ,FechaPrevista bit
			 ,SolicitaJC bit
			 ,ImprimeSolic bit
			 ,AltoCoste bit)

	INSERT INTO
		@TablaPruebas
	SELECT	   
		IdProtocolo
		,DiaPrevisto
		,PP.CodPrueba
		,TipoSolicitud
		,Juicio_Clinico
		,CodSeccion
		,PP.TipoPrueba
		,isnull(Examen,isnull(DesPrueba,AP1.Caracteristicas+', '+AP2.Caracteristicas)) as Examen
		,TipoCitologia
		,CodTopografia
		,CodProcedimiento
		,EsPerfil
		,NULL
		,FechaPrevista
		,SolicitaJC	
		,ImprimeSolic
		,PL.AltoCoste
	FROM
		CodigosProtPruebasCentros PC
	INNER JOIN
		ProtocolosPruebas PP ON
			PC.IdCodigosProtPruebasCentros = PP.IdCodigoProtPruebasCentros	
	left join 
		DictamenesX DX on DX.Cod_Examen = PP.CodPrueba
	left join 
		PruebasLab PL on PP.CodPrueba = PL.CodPrueba
	left join 
		SNOMED AP1 on AP1.CodigoSNOMED = PP.CodTopografia
	left join 
		SNOMED AP2 on AP2.CodigoSNOMED = PP.CodPrueba
	where 
	    PC.CodCentro = @spvar_CodCentro AND
		PC.Urgencias = (case when @spvar_TipoEpisodio = 3 then '1' else PC.Urgencias end)
		and PC.Hospitalizacion = (case when @spvar_TipoEpisodio = 2 then '1' else PC.Hospitalizacion end)
		and PC.Consultas = (case when @spvar_TipoEpisodio = 1 then '1' else PC.Consultas end)
	    and (PP.EsPruebaGES = 0 or PP.EsPruebaGES is null)
	    and ((PP.TipoPrueba = 'L' and PP.EsPerfil = 1) or (PP.TipoPrueba <> 'L'))
	    and ISNULL(PC.Borrado, 0) = 0

end

/**************************************************************************************/	
--Actualizamos los perfiles para laboratorio
insert into @TablaPruebas
select tp.IdProtocolo 
	  ,tp.DiaPrevisto 
	  ,pp.CodPrueba
	  ,tp.TipoSolicitud
	  ,tp.Juicio_Clinico
	  ,NULL
	  ,'L'
	  ,pl.desprueba
	  ,NULL
	  ,NULL
	  ,NULL
	  ,0
	  ,pp.CodPerfil
	  ,tp.FechaPrevista
	  ,tp.SolicitaJC
	  ,tp.ImprimeSolic
	  ,tp.AltoCoste
from  @TablaPruebas tp
	 ,PerfilPruebaLab pp
	 ,PruebasLab pl
where tp.EsPerfil = '1'
	  and tp.codprueba = pp.codperfil
	  and pl.codprueba = pp.codprueba
	  and pl.Estado <> '0'
	  and pp.Estado <> '0'

update tp
set tp.Examen = pl.DesPerfil
from @TablaPruebas tp, perfileslab pl
where tp.EsPerfil = '1'
	  and tp.codprueba = pl.codperfil
/****************************************************************************************************/		  

select * from @TablaPruebas
order by TipoPrueba

select C.CodigoProtocolo,
       C.DescProtocolo,
       PC.Borrado,
       PC.SolicitaHemoderiv
from 
	CodigosProtPruebas C
INNER JOIN
	CodigosProtPruebasCentros PC ON
		C.CodigoProtocolo = PC.CodigoProtocolo AND
		PC.CodCentro = @spvar_CodCentro
where 
	PC.Urgencias = (case when @spvar_TipoEpisodio = 3 then '1' else PC.Urgencias end)
	and PC.Hospitalizacion = (case when @spvar_TipoEpisodio = 2 then '1' else PC.Hospitalizacion end)
	and PC.Consultas = (case when @spvar_TipoEpisodio = 1 then '1' else PC.Consultas end)
    and exists(select PP.* from ProtocolosPruebas PP where PP.IdCodigoProtPruebasCentros = PC.IdCodigosProtPruebasCentros and PP.EsPruebaGES = 0 or PP.EsPruebaGES is null)
	and ISNULL(C.Borrado,'0') = '0'

GO
GO



--dbo.SpParSSolicitudTrasladoAcompanyante.sql

USE [Parametros]
GO

IF EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[SpParSSolicitudTrasladoAcompanyante]') AND type in (N'P', N'PC'))
DROP PROCEDURE [dbo].[SpParSSolicitudTrasladoAcompanyante]
GO

/****************************************************
PROCEDIMIENTO	: SpParSSolicitudTrasladoAcompanyante
FUNCION			: Seleccionar todos los campos de la tabla SolicitudTrasladoAcompanyante
FECHA			: 25/08/2017
VERSION			: 17.3 - 19248 - Modificaciones en Solicitud de Traslado Externa desde Admision e Historia Clinica
AUTOR			: Marco Polo Ruiz
****************************************************/

CREATE PROCEDURE [dbo].[SpParSSolicitudTrasladoAcompanyante]
    @spvar_CodCentro char(5)=NULL

AS 

BEGIN 
	SELECT IdAcompanyante, CodAcompanyante, DescAcompanyante, Orden, CodCentro
		  
	FROM Parametros..SolicitudTrasladoAcompanyante
	WHERE 
		CodCentro=ISNULL(@spvar_CodCentro,CodCentro) AND Eliminado <> 1
	ORDER BY Orden ASC
END

GO
GO



--dbo.SpParSTurnosInfQuirurgico.sql

USE [Parametros];
GO
IF EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[SpParSTurnosInfQuirurgico]') AND type in (N'P', N'PC'))
	DROP PROCEDURE [dbo].[SpParSTurnosInfQuirurgico]
GO

/****************************************************
PROCEDIMIENTO	: SpParSTurnosInfQuirurgico
FUNCION			: Obtener los Turnos Quirurgicos
FECHA			: 02/08/2017
VERSION			: 17.3 - 16153
AUTOR			: Marco Polo Ruiz
****************************************************/
CREATE PROCEDURE [dbo].[SpParSTurnosInfQuirurgico]
AS

SELECT idTurnoInfQuirurgico,
       CodCentro,
       Descripcion,
	   Orden
FROM Parametros..TurnosInfQuirurgico
ORDER BY Orden

GO
GO



--dbo.SpParSValidaContrasenya.sql

USE [Parametros]
GO

IF EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[SpParSValidaContrasenya]') AND type in (N'P', N'PC'))
	DROP PROCEDURE [dbo].[SpParSValidaContrasenya]
GO
  
-- =============================================
-- Author:		Ismael Sampere
-- Create date: 05/05/2010
-- Description:	Valida la contraseña de un usuario de Florence y devuelve sus datos
-- MODIFICACION: (05/10/2012) Fran Cuenca MAIPU -- CHC-2024 -- V4.33, Registro atenciones profesionales no médicos
-- MODIFICACION: (15/05/2015) - v4.51 - 1620 - APB - Integración LME
-- MODIFICACION: (29/09/2016) - v4.65 - 13406 - MMM - Acceso mediante lista blanca Florence
-- MODIFICACIÓN: (09/02/2017) - v4.68 - 15136 - DVR - Auditoría de cambio de contraseñas y comunicación al usuario mediante mail 
-- MODIFICACIÓN: (29/06/2017 - V17.2r1 - 18277 - SGH - Triaje ESI 
-- =============================================
CREATE PROCEDURE [dbo].[SpParSValidaContrasenya]
	 @spvar_Usuario as varchar(30)
	,@spvar_Contrasenya as varchar(8)
AS

BEGIN
	SELECT	 PM.CodServicioMedico AS CodServicio
			,PM.DNIMedico AS DNI
			,RTrim(PM.NomMedico) AS Nombre
			,RTrim(PM.Apell1) AS Apell1
			,RTrim(PM.Apell2) AS Apell2
			,'M' AS Tipo
			,Convert(char(10),PM.FechaLlaveMed,103) AS FechaLlave
			,PH.ValidezClaves
			,PM.NumColegMed AS NumColeg
			,PM.CodSeccionMed
			,CS.CodMDiagnostico
			,PM.Idioma1 AS Idioma
			,PM.NecUsPACS
			,PM.URLPrinc 
			,PM.TipoRadiologo
			,isnull(PM.TelefonoMovil,'') AS TelefonoMovil
			,isnull(PM.AceptaSMS,0) AS AceptaSMS
			,NULL AS PermiteCrearRayos
			,PM.ConsultorExterno
			,PM.CodCentroMed AS CodCentro
			,PM.OcultaPac
			--MAIPU -- CHC-2024 -- V4.33, Registro atenciones profesionales no médicos
			,CD.Descripcion AS DescRol
			,PM.rol
			,PM.CodRol			
			--MAIPU -- CHC-2024 -- V4.33, Fin
			,PM.Nif --(15/05/2015) - v4.51 - 1620 - APB - Integración LME
			,UsuGenerico
			,PM.Email
			,PM.UsuarioMedico as Login
			,PM.TriajeESI
	FROM	Parametros.dbo.ParametrosMedicos PM
			LEFT JOIN Parametros.dbo.CodSecciones CS on PM.CodSeccionMed = CS.CodSec
			--MAIPU -- CHC-2024 -- V4.33, Registro atenciones profesionales no médicos
			LEFT JOIN Parametros..Codigos CD on (CD.Codigo = PM.CodRol) and CD.Tabla = 'ROLUSUARIO',
			--MAIPU -- CHC-2024 -- V4.33, Fin
			Parametros.dbo.ParametrosHospital PH

	WHERE	PM.LlaveMedico LIKE @spvar_Contrasenya + '%'
			and PM.UsuarioMedico = @spvar_Usuario
			and PM.EliminadoMed IS NULL

	UNION

	SELECT	 TD.CodSeccionTecnico AS CodServicio
			,TD.DNITecnico AS DNI
			,TD.NombreTecnico AS Nombre
			,TD.Apell1Tecnico AS Apell1
			,TD.Apell2Tecnico AS Apell2
			,'T' AS Tipo
			,Convert(char(10),TD.FechaLlaveTecn,103) AS FechaLlave
			,PH.ValidezClaves
			,NULL AS NumColeg
			,TD.CodSeccionTecnico AS CodSeccionMed
			,CS.CodMDiagnostico AS CodMDiagnostico
			,TD.Idioma
			,TD.NecUsPACS
			,TD.URLPrinc
			,TD.tiporadiologo
			,'' AS TelefonoMovil
			,0 AS AceptaSMS
			,NULL AS PermiteCrearRayos
			,NULL AS ConsultorExterno
			,TD.CodCentroTecnico AS CodCentro
			,TD.OcultaPac
			--MAIPU -- CHC-2024 -- V4.33, Registro atenciones profesionales no médicos
			,CD.Descripcion AS DescRol
			,TD.rol
			,TD.CodRol
			--MAIPU -- CHC-2024 -- V4.33, Fin
			,TD.Nif --(15/05/2015) - v4.51 - 1620 - APB - Integración LME
			,UsuGenerico
			,TD.Email
			,TD.UsuarioTecnico as Login
			,TD.TriajeESI
	FROM	Parametros.dbo.TecnicosDatos TD 
			LEFT JOIN Parametros.dbo.CodSecciones CS on TD.CodSeccionTecnico = CS.CodSec
			--MAIPU -- CHC-2024 -- V4.33, Registro atenciones profesionales no médicos
			LEFT JOIN Parametros..Codigos CD on (CD.Codigo = TD.CodRol) and CD.Tabla = 'ROLUSUARIO',
			--MAIPU -- CHC-2024 -- V4.33, Fin
			Parametros.dbo.ParametrosHospital PH

	WHERE	TD.LlaveTecnico LIKE @spvar_Contrasenya + '%'
			and TD.UsuarioTecnico = @spvar_Usuario
			and TD.EliminadoTecnico IS NULL

	UNION

	SELECT	 isnull(DE.CodServicio,'AC') AS CodServicio
			,DE.DNIEnf AS DNI
			,RTrim(DE.NombreEnf) AS Nombre
			,RTrim(DE.Apell1Enf) AS Apell1
			,RTrim(DE.Apell2Enf) AS Apell2
			,'E' AS Tipo
			,Convert(char(10),DE.FechaLlaveEnf,103) AS FechaLlave
			,PH.ValidezClaves
			,NULL AS NumColeg
			,NULL AS CodSeccionMed
			,NULL AS CodMDiagnostico
			,DE.Idioma AS Idioma
			,0 AS NecUsPACS
			,1 AS URLPrinc
			,DE.tiporadiologo
			,'' AS TelefonoMovil
			,0 AS AceptaSMS
			,NULL AS PermiteCrearRayos
			,NULL AS ConsultorExterno
			,DE.CodCentroEnf AS CodCentro
			,DE.OcultaPac
			--MAIPU -- CHC-2024 -- V4.33, Registro atenciones profesionales no médicos
			,CD.Descripcion AS DescRol
			,DE.rol
			,DE.CodRol
			--MAIPU -- CHC-2024 -- V4.33, Fin
			,DE.Nif --(15/05/2015) - v4.51 - 1620 - APB - Integración LME
			,UsuGenerico
			,DE.Email
			,DE.UsuarioEnf as Login
			,DE.TriajeESI
	FROM	Parametros.dbo.DatosEnfermeras DE
			--MAIPU -- CHC-2024 -- V4.33, Registro atenciones profesionales no médicos
			LEFT JOIN Parametros..Codigos CD on (CD.Codigo = DE.CodRol) and CD.Tabla = 'ROLUSUARIO',
			--MAIPU -- CHC-2024 -- V4.33, Fin
			Parametros.dbo.ParametrosHospital PH

	WHERE	DE.LlaveEnf LIKE @spvar_Contrasenya + '%'
			and DE.UsuarioEnf = @spvar_Usuario
			and DE.EliminadoEnf IS NULL

	UNION

	SELECT	 NULL AS CodServicio
			,A.DNIAdminist AS DNI
			,RTrim(A.NomAdminis) AS Nombre
			,RTrim(A.Apell1Administ) AS Apell1
			,RTrim(A.Apell2Administ) AS Apell2
			,'A' AS Tipo
			,Convert(char(10),A.FLlaveAdminist,103) AS FechaLlave
			,PH.ValidezClaves
			,NULL AS NumColeg
			,NULL AS CodSeccionMed
			,NULL AS CodMDiagnostico
			,A.Idioma AS Idioma
			,0 AS NecUsPACS
			,1 AS URLPrinc
			,A.tipoRadiologo
			,'' AS TelefonoMovil
			,0 AS AceptaSMS
			,A.PermiteCrearRayos
			,NULL AS ConsultorExterno
			,A.CodCentroAdminist AS CodCentro
			,A.OcultaPac
			--MAIPU -- CHC-2024 -- V4.33, Registro atenciones profesionales no médicos
			,CD.Descripcion AS DescRol
			,A.Rol
			,A.CodRol
			--MAIPU -- CHC-2024 -- V4.33, Fin
			,A.Nif --(15/05/2015) - v4.51 - 1620 - APB - Integración LME
			,UsuGenerico
			,A.Email
			,A.UsuarioAdminis as Login
			,A.TriajeESI
	FROM	Parametros.dbo.Administrativo A
			--MAIPU -- CHC-2024 -- V4.33, Registro atenciones profesionales no médicos
			LEFT JOIN Parametros..Codigos CD on (CD.Codigo = A.CodRol) and CD.Tabla = 'ROLUSUARIO',
			--MAIPU -- CHC-2024 -- V4.33, Fin
			Parametros.dbo.ParametrosHospital PH

	WHERE	A.LlaveAdminist LIKE @spvar_Contrasenya + '%'
			and A.UsuarioAdminis = @spvar_Usuario
			and A.EliminadoAdminist IS NULL
END

GO
GO



--dbo.SpParUActualizaAdminist.sql

USE [Parametros];
GO
IF EXISTS 
(
    SELECT * 
        FROM sys.procedures 
        WHERE [object_id] = OBJECT_ID('[dbo].[SpParUActualizaAdminist]')
)
BEGIN
    DROP PROCEDURE [dbo].[SpParUActualizaAdminist];
END
GO

/*********************************************************************
* FUNCION: Se modifican los datos de los administrativos
* ENTRADA: 
*			DNI del administrativo
*			Nombre
*			Apellidos
*			Login
*			Password -> opcional: si no se introduce se conserva el existente
*			Perfil del administrativo
*			Idioma1
*			Centro
* DEVUELVE: 
* FECHA: 22/09/2008
* VERSION: 1.0
* AUTOR: Joaquín Gras Gómez (Agensys)
* ORIGEN: Gestión de usuarios
*******************************************************************
* AUTOR: Manuel Mas Asencio
* FECHA: 19/11/2008
* MODIFICACION: Si no es un usuario de sólo lectura 
*				se le añade el servicio '01'
*******************************************************************
* FECHA: 09/12/2008
* AUTOR: Ramon Jimenez (Mecemsa)
* MODIFICACION: Se añade a la update los campos 'Foto' y 'Rol'.
*******************************************************************
* FECHA: 12/12/2008
* AUTOR: Ramon Jimenez (Mecemsa)
* MODIFICACION: Se comprueba mediante ActualizaPerfil si hay que actualizar los permisos o no.
*******************************************************************
* FECHA: 30/07/2009
* AUTOR: Joaquín Aniorte
* MODIFICACION: Actualiza el DNI
'*******************************************************************
* FECHA: 11/01/2010
* AUTOR: Miguel Ángel Utiel Peñaranda
* MODIFICACION: Actualización del Código de departamento y no se actualicen los permisos
*******************************************************************
* FECHA: 09/01/2010
* AUTOR: Miguel Ángel Utiel Peñaranda
* MODIFICACION: Añadido la actualización del campo OculpaPac
*******************************************************************
* FECHA: 18/03/2010
* AUTOR: Miguel Ángel Utiel
* MODIFICACION: Añadido el campo Documentalista
**************************************************************************************
* MODIFICACION: (14/05/2010) Luis Merle. Añadido el campo PermisosIndicadores
* MODIFICACION: (29/11/2010) Miguel Ángel Utiel. Se guarde el servicio del administrativo seleccionado desde Florence
* MODIFICACION: (02/02/2011) Ramón Jiménez. Si es un update de contraseña, solo actualizamos la clave y la fecha de la llave.
* MODIFICACION: (18/02/2011) Alejandro Palazón. Añadido el campo ConsultorExterno
* MODIFICACION: (24/02/2011) Alejandro Palazón. Añadido el campo CodMutua
* MODIFICACION: (05/10/2012) Fran Cuenca MAIPU -- CHC-2024 -- V4.33, Registro atenciones profesionales no médicos
* MODIFICACIÓN: (21/05/2013) Alfredo - CHC3064 - 4.37 - Añado FAlta
* MODIFICACIÓN: (26/05/2016) - V4.62 – 3248 – DCR - Se agrega el CambioClave=1 del usuario al UPDATE ParametrosMedicos cuando hay password
* MODIFICACIÓN: (03/10/2016) - V4.65 – 13406 – MMM - Acceso mediante lista blanca Florence 
* MODIFICACIÓN: (09/02/2017) - V4.68 - 15136 - DVR - Auditoría de cambio de contraseñas y comunicación al usuario mediante mail 
* MODIFICACIÓN: (29/06/2017) - V17.2r1 - 18277 - SGH - Triaje ESI 
**************************************************************************************/

CREATE PROCEDURE [dbo].[SpParUActualizaAdminist]
	 @spvar_DNI char(8)
	,@spvar_Nombre char(15)
	,@spvar_Apell1 char(15)
	,@spvar_Apell2 char(15)
	,@spvar_Login varchar(30)
	,@spvar_Passwd varchar(50) = null
	,@spvar_Perfil int
	,@spvar_Idioma1 char(5)
	,@spvar_CodCentro char(5)
	--MAIPU -- CHC-2024 -- V4.33, Registro atenciones profesionales no médicos
	,@spvar_Rol varchar(25) = null
	,@spvar_CodRol char(2) = null
	--MAIPU -- CHC-2024 -- V4.33, Fin
	,@spvar_Foto image = null
	,@spvar_ActualizaPerfil bit = null
	,@spvar_CodDepart int = 0
	,@spvar_nif char(9) = null
	,@spvar_Oculta bit = 0
	,@spvar_Documentalista bit = 0
	,@spvar_PermisosIndicadores int = 0
	,@spvar_CodServicioAdminist char(4) = null
	,@spvar_ConsultorExterno bit = 0
	,@spvar_CodMutua char(5) = null
	,@FAlta smalldatetime = null --Alfredo - CHC3064
	,@spvar_UsuGenerico bit = 0
	,@spvar_Email varchar(100)= null
	,@spvar_TriajeESI bit = null
AS
BEGIN

	declare @PermiteCrearRayos bit

	if @spvar_CodServicioAdminist is null
	begin
		if @spvar_Perfil <> '47'
			select @spvar_CodServicioAdminist = '01'
		else
			select @spvar_CodServicioAdminist = null
	end

	if @spvar_Perfil = '49' -- Si es administrativo de rayos, poner el bit en la tabla a 1
		select @PermiteCrearRayos = 1
	else
		select @PermiteCrearRayos = 0

	IF @spvar_Passwd is null
	BEGIN
		UPDATE Administrativo
		SET  NomAdminis = @spvar_Nombre
			,Apell1Administ = @spvar_Apell1
			,Apell2Administ = @spvar_Apell2
			,UsuarioAdminis = @spvar_Login
			,Perfil = @spvar_Perfil
			,Idioma = @spvar_Idioma1
			,CodCentroAdminist = @spvar_CodCentro
			,PermiteCrearRayos = @PermiteCrearRayos
			,CodServicioAdminist = @spvar_CodServicioAdminist
			--MAIPU -- CHC-2024 -- V4.33, Registro atenciones profesionales no médicos
			,Rol = @spvar_Rol -- RJF (10/12/08)
			,CodRol = @spvar_CodRol
			--MAIPU -- CHC-2024 -- V4.33, Fin
			,Foto = @spvar_Foto -- RJF (10/12/08)
			,CodDepartamento = @spvar_CodDepart
			,Nif = @spvar_nif
			,OcultaPac = @spvar_Oculta
			,Documentacion = @spvar_Documentalista
			,PermisosIndicadores = @spvar_PermisosIndicadores
			,ConsultorExterno = @spvar_ConsultorExterno
			,CodMutua = @spvar_CodMutua
			,FAltaAdminist = ISNULL(@FAlta,FAltaAdminist) --Alfredo - CHC3064
			,UsuGenerico = @spvar_UsuGenerico
			,Email = @spvar_Email
			,TriajeESI = ISNULL(@spvar_TriajeESI,TriajeESI)
		WHERE DNIAdminist = @spvar_DNI
	END
	ELSE
	BEGIN
		UPDATE Administrativo
		SET  LlaveAdminist = @spvar_Passwd
			,FLlaveAdminist = GETDATE()
			,CambioClave = 1
		WHERE DNIAdminist = @spvar_DNI	
	END

END
GO



--dbo.SpParUActualizaEnfermera.sql

USE [Parametros];
GO
IF EXISTS 
(
    SELECT * 
        FROM sys.procedures 
        WHERE [object_id] = OBJECT_ID('[dbo].[SpParUActualizaEnfermera]')
)
BEGIN
    DROP PROCEDURE [dbo].[SpParUActualizaEnfermera];
END
GO

/*********************************************************************
* FUNCION: Se modifican los datos de las enfermeras
* ENTRADA: 
*			DNI de la enfermera
*			Nombre
*			Apellidos
*			Login
*			Password -> opcional: si no se introduce se conserva el existente
*			Perfil de la enfermera
*			Idioma1
*			Centro
* DEVUELVE: 
* FECHA: 22/09/2008
* VERSION: 1.0
* AUTOR: Joaquín Gras Gómez (Agensys)
* ORIGEN: Gestión de usuarios
'*******************************************************************
* FECHA: 09/12/2008
* AUTOR: Ramon Jimenez (Mecemsa)
* MODIFICACION: Se añade a la update los campos 'Foto' y 'Rol'.
*******************************************************************
* FECHA: 12/12/2008
* AUTOR: Ramon Jimenez (Mecemsa)
* MODIFICACION: Se comprueba mediante ActualizaPerfil si hay que actualizar los permisos o no.
*******************************************************************
* FECHA: 08/05/2009
* AUTOR: Curro Rosado (Agensys Technology)
* MODIFICACION: Se añade el campo CodServicio.
*******************************************************************
* FECHA: 30/07/2009
* AUTOR: Joaquín Aniorte
* MODIFICACION: Se añaden los campos ColectivoDue, Incentivos y DNI a la actualización.
*******************************************************************
* FECHA: 11/01/2010
* AUTOR: Miguel Ángel Utiel Peñaranda
* MODIFICACION: Actualización del Código de departamento y no se actualicen los permisos y añadido el nif
*******************************************************************
* FECHA: 11/01/2010
* AUTOR: Miguel Ángel Utiel Peñaranda
* MODIFICACION: Añadido la posibilidad de ser Matrona o Fisioterapeuta
*******************************************************************
* FECHA: 09/01/2010
* AUTOR: Miguel Ángel Utiel Peñaranda
* MODIFICACION: Añadido la actualización del campo OculpaPac
*******************************************************************
* FECHA: 22/02/2010
* AUTOR: Miguel Ángel Utiel Peñaranda
* MODIFICACION: Comprobación de nulos en la actualizacion de colectivos e incentivos
*******************************************************************
* FECHA: 18/03/2010
* AUTOR: Miguel Ángel Utiel
* MODIFICACION: Añadido el campo Documentalista
**************************************************************************************
* MODIFICACION: 21/05/2010 Miguel Ángel Utiel. Comentado funcion que mantiene siempre el colectivo y los incentivos en caso de pasarle unos vacions
* MODIFICACION: 24/05/2010 Luis Merle. Añadido el campo PermisosIndicadores
**************************************************************************************
* FECHA: 22/06/2010
* AUTOR: Paco Aznar
* MODIFICACION: Se añade el campo porcenJornada
**************************************************************************************
* FECHA: 09/09/2010
* AUTOR: Teresa L Fabuel
* MODIFICACION: Se añade el campo visita (TipoExploracion)
**************************************************************************************
* FECHA: 22/12/2010
* AUTOR: Miguel Ángel Utiel
* MODIFICACION: Se añade el vampo VerEnEnfermeria y comentado campo de Tere
**************************************************************************************
* FECHA: 02/02/2011
* AUTOR: Ramón Jiménez.
* MODIFICACION : Si es un update de contraseña, solo actualizamos la clave y la fecha de la llave.
**************************************************************************************
* MODIFICACIÓN: (05/10/2012) Fran Cuenca MAIPU -- CHC-2024 -- V4.33, Registro atenciones profesionales no médicos
* MODIFICACIÓN: (21/05/2013) Alfredo - CHC3064 - 4.37 - Añado FAlta
* MODIFICACIÓN: (26/05/2016) - V4.62 – 3248 – DCR - Se agrega el CambioClave=1 del usuario al UPDATE ParametrosMedicos cuando hay password
* MODIFICACIÓN: (14/06/2016) - V4.62 - 3218 - SGN - Registro Confidencial
* MODIFICACIÓN: (03/10/2016) - V4.65 - 13406 - MMM - Acceso mediante lista blanca Florence
* MODIFICACIÓN: (09/02/2017) - V4.68 - 15136 - DVR - Auditoría de cambio de contraseñas y comunicación al usuario mediante mail
* MODIFICACIÓN: (29/06/2017) - V17.2r1 - 18277 - SGH - Triaje ESI 
**************************************************************************************/

CREATE PROCEDURE [dbo].[SpParUActualizaEnfermera]
	 @spvar_DNI char(8)
	,@spvar_Nombre char(15)
	,@spvar_Apell1 char(15)
	,@spvar_Apell2 char(15)
	,@spvar_Login varchar(30)
	,@spvar_Passwd varchar(50) = null
	,@spvar_Perfil int
	,@spvar_Idioma1 char(5)
	,@spvar_CodCentro char(5)
	--MAIPU -- CHC-2024 -- V4.33, Registro atenciones profesionales no médicos
	,@spvar_Rol varchar(25) = null
	,@spvar_CodRol char(2) = null
	--MAIPU -- CHC-2024 -- V4.33, Fin
	,@spvar_Foto image = null
	,@spvar_ActualizaPerfil bit = null
	,@spvar_CodServicio varchar(4)
	,@spvar_CodColectivo varchar(3) = null
	,@spvar_Incentivos bit = null
	,@spvar_CodDepart int = 0
	,@spvar_nif char(9) = null
	,@spvar_esfisio bit = 0
	,@spvar_esmatrona bit = 0
	,@spvar_Oculta bit = 0
	,@spvar_Documentalista bit = 0
	,@spvar_PermisosIndicadores int = 0
	,@spvar_PorcenJornada decimal(5,2) = null
	,@spvar_Visita bit = null
	,@FAlta smalldatetime = null --Alfredo - CHC3064
	,@spvar_RCC tinyint = 0
	,@spvar_UsuGenerico bit = 0
	,@spvar_Email varchar(100) = null
	,@spvar_TriajeESI bit = null

AS
BEGIN
	
	if @spvar_PorcenJornada is not null
	begin
		set @spvar_PorcenJornada = CONVERT(decimal(5,2),@spvar_porcenJornada)
	end

	IF @spvar_Passwd is null
	BEGIN
		UPDATE DatosEnfermeras
		SET  NombreEnf = @spvar_Nombre
			,Apell1Enf = @spvar_Apell1
			,Apell2Enf = @spvar_Apell2
			,UsuarioEnf = @spvar_Login
			,Perfil = @spvar_Perfil
			,Idioma = @spvar_Idioma1
			,CodCentroEnf = @spvar_CodCentro
			,EsFisio = @spvar_EsFisio
			--MAIPU -- CHC-2024 -- V4.33, Registro atenciones profesionales no médicos
			,Rol = @spvar_Rol -- RJF (10/12/08)
			,CodRol = @spvar_CodRol
			--MAIPU -- CHC-2024 -- V4.33, Fin
			,Foto = @spvar_Foto -- RJF (10/12/08)
			,CodServicio = @spvar_CodServicio
			,ColectivoDUE = @spvar_CodColectivo
			,IncentivosEnf = @spvar_Incentivos
			,CodDepartamento = @spvar_CodDepart
			,Nif = @spvar_nif
			,OcultaPac = @spvar_Oculta
			,PermiteCrearPropuesta = @spvar_esmatrona
			,Documentacion = @spvar_Documentalista
			,PermisosIndicadores = @spvar_PermisosIndicadores
			,PorcenJornada = @spvar_PorcenJornada
			--,TipoExploracion = @spvar_Visita
			--,VerEnAgendas = @spvar_esmatrona 
			,FechaAltaEnf = ISNULL(@FAlta,FechaAltaEnf) --Alfredo - CHC3064
			,RCC = @spvar_RCC
			,UsuGenerico = @spvar_UsuGenerico
			,Email = @spvar_Email
			,TriajeESI = ISNULL(@spvar_TriajeESI,TriajeESI)
		WHERE DNIEnf = @spvar_DNI	
	END
	ELSE
	BEGIN
		UPDATE DatosEnfermeras
		SET  LlaveEnf = @spvar_Passwd
			,FechaLlaveEnf = GETDATE()
			,CambioClave = 1
		WHERE DNIEnf = @spvar_DNI	
	END

	IF @spvar_EsMatrona = 1
		BEGIN
			UPDATE DatosEnfermeras 
			SET	   PuedeIngresar = 1
			      ,CodigoPerfilEnf = 'E019' 
			WHERE  DNIEnf = @spvar_DNI	
		END
	ELSE
		BEGIN
			UPDATE DatosEnfermeras 
			SET	   PuedeIngresar = 0
			      ,CodigoPerfilEnf = 'per' 
			WHERE  DNIEnf = @spvar_DNI	
		END

END
GO



--dbo.SpParUActualizaMedico.sql

USE [Parametros];
GO
IF EXISTS 
(
    SELECT * 
        FROM sys.procedures 
        WHERE [object_id] = OBJECT_ID('[dbo].[SpParUActualizaMedico]')
)
BEGIN
    DROP PROCEDURE [dbo].[SpParUActualizaMedico];
END
GO

/*********************************************************************
* FUNCION: Se modifican los datos de los médicos
* ENTRADA: 
*			DNI del médico
*			Nombre
*			Apellidos
*			Login
*			Password -> opcional: si no se introduce se conserva el existente
*			Perfil del médico
*			Idioma1
*			Idioma2
*			Centro
*			Servicio
* DEVUELVE: 
* FECHA: 22/09/2008
* VERSION: 1.0
* AUTOR: Joaquín Gras Gómez (Agensys)
* ORIGEN: Gestión de usuarios
*******************************************************************
* FECHA: 09/12/2008
* AUTOR: Ramon Jimenez (Mecemsa)
* MODIFICACION: Se añade a la update los campos 'Foto' y 'Rol'.
*******************************************************************
* FECHA: 12/12/2008
* AUTOR: Ramon Jimenez (Mecemsa)
* MODIFICACION: Se comprueba mediante ActualizaPerfil si hay que actualizar los permisos o no.
*******************************************************************
* FECHA: 07/05/2009
* AUTOR: Curro Rosado (Agensys)
* MODIFICACION: Se modifica el flag de consultor externo si se modifica
*******************************************************************
* FECHA: 30/07/2009
* AUTOR: Joaquín Aniorte
* MODIFICACION: Se añaden los campos Incentivos y DNI a la actualización.
*******************************************************************
* FECHA: 11/01/2010
* AUTOR: Miguel Ángel Utiel Peñaranda
* MODIFICACION: Actualización del Código de departamento y no se actualicen los permisos y añadido el nif
*******************************************************************
* FECHA: 09/01/2010
* AUTOR: Miguel Ángel Utiel Peñaranda
* MODIFICACION: Añadido la actualización del campo OculpaPac
*******************************************************************
* FECHA: 22/02/2010
* AUTOR: Miguel Ángel Utiel Peñaranda
* MODIFICACION: Comprobación de nulos en la actualizacion de colectivos e incentivos
*******************************************************************
* FECHA: 18/03/2010
* AUTOR: Miguel Ángel Utiel
* MODIFICACION: Añadido el campo Documentalista
**************************************************************************************
* FECHA: 26/03/2010
* AUTOR: Miguel Ángel Utiel
* MODIFICACION: Añadido el AvisoHemo para avisos del modulo de Banco de Sangre
**************************************************************************************
* FECHA: 22/04/2010
* AUTOR: Joaquín Aniorte Mora
* MODIFICACION: Añadido el campo NumColegMed
**************************************************************************************
* MODIFICACION: 29/04/2010 Teresa L Fabuel. Añadido el campo JefeServicio
* MODIFICACION: 14/05/2010 Luis Merle. Añadido el campo PermisosIndicadores
**************************************************************************************
* FECHA: 16/06/2010
* AUTOR: Paco Aznar
* MODIFICACION: Se inserta si el medico es residente
**************************************************************************************
* MODIFICACION: 27/10/2010 Teresa L Fabuel S. Se actualiza el campo NifCrc
*************************************************************************************
* FECHA: 18/01/2011
* AUTOR: Alejandro Palazon
* MODIFICACION: Se actualiza el campo CodMutua
**************************************************************************************
* MODIFICACION: (02/02/2011) Ramón Jiménez. Si es un update de contraseña, solo actualizamos la clave y la fecha de la llave.
* MODIFICACION: (05/10/2012) Fran Cuenca MAIPU -- CHC-2024 -- V4.33, Registro atenciones profesionales no médicos
* MODIFICACION: (02/05/2013) Alfredo -- CHC2983 -- V4.38, Modifico la gestión de los incentivos cuando se pasa un NULL. Eso no ha funcionado nunca!!!
* MODIFICACIÓN: (21/05/2013) Alfredo - CHC3064 - 4.37 - Añado FAlta
* MODIFICACIÓN: (30/07/2014) - V4.46r1 – 1159 – ECR - Observaciones FG
* MODIFICACIÓN: (09/10/2014) - V4.47r2 – 1466 – APO - Se agrega el Dni del usuario al UPDATE ParametrosMedicos   
* MODIFICACIÓN: (26/05/2016) - V4.62 – 3248 – DCR - Se agrega el CambioClave=1 del usuario al UPDATE ParametrosMedicos cuando hay password
* MODIFICACIÓN: (14/06/2016) - V4.62 - 3218 - SGN - Registro Confidencial
* MODIFICACIÓN: (03/10/2016) - V4.65 - 13406 - MMM - Acceso mediante lista blanca Florence
* MODIFICACIÓN: (09/02/2017) - V4.68 - 15136 - DVR - Auditoría de cambio de contraseñas y comunicación al usuario mediante mail 
* MODIFICACIÓN: (29/06/2017) - V17.2r1 - 18277 - SGH - Triaje ESI 
**************************************************************************************/

CREATE PROCEDURE [dbo].[SpParUActualizaMedico]
	 @spvar_DNI char(8)
	,@spvar_Nombre char(15)
	,@spvar_Apell1 char(15)
	,@spvar_Apell2 char(15)
	,@spvar_Login varchar(30)
	,@spvar_Passwd varchar(50) = null
	,@spvar_Perfil int
	,@spvar_Idioma1 char(5)
	,@spvar_Idioma2 char(5) = null
	,@spvar_CodCentro char(5)
	,@spvar_CodServicio char(4)
	--MAIPU -- CHC-2024 -- V4.33, Registro atenciones profesionales no médicos
	,@spvar_Rol varchar(25) = null
	,@spvar_CodRol char(2) = null
	--MAIPU -- CHC-2024 -- V4.33, Fin
	,@spvar_Foto image = null
	,@spvar_ActualizaPerfil bit = null
	,@spvar_ConsExt bit = null
	,@spvar_ClaveMed char(7)
	,@spvar_Incentivos bit = null
	,@spvar_CodDepart int = 0
	,@spvar_nif char(9) = null
	,@spvar_Oculta bit = 0
	,@spvar_Documentalista bit = 0
	,@spvar_AvisoHemo bit = 0
	,@spvar_NumColegiado char(12) = null
	,@spvar_JefeServicio bit = null
	,@spvar_PermisosIndicadores int = 0
	,@spvar_Residente bit = null
	,@spvar_NifCrc char(9) = null
	,@spvar_CodMutua char(5) = null
	,@FAlta smalldatetime = null --Alfredo - CHC3064
	,@spvar_RCC tinyint = 0
	,@spvar_UsuGenerico bit = 0
	,@spvar_Email varchar(100) = null
	,@spvar_TriajeESI bit = null
AS

BEGIN
	
	--Alfredo - CHC2983 - inicio
	--set @spvar_Incentivos = isnull(@spvar_Incentivos,(select IncentivosMed from parametros..ParametrosMedicos where DNIMedico = @spvar_DNI))
	IF @spvar_Incentivos IS NULL
	BEGIN
		IF (select IncentivosMed from parametros..ParametrosMedicos where DNIMedico = @spvar_DNI) = 'S'
			set @spvar_Incentivos = 1
		ELSE
			set @spvar_Incentivos = 0
	END
	--Alfredo - CHC2983 - fin

	if exists(select ClaveMed from ParametrosMedicos where clavemed = @spvar_ClaveMed and DNIMedico <> @spvar_DNI)
	Begin
		update ParametrosMedicos 
		set ClaveMed = null
		where ClaveMed = @spvar_ClaveMed
	End
	
	declare @Incentivos varchar
	
	if(@spvar_Incentivos = 1)
		set @Incentivos = 'S'
	else
		set @Incentivos = 'N'
	
	IF @spvar_Passwd is null
	BEGIN
		UPDATE ParametrosMedicos
		SET  NomMedico = @spvar_Nombre
			,Apell1 = @spvar_Apell1
			,Apell2 = @spvar_Apell2
			,AliasMedico = substring(@spvar_Login,1,15)
			,UsuarioMedico = @spvar_Login
			,Perfil = @spvar_Perfil
			,Idioma1 = @spvar_Idioma1
			,Idioma2 = @spvar_Idioma2
			--CodCentroMed = @spvar_CodCentro, -- V4.46r1 – 1159 – ECR - Observaciones FG
			--CodServicioMedico = @spvar_CodServicio, -- V4.46r1 – 1159 – ECR - Observaciones FG
			--MAIPU -- CHC-2024 -- V4.33, Registro atenciones profesionales no médicos
			,Rol = @spvar_Rol
			,CodRol = @spvar_CodRol
			--MAIPU -- CHC-2024 -- V4.33, Fin
			,Foto = @spvar_Foto
			,ConsultorExterno = @spvar_ConsExt
			,ClaveMed = @spvar_ClaveMed
			,IncentivosMed = @Incentivos
			,CodDepartamento = @spvar_CodDepart
			,Nif = @spvar_nif
			,OcultaPac = @spvar_Oculta
			,Documentacion = @spvar_Documentalista
			,AvisoHemo = @spvar_AvisoHemo
			,NumColegMed = @spvar_NumColegiado
			,JefeServicio = @spvar_JefeServicio
			,PermisosIndicadores = @spvar_PermisosIndicadores
			,Residente = @spvar_Residente
			,NIFCRC = ISNULL(@spvar_NifCrc,@spvar_nif)
			,CodMutua = @spvar_CodMutua
			,FAltaMedico = ISNULL(@FAlta,FAltaMedico) --Alfredo - CHC3064
			,RCC = @spvar_RCC
			,UsuGenerico = @spvar_UsuGenerico
			,Email = @spvar_Email
			,TriajeESI = ISNULL(@spvar_TriajeESI,TriajeESI)
		WHERE DNIMedico = @spvar_DNI
	END
	ELSE
	BEGIN
		UPDATE ParametrosMedicos
		SET  LlaveMedico = @spvar_Passwd
			,FechaLlaveMed = GETDATE()
			,CambioClave = 1
		WHERE DNIMedico = @spvar_DNI	
	END
	
	-- V4.46r1 – 1159 – ECR - Observaciones FG - INI
	UPDATE ParametrosMedicos
	SET CodServicioMedico = @spvar_CodServicio
	WHERE CodCentroMed = @spvar_CodCentro 
		  AND CodServicioMedico <> @spvar_CodServicio
		  AND DNIMedico = @spvar_DNI -- V4.47r2 – 1466 – APO - Error SP - INI
	-- V4.46r1 – 1159 – ECR - Observaciones FG - FIN

END
GO



--dbo.SpParUActualizaTecnico.sql

USE [Parametros];
    GO
    IF EXISTS 
    (
        SELECT * 
            FROM sys.procedures 
            WHERE [object_id] = OBJECT_ID('[dbo].[SpParUActualizaTecnico]')
    )
    BEGIN
        DROP PROCEDURE [dbo].[SpParUActualizaTecnico];
    END
    GO
/*********************************************************************
* FUNCION: Se modifican los datos de los tÃ©cnicos
* ENTRADA: 
*			DNI del tÃ©cnico
*			Nombre
*			Apellidos
*			Login
*			Password -> opcional: si no se introduce se conserva el existente
*			Perfil del tÃ©cnico
*			Idioma1
*			Centro
*			Servicio
* DEVUELVE: 
* FECHA: 22/09/2008
* VERSION: 1.0
* AUTOR: JoaquÃ­n Gras GÃ³mez (Agensys)
* ORIGEN: GestiÃ³n de usuarios
'*******************************************************************
* FECHA: 09/12/2008
* AUTOR: Ramon Jimenez (Mecemsa)
* MODIFICACION: Se aÃ±ade a la update los campos 'Foto' y 'Rol'.
'*******************************************************************
* FECHA: 12/12/2008
* AUTOR: Ramon Jimenez (Mecemsa)
* MODIFICACION: Se comprueba mediante ActualizaPerfil si hay que actualizar los permisos o no.
*******************************************************************
* FECHA: 30/07/2009
* AUTOR: JoaquÃ­n Aniorte
* MODIFICACION: Se aÃ±aden los campos ColectivoTec, IncentivosEnf, IncentivosTec
*				y DNI a la actualizaciÃ³n
*******************************************************************
* FECHA: 11/01/2010
* AUTOR: Miguel Ãngel Utiel PeÃ±aranda
* MODIFICACION: ActualizaciÃ³n del CÃ³digo de departamento y no se actualicen los permisos y aÃ±adido el nif
*******************************************************************
* FECHA: 09/01/2010
* AUTOR: Miguel Ãngel Utiel PeÃ±aranda
* MODIFICACION: AÃ±adido la actualizaciÃ³n del campo OculpaPac
*******************************************************************
* FECHA: 22/02/2010
* AUTOR: Miguel Ãngel Utiel PeÃ±aranda
* MODIFICACION: ComprobaciÃ³n de nulos en la actualizacion de colectivos e incentivos
**************************************************************************************
* MODIFICACION: (21/05/2010) Miguel Ãngel Utiel. Comentado funcion que mantiene siempre el colectivo y los incentivos en caso de pasarle unos vacios
* MODIFICACION: (24/05/2010) Luis Merle. AÃ±adido el campo PermisosIndicadores
* MODIFICACION: (02/02/2011) RamÃ³n JimÃ©nez. Si es un update de contraseÃ±a, solo actualizamos la clave y la fecha de la llave.
* MODIFICACION: (05/10/2012) Fran Cuenca MAIPU -- CHC-2024 -- V4.33, Registro atenciones profesionales no mÃ©dicos
* MODIFICACIÃ“N: (21/05/2013) Alfredo - CHC3064 - 4.37 - AÃ±ado FAlta
* MODIFICACIÃ“N: (26/05/2016) - V4.62 â€“ 3248 â€“ DCR - Se agrega el CambioClave=1 del usuario al UPDATE ParametrosMedicos cuando hay password 
* MODIFICACIÃ“N: (03/10/2016) - V4.65 - 13406 - MMM - Acceso mediante lista blanca Florence
* MODIFICACIÃ“N: (09/02/2017) - V4.68 - 15136 - DVR - AuditorÃ­a de cambio de contraseÃ±as y comunicaciÃ³n al usuario mediante mail 
* MODIFICACIÃ“N: (29/06/2017) - V17.2r1 - 18277 - SGH - Triaje ESI 
* MODIFICACIÃ“N: (22/08/2017) - V17.3 - 18454 - MPR - Modificaciones a Interconsultas Internas
**************************************************************************************/

CREATE PROCEDURE [dbo].[SpParUActualizaTecnico]
	 @spvar_DNI char(8)
	,@spvar_Nombre char(15)
	,@spvar_Apell1 char(15)
	,@spvar_Apell2 char(15)
	,@spvar_Login varchar(30)
	,@spvar_Passwd varchar(50) = null
	,@spvar_Perfil int
	,@spvar_Idioma1 char(5)
	,@spvar_CodCentro char(5)
	,@spvar_CodServicio char(4)
	--MAIPU -- CHC-2024 -- V4.33, Registro atenciones profesionales no mÃ©dicos
	,@spvar_Rol varchar(25) = null
	,@spvar_CodRol char(2) = null
	--MAIPU -- CHC-2024 -- V4.33, Fin
	,@spvar_Foto image = null
	,@spvar_ActualizaPerfil bit = null
	,@spvar_CodColectivo varchar(3) = null
	,@spvar_IncentivosEnf bit = null
	,@spvar_IncentivosTec bit = null
	,@spvar_CodDepart int = 0
	,@spvar_nif char(9) = null
	,@spvar_Oculta bit = 0
	,@spvar_PermisosIndicadores int = 0
	,@FAlta smalldatetime = null --Alfredo - CHC3064
	,@spvar_UsuGenerico bit = 0
	,@spvar_Email varchar(100) = null
	,@spvar_TriajeESI bit = null
AS

BEGIN

	IF @spvar_Passwd is null
	BEGIN
		UPDATE Parametros..TecnicosDatos
		SET  NombreTecnico = @spvar_Nombre
			,Apell1Tecnico = @spvar_Apell1
			,Apell2Tecnico = @spvar_Apell2
			,UsuarioTecnico = @spvar_Login
			,Perfil = @spvar_Perfil
			,Idioma = @spvar_Idioma1
			,CodCentroTecnico = @spvar_CodCentro
			,CodSeccionTecnico = @spvar_CodServicio
			--MAIPU -- CHC-2024 -- V4.33, Registro atenciones profesionales no mÃ©dicos
			,Rol = @spvar_Rol -- RJF (10/12/08) 
			,CodRol = @spvar_CodRol
			--MAIPU -- CHC-2024 -- V4.33, Fin
			,Foto = @spvar_Foto -- RJF (10/12/08)
			,ColectivoTEC = @spvar_CodColectivo
			,IncentivosEnf = @spvar_IncentivosEnf
			,IncentivosTec = @spvar_IncentivosTec
			,CodDepartamento = @spvar_CodDepart
			,Nif = @spvar_nif
			,OcultaPac = @spvar_Oculta
			,PermisosIndicadores = @spvar_PermisosIndicadores		 
			,FAltaTecnico = ISNULL(@FAlta,FAltaTecnico) --Alfredo - CHC3064
			,CodServicioTecnico = @spvar_CodServicio
			,UsuGenerico = @spvar_UsuGenerico
			,Email = @spvar_Email
			,TriajeESI = ISNULL(@spvar_TriajeESI,TriajeESI)
		WHERE DNITecnico = @spvar_DNI		
	END
	ELSE
	BEGIN
		UPDATE parametros..TecnicosDatos
		SET  LlaveTecnico = @spvar_Passwd
			,FechaLlaveTecn = GETDATE()
			,CambioClave = 1
		WHERE DNITecnico = @spvar_DNI	
	END

END

GO



--dbo.SpParUBloqueoQuirofano.sql

USE [Parametros];
GO
IF EXISTS 
(
    SELECT * 
        FROM sys.procedures 
        WHERE [object_id] = OBJECT_ID('[dbo].[SpParUBloqueoQuirofano]')
)
BEGIN
    DROP PROCEDURE [dbo].[SpParUBloqueoQuirofano];
END
GO

/*********************************************************************
* FUNCION	: Actualiza un bloqueo de quirofano
* DEVUELVE	: 1 ó 0 indicando si se ha realizado correctamente
* FECHA		: 01/10/2009
* VERSION	: 1.0
* AUTOR		: Jesús Mañogil (Mecemsa)
* MODIF		: v17.3 - 16148 - ASM - Bloqueo de pabellón por intervalos de horarios
'*******************************************************************/

CREATE PROCEDURE [dbo].[SpParUBloqueoQuirofano] 
	 @spvar_NumQuirofano as char(2)
	,@spvar_FechaDesde as smalldatetime
	,@spvar_FechaHasta as smalldatetime
	,@spvar_CodMotivo as int
	,@spvar_DNI as char(9)
AS

update Parametros..BloqueoQuirofanos
set FechaBloqueo = GETDATE()
   ,CodMotivo = @spvar_CodMotivo
   ,DNI = @spvar_DNI
where NumQuirofano = @spvar_NumQuirofano and
	  Intervalos = 1 and
	  FechaDesde = @spvar_FechaDesde and
	  FechaHasta = @spvar_FechaHasta

if @@ROWCOUNT = 1
	select 1		  
else
	
begin	  
	update Parametros..BloqueoQuirofanos
	set FechaBloqueo = GETDATE()
	   ,CodMotivo = @spvar_CodMotivo
	   ,DNI = @spvar_DNI
	where NumQuirofano = @spvar_NumQuirofano and
		  Intervalos = 0 AND
		  cast(FechaDesde as date) <= @spvar_FechaHasta and 
		  cast(FechaHasta as date) >= @spvar_FechaDesde
	
	if @@ROWCOUNT = 1
		select 1		  
	else
		select 0		  

end

GO
GO



--dbo.trgProtocolosPruebas_InsteadOf_I.sql

USE [Parametros]
GO

/****** Object:  Trigger [trgProtocolosPruebas_InsteadOf_I]    Script Date: 06/21/2017 13:02:58 ******/
IF  EXISTS (SELECT * FROM sys.triggers WHERE object_id = OBJECT_ID(N'[dbo].[trgProtocolosPruebas_InsteadOf_I]'))
DROP TRIGGER [dbo].[trgProtocolosPruebas_InsteadOf_I]
GO




GO



--dbo.trgProtocolosPruebas_InsteadOf_U.sql

USE [Parametros]
GO

/****** Object:  Trigger [trgProtocolosPruebas_InsteadOf_U]    Script Date: 06/21/2017 13:03:05 ******/
IF  EXISTS (SELECT * FROM sys.triggers WHERE object_id = OBJECT_ID(N'[dbo].[trgProtocolosPruebas_InsteadOf_U]'))
DROP TRIGGER [dbo].[trgProtocolosPruebas_InsteadOf_U]
GO

--CONSOLIDACION
--Eliminar para renombrar
USE [Parametros];
GO
IF EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[SpHCLIDatosCamas]') AND type in (N'P', N'PC'))
                DROP PROCEDURE [dbo].[SpHCLIDatosCamas]
GO


--dbo.SpConIQuiNuevo.sql

USE [Consultas]
GO
/****** Object:  StoredProcedure [dbo].[SpConIQuiNuevo]    Script Date: 03/08/2017 9:54:15 ******/
IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[SpConIQuiNuevo]') AND type in (N'P', N'PC'))
DROP PROCEDURE [dbo].[SpConIQuiNuevo]
GO

USE [Consultas]
GO

SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

--	PROCEDIMIENTO		: 	SpConIQuiNuevo
--	FUNCION                 		: 	Inserta un nuevo informe quirÃºrgico
--	DEVUELVE                		: 
--	FECHA                  			: 	21/12/2005
--	VERSION                 		: 	1.0
--	AUTOR                   		: 	Gerardo Prieto David (MECEMSA Consultores)
--  MODIFICACION		:   MPS 31/05/07 aÃ±adir parametros para possum
--							Jorge Poveda SÃ¡ez 10/12/2007 AÃ±ado dos campos CodExamInterven 1 y 2
--							Ismael 14/12/2007 AÃ±adido el parametro ActualizaIngreso para actualizar la fecha de
--							hospitalizacion con respecto a la de inicio de la intervencion
--							Ismael 18/12/2007 valor por defecto a los parametros por compatibilidad
--							Oscar 19/08/2008 se guarda la informaciÃ³n del paciente para kiosko
--							Pablo 31/12/2008 se aumenta el tamaÃ±o de descOperatoria
--							Ismael 27/01/2009 Actualizacion de estados de la preoperatoria para RCLE
--							Pablo GonzÃ¡lez 10/03/2009 InfoPaciente en preoperatoria
--							Pablo GonzÃ¡lez 30/03/2009 No se acualiza inforpaciente
--							26/11/2013 -  v4.41 - CTF - 73569626D - CHC3335_ModificaciÃ³n Campo Analista en InfQuirurgico 
--	APLICACIÃ“N ORIGEN   	: 	Informe quirÃºrgico
--  MODIFICACIÃ“N	: 05/09/2016 - v4.64 - 12771 - CCM - Repasar las tablas que tienen historificacion
--  MODIFICACION: 15/05/2017 - v17.2 - 16142 - FCB - Solicitud de PabellÃ³n - Registro de especialidad
--  MODIFICACION: 03/08/2017 - v17.3 - 16153 - MPR - Registro Quirurgico - Incorporar registro de Turno
--  MODIFICACIÃ“N: 23/10/2017 - v17.3r1 - MMM - 16152 - Agregar estado de DiagnÃ³sticos en solicitud de pabellÃ³n

CREATE Procedure [dbo].[SpConIQuiNuevo]
	
	@spvar_CodInforme Varchar(7) = NULL,
	@spvar_CodIntervencion Varchar(7),
	@spvar_CodPaciente Char(16), 
	@spvar_CodEpisodio Char(5), 
	@spvar_FSolicitud Smalldatetime, 
	@spvar_CodCirujano Char(8), 
	@spvar_CodInstrumentista Char(8), 
	@spvar_CodAyuda1 Char(8),
	@spvar_CodAyuda2 Char(8), 
	@spvar_CodAyuda3 Char(8), 
	@spvar_CodMedInforma Char(8), 
	@spvar_CodQuirofano Char(2),
	@spvar_Posicion Char(2), 
	@spvar_CodVia Char(2), 
	@spvar_CodProcedimiento Char(6), 
	@spvar_CodCIE Char(6), 
	@spvar_CodAntibiotico int,
	@spvar_TipoIntervencion Char(1), 
	@spvar_Destino Char(1), 
	@spvar_Drenaje Bit, 
	@spvar_TecnicaEmpleada Varchar(100),
	@spvar_TecnicaCierre Varchar(100), 
	@spvar_Pieza Varchar(40), 
	@spvar_HoraInicio Smalldatetime, 
	@spvar_HoraFin Smalldatetime,
	@spvar_FInforme Smalldatetime, 
	@spvar_CodMutua Char(5), 
	@spvar_Facturable Bit = 0,
	@spvar_CantidadProcesos Tinyint = 1,
	@spvar_DescOperatoria varchar(max), --Pablo
	@spvar_SolBiopsia char(10),
	@spvar_SolLaboratorio char(10),
	@spvar_SolCitologias char(10),
	@spvar_SolHormonales bit,
	@spvar_SolRadiologia char(10),
	@spvar_SolPostmortem bit,
	@spvar_Firmado bit = 0,
	@spvar_NumCordales char(2) = null,
	@spvar_CodExamInterv char(7) = null,
	@spvar_TasaMorbilidad float = null,  -- mps 
	@spvar_TasaMortalidad float = null,   -- mps 
	@spvar_CodExamInterv1 char(7) = null, --Jorge
	@spvar_CodExamInterv2 char(7) = null,  --Jorge
	@spvar_ActualizaIngreso as bit = '0',
	@spvar_InfoPaciente as varchar(4000) = null
	,@spvar_NombreAnestesista as varchar(70)=null --43
	,@spvar_CodCentro as varchar(5)   --44
	,@spvar_IdPlano tinyint =NULL
	,@spvar_IdCuadrante tinyint = NULL
	,@spvar_DNIUsuarioModifica varchar(8) = NULL
	,@spvar_idTurnoInfQuirurgico int
	,@spvar_Estado int = NULL
	
As
Exec SpConSQuiSusp @spvar_CodIntervencion

	if @spvar_DNIUsuarioModifica  is NULL
	BEGIN
		SET @spvar_DNIUsuarioModifica = ''
	END

	If @@RowCount = 0

		Begin
		
			If (Select CodPaciente From HClinica..Preoperatoria Where CodIntervencion = @spvar_CodIntervencion) Is Null
			
				--	Se borrÃ³ desde otro sitio la hoja de preoperatorio.
				Select 2

			Else

				Begin
					-- mps guardar los datos del possum 
					if exists(select * from hclinica..preoperatoria
								where CodIntervencion = @spvar_CodIntervencion)
					begin
					
					INSERT INTO Historificacion..HClinica_Preoperatoria
						   (CodHojaPreop, CodIntervencion, CodPaciente, CodEpisodio, CodProc,
							CodProtocolo, TipoAnestesia, JClinico, CodCIEPreop, RQuirurgico,
							ProfAntibiotica, ProfOtros, ProfTromboembolica, Region, FPreoperatoria,
							DNIMedicoPreop, DescPreop, TecPrevistas, CSuspendida, FPrevista,
							Ambulatoria, Tipo, PreopCompleto, FIntervencion, Autotransfusion,
							VistoBueno, MedicoRemite, CodMutua, Anestesista, FConsentInterv,
							FConsentProtesis, CodCenRemite, Preanestesia, FPasivo, DiasLEspera,
							NecesHemoderiv, UsuHemoderiv, CodHistoria, Eliminado, Servicio,
							FechaFirma, FechaUltimaAct, DescProtocolo, CiruMenor, TiempoOper,
							CodProtocolo2, DescProtocolo2, CodProtocolo3, DescProtocolo3, cma, 
							MotivoPreferente, Estado, JornadaExtra, DniASQ, FEliminada, FSuspendida,
							TasaMorbilidad, TasaMortalidad, Lateralidad, ResaltaPlaning, CodExamInterven,
							TieneImagen, Factivo, FultimoPasivo, JornadaExtraVali, DniASQVali,
							ObservacionesPreoper, Confirmacion, EliminadoPlan, CMAsinHDIA,
							CodigoGRD, PesoGRD, Complejidad, RequiereUvi, EstadoRCLE, InfoPaciente,
							dniInfoPacMed, dniInfoPacEnf, dniInfoPacAnes, FInfoPaciente, ObsEnfermeria,
							Neoplasia, DniCirujanoPrevisto, AvisadoPac, ObservacionesAvisadoPac,
							DniAvisadoPac, CodAvisoPac, ComplejidadPreop, IntervencionEspecial,
							UHD, TieneEquipo, CentroDestino, TipoCenRemite, ServicioOrigen,
							Ayudantes, AlergiaLatex, RequiereIngreso, TieneProtesis, Infeccioso,
							Preparatoria, DNISuspendida, DNIEliminada, FecModificacionPreop,
							CiruAUrgente, DniAyudantePrevisto, AvisoPlanificar, FPrevistaIntervencion,
							NumListaRCLE, EsSincronizadoRCLE, PacFirmaConsen, NumSuspensiones,
							Observaciones, Pagado, CodMotivoPreferente, IdPlano, IdCuadrante,
							EsReIntervencion, DescReIntervencion, Validado, FCreacionHistorico, DNIUsuarioModifica 
							,CodEspecialidadUrg )
					 SELECT Prp.CodHojaPreop, Prp.CodIntervencion, Prp.CodPaciente, Prp.CodEpisodio, Prp.CodProc,
							Prp.CodProtocolo, Prp.TipoAnestesia, Prp.JClinico, Prp.CodCIEPreop, Prp.RQuirurgico,
							Prp.ProfAntibiotica, Prp.ProfOtros, Prp.ProfTromboembolica, Prp.Region, Prp.FPreoperatoria,
							Prp.DNIMedicoPreop, Prp.DescPreop, Prp.TecPrevistas, Prp.CSuspendida, Prp.FPrevista,
							Prp.Ambulatoria, Prp.Tipo, Prp.PreopCompleto, Prp.FIntervencion, Prp.Autotransfusion,
							Prp.VistoBueno, Prp.MedicoRemite, Prp.CodMutua, Prp.Anestesista, Prp.FConsentInterv,
							Prp.FConsentProtesis, Prp.CodCenRemite, Prp.Preanestesia, Prp.FPasivo, Prp.DiasLEspera,
							Prp.NecesHemoderiv, Prp.UsuHemoderiv, Prp.CodHistoria, Prp.Eliminado, Prp.Servicio,
							Prp.FechaFirma, Prp.FechaUltimaAct, Prp.DescProtocolo, Prp.CiruMenor, Prp.TiempoOper,
							Prp.CodProtocolo2, Prp.DescProtocolo2, Prp.CodProtocolo3, Prp.DescProtocolo3, Prp.cma, 
							Prp.MotivoPreferente, Prp.Estado, Prp.JornadaExtra, Prp.DniASQ, Prp.FEliminada, Prp.FSuspendida,
							Prp.TasaMorbilidad, Prp.TasaMortalidad, Prp.Lateralidad, Prp.ResaltaPlaning, Prp.CodExamInterven,
							Prp.TieneImagen, Prp.Factivo, Prp.FultimoPasivo, Prp.JornadaExtraVali, Prp.DniASQVali,
							Prp.ObservacionesPreoper, Prp.Confirmacion, Prp.EliminadoPlan, Prp.CMAsinHDIA,
							Prp.CodigoGRD, Prp.PesoGRD, Prp.Complejidad, Prp.RequiereUvi, Prp.EstadoRCLE, Prp.InfoPaciente,
							Prp.dniInfoPacMed, Prp.dniInfoPacEnf, Prp.dniInfoPacAnes, Prp.FInfoPaciente, Prp.ObsEnfermeria,
							Prp.Neoplasia, Prp.DniCirujanoPrevisto, Prp.AvisadoPac, Prp.ObservacionesAvisadoPac,
							Prp.DniAvisadoPac, Prp.CodAvisoPac, Prp.ComplejidadPreop, Prp.IntervencionEspecial,
							Prp.UHD, Prp.TieneEquipo, Prp.CentroDestino, Prp.TipoCenRemite, Prp.ServicioOrigen,
							Prp.Ayudantes, Prp.AlergiaLatex, Prp.RequiereIngreso, Prp.TieneProtesis, Prp.Infeccioso,
							Prp.Preparatoria, Prp.DNISuspendida, Prp.DNIEliminada, Prp.FecModificacionPreop,
							Prp.CiruAUrgente, Prp.DniAyudantePrevisto, Prp.AvisoPlanificar, Prp.FPrevistaIntervencion,
							Prp.NumListaRCLE, Prp.EsSincronizadoRCLE, Prp.PacFirmaConsen, Prp.NumSuspensiones,
							Prp.Observaciones, Prp.Pagado, Prp.CodMotivoPreferente, Prp.IdPlano, Prp.IdCuadrante,
							Prp.EsReIntervencion, Prp.DescReIntervencion, Prp.Validado, GetDate(), @spvar_DNIUsuarioModifica 
							,Prp.CodEspecialidadUrg
					   FROM HClinica..Preoperatoria Prp
					   WHERE CodIntervencion = @spvar_CodIntervencion
									
					
						update hclinica..preoperatoria
						set TasaMorbilidad = @spvar_TasaMorbilidad,
							TasaMortalidad = @spvar_TasaMortalidad
						where CodIntervencion = @spvar_CodIntervencion
					end

					--Ismael(27/01/2009) Actualizacion de estados de la preoperatoria para RCLE
					if @spvar_Firmado = '1'
					begin
						declare @Tipo as char(1)
						
						select @Tipo = Tipo 
						from hclinica..preoperatoria
						where CodIntervencion = @spvar_CodIntervencion
					
						if @Tipo = parametros.dbo.fnParValorConstante('m_strCodTipoUrgente')
						begin
							INSERT INTO Historificacion..HClinica_Preoperatoria
									   (CodHojaPreop, CodIntervencion, CodPaciente, CodEpisodio, CodProc,
										CodProtocolo, TipoAnestesia, JClinico, CodCIEPreop, RQuirurgico,
										ProfAntibiotica, ProfOtros, ProfTromboembolica, Region, FPreoperatoria,
										DNIMedicoPreop, DescPreop, TecPrevistas, CSuspendida, FPrevista,
										Ambulatoria, Tipo, PreopCompleto, FIntervencion, Autotransfusion,
										VistoBueno, MedicoRemite, CodMutua, Anestesista, FConsentInterv,
										FConsentProtesis, CodCenRemite, Preanestesia, FPasivo, DiasLEspera,
										NecesHemoderiv, UsuHemoderiv, CodHistoria, Eliminado, Servicio,
										FechaFirma, FechaUltimaAct, DescProtocolo, CiruMenor, TiempoOper,
										CodProtocolo2, DescProtocolo2, CodProtocolo3, DescProtocolo3, cma, 
										MotivoPreferente, Estado, JornadaExtra, DniASQ, FEliminada, FSuspendida,
										TasaMorbilidad, TasaMortalidad, Lateralidad, ResaltaPlaning, CodExamInterven,
										TieneImagen, Factivo, FultimoPasivo, JornadaExtraVali, DniASQVali,
										ObservacionesPreoper, Confirmacion, EliminadoPlan, CMAsinHDIA,
										CodigoGRD, PesoGRD, Complejidad, RequiereUvi, EstadoRCLE, InfoPaciente,
										dniInfoPacMed, dniInfoPacEnf, dniInfoPacAnes, FInfoPaciente, ObsEnfermeria,
										Neoplasia, DniCirujanoPrevisto, AvisadoPac, ObservacionesAvisadoPac,
										DniAvisadoPac, CodAvisoPac, ComplejidadPreop, IntervencionEspecial,
										UHD, TieneEquipo, CentroDestino, TipoCenRemite, ServicioOrigen,
										Ayudantes, AlergiaLatex, RequiereIngreso, TieneProtesis, Infeccioso,
										Preparatoria, DNISuspendida, DNIEliminada, FecModificacionPreop,
										CiruAUrgente, DniAyudantePrevisto, AvisoPlanificar, FPrevistaIntervencion,
										NumListaRCLE, EsSincronizadoRCLE, PacFirmaConsen, NumSuspensiones,
										Observaciones, Pagado, CodMotivoPreferente, IdPlano, IdCuadrante,
										EsReIntervencion, DescReIntervencion, Validado, FCreacionHistorico, DNIUsuarioModifica )
								 SELECT Prp.CodHojaPreop, Prp.CodIntervencion, Prp.CodPaciente, Prp.CodEpisodio, Prp.CodProc,
										Prp.CodProtocolo, Prp.TipoAnestesia, Prp.JClinico, Prp.CodCIEPreop, Prp.RQuirurgico,
										Prp.ProfAntibiotica, Prp.ProfOtros, Prp.ProfTromboembolica, Prp.Region, Prp.FPreoperatoria,
										Prp.DNIMedicoPreop, Prp.DescPreop, Prp.TecPrevistas, Prp.CSuspendida, Prp.FPrevista,
										Prp.Ambulatoria, Prp.Tipo, Prp.PreopCompleto, Prp.FIntervencion, Prp.Autotransfusion,
										Prp.VistoBueno, Prp.MedicoRemite, Prp.CodMutua, Prp.Anestesista, Prp.FConsentInterv,
										Prp.FConsentProtesis, Prp.CodCenRemite, Prp.Preanestesia, Prp.FPasivo, Prp.DiasLEspera,
										Prp.NecesHemoderiv, Prp.UsuHemoderiv, Prp.CodHistoria, Prp.Eliminado, Prp.Servicio,
										Prp.FechaFirma, Prp.FechaUltimaAct, Prp.DescProtocolo, Prp.CiruMenor, Prp.TiempoOper,
										Prp.CodProtocolo2, Prp.DescProtocolo2, Prp.CodProtocolo3, Prp.DescProtocolo3, Prp.cma, 
										Prp.MotivoPreferente, Prp.Estado, Prp.JornadaExtra, Prp.DniASQ, Prp.FEliminada, Prp.FSuspendida,
										Prp.TasaMorbilidad, Prp.TasaMortalidad, Prp.Lateralidad, Prp.ResaltaPlaning, Prp.CodExamInterven,
										Prp.TieneImagen, Prp.Factivo, Prp.FultimoPasivo, Prp.JornadaExtraVali, Prp.DniASQVali,
										Prp.ObservacionesPreoper, Prp.Confirmacion, Prp.EliminadoPlan, Prp.CMAsinHDIA,
										Prp.CodigoGRD, Prp.PesoGRD, Prp.Complejidad, Prp.RequiereUvi, Prp.EstadoRCLE, Prp.InfoPaciente,
										Prp.dniInfoPacMed, Prp.dniInfoPacEnf, Prp.dniInfoPacAnes, Prp.FInfoPaciente, Prp.ObsEnfermeria,
										Prp.Neoplasia, Prp.DniCirujanoPrevisto, Prp.AvisadoPac, Prp.ObservacionesAvisadoPac,
										Prp.DniAvisadoPac, Prp.CodAvisoPac, Prp.ComplejidadPreop, Prp.IntervencionEspecial,
										Prp.UHD, Prp.TieneEquipo, Prp.CentroDestino, Prp.TipoCenRemite, Prp.ServicioOrigen,
										Prp.Ayudantes, Prp.AlergiaLatex, Prp.RequiereIngreso, Prp.TieneProtesis, Prp.Infeccioso,
										Prp.Preparatoria, Prp.DNISuspendida, Prp.DNIEliminada, Prp.FecModificacionPreop,
										Prp.CiruAUrgente, Prp.DniAyudantePrevisto, Prp.AvisoPlanificar, Prp.FPrevistaIntervencion,
										Prp.NumListaRCLE, Prp.EsSincronizadoRCLE, Prp.PacFirmaConsen, Prp.NumSuspensiones,
										Prp.Observaciones, Prp.Pagado, Prp.CodMotivoPreferente, Prp.IdPlano, Prp.IdCuadrante,
										Prp.EsReIntervencion, Prp.DescReIntervencion, Prp.Validado, GetDate(), @spvar_DNIUsuarioModifica 
								   FROM HClinica..Preoperatoria Prp
								   WHERE CodIntervencion = @spvar_CodIntervencion
						
							update hclinica..preoperatoria
							set EstadoRCLE = parametros.dbo.fnParValorConstante('m_strEstadoRCLEFirmaU')
							where CodIntervencion = @spvar_CodIntervencion							
						end
						else
						begin
						
								INSERT INTO Historificacion..HClinica_Preoperatoria
								   (CodHojaPreop, CodIntervencion, CodPaciente, CodEpisodio, CodProc,
									CodProtocolo, TipoAnestesia, JClinico, CodCIEPreop, RQuirurgico,
									ProfAntibiotica, ProfOtros, ProfTromboembolica, Region, FPreoperatoria,
									DNIMedicoPreop, DescPreop, TecPrevistas, CSuspendida, FPrevista,
									Ambulatoria, Tipo, PreopCompleto, FIntervencion, Autotransfusion,
									VistoBueno, MedicoRemite, CodMutua, Anestesista, FConsentInterv,
									FConsentProtesis, CodCenRemite, Preanestesia, FPasivo, DiasLEspera,
									NecesHemoderiv, UsuHemoderiv, CodHistoria, Eliminado, Servicio,
									FechaFirma, FechaUltimaAct, DescProtocolo, CiruMenor, TiempoOper,
									CodProtocolo2, DescProtocolo2, CodProtocolo3, DescProtocolo3, cma, 
									MotivoPreferente, Estado, JornadaExtra, DniASQ, FEliminada, FSuspendida,
									TasaMorbilidad, TasaMortalidad, Lateralidad, ResaltaPlaning, CodExamInterven,
									TieneImagen, Factivo, FultimoPasivo, JornadaExtraVali, DniASQVali,
									ObservacionesPreoper, Confirmacion, EliminadoPlan, CMAsinHDIA,
									CodigoGRD, PesoGRD, Complejidad, RequiereUvi, EstadoRCLE, InfoPaciente,
									dniInfoPacMed, dniInfoPacEnf, dniInfoPacAnes, FInfoPaciente, ObsEnfermeria,
									Neoplasia, DniCirujanoPrevisto, AvisadoPac, ObservacionesAvisadoPac,
									DniAvisadoPac, CodAvisoPac, ComplejidadPreop, IntervencionEspecial,
									UHD, TieneEquipo, CentroDestino, TipoCenRemite, ServicioOrigen,
									Ayudantes, AlergiaLatex, RequiereIngreso, TieneProtesis, Infeccioso,
									Preparatoria, DNISuspendida, DNIEliminada, FecModificacionPreop,
									CiruAUrgente, DniAyudantePrevisto, AvisoPlanificar, FPrevistaIntervencion,
									NumListaRCLE, EsSincronizadoRCLE, PacFirmaConsen, NumSuspensiones,
									Observaciones, Pagado, CodMotivoPreferente, IdPlano, IdCuadrante,
									EsReIntervencion, DescReIntervencion, Validado, FCreacionHistorico, DNIUsuarioModifica )
							 SELECT Prp.CodHojaPreop, Prp.CodIntervencion, Prp.CodPaciente, Prp.CodEpisodio, Prp.CodProc,
									Prp.CodProtocolo, Prp.TipoAnestesia, Prp.JClinico, Prp.CodCIEPreop, Prp.RQuirurgico,
									Prp.ProfAntibiotica, Prp.ProfOtros, Prp.ProfTromboembolica, Prp.Region, Prp.FPreoperatoria,
									Prp.DNIMedicoPreop, Prp.DescPreop, Prp.TecPrevistas, Prp.CSuspendida, Prp.FPrevista,
									Prp.Ambulatoria, Prp.Tipo, Prp.PreopCompleto, Prp.FIntervencion, Prp.Autotransfusion,
									Prp.VistoBueno, Prp.MedicoRemite, Prp.CodMutua, Prp.Anestesista, Prp.FConsentInterv,
									Prp.FConsentProtesis, Prp.CodCenRemite, Prp.Preanestesia, Prp.FPasivo, Prp.DiasLEspera,
									Prp.NecesHemoderiv, Prp.UsuHemoderiv, Prp.CodHistoria, Prp.Eliminado, Prp.Servicio,
									Prp.FechaFirma, Prp.FechaUltimaAct, Prp.DescProtocolo, Prp.CiruMenor, Prp.TiempoOper,
									Prp.CodProtocolo2, Prp.DescProtocolo2, Prp.CodProtocolo3, Prp.DescProtocolo3, Prp.cma, 
									Prp.MotivoPreferente, Prp.Estado, Prp.JornadaExtra, Prp.DniASQ, Prp.FEliminada, Prp.FSuspendida,
									Prp.TasaMorbilidad, Prp.TasaMortalidad, Prp.Lateralidad, Prp.ResaltaPlaning, Prp.CodExamInterven,
									Prp.TieneImagen, Prp.Factivo, Prp.FultimoPasivo, Prp.JornadaExtraVali, Prp.DniASQVali,
									Prp.ObservacionesPreoper, Prp.Confirmacion, Prp.EliminadoPlan, Prp.CMAsinHDIA,
									Prp.CodigoGRD, Prp.PesoGRD, Prp.Complejidad, Prp.RequiereUvi, Prp.EstadoRCLE, Prp.InfoPaciente,
									Prp.dniInfoPacMed, Prp.dniInfoPacEnf, Prp.dniInfoPacAnes, Prp.FInfoPaciente, Prp.ObsEnfermeria,
									Prp.Neoplasia, Prp.DniCirujanoPrevisto, Prp.AvisadoPac, Prp.ObservacionesAvisadoPac,
									Prp.DniAvisadoPac, Prp.CodAvisoPac, Prp.ComplejidadPreop, Prp.IntervencionEspecial,
									Prp.UHD, Prp.TieneEquipo, Prp.CentroDestino, Prp.TipoCenRemite, Prp.ServicioOrigen,
									Prp.Ayudantes, Prp.AlergiaLatex, Prp.RequiereIngreso, Prp.TieneProtesis, Prp.Infeccioso,
									Prp.Preparatoria, Prp.DNISuspendida, Prp.DNIEliminada, Prp.FecModificacionPreop,
									Prp.CiruAUrgente, Prp.DniAyudantePrevisto, Prp.AvisoPlanificar, Prp.FPrevistaIntervencion,
									Prp.NumListaRCLE, Prp.EsSincronizadoRCLE, Prp.PacFirmaConsen, Prp.NumSuspensiones,
									Prp.Observaciones, Prp.Pagado, Prp.CodMotivoPreferente, Prp.IdPlano, Prp.IdCuadrante,
									Prp.EsReIntervencion, Prp.DescReIntervencion, Prp.Validado, GetDate(), @spvar_DNIUsuarioModifica 
							   FROM HClinica..Preoperatoria Prp
							   WHERE CodIntervencion = @spvar_CodIntervencion
								
							update hclinica..preoperatoria
							set EstadoRCLE = parametros.dbo.fnParValorConstante('m_strEstadoRCLEFirmaPP')
							where CodIntervencion = @spvar_CodIntervencion
						end
 					end

					--	Si no se facilita el cÃ³digo de informe (informe nuevo), se genera un cÃ³digo nuevo.
					If @spvar_CodInforme Is Null

						Begin

							--	Obtener el nuevo cÃ³digo de informe.
							Declare @Numero Varchar(5)
							Declare @Anyo Varchar(2)

							Select @Anyo = substring(convert(varchar(4),datepart(yy,getdate())),3,2)

							Select 
								@Numero =convert(varchar(5), IsNull(Max(convert(int,SubString(CodInforme,3,5)))+1,1))
							From 
								HClinica..InformeQuirurgico		
							Where
								CodInforme Like @Anyo + '%'

							Select @spvar_CodInforme = convert(varchar(7), @Anyo + stuff('00000', 6-DataLength(@Numero), DataLength(@Numero), @Numero))	

						End			

					--	Borrado de cualquier informe previo.
					Delete From HClinica..InformeQuirurgico
					Where 
						CodIntervencion = @spvar_CodIntervencion

					-- Para asegurarnos de que no inserta un Codigo de Mutua null
					If @spvar_CodMutua is null
					begin
						Select @spvar_CodMutua = CodMutua
						From HClinica..Preoperatoria
						Where CodIntervencion = @spvar_CodIntervencion
					end

					-- Para asegurarnos de que no inserta un Codigo de Procedimiento null
					If @spvar_CodProcedimiento is null
					begin
						Select @spvar_CodProcedimiento = CodProc
						From HClinica..Preoperatoria
						Where CodIntervencion = @spvar_CodIntervencion
					end


					--CTF - 73569626D - CHC3335_ModificaciÃ³n Campo Analista en InfQuirurgico - INI
					IF (SELECT ValorConstante FROM Parametros..constantes WHERE NombreConstante = 'm_bolAnestesiologia' and CentroRef=@spvar_CodCentro)=1 
						BEGIN
							Select @spvar_NombreAnestesista = null
						END
					--CTF - 73569626D - CHC3335_ModificaciÃ³n Campo Analista en InfQuirurgico - FIN

					--	InserciÃ³n de los datos en la tabla.
					Insert HClinica..InformeQuirurgico (
						CodIntervencion,
						CodInforme,
						CodPaciente, 
						CodEpisodio, 
						FSolicitud, 
						CodCirujano,
						CodInstrumentista,
                        CodAyudante1, 
						CodAyudante2, 
						CodAyudante3, 
                        CodMedInforma, 
						CodQuirofano, 
						PosicionInter,
                        CodVia, 
						CodProcedimiento, 
						CodPostCIE,
                        CodAntibioticos, 
						TipoInter, 
						DestinoInter,
						Drenaje, 
						TecnicasEmpleadas, 
                        TecnicaCierre, 
						PiezaExtirpada, 
						HInicioInter,
                        HFinInter, 
						FInforme,
						CodMutua, 
						Facturable,
                        CantidadProcesos,
						DescOperatoria,
						SolBiopsia,
						SolLaboratorio,
						SolCitologias,
						SolHormonales,
						SolRadiologia,
						SolPostmortem,
						Firmado,
						NumCordales,
						CodExamInterven,
						CodExamInterven1,
						CodExamInterven2
						--InfoPaciente
						--CTF - 73569626D - CHC3335_ModificaciÃ³n Campo Analista en InfQuirurgico 
						,NombreAnestesista
						--(08/09/2015) - v4.53r1 - 2500 - VAS - Plano y extremidad de intervenciones quirÃºrgicas - INI
					    ,IdPlano 
					    ,IdCuadrante 
					    --(08/09/2015) - v4.53r1 - 2500 - VAS - Plano y extremidad de intervenciones quirÃºrgicas - FIN
						,IdTurnoInfQuirurgico
						,Estado
						
					)  
                   	Values (
						@spvar_CodIntervencion,
						@spvar_CodInforme,
						@spvar_CodPaciente, 
						@spvar_CodEpisodio, 
						@spvar_FSolicitud, 
						@spvar_CodCirujano, 
						@spvar_CodInstrumentista, 
                        @spvar_CodAyuda1, 
						@spvar_CodAyuda2, 
						@spvar_CodAyuda3, 
						@spvar_CodMedInforma, 
                        @spvar_CodQuirofano, 
						@spvar_Posicion, 
						@spvar_CodVia, 
						@spvar_CodProcedimiento, 
						@spvar_CodCIE, 	
						@spvar_CodAntibiotico,
                        @spvar_TipoIntervencion, 
						@spvar_Destino, 
						@spvar_Drenaje, 
						@spvar_TecnicaEmpleada, 
						@spvar_TecnicaCierre, 
                        @spvar_Pieza, 
						@spvar_HoraInicio, 
						@spvar_HoraFin, 
						@spvar_FInforme,
						@spvar_CodMutua, 
						@spvar_Facturable,
                        @spvar_CantidadProcesos,
						@spvar_DescOperatoria,
						@spvar_SolBiopsia,
						@spvar_SolLaboratorio,
						@spvar_SolCitologias,
						@spvar_SolHormonales,
						@spvar_SolRadiologia,
						@spvar_SolPostmortem,
						@spvar_Firmado,
						@spvar_NumCordales,
					    @spvar_CodExamInterv,
						@spvar_CodExamInterv1,
						@spvar_CodExamInterv2
						--@spvar_InfoPaciente
						--CTF - 73569626D - CHC3335_ModificaciÃ³n Campo Analista en InfQuirurgico 
						,@spvar_NombreAnestesista
						--(08/09/2015) - v4.53r1 - 2500 - VAS - Plano y extremidad de intervenciones quirÃºrgicas - INI
						,@spvar_IdPlano
						,@spvar_IdCuadrante
						--(08/09/2015) - v4.53r1 - 2500 - VAS - Plano y extremidad de intervenciones quirÃºrgicas - FIN
						,@spvar_idTurnoInfQuirurgico
						,@spvar_Estado
						
					)

					--	Actualizar la fecha de la intervenciÃ³n en la hoja preoperatoria.
					
					
					INSERT INTO Historificacion..HClinica_Preoperatoria
						   (CodHojaPreop, CodIntervencion, CodPaciente, CodEpisodio, CodProc,
							CodProtocolo, TipoAnestesia, JClinico, CodCIEPreop, RQuirurgico,
							ProfAntibiotica, ProfOtros, ProfTromboembolica, Region, FPreoperatoria,
							DNIMedicoPreop, DescPreop, TecPrevistas, CSuspendida, FPrevista,
							Ambulatoria, Tipo, PreopCompleto, FIntervencion, Autotransfusion,
							VistoBueno, MedicoRemite, CodMutua, Anestesista, FConsentInterv,
							FConsentProtesis, CodCenRemite, Preanestesia, FPasivo, DiasLEspera,
							NecesHemoderiv, UsuHemoderiv, CodHistoria, Eliminado, Servicio,
							FechaFirma, FechaUltimaAct, DescProtocolo, CiruMenor, TiempoOper,
							CodProtocolo2, DescProtocolo2, CodProtocolo3, DescProtocolo3, cma, 
							MotivoPreferente, Estado, JornadaExtra, DniASQ, FEliminada, FSuspendida,
							TasaMorbilidad, TasaMortalidad, Lateralidad, ResaltaPlaning, CodExamInterven,
							TieneImagen, Factivo, FultimoPasivo, JornadaExtraVali, DniASQVali,
							ObservacionesPreoper, Confirmacion, EliminadoPlan, CMAsinHDIA,
							CodigoGRD, PesoGRD, Complejidad, RequiereUvi, EstadoRCLE, InfoPaciente,
							dniInfoPacMed, dniInfoPacEnf, dniInfoPacAnes, FInfoPaciente, ObsEnfermeria,
							Neoplasia, DniCirujanoPrevisto, AvisadoPac, ObservacionesAvisadoPac,
							DniAvisadoPac, CodAvisoPac, ComplejidadPreop, IntervencionEspecial,
							UHD, TieneEquipo, CentroDestino, TipoCenRemite, ServicioOrigen,
							Ayudantes, AlergiaLatex, RequiereIngreso, TieneProtesis, Infeccioso,
							Preparatoria, DNISuspendida, DNIEliminada, FecModificacionPreop,
							CiruAUrgente, DniAyudantePrevisto, AvisoPlanificar, FPrevistaIntervencion,
							NumListaRCLE, EsSincronizadoRCLE, PacFirmaConsen, NumSuspensiones,
							Observaciones, Pagado, CodMotivoPreferente, IdPlano, IdCuadrante,
							EsReIntervencion, DescReIntervencion, Validado, FCreacionHistorico, DNIUsuarioModifica )
					 SELECT Prp.CodHojaPreop, Prp.CodIntervencion, Prp.CodPaciente, Prp.CodEpisodio, Prp.CodProc,
							Prp.CodProtocolo, Prp.TipoAnestesia, Prp.JClinico, Prp.CodCIEPreop, Prp.RQuirurgico,
							Prp.ProfAntibiotica, Prp.ProfOtros, Prp.ProfTromboembolica, Prp.Region, Prp.FPreoperatoria,
							Prp.DNIMedicoPreop, Prp.DescPreop, Prp.TecPrevistas, Prp.CSuspendida, Prp.FPrevista,
							Prp.Ambulatoria, Prp.Tipo, Prp.PreopCompleto, Prp.FIntervencion, Prp.Autotransfusion,
							Prp.VistoBueno, Prp.MedicoRemite, Prp.CodMutua, Prp.Anestesista, Prp.FConsentInterv,
							Prp.FConsentProtesis, Prp.CodCenRemite, Prp.Preanestesia, Prp.FPasivo, Prp.DiasLEspera,
							Prp.NecesHemoderiv, Prp.UsuHemoderiv, Prp.CodHistoria, Prp.Eliminado, Prp.Servicio,
							Prp.FechaFirma, Prp.FechaUltimaAct, Prp.DescProtocolo, Prp.CiruMenor, Prp.TiempoOper,
							Prp.CodProtocolo2, Prp.DescProtocolo2, Prp.CodProtocolo3, Prp.DescProtocolo3, Prp.cma, 
							Prp.MotivoPreferente, Prp.Estado, Prp.JornadaExtra, Prp.DniASQ, Prp.FEliminada, Prp.FSuspendida,
							Prp.TasaMorbilidad, Prp.TasaMortalidad, Prp.Lateralidad, Prp.ResaltaPlaning, Prp.CodExamInterven,
							Prp.TieneImagen, Prp.Factivo, Prp.FultimoPasivo, Prp.JornadaExtraVali, Prp.DniASQVali,
							Prp.ObservacionesPreoper, Prp.Confirmacion, Prp.EliminadoPlan, Prp.CMAsinHDIA,
							Prp.CodigoGRD, Prp.PesoGRD, Prp.Complejidad, Prp.RequiereUvi, Prp.EstadoRCLE, Prp.InfoPaciente,
							Prp.dniInfoPacMed, Prp.dniInfoPacEnf, Prp.dniInfoPacAnes, Prp.FInfoPaciente, Prp.ObsEnfermeria,
							Prp.Neoplasia, Prp.DniCirujanoPrevisto, Prp.AvisadoPac, Prp.ObservacionesAvisadoPac,
							Prp.DniAvisadoPac, Prp.CodAvisoPac, Prp.ComplejidadPreop, Prp.IntervencionEspecial,
							Prp.UHD, Prp.TieneEquipo, Prp.CentroDestino, Prp.TipoCenRemite, Prp.ServicioOrigen,
							Prp.Ayudantes, Prp.AlergiaLatex, Prp.RequiereIngreso, Prp.TieneProtesis, Prp.Infeccioso,
							Prp.Preparatoria, Prp.DNISuspendida, Prp.DNIEliminada, Prp.FecModificacionPreop,
							Prp.CiruAUrgente, Prp.DniAyudantePrevisto, Prp.AvisoPlanificar, Prp.FPrevistaIntervencion,
							Prp.NumListaRCLE, Prp.EsSincronizadoRCLE, Prp.PacFirmaConsen, Prp.NumSuspensiones,
							Prp.Observaciones, Prp.Pagado, Prp.CodMotivoPreferente, Prp.IdPlano, Prp.IdCuadrante,
							Prp.EsReIntervencion, Prp.DescReIntervencion, Prp.Validado, GetDate(), @spvar_DNIUsuarioModifica 
					   FROM HClinica..Preoperatoria Prp
					   WHERE CodIntervencion = @spvar_CodIntervencion
					
					
					Update 
						HClinica..Preoperatoria
					Set 
						FIntervencion = @spvar_HoraInicio
					Where 
						CodIntervencion = @spvar_CodIntervencion

					-- Actualizamos la fecha de ingreso si es posterior al inicio de la intervencion
					if @spvar_ActualizaIngreso = '1'
					begin
						update ingresos..episodiohospitalizacion
						set FechaHospitalizacion = @spvar_HoraInicio
						where CodPaciente = @spvar_CodPaciente and CodEpisodio = @spvar_CodEpisodio 
					end
					
					Select 0

				End

		End

	Else

		Select 1
		
/* 01/04/2009		JGALVEZ		ENIAC1/PREPROD		Command(s) completed successfully */




GO



--dbo.SpConSInfQuirurImpresion.sql

USE [Consultas]
GO

/****** Object:  StoredProcedure [dbo].[SpConSInfQuirurImpresion]    Script Date: 12/13/2013 09:31:01 ******/
IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[SpConSInfQuirurImpresion]') AND type in (N'P', N'PC'))
DROP PROCEDURE [dbo].[SpConSInfQuirurImpresion]
GO

USE [Consultas]
GO

/****** Object:  StoredProcedure [dbo].[SpConSInfQuirurImpresion]    Script Date: 12/13/2013 09:31:01 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO




--	PROCEDIMIENTO		: 	SpConSInfQuirurImpresion
--	FUNCION             : 	Obtiene los datos de impresión para el nuevo documento de Informe Quirúrgico
--							"rptInfQuirurgico.rpt" de tipo de episodio Consultas Externas 
--	FECHA               : 	27/12/2012
--	VERSION             : 	SIDRA 4.35 Release 1 CHC2414
--	AUTOR               : 	Miguel Ángel Sánchez
--	APLICACIÓN ORIGEN   : 	Informe quirurgico
--  Modificación        :   04/01/2013 - MAS - CHC2414 v4.35 Release 1 - No mostraba los nombres de los 3 ayudantes
--  Modificación		:   06/06/2013 - CTF - 73569626 - v4.39 - HC3096_REQ29954_MODIFICACIÓN PROTOCOLO OPERATORIO
--  MODIFICACION		:	10/07/2013 25412344N - CHC2947 - REQ27104 - v4.40 - CREACIÓN DE COMBOBOX PREFERENTE MODULO QUIROFANO 	
--  MODIFICACION		: 13/12/2013 - CTF - 73569626D - CHC3335_Modificación Campo Analista en InfQuirurgico 
--  MODIFICACIÓN        : 23/10/2017 - v17.3r1 - MMM - 16152 - Agregar estado de Diagnósticos en solicitud de pabellón									
--*******************************************************************


CREATE Proc [dbo].[SpConSInfQuirurImpresion]
	@spvar_CodIntervencion varchar(7),
	@spvar_CodHojaPreop varchar(7)
As
	--	Declaración de variables
	Declare @spvar_DNICir Char(8)
	Declare @spvar_DNIAnes Char(8)
	Declare @spvar_DNIEnf Char(8)
	Declare @spvar_DNI1 Char(8)
	Declare @spvar_DNI2 Char(8)
	Declare @spvar_DNI3 Char(8)
	Declare @spvar_Cir VarChar(45)
	Declare @spvar_Anes Varchar(45)
	Declare @spvar_Enf Varchar(45)
	Declare @spvar_Ayu1 Varchar(45)
	Declare @spvar_Ayu2 Varchar(45)
	Declare @spvar_Ayu3 Varchar(45)
	Declare @spvar_DiagPre char(256)
	Declare @spvar_DiagPreSecun char (256)
	Declare @spvar_EstadoPreopPrin int
	Declare @spvar_OpePro char(256)
	
	--CTF - 73569626D - CHC3335_Modificación Campo Analista en InfQuirurgico
	  Declare @spvar_UnidadAnestesia bit 

	--  Valor de variables
	Select @spvar_DNICir = ''
	Select @spvar_DNIAnes = ''
	Select @spvar_DNIEnf = ''
	Select @spvar_DNI1 = ''
	Select @spvar_DNI2 = ''
	Select @spvar_DNI3 = ''

	--------------------------------------------------------------------------------
	--  OBTENCION DE DNIs
	--------------------------------------------------------------------------------
	--	Obtencin del DNI del cirujano, del instrumentista y de los ayudantes.	
	Select 
		@spvar_DNICir = CodCirujano,
		@spvar_DNIEnf = CodInstrumentista,
		@spvar_DNI1 = CodAyudante1,
		@spvar_DNI2 = CodAyudante2,
		@spvar_DNI3 = CodAyudante3
	From 
		HClinica..InformeQuirurgico
	Where 
		CodIntervencion = @spvar_CodIntervencion

	--	Obtencin del DNI del anestesista.
	Select 
		@spvar_DNIAnes = DNIAnestesista
	From 
		HClinica..InformeAnestesico
	Where 
		CodIntervencion = @spvar_CodIntervencion

	------------------------------------------------------------------------------------
	--  OBTENCION DE NOMBRES
	------------------------------------------------------------------------------------
	--	Obtencin del nombre del cirujano.
	Select 
		@spvar_Cir = Rtrim(parametros..ParametrosMedicos.NomMedico)+' '+RTrim(parametros..ParametrosMedicos.Apell1)+' '+RTrim(parametros..ParametrosMedicos.Apell2)
	From 
		Parametros..ParametrosMedicos
	Where 
		DNIMedico = @spvar_DNICir
		
	--	Obtencin del nombre del anestesista.
	 --CTF - 73569626D - CHC3335_Modificación Campo Analista en InfQuirurgico - INI
      Select 
            @spvar_UnidadAnestesia = ValorConstante
      From 
            Parametros..Constantes
      Where 
            NombreConstante like 'm_bolAnestesiologia'
      
      IF @spvar_UnidadAnestesia=0
		  Select 
				@spvar_Anes = NombreAnestesista
		  From 
				HClinica..InformeQuirurgico
		  Where 
				CodIntervencion = @spvar_CodIntervencion
      ELSE
	  --CTF - 73569626D - CHC3335_Modificación Campo Analista en InfQuirurgico - FIN
		  Select 
	   		@spvar_Anes = Rtrim(parametros..ParametrosMedicos.NomMedico)+' '+RTrim(parametros..ParametrosMedicos.Apell1)+' '+RTrim(parametros..ParametrosMedicos.Apell2)
		  From 
			Parametros..ParametrosMedicos
		  Where 
			DNIMedico = @spvar_DNIAnes

	--	Obtencin del nombre del instrumentista.
	Select 
		@spvar_Enf = Rtrim(parametros..DatosEnfermeras.NombreEnf)+' '+RTrim(parametros..DatosEnfermeras.Apell1Enf)+' '+RTrim(parametros..DatosEnfermeras.Apell2Enf)
	From 
		Parametros..DatosEnfermeras
	Where 
		DNIEnf = @spvar_DNIEnf

	-- 04/01/2013 - MAS - CHC2414 v4.35 Release 1 - No mostraba los nombres de los 3 ayudantes - INI
	--	Obtencin del nombre del primer ayudante.
	--Select 
	--	@spvar_Ayu1 = Rtrim(parametros..DatosEnfermeras.NombreEnf)+' '+RTrim(parametros..DatosEnfermeras.Apell1Enf)+' '+RTrim(parametros..DatosEnfermeras.Apell2Enf)
	--From 
	--	Parametros..DatosEnfermeras
	--Where 
	--	DNIEnf = @spvar_DNI1
	Select 
		@spvar_Ayu1 = Rtrim(parametros..ParametrosMedicos.NomMedico)+' '+RTrim(parametros..ParametrosMedicos.Apell1)+' '+RTrim(parametros..ParametrosMedicos.Apell2)
	From 
		Parametros..ParametrosMedicos
	Where 
		DNIMedico = @spvar_DNI1

	--	Obtencin del nombre del segundo ayudante.
	--Select 
	--	@spvar_Ayu2 = Rtrim(parametros..DatosEnfermeras.NombreEnf)+' '+RTrim(parametros..DatosEnfermeras.Apell1Enf)+' '+RTrim(parametros..DatosEnfermeras.Apell2Enf)
	--From 
	--	Parametros..DatosEnfermeras
	--Where 
	--	DNIEnf = @spvar_DNI2
	Select 
		@spvar_Ayu2 = Rtrim(parametros..ParametrosMedicos.NomMedico)+' '+RTrim(parametros..ParametrosMedicos.Apell1)+' '+RTrim(parametros..ParametrosMedicos.Apell2)
	From 
		Parametros..ParametrosMedicos
	Where 
		DNIMedico = @spvar_DNI2

	--	Obtencin del nombre del tercer ayudante.
	--Select 
	--	@spvar_Ayu3 = Rtrim(parametros..DatosEnfermeras.NombreEnf)+' '+RTrim(parametros..DatosEnfermeras.Apell1Enf)+' '+RTrim(parametros..DatosEnfermeras.Apell2Enf)
	--From 
	--	Parametros..DatosEnfermeras
	--Where 
	--	DNIEnf = @spvar_DNI3
	Select 
		@spvar_Ayu3 = Rtrim(parametros..ParametrosMedicos.NomMedico)+' '+RTrim(parametros..ParametrosMedicos.Apell1)+' '+RTrim(parametros..ParametrosMedicos.Apell2)
	From 
		Parametros..ParametrosMedicos
	Where 
		DNIMedico = @spvar_DNI3
	-- 04/01/2013 - MAS - CHC2414 v4.35 Release 1 - No mostraba los nombres de los 3 ayudantes - FIN
	
	-- Obtención del diagnóstico preoperatorio y operación propuesta de la Hoja Preoperatoria
	SELECT
	    --CTF - CHC3096_REQ29954_MODIFICACIÓN PROTOCOLO OPERATORIO - INI
		--@spvar_DiagPre = DescDiagnostico,
		@spvar_DiagPre='(' + LTrim(RTrim(isnull(C.CodOficial,''))) +') '+DescDiagnostico ,

			@spvar_DiagPreSecun = ', ' + isnull((Select SUBSTRING((select ', (' + LTrim(RTrim(isnull(Diag2.CodOficial,''))) +') '+Diag2.DescDiagnostico  + ' (' + ED.Estado + ')' 
							   from Parametros..CIEDiagnostico Diag2 
									INNER JOIN Consultas..CapituloQPreopera EQ 
													ON EQ.CodIntervencion=HP.CodIntervencion
													AND EQ.CodCapitulo = Diag2.CodDiagnostico left join Parametros..EstadosDiagnosticos ED on ED.IdEstadosDiagnostico = EQ.Estado
									FOR XML PATH('')
									)
			,2,1000)),''),

			@spvar_EstadoPreopPrin = HP.Estado,

		
		--@spvar_OpePro = DescProced
		@spvar_OpePro ='('+isnull(CodFonDeis,'') + ') ' + DescProced +', ' +
			isnull((Select SUBSTRING((select ', ('+ isnull(P.CodFonDeis,'')+') '+ LTrim(RTrim(P.DescProced))
					from  
						Consultas..CapituloQPreopera EQ,
        				Parametros..Procedimientos P
   					WHERE 
						CodIntervencion = HP.CodIntervencion
						AND EQ.CodCapitulo = P.CodDiagnostico 
					FOR XML PATH(''))
			,2,1000)),'')
		--CTF - CHC3096_REQ29954_MODIFICACIÓN PROTOCOLO OPERATORIO - FIN	
	FROM HClinica..Preoperatoria HP,
		 --CTF - CHC3096_REQ29954_MODIFICACIÓN PROTOCOLO OPERATORIO -- INI			  
		 --parametros..CIEDiagnostico,
		 parametros..CIEDiagnostico C,
		 parametros..Procedimientos
		 --parametros..MutuasSalud CM
		 --CTF - CHC3096_REQ29954_MODIFICACIÓN PROTOCOLO OPERATORIO -- FIN

	WHERE HP.CodHojaPreop=@spvar_CodHojaPreop 
		  And HP.CodIntervencion=@spvar_CodIntervencion  
		  And HP.CodProc=parametros..Procedimientos.CodDiagnostico 
		  --CTF - CHC3096_REQ29954_MODIFICACIÓN PROTOCOLO OPERATORIO - INI
		  --And HP.CodCIEPreop= parametros..CIEDiagnostico.CodDiagnostico 
		  And HP.CodCIEPreop=C.CodDiagnostico 
		  --And CM.Codigo=HP.CodMutua
		   --CTF - CHC3096_REQ29954_MODIFICACIÓN PROTOCOLO OPERATORIO -- FIN
		  And HP.Eliminado is null	
		
	------------------------------------------------------------------------------------
	--  SELECT QUERY PARA DEVOLVER
	------------------------------------------------------------------------------------
	select  @spvar_Cir as NombreCirujano,
			@spvar_Anes as NombreAnestesista,
			@spvar_Enf as NombreInstrumentista,
			@spvar_Ayu1 as NombreAyudante1,
			@spvar_Ayu2 as NombreAyudante2,
			@spvar_Ayu3 as NombreAyudante3,
			HInicioInter as FechaOperacion,
			@spvar_OpePro as DiagnosticoPropuesta,
			@spvar_DiagPre as DiagnosticoPreoperatorio,
			@spvar_DiagPreSecun as DiagnosticoPreOperSecundario, 
			@spvar_EstadoPreopPrin as EstadoPreOperPrincipal,
			--CTF - CHC3096_REQ29954_MODIFICACIÓN PROTOCOLO OPERATORIO - INI
			--DescProced as OperacionPracticada,
			OperacionPracticada= isnull(CodFonDeis,'') + ' ' + DescProced +', ' +
				isnull((Select SUBSTRING((select ', '+ isnull(P.CodFonDeis,'')+' '+ LTrim(RTrim(P.DescProced))
						from  
							Consultas..CapituloQuirurgico EQ,
        					Parametros..Procedimientos P
   						WHERE 
							CodIntervencion = IQ.CodIntervencion
							AND EQ.CodCapitulo = P.CodDiagnostico 
						FOR XML PATH(''))
				,2,1000)),''),
			--C.DescDiagnostico as DiagnosticoPostoperatorio,
			DiagnosticoPostoperatorioPrincipal='(' + LTrim(RTrim(isnull(C.CodOficial,''))) +') '+C.DescDiagnostico + ', ' ,
			--CTF - CHC3096_REQ29954_MODIFICACIÓN PROTOCOLO OPERATORIO - FIN
			
						
			DiagnosticoPostoperatorioSecundario = ', ' + isnull((Select SUBSTRING((select ', (' + LTrim(RTrim(isnull(Diag2.CodOficial,''))) +') '+Diag2.DescDiagnostico + ' (' + ED.Estado + ')'  
										   from Parametros..CIEDiagnostico Diag2 
												INNER JOIN Consultas..CapituloQuirurgico EQ ON EQ.CodCapitulo = Diag2.CodDiagnostico 
																and EQ.CodIntervencion=IQ.CodIntervencion left join Parametros..EstadosDiagnosticos ED on ED.IdEstadosDiagnostico = EQ.Estado
																																 
												FOR XML PATH('')
												)
						,2,1000)),''),		
							
			EstadoPostoperatorioPrincipal = IQ.Estado,	
			RQuirurgico as RiesgoQuirurgico,
			Riesgo=(Select Descripcion 
					From parametros..Codigos
					Where (Tabla='EstRiesgoInterv' Or Tabla='N') And Codigo=IsNull(P.RQuirurgico,'N')),
			P.TipoAnestesia,
			TAnestesia=(Select Descripcion 
                  		 From parametros..Codigos
                    		Where (Tabla='EstTipoAnestesia' Or Tabla='N') And Codigo=IsNull(P.TipoAnestesia,'N')),
			P.CodHistoria as HistoriaClinica,
			Rtrim(PAC.PacNombre) + ' ' + RTrim(PAC.PacApell1) + ' ' + RTrim(PAC.PacApell2) as NombrePaciente,
			--CTF - 73569626 - v4.39 - HC3096_REQ29954_MODIFICACIÓN PROTOCOLO OPERATORIO
	 		--- RRG - 25412344N - CHC2947 - REQ27104 - v4.40 - CREACIÓN DE COMBOBOX PREFERENTE MODULO QUIROFANO - INI
			--- Código Antiguo:
            --- P.MotivoPreferente,
			--- Código Nuevo:
			MP.Descripcion as MotivoPreferente,
			--- RRG - 25412344N - CHC2947 - REQ27104 - v4.40 - CREACIÓN DE COMBOBOX PREFERENTE MODULO QUIROFANO - FIN				  
			 P.Tipo	
			                  
	From 
			HClinica..InformeQuirurgico IQ
			left join Parametros..CIEDiagnostico C on CodPostCIE = c.CodDiagnostico
			right join Parametros..MutuasSalud M on M.Codigo = IQ.CodMutua
			right join Hclinica..Preoperatoria P on P.CodHojaPreop = @spvar_CodHojaPreop
			--- RRG - 25412344N - CHC2947 - REQ27104 - v4.40 - CREACIÓN DE COMBOBOX PREFERENTE MODULO QUIROFANO - INI
			--- Código antiguo:
			--- No hay
			--- Código nuevo:
			LEFT JOIN Parametros..MotivosIntervencionPreferente MP ON P.CodMotivoPreferente= MP.CodMotivo
			--- RRG - 25412344N - CHC2947 - REQ27104 - v4.40 - CREACIÓN DE COMBOBOX PREFERENTE MODULO QUIROFANO - FIN
			right join Hclinica..Pacientes PAC on PAC.CodHistoria = P.CodHistoria,
			
			Parametros..Procedimientos PRO		

	Where 
			IQ.CodIntervencion = @spvar_CodIntervencion And
			CodProcedimiento = PRO.CodDiagnostico 



GO




GO



--dbo.SpConSPreopEpisodio.sql

    USE [Consultas];
    GO
    IF EXISTS 
    (
        SELECT * 
            FROM sys.procedures 
            WHERE [object_id] = OBJECT_ID('[dbo].[SpConSPreopEpisodio]')
    )
    BEGIN
        DROP PROCEDURE [dbo].[SpConSPreopEpisodio];
    END
    GO
    


--	PROCEDIMIENTO		: 	SpConSPreopEpisodio
--	FUNCION             : 	Realiza varias acciones según los parámetros de entrada
--  FECHA				:	24/11/2008
--  AUTOR				:	MPS 
--  COMENTARIOS			:	Procede del antiguo SpConSQuiEpisodio
							--	FECHA               : 	20/12/2005
							--	VERSION             : 	1.0
							--	AUTOR               : 	Gerardo Prieto David (MECEMSA Consultores)
--	APLICACIN ORIGEN   	: 	Informe quirurgico
--  Modificacion        : Ismael(27/11/2007) Incluida la union en las select para que se vea la informacion
--											 en episodios de consulta e ingresos
--  Modificacion        : Ismael(27/01/2009) Ampliado el tamaño del campo CodHistoria
--  MODIFICACIÓN		: (04/09/2015) - v4.53r1 - SGN - 2500 - Plano y extremidad de intervenciones quirúrgicas
--  MODIFICACIÓN		: (23/10/2017) - v17.3r1 - MMM - 16152 - Agregar estado de Diagnósticos en solicitud de pabellón

CREATE PROC [dbo].[SpConSPreopEpisodio]

	@spvar_CodPaciente varchar(16),
    @spvar_CodEpisodio varchar(5),
	@spvar_Fecha Smalldatetime,
	@spvar_Tabla varchar(2),
	@spvar_Elemento VARCHAR(2),
	@spvar_Codigo varchar(7),
	@spvar_Accion CHAR(2),
	@spvar_CodHistoria varchar(8),
	@spvar_CodIntervencion varchar(7)
	--(04/09/2015) - v4.53r1 - SGN - 2500 - Plano y extremidad de intervenciones quirúrgicas - INI
	,@spvar_IdPlano tinyint = NULL
	,@spvar_IdCuadrante tinyint = NULL
	--(04/09/2015) - v4.53r1 - SGN - 2500 - Plano y extremidad de intervenciones quirúrgicas - FIN
	,@spvar_Estado int = NULL
	
AS

	--	Accion - Valores
	--
	--	01:	Mostrar - Protesis
	--	02:	Mostrar - Equipos
	--	03:	Mostrar - DiagnosticosCIE
	--	04:	Mostrar - Procedimientos

	--	1:	Insertar
	--	2:	Eliminar
	--	3:	Actualizar la Tabla Alertas

	DECLARE @F_Informe SMALLDATETIME

	--	Mostrar prtesis.
	IF @spvar_Accion = '01'
		
		SELECT 
			EQ.CodCapitulo,
          	CP.Implante + ' (' + CP.Fabricante + ')'
   		FROM 
			Consultas..CapituloQPreopera EQ,
        	Parametros..CodProtesis CP
   		WHERE 
			CodIntervencion = @spvar_CodIntervencion AND
			TabCapitulo like @spvar_Tabla AND 
			EleCapitulo = '1' AND 
			EQ.CodCapitulo like @spvar_Codigo AND 
			EQ.CodCapitulo = CP.CodImplante

		union

		SELECT 
			EQ.CodCapitulo,
          	CP.Implante + ' (' + CP.Fabricante + ')'
   		FROM 
			Ingresos..CapituloQPreopera EQ,
        	Parametros..CodProtesis CP
   		WHERE 
			CodIntervencion = @spvar_CodIntervencion AND
			TabCapitulo like @spvar_Tabla AND 
			EleCapitulo = '1' AND 
			EQ.CodCapitulo like @spvar_Codigo AND 
			EQ.CodCapitulo = CP.CodImplante

	--	Mostrar equipos.
	IF @spvar_Accion = '02'
   		
		SELECT 
			EQ.CodCapitulo,
          	CE.DescEquipo
   		FROM 
			Consultas..CapituloQPreopera EQ,
        	Parametros..DatosEquipos CE
   		WHERE 
			CodIntervencion = @spvar_CodIntervencion AND
			TabCapitulo like @spvar_Tabla AND 
			EleCapitulo = '0' AND 
			EQ.CodCapitulo like @spvar_Codigo AND 
			EQ.CodCapitulo = CE.CodigoEquipo

		union

		SELECT 
			EQ.CodCapitulo,
          	CE.DescEquipo
   		FROM 
			Ingresos..CapituloQPreopera EQ,
        	Parametros..DatosEquipos CE
   		WHERE 
			CodIntervencion = @spvar_CodIntervencion AND
			TabCapitulo like @spvar_Tabla AND 
			EleCapitulo = '0' AND 
			EQ.CodCapitulo like @spvar_Codigo AND 
			EQ.CodCapitulo = CE.CodigoEquipo

	--	Diagnsticos CIE.
	IF @spvar_Accion = '03'

   		SELECT 
			EQ.CodCapitulo,
          	D.DescDiagnostico, EQ.Estado
   		FROM 
			Consultas..CapituloQPreopera EQ,
        	Parametros..CIEDiagnostico D 
		WHERE 
			CodIntervencion = @spvar_CodIntervencion AND
			TabCapitulo like @spvar_Tabla AND 
			EleCapitulo = '2' AND 
			EQ.CodCapitulo like @spvar_Codigo AND 
			EQ.CodCapitulo = D.CodDiagnostico

		union

		SELECT 
			EQ.CodCapitulo,
          	D.DescDiagnostico, EQ.Estado
   		FROM 
			Ingresos..CapituloQPreopera EQ,
        	Parametros..CIEDiagnostico D 
		WHERE 
			CodIntervencion = @spvar_CodIntervencion AND
			TabCapitulo like @spvar_Tabla AND 
			EleCapitulo = '2' AND 
			EQ.CodCapitulo like @spvar_Codigo AND 
			EQ.CodCapitulo = D.CodDiagnostico

	--	Mostrar procedimientos.
	IF @spvar_Accion = '04'

		SELECT 
			EQ.CodCapitulo,
          	P.DescProced
          	--(04/09/2015) - v4.53r1 - SGN - 2500 - Plano y extremidad de intervenciones quirúrgicas - INI
          	,EQ.IdPlano
          	,EQ.IdCuadrante
          	,Pl.DescPlano
          	,C.DescCuadrante
          	--(04/09/2015) - v4.53r1 - SGN - 2500 - Plano y extremidad de intervenciones quirúrgicas - FIN
   		FROM 
			Consultas..CapituloQPreopera EQ
        	LEFT JOIN Parametros..Procedimientos P ON EQ.CodCapitulo = P.CodDiagnostico
        	--(04/09/2015) - v4.53r1 - SGN - 2500 - Plano y extremidad de intervenciones quirúrgicas - INI
        	LEFT JOIN Parametros..Planos Pl ON EQ.IdPlano=pl.IdPlano
        	LEFT JOIN Parametros..Cuadrantes C ON EQ.IdCuadrante=C.IdCuadrante
        	--(04/09/2015) - v4.53r1 - SGN - 2500 - Plano y extremidad de intervenciones quirúrgicas - FIN
   		WHERE 
			CodIntervencion = @spvar_CodIntervencion AND
			TabCapitulo like @spvar_Tabla AND 
			EleCapitulo = '3' AND 
			EQ.CodCapitulo like @spvar_Codigo  
			
		union

		SELECT 
			EQ.CodCapitulo,
          	P.DescProced
          	--(04/09/2015) - v4.53r1 - SGN - 2500 - Plano y extremidad de intervenciones quirúrgicas - INI
          	,EQ.IdPlano
          	,EQ.IdCuadrante
          	,Pl.DescPlano
          	,C.DescCuadrante
          	--(04/09/2015) - v4.53r1 - SGN - 2500 - Plano y extremidad de intervenciones quirúrgicas - FIN

   		FROM 
			Ingresos..CapituloQPreopera EQ
			LEFT JOIN Parametros..Procedimientos P ON EQ.CodCapitulo = P.CodDiagnostico
			--04/09/2015 - v4.53r1 - SGN - 2500 - Plano y extremidad de intervenciones quirúrgicas - INI
			LEFT JOIN Parametros..Planos Pl ON EQ.IdPlano = Pl.IdPlano
			LEFT JOIN Parametros..Cuadrantes C ON EQ.IdCuadrante = C.IdCuadrante
			 --04/09/2015 - v4.53r1 - SGN - 2500 - Plano y extremidad de intervenciones quirúrgicas - FIN
			
   		WHERE 
			CodIntervencion = @spvar_CodIntervencion AND
			TabCapitulo like @spvar_Tabla AND 
			EleCapitulo = '3' AND 
			EQ.CodCapitulo like @spvar_Codigo 
			  
	--	Insertar.
	IF @spvar_Accion = '1'

		INSERT CapituloQPreopera 
   		VALUES ( 
			@spvar_CodPaciente,
			@spvar_CodEpisodio,
			@spvar_Fecha,
			@spvar_Tabla,
			@spvar_Elemento,
			@spvar_Codigo, 
			@spvar_CodHistoria,
			@spvar_CodIntervencion
          	--(04/09/2015) - v4.53r1 - SGN - 2500 - Plano y extremidad de intervenciones quirúrgicas - INI
			,@spvar_IdPlano
			,@spvar_IdCuadrante
          	--(04/09/2015) - v4.53r1 - SGN - 2500 - Plano y extremidad de intervenciones quirúrgicas - FIN
			,@spvar_Estado
			)

	--	Eliminar.
	IF @spvar_Accion = '2'

		BEGIN

			--	Borrar de Lista de Problemas si son Intervenciones desde InformeQuirurgico.
  			IF '1' Like @spvar_Tabla AND '3' Like @spvar_Elemento 
		
				BEGIN

					SELECT 
						@F_Informe = FInforme
					FROM 
						HClinica..InformeQuirurgico
					WHERE 
						CodPaciente = @spvar_CodPaciente AND 
						CodEpisodio = @spvar_CodEpisodio AND 
						FSolicitud=@spvar_Fecha

					DELETE 
						LP
    					FROM 
							HClinica..Problemas LP,
   	 						CapituloQPreopera EQ
    					WHERE 
							CodIntervencion = @spvar_CodIntervencion AND
							EQ.TabCapitulo like @spvar_Tabla AND 
							EQ.EleCapitulo like @spvar_Elemento AND 
							EQ.CodCapitulo like @spvar_Codigo AND 
							LP.CodPaciente = EQ.CodPaciente AND 
							LP.FecIni = EQ.FecCapitulo AND 
							LP.FecEntrada = @F_Informe AND 
							LP.CodProblem = EQ.CodCapitulo AND 
							LP.CodGrupProblem = '6' AND 
							LP.CodVitRelevancia = 'R'

				END
   
			DELETE 
				CapituloQPreopera
   			WHERE 
				CodIntervencion = @spvar_CodIntervencion AND
				TabCapitulo like @spvar_Tabla AND 
				EleCapitulo like @spvar_Elemento AND 
				CodCapitulo like @spvar_Codigo

		END

	/*IF @spvar_Accion = '3'

		BEGIN 

			SELECT 
				@F_Informe = FInforme
   			FROM 
				HClinica..InformeQuirurgico
   			WHERE 
				CodIntervencion = @spvar_CodIntervencion

			INSERT Problemas (
				CodPaciente,
                FecIni,
                FecEntrada,
                CodGrupProblem,
                CodVitRelevancia,
                CodProblem,
                DescProblem,
				ObserProblem,
				CodEspec,
				CodHistoria
			)

			SELECT 
				CodPaciente,
          		Fecha,
          		@F_Informe,
          		"6",
          		"R", 
          		Codigo,
          		DescProced,
				NULL,
				NULL,
				NULL
   			FROM 
				CapituloQPreopera EQ,
        		Parametros..Procedimientos P
   			WHERE 
				CodIntervencion = @spvar_CodIntervencion AND
				TabCapitulo = '1' And 
				EleCapitulo = '3' And 
				CodCapitulo = P.CodDiagnostico AND 
				NOT Exists(
					SELECT *
					FROM Problemas LP
                    WHERE 	LP.CodPaciente = EQ.CodPaciente AND 
							LP.FecIni = EQ.Fecha AND 
							LP.FecEntrada = @F_Informe AND 
							EQ.TabCapitulo = '1' AND 
							EQ.EleCapitulo = '3' AND 
							EQ.CodCapitulo = LP.CodProblem
				)

		END
*/



    GO

GO



--dbo.SpConSQuiDatos.sql

USE [Consultas]
GO

/****** Object:  StoredProcedure [dbo].[SpConSQuiDatos]    Script Date: 11/25/2013 09:42:47 ******/
IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[SpConSQuiDatos]') AND type in (N'P', N'PC'))
DROP PROCEDURE [dbo].[SpConSQuiDatos]
GO

USE [Consultas]
GO

/****** Object:  StoredProcedure [dbo].[SpConSQuiDatos]    Script Date: 11/25/2013 09:42:48 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO




--	PROCEDIMIENTO		: 	SpConSQuiDatos
--	FUNCION                 		: 	Obtiene los datos de un informe quirrgico
--	DEVUELVE                		: 
--	FECHA                  		: 	22/12/2005
--	VERSION                 		: 	1.0
--	AUTOR               : 	Gerardo Prieto David (MECEMSA Consultores)
--  MODIFICACION		:   MPS 31/05/07 possum
--							Jorge Poveda SÃ¡ez 10/12/2007
--							He incluido los campos codExamInterv 1 y 2
--	APLICACIN ORIGEN   	: 	Informe quirurgico
--*******************************************************************
-- MODIFICACIÃ“N: Obtenemos tambiÃ©n la fecha de solicitud y el cÃ³digo del episodio del informe quirÃºrgico
-- FECHA		: 24/07/2008
-- AUTOR		: Oscar Vilella Alarcon
--*******************************************************************
-- MODIFICACIÃ“N: Obtenemos la informaciÃ³n del paciente a mostrar en kiosko
-- FECHA		: 19/08/2008
-- AUTOR		: Oscar Vilella Alarcon
--*******************************************************************
-- MODIFICACIÃ“N: La informaciÃ³n del kiosco la sacamos de la preoperatoria
-- FECHA		: 10/03/2009
-- AUTOR		: Pablo GonzÃ¡lez Moro
--*******************************************************************
-- MODIFICACIÃ“N: El nombre del anestesista se obtiene de la tabla InforeQuirurgico o de Infore Anestesico depeniendo del valor de la constante m_bolAnestesiologia
-- FECHA		: 25/11/2013
-- AUTOR		: CTF - 73569626D - CHC3335_ModificaciÃ³n Campo Analista en InfQuirurgico
--*******************************************************************
-- MODIFICACION:		: 17/05/2017 - v17.2 - 16381 - LMF - Filtrado de secciones y exÃ¡menes por centro
-- MODIFICACION         : 03/08/2017 - v17.3 - 16153 - MPR - Registro Quirurgico - Incorporar registro de Turno
--  MODIFICACIÃ“N        : 23/10/2017 - v17.3r1 - MMM - 16152 - Agregar estado de DiagnÃ³sticos en solicitud de pabellÃ³n	
--*******************************************************************

CREATE Proc [dbo].[SpConSQuiDatos]

	@spvar_CodIntervencion varchar(7)
	--CTF - 73569626D - CHC3335_ModificaciÃ³n Campo Analista en InfQuirurgico
	,@spvar_CodCentro char(5)
	
As


	--	Declaracin de variables.
	Declare @spvar_CodAntib int, @spvar_Antibiotico varchar(60), @spvar_DNICir Char(8)
	Declare @spvar_Cir VarChar(45), @spvar_DNIAnes Char(8), @spvar_Anes Varchar(45)
	Declare @spvar_DNIEnf Char(8), @Enf Varchar(45), @spvar_DNI1 Char(8), @spvar_Ayu1 Varchar(45)
	Declare @spvar_DNI2 Char(8), @spvar_Ayu2 Varchar(45), @spvar_DNI3 Char(8), @spvar_Ayu3 Varchar(45)
	Declare @spvar_CodCenRemite CHAR(5)
	declare @spvar_TasaMorbilidad float   --mps
	declare	@spvar_TasaMortalidad float    --mps
	declare @spvar_InfoPaciente varchar(4000)

	--	Valor inicial de las variables.
	Select @spvar_Antibiotico = ''
	Select @spvar_CodAntib = Null	
	Select @spvar_DNICir = ''
	Select @spvar_DNIAnes = ''
	Select @spvar_DNIEnf = ''
	Select @spvar_DNI1 = ''
	Select @spvar_DNI2 = ''
	Select @spvar_DNI3 = ''
	select @spvar_TasaMorbilidad = null
	select @spvar_TasaMortalidad = null

	--	Obtencin de los datos del antibitico empleado.	
	Select 
		@spvar_CodAntib = IQ.CodAntibioticos,
       	@spvar_Antibiotico = CF.DescEspecialidad + CF.DescPresentacion
	From 
		HClinica..InformeQuirurgico IQ,
       	Farmacias..Especialidad CF,
       	Farmacias..REspecialidad CFR
 	Where 
		IQ.CodIntervencion = @spvar_CodIntervencion And	
		CFR.IDEspecialidad = CodAntibioticos And
       	CF.codEspec = CFR.CodEspec And
       	CF.Tipo = CFR.Tipo

	--	Obtencin del DNI del cirujano, del instrumentista y de los ayudantes.	
	Select 
		@spvar_DNICir = CodCirujano,
		@spvar_DNIEnf = CodInstrumentista,
		@spvar_DNI1 = CodAyudante1,
		@spvar_DNI2 = CodAyudante2,
		@spvar_DNI3 = CodAyudante3
	From 
		HClinica..InformeQuirurgico
	Where 
		CodIntervencion = @spvar_CodIntervencion

	--	Obtencin del nombre del cirujano.
	Select 
		@spvar_Cir = Rtrim(parametros..ParametrosMedicos.NomMedico)+' '+RTrim(parametros..ParametrosMedicos.Apell1)+' '+RTrim(parametros..ParametrosMedicos.Apell2)
	From 
		Parametros..ParametrosMedicos
	Where 
		DNIMedico = @spvar_DNICir

	--	Obtencin del DNI del anestesista.
	Select 
		@spvar_DNIAnes = DNIAnestesista
	From 
		HClinica..InformeAnestesico
	Where 
		CodIntervencion = @spvar_CodIntervencion

	--	Obtencin del nombre del anestesista.
	--CTF - 73569626D - CHC3335_ModificaciÃ³n Campo Analista en InfQuirurgico - INI
	IF (SELECT ValorConstante FROM Parametros..constantes WHERE NombreConstante = 'm_bolAnestesiologia' and CentroRef=@spvar_CodCentro)=1
		BEGIN
	--CTF - 73569626D - CHC3335_ModificaciÃ³n Campo Analista en InfQuirurgico - FIN
			Select 
				@spvar_Anes = Rtrim(parametros..ParametrosMedicos.NomMedico)+' '+RTrim(parametros..ParametrosMedicos.Apell1)+' '+RTrim(parametros..ParametrosMedicos.Apell2)
			From 
				Parametros..ParametrosMedicos
			Where 
				DNIMedico = @spvar_DNIAnes
	--CTF - 73569626D - CHC3335_ModificaciÃ³n Campo Analista en InfQuirurgico - INI
		END	
	ELSE
		BEGIN
				Select 
					@spvar_Anes = RTRIM(NombreAnestesista)
				From 
					HClinica..InformeQuirurgico
				Where 
					CodIntervencion = @spvar_CodIntervencion
		END
	--CTF - 73569626D - CHC3335_ModificaciÃ³n Campo Analista en InfQuirurgico - FIN
	
	--	Obtencin del nombre del instrumentista.
	Select 
		@Enf = Rtrim(parametros..DatosEnfermeras.NombreEnf)+' '+RTrim(parametros..DatosEnfermeras.Apell1Enf)+' '+RTrim(parametros..DatosEnfermeras.Apell2Enf)
	From 
		Parametros..DatosEnfermeras
	Where 
		DNIEnf = @spvar_DNIEnf

	--	Obtencin del nombre del primer ayudante.
	Select 
		@spvar_Ayu1 = Rtrim(parametros..DatosEnfermeras.NombreEnf)+' '+RTrim(parametros..DatosEnfermeras.Apell1Enf)+' '+RTrim(parametros..DatosEnfermeras.Apell2Enf)
	From 
		Parametros..DatosEnfermeras
	Where 
		DNIEnf = @spvar_DNIEnf

	--	Obtencin del nombre del segundo ayudante.
	Select 
		@spvar_Ayu2 = Rtrim(parametros..DatosEnfermeras.NombreEnf)+' '+RTrim(parametros..DatosEnfermeras.Apell1Enf)+' '+RTrim(parametros..DatosEnfermeras.Apell2Enf)
	From 
		Parametros..DatosEnfermeras
	Where 
		DNIEnf = @spvar_DNIEnf

	--	Obtencin del nombre del tercer ayudante.
	Select 
		@spvar_Ayu3 = Rtrim(parametros..DatosEnfermeras.NombreEnf)+' '+RTrim(parametros..DatosEnfermeras.Apell1Enf)+' '+RTrim(parametros..DatosEnfermeras.Apell2Enf)
	From 
		Parametros..DatosEnfermeras
	Where 
		DNIEnf = @spvar_DNIEnf

	--	Obtencin del cdigo del centro remitente.
	SELECT 
		@spvar_CodCenRemite = CodCenRemite
	FROM 
		HClinica..Preoperatoria
	WHERE 
		CodIntervencion = @spvar_CodIntervencion

	 -- Datos del resultado del possum. EstÃ¡n en la preoperatoria
	-- MORBILIDAD
	SELECT 
		@spvar_TasaMorbilidad = TasaMorbilidad
	FROM
		HClinica..Preoperatoria
	WHERE
		CodIntervencion = @spvar_CodIntervencion

	-- MORTALIDAD e InfoPaciente
	SELECT 
		@spvar_TasaMortalidad = TasaMortalidad,
		@spvar_InfoPaciente = InfoPaciente
	FROM
		HClinica..Preoperatoria
	WHERE
		CodIntervencion = @spvar_CodIntervencion

	--	Obtencin del resto de valores.
	Select 
		@spvar_DNICir,
		@spvar_Cir, 
		@spvar_DNIAnes,
		@spvar_Anes, 
		@spvar_DNIEnf, 
		@Enf,
       	@spvar_DNI1, 
		@spvar_Ayu1, 
		@spvar_DNI2, 
		@spvar_Ayu2, 
		@spvar_DNI3, 
		@spvar_Ayu3,
       	a.CodMedInforma,
       	Medico = (
			Select 
				Rtrim(Parametros..ParametrosMedicos.NomMedico)+' '+RTrim(Parametros..ParametrosMedicos.Apell1)+' '+RTrim(Parametros..ParametrosMedicos.Apell2)
            From 
				Parametros..ParametrosMedicos
            Where 
				a.CodMedInforma = DNIMedico
		),
       	a.CodQuirofano,
       	a.PosicionInter,
       	Pos = (
			Select 
				Descripcion
            From 
				Parametros..Codigos
            Where 
				(Tabla = 'EstPosIntervencion' Or Tabla = 'N') And
                    			Codigo = IsNull(a.PosicionInter,'N')
		),
		a.CodVia,
      	Via = (
			Select 
				Descripcion
            From 
				Parametros..Codigos
			Where 
				(Tabla = 'EstDescripcionVia' Or Tabla = 'N') And
				Codigo = IsNull(a.CodVia,'N')
		),
		a.CodProcedimiento, 
		DescProced,
       	a.CodPostCIE,
		DescDiagnostico,
       	@spvar_CodAntib, 
		@spvar_Antibiotico,
       	a.TipoInter,
       	Interv = (
			Select 
				Descripcion
            From 
				Parametros..Codigos
            Where 
				(Tabla = 'EstDesIntervencion' Or Tabla = 'N') And
				Codigo = IsNull(a.TipoInter,'N')
		),
		a.DestinoInter,
		Destino = (
			Select 
				Descripcion
			From 
				Parametros..Codigos
			Where 
				(Tabla = 'EstDestIntervencion' Or Tabla = 'N') And
                        			Codigo = IsNull(a.DestinoInter,'N')
		),
       	a.Solicitudes,
       	a.Drenaje, 
       	a.DescOperatoria,
       	a.TecnicasEmpleadas,
       	a.TecnicaCierre,
       	a.PiezaExtirpada,
       	a.HInicioInter,
		a.HFinInter, 
       	a.FInforme,
       	a.CodMutua,
       	Entidad,
       	a.Facturable,
       	a.CantidadProcesos,
       	@spvar_CodCenRemite,
		a.SolBiopsia,
		a.SolLaboratorio,
		a.SolCitologias,
		a.SolHormonales,
		a.SolRadiologia,
		a.SolPostmortem,
		a.CodInforme,
		a.Firmado,
		a.NumCordales,
		a.CodExamInterven,
		a.CodExamInterven1, --Jorge
		a.CodExamInterven2, --Jorge
		@spvar_TasaMorbilidad as TasaMorbilidad,
		@spvar_TasaMortalidad as TasaMortalidad,
		a.FSolicitud,
		a.CodEpisodio,
		@spvar_InfoPaciente as InfoPaciente
		--(08/09/2015) - v4.53r1 - 2500 - VAS - Plano y extremidad de intervenciones quirÃºrgicas - INI
		, a.IdPlano
		, PL.DescPlano
		, a.IdCuadrante
		, CU.DescCuadrante
		--(08/09/2015) - v4.53r1 - 2500 - VAS - Plano y extremidad de intervenciones quirÃºrgicas - FIN
		, a.IdTurnoInfQuirurgico
		,a.Estado
		
	From 
		/*		/*HClinica..InformeQuirurgico  left join parametros..CIEDiagnostico
		on codpostcie = CodDiagnostico,*/
       	Parametros..Procedimientos P,
       	Parametros..MutuasSalud M left join HClinica..InformeQuirurgico a
		on a.CodMutua = m.codigo,
		parametros..CIEDiagnostico cie*/

			HClinica..InformeQuirurgico a left join Parametros..CIEDiagnostico C on CodPostCIE = c.CodDiagnostico
			right join Parametros..MutuasSalud M on M.Codigo = a.CodMutua--,
			--2500 - VAS prov - INI
			left join Parametros..Planos PL on a.IdPlano = PL.IdPlano
			left join Parametros..Cuadrantes CU on a.IdCuadrante = CU.IdCuadrante
			--2500 - VAS prov - FIN
       		, Parametros..Procedimientos p
 	Where 
		a.CodIntervencion = @spvar_CodIntervencion And
		a.CodProcedimiento = P.CodDiagnostico
		--and a.codpostcie = cie.CodDiagnostico



GO




GO



--dbo.SpConSQuiPrevio.sql

    USE [Consultas];
    GO
    IF EXISTS 
    (
        SELECT * 
            FROM sys.procedures 
            WHERE [object_id] = OBJECT_ID('[dbo].[SpConSQuiPrevio]')
    )
    BEGIN
        DROP PROCEDURE [dbo].[SpConSQuiPrevio];
    END
    GO
    


--	PROCEDIMIENTO		: 	SpConSQuiPrevio
--	FUNCION                 		: 	Obtiene los datos de la hoja preoperatoria
--	DEVUELVE                		: 
--	FECHA                  		: 	20/12/2005
--	VERSION                 		: 	1.0
--	AUTOR                   		: 	Gerardo Prieto David (MECEMSA Consultores)
--  MODIFICACION			: MPS 31/05/07 obtener los campos del possum 
--	APLICACIN ORIGEN   		: 	Informe quirrgico
--  MODIFICACIÓN	: (04/09/2015) - v4.53r1 - SGN - 2500 - Plano y extremidad de intervenciones quirúrgicas
-- MODIFICACION     : (23/10/2017) - v17.3r1 - 16152 - MMM - Agregar estado de Diagnósticos en solicitud de pabellón	

CREATE Proc [dbo].[SpConSQuiPrevio] 
		@spvar_CodIntervencion varchar(7)

As
Select 
		P.DescProced,
       	HP.CodProc,
	    D.DescDiagnostico,
       	HP.CodCIEPreop,
	    HP.FPrevista,
       	EC.CodServicioFinal,
	    HP.CodMutua,
       	Entidad,
	    Obligatorio_Quirofano = 0,
       	--HP.CantProcesos,
	    HP.FIntervencion,
		HP.CodExamInterven,
		HP.TasaMorbilidad,  -- mps
		HP.TasaMortalidad   -- mps
		--(04/09/2015) - v4.53r1 - SGN - 2500 - Plano y extremidad de intervenciones quirúrgicas - INI
		,HP.IdPlano
		,HP.IdCuadrante
		,Pl.DescPlano
		,C.DescCuadrante
		--(04/09/2015) - v4.53r1 - SGN - 2500 - Plano y extremidad de intervenciones quirúrgicas - FIN
		,HP.Estado
		
	From 
		HClinica..Preoperatoria HP
     	LEFT JOIN Parametros..Procedimientos P ON P.CodDiagnostico= HP.CodProc
     	LEFT JOIN Parametros..CIEDiagnostico D ON D.CodDiagnostico= HP.CodCIEPreop
     	LEFT JOIN Parametros..MutuasSalud ON Codigo = HP.CodMutua
     	LEFT JOIN Consultas..EpisodioConsultas EC ON (EC.CodPaciente = HP.CodPaciente AND EC.CodEpisodio = HP.CodEpisodio)
     	--04/09/2015 - v4.53r1 - SGN - 2500 - Plano y extremidad de intervenciones quirúrgicas - INI
		LEFT JOIN Parametros..Planos Pl ON HP.IdPlano = Pl.IdPlano
		LEFT JOIN Parametros..Cuadrantes C ON HP.IdCuadrante = C.IdCuadrante
		--04/09/2015 - v4.53r1 - SGN - 2500 - Plano y extremidad de intervenciones quirúrgicas - FIN

	Where 
		HP.CodIntervencion = @spvar_CodIntervencion 
    	
    GO

GO



--dbo.SpConSQuiruEpisodio.sql

 USE [Consultas];
    GO
    IF EXISTS 
    (
        SELECT * 
            FROM sys.procedures 
            WHERE [object_id] = OBJECT_ID('[dbo].[SpConSQuiruEpisodio]')
    )
    BEGIN
        DROP PROCEDURE [dbo].[SpConSQuiruEpisodio];
    END
    GO
    


--	PROCEDIMIENTO		: 	SpConSQuiruEpisodio
--	FUNCION             : 	Realiza varias acciones según los parámetros de entrada
--	DEVUELVE            : 
--  FECHA				:	24/11/2008
--  AUTOR				:	MPS 
--	COMENTARIO			:	Procede de SpConSQuiEpisodio
							--	FECHA               : 	20/12/2005
							--	VERSION             : 	1.0
							--	AUTOR               : 	Gerardo Prieto David (MECEMSA Consultores)
--	APLICACIN ORIGEN   	: 	Informe quirurgico
--  Modificacion        : Ismael(27/11/2007) Incluida la union en las select para que se vea la informacion
--											 en episodios de consulta e ingresos
--  Modificacion        : Ismael(27/01/2009) Ampliado el tamaño del campo CodHistoria
--  MODIFICACIÓN		: (04/09/2015) - v4.53r1 - SGN - 2500 - Plano y extremidad de intervenciones quirúrgicas
--  MODIFICACIÓN		: (23/10/2017) - v17.3r1 - MMM - 16152 - Agregar estado de Diagnósticos en solicitud de pabellón

CREATE PROC [dbo].[SpConSQuiruEpisodio]

	@spvar_CodPaciente varchar(16),
    @spvar_CodEpisodio varchar(5),
	@spvar_Fecha Smalldatetime,
	@spvar_Tabla varchar(2),
	@spvar_Elemento VARCHAR(2),
	@spvar_Codigo varchar(7),
	@spvar_Accion CHAR(2),
	@spvar_CodHistoria varchar(8),
	@spvar_CodIntervencion varchar(7), 
	@spvar_ModoNuevo bit  
	--(04/09/2015) - v4.53r1 - SGN - 2500 - Plano y extremidad de intervenciones quirúrgicas - INI
	,@spvar_IdPlano tinyint = NULL
	,@spvar_IdCuadrante tinyint = NULL
	--(04/09/2015) - v4.53r1 - SGN - 2500 - Plano y extremidad de intervenciones quirúrgicas - FIN
	,@spvar_Estado int = NULL
	
AS

	--	Accion - Valores
	--
	--	01:	Mostrar - Protesis
	--	02:	Mostrar - Equipos
	--	03:	Mostrar - DiagnosticosCIE
	--	04:	Mostrar - Procedimientos

	--	1:	Insertar
	--	2:	Eliminar
	--	3:	Actualizar la Tabla Alertas

	DECLARE @F_Informe SMALLDATETIME

	--	Mostrar prtesis.
	IF @spvar_Accion = '01'
		
		SELECT 
			EQ.CodCapitulo,
          	CP.Implante + ' (' + CP.Fabricante + ')'
   		FROM 
			Consultas..CapituloQuirurgico EQ,
        	Parametros..CodProtesis CP
   		WHERE 
			CodIntervencion = @spvar_CodIntervencion AND
			TabCapitulo like @spvar_Tabla AND 
			EleCapitulo = '1' AND 
			EQ.CodCapitulo like @spvar_Codigo AND 
			EQ.CodCapitulo = CP.CodImplante

		union

		SELECT 
			EQ.CodCapitulo,
          	CP.Implante + ' (' + CP.Fabricante + ')'
   		FROM 
			Ingresos..CapituloQuirurgico EQ,
        	Parametros..CodProtesis CP
   		WHERE 
			CodIntervencion = @spvar_CodIntervencion AND
			TabCapitulo like @spvar_Tabla AND 
			EleCapitulo = '1' AND 
			EQ.CodCapitulo like @spvar_Codigo AND 
			EQ.CodCapitulo = CP.CodImplante

	--	Mostrar equipos.
	IF @spvar_Accion = '02'
   		
		SELECT 
			EQ.CodCapitulo,
          	CE.DescEquipo
   		FROM 
			Consultas..CapituloQuirurgico EQ,
        	Parametros..DatosEquipos CE
   		WHERE 
			CodIntervencion = @spvar_CodIntervencion AND
			TabCapitulo like @spvar_Tabla AND 
			EleCapitulo = '0' AND 
			EQ.CodCapitulo like @spvar_Codigo AND 
			EQ.CodCapitulo = CE.CodigoEquipo

		union

		SELECT 
			EQ.CodCapitulo,
          	CE.DescEquipo
   		FROM 
			Ingresos..CapituloQuirurgico EQ,
        	Parametros..DatosEquipos CE
   		WHERE 
			CodIntervencion = @spvar_CodIntervencion AND
			TabCapitulo like @spvar_Tabla AND 
			EleCapitulo = '0' AND 
			EQ.CodCapitulo like @spvar_Codigo AND 
			EQ.CodCapitulo = CE.CodigoEquipo

	--	Diagnsticos CIE.
	IF @spvar_Accion = '03'
	begin
		-- mps compruebo si existen registros con Procedencia = 1 
		if exists (SELECT * 
					FROM 
						Consultas..CapituloQuirurgico EQ,
						Parametros..CIEDiagnostico D 
					WHERE 
						CodIntervencion = @spvar_CodIntervencion AND
						TabCapitulo like @spvar_Tabla AND 
						EleCapitulo = '2' AND 
						EQ.CodCapitulo like @spvar_Codigo AND 
						EQ.CodCapitulo = D.CodDiagnostico  ) or 
					exists (SELECT *
					FROM 
						Ingresos..CapituloQuirurgico EQ,
						Parametros..CIEDiagnostico D 
					WHERE 
						CodIntervencion = @spvar_CodIntervencion AND
						TabCapitulo like @spvar_Tabla AND 
						EleCapitulo = '2' AND 
						EQ.CodCapitulo like @spvar_Codigo AND 
						EQ.CodCapitulo = D.CodDiagnostico )
		begin
				SELECT 
					EQ.CodCapitulo,
          			D.DescDiagnostico, EQ.Estado
   				FROM 
					Consultas..CapituloQuirurgico EQ,
        			Parametros..CIEDiagnostico D 
				WHERE 
					CodIntervencion = @spvar_CodIntervencion AND
					TabCapitulo like @spvar_Tabla AND 
					EleCapitulo = '2' AND 
					EQ.CodCapitulo like @spvar_Codigo AND 
					EQ.CodCapitulo = D.CodDiagnostico  

				union

				SELECT 
					EQ.CodCapitulo,
          			D.DescDiagnostico, EQ.Estado
   				FROM 
					Ingresos..CapituloQuirurgico EQ,
        			Parametros..CIEDiagnostico D 
				WHERE 
					CodIntervencion = @spvar_CodIntervencion AND
					TabCapitulo like @spvar_Tabla AND 
					EleCapitulo = '2' AND 
					EQ.CodCapitulo like @spvar_Codigo AND 
					EQ.CodCapitulo = D.CodDiagnostico  
		end 
        -- sólo en el caso de modo nuevo sacaremos lo que escribió la preoperatoria
		else if @spvar_ModoNuevo = 1 
		begin
				SELECT 
					EQ.CodCapitulo,
          			D.DescDiagnostico, EQ.Estado
   				FROM 
					Consultas..CapituloQPreopera EQ,
        			Parametros..CIEDiagnostico D 
				WHERE 
					CodIntervencion = @spvar_CodIntervencion AND
					TabCapitulo like @spvar_Tabla AND 
					EleCapitulo = '2' AND 
					EQ.CodCapitulo like @spvar_Codigo AND 
					EQ.CodCapitulo = D.CodDiagnostico  

				union

				SELECT 
					EQ.CodCapitulo,
          			D.DescDiagnostico, EQ.Estado
   				FROM 
					Ingresos..CapituloQPreopera EQ,
        			Parametros..CIEDiagnostico D 
				WHERE 
					CodIntervencion = @spvar_CodIntervencion AND
					TabCapitulo like @spvar_Tabla AND 
					EleCapitulo = '2' AND 
					EQ.CodCapitulo like @spvar_Codigo AND 
					EQ.CodCapitulo = D.CodDiagnostico  
		end 
   		
	end 
	--	Mostrar procedimientos.
	IF @spvar_Accion = '04'
	begin
	-- mps compruebo si existen registros con Procedencia = 1 
		if exists(SELECT *
					FROM 
						Consultas..CapituloQuirurgico EQ,
						Parametros..Procedimientos P
					WHERE 
						CodIntervencion = @spvar_CodIntervencion AND
						TabCapitulo like @spvar_Tabla AND 
						EleCapitulo = '3' AND 
						EQ.CodCapitulo like @spvar_Codigo AND 
						EQ.CodCapitulo = P.CodDiagnostico  ) or 
					exists(SELECT 
						EQ.CodCapitulo,
						P.DescProced
					FROM 
						Ingresos..CapituloQuirurgico EQ,
						Parametros..Procedimientos P
					WHERE 
						CodIntervencion = @spvar_CodIntervencion AND
						TabCapitulo like @spvar_Tabla AND 
						EleCapitulo = '3' AND 
						EQ.CodCapitulo like @spvar_Codigo AND 
						EQ.CodCapitulo = P.CodDiagnostico )
		begin
			SELECT 
				EQ.CodCapitulo,
          		P.DescProced
          	--(04/09/2015) - v4.53r1 - SGN - 2500 - Plano y extremidad de intervenciones quirúrgicas - INI
          	,EQ.IdPlano
          	,EQ.IdCuadrante
          	,Pl.DescPlano
          	,C.DescCuadrante
          	--(04/09/2015) - v4.53r1 - SGN - 2500 - Plano y extremidad de intervenciones quirúrgicas - FIN
   			FROM 
				Consultas..CapituloQuirurgico EQ
        		LEFT JOIN Parametros..Procedimientos P ON EQ.CodCapitulo = P.CodDiagnostico
        		--04/09/2015 - v4.53r1 - SGN - 2500 - Plano y extremidad de intervenciones quirúrgicas - INI
				LEFT JOIN Parametros..Planos Pl ON EQ.IdPlano = Pl.IdPlano
				LEFT JOIN Parametros..Cuadrantes C ON EQ.IdCuadrante = C.IdCuadrante
				--04/09/2015 - v4.53r1 - SGN - 2500 - Plano y extremidad de intervenciones quirúrgicas - FIN
   			WHERE 
				CodIntervencion = @spvar_CodIntervencion AND
				TabCapitulo like @spvar_Tabla AND 
				EleCapitulo = '3' AND 
				EQ.CodCapitulo like @spvar_Codigo 				

			union

			SELECT 
				EQ.CodCapitulo,
          		P.DescProced
          		--(04/09/2015) - v4.53r1 - SGN - 2500 - Plano y extremidad de intervenciones quirúrgicas - INI
          		,EQ.IdPlano
          		,EQ.IdCuadrante
          		,Pl.DescPlano
          		,C.DescCuadrante
          		--(04/09/2015) - v4.53r1 - SGN - 2500 - Plano y extremidad de intervenciones quirúrgicas - FIN
   			FROM 
				Ingresos..CapituloQuirurgico EQ
        		LEFT JOIN Parametros..Procedimientos P ON EQ.CodCapitulo = P.CodDiagnostico
        		--04/09/2015 - v4.53r1 - SGN - 2500 - Plano y extremidad de intervenciones quirúrgicas - INI
				LEFT JOIN Parametros..Planos Pl ON EQ.IdPlano = Pl.IdPlano
				LEFT JOIN Parametros..Cuadrantes C ON EQ.IdCuadrante = C.IdCuadrante
				--04/09/2015 - v4.53r1 - SGN - 2500 - Plano y extremidad de intervenciones quirúrgicas - FIN
   			WHERE 
				CodIntervencion = @spvar_CodIntervencion AND
				TabCapitulo like @spvar_Tabla AND 
				EleCapitulo = '3' AND 
				EQ.CodCapitulo like @spvar_Codigo 
			end
			-- sólo en el caso de modo nuevo sacaremos lo que escribió la preoperatoria
			else if @spvar_ModoNuevo = 1 
			begin
				SELECT 
					EQ.CodCapitulo,
          			P.DescProced
          			--(04/09/2015) - v4.53r1 - SGN - 2500 - Plano y extremidad de intervenciones quirúrgicas - INI
          			,EQ.IdPlano
          			,EQ.IdCuadrante
          			,PL.DescPlano
          			,C.DescCuadrante
          			--(04/09/2015) - v4.53r1 - SGN - 2500 - Plano y extremidad de intervenciones quirúrgicas - FIN
   				FROM 
					Consultas..CapituloQPreopera EQ
        			LEFT JOIN Parametros..Procedimientos P ON EQ.CodCapitulo = P.CodDiagnostico
        			--04/09/2015 - v4.53r1 - SGN - 2500 - Plano y extremidad de intervenciones quirúrgicas - INI
					LEFT JOIN Parametros..Planos Pl ON EQ.IdPlano = Pl.IdPlano
					LEFT JOIN Parametros..Cuadrantes C ON EQ.IdCuadrante = C.IdCuadrante
					--04/09/2015 - v4.53r1 - SGN - 2500 - Plano y extremidad de intervenciones quirúrgicas - FIN
   				WHERE 
					CodIntervencion = @spvar_CodIntervencion AND
					TabCapitulo like @spvar_Tabla AND 
					EleCapitulo = '3' AND 
					EQ.CodCapitulo like @spvar_Codigo 

				union

				SELECT 
					EQ.CodCapitulo,
          			P.DescProced
          			--(04/09/2015) - v4.53r1 - SGN - 2500 - Plano y extremidad de intervenciones quirúrgicas - INI
          			,EQ.IdPlano
          			,EQ.IdCuadrante
          			,PL.DescPlano
          			,C.DescCuadrante
          			--(04/09/2015) - v4.53r1 - SGN - 2500 - Plano y extremidad de intervenciones quirúrgicas - FIN
   				FROM 
					Ingresos..CapituloQPreopera EQ
        			LEFT JOIN Parametros..Procedimientos P ON EQ.CodCapitulo = P.CodDiagnostico
        			--04/09/2015 - v4.53r1 - SGN - 2500 - Plano y extremidad de intervenciones quirúrgicas - INI
					LEFT JOIN Parametros..Planos Pl ON EQ.IdPlano = Pl.IdPlano
					LEFT JOIN Parametros..Cuadrantes C ON EQ.IdCuadrante = C.IdCuadrante
					--04/09/2015 - v4.53r1 - SGN - 2500 - Plano y extremidad de intervenciones quirúrgicas - FIN
   				WHERE 
					CodIntervencion = @spvar_CodIntervencion AND
					TabCapitulo like @spvar_Tabla AND 
					EleCapitulo = '3' AND 
					EQ.CodCapitulo like @spvar_Codigo 
				end 
		
	end 
	--	Insertar.
	IF @spvar_Accion = '1'

		INSERT CapituloQuirurgico 
   		VALUES ( 
			@spvar_CodPaciente,
			@spvar_CodEpisodio,
			@spvar_Fecha,
			@spvar_Tabla,
			@spvar_Elemento,
			@spvar_Codigo, 
			@spvar_CodHistoria,
			@spvar_CodIntervencion
			--(04/09/2015) - v4.53r1 - SGN - 2500 - Plano y extremidad de intervenciones quirúrgicas - INI
			,@spvar_IdPlano
			,@spvar_IdCuadrante
          	--(04/09/2015) - v4.53r1 - SGN - 2500 - Plano y extremidad de intervenciones quirúrgicas - FIN
			,@spvar_Estado
			
		)

	--	Eliminar.
	IF @spvar_Accion = '2'

		BEGIN

			--	Borrar de Lista de Problemas si son Intervenciones desde InformeQuirurgico.
  			IF '1' Like @spvar_Tabla AND '3' Like @spvar_Elemento 
		
				BEGIN

					SELECT 
						@F_Informe = FInforme
					FROM 
						HClinica..InformeQuirurgico
					WHERE 
						CodPaciente = @spvar_CodPaciente AND 
						CodEpisodio = @spvar_CodEpisodio AND 
						FSolicitud=@spvar_Fecha

					DELETE 
						LP
    					FROM 
							HClinica..Problemas LP,
   	 						CapituloQuirurgico EQ
    					WHERE 
							CodIntervencion = @spvar_CodIntervencion AND
							EQ.TabCapitulo like @spvar_Tabla AND 
							EQ.EleCapitulo like @spvar_Elemento AND 
							EQ.CodCapitulo like @spvar_Codigo AND 
							LP.CodPaciente = EQ.CodPaciente AND 
							LP.FecIni = EQ.FecCapitulo AND 
							LP.FecEntrada = @F_Informe AND 
							LP.CodProblem = EQ.CodCapitulo AND 
							LP.CodGrupProblem = '6' AND 
							LP.CodVitRelevancia = 'R'

				END
   
			DELETE 
				CapituloQuirurgico
   			WHERE 
				CodIntervencion = @spvar_CodIntervencion AND
				TabCapitulo like @spvar_Tabla AND 
				EleCapitulo like @spvar_Elemento AND 
				CodCapitulo like @spvar_Codigo 
		END

	/*IF @spvar_Accion = '3'

		BEGIN 

			SELECT 
				@F_Informe = FInforme
   			FROM 
				HClinica..InformeQuirurgico
   			WHERE 
				CodIntervencion = @spvar_CodIntervencion

			INSERT Problemas (
				CodPaciente,
                FecIni,
                FecEntrada,
                CodGrupProblem,
                CodVitRelevancia,
                CodProblem,
                DescProblem,
				ObserProblem,
				CodEspec,
				CodHistoria
			)

			SELECT 
				CodPaciente,
          		Fecha,
          		@F_Informe,
          		"6",
          		"R", 
          		Codigo,
          		DescProced,
				NULL,
				NULL,
				NULL
   			FROM 
				CapituloQuirurgico EQ,
        		Parametros..Procedimientos P
   			WHERE 
				CodIntervencion = @spvar_CodIntervencion AND
				TabCapitulo = '1' And 
				EleCapitulo = '3' And 
				CodCapitulo = P.CodDiagnostico AND 
				NOT Exists(
					SELECT *
					FROM Problemas LP
                    WHERE 	LP.CodPaciente = EQ.CodPaciente AND 
							LP.FecIni = EQ.Fecha AND 
							LP.FecEntrada = @F_Informe AND 
							EQ.TabCapitulo = '1' AND 
							EQ.EleCapitulo = '3' AND 
							EQ.CodCapitulo = LP.CodProblem
				)

		END
*/



    GO

GO



--dbo.SpHCLDDetalleParto.sql

USE [Hclinica]
GO

IF EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[SpHCLDDetalleParto]') AND type in (N'P', N'PC'))
	DROP PROCEDURE [dbo].[SpHCLDDetalleParto]
GO

/****************************************************
PROCEDIMIENTO	: SpHCLDDetalleParto
FUNCION			: Elimina registros de DetalleParto
FECHA			: 24/08/2017
VERSION			: V17.3r1 - 16147 - Mejoras Urgencia Maternidad y Partograma
AUTOR			: Fran Cuenca/Alberto Pagán Benedicto
****************************************************/

CREATE PROCEDURE [dbo].[SpHCLDDetalleParto]
     @spvar_CodPaciente char(16)
	,@spvar_CodEpisodio char(5)
	,@spvar_Codigo char(1)
AS 

BEGIN 
	DELETE Hclinica..DetalleParto
	WHERE CodPaciente = @spvar_CodPaciente AND
	      CodEpisodio = @spvar_CodEpisodio AND
		  Codigo = @spvar_Codigo
END

GO



--dbo.SpHClDEliminaEstGin.sql

USE [Hclinica]
GO

IF EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[SpHClDEliminaEstGin]') AND type in (N'P', N'PC'))
	DROP PROCEDURE [dbo].[SpHClDEliminaEstGin]
GO   

--	PROCEDIMIENTO	  : SpHClDEliminaEstGin
--	FUNCION           : Elimina los datos del informe Ginecológico/Gineco-Obstétrico
--	DEVUELVE          :
--	FECHA             : 01/03/2006
--	VERSION           : 1.0
--	AUTOR             : Patricia Clemente
--	APLICACIÓN ORIGEN : HClinicaBasica.FEstGin - Formulario de Estudio Ginecológico/Gineco-Obstétrico

CREATE PROCEDURE [dbo].[SpHClDEliminaEstGin]
	 @CodPaciente char(16)
	,@NumConsulta tinyint
AS

DELETE Hclinica..InformeGinecologico
WHERE CodPaciente = @CodPaciente AND NumConsulta = @NumConsulta

GO
GO



--dbo.SpHCLIDetalleParto.sql

USE [Hclinica]
GO

IF EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[SpHCLIDetalleParto]') AND type in (N'P', N'PC'))
	DROP PROCEDURE [dbo].[SpHCLIDetalleParto]
GO
    
/************************************************************************
PROCEDIMIENTO : SpHCLIDetalleParto
FUNCION       :
DEVUELVE      :
FECHA         : 20/11/2006
VERSION       : 1.0
AUTOR         : Teresa L Fabuel Serrano
************************************************************************
MODIFICACIÓN  : (10/10/2017) - V17.3r1 - 16147 - APB - Mejoras Urgencia Maternidad y Partograma
************************************************************************/

CREATE PROCEDURE [dbo].[SpHCLIDetalleParto]
	 @spvar_CodPaciente char(16)
 	,@spvar_CodEpisodio char(5)
	,@spvar_Fecha smalldatetime
	,@spvar_Codigo char(1)
	,@spvar_Tipo char(1)
	,@spvar_FechaInsert smalldatetime
AS

IF NOT EXISTS(SELECT CodPaciente
			  FROM Hclinica..DetalleParto 
			  WHERE CodPaciente = @spvar_CodPaciente and
					CodEpisodio = @spvar_CodEpisodio and
					Fecha = @spvar_Fecha and
					Codigo = @spvar_Codigo and
					Tipo = @spvar_Tipo)
BEGIN
	INSERT Hclinica..DetalleParto
		   (CodPaciente
		   ,CodEpisodio
		   ,Fecha
		   ,Codigo
		   ,Tipo
		   ,FechaInsert)
	VALUES (@spvar_CodPaciente
		   ,@spvar_CodEpisodio
		   ,@spvar_Fecha
		   ,@spvar_Codigo
		   ,@spvar_Tipo
		   ,@spvar_FechaInsert)
END

GO
GO



--dbo.SpHClIPreoperatoria.sql

     USE [HClinica];
    GO
    IF EXISTS 
    (
        SELECT * 
            FROM sys.procedures 
            WHERE [object_id] = OBJECT_ID('[dbo].[SpHClIPreoperatoria]')
    )
    BEGIN
        DROP PROCEDURE [dbo].[SpHClIPreoperatoria];
    END
    GO
    


/*

	PROCEDIMIENTO		: HClinica..SpHClIPreoperatoria
	FUNCION				: Realiza la inserción de hojas preoperatorias
	DEVUELVE			: Codigo de intervencion generado
	FECHA				: 09/02/2009
	VERSION				: 1.0
	AUTOR				: Sonia Mateo
	APLICACION			: Hojas preoperatorias
	MODIFICACIÓN		: 06/03/09 MPS - ampliar tipo campo @spvar_TipoAnestesia a char(2)
	MODIFICACION		: 09/03/2009 Ismael Sampere - nuevo campo DniCirujanoPrevisto
	MODIFICACION		: 08/04/2009 Ismael Sampere - nuevo campo Neoplasia
	MODIFICACION		: 19/06/2009 Joaquín Aniorte - Nuevo campo ComplejidadPreop
	MODIFICACION		: 30/07/2009 Paco Aznar - Nuevo campo CentroDestino
	MODIFICACION		: 26/08/2009 Paco Aznar - Nuevo campo TipoCenRemite
	MODIFICACION		: 02/09/2009 Joaquín Aniorte - Nuevo campo IntervencionEspecial
	MODIFICACION		: 03/09/2009 Joaquín Aniorte - Nuevo campo UHD
	MODIFICACION		: 06/11/2009 Luis Merle - Nuevo campo TieneEquipo
	MODIFICACION		: 24/11/2009 Paco Aznar - Nuevo campo servicioDestino
	MODIFICACION		: 31/12/2009 Pablo González - Error al generar el codigo de preoperatoria con el cambio de año
	MODIFICACION		: 02/02/2010 Joaquín Aniorte - Se intercambian el servicio y el servicio destino que pasa a llamarse ServicioOrigen (FLORENCECLI-1139) 
	MODIFICACION		: 03/02/2010 Joaquín Aniorte - Nuevos campos Ayudantes, Preparatoria y AlergiaLatex
	MODIFICACION		: 22/02/2010 Joaquín Aniorte - Nuevos campo TieneProtesis
	MODIFICACION		: 25/02/2010 Joaquín Aniorte - Campo cambiado (Preparatoria -> RequiereIngreso) y Nuevo Campo Infeccioso
	MODIFICACION		: 08/03/2010 Joaquín Aniorte - Ampliación de campo DescPreop a varchar 1000
						: 04/08/2010 Teresa L Fabuel - Nuevo campo Cirugia Ambulatoria Urgente 'CiruAUrgente'
						: 17/09/2010 Teresa L F S - Nuevo campo AvisoPlanificar. Nuevo campo Fecha prevista de la Intervención FPrevistaIntervencion.
--						: 27/08/2012 Fran Cuenca  - Boton_firma_consentimiento_Hoja_Preop	
						: 26/02/2013 Fran Cuenca - MAIPU CHC2671 -v 4.38 - Integracion SAP-SD		
-- MODIFICACION			: 10/07/2013 25412344N		- CHC2947 - REQ27104 - v4.40 - CREACIÓN DE COMBOBOX PREFERENTE MODULO QUIROFANO 	
-- MODIFICACION			: (04/09/2015) - v4.53r1 - SGN - 2500 - Plano y extremidad de intervenciones quirúrgicas		
-- MODIFICACION			: (14/10/2015) - v4.55 - CCM - 2525 - Solicitud de Pabellón incorporar Registro Re-intervención	
-- MODIFICACION:		: 15/05/2017 - v17.2 - 16142 - FCB - Solicitud de Pabellón - Registro de especialidad	
-- MODIFICACION:		: 17/05/2017 - v17.2 - 16381 - LMF - Filtrado de secciones y exámenes por centro
-- MODIFICACION:		: 23/10/2017 - v17.3r1 - 16152 - MMM - Agregar estado de Diagnósticos en solicitud de pabellón								
*/

CREATE   PROCEDURE [dbo].[SpHClIPreoperatoria]
	@spvar_CodPaciente char(16),
	@spvar_CodEpisodio char(5),
	@spvar_CodProc char(6),
	@spvar_TipoAnestesia char(2),
	@spvar_CodCIEPreop char(6),
	@spvar_CodProtocolo char(6),
	@spvar_DescProtocolo varchar(50),
	@spvar_RQuirurgico char(1),	
	@spvar_Region char(2),	
	@spvar_FPreoperatoria smalldatetime,
	@spvar_DNIMedicoPreop char(8),
	@spvar_DescPreop varchar(1000),
	@spvar_TecPrevistas varchar(100),
	@spvar_Ambulatoria bit,
	@spvar_Tipo char(1),
	@spvar_PreopCompleto bit,
	@spvar_JClinico varchar(2000),
	@spvar_VistoBueno bit,	
	@spvar_Autotransfusion bit,
	@spvar_GSangre char(1),
	@spvar_RH char(1),
	@spvar_MedicoRemite varchar(47),	
	@spvar_CodMutua char(5),
	@spvar_Anestesista varchar(30),
	@spvar_FConsentInterv Smalldatetime, 
	@spvar_FConsentProtesis Smalldatetime,
	@spvar_CodCenRemite CHAR(5),
	@spvar_Preanestesia char(1), 	
	@spvar_NecesHemoderiv char(1)='N', 
	@spvar_UsuHemoderiv varchar(30)=Null, 
	@spvar_CodHistoria varchar(8) = Null,
	@spvar_Servicio char(4)=null,
	@spvar_CiruMenor bit,
	@spvar_Duracion int,
	@spvar_CodProtocolo2 char(6) = null,
	@spvar_DescProtocolo2 varchar(50) = null,
	@spvar_CodProtocolo3 char(6) = null,
	@spvar_DescProtocolo3 varchar(50) = null,	
	@spvar_CMA bit	= null,
    --- RRG - 25412344N - CHC2947 - REQ27104 - v4.40 - CREACIÓN DE COMBOBOX PREFERENTE MODULO QUIROFANO - INI
    --- Código Antiguo:
	--- @spvar_MotivoPreferente varchar(100) = null,
    --- Código Nuevo:
	@spvar_intCodMotivoPreferente int = null,
    --- RRG - 25412344N - CHC2947 - REQ27104 - v4.40 - CREACIÓN DE COMBOBOX PREFERENTE MODULO QUIROFANO - FIN
	@spvar_Lateralidad int = null,
	@spvar_CodExamIntervencionismo char(7) = null ,
	@spvar_TasaMorbilidad float = null, 
	@spvar_TasaMortalidad float = null, 
	@spvar_CMAsinHDIA bit = NULL,
	@spvar_Complejidad char(2) = NULL,
	@spvar_RequiereUvi bit = 0,
	@spvar_Neoplasia bit = 0,
	@spvar_ComplejidadPreop int = NULL,
	@spvar_centroDestino char(5) = NULL,
	@spvar_TipoCenRemite int = NULL,
	@spvar_IntervencionEspecial bit = 0,
	@spvar_UHD bit = 0,
	@spvar_TieneEquipo bit = 0,
	@spvar_servDestino char(4) = NULL,
	@spvar_Ayudantes int = 0,
	@spvar_RequiereIngreso bit = 0,
	@spvar_AlergiaLatex bit = 0,
	@spvar_TieneProtesis bit = 0,
	@spvar_Infeccioso bit = 0,
	@spvar_CiruAUrgente bit = 0,
	@spvar_AvisosPlanif varchar(max) = null,
	@spvar_FPrevIntervencion datetime = null,
	--MAIPU  CHC 1945  V4.32   FCB, Botón firma consentimiento Hoja Preop. v1
	@spvar_PacFirmaConsen bit = 0
	--MAIPU  CHC 1945  V4.32   FCB, fin
	--MAIPU CHC2671  v4.38 FCB, Integracion SAP-SD
	,@spvar_Pagado bit=0
	--MAIPU CHC2671  v4.38 FCB, Fin
	--(04/09/2015) - v4.53r1 - SGN - 2500 - Plano y extremidad de intervenciones quirúrgicas - INI
	,@spvar_IdPlano tinyint =NULL
	,@spvar_IdCuadrante tinyint =NULL
	--(04/09/2015) - v4.53r1 - SGN - 2500 - Plano y extremidad de intervenciones quirúrgicas - FIN
	,@spvar_EsReintervencion bit = 0
	,@spvar_DescReintervencion varchar(250) = null
	,@spvar_CodEspecialidadUrg varchar(4) = null
	,@spvar_Estado int = NULL
	

AS

DECLARE @EstadoRCLEInicial as char(3),
		@CodIntervencion as char(7)


-- Obtiene el codigo del servicio del medico indicado en la preoperatoria
IF @spvar_Servicio is null
BEGIN
	SELECT @spvar_Servicio = (SELECT CodServicioMedico
							  FROM   Parametros..ParametrosMedicos
							  WHERE  DNIMedico = @spvar_DNIMedicoPreop)
END


-- Calcula el estado inicial para RCLE
select @EstadoRCLEInicial = Parametros.dbo.fnParValorConstante('m_strEstadoInicialRCLE')

-- Calcula el codigo de intervencion para la preoperatoria
select	@CodIntervencion  = substring(convert(varchar(4),year(getdate())),3,2) + parametros.dbo.rellenaiz(5,'0',MAX(substring(CodIntervencion,3,5)) + 1) 
from	hclinica..preoperatoria 
where	substring(CodIntervencion,1,2) = substring(convert(varchar(4),year(getdate())),3,2)

-- Si no tenemos ningun codigo de intervencion para el año lo inicializamos
select @CodIntervencion = ISNULL(@CodIntervencion, substring(convert(varchar(4),year(getdate())),3,2) + '00000')

		
-- Devuelve el codigo de intervencion calculado 
select @CodIntervencion as CodIntervencion

-- Inserta los datos en la tabla de la preoperatoria
	INSERT Preoperatoria(
					 CodHojaPreop,
					 CodIntervencion,
					 CodPaciente,
					 CodEpisodio,
					 CodProc,
					 TipoAnestesia,
					 CodCIEPreop,
					 RQuirurgico,
					 Region,
					 FPreoperatoria,
					 DNIMedicoPreop,
					 DescPreop,
					 TecPrevistas,
					 Ambulatoria,
					 Tipo,
					 PreopCompleto,
					 JClinico,
					 Autotransfusion,
					 VistoBueno,
					 MedicoRemite,
					 CodMutua,
					 Anestesista,
					 FConsentInterv,
					 FConsentProtesis,
					 CodCenRemite,
					 Preanestesia,
					 NecesHemoderiv,
					 UsuHemoderiv,
					 CodHistoria, 
					 Servicio,
					 CodProtocolo,
					 DescProtocolo,
					 CiruMenor,
					 TiempoOper,
					 CodProtocolo2,
					 DescProtocolo2,
					 CodProtocolo3,
					 DescProtocolo3,
					 cma,
					 --- RRG - 25412344N - CHC2947 - REQ27104 - v4.40 - CREACIÓN DE COMBOBOX PREFERENTE MODULO QUIROFANO - INI
					 --- Código Antiguo:
					 --- MotivoPreferente,
					 --- Código nuevo:
					 CodMotivoPreferente,
					 --- RRG - 25412344N - CHC2947 - REQ27104 - v4.40 - CREACIÓN DE COMBOBOX PREFERENTE MODULO QUIROFANO - FIN
					 Lateralidad, 
					 CodExamInterven,
					 TasaMorbilidad,
					 TasaMortalidad,
					 CMAsinHDIA,
					 Complejidad, 
					 RequiereUvi,
					 EstadoRCLE,
					 DniCirujanoPrevisto,
					 Neoplasia,
					 ComplejidadPreop,
					 centroDestino,
					 TipoCenRemite,
					 IntervencionEspecial,
					 UHD,
					 TieneEquipo,
					 ServicioOrigen,
					 Ayudantes,
					 RequiereIngreso,
					 AlergiaLatex,
					 TieneProtesis,
					 Infeccioso,
					 CiruAUrgente,
					 AvisoPlanificar,
					 FPrevistaIntervencion,
					--MAIPU  CHC 1945  V4.32   FCB, Botón firma consentimiento Hoja Preop. v1
					PacFirmaConsen
					--MAIPU  CHC 1945  V4.32   FCB, fin
					--MAIPU CHC2671  v4.38 FCB, Integracion SAP-SD
					,Pagado
					--MAIPU CHC2671  v4.38 FCB, Fin
					--(04/09/2015) - v4.53r1 - SGN - 2500 - Plano y extremidad de intervenciones quirúrgicas - INI
					, IdPlano
					, IdCuadrante
					--(04/09/2015) - v4.53r1 - SGN - 2500 - Plano y extremidad de intervenciones quirúrgicas - FIN
					,EsReintervencion
					,DescReintervencion
					, CodEspecialidadUrg
					,Estado
									

					 )

		VALUES( @CodIntervencion,
				@CodIntervencion,
				@spvar_CodPaciente,
				@spvar_CodEpisodio,
				@spvar_CodProc,
				@spvar_TipoAnestesia,
				@spvar_CodCIEPreop,
				@spvar_RQuirurgico,		
				@spvar_Region,	
				@spvar_FPreoperatoria,
				@spvar_DNIMedicoPreop,
				@spvar_DescPreop,
				@spvar_TecPrevistas,
				@spvar_Ambulatoria,
				@spvar_Tipo,
				@spvar_PreopCompleto,
				@spvar_JClinico,
				@spvar_Autotransfusion,
				--@spvar_VistoBueno,
				0,
				@spvar_MedicoRemite,
				@spvar_CodMutua,
				@spvar_Anestesista,
				@spvar_FConsentInterv,
				@spvar_FConsentProtesis,
				@spvar_CodCenRemite,
				@spvar_Preanestesia,
				@spvar_NecesHemoderiv,
				@spvar_UsuHemoderiv,
				@spvar_CodHistoria, 
				@spvar_servDestino, --@spvar_Servicio,
				@spvar_CodProtocolo,
				@spvar_DescProtocolo,
				@spvar_CiruMenor,
				@spvar_Duracion,
				@spvar_CodProtocolo2,
				@spvar_DescProtocolo2,
				@spvar_CodProtocolo3,
				@spvar_DescProtocolo3,	
				@spvar_CMA, 	
				--- RRG - 25412344N - CHC2947 - REQ27104 - v4.40 - CREACIÓN DE COMBOBOX PREFERENTE MODULO QUIROFANO - INI
				--- Código Antiguo:
				--- @spvar_MotivoPreferente,
				--- Código nuevo:
				@spvar_intCodMotivoPreferente,
				--- RRG - 25412344N - CHC2947 - REQ27104 - v4.40 - CREACIÓN DE COMBOBOX PREFERENTE MODULO QUIROFANO - FIN				
				@spvar_Lateralidad,
				@spvar_CodExamIntervencionismo,
				@spvar_TasaMorbilidad,
				@spvar_TasaMortalidad,
				@spvar_CMAsinHDIA,
				@spvar_Complejidad, 
				@spvar_RequiereUvi,
				@EstadoRCLEInicial,
				@spvar_DNIMedicoPreop,
				@spvar_Neoplasia,
				@spvar_ComplejidadPreop,
				@spvar_centroDestino,
				@spvar_TipoCenRemite,
				@spvar_IntervencionEspecial,
				@spvar_UHD,
				@spvar_TieneEquipo,
				@spvar_Servicio, --@spvar_servDestino
				@spvar_Ayudantes,
				@spvar_RequiereIngreso,
				@spvar_AlergiaLatex,
				@spvar_TieneProtesis,
				@spvar_Infeccioso,
				@spvar_CiruAUrgente,
				@spvar_AvisosPlanif,
				@spvar_FPrevIntervencion,
				--MAIPU  CHC 1945  V4.32   FCB, Botón firma consentimiento Hoja Preop. v1
				@spvar_PacFirmaConsen
				--MAIPU  CHC 1945  V4.32   FCB, fin
				--MAIPU CHC2671  v4.38 FCB, Integracion SAP-SD
				,@spvar_Pagado
				--MAIPU CHC2671  v4.38 FCB, Fin
				--(04/09/2015) - v4.53r1 - SGN - 2500 - Plano y extremidad de intervenciones quirúrgicas - INI
				, @spvar_IdPlano
				, @spvar_IdCuadrante
				--(04/09/2015) - v4.53r1 - SGN - 2500 - Plano y extremidad de intervenciones quirúrgicas - FIN
				, @spvar_EsReintervencion
				, @spvar_DescReintervencion
				, @spvar_CodEspecialidadUrg
				,@spvar_Estado
			
				)



IF EXISTS(	SELECT	* 
			FROM	HClinica..LTiemposEspera
			WHERE	CodPaciente=@spvar_CodPaciente AND 
					CodEpisodio=@spvar_CodEpisodio AND 
					FechaPasivo Is Not Null AND 
					CodIntervencion = @CodIntervencion)
BEGIN

    UPDATE Preoperatoria
    SET    Preoperatoria.FPasivo = LE.FechaPasivo
    FROM   Preoperatoria, HClinica..LTiemposEspera LE
    WHERE  Preoperatoria.CodHojaPreop = @CodIntervencion
		   AND Preoperatoria.CodIntervencion = @CodIntervencion
		   AND Preoperatoria.CodPaciente=@spvar_CodPaciente
		   AND Preoperatoria.CodEpisodio=@spvar_CodEpisodio
		   AND Preoperatoria.FPreoperatoria=@spvar_FPreoperatoria
		   AND Preoperatoria.CodProc=@spvar_CodProc
		   AND LE.CodPaciente= Preoperatoria.CodPaciente
		   AND LE.CodEpisodio= Preoperatoria.CodEpisodio
		   AND LE.FechaPasivo Is Not Null


	UPDATE InformeQuirurgico
	SET    FSolicitud = @spvar_FPreoperatoria
	WHERE  InformeQuirurgico.CodPaciente = @spvar_CodPaciente 
		   AND InformeQuirurgico.CodEpisodio = @spvar_CodEpisodio


	UPDATE Ingresos..EpisodioHospitalizacion
	SET    TipoIntervSolic = @spvar_Tipo
	WHERE  CodPaciente = @spvar_CodPaciente
		   AND CodEpisodio = @spvar_CodEpisodio


END


UPDATE PrecedenteNoAnomalo
SET    GrupoSanguineo=@spvar_GSangre,RH=@spvar_RH
WHERE  CodPaciente=@spvar_CodPaciente

IF @@RowCount=0
 INSERT PrecedenteNoAnomalo(
						    CodPaciente,
							GrupoSanguineo,
							RH,
							Gordura,
							VidaSedentaria,
							Cansancio)
 VALUES(@spvar_CodPaciente,
		@spvar_GSangre,
		@spvar_RH,
		0,	
		0,
		0)


UPDATE Ingresos..EpisodioHospitalizacion
SET    TipoIntervSolic=@spvar_Tipo
FROM   Preoperatoria
WHERE  Ingresos..EpisodioHospitalizacion.CodPaciente = @spvar_CodPaciente
       AND Ingresos..EpisodioHospitalizacion.CodEpisodio = @spvar_CodEpisodio




    GO

GO



--dbo.SpHClIUDPartograma.sql

USE [Hclinica]
GO

IF EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[SpHClIUDPartograma]') AND type in (N'P', N'PC'))
	DROP PROCEDURE [dbo].[SpHClIUDPartograma]
GO

SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

/*
PROCEDIMIENTO     : SPHClIUDPartograma
FUNCION           : Inserta, actualiza y elimina del partograma
DEVUELVE          : 
FECHA             : 24/07/2006
VERSION           : 1.0
AUTOR             : Manuel Mas Asencio (MECEMSA)
MODIFICACIÓN	  : (16/05/2008) Jesús Mañogil - Mecemsa - Nuevos parámetros para guardar FCFetal e InicioGrafica
MODIFICACIÓN	  : (29/06/2010) Teresa L Fabuel. Nuevos parametros para Oxitocina. En todos los registros tienen el mismo valor.
MODIFICACIÓN	  : (18/07/2013) CTF - 73569626D - CHC3241_REQ33263_cambiar etiqueta y agregar combolista en partograma
MODIFICACIÓN	  : (29/07/2014) MAJL 1162 v4.46r1 Observaciones Partograma
MODIFICACIÓN	  : (24/08/2017) - v17.3r1 - 16147 - FCB - Mejoras Urgencia Maternidad y Partograma
*/

CREATE PROCEDURE [dbo].[SpHClIUDPartograma]
	@spvar_ACCION char(1), /* I-INSERT, U-UPDATE, D-DELETE */	
	@spvar_CodPaciente char(16), 
	@spvar_CodEpisodio char(5),
	@spvar_FecPartograma smalldatetime = NULL,
	@spvar_TAS smallint = NULL,
	@spvar_TAD smallint = NULL,
	@spvar_Pulso smallint = NULL,
	@spvar_Temperatura float = NULL,
	@spvar_Dilatacion char(2) = NULL,
	@spvar_Longitud char(1) = NULL,
	@spvar_Consistencia char(1) = NULL,
	@spvar_Posicion char(1) = NULL,
	@spvar_PlanoCabeza char(1) = NULL,
	@spvar_PhScalp float = NULL,
	@spvar_Saturacion tinyint = NULL,
	@spvar_FIO2 tinyint = NULL,
	@spvar_NIFObservador char(8) = NULL,
	@spvar_Observaciones varchar(200) = NULL,
	@spvar_Planta char(2) = NULL,
	@spvar_Miccion char(1)=null,
	@spvar_HoraEpidural smalldatetime = NULL,
	@spvar_FCFetal tinyint = NULL,
	@spvar_InicioGrafica bit = NULL,
	@spvar_FOxitocina datetime = Null,
	@spvar_IndicacionOxitocina varchar(200) = Null,
	@spvar_TipoAnalgesia int = Null,
	@spvar_VariedadPosicion varchar(20) = null,
	@spvar_MonitorizacionFetal varchar(200) = NULL,
	@spvar_ResponsableTexto varchar(200) = NULL,
	@spvar_FecAmniorrexis smallDateTime = NULL,
	@spvar_Amniorrexis bit = NULL,
	@spvar_LiqAmniotico char(1)= NULL
AS

IF @spvar_ACCION='I'

   BEGIN
	IF NOT EXISTS (SELECT CodPaciente 
				   FROM   Hclinica..Partograma 
				   WHERE  CodPaciente = @spvar_CodPaciente and 
						  CodEpisodio = @spvar_CodEpisodio and 
						  FecPartograma = @spvar_FecPartograma)   	   		
		INSERT INTO Hclinica..Partograma
						([CodPaciente], 
						 [CodEpisodio], 
						 [FecPartograma], 
						 [TAS], 
						 [TAD], 
						 [Pulso], 
						 [Temperatura], 
						 [Dilatacion], 
						 [Longitud], 
						 [Consistencia], 
						 [Posicion], 						 
						 [PhScalp], 
						 [Saturacion],
						 [Planta],
						 [NIFObservador],
						 [DescObservaciones], 						 
						 [PlanoCabeza],  
						 [FIO2],
						 Miccion,
						 HoraEpidural,					 
						 FCFetal,
						 InicioGrafica,
						 FOxitocina,
						 IndicacionOxitocina,
						 TipoAnalgesia,
						 VariedadPosicion,
						 MonitorizacionFetal,
						 ResponsableTexto,
						 FecAmniorrexis,
						 Amniorrexis,
						 LiqAmniotico
						 )					 
		VALUES 
			(@spvar_CodPaciente, 
			 @spvar_CodEpisodio, 
			 @spvar_FecPartograma,
			 @spvar_TAS, 
			 @spvar_TAD, 
			 @spvar_Pulso, 
			 @spvar_Temperatura, 
			 @spvar_Dilatacion, 
			 @spvar_Longitud, 
			 @spvar_Consistencia, 
			 @spvar_Posicion, 			 
			 @spvar_PhScalp, 
			 @spvar_Saturacion,	
			 @spvar_Planta,		 
			 @spvar_NIFObservador, 
			 @spvar_Observaciones,
			 @spvar_PlanoCabeza, 
			 @spvar_FIO2,
			 @spvar_Miccion,
			 @spvar_HoraEpidural,
			 @spvar_FCFetal,
			 @spvar_InicioGrafica,
			 @spvar_FOxitocina,
			 @spvar_IndicacionOxitocina,
			 @spvar_TipoAnalgesia,
			 @spvar_VariedadPosicion, 
			 @spvar_MonitorizacionFetal,
			 @spvar_ResponsableTexto,
			 @spvar_FecAmniorrexis,
			 @spvar_Amniorrexis,
			 @spvar_LiqAmniotico
			 )
   
		-- Se actualizan todos los registros con los valores nuevos
		Update Hclinica..Partograma
		Set FOxitocina = @spvar_FOxitocina,
			IndicacionOxitocina = @spvar_IndicacionOxitocina,
			HoraEpidural = @spvar_HoraEpidural,
			TipoAnalgesia = @spvar_TipoAnalgesia	
		Where CodPaciente = @spvar_CodPaciente and 
		      CodEpisodio = @spvar_CodEpisodio
   END

IF @spvar_ACCION ='U'

   BEGIN
      IF EXISTS (SELECT CodPaciente 
				 FROM   Hclinica..Partograma 
				 WHERE  CodPaciente = @spvar_CodPaciente and 
				 		CodEpisodio = @spvar_CodEpisodio and 
						FecPartograma = @spvar_FecPartograma)  
		BEGIN  
			-- Si IniciaGrafica tiene un valor, dado que sólamente una
			-- debe ser el inicio, antes limpiamos ese dato en todas
			IF @spvar_InicioGrafica = 1
			BEGIN
				UPDATE 
					Hclinica..Partograma
				SET 
					InicioGrafica = NULL	
				WHERE 	
					CodPaciente = @spvar_CodPaciente and	
					CodEpisodio = @spvar_CodEpisodio
			END

			UPDATE 
				Hclinica..Partograma
			SET 
				[FecPartograma]= @spvar_FecPartograma, 
				[TAS] = @spvar_TAS, 
				[TAD] = @spvar_TAD, 
				[Pulso] = @spvar_Pulso, 
				[Temperatura] = @spvar_Temperatura, 
				[Dilatacion] = @spvar_Dilatacion, 
				[Longitud] = @spvar_Longitud, 
				[Consistencia] = @spvar_Consistencia, 
				[Posicion] = @spvar_Posicion, 		
				[PhScalp] = @spvar_PhScalp, 
				[Saturacion] = @spvar_Saturacion,		
				[Planta] = @spvar_Planta,
				[NIFObservador] = @spvar_NIFObservador, 
				[DescObservaciones] = @spvar_Observaciones,
				[FIO2] = @spvar_FIO2, 
				[PlanoCabeza] = @spvar_PlanoCabeza,
				Miccion = @spvar_Miccion,
				HoraEpidural = @spvar_HoraEpidural,
				FCFetal = @spvar_FCFetal,
				InicioGrafica = @spvar_InicioGrafica,
				FOxitocina = @spvar_FOxitocina,
				IndicacionOxitocina = @spvar_IndicacionOxitocina,
				TipoAnalgesia=@spvar_TipoAnalgesia,
				VariedadPosicion=@spvar_VariedadPosicion, 
				MonitorizacionFetal=@spvar_MonitorizacionFetal,
				ResponsableTexto=@spvar_ResponsableTexto,
				FecAmniorrexis=@spvar_FecAmniorrexis,
				Amniorrexis=@spvar_Amniorrexis,
				LiqAmniotico=@spvar_LiqAmniotico
			WHERE 	
				CodPaciente = @spvar_CodPaciente and	
				CodEpisodio = @spvar_CodEpisodio and 	
				FecPartograma = @spvar_FecPartograma
		
			-- Se actualizan todos los registros con los valores nuevos
			Update HClinica..Partograma
			Set FOxitocina = @spvar_FOxitocina,
				IndicacionOxitocina = @spvar_IndicacionOxitocina,
				HoraEpidural = @spvar_HoraEpidural,			
				TipoAnalgesia=@spvar_TipoAnalgesia	
			Where CodPaciente = @spvar_CodPaciente and 
				  CodEpisodio = @spvar_CodEpisodio
		END
   END

IF @spvar_ACCION ='D'  

   BEGIN
      IF EXISTS (SELECT CodPaciente 
				 FROM   Hclinica..Partograma 
				 WHERE CodPaciente = @spvar_CodPaciente and 
					   CodEpisodio = @spvar_CodEpisodio and 
					   FecPartograma = @spvar_FecPartograma)	
		DELETE	
			Hclinica..Partograma
		WHERE 	
			CodPaciente = @spvar_CodPaciente and	
			CodEpisodio = @spvar_CodEpisodio and 	
			FecPartograma = @spvar_FecPartograma
   END

GO



--dbo.SpHClIUEstGin.sql

USE [Hclinica]
GO

IF EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[SpHClIUEstGin]') AND type in (N'P', N'PC'))
	DROP PROCEDURE [dbo].[SpHClIUEstGin]
GO

SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

--	PROCEDIMIENTO	  : SpHClIUEstGin
--	FUNCION           : Inserta/Actualiza los datos del informe Ginecológico/Gineco-Obstétrico
--	DEVUELVE          : 
--	FECHA             : 28/02/2006
--	VERSION           : 1.0
--	AUTOR             : Patricia Clemente
--	APLICACIÓN ORIGEN : HClinicaBasica.FEstGin - Formulario de Estudio Ginecológico/Gineco-Obstétrico
--  MODIFICACION      : (04/04/2011) Ramón Jiménez. Guardo si es una consulta de anticoncepción de emergencia y si se ha entregado el medicamento.
--  MODIFICACION      : (15/06/2011) César Moreno. Se incluyen los campos Latidos Card., Altura Uterina, Presentación, Estado membrana
--  MODIFICACION      : (08/08/2013) - CHC3279 - Alfredo - para el estudio ginecológico se incluye: EsFUROP; FechaFUR; FechaFUROP; EdadGestacionalFUR; EdadGestacionalFUROP; FechaPPFUR; FechaPPFUROP; VID; VDRL; Embarazos; Partos; Cesareas; Abortos; ObservacionesExamenes
--  MODIFICACION      : (21/10/2013) - CHC3625 - CTF - 73569626D - CHC3625_Observaciones REQ 27384 Informe Ginecológico en DAU
--  MODIFICACION      : (28/01/2015) - V4.50 - 1628 - RRG - V.D.R.L - REQ 67470
--  MODIFICACION      : (24/08/2017) - V17.3r1 - 16147 - FCB/APB - Mejoras Urgencia Maternidad y Partograma

CREATE PROCEDURE [dbo].[SpHClIUEstGin]
	 @spvar_strCodPaciente char(16)
	,@spvar_intNumConsulta tinyint
	,@spvar_FecConsulta smalldatetime
	,@spvar_strdescutero varchar(255)
	,@spvar_stradjunto varchar(255)
	,@spvar_strobs varchar(8000)
	,@spvar_strcausa varchar(65)
	,@spvar_strorigen char(1)
	,@spvar_fecultimaMenst smalldatetime
	,@spvar_strPar char(10)
	,@spvar_strnifmedicoinforme char(8)
	,@spvar_strdescgenext varchar(255) 
	,@spvar_intmenarquia tinyint
	,@spvar_bolembarazada bit
	,@spvar_strformula_menstrual varchar(16)
	,@spvar_stropc char(1)
	,@spvar_FecFirma datetime
	,@spvar_strAbdomen varchar(500)
	,@spvar_strVagina varchar(500)
	,@spvar_strCuerpoUtero varchar(500)
	,@spvar_strParametrios varchar(500)
	,@spvar_strDouglas varchar(500)
	,@spvar_strRectoVejiga varchar(500)
	,@spvar_strMamas varchar(500)
	,@spvar_AntiEmerg bit = null
	,@spvar_EntregaAntiEmerg bit = null
	,@spvar_LatidosCardiof varchar(500) = null
	,@spvar_AlturaUterina varchar(500) = null
	,@spvar_Presentacion varchar(500) = null
	,@spvar_EstadoMembrana varchar(500) = null
	,@EsFUROP bit = null
	,@FechaFUR smalldatetime = null
	,@FechaFUROP smalldatetime = null
	,@EdadGestacionalFUR varchar(10) = null
	,@EdadGestacionalFUROP varchar(10) = null
	,@FechaPPFUR datetime = null
	,@FechaPPFUROP datetime = null
	,@VID bit = null
	,@VDRL tinyint = null
	,@Embarazos integer = null
	,@Partos integer = null
	,@Cesareas integer = null
	,@Abortos integer = null
	,@ObservacionesExamenes varchar(5000) = null
	,@spvar_CodEpisodio varchar(5) = null
	,@spvar_PesoInicial decimal(6,2) = null
	,@spvar_PesoFinal decimal(6,2) = null
	,@spvar_Talla decimal(6,2) = null
AS

declare @spvar_intNCons tinyint

if @spvar_stropc='C'
	begin
		select @spvar_intNCons = isnull(max(NumConsulta)+1, 1) 
		from Hclinica..InformeGinecologico
		where CodPaciente = @spvar_strcodPaciente
	
		if @spvar_intNCons <> @spvar_intNumConsulta
			begin
				select @spvar_intNumConsulta = @spvar_intNCons
			end

			delete Hclinica..InformeGinecologico
			where CodPaciente = @spvar_strcodPaciente and
				  NumConsulta = @spvar_intNumConsulta

			insert into Hclinica..InformeGinecologico 
			    (CodPaciente
				,NumConsulta
				,FecConsulta
				,DescUtero
				,Adjunto
				,Obs
				,Causa
				,Origen
				,FecUltimaMenst
				,Par
				,NifMedicoInforme
				,DescGenExt
				,FecFirma
				,Abdomen
				,Vagina
				,CuerpoUtero
				,Parametrios
				,Douglas
				,RectoVejiga
				,Mamas
				,AntiConcepcionEmerg
				,EntregaAntiConcepcionEmerg
				,LatidosCard
				,AlturaUterina
				,Presentacion
				,EstadoMemb
			    ,EsFUROP
			    ,FechaFUR
			    ,FechaFUROP
			    ,EdadGestacionalFUR
			    ,EdadGestacionalFUROP
			    ,FechaPPFUR
			    ,FechaPPFUROP
			    ,VID
			    ,VDRL
			    ,Embarazos
			    ,Partos
			    ,Cesareas
			    ,Abortos
			    ,ObservacionesExamenes
				,CodEpisodio
				,PesoInicial
				,PesoFinal
				,Talla)
   	
			values 
			    (@spvar_strCodPaciente
				,@spvar_intNumConsulta
				,@spvar_FecConsulta
				,@spvar_strdescutero
				,@spvar_stradjunto
				,@spvar_strobs
				,@spvar_strcausa
				,@spvar_strorigen
				,@spvar_fecultimaMenst
				,@spvar_strPar
				,@spvar_strnifmedicoinforme
				,@spvar_strdescgenext
				,@spvar_FecFirma
				,@spvar_strAbdomen
				,@spvar_strVagina
				,@spvar_strCuerpoUtero
				,@spvar_strParametrios
				,@spvar_strDouglas
				,@spvar_strRectoVejiga
				,@spvar_strMamas
				,@spvar_AntiEmerg
				,@spvar_EntregaAntiEmerg
				,@spvar_LatidosCardiof
                ,@spvar_AlturaUterina
                ,@spvar_Presentacion
                ,@spvar_EstadoMembrana
				,@EsFUROP
			    ,@FechaFUR
			    ,@FechaFUROP
			    ,@EdadGestacionalFUR
			    ,@EdadGestacionalFUROP
			    ,@FechaPPFUR
			    ,@FechaPPFUROP
				,@VID
				,@VDRL
				,@Embarazos
				,@Partos
				,@Cesareas
				,@Abortos
				,@ObservacionesExamenes
				,@spvar_CodEpisodio
				,@spvar_PesoInicial
				,@spvar_PesoFinal
				,@spvar_Talla)
	end
else
	begin	
			update Hclinica..InformeGinecologico
			set  FecConsulta = @spvar_FecConsulta
				,Causa = @spvar_strCausa
				,Origen = @spvar_strOrigen
				,DescUtero = @spvar_strdescutero
				,Adjunto = @spvar_strAdjunto
				,FecUltimaMenst = @spvar_FecultimaMenst
				,Par = @spvar_strPar
				,NifMedicoInforme = @spvar_strnifmedicoinforme
				,DescGenExt = @spvar_strDescGenExt
				,FecFirma = @spvar_FecFirma
				,Obs = @spvar_strObs
				,Abdomen = @spvar_strAbdomen
				,Vagina = @spvar_strVagina
				,CuerpoUtero = @spvar_strCuerpoUtero
				,Parametrios = @spvar_strParametrios
				,Douglas = @spvar_strDouglas
				,RectoVejiga = @spvar_strRectoVejiga
				,Mamas = @spvar_strMamas
				,AntiConcepcionEmerg = @spvar_AntiEmerg
				,EntregaAntiConcepcionEmerg = @spvar_EntregaAntiEmerg
				,LatidosCard = @spvar_LatidosCardiof
				,AlturaUterina = @spvar_AlturaUterina
				,Presentacion = @spvar_Presentacion
				,EstadoMemb = @spvar_EstadoMembrana
				,EsFUROP = @EsFUROP
				,FechaFUR = @FechaFUR
				,FechaFUROP = @FechaFUROP
				,EdadGestacionalFUR = @EdadGestacionalFUR
				,EdadGestacionalFUROP = @EdadGestacionalFUROP
				,FechaPPFUR = @FechaPPFUR
				,FechaPPFUROP = @FechaPPFUROP
				,VID = @VID
				,VDRL = @VDRL
				,Embarazos = @Embarazos
				,Partos = @Partos
				,Cesareas = @Cesareas
				,Abortos = @Abortos
				,ObservacionesExamenes = @ObservacionesExamenes
				,CodEpisodio = @spvar_CodEpisodio
				,PesoInicial = @spvar_PesoInicial
				,PesoFinal = @spvar_PesoFinal
				,Talla = @spvar_Talla
			where CodPaciente = @spvar_strCodPaciente and
				  NumConsulta = @spvar_intNumConsulta
	end
	
    /*Actualizar los datos en la tabla antecedentesginecobstricos*/
	update Hclinica..AntecedentesGinecobstricos
	set  AnyosMenar = @spvar_intmenarquia
		,EnCinta = @spvar_bolembarazada
		,DescFormula = @spvar_strformula_menstrual
		,FechaUltMens = @spvar_fecultimaMenst
	where CodPaciente = @spvar_strCodPaciente

if @@ROWCOUNT = 0
	begin
		insert into Hclinica..AntecedentesGinecobstricos
			    (CodPaciente
				,AnyosMenar
				,EnCinta
				,DescFormula
				,Par
				,FechaUltMens
				,TieneHijosE
				,TieneAbortosE
				,TieneHijosI)
		values
				(@spvar_strCodPaciente
				,@spvar_intmenarquia
				,@spvar_bolEmbarazada
				,@spvar_strformula_menstrual
				,@spvar_strPar
				,@spvar_fecultimaMenst
				,0
				,0
				,0)	
	end

GO



--dbo.SpHCLSDetalleParto.sql

USE [Hclinica]
GO

IF EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[SpHCLSDetalleParto]') AND type in (N'P', N'PC'))
	DROP PROCEDURE [dbo].[SpHCLSDetalleParto]
GO

/************************************************************************
PROCEDIMIENTO : SpHCLSDetalleParto
FUNCION       :
DEVUELVE      :
FECHA         : 20/11/2006
VERSION       : 1.0
AUTOR         : Teresa L Fabuel Serrano
************************************************************************
MODIFICACIÓN  : (10/10/2017) - v17.3r1 - 16147 - APB - Mejoras Urgencia Maternidad y Partograma
************************************************************************/

CREATE PROCEDURE [dbo].[SpHCLSDetalleParto]
	 @spvar_CodPaciente char(16)
 	,@spvar_CodEpisodio char(5)
	,@spvar_Codigo char(1)
	,@spvar_Tabla char(20)
AS

SELECT DISTINCT DP.CodPaciente
			   ,DP.CodEpisodio
			   ,DP.Fecha
			   ,DP.Codigo
			   ,DP.Tipo
			   ,DP.FechaInsert
			   ,(SELECT DISTINCT C.Descripcion
				 FROM Parametros..Codigos C
				 WHERE C.Tabla = @spvar_Tabla AND C.Codigo = DP.Tipo) Descripcion

FROM Hclinica..DetalleParto DP

WHERE DP.CodPaciente = @spvar_CodPaciente AND
	  DP.CodEpisodio = @spvar_CodEpisodio AND
	  DP.Codigo = @spvar_Codigo

GO
GO



--dbo.SpHClSEcografias.sql

USE [HClinica];
GO

IF EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[SpHClSEcografias]') AND type in (N'P', N'PC'))
	DROP PROCEDURE [dbo].[SpHClSEcografias]
GO
    
/*
PROCEDIMIENTO     : SpHClSEcografias
FUNCION           : Obtiene las ecografías de una paciente
DEVUELVE		  : 
FECHA             : 06/07/2006
VERSION           : 1.0
AUTOR             : Manuel Mas Asencio (MECEMSA)
MODIFICACIÓN	  : (24/08/2017) - v17.3r1 - 16147 - FCB - Mejoras Urgencia Maternidad y Partograma
*/

CREATE PROCEDURE [dbo].[SpHClSEcografias]
	@spvar_CodPaciente char(16)
AS
		
SELECT 	
	 E.CodPaciente
	,E.NumGest
	,E.NumPartos
	,E.NumCesareas
	,E.NumAbortEspont
	,E.NumAbortosIVE
	,E.NumEctopicos
	,E.EGSemanas
	,E.EGDias
	,E.Estado
	,E.Peso
	,E.AnatomiaPatologica
FROM 	
	Ecogrf E
WHERE	
	E.CodPaciente = @spvar_CodPaciente
	AND E.FecExploracion > (getdate() - 365) 
ORDER BY E.FecExploracion Desc

GO

GO



--dbo.SpHClSEstGin.sql

USE [Hclinica]
GO

IF EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[SpHClSEstGin]') AND type in (N'P', N'PC'))
	DROP PROCEDURE [dbo].[SpHClSEstGin]
GO

SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

--	PROCEDIMIENTO	  : SpHClSEstGin
--	FUNCION           : Devuelve los datos del informe Ginecológico/Gineco-Obstétrico
--	DEVUELVE          : 
--	FECHA             : 27/02/2006
--	VERSION           : 1.0
--	AUTOR             : Patricia Clemente
--	APLICACIÓN ORIGEN : Informe Ginecologico
--  MODIFICACION      : (04/04/2011) Ramón Jiménez. Obtengo los campos AntiConcepcionEmerg y EntregaAntiConcepcionEmerg
--  MODIFICACION      : (15/06/2011) César Moreno. Se incluyen los campos Latidos Card., Altura Uterina, Presentación, Estado membrana
--  MODIFICACION      : (08/08/2013) - CHC3279 - Alfredo - para el estudio ginecológico se incluye: EsFUROP; FechaFUR; FechaFUROP; EdadGestacionalFUR; EdadGestacionalFUROP; FechaPPFUR; FechaPPFUROP; VID; VDRL; Embarazos; Partos; Cesareas; Abortos; ObservacionesExamenes
--  MODIFICACION      : (21/10/2013) - CHC3625 - CTF - 73569626D - CHC3625_Observaciones REQ 27384 Informe Ginecológico en DAU
--  MODIFICACION      : (16/12/2013) - CHC3959 - NCB - Informe Ginecológico
--  MODIFICACION      : (24/08/2017) - V17.3r1 - 16147 - FCB - Mejoras Urgencia Maternidad y Partograma

CREATE PROCEDURE [dbo].[SpHClSEstGin]
	 @CodPaciente char(16)
	,@spvar_CodEpisodio char(5) = null 
AS

select Medico = (rtrim(NomMedico) + ' ' + rtrim(apell1) + ' ' + rtrim(apell2))
	  ,A.AnyosMenar
	  ,A.EnCinta
	  ,A.DescFormula
	  ,I.Par
	  ,I.FecUltimaMenst
	  ,I.NumConsulta
	  ,I.Origen
	  ,I.FecConsulta
	  ,I.Causa
	  ,I.DescUtero
	  ,I.Adjunto 
	  ,I.DescGenExt
	  ,I.Obs
	  ,I.NifMedicoInforme
	  ,I.FecFirma
	  ,I.Abdomen
	  ,I.Vagina
	  ,I.CuerpoUtero
	  ,I.Parametrios
	  ,I.Douglas
	  ,I.RectoVejiga
	  ,I.Mamas
	  ,I.LatidosCard
	  ,I.AlturaUterina
	  ,I.Presentacion
	  ,I.EstadoMemb
	  ,I.AntiConcepcionEmerg as AntiConcepcionEmerg
	  ,I.EntregaAntiConcepcionEmerg as EntregaAntiConcepcionEmerg
	  ,I.EsFUROP
	  ,I.FechaFUR
	  ,I.FechaFUROP
	  ,I.EdadGestacionalFUR
	  ,I.EdadGestacionalFUROP
	  ,I.FechaPPFUR
	  ,I.FechaPPFUROP
	  ,I.VID
	  ,I.VDRL
	  ,I.Embarazos
	  ,I.Partos
	  ,I.Cesareas
	  ,I.Abortos
	  ,I.ObservacionesExamenes
	  ,I.PesoInicial
	  ,I.PesoFinal
	  ,I.Talla

from Hclinica..InformeGinecologico I 
	 left outer join Hclinica..AntecedentesGinecobstricos A on I.CodPaciente = A.CodPaciente
	 left outer join Parametros..ParametrosMedicos P on I.NifMedicoInforme = P.DNIMedico  

where A.CodPaciente = @codPaciente and
	 (@spvar_CodEpisodio is null or I.CodEpisodio = @spvar_CodEpisodio)

GO



--dbo.SpHClSHojaParto.sql

USE [Hclinica]
GO

IF EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[SpHClSHojaParto]') AND type in (N'P', N'PC'))
	DROP PROCEDURE [dbo].[SpHClSHojaParto]
GO

SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

/*
PROCEDIMIENTO : SpHClSHojaParto
FUNCION       : Obtiene los datos de una Hoja de Parto/Obstétrica
DEVUELVE	  :
FECHA         : 06/07/2006
VERSION       : 1.0
AUTOR         : Manuel Mas Asencio (MECEMSA)
MODIFICACION  : (30/06/2011) Teresa L Fabuel. Se obtiene el campo TecEspontanea
MODIFICACION  : (05/11/2012) Fran Cuenca, CHC2315 v4.34 añadir nuevos asistentes a la hoja de fin de parto
MODIFICACION  : (31/01/2013) MAS - CHC2477 - v4.37 - Modificada en la Select la asignación de LactMaterna por TipoLactancia del Alumbramiento.
MODIFICACION  : (02/04/2013) CTF - 73569626D - v4.39 - CHC2425_REQ17079_Módulo Bloque Materno Infantil - Hoja de Parto
MODIFICACION  : (07/05/2015) - V4.50r2 - 2145 - AAP - Hoja fin de parto
MODIFICACION  : (10/11/2016) - V4.66 - 13885 - SGH - Opciones en liquido teñido
MODIFICACION  : (16/10/2017) - V17.3r1 - 16147 - APB - Mejoras Urgencia Maternidad y Partograma
*/

CREATE PROCEDURE [dbo].[SpHClSHojaParto]
	 @spvar_CodPaciente char(16)
	,@spvar_CodEpisodio char(5)
AS

Declare @spvar_FApe1Padre datetime
Declare @spvar_FecUltimaMenst datetime

SET @spvar_FApe1Padre = (SELECT max(E.FecExploracion)
						 FROM 	Hclinica..Ecogrf E
						 WHERE	E.CodPaciente = @spvar_CodPaciente AND
								E.FecExploracion > (getdate() -240) AND
								E.NumSemana = '20')

SET @spvar_FecUltimaMenst = (SELECT max(E.FecExploracion)
							 FROM   Hclinica..Ecogrf E
							 WHERE	E.CodPaciente = @spvar_CodPaciente AND
									E.FecExploracion > (getdate() -270))

SELECT A.[CodPaciente]
	  ,A.[CodEpisodio]
	  ,A.[FecHojaAlumbramiento]
	  ,A.[CausaIngreso]
	  ,A.[CtrlTension]
	  ,A.[DespDiabetes]
	  ,A.[DespStreptococo]
	  ,DescDespStreptococo = (SELECT C.Descripcion
						      FROM   Parametros..Codigos C
						      WHERE  C.Tabla = 'DespStreptAga' AND C.Codigo = A.DespStreptococo)
	  ,A.[TratCtrlTension]
	  ,A.[TratDiabetes]
	  ,A.[ProbFetal]
	  ,A.[ProbMaternos]
	  ,A.[FecIniAlumbramiento]
	  ,A.[TipoAlumbramientoInicio]
	  ,TipoPartoInicioDescripcion = (SELECT C.Descripcion 
								     FROM   Parametros..Codigos C 
								     WHERE  Tabla = 'EstTipoParto' AND C.Codigo = A.TipoAlumbramientoInicio)
	  ,A.[IndicInicio]
	  ,A.[TipoPresentacion]
	  ,PresentacionDescripcion = (SELECT C.Descripcion 
							      FROM   Parametros..Codigos C 
							      WHERE  Tabla = 'EstPresentacion' AND C.Codigo = A.TipoPresentacion)
      ,A.[DescOtraPresentacion]
	  ,A.[FecAmniorrexis]
	  ,A.[Amniorrexis]
	  ,TipoAmniorrexisDescripcion = (SELECT C.Descripcion 
								     FROM   Parametros..Codigos C 
								     WHERE  Tabla = 'EstAmniorrexis' AND C.Codigo = A.Amniorrexis)
	  ,A.[LiqAmniotico]
	  ,LiquidoAmnioticoDescripcion = (SELECT C.Descripcion 
								      FROM   Parametros..Codigos C 
								      WHERE  Tabla = 'EstLiqAmniotico' AND C.Codigo = A.LiqAmniotico)
	  ,A.[AmniorrexisObserv]
	  ,A.[FecFinParto]
	  ,A.[Parto]
	  ,A.[Anestesia]
	  ,A.[AnestEfectiva]
	  ,A.[FecUltimaMenst]
	  ,A.[EdadGestS]
	  ,A.[EdadGestD]
	  ,A.[AlumbramientoUnico]
	  ,A.[NumHijos]
   	  ,A.[TipoLactancia]
	  ,A.[PesoPlacenta]
	  ,A.[DescCaractPlacenta]
	  ,A.[DescManiobras]
	  ,A.[TipoAlumbramientoFin]
	  ,A.[TecInstrum]
	  ,A.[TecPod]
	  ,A.[IndicInstrument]
	  ,A.[IndicCesarea]
	  ,A.[NIFMatrona]
	  ,NombreMatrona = (
						SELECT rtrim(NombreEnf) + ' ' + rtrim(Apell1Enf) + ' ' + rtrim(Apell2Enf)
						FROM Parametros..DatosEnfermeras 
						WHERE DNIEnf = [NIFMatrona]
						UNION
						SELECT rtrim(NomMedico) + ' ' + rtrim(Apell1) + ' ' + rtrim(Apell2)
						FROM Parametros..ParametrosMedicos 
						WHERE DNIMedico = [NIFMatrona]
						UNION
						SELECT rtrim(NombreTecnico) + ' ' + rtrim(Apell1Tecnico) + ' ' + rtrim(Apell2Tecnico)
						FROM Parametros..TecnicosDatos 
						WHERE DNITecnico = [NIFMatrona])
	  ,A.[NIFGinec]
	  ,NombreGinecologo = (
						   SELECT rtrim(NombreEnf) + ' ' + rtrim(Apell1Enf) + ' ' + rtrim(Apell2Enf)
						   FROM Parametros..DatosEnfermeras 
						   WHERE DNIEnf = [NIFGinec]
						   UNION
						   SELECT rtrim(NomMedico) + ' ' + rtrim(Apell1) + ' ' + rtrim(Apell2)
						   FROM Parametros..ParametrosMedicos 
						   WHERE DNIMedico = [NIFGinec]
						   UNION
						   SELECT rtrim(NombreTecnico) + ' ' + rtrim(Apell1Tecnico) + ' ' + rtrim(Apell2Tecnico)
						   FROM Parametros..TecnicosDatos 
						   WHERE DNITecnico = [NIFGinec])
	  ,A.[NIFPediatraPre]
	  ,NombrePediatraAntes = (
							  SELECT rtrim(NombreEnf) + ' ' + rtrim(Apell1Enf) + ' ' + rtrim(Apell2Enf)
							  FROM Parametros..DatosEnfermeras 
							  WHERE DNIEnf = [NIFPediatraPre]
							  UNION
							  SELECT rtrim(NomMedico) + ' ' + rtrim(Apell1) + ' ' + rtrim(Apell2)
							  FROM Parametros..ParametrosMedicos 
							  WHERE DNIMedico = [NIFPediatraPre]
							  UNION
							  SELECT rtrim(NombreTecnico) + ' ' + rtrim(Apell1Tecnico) + ' ' + rtrim(Apell2Tecnico)
							  FROM Parametros..TecnicosDatos 
							  WHERE DNITecnico = [NIFPediatraPre])
	  ,A.[NIFPediatraPost]
	  ,NombrePediatraDespues = (
								SELECT rtrim(NombreEnf) + ' ' + rtrim(Apell1Enf) + ' ' + rtrim(Apell2Enf)
								FROM Parametros..DatosEnfermeras 
								WHERE DNIEnf = [NIFPediatraPost]
								UNION
								SELECT rtrim(NomMedico) + ' ' + rtrim(Apell1) + ' ' + rtrim(Apell2)
								FROM Parametros..ParametrosMedicos 
								WHERE DNIMedico = [NIFPediatraPost]
								UNION
								SELECT rtrim(NombreTecnico) + ' ' + rtrim(Apell1Tecnico) + ' ' + rtrim(Apell2Tecnico)
								FROM Parametros..TecnicosDatos 
								WHERE DNITecnico = [NIFPediatraPost])
	  ,A.[NIFAnest]
	  ,NombreAnestesiologo = (
							  SELECT rtrim(NombreEnf) + ' ' + rtrim(Apell1Enf) + ' ' + rtrim(Apell2Enf)
							  FROM Parametros..DatosEnfermeras 
							  WHERE DNIEnf = [NIFAnest]
							  UNION
							  SELECT rtrim(NomMedico) + ' ' + rtrim(Apell1) + ' ' + rtrim(Apell2)
							  FROM Parametros..ParametrosMedicos 
							  WHERE DNIMedico = [NIFAnest]
							  UNION
							  SELECT rtrim(NombreTecnico) + ' ' + rtrim(Apell1Tecnico) + ' ' + rtrim(Apell2Tecnico)
							  FROM Parametros..TecnicosDatos 
							  WHERE DNITecnico = [NIFAnest])
	  ,A.[Observ]
	  ,A.[FecEntParitorio]
	  ,A.[FecSalParitorio]
	  ,Sub.Ape1Padre
	  ,Sub.Ape1Madre
	  ,EcoFUR = Sub2.FecUltimaMenst
	  ,Sub2.EdadGestReal
	  ,A.EdadGesta
	  ,A.TratEstreptococo
	  ,A.PartoNatural
	  ,A.FirmaConsent
	  ,A.LiqAmniotico2
	  ,LT.Codigo AS LiqTenido
	  ,A.LiqCantidad
	  ,A.Episio
	  ,A.Desgarro
	  ,LiquidoAmnioticoDescripcion2 = (SELECT C.Descripcion 
								       FROM   Parametros..Codigos C 
								       WHERE  Tabla = 'EstTipoParto2' AND C.Codigo = A.LiqAmniotico2)
	  ,A.TecCesarea
	  ,A.TecEspontanea
	  ,A.NIFMatronaRN
	  ,A.NIFTENSParto
	  ,A.NIFTENSRN
	  ,PNA.GrupoSanguineo
	  ,PNA.RH
	  ,PNA.VIH
	  ,PNA.VIHObservaciones
	  ,PNA.VDRL
	  ,PNA.VDRLObservaciones
	  ,PNA.RHSensibilizado
	  ,A.IndicEspontanea
	
FROM Hclinica..Alumbramiento A 	
	 LEFT JOIN 
			  (SELECT E.Ape1Padre
			         ,Ape1Madre = P.PacApell1
			         ,P.CodPaciente
			   FROM   Hclinica..Pacientes P
			          LEFT JOIN Ecogrf E ON E.CodPaciente = P.CodPaciente
			   WHERE  E.CodPaciente = @spvar_CodPaciente AND
					  E.FecExploracion = @spvar_FApe1Padre) Sub ON Sub.CodPaciente = A.CodPaciente
	 LEFT JOIN 
			  (SELECT E.FecUltimaMenst
			         ,E.EdadGestReal
			         ,E.CodPaciente
			   FROM   Hclinica..Ecogrf E
			   WHERE  E.CodPaciente = @spvar_CodPaciente AND
					  E.FecExploracion = @spvar_FecUltimaMenst) Sub2 ON Sub2.CodPaciente = A.CodPaciente		
	 LEFT JOIN Hclinica..PrecedenteNoAnomalo PNA ON PNA.CodPaciente = A.CodPaciente
	 LEFT JOIN Parametros..LiquidoTenyido LT ON LT.Codigo = A.LiqTenido

WHERE A.CodPaciente = @spvar_CodPaciente AND A.CodEpisodio = @spvar_CodEpisodio

GO
GO



--dbo.SpHClSPartograma.sql

USE [Hclinica]
GO

IF EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[SpHClSPartograma]') AND type in (N'P', N'PC'))
	DROP PROCEDURE [dbo].[SpHClSPartograma]
GO

SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

/*
PROCEDIMIENTO : SpHClSPartograma
FUNCION       : Obtiene los datos del Partograma
DEVUELVE      :
FECHA         : 21/07/2006
VERSION       : 1.0
AUTOR         : Manuel Mas Asencio (MECEMSA)
MODIFICACION  : (16/05/2008) Jesús Mañogil - Mecemsa - Nuevos campos en la select para obtener FCFetal y InicioGrafica
MODIFICACION  : (30/10/2009) Paco Aznar  Se devuelve el centro del episodio que se consulta
MODIFICACION  :	(29/06/2010) Teresa L Fabuel. Se devuelven los campos FOxitocina y IndicacionOxitocina de Partograma.
MODIFICACION  :	(18/07/2013) CTF - 73569626D - CHC3241_REQ33263_cambiar etiqueta y agregar combolista en partograma
MODIFICACION  : (29/07/2014) MAJL v4.46r1 Observaciones Partograma
MODIFICACION  : (24/08/2017) - V17.3r1 - 16147 - FCB/APB - Mejoras Urgencia Maternidad y Partograma
*/

CREATE PROCEDURE [dbo].[SpHClSPartograma]
	 @spvar_CodPaciente char(16)
	,@spvar_CodEpisodio char(5)
AS
	
SELECT P.FecPartograma
	  ,P.TAS
	  ,P.TAD
	  ,P.Pulso
	  ,P.Temperatura
	  ,P.Dilatacion
	  ,DescDilatacion = (SELECT C.Descripcion 
					     FROM   Parametros..Codigos C 
					     WHERE  C.Tabla = 'EstDilatacionParto' AND C.Codigo = P.Dilatacion)
	  ,P.Longitud
	  ,DescLongitud = (SELECT C.Descripcion 
					   FROM   Parametros..Codigos C 
					   WHERE  C.Tabla = 'EstLongitudParto' AND C.Codigo = P.Longitud)
	  ,P.Consistencia
	  ,DescConsistencia = (SELECT C.Descripcion 
						   FROM   Parametros..Codigos C 
						   WHERE  C.Tabla = 'EstConsistenciaParto' AND C.Codigo = P.Consistencia)
	  ,P.Posicion
	  ,DescPosicion = (SELECT C.Descripcion 
					   FROM   Parametros..Codigos C 
					   WHERE  C.Tabla = 'EstPosicionParto' AND C.Codigo = P.Posicion)
	  ,P.PlanoCabeza
	  ,DescPlanoCabeza = (SELECT C.Descripcion 
					      FROM   Parametros..Codigos C 
					      WHERE  C.Tabla = 'EstPlanoCabeza' AND C.Codigo = P.PlanoCabeza)
	  ,P.PhScalp
	  ,P.Saturacion
	  ,P.FCFetal
	  ,P.FIO2
	  ,P.NIFObservador
	  ,Usuario = U.Dni
	  ,NombreUsu = U.NombreCompleto
  	  ,P.DescObservaciones
	  ,P.Planta
	  ,P.CodPaciente
	  ,P.CodEpisodio
	  ,P.Miccion
	  ,DescMiccion = (SELECT C.Descripcion 
					  FROM  Parametros..Codigos C 
					  WHERE C.Tabla = 'Miccion' AND C.Codigo = P.Miccion)
	  ,P.HoraEpidural
	  ,P.InicioGrafica
	  ,codCentro = CASE substring(@spvar_CodEpisodio,1,1)
				   WHEN 'H' THEN (SELECT CentroIngreso FROM Ingresos..EpisodioHospitalizacion EH WHERE EH.CodEpisodio = @spvar_CodEpisodio AND EH.CodPaciente = @spvar_CodPaciente)
				   WHEN 'U' THEN (SELECT CodigoCentUrg FROM Ingresos..EpisodioUrgencias U WHERE U.CodEpisodio = @spvar_CodEpisodio AND U.CodPaciente = @spvar_CodPaciente) END
	  ,P.FOxitocina
	  ,P.IndicacionOxitocina
	  ,P.TipoAnalgesia
	  ,P.VariedadPosicion
	  ,P.MonitorizacionFetal
	  ,P.ResponsableTexto
	  ,P.FecAmniorrexis
	  ,P.Amniorrexis
	  ,P.LiqAmniotico

FROM Hclinica..Partograma P
	 LEFT JOIN Parametros..vParDatosUsuarios U ON U.Dni = P.NIFObservador

WHERE P.CodPaciente = @spvar_CodPaciente AND P.CodEpisodio = @spvar_CodEpisodio	

ORDER BY P.FecPartograma

GO



--dbo.SpHClSSolicitudTraslado.sql

USE [Hclinica]
GO

IF EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[SpHClSSolicitudTraslado]') AND type in (N'P', N'PC'))
	DROP PROCEDURE [dbo].[SpHClSSolicitudTraslado]
GO

SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

/*
PROCEDIMIENTO: SpHClSSolicitudTraslado
FUNCION: Obtiene las solicitudes de traslado por diferentes criterios: paciente, episodio, ámbito, tipo, fechas
DEVUELVE:
FECHA: 24/07/2013
VERSION: 1.0
AUTOR: MAIPU CHC2503 V4.40 FCB, Solicitudes de traslado
MODIFICACION: MAIPU CHC3555 V4.40 R5 FCB, Observacion CHC2503
MODIFICACIÓN: (15/10/2013) Alberto Pagán - MAIPU CHC3617 - V4.40 Release 6 - Observaciones Solicitud de Traslado
MODIFICACIÓN: (08/04/2014) MAIPU CHC4283 v4.42 FCB, Integración con SAP se envié en el campo centro el valor que tenga el Episodio
MODIFICACION: (22/08/2017) - V17.3 - 19362 - MPR - Gestor de Solicitudes de Traslado
MODIFICACIÓN: (24/08/2017) - V17.3 - 19362 - ASM - Gestor de Solicitudes de Traslado - Añado CodPaciente y CodEpisodio a la select
MODIFICACIÓN: (31/08/2017) - V17.3 - 19362 - ASM - Gestor de Solicitudes de Traslado - Si traigo CodPaciente pero no CodEpisodio, nos traemos todas las solicitudes del paciente-centro
MODIFICACIÓN: (19/10/2017) - V17.3r1 - 20637 - APB - Observaciones Gestor de Solicitudes de Traslado
*/

CREATE PROCEDURE [dbo].[SpHClSSolicitudTraslado]
     @spvar_CodPaciente char(16) = null
	,@spvar_CodEpisodio char(5) = null
	,@spvar_CodCentro char(5)
	,@spvar_Tipo char(1) = null
	,@spvar_Internos bit = null
	,@spvar_Externos bit = null
	,@spvar_FechaDesde smalldatetime = null
	,@spvar_FechaHasta smalldatetime = null
	,@spvar_CCEE char(1) = null
	,@spvar_Hosp char(1) = null
	,@spvar_Urg char(1) = null
AS 

BEGIN 
	SELECT ST.IdSolicitudTraslado
		  ,ST.IdEstSolTrans
		  ,ST.FSolicitud
		  ,ST.FModificacion
	      ,ST.CodCentro 
	      ,ST.CodPaciente
	      ,ST.CodEpisodio
	      ,ST.IdPrioSolTrans
	      ,ST.TipoTrasladoOri
	      ,ST.TipoTrasladoDes
	      ,ST.IdTipoVehiculoTras
	      ,ST.Retorno
	      ,ST.Medicalizado
	      ,ST.CodCentroOri
	      ,ST.CodAreaOri
	      ,ST.CodPlantasOri
	      ,ST.NumCamaOri
	      ,ST.CodCamaOri
	      ,ST.CodUbiConsOri
	      ,ST.CodSalaOri
	      ,ST.NumQuirofanoOri
	      ,ST.CodServicioOri
	      ,ST.CodCentroDes
	      ,ST.CodAreaDes
	      ,ST.CodPlantasDes
	      ,ST.NumCamaDes
	      ,ST.CodCamaDes
	      ,ST.CodUbiConsDes
	      ,ST.CodSalaDes
	      ,ST.NumQuirofanoDes
	      ,ST.CodServicioDes
	      ,ST.TrasExtOri
	      ,ST.DesTrasExtOri
	      ,ST.TrasExtDes
	      ,ST.DesTrasExtDes
	      ,ST.Observaciones
	      ,TVT.DesTipoVehiculoTras 
	      ,PST.DesPrioSolTrans
		  ,P.NumTarjSanitaria AS RUN
		  ,P.CodHistoria
		  ,RTRIM(P.PacNombre) + ' ' + RTRIM(P.PacApell1) + ' ' + RTRIM(P.PacApell2) AS NomCompletoPaciente
		  ,RIGHT('00000000' + LTRIM(RTRIM(AHP.[CodHistoriaPapel])),8) AS NHistPapel
		  ,ST.DNIProfesional 
		  ,RTRIM(VDU.Nombre) + ' ' + RTRIM(VDU.Apellido1) + ' ' + RTRIM(VDU.Apellido2) AS NomCompletoFuncionario
		  ,ST.CodPaciente
		  ,ST.CodEpisodio		  
		  ,EST.DesEstSolTran
		  ,ST.CodAcompanyante
		  ,ST.DNIMedicoTraslada
		  ,MedTras.NombreCompleto AS 'MedicoTraslada'
		  ,ST.DNIEnfermeraTraslada
		  ,EnfTras.NombreCompleto AS 'EnfermeraTraslada'
		  ,ST.NombreMedicoRecibe
		  ,ST.NombreEnfermeraRecibe
		  ,ST.NombreMatronaRecibe
		  ,STA.DescAcompanyante AS 'Acompanyante'
		  ,RTRIM(P.PacNombre) AS 'PacNombre'
		  ,RTRIM(P.PacApell1) AS 'PacApellido1'
		  ,RTRIM(P.PacApell2) AS 'PacApellido2'
	
	FROM Hclinica..SolicitudTraslado ST
		 LEFT JOIN Parametros..TipoVehiculoTras TVT ON TVT.IdTipoVehiculoTras = ST.IdTipoVehiculoTras 
		 LEFT JOIN Parametros..PrioSolTrans PST ON PST.IdPrioSolTrans = ST.IdPrioSolTrans 
		 LEFT JOIN Hclinica..Pacientes P ON P.CodPaciente = ST.CodPaciente 
		 LEFT JOIN Hclinica..ArchivoHistoriasPapel AHP ON AHP.CodPaciente = ST.CodPaciente AND AHP.CodCentro = ST.CodCentro 
		 LEFT JOIN Parametros..vParDatosUsuarios VDU ON VDU.Dni = ST.DNIProfesional 
		 LEFT JOIN Parametros..EstSolTrans EST ON EST.IdEstSolTrans = ST.IdEstSolTrans
		 LEFT JOIN Parametros..vParDatosUsuarios MedTras ON MedTras.Dni = ST.DNIMedicoTraslada
		 LEFT JOIN Parametros..vParDatosUsuarios EnfTras ON EnfTras.Dni = ST.DNIEnfermeraTraslada
		 LEFT JOIN Parametros..SolicitudTrasladoAcompanyante STA ON STA.CodAcompanyante = ST.CodAcompanyante AND STA.CodCentro = @spvar_CodCentro
	
	WHERE (@spvar_CodPaciente IS NOT NULL AND ST.CodPaciente = @spvar_CodPaciente AND
			ST.CodEpisodio = ISNULL(@spvar_CodEpisodio,ST.CodEpisodio) AND
			ST.CodCentro = @spvar_CodCentro) OR
		  (@spvar_CodPaciente IS NULL AND ST.CodCentro = @spvar_CodCentro AND
			(SUBSTRING(ST.CodEpisodio,1,1) = ISNULL(@spvar_CCEE,SUBSTRING(ST.CodEpisodio,1,1)) OR
			 SUBSTRING(ST.CodEpisodio,1,1) = ISNULL(@spvar_Hosp,SUBSTRING(ST.CodEpisodio,1,1)) OR
			 SUBSTRING(ST.CodEpisodio,1,1) = ISNULL(@spvar_Urg,SUBSTRING(ST.CodEpisodio,1,1))) AND
		  ((@spvar_Internos = 1 AND TipoTrasladoOri = 0 AND TipoTrasladoDes = 0 AND CodAreaOri IS NOT NULL AND CodAreaDes IS NOT NULL) OR
		   (@spvar_Externos = 1 AND (TipoTrasladoOri = 1 OR TipoTrasladoDes = 1 OR CodAreaOri IS NULL OR CodAreaDes IS NULL))) AND
			ST.FSolicitud BETWEEN ISNULL(@spvar_FechaDesde,ST.FSolicitud) AND ISNULL(@spvar_FechaHasta,ST.FSolicitud))

END

GO
GO



--dbo.SpHClUEcogrf.sql

USE [Hclinica];
GO

IF EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[SpHClUEcogrf]') AND type in (N'P', N'PC'))
	DROP PROCEDURE [dbo].[SpHClUEcogrf]
GO
    
/*
PROCEDIMIENTO : SpHClUEcogrf
FUNCION       : Modifica las ecografías de una paciente
DEVUELVE	  :
FECHA         : 20/11/2006
VERSION       : 1.0
AUTOR         : Teresa L Fabuel Serrano (Agensys)
MODIFICACIÓN  : (24/08/2017) - V17.3r1 - 16147 - FCB/APB - Mejoras Urgencia Maternidad y Partograma
*/

CREATE PROCEDURE [dbo].[SpHClUEcogrf]
	 @spvar_CodPaciente char(16)
	,@spvar_CodEpisodio char(5)
	,@spvar_NumGesta tinyint
	,@spvar_NumParto tinyint
	,@spvar_NumCesarea tinyint
	,@spvar_NumAborto tinyint
	,@spvar_EGSemanas tinyint = null
	,@spvar_EGDias tinyint = null
	,@spvar_Estado bit = null
	,@spvar_Peso decimal(6,2) = null
	,@spvar_AnatomiaPatologica varchar(1000) = null
AS

if (select count(*)
	from Hclinica..Ecogrf
	where CodPaciente = @spvar_CodPaciente and CodEpisodio = @spvar_CodEpisodio) > 0
	begin
		update Hclinica..Ecogrf
		set  NumGest = @spvar_NumGesta
			,NumPartos = @spvar_NumParto
			,NumCesareas = @spvar_NumCesarea
			,NumAbortEspont = @spvar_NumAborto
			,EGSemanas = @spvar_EGSemanas
			,EGDias = @spvar_EGDias
			,Estado = @spvar_Estado
			,Peso = @spvar_Peso
			,AnatomiaPatologica = @spvar_AnatomiaPatologica
		where CodPaciente = @spvar_CodPaciente and
		      CodEpisodio = @spvar_CodEpisodio
	end
else
	begin
		insert into Hclinica..Ecogrf
		(CodPaciente, CodEpisodio, NumSemana, FecExploracion, NumGest, NumPartos, NumCesareas, 
		 NumAbortEspont, AntecPrevios, factRiesgo, EGSemanas, EGDias, Estado, Peso, AnatomiaPatologica)
		values
		(@spvar_CodPaciente, @spvar_CodEpisodio, 1, GETDATE(), @spvar_NumGesta, @spvar_NumParto, 
		 @spvar_NumCesarea, @spvar_NumAborto, 0, 0, @spvar_EGSemanas, @spvar_EGDias, @spvar_Estado, @spvar_Peso, @spvar_AnatomiaPatologica)
	end

GO



--dbo.SpHClUPreoperatoria.sql

USE [Hclinica]
GO

/****** Object:  StoredProcedure [dbo].[SpHClUPreoperatoria]    Script Date: 07/26/2013 12:02:38 ******/
IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[SpHClUPreoperatoria]') AND type in (N'P', N'PC'))
DROP PROCEDURE [dbo].[SpHClUPreoperatoria]
GO

USE [Hclinica]
GO

/****** Object:  StoredProcedure [dbo].[SpHClUPreoperatoria]    Script Date: 07/26/2013 12:02:38 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

    


/*

	PROCEDIMIENTO		: SpHClUPreoperatoria
	FUNCION				: Realiza la actualizacion de hojas preoperatorias
	DEVUELVE			: 
	FECHA				: 09/02/2009
	VERSION				: 1.0
	AUTOR				: Sonia Mateo
	APLICACION			: Hojas preoperatorias
	MODIFICACIÓN		: 06/03/09 MPS - ampliar tipo campo @spvar_TipoAnestesia a char(2)
    MODIFICACION		: 08/04/2009 Ismael Sampere - nuevo campo Neoplasia
    MODIFICACION		: 19/06/2009 Joaquín Aniorte - Nuevo Campo ComplejidadPreop
    MODIFICACION		: 30/07/2009 Paco Aznar - Nuevo campo CentroDestino
    MODIFICACION		: 26/08/2009 Paco Aznar - Nuevo campo TipoCenRemite
    MODIFICACIÓN		: 02/09/2009 Joaquín Aniorte - Nueco campo IntervencionEspecial
    MODIFICACION		: 03/09/2009 Joaquín Aniorte - Nuevo campo UHD
    MODIFICACION		: 06/11/2009 Luis Merle - Nuevo campo TieneEquipo
    MODIFICACION		: 24/11/2009 Paco Aznar - Nuevo campo servicioDestino
	  MODIFICACION		: 02/02/2010 Joaquín Aniorte - Se intercambian el servicio y el servicio destino que pasa a llamarse ServicioOrigen (FLORENCECLI-1139) 
    MODIFICACION		: 03/02/2010 Joaquín Aniorte - Nuevos campos Ayudantes, Preparatoria y AlergiaLatex
    MODIFICACION		: 22/02/2010 Joaquín Aniorte - Nuevo campo TieneProtesis
    MODIFICACION		: 25/02/2010 Joaquín Aniorte - Campo cambiado (Preparatoria -> RequiereIngreso) y Nuevo Campo Infeccioso
    MODIFICACION		: 08/03/2010 Joaquín Aniorte - Ampliación de campo DescPreop a varchar 1000
    MODIFICACION		: 06/07/2010 Ramón Jiménez - Añado del campo DNISuspendida y FecModificacionPreop
						: 04/08/2010 Teresa L Fabuel - Nuevo campo Cirugia Ambulatoria Urgente 'CiruAUrgente'
						: 17/09/2010 Teresa L F S - Nuevo campo AvisoPlanificar. Nuevo campo fecha prevista de la intervencion 'FPrevistaIntervencion'.
						: 27/08/2012 Fran Cuenca  - Boton_firma_consentimiento_Hoja_Preop
						: 26/02/2013 Fran Cuenca - MAIPU CHC2672 -v 4.38 - Integracion SAP-SD	
-- MODIFICACION			: 10/07/2013 25412344N		- CHC2947 - REQ27104 - v4.40 - CREACIÓN DE COMBOBOX PREFERENTE MODULO QUIROFANO 									
-- MODIFICACION			: (04/09/2015) - v4.53r1 - SGN - 2500 - Plano y extremidad de intervenciones quirúrgicas	
-- MODIFICACION			: 14/10/2015 - v4.55 - CCM - 2525 - Solicitud de Pabellón incorporar Registro Re-intervención	
-- MODIFICACIÓN			: 06/09/2016 - v4.64 - 12771 - CCM - Repasar las tablas que tienen historificacion			
-- MODIFICACIÓN			: 17/10/2016 - v4.64r1 - 13674 - CCM - Repasar las tablas que tienen historificacion
-- MODIFICACION			: 15/05/2017 - v17.2 - 16142 - FCB - Solicitud de Pabellón - Registro de especialidad	
-- MODIFICACION			: 17/05/2017 - v17.2 - 16381 - LMF - Filtrado de secciones y exámenes por centro	
-- MODIFICACION         : 23/10/2017 - v17.3r1 - 16152 - MMM - Agregar estado de Diagnósticos en solicitud de pabellón								
*/ 

CREATE PROCEDURE [dbo].[SpHClUPreoperatoria]
	@spvar_CodIntervencion char(7),
	@spvar_CodPaciente char(16),
	@spvar_CodEpisodio char(5),
	@spvar_CodProc char(6),
	@spvar_TipoAnestesia char(2),
	@spvar_CodCIEPreop char(6),
	@spvar_CodProtocolo char(6),
	@spvar_DescProtocolo varchar(50),
	@spvar_RQuirurgico char(1),	
	@spvar_Region char(2),	
	@spvar_FPreoperatoria smalldatetime,
	@spvar_DNIMedicoPreop char(8),
	@spvar_DescPreop varchar(1000),
	@spvar_TecPrevistas varchar(100),
	@spvar_CSuspendida varchar(255),
	@spvar_Ambulatoria bit,
	@spvar_Tipo char(1),
	@spvar_PreopCompleto bit,
	@spvar_JClinico varchar(2000),
	@spvar_VistoBueno bit,	
	@spvar_Autotransfusion bit,
	@spvar_GSangre char(1),
	@spvar_RH char(1),
	@spvar_MedicoRemite varchar(47),	
	@spvar_CodMutua char(5),
	@spvar_Anestesista varchar(30),
	@spvar_FConsentInterv Smalldatetime, 
	@spvar_FConsentProtesis Smalldatetime,
	@spvar_CodCenRemite CHAR(5),
	@spvar_Preanestesia char(1), 	
	@spvar_NecesHemoderiv char(1)='N', 
	@spvar_UsuHemoderiv varchar(30)=Null, 
	@spvar_CodHistoria varchar(8) = Null,
	@spvar_Servicio char(4)=null,
	@spvar_CiruMenor bit,
	@spvar_Duracion int,
	@spvar_CodProtocolo2 char(6) = null,
	@spvar_DescProtocolo2 varchar(50) = null,
	@spvar_CodProtocolo3 char(6) = null,
	@spvar_DescProtocolo3 varchar(50) = null,	
	@spvar_CMA bit	= null,
	@spvar_intCodMotivoPreferente int = null,
	@spvar_Lateralidad int = null,
	@spvar_CodExamIntervencionismo char(7) = null ,
	@spvar_TasaMorbilidad float = null, 
	@spvar_TasaMortalidad float = null, 
	@spvar_CMAsinHDIA bit = NULL,
	@spvar_Complejidad char(2) = NULL,
	@spvar_RequiereUvi bit = 0,
	@spvar_Neoplasia bit = 0,
	@spvar_ComplejidadPreop int = NULL,
	@spvar_centroDestino char(5) = NULL,
	@spvar_TipoCenRemite int = NULL,
	@spvar_IntervencionEspecial bit = 0,
	@spvar_UHD bit = 0,
	@spvar_TieneEquipo bit = 0,
	@spvar_servDestino char(4) = NULL,
	@spvar_Ayudantes int = 0,
	@spvar_RequiereIngreso bit = 0,
	@spvar_AlergiaLatex bit = 0,
	@spvar_TieneProtesis bit = 0,
	@spvar_Infeccioso bit = 0,
	@spvar_DNISuspendida varchar(8)=null,
	@spvar_CiruAUrgente bit = 0,
	@spvar_AvisosPlanif varchar(max) = null,
	@spvar_FPrevIntervencion datetime = null,
	@spvar_PacFirmaConsen bit = 0
	,@spvar_Pagado bit=0
	,@spvar_IdPlano tinyint =NULL
	,@spvar_IdCuadrante tinyint =NULL
	,@spvar_EsReintervencion bit = 0
	,@spvar_DescReintervencion varchar(250) = null
	,@spvar_DNIUsuarioModifica varchar(8) = NULL
	,@spvar_CodEspecialidadUrg varchar(4) = null
	,@spvar_Estado int = null
	
AS

DECLARE @spvar_FSuspendida AS SMALLDATETIME,
		@FultimoPasivo as smalldatetime,
		@FActivo as smalldatetime,
		@EstadoRCLEInicial as char(3),
		@FecPrevista as smalldatetime,
		@FecTimeStamp as smalldatetime
		
	IF @spvar_DNIUsuarioModifica  is NULL
	BEGIN
		SET @spvar_DNIUsuarioModifica = ''
	END

IF RTRIM(@spvar_CSuspendida) <> '' and @spvar_CSuspendida is not null
	SELECT @spvar_FSuspendida = getdate(),
				 @FecTimeStamp = null
ELSE
	SELECT @spvar_FSuspendida = NULL,
				 @spvar_DNISuspendida = null,
				 @FecTimeStamp = GETDATE()

IF @spvar_Servicio is null
BEGIN
	SELECT @spvar_Servicio = (SELECT CodServicioMedico
							  FROM   Parametros..ParametrosMedicos
							  WHERE  DNIMedico = @spvar_DNIMedicoPreop)
END


-- (04/06/07) Sonia, obtiene la fecha de pasivo de la preoperatoria si la tiene
select	@FultimoPasivo = FultimoPasivo,
		@FActivo = FActivo
from	hclinica..preoperatoria
WHERE	CodIntervencion = @spvar_CodIntervencion     

	
	 if (SELECT CASE when Prp.FPasivo IS NULL Then 0 else 1 end as bPasivo  From HClinica..Preoperatoria as Prp WHERE CodIntervencion = @spvar_CodIntervencion ) = 0
	Begin
	
		INSERT INTO Historificacion..HClinica_Preoperatoria
				   (CodHojaPreop, CodIntervencion, CodPaciente, CodEpisodio, CodProc,
					CodProtocolo, TipoAnestesia, JClinico, CodCIEPreop, RQuirurgico,
					ProfAntibiotica, ProfOtros, ProfTromboembolica, Region, FPreoperatoria,
					DNIMedicoPreop, DescPreop, TecPrevistas, CSuspendida, FPrevista,
					Ambulatoria, Tipo, PreopCompleto, FIntervencion, Autotransfusion,
					VistoBueno, MedicoRemite, CodMutua, Anestesista, FConsentInterv,
					FConsentProtesis, CodCenRemite, Preanestesia, FPasivo, DiasLEspera,
					NecesHemoderiv, UsuHemoderiv, CodHistoria, Eliminado, Servicio,
					FechaFirma, FechaUltimaAct, DescProtocolo, CiruMenor, TiempoOper,
					CodProtocolo2, DescProtocolo2, CodProtocolo3, DescProtocolo3, cma, 
					MotivoPreferente, Estado, JornadaExtra, DniASQ, FEliminada, FSuspendida,
					TasaMorbilidad, TasaMortalidad, Lateralidad, ResaltaPlaning, CodExamInterven,
					TieneImagen, Factivo, FultimoPasivo, JornadaExtraVali, DniASQVali,
					ObservacionesPreoper, Confirmacion, EliminadoPlan, CMAsinHDIA,
					CodigoGRD, PesoGRD, Complejidad, RequiereUvi, EstadoRCLE, InfoPaciente,
					dniInfoPacMed, dniInfoPacEnf, dniInfoPacAnes, FInfoPaciente, ObsEnfermeria,
					Neoplasia, DniCirujanoPrevisto, AvisadoPac, ObservacionesAvisadoPac,
					DniAvisadoPac, CodAvisoPac, ComplejidadPreop, IntervencionEspecial,
					UHD, TieneEquipo, CentroDestino, TipoCenRemite, ServicioOrigen,
					Ayudantes, AlergiaLatex, RequiereIngreso, TieneProtesis, Infeccioso,
					Preparatoria, DNISuspendida, DNIEliminada, FecModificacionPreop,
					CiruAUrgente, DniAyudantePrevisto, AvisoPlanificar, FPrevistaIntervencion,
					NumListaRCLE, EsSincronizadoRCLE, PacFirmaConsen, NumSuspensiones,
					Observaciones, Pagado, CodMotivoPreferente, IdPlano, IdCuadrante,
					EsReIntervencion, DescReIntervencion, Validado, FCreacionHistorico, DNIUsuarioModifica
					,CodEspecialidadUrg )
			 SELECT Prp.CodHojaPreop, Prp.CodIntervencion, Prp.CodPaciente, Prp.CodEpisodio, Prp.CodProc,
					Prp.CodProtocolo, Prp.TipoAnestesia, Prp.JClinico, Prp.CodCIEPreop, Prp.RQuirurgico,
					Prp.ProfAntibiotica, Prp.ProfOtros, Prp.ProfTromboembolica, Prp.Region, Prp.FPreoperatoria,
					Prp.DNIMedicoPreop, Prp.DescPreop, Prp.TecPrevistas, Prp.CSuspendida, Prp.FPrevista,
					Prp.Ambulatoria, Prp.Tipo, Prp.PreopCompleto, Prp.FIntervencion, Prp.Autotransfusion,
					Prp.VistoBueno, Prp.MedicoRemite, Prp.CodMutua, Prp.Anestesista, Prp.FConsentInterv,
					Prp.FConsentProtesis, Prp.CodCenRemite, Prp.Preanestesia, Prp.FPasivo, Prp.DiasLEspera,
					Prp.NecesHemoderiv, Prp.UsuHemoderiv, Prp.CodHistoria, Prp.Eliminado, Prp.Servicio,
					Prp.FechaFirma, Prp.FechaUltimaAct, Prp.DescProtocolo, Prp.CiruMenor, Prp.TiempoOper,
					Prp.CodProtocolo2, Prp.DescProtocolo2, Prp.CodProtocolo3, Prp.DescProtocolo3, Prp.cma, 
					Prp.MotivoPreferente, Prp.Estado, Prp.JornadaExtra, Prp.DniASQ, Prp.FEliminada, Prp.FSuspendida,
					Prp.TasaMorbilidad, Prp.TasaMortalidad, Prp.Lateralidad, Prp.ResaltaPlaning, Prp.CodExamInterven,
					Prp.TieneImagen, Prp.Factivo, Prp.FultimoPasivo, Prp.JornadaExtraVali, Prp.DniASQVali,
					Prp.ObservacionesPreoper, Prp.Confirmacion, Prp.EliminadoPlan, Prp.CMAsinHDIA,
					Prp.CodigoGRD, Prp.PesoGRD, Prp.Complejidad, Prp.RequiereUvi, Prp.EstadoRCLE, Prp.InfoPaciente,
					Prp.dniInfoPacMed, Prp.dniInfoPacEnf, Prp.dniInfoPacAnes, Prp.FInfoPaciente, Prp.ObsEnfermeria,
					Prp.Neoplasia, Prp.DniCirujanoPrevisto, Prp.AvisadoPac, Prp.ObservacionesAvisadoPac,
					Prp.DniAvisadoPac, Prp.CodAvisoPac, Prp.ComplejidadPreop, Prp.IntervencionEspecial,
					Prp.UHD, Prp.TieneEquipo, Prp.CentroDestino, Prp.TipoCenRemite, Prp.ServicioOrigen,
					Prp.Ayudantes, Prp.AlergiaLatex, Prp.RequiereIngreso, Prp.TieneProtesis, Prp.Infeccioso,
					Prp.Preparatoria, Prp.DNISuspendida, Prp.DNIEliminada, Prp.FecModificacionPreop,
					Prp.CiruAUrgente, Prp.DniAyudantePrevisto, Prp.AvisoPlanificar, Prp.FPrevistaIntervencion,
					Prp.NumListaRCLE, Prp.EsSincronizadoRCLE, Prp.PacFirmaConsen, Prp.NumSuspensiones,
					Prp.Observaciones, Prp.Pagado, Prp.CodMotivoPreferente, Prp.IdPlano, Prp.IdCuadrante,
					Prp.EsReIntervencion, Prp.DescReIntervencion, Prp.Validado, GetDate(), @spvar_DNIUsuarioModifica 
					,Prp.CodEspecialidadUrg
			   FROM HClinica..Preoperatoria Prp
			   WHERE CodIntervencion = @spvar_CodIntervencion
		
		END


	UPDATE [HClinica].[dbo].[Preoperatoria]
	   SET 
		  [CodProc] = @spvar_CodProc,
		  [TipoAnestesia] = @spvar_TipoAnestesia,
		  [JClinico] = @spvar_JClinico,
		  [CodCIEPreop] = @spvar_CodCIEPreop,
		  [RQuirurgico] = @spvar_RQuirurgico,
		  [Region] = @spvar_Region,
		  [FPreoperatoria] = @spvar_FPreoperatoria,
		  [DNIMedicoPreop] = @spvar_DNIMedicoPreop,
		  [DescPreop] = @spvar_DescPreop,
		  [TecPrevistas] = @spvar_TecPrevistas,
		  [CSuspendida] = @spvar_CSuspendida,
		  [Ambulatoria] = @spvar_Ambulatoria,
		  [Tipo] = @spvar_Tipo,
		  [PreopCompleto] = @spvar_PreopCompleto,
		  [Autotransfusion] = @spvar_Autotransfusion,
		  [MedicoRemite] = @spvar_MedicoRemite,
		  [CodMutua] = @spvar_CodMutua,
		  [Anestesista] = @spvar_Anestesista,
		  [FConsentInterv] = @spvar_FConsentInterv,
		  [FConsentProtesis] = @spvar_FConsentProtesis,
		  [CodCenRemite] = @spvar_CodCenRemite,
		  [Preanestesia] = @spvar_Preanestesia,
		  [NecesHemoderiv] = @spvar_NecesHemoderiv,
		  [UsuHemoderiv] = @spvar_UsuHemoderiv,
		  [Servicio] = @spvar_servDestino,
		  [FechaUltimaAct] = getdate(),
		  [CodProtocolo] = @spvar_CodProtocolo,
		  [DescProtocolo] = @spvar_DescProtocolo,
		  [CiruMenor] = @spvar_CiruMenor,
		  [TiempoOper] = @spvar_Duracion,
		  [CodProtocolo2] = @spvar_CodProtocolo2,
		  [DescProtocolo2] = @spvar_DescProtocolo2,
		  [CodProtocolo3] = @spvar_CodProtocolo3,
		  [DescProtocolo3] = @spvar_DescProtocolo3,
		  [cma] = @spvar_CMA,	  
		  [CodMotivoPreferente] = @spvar_intCodMotivoPreferente,  
		  [FSuspendida] = @spvar_FSuspendida,
		  [Lateralidad] = @spvar_Lateralidad,
		  [CodExamInterven] = @spvar_CodExamIntervencionismo,
		  [TasaMorbilidad] = @spvar_TasaMorbilidad,
		  [TasaMortalidad] = @spvar_TasaMortalidad,
		  [FultimoPasivo] = @FultimoPasivo,
		  [FActivo] = @FActivo,
		  [CMAsinHDIA] = @spvar_CMAsinHDIA,
		  [Complejidad] = @spvar_Complejidad,
		  [RequiereUvi] = @spvar_RequiereUvi,
		  [Neoplasia] = @spvar_Neoplasia,
		  [ComplejidadPreop] = @spvar_ComplejidadPreop,
		  [centroDestino] = @spvar_centroDestino,
		  [TipoCenRemite] = @spvar_TipoCenRemite,
		  [IntervencionEspecial] = @spvar_IntervencionEspecial,
		  [UHD] = @spvar_UHD,
		  [TieneEquipo] = @spvar_TieneEquipo,
		  [ServicioOrigen] = @spvar_Servicio,
		  [Ayudantes] = @spvar_Ayudantes,
		  [RequiereIngreso] = @spvar_RequiereIngreso,
		  [AlergiaLatex] = @spvar_AlergiaLatex,
		  [TieneProtesis] =  @spvar_TieneProtesis,
		  [Infeccioso] = @spvar_Infeccioso,
		  [DNISuspendida] = @spvar_DNISuspendida,
		  [FecModificacionPreop] = @FecTimeStamp,
		  CiruAUrgente = @spvar_CiruAUrgente,
		  AvisoPlanificar = @spvar_AvisosPlanif,
		  FPrevistaIntervencion = @spvar_FPrevIntervencion,
		  PacFirmaConsen=	@spvar_PacFirmaConsen 
		  ,Pagado= @spvar_Pagado
		  ,IdPlano = @spvar_IdPlano
		  ,IdCuadrante = @spvar_IdCuadrante
		  ,EsReintervencion = @spvar_EsReintervencion 
		  ,Descreintervencion = @spvar_DescReintervencion 
		  ,CodEspecialidadUrg = @spvar_CodEspecialidadUrg
		  ,Estado = @spvar_Estado

	where	codintervencion = @spvar_codintervencion
	


IF EXISTS(	SELECT	* 
			FROM	HClinica..LTiemposEspera
			WHERE	CodPaciente=@spvar_CodPaciente AND 
					CodEpisodio=@spvar_CodEpisodio AND 
					FechaPasivo Is Not Null AND 
					CodIntervencion = @spvar_CodIntervencion)
BEGIN


    UPDATE Preoperatoria
    SET    Preoperatoria.FPasivo = LE.FechaPasivo
    FROM   Preoperatoria, HClinica..LTiemposEspera LE
    WHERE  Preoperatoria.CodIntervencion = @spvar_CodIntervencion
		   AND Preoperatoria.CodPaciente=@spvar_CodPaciente
		   AND Preoperatoria.CodEpisodio=@spvar_CodEpisodio
		   AND Preoperatoria.FPreoperatoria=@spvar_FPreoperatoria
		   AND Preoperatoria.CodProc=@spvar_CodProc
		   AND LE.CodPaciente= Preoperatoria.CodPaciente
		   AND LE.CodEpisodio= Preoperatoria.CodEpisodio
		   AND LE.FechaPasivo Is Not Null


	UPDATE InformeQuirurgico
	SET    FSolicitud = @spvar_FPreoperatoria
	WHERE  InformeQuirurgico.CodPaciente = @spvar_CodPaciente 
		   AND InformeQuirurgico.CodEpisodio = @spvar_CodEpisodio


	UPDATE Ingresos..EpisodioHospitalizacion
	SET    TipoIntervSolic = @spvar_Tipo
	WHERE  CodPaciente = @spvar_CodPaciente
		   AND CodEpisodio = @spvar_CodEpisodio


END


UPDATE PrecedenteNoAnomalo
SET    GrupoSanguineo=@spvar_GSangre,RH=@spvar_RH
WHERE  CodPaciente=@spvar_CodPaciente

IF @@RowCount=0
 INSERT PrecedenteNoAnomalo(
						    CodPaciente,
							GrupoSanguineo,
							RH,
							Gordura,
							VidaSedentaria,
							Cansancio)
 VALUES(@spvar_CodPaciente,
		@spvar_GSangre,
		@spvar_RH,
		0,	
		0,
		0)


UPDATE Ingresos..EpisodioHospitalizacion
SET    TipoIntervSolic=@spvar_Tipo
FROM   Preoperatoria
WHERE  Ingresos..EpisodioHospitalizacion.CodPaciente = @spvar_CodPaciente
       AND Ingresos..EpisodioHospitalizacion.CodEpisodio = @spvar_CodEpisodio

GO



GO



--dbo.SpIngIQuiNuevo.sql

USE [Ingresos]
GO
/****** Object:  StoredProcedure [dbo].[SpIngIQuiNuevo]    Script Date: 03/08/2017 9:39:49 ******/
IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[SpIngIQuiNuevo]') AND type in (N'P', N'PC'))
DROP PROCEDURE [dbo].[SpIngIQuiNuevo]
GO

USE [Ingresos]
GO

SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


--	PROCEDIMIENTO		: 	SpIngIQuiNuevo
--	FUNCION             : 	Inserta un nuevo informe quirÃºrgico
--	DEVUELVE            : 
--	FECHA               : 	21/12/2005
--	VERSION             : 	1.0
--	AUTOR               : 	Gerardo Prieto David (MECEMSA Consultores)
--  MODIFICACION		:   MPS 31/05/07 aÃ±adir parametros para possum
--							Jorge Poveda SÃ¡ez 10/12/2007 AÃ±ado dos campos CodExamInterven 1 y 2
--							Ismael 14/12/2007 AÃ±adido el parametro ActualizaIngreso para actualizar la fecha de
--							hospitalizacion con respecto a la de inicio de la intervencion
--							Ismael 18/12/2007 valor por defecto a los parametros por compatibilidad
--							Oscar 19/08/2008 se guarda la informaciÃ³n del paciente para kiosko
--							Pablo GonzÃ¡lez 31/12/2008 aumentado tamaÃ±o descOperatoria
--							Ismael 27/01/2009 Actualizacion de estados de la preoperatoria para RCLE
--							Pablo GonzÃ¡lez 10/03/2009 InfoPaciente en preoperatoria
--							Teresa L F 29/05/2009 Se actualiza el tiempo teorico de la estancia segÃºn el procedimiento realizado menos episodios de UHD o UCSI.
--							CTF - 73569626D - CHC3335_ModificaciÃ³n Campo Analista en InfQuirurgico
--	APLICACIÃ“N ORIGEN   : 	Informe quirÃºrgico
--  MODIFICACIÃ“N		: (04/09/2015) - v4.53r1 - SGN - 2500 - Plano y extremidad de intervenciones quirÃºrgicas
--	MODIFICACIÃ“N		: 05/09/2016 - v4.64 - 12771 - CCM - Repasar las tablas que tienen historificacion
--  MODIFICACIÃ“N : 18/10/2016 - v4.64r1 - 13674 - CCM - Repasar las tablas que tienen historificacion
--  MODIFICACION: 15/05/2017 - v17.2 - 16142 - FCB - Solicitud de PabellÃ³n - Registro de especialidad
--  MODIFICACION: 02/08/2017 v17.3 - 16153 - MPR - Registro Quirurgico - Incorporar registro de Turno
--  MODIFICACIÃ“N: 23/10/2017 - v17.3r1 - MMM - 16152 - Agregar estado de DiagnÃ³sticos en solicitud de pabellÃ³n

CREATE Procedure [dbo].[SpIngIQuiNuevo]
	
	@spvar_CodInforme Varchar(7) = NULL,
	@spvar_CodIntervencion Varchar(7),
	@spvar_CodPaciente Char(16), 
	@spvar_CodEpisodio Char(5), 
	@spvar_FSolicitud Smalldatetime, 
	@spvar_CodCirujano Char(8), 
	@spvar_CodInstrumentista Char(8), 
	@spvar_CodAyuda1 Char(8),
	@spvar_CodAyuda2 Char(8), 
	@spvar_CodAyuda3 Char(8), 
	@spvar_CodMedInforma Char(8), 
	@spvar_CodQuirofano Char(2),
	@spvar_Posicion Char(2), 
	@spvar_CodVia Char(2), 
	@spvar_CodProcedimiento Char(6), 
	@spvar_CodCIE Char(6), 
	@spvar_CodAntibiotico int,
	@spvar_TipoIntervencion Char(1), 
	@spvar_Destino Char(1), 
	@spvar_Drenaje Bit, 
	@spvar_TecnicaEmpleada Varchar(100),
	@spvar_TecnicaCierre Varchar(100), 
	@spvar_Pieza Varchar(40), 
	@spvar_HoraInicio Smalldatetime, 
	@spvar_HoraFin Smalldatetime,
	@spvar_FInforme Smalldatetime, 
	@spvar_CodMutua Char(5), 
	@spvar_Facturable Bit = 0,
	@spvar_CantidadProcesos Tinyint = 1,
	@spvar_DescOperatoria varchar(max),
	@spvar_SolBiopsia char(10),
	@spvar_SolLaboratorio char(10),
	@spvar_SolCitologias char(10),
	@spvar_SolHormonales bit,
	@spvar_SolRadiologia char(10),
	@spvar_SolPostmortem bit,
	@spvar_Firmado bit = 0,
	@spvar_NumCordales char(2) = null,
	@spvar_CodExamInterv char(7) = null,         
	@spvar_CodExamInterv1 char(7) = null,
	@spvar_CodExamInterv2 char(7) = null,
	@spvar_TasaMorbilidad float = null,  -- mps 
	@spvar_TasaMortalidad float = null,   -- mps 
	@spvar_ActualizaIngreso as bit = '0',
	@spvar_InfoPaciente as varchar(4000) = null
	,@spvar_NombreAnestesista as varchar(70)=null
	,@spvar_CodCentro as varchar(5)
	,@spvar_IdPlano tinyint =NULL
	,@spvar_IdCuadrante tinyint =NULL
	,@spvar_DNIUsuarioModifica varchar(8) = NULL
	,@spvar_idTurnoInfQuirurgico int
	,@spvar_Estado int = NULL
	
As
	if @spvar_DNIUsuarioModifica  is NULL
	BEGIN
		SET @spvar_DNIUsuarioModifica = ''
	END

	Exec SpIngSQuiSusp @spvar_CodIntervencion

	If @@RowCount = 0

		Begin
		
			If (Select CodPaciente From HClinica..Preoperatoria Where CodIntervencion = @spvar_CodIntervencion) Is Null
			
				--	Se borrÃ³ desde otro sitio la hoja de preoperatorio.
				Select 2

			Else

				Begin
		
					-- mps guardar los datos del possum 
					if exists(select * from hclinica..preoperatoria
								where CodIntervencion = @spvar_CodIntervencion)
					begin
					
						INSERT INTO Historificacion..HClinica_Preoperatoria
						   (CodHojaPreop, CodIntervencion, CodPaciente, CodEpisodio, CodProc,
							CodProtocolo, TipoAnestesia, JClinico, CodCIEPreop, RQuirurgico,
							ProfAntibiotica, ProfOtros, ProfTromboembolica, Region, FPreoperatoria,
							DNIMedicoPreop, DescPreop, TecPrevistas, CSuspendida, FPrevista,
							Ambulatoria, Tipo, PreopCompleto, FIntervencion, Autotransfusion,
							VistoBueno, MedicoRemite, CodMutua, Anestesista, FConsentInterv,
							FConsentProtesis, CodCenRemite, Preanestesia, FPasivo, DiasLEspera,
							NecesHemoderiv, UsuHemoderiv, CodHistoria, Eliminado, Servicio,
							FechaFirma, FechaUltimaAct, DescProtocolo, CiruMenor, TiempoOper,
							CodProtocolo2, DescProtocolo2, CodProtocolo3, DescProtocolo3, cma, 
							MotivoPreferente, Estado, JornadaExtra, DniASQ, FEliminada, FSuspendida,
							TasaMorbilidad, TasaMortalidad, Lateralidad, ResaltaPlaning, CodExamInterven,
							TieneImagen, Factivo, FultimoPasivo, JornadaExtraVali, DniASQVali,
							ObservacionesPreoper, Confirmacion, EliminadoPlan, CMAsinHDIA,
							CodigoGRD, PesoGRD, Complejidad, RequiereUvi, EstadoRCLE, InfoPaciente,
							dniInfoPacMed, dniInfoPacEnf, dniInfoPacAnes, FInfoPaciente, ObsEnfermeria,
							Neoplasia, DniCirujanoPrevisto, AvisadoPac, ObservacionesAvisadoPac,
							DniAvisadoPac, CodAvisoPac, ComplejidadPreop, IntervencionEspecial,
							UHD, TieneEquipo, CentroDestino, TipoCenRemite, ServicioOrigen,
							Ayudantes, AlergiaLatex, RequiereIngreso, TieneProtesis, Infeccioso,
							Preparatoria, DNISuspendida, DNIEliminada, FecModificacionPreop,
							CiruAUrgente, DniAyudantePrevisto, AvisoPlanificar, FPrevistaIntervencion,
							NumListaRCLE, EsSincronizadoRCLE, PacFirmaConsen, NumSuspensiones,
							Observaciones, Pagado, CodMotivoPreferente, IdPlano, IdCuadrante,
							EsReIntervencion, DescReIntervencion, Validado, FCreacionHistorico, DNIUsuarioModifica 
							,CodEspecialidadUrg )
					 SELECT Prp.CodHojaPreop, Prp.CodIntervencion, Prp.CodPaciente, Prp.CodEpisodio, Prp.CodProc,
							Prp.CodProtocolo, Prp.TipoAnestesia, Prp.JClinico, Prp.CodCIEPreop, Prp.RQuirurgico,
							Prp.ProfAntibiotica, Prp.ProfOtros, Prp.ProfTromboembolica, Prp.Region, Prp.FPreoperatoria,
							Prp.DNIMedicoPreop, Prp.DescPreop, Prp.TecPrevistas, Prp.CSuspendida, Prp.FPrevista,
							Prp.Ambulatoria, Prp.Tipo, Prp.PreopCompleto, Prp.FIntervencion, Prp.Autotransfusion,
							Prp.VistoBueno, Prp.MedicoRemite, Prp.CodMutua, Prp.Anestesista, Prp.FConsentInterv,
							Prp.FConsentProtesis, Prp.CodCenRemite, Prp.Preanestesia, Prp.FPasivo, Prp.DiasLEspera,
							Prp.NecesHemoderiv, Prp.UsuHemoderiv, Prp.CodHistoria, Prp.Eliminado, Prp.Servicio,
							Prp.FechaFirma, Prp.FechaUltimaAct, Prp.DescProtocolo, Prp.CiruMenor, Prp.TiempoOper,
							Prp.CodProtocolo2, Prp.DescProtocolo2, Prp.CodProtocolo3, Prp.DescProtocolo3, Prp.cma, 
							Prp.MotivoPreferente, Prp.Estado, Prp.JornadaExtra, Prp.DniASQ, Prp.FEliminada, Prp.FSuspendida,
							Prp.TasaMorbilidad, Prp.TasaMortalidad, Prp.Lateralidad, Prp.ResaltaPlaning, Prp.CodExamInterven,
							Prp.TieneImagen, Prp.Factivo, Prp.FultimoPasivo, Prp.JornadaExtraVali, Prp.DniASQVali,
							Prp.ObservacionesPreoper, Prp.Confirmacion, Prp.EliminadoPlan, Prp.CMAsinHDIA,
							Prp.CodigoGRD, Prp.PesoGRD, Prp.Complejidad, Prp.RequiereUvi, Prp.EstadoRCLE, Prp.InfoPaciente,
							Prp.dniInfoPacMed, Prp.dniInfoPacEnf, Prp.dniInfoPacAnes, Prp.FInfoPaciente, Prp.ObsEnfermeria,
							Prp.Neoplasia, Prp.DniCirujanoPrevisto, Prp.AvisadoPac, Prp.ObservacionesAvisadoPac,
							Prp.DniAvisadoPac, Prp.CodAvisoPac, Prp.ComplejidadPreop, Prp.IntervencionEspecial,
							Prp.UHD, Prp.TieneEquipo, Prp.CentroDestino, Prp.TipoCenRemite, Prp.ServicioOrigen,
							Prp.Ayudantes, Prp.AlergiaLatex, Prp.RequiereIngreso, Prp.TieneProtesis, Prp.Infeccioso,
							Prp.Preparatoria, Prp.DNISuspendida, Prp.DNIEliminada, Prp.FecModificacionPreop,
							Prp.CiruAUrgente, Prp.DniAyudantePrevisto, Prp.AvisoPlanificar, Prp.FPrevistaIntervencion,
							Prp.NumListaRCLE, Prp.EsSincronizadoRCLE, Prp.PacFirmaConsen, Prp.NumSuspensiones,
							Prp.Observaciones, Prp.Pagado, Prp.CodMotivoPreferente, Prp.IdPlano, Prp.IdCuadrante,
							Prp.EsReIntervencion, Prp.DescReIntervencion, Prp.Validado, GetDate(), @spvar_DNIUsuarioModifica 
							,Prp.CodEspecialidadUrg
					   FROM HClinica..Preoperatoria Prp
					   WHERE CodIntervencion = @spvar_CodIntervencion
										
						update hclinica..preoperatoria
						set TasaMorbilidad = @spvar_TasaMorbilidad,
							TasaMortalidad = @spvar_TasaMortalidad
						where CodIntervencion = @spvar_CodIntervencion
					end

					--Ismael(27/01/2009) Actualizacion de estados de la preoperatoria para RCLE
					if @spvar_Firmado = '1'
					begin
						declare @Tipo as char(1)
						
						select @Tipo = Tipo 
						from hclinica..preoperatoria
						where CodIntervencion = @spvar_CodIntervencion
					
						if @Tipo = parametros.dbo.fnParValorConstante('m_strCodTipoUrgente')
						begin							
							update hclinica..preoperatoria
							set EstadoRCLE = parametros.dbo.fnParValorConstante('m_strEstadoRCLEFirmaU')
							where CodIntervencion = @spvar_CodIntervencion							
						end
						else
						begin
						
							update hclinica..preoperatoria
							set EstadoRCLE = parametros.dbo.fnParValorConstante('m_strEstadoRCLEFirmaPP')
							where CodIntervencion = @spvar_CodIntervencion
						end
 					end

					--	Si no se facilita el cÃ³digo de informe (informe nuevo), se genera un cÃ³digo nuevo.
					If @spvar_CodInforme Is Null

						Begin

							--	Obtener el nuevo cÃ³digo de informe.
							Declare @Numero Varchar(5)
							Declare @Anyo Varchar(2)

							Select @Anyo = substring(convert(varchar(4),datepart(yy,getdate())),3,2)

							Select 
								@Numero =convert(varchar(5), IsNull(Max(convert(int,SubString(CodInforme,3,5)))+1,1))
							From 
								HClinica..InformeQuirurgico		
							Where
								CodInforme Like @Anyo + '%'

							Select @spvar_CodInforme = convert(varchar(7), @Anyo + stuff('00000', 6-DataLength(@Numero), DataLength(@Numero), @Numero))	

						End								

					--	Borrado de cualquier informe previo.
					Delete From HClinica..InformeQuirurgico
					Where 
						CodIntervencion = @spvar_CodIntervencion

					-- Para asegurarnos de que no inserta un Codigo de Mutua null
					If @spvar_CodMutua is null
					begin
						Select @spvar_CodMutua = CodMutua
						From HClinica..Preoperatoria
						Where CodIntervencion = @spvar_CodIntervencion
					end

					-- Para asegurarnos de que no inserta un Codigo de Procedimiento null
					If @spvar_CodProcedimiento is null
					begin
						Select @spvar_CodProcedimiento = CodProc
						From HClinica..Preoperatoria
						Where CodIntervencion = @spvar_CodIntervencion
					end
					
					--CTF - 73569626D - CHC3335_ModificaciÃ³n Campo Analista en InfQuirurgico - INI
					IF (SELECT ValorConstante FROM Parametros..constantes WHERE NombreConstante = 'm_bolAnestesiologia' and CentroRef=@spvar_CodCentro)=1 
						BEGIN
							Select @spvar_NombreAnestesista = null
						END
					--CTF - 73569626D - CHC3335_ModificaciÃ³n Campo Analista en InfQuirurgico - FIN
					

					--	InserciÃ³n de los datos en la tabla.
					Insert HClinica..InformeQuirurgico (
						CodIntervencion,
						CodInforme,
						CodPaciente, 
						CodEpisodio, 
						FSolicitud, 
                        CodCirujano,
						CodInstrumentista,
                        CodAyudante1, 
						CodAyudante2, 
						CodAyudante3, 
                        CodMedInforma, 
						CodQuirofano, 
						PosicionInter,
                        CodVia, 
						CodProcedimiento, 
						CodPostCIE,
                        CodAntibioticos, 
						TipoInter, 
						DestinoInter,
						Drenaje, 
						TecnicasEmpleadas, 
                        TecnicaCierre, 
						PiezaExtirpada, 
						HInicioInter,
                        HFinInter, 
						FInforme,
						CodMutua, 
						Facturable,
                        CantidadProcesos,
						DescOperatoria,
						SolBiopsia,
						SolLaboratorio,
						SolCitologias,
						SolHormonales,
						SolRadiologia,
						SolPostmortem,
						Firmado,
						NumCordales,
						CodExamInterven,
						CodExamInterven1,
						CodExamInterven2
						--InfoPaciente
						--CTF - 73569626D - CHC3335_ModificaciÃ³n Campo Analista en InfQuirurgico 
						,NombreAnestesista
						--(04/09/2015) - v4.53r1 - SGN - 2500 - Plano y extremidad de intervenciones quirÃºrgicas - INI
					    ,IdPlano 
					    ,IdCuadrante 
					    --(04/09/2015) - v4.53r1 - SGN - 2500 - Plano y extremidad de intervenciones quirÃºrgicas - FIN
						,IdTurnoInfQuirurgico 
						,Estado
						
					)  
                   	Values (
						@spvar_CodIntervencion,
						@spvar_CodInforme,
						@spvar_CodPaciente, 
						@spvar_CodEpisodio, 
						@spvar_FSolicitud, 
						@spvar_CodCirujano, 
						@spvar_CodInstrumentista, 
                        @spvar_CodAyuda1, 
						@spvar_CodAyuda2, 
						@spvar_CodAyuda3, 
						@spvar_CodMedInforma, 
                        @spvar_CodQuirofano, 
						@spvar_Posicion, 
						@spvar_CodVia, 
						@spvar_CodProcedimiento, 
						@spvar_CodCIE, 	
						@spvar_CodAntibiotico,
                        @spvar_TipoIntervencion, 
						@spvar_Destino, 
						@spvar_Drenaje, 
						@spvar_TecnicaEmpleada, 
						@spvar_TecnicaCierre, 
                        @spvar_Pieza, 
						@spvar_HoraInicio, 
						@spvar_HoraFin, 
						@spvar_FInforme,
						@spvar_CodMutua, 
						@spvar_Facturable,
                        @spvar_CantidadProcesos,
						@spvar_DescOperatoria,
						@spvar_SolBiopsia,
						@spvar_SolLaboratorio,
						@spvar_SolCitologias,
						@spvar_SolHormonales,
						@spvar_SolRadiologia,
						@spvar_SolPostmortem,
						@spvar_Firmado,
						@spvar_NumCordales,
					    @spvar_CodExamInterv,
						@spvar_CodExamInterv1,
						@spvar_CodExamInterv2
						--@spvar_InfoPaciente
						--CTF - 73569626D - CHC3335_ModificaciÃ³n Campo Analista en InfQuirurgico 
						,@spvar_NombreAnestesista
						--(04/09/2015) - v4.53r1 - SGN - 2500 - Plano y extremidad de intervenciones quirÃºrgicas - INI
						,@spvar_IdPlano
						,@spvar_IdCuadrante
						--(04/09/2015) - v4.53r1 - SGN - 2500 - Plano y extremidad de intervenciones quirÃºrgicas - FIN
						,@spvar_idTurnoInfQuirurgico
						,@spvar_Estado
					
					)

					--	Actualizar la fecha de la intervenciÃ³n en la hoja preoperatoria.
							
					Update 
						HClinica..Preoperatoria
					Set 
						FIntervencion = @spvar_HoraInicio
					Where 
						CodIntervencion = @spvar_CodIntervencion

					-- Actualizamos la fecha de ingreso si es posterior al inicio de la intervencion
					if @spvar_ActualizaIngreso = '1'
					begin
						declare @FechaMinHospi as smalldatetime 						

						select @FechaMinHospi = min(fechahospitalizacion) from ingresos..episodiohospitalizacion 
						where codingreso = (select codingreso from ingresos..episodiohospitalizacion 
												where CodPaciente = @spvar_CodPaciente 
													  and CodEpisodio = @spvar_CodEpisodio)

						update ingresos..episodiohospitalizacion
						set FechaHospitalizacion = @spvar_HoraInicio
						where CodPaciente = @spvar_CodPaciente --and CodEpisodio = @spvar_CodEpisodio
							  and FechaHospitalizacion = @FechaMinHospi
							  
					end
					
					-- Se actualiza el tiempo teorico de la estancia segÃºn el procedimiento realizado
					if @spvar_Firmado = '1'
					Begin
						Update Ingresos..EpisodioHospitalizacion
						set estanciaTeorica = PO.EstanciaTeorica
						from Ingresos..EpisodioHospitalizacion EH, parametros..Procedimientos PO,
						parametros..DatosCamas DC, parametros..CodigoPlantas CP
						where EH.CodPaciente = @spvar_CodPaciente
						and EH.CodEpisodio = @spvar_CodEpisodio
						and PO.CodDiagnostico = @spvar_CodProcedimiento
						and replace(EH.numcama,'*','') = replace(DC.numcama,'*','') 
						and DC.CodPlanta = CP.CodPla
						and CP.EsUcsi = 0
						and CP.EsUHD = 0					
					End
					
					Select 0

				End

		End

	Else

		Select 1



GO



--dbo.SpIngSInfQuirurImpresion.sql

USE [Ingresos]
GO

/****** Object:  StoredProcedure [dbo].[SpIngSInfQuirurImpresion]    Script Date: 12/13/2013 09:31:28 ******/
IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[SpIngSInfQuirurImpresion]') AND type in (N'P', N'PC'))
DROP PROCEDURE [dbo].[SpIngSInfQuirurImpresion]
GO

USE [Ingresos]
GO

/****** Object:  StoredProcedure [dbo].[SpIngSInfQuirurImpresion]    Script Date: 12/13/2013 09:31:28 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO




--    PROCEDIMIENTO           :     SpIngSInfQuirurImpresion
--    FUNCION             :   Obtiene los datos de impresión para el nuevo documento de Informe Quirúrgico
--                                       "rptInfQuirurgico.rpt" de tipo de episodio Urgencias o de episodio de Hospitalización
--    FECHA               :   27/12/2012
--    VERSION             :   SIDRA 4.35 Release 1 CHC2414
--    AUTOR               :   Miguel Ángel Sánchez
--    APLICACIÓN ORIGEN   :   Informe quirurgico
--  Modificación          :   04/01/2013 - MAS - CHC2414 v4.35 Release 1 - No mostraba los nombres de los 3 ayudantes
--  Modificación		  : 21/05/2013 - CTF - CHC3040_Validar PA SpIngSInfQuirurImpresion - Se comprueban los cambios en los dos campos OpeReal y OpePro
--  Modificación		  :	06/06/2013 - CTF - 73569626 - v4.39 - HC3096_REQ29954_MODIFICACIÓN PROTOCOLO OPERATORIO
--  MODIFICACION		  : 10/07/2013 25412344N - CHC2947 - REQ27104 - v4.40 - CREACIÓN DE COMBOBOX PREFERENTE MODULO QUIROFANO
--  MODIFICACION		  : 13/12/2013 - CTF - 73569626D - CHC3335_Modificación Campo Analista en InfQuirurgico 		
--  MODIFICACIÓN          : 23/10/2017 - v17.3r1 - MMM - 16152 - Agregar estado de Diagnósticos en solicitud de pabellón								
--*******************************************************************


CREATE Proc [dbo].[SpIngSInfQuirurImpresion]
      @spvar_CodIntervencion varchar(7),
      @spvar_CodHojaPreop varchar(7)
As
      --    Declaración de variables
      Declare @spvar_DNICir Char(8)
      Declare @spvar_DNIAnes Char(8)
      Declare @spvar_DNIEnf Char(8)
      Declare @spvar_DNI1 Char(8)
      Declare @spvar_DNI2 Char(8)
      Declare @spvar_DNI3 Char(8)
      Declare @spvar_Cir VarChar(45)
      Declare @spvar_Anes Varchar(45)
      Declare @spvar_Enf Varchar(45)
      Declare @spvar_Ayu1 Varchar(45)
      Declare @spvar_Ayu2 Varchar(45)
      Declare @spvar_Ayu3 Varchar(45)
      Declare @spvar_DiagPre char(256)
	  Declare @spvar_DiagPreSecun char (256)
	  Declare @spvar_EstadoPreopPrin int
      Declare @spvar_OpePro varchar(256)
      --CTF - CHC3040_Validar PA SpIngSInfQuirurImpresion 
      Declare @spvar_OpeReal varchar(256) 
	  --CTF - 73569626D - CHC3335_Modificación Campo Analista en InfQuirurgico
	  Declare @spvar_UnidadAnestesia bit 

      --  Valor de variables
      Select @spvar_DNICir = ''
      Select @spvar_DNIAnes = ''
      Select @spvar_DNIEnf = ''
      Select @spvar_DNI1 = ''
      Select @spvar_DNI2 = ''
      Select @spvar_DNI3 = ''

      --------------------------------------------------------------------------------
      --  OBTENCION DE DNIs
      --------------------------------------------------------------------------------
      --    Obtencin del DNI del cirujano, del instrumentista y de los ayudantes.  
      Select 
            @spvar_DNICir = CodCirujano,
            @spvar_DNIEnf = CodInstrumentista,
            @spvar_DNI1 = CodAyudante1,
            @spvar_DNI2 = CodAyudante2,
            @spvar_DNI3 = CodAyudante3
      From 
            HClinica..InformeQuirurgico
      Where 
            CodIntervencion = @spvar_CodIntervencion

      --    Obtencin del DNI del anestesista.
      Select 
            @spvar_DNIAnes = DNIAnestesista
      From 
            HClinica..InformeAnestesico
      Where 
            CodIntervencion = @spvar_CodIntervencion

      ------------------------------------------------------------------------------------
      --  OBTENCION DE NOMBRES
      ------------------------------------------------------------------------------------
      --    Obtencin del nombre del cirujano.
      Select 
            @spvar_Cir = Rtrim(parametros..ParametrosMedicos.NomMedico)+' '+RTrim(parametros..ParametrosMedicos.Apell1)+' '+RTrim(parametros..ParametrosMedicos.Apell2)
      From 
            Parametros..ParametrosMedicos
      Where 
            DNIMedico = @spvar_DNICir
            
      --    Obtencin del nombre del anestesista.
      --CTF - 73569626D - CHC3335_Modificación Campo Analista en InfQuirurgico - INI
      Select 
            @spvar_UnidadAnestesia = ValorConstante
      From 
            Parametros..Constantes
      Where 
            NombreConstante like 'm_bolAnestesiologia'
      
      IF @spvar_UnidadAnestesia=0
		  Select 
				@spvar_Anes = NombreAnestesista
		  From 
				HClinica..InformeQuirurgico
		  Where 
				CodIntervencion = @spvar_CodIntervencion
      ELSE
	  --CTF - 73569626D - CHC3335_Modificación Campo Analista en InfQuirurgico - FIN
		  Select 
				@spvar_Anes = Rtrim(parametros..ParametrosMedicos.NomMedico)+' '+RTrim(parametros..ParametrosMedicos.Apell1)+' '+RTrim(parametros..ParametrosMedicos.Apell2)
		  From 
				Parametros..ParametrosMedicos
		  Where 
				DNIMedico = @spvar_DNIAnes

      --    Obtencin del nombre del instrumentista.
      Select 
            @spvar_Enf = Rtrim(parametros..DatosEnfermeras.NombreEnf)+' '+RTrim(parametros..DatosEnfermeras.Apell1Enf)+' '+RTrim(parametros..DatosEnfermeras.Apell2Enf)
      From 
            Parametros..DatosEnfermeras
      Where 
            DNIEnf = @spvar_DNIEnf

      -- 04/01/2013 - MAS - CHC2414 v4.35 Release 1 - No mostraba los nombres de los 3 ayudantes - INI
      --    Obtencin del nombre del primer ayudante.
      --Select 
      --    @spvar_Ayu1 = Rtrim(parametros..DatosEnfermeras.NombreEnf)+' '+RTrim(parametros..DatosEnfermeras.Apell1Enf)+' '+RTrim(parametros..DatosEnfermeras.Apell2Enf)
      --From 
      --    Parametros..DatosEnfermeras
      --Where 
      --    DNIEnf = @spvar_DNI1
      Select 
            @spvar_Ayu1 = Rtrim(parametros..ParametrosMedicos.NomMedico)+' '+RTrim(parametros..ParametrosMedicos.Apell1)+' '+RTrim(parametros..ParametrosMedicos.Apell2)
      From 
            Parametros..ParametrosMedicos
      Where 
            DNIMedico = @spvar_DNI1

      --    Obtencin del nombre del segundo ayudante.
      --Select 
      --    @spvar_Ayu2 = Rtrim(parametros..DatosEnfermeras.NombreEnf)+' '+RTrim(parametros..DatosEnfermeras.Apell1Enf)+' '+RTrim(parametros..DatosEnfermeras.Apell2Enf)
      --From 
      --    Parametros..DatosEnfermeras
      --Where 
      --    DNIEnf = @spvar_DNI2
      Select 
            @spvar_Ayu2 = Rtrim(parametros..ParametrosMedicos.NomMedico)+' '+RTrim(parametros..ParametrosMedicos.Apell1)+' '+RTrim(parametros..ParametrosMedicos.Apell2)
      From 
            Parametros..ParametrosMedicos
      Where 
            DNIMedico = @spvar_DNI2

      --    Obtencin del nombre del tercer ayudante.
      --Select 
      --    @spvar_Ayu3 = Rtrim(parametros..DatosEnfermeras.NombreEnf)+' '+RTrim(parametros..DatosEnfermeras.Apell1Enf)+' '+RTrim(parametros..DatosEnfermeras.Apell2Enf)
      --From 
      --    Parametros..DatosEnfermeras
      --Where 
      --    DNIEnf = @spvar_DNI3
      Select 
            @spvar_Ayu3 = Rtrim(parametros..ParametrosMedicos.NomMedico)+' '+RTrim(parametros..ParametrosMedicos.Apell1)+' '+RTrim(parametros..ParametrosMedicos.Apell2)
      From 
            Parametros..ParametrosMedicos
      Where 
            DNIMedico = @spvar_DNI3
      -- 04/01/2013 - MAS - CHC2414 v4.35 Release 1 - No mostraba los nombres de los 3 ayudantes - FIN
      
      -- Obtención del diagnóstico preoperatorio y operación propuesta de la Hoja Preoperatoria
      SELECT
        --CTF - CHC3096_REQ29954_MODIFICACIÓN PROTOCOLO OPERATORIO - INI
		--@spvar_DiagPre = DescDiagnostico,
		--@spvar_DiagPre='(' + LTrim(RTrim(C.CodOficial)) +') '+DescDiagnostico + ', ' +
		--	(Select SUBSTRING((select ', (' + LTrim(RTrim(Diag2.CodOficial)) +') '+Diag2.DescDiagnostico  
		--					   from Parametros..CIEDiagnostico Diag2 
		--							LEFT JOIN Hclinica..DiagnosticosCIE DiagCIE2 
		--											ON DiagCIE2.CodDiag = Diag2.CodDiagnostico 
		--											AND DiagCIE2.CodPaciente = HP.CodPaciente 
		--											AND DiagCIE2.CodEpisodio = HP.CodEpisodio 
		--						where DiagCIE2.EsPrincipal <> 1 
		--							and DiagCIE2.FecBorrado is null FOR XML PATH(''))
		--	,2,1000)),	
		@spvar_DiagPre='(' + LTrim(RTrim(isnull(C.CodOficial,''))) +') '+DescDiagnostico ,

			@spvar_DiagPreSecun = ', ' + isnull((Select SUBSTRING((select ', (' + LTrim(RTrim(isnull(Diag2.CodOficial,''))) +') '+Diag2.DescDiagnostico  + ' (' + ED.Estado + ')' 
							   from Parametros..CIEDiagnostico Diag2 
									INNER JOIN Ingresos..CapituloQPreopera EQ 
													ON EQ.CodIntervencion=HP.CodIntervencion
													AND EQ.CodCapitulo = Diag2.CodDiagnostico left join Parametros..EstadosDiagnosticos ED on ED.IdEstadosDiagnostico = EQ.Estado
									FOR XML PATH('')
									)
			,2,1000)),''),

			@spvar_EstadoPreopPrin = HP.Estado,
		
            @spvar_OpePro = '(' + LTRIM(RTRIM(isnull(CodFonDeis,''))) +') '+ DescProced
            --CTF - CHC3096_REQ29954_MODIFICACIÓN PROTOCOLO OPERATORIO - FIN 	
            --CTF - CHC3040_Validar PA SpIngSInfQuirurImpresion       
                        
            --CTF - CHC3096_REQ29954_MODIFICACIÓN PROTOCOLO OPERATORIO
            --@spvar_OpeReal = DescProced   
            
      FROM HClinica..Preoperatoria HP,
			 --CTF - CHC3096_REQ29954_MODIFICACIÓN PROTOCOLO OPERATORIO -- INI			  
			 --parametros..CIEDiagnostico,
			 parametros..CIEDiagnostico C,
            parametros..Procedimientos
            --parametros..MutuasSalud CM
            --CTF - CHC3096_REQ29954_MODIFICACIÓN PROTOCOLO OPERATORIO -- FIN

      WHERE HP.CodHojaPreop=@spvar_CodHojaPreop 
              And HP.CodIntervencion=@spvar_CodIntervencion  
              And HP.CodProc=parametros..Procedimientos.CodDiagnostico 
			  --CTF - CHC3096_REQ29954_MODIFICACIÓN PROTOCOLO OPERATORIO - INI
			  --And HP.CodCIEPreop= parametros..CIEDiagnostico.CodDiagnostico 
			  And HP.CodCIEPreop=C.CodDiagnostico 
              --And CM.Codigo=HP.CodMutua
              --CTF - CHC3096_REQ29954_MODIFICACIÓN PROTOCOLO OPERATORIO -- FIN
              And HP.Eliminado is null  
     
     -- CTF - CHC3040_Validar PA SpIngSInfQuirurImpresion - INI
     --CTF - CHC3096_REQ29954_MODIFICACIÓN PROTOCOLO OPERATORIO -- INI
	 SELECT 
		--	@spvar_OpePro = @spvar_OpePro +ISNULL(', '+ LTRIM(RTRIM(P.DescProced)),'') 
		 @spvar_OpePro = @spvar_OpePro+', ' +isnull((Select SUBSTRING((select ', ('+ LTRIM(RTRIM(isnull(P.CodFonDeis,'')))+') '+ LTrim(RTrim(P.DescProced))
					from  
						Ingresos..capituloqpreopera EQ,
    					Parametros..Procedimientos P
					WHERE 
						CodIntervencion = @spvar_CodIntervencion
						AND EQ.CodCapitulo = P.CodDiagnostico 
					FOR XML PATH(''))
			,2,1000)),'')
	 --FROM Ingresos..CapituloQPreopera CP
		--   INNER JOIN Parametros..Procedimientos P ON CP.CodCapitulo =P.CodDiagnostico
	 --WHERE CodIntervencion=@spvar_CodIntervencion AND P.Borrado IS NULL

	 --IF EXISTS (SELECT * FROM Consultas..capituloquirurgico WHERE CodIntervencion=@spvar_CodIntervencion)
	 --BEGIN
	 --SELECT 
		--	@spvar_OpeReal = @spvar_OpeReal +ISNULL(', '+ LTRIM(RTRIM(P.DescProced)),'') 
	 --FROM Consultas..CapituloQuirurgico CP
		--   INNER JOIN Parametros..Procedimientos P ON CP.CodCapitulo =P.CodDiagnostico
	 --WHERE CodIntervencion=@spvar_CodIntervencion AND P.Borrado IS NULL	 
	 --END
	 
	 --IF EXISTS (SELECT * FROM Ingresos..capituloquirurgico WHERE CodIntervencion=@spvar_CodIntervencion)
	 --BEGIN
	 --SELECT 
		--	@spvar_OpeReal = @spvar_OpeReal +ISNULL(', '+ LTRIM(RTRIM(P.DescProced)),'') 
	 --FROM Ingresos..CapituloQuirurgico CP
		--   INNER JOIN Parametros..Procedimientos P ON CP.CodCapitulo =P.CodDiagnostico
	 --WHERE CodIntervencion=@spvar_CodIntervencion AND P.Borrado IS NULL
	 --END
	 --CTF - CHC3096_REQ29954_MODIFICACIÓN PROTOCOLO OPERATORIO -- FIN
	 -- CTF - CHC3040_Validar PA SpIngSInfQuirurImpresion - FIN
            
      ------------------------------------------------------------------------------------
      --  SELECT QUERY PARA DEVOLVER
      ------------------------------------------------------------------------------------
      select  @spvar_Cir as NombreCirujano,
                  @spvar_Anes as NombreAnestesista,
                  @spvar_Enf as NombreInstrumentista,
                  @spvar_Ayu1 as NombreAyudante1,
                  @spvar_Ayu2 as NombreAyudante2,
                  @spvar_Ayu3 as NombreAyudante3,
                  HInicioInter as FechaOperacion,
                  @spvar_OpePro as DiagnosticoPropuesta,
                  @spvar_DiagPre as DiagnosticoPreoperatorio,
				  @spvar_DiagPreSecun as DiagnosticoPreOperSecundario, 
				  @spvar_EstadoPreopPrin as EstadoPreOperPrincipal,
				 -- @spvar_EstadoPreSecun as EstadoPreOperSecundario,
				  -- CTF - CHC3040_Validar PA SpIngSInfQuirurImpresion - INI
                  --DescProced as OperacionPracticada,
                  --CTF - CHC3096_REQ29954_MODIFICACIÓN PROTOCOLO OPERATORIO - INI
                  --@spvar_OpeReal as OperacionPracticada,
                  OperacionPracticada= '('+LTRIM(RTRIM(isnull(CodFonDeis,''))) + ') ' + DescProced +', ' +
					isnull((Select SUBSTRING((select ', ('+ LTRIM(RTRIM(isnull(P.CodFonDeis,'')))+') '+ LTrim(RTrim(P.DescProced))
							from  
								Ingresos..CapituloQuirurgico EQ,
        						Parametros..Procedimientos P
   							WHERE 
								CodIntervencion = IQ.CodIntervencion
								AND EQ.CodCapitulo = P.CodDiagnostico 
							FOR XML PATH(''))
					,2,1000)),''),
                  --CTF - CHC3096_REQ29954_MODIFICACIÓN PROTOCOLO OPERATORIO - FIN
                  -- CTF - CHC3040_Validar PA SpIngSInfQuirurImpresion - FIN
                  --CTF - CHC3096_REQ29954_MODIFICACIÓN PROTOCOLO OPERATORIO - INI
					--C.DescDiagnostico as DiagnosticoPostoperatorio,
					DiagnosticoPostoperatorioPrincipal='(' + LTrim(RTrim(isnull(C.CodOficial,''))) +') '+C.DescDiagnostico,
						
					--CTF - CHC3096_REQ29954_MODIFICACIÓN PROTOCOLO OPERATORIO - FIN   

					--CTF - CHC3096_REQ29954_MODIFICACIÓN PROTOCOLO OPERATORIO - FIN
									
					 DiagnosticoPostoperatorioSecundario = ', ' + isnull((Select SUBSTRING((select ', (' + LTrim(RTrim(isnull(Diag2.CodOficial,''))) +') '+Diag2.DescDiagnostico + ' (' + ED.Estado + ')'  
										   from Parametros..CIEDiagnostico Diag2 
												INNER JOIN Ingresos..CapituloQuirurgico EQ ON EQ.CodCapitulo = Diag2.CodDiagnostico 
																and EQ.CodIntervencion=IQ.CodIntervencion left join Parametros..EstadosDiagnosticos ED on ED.IdEstadosDiagnostico = EQ.Estado
																																 
												FOR XML PATH('')
												)
						,2,1000)),''),		
							
			      EstadoPostoperatorioPrincipal = IQ.Estado,	
				  
				  --EstadoPostoperatorioSecundario = (select Estado from Parametros..CIEDiagnostico Diag2 
						--			INNER JOIN Ingresos..CapituloQPreopera EQ
						--							ON EQ.CodIntervencion=IQ.CodIntervencion
						--							AND EQ.CodCapitulo = Diag2.CodDiagnostico),	

													
                  RQuirurgico as RiesgoQuirurgico,
                  Riesgo=(Select Descripcion 
                             From parametros..Codigos
                             Where (Tabla='EstRiesgoInterv' Or Tabla='N') And Codigo=IsNull(P.RQuirurgico,'N')),
                  P.TipoAnestesia,
                  TAnestesia=(Select Descripcion 
                              From parametros..Codigos
                             Where (Tabla='EstTipoAnestesia' Or Tabla='N') And Codigo=IsNull(P.TipoAnestesia,'N')),
                  P.CodHistoria as HistoriaClinica,
                  Rtrim(PAC.PacNombre) + ' ' + RTrim(PAC.PacApell1) + ' ' + RTrim(PAC.PacApell2) as NombrePaciente,
                  -- CTF - 73569626 - v4.39 - HC3096_REQ29954_MODIFICACIÓN PROTOCOLO OPERATORIO                         
				  --- RRG - 25412344N - CHC2947 - REQ27104 - v4.40 - CREACIÓN DE COMBOBOX PREFERENTE MODULO QUIROFANO - INI
				  --- Código Antiguo:
                  --- P.MotivoPreferente,
				  --- Código Nuevo:
				  MP.Descripcion as MotivoPreferente,
				  --- RRG - 25412344N - CHC2947 - REQ27104 - v4.40 - CREACIÓN DE COMBOBOX PREFERENTE MODULO QUIROFANO - FIN				  
				  P.Tipo		  
      From 
                  HClinica..InformeQuirurgico IQ
                  left join Parametros..CIEDiagnostico C on CodPostCIE = c.CodDiagnostico
                  right join Parametros..MutuasSalud M on M.Codigo = IQ.CodMutua
                  right join Hclinica..Preoperatoria P on P.CodHojaPreop = @spvar_CodHojaPreop
				  --- RRG - 25412344N - CHC2947 - REQ27104 - v4.40 - CREACIÓN DE COMBOBOX PREFERENTE MODULO QUIROFANO - INI
				  --- Código antiguo:
				  --- No hay
				  --- Código nuevo:
				  LEFT JOIN Parametros..MotivosIntervencionPreferente MP ON P.CodMotivoPreferente= MP.CodMotivo
				  --- RRG - 25412344N - CHC2947 - REQ27104 - v4.40 - CREACIÓN DE COMBOBOX PREFERENTE MODULO QUIROFANO - FIN
                  right join Hclinica..Pacientes PAC on PAC.CodHistoria = P.CodHistoria,
                  Parametros..Procedimientos PRO           

      Where 
                  IQ.CodIntervencion = @spvar_CodIntervencion And
                  CodProcedimiento = PRO.CodDiagnostico 



GO



--dbo.SpIngSPreopEpisodio.sql

   USE [Ingresos];
    GO
    IF EXISTS 
    (
        SELECT * 
            FROM sys.procedures 
            WHERE [object_id] = OBJECT_ID('[dbo].[SpIngSPreopEpisodio]')
    )
    BEGIN
        DROP PROCEDURE [dbo].[SpIngSPreopEpisodio];
    END
    GO
    

--	PROCEDIMIENTO		: 	SpIngSPreopEpisodio
--	FUNCION             : 	Realiza varias acciones dependiendo de los parámetros de entrada
--	FECHA				:	24/11/2008
--	AUTOR				:	MPS
--	COMENTARIOS			:	Procede del antiguo SpIngSQuiEpisodio modificado para la nueva tabla de la preoperatoria
						--	FECHA               : 	20/12/2005
						--	VERSION             : 	1.0
						--	AUTOR               : 	Gerardo Prieto David (MECEMSA Consultores)
--	APLICACIN ORIGEN   	: 	Informe quirrgico
--  Modificacion        :	Ismael(27/11/2007) Incluida la union en las select para que se vea la informacion
--											 en episodios de consulta e ingresos
--  Modificacion        : Ismael(27/01/2009) Ampliacion del codigo de historia
--  Modificacion        : Jesús Mañogil (14/04/2009) Se corrige problema de ambigüedad por un nuevo campo en Procedimientos
--  MODIFICACIÓN		: (04/09/2015) - v4.53r1 - SGN - 2500 - Plano y extremidad de intervenciones quirúrgicas
--  MODIFICACIÓN		: (23/10/2017) - v17.3r1 - MMM - 16152 - Agregar estado de Diagnósticos en solicitud de pabellón

CREATE PROC [dbo].[SpIngSPreopEpisodio]

	@spvar_CodPaciente varchar(16),
    @spvar_CodEpisodio varchar(5),
	@spvar_Fecha Smalldatetime,
	@spvar_Tabla varchar(2),
	@spvar_Elemento VARCHAR(2),
	@spvar_Codigo varchar(7),
	@spvar_Accion CHAR(2),
	@spvar_CodHistoria varchar(8),
	@spvar_CodIntervencion varchar(7)
	--(04/09/2015) - v4.53r1 - SGN - 2500 - Plano y extremidad de intervenciones quirúrgicas - INI
	,@spvar_IdPlano tinyint = NULL
	,@spvar_IdCuadrante tinyint = NULL
	--(04/09/2015) - v4.53r1 - SGN - 2500 - Plano y extremidad de intervenciones quirúrgicas - FIN
	,@spvar_Estado int = NULL

	
AS

	--	Accion - Valores
	--
	--	01:	Mostrar - Protesis
	--	02:	Mostrar - Equipos
	--	03:	Mostrar - DiagnosticosCIE
	--	04:	Mostrar - Procedimientos

	--	1:	Insertar
	--	2:	Eliminar
	--	3:	Actualizar la Tabla Alertas

	DECLARE @F_Informe SMALLDATETIME

	--	Mostrar prtesis.
	IF @spvar_Accion = '01'
	
		SELECT 
			EQ.CodCapitulo,
          			CP.Implante + ' (' + CP.Fabricante + ')'
   		FROM 
			Consultas..CapituloQPreopera EQ,
        	Parametros..CodProtesis CP
   		WHERE 
			CodIntervencion = @spvar_CodIntervencion AND
			TabCapitulo like @spvar_Tabla AND 
			EleCapitulo = '1' AND 
			EQ.CodCapitulo like @spvar_Codigo AND 
			EQ.CodCapitulo = CP.CodImplante

		union

		SELECT 
			EQ.CodCapitulo,
          			CP.Implante + ' (' + CP.Fabricante + ')'
   		FROM 
			Ingresos..CapituloQPreopera EQ,
        	Parametros..CodProtesis CP
   		WHERE 
			CodIntervencion = @spvar_CodIntervencion AND
			TabCapitulo like @spvar_Tabla AND 
			EleCapitulo = '1' AND 
			EQ.CodCapitulo like @spvar_Codigo AND 
			EQ.CodCapitulo = CP.CodImplante

	--	Mostrar equipos.
	IF @spvar_Accion = '02'
   		
		SELECT 
			EQ.CodCapitulo,
          			CE.DescEquipo
   		FROM 
			Consultas..CapituloQPreopera EQ,
        	Parametros..DatosEquipos CE
   		WHERE 
			CodIntervencion = @spvar_CodIntervencion AND
			TabCapitulo like @spvar_Tabla AND 
			EleCapitulo = '0' AND 
			EQ.CodCapitulo like @spvar_Codigo AND 
			EQ.CodCapitulo = CE.CodigoEquipo

		union

		SELECT 
			EQ.CodCapitulo,
          			CE.DescEquipo
   		FROM 
			Ingresos..CapituloQPreopera EQ,
        	Parametros..DatosEquipos CE
   		WHERE 
			CodIntervencion = @spvar_CodIntervencion AND
			TabCapitulo like @spvar_Tabla AND 
			EleCapitulo = '0' AND 
			EQ.CodCapitulo like @spvar_Codigo AND 
			EQ.CodCapitulo = CE.CodigoEquipo

	--	Diagnsticos CIE.
	IF @spvar_Accion = '03'

   		SELECT 
			EQ.CodCapitulo,
          			D.DescDiagnostico, EQ.Estado
   		FROM 
			Consultas..CapituloQPreopera EQ,
        			Parametros..CIEDiagnostico D 
		WHERE 
			CodIntervencion = @spvar_CodIntervencion AND
			TabCapitulo like @spvar_Tabla AND 
			EleCapitulo = '2' AND 
			EQ.CodCapitulo like @spvar_Codigo AND 
			EQ.CodCapitulo = D.CodDiagnostico

		union

		SELECT 
			EQ.CodCapitulo,
          			D.DescDiagnostico, EQ.Estado
   		FROM 
			Ingresos..CapituloQPreopera EQ,
        			Parametros..CIEDiagnostico D 
		WHERE 
			CodIntervencion = @spvar_CodIntervencion AND
			TabCapitulo like @spvar_Tabla AND 
			EleCapitulo = '2' AND 
			EQ.CodCapitulo like @spvar_Codigo AND 
			EQ.CodCapitulo = D.CodDiagnostico

		

	--	Mostrar procedimientos.
	IF @spvar_Accion = '04'

		SELECT 
			EQ.CodCapitulo,
          	P.DescProced
          	--(04/09/2015) - v4.53r1 - SGN - 2500 - Plano y extremidad de intervenciones quirúrgicas - INI
          	,EQ.IdPlano
          	,EQ.IdCuadrante
          	,Pl.DescPlano
          	,C.DescCuadrante
          	--(04/09/2015) - v4.53r1 - SGN - 2500 - Plano y extremidad de intervenciones quirúrgicas - FIN
          	
   		FROM 
			Consultas..CapituloQPreopera EQ
        	LEFT JOIN Parametros..Procedimientos P ON EQ.CodCapitulo = P.CodDiagnostico
        	--04/09/2015 - v4.53r1 - SGN - 2500 - Plano y extremidad de intervenciones quirúrgicas - INI
			LEFT JOIN Parametros..Planos Pl ON EQ.IdPlano = Pl.IdPlano
			LEFT JOIN Parametros..Cuadrantes C ON EQ.IdCuadrante = C.IdCuadrante
			--04/09/2015 - v4.53r1 - SGN - 2500 - Plano y extremidad de intervenciones quirúrgicas - FIN
   		WHERE 
			CodIntervencion = @spvar_CodIntervencion AND
			TabCapitulo like @spvar_Tabla AND 
			EleCapitulo = '3' AND 
			EQ.CodCapitulo like @spvar_Codigo 
			
		union

		SELECT 
			EQ.CodCapitulo,
          	P.DescProced
          	--(04/09/2015) - v4.53r1 - SGN - 2500 - Plano y extremidad de intervenciones quirúrgicas - INI
          	,EQ.IdPlano
          	,EQ.IdCuadrante
          	,Pl.DescPlano
          	,C.DescCuadrante
          	--(04/09/2015) - v4.53r1 - SGN - 2500 - Plano y extremidad de intervenciones quirúrgicas - FIN
          	
   		FROM 
			Ingresos..CapituloQPreopera EQ
        	LEFT JOIN Parametros..Procedimientos P ON EQ.CodCapitulo = P.CodDiagnostico
        	--04/09/2015 - v4.53r1 - SGN - 2500 - Plano y extremidad de intervenciones quirúrgicas - INI
			LEFT JOIN Parametros..Planos Pl ON EQ.IdPlano = Pl.IdPlano
			LEFT JOIN Parametros..Cuadrantes C ON EQ.IdCuadrante = C.IdCuadrante
			--04/09/2015 - v4.53r1 - SGN - 2500 - Plano y extremidad de intervenciones quirúrgicas - FIN
   		WHERE 
			CodIntervencion = @spvar_CodIntervencion AND
			TabCapitulo like @spvar_Tabla AND 
			EleCapitulo = '3' AND 
			EQ.CodCapitulo like @spvar_Codigo AND 
			EQ.CodCapitulo = P.CodDiagnostico
  
	--	Insertar.
	IF @spvar_Accion = '1'

		INSERT CapituloQPreopera 
   		VALUES ( 
			@spvar_CodPaciente,
			@spvar_CodEpisodio,
			@spvar_Fecha,
			@spvar_Tabla,
			@spvar_Elemento,
			@spvar_Codigo, 
			@spvar_CodHistoria,
			@spvar_CodIntervencion
			--(04/09/2015) - v4.53r1 - SGN - 2500 - Plano y extremidad de intervenciones quirúrgicas - INI
			,@spvar_IdPlano
			,@spvar_IdCuadrante
			--(04/09/2015) - v4.53r1 - SGN - 2500 - Plano y extremidad de intervenciones quirúrgicas - FIN
			,@spvar_Estado
			
		)

	--	Eliminar.
	IF @spvar_Accion = '2'

		BEGIN

			--	Borrar de Lista de Problemas si son Intervenciones desde InformeQuirurgico.
  			IF '1' Like @spvar_Tabla AND '3' Like @spvar_Elemento 
		
				BEGIN

					SELECT 
						@F_Informe = FInforme
					FROM 
						HClinica..InformeQuirurgico
					WHERE 
						CodPaciente = @spvar_CodPaciente AND 
						CodEpisodio = @spvar_CodEpisodio AND 
						FSolicitud=@spvar_Fecha

					DELETE 
						LP
    					FROM 
						HClinica..Problemas LP,
   	 					CapituloQPreopera EQ
    					WHERE 
						CodIntervencion = @spvar_CodIntervencion AND
						EQ.TabCapitulo like @spvar_Tabla AND 
						EQ.EleCapitulo like @spvar_Elemento AND 
						EQ.CodCapitulo like @spvar_Codigo AND 
						LP.CodPaciente = EQ.CodPaciente AND 
						LP.FecIni = EQ.FecCapitulo AND 
						LP.FecEntrada = @F_Informe AND 
						LP.CodProblem = EQ.CodCapitulo AND 
						LP.CodGrupProblem = '6' AND 
						LP.CodVitRelevancia = 'R'

				END
   
			DELETE 
				CapituloQPreopera
   			WHERE 
				CodIntervencion = @spvar_CodIntervencion AND
				TabCapitulo like @spvar_Tabla AND 
				EleCapitulo like @spvar_Elemento AND 
				CodCapitulo like @spvar_Codigo

		END

	IF @spvar_Accion = '3'

		BEGIN 

			SELECT 
				@F_Informe = FInforme
   			FROM 
				HClinica..InformeQuirurgico
   			WHERE 
				CodIntervencion = @spvar_CodIntervencion

			INSERT Problemas (
				CodPaciente,
                           		FecIni,
                           		FecEntrada,
                           		CodGrupProblem,
                           		CodVitRelevancia,
                           		CodProblem,
                           		DescProblem,
				ObserProblem,
				CodEspec,
				CodHistoria
			)

			SELECT 
				CodPaciente,
          				Fecha,
          				@F_Informe,
          				"6",
          				"R", 
          				Codigo,
          				Procedimiento,
				NULL,
				NULL,
				NULL
   			FROM 
				CapituloQPreopera EQ,
        				Parametros..Procedimientos P
   			WHERE 
				CodIntervencion = @spvar_CodIntervencion AND
				TabCapitulo = '1' And 
				EleCapitulo = '3' And 
				EQ.CodCapitulo = P.CodDiagnostico AND 
				NOT Exists(
					SELECT *
					FROM Problemas LP
                         				WHERE 	LP.CodPaciente = EQ.CodPaciente AND 
							LP.FecIni = EQ.Fecha AND 
							LP.FecEntrada = @F_Informe AND 
							EQ.Tabla = '1' AND 
							EQ.Elemento = '3' AND 
							EQ.Codigo = LP.CodProblem
				)

		END






    GO

GO



--dbo.SpIngSQuiDatos.sql

USE [Ingresos]
GO

/****** Object:  StoredProcedure [dbo].[SpIngSQuiDatos]    Script Date: 10/24/2014 13:30:02 ******/
IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[SpIngSQuiDatos]') AND type in (N'P', N'PC'))
DROP PROCEDURE [dbo].[SpIngSQuiDatos]
GO

USE [Ingresos]
GO

/****** Object:  StoredProcedure [dbo].[SpIngSQuiDatos]    Script Date: 10/24/2014 13:30:02 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

--	PROCEDIMIENTO		: 	SpIngSQuiDatos
--	FUNCION          	: 	Obtiene los datos de un informe quirrgico
--	DEVUELVE          	: 
--	FECHA             	: 	22/12/2005
--	VERSION             : 	1.0
--	AUTOR             	: 	Gerardo Prieto David (MECEMSA Consultores)
--  MODIFICACION		:   MPS 31/05/07 possum
--							Jorge Poveda SÃ¡ez 10/12/2007
--							He incluido los campos CodExamInterv 1 y 2
--	APLICACIN ORIGEN   	: 	Informe quirrgico
--*******************************************************************
-- MODIFICACIÃ“N: Obtenemos tambiÃ©n la fecha de solicitud y el cÃ³digo del episodio del informe quirÃºrgico
-- FECHA		: 24/07/2008
-- AUTOR		: Oscar Vilella Alarcon
--*******************************************************************
-- MODIFICACIÃ“N: Obtenemos la informaciÃ³n del paciente a mostrar en kiosko
-- FECHA		: 19/08/2008
-- AUTOR		: Oscar Vilella Alarcon
--*******************************************************************
-- MODIFICACIÃ“N: La informaciÃ³n del kiosco la sacamos de la preoperatoria
-- FECHA		: 10/03/2009
-- AUTOR		: Pablo GonzÃ¡lez Moro
--*******************************************************************
-- MODIFICACIÃ“N : Ampliamos  de tamaÃ±o la variable local @spvar_Antibiotico
-- FECHA		: 13/06/2011
-- AUTOR		: Jose Almela
--*******************************************************************
-- MODIFICACIÃ“N: El nombre del anestesista se obtiene de la tabla InforeQuirurgico o de Infore Anestesico depeniendo del valor de la constante m_bolAnestesiologia
-- FECHA		: 25/11/2013
-- AUTOR		: CTF - 73569626D - CHC3335_ModificaciÃ³n Campo Analista en InfQuirurgico
--*******************************************************************
-- MODIFICACIÃ“N : Se agrega la Enfermera Matrona como cirujano previsto al informe quirurgico.
-- FECHA		: 24/09/2014
-- AUTOR		: Req. 68579 v4.46r2 - 1466 - Patrick VicuÃ±a
--*******************************************************************
--MODIFICACIÃ“N	: (04/09/2015) - v4.53r1 - SGN - 2500 - Plano y extremidad de intervenciones quirÃºrgicas
--*******************************************************************
-- MODIFICACION:		: 17/05/2017 - v17.2 - 16381 - LMF - Filtrado de secciones y exÃ¡menes por centro
-- MODIFICACION         : 03/08/2017 - v17.3 - 16153 - MPR - Registro Quirurgico - Incorporar registro de Turno
--  MODIFICACIÃ“N        : 23/10/2017 - v17.3r1 - MMM - 16152 - Agregar estado de DiagnÃ³sticos en solicitud de pabellÃ³n	

CREATE Proc [dbo].[SpIngSQuiDatos]

	@spvar_CodIntervencion varchar(7)
	--CTF - 73569626D - CHC3335_ModificaciÃ³n Campo Analista en InfQuirurgico
	,@spvar_CodCentro char(5)

As

	--	Declaracin de variables.
	Declare @spvar_CodAntib int,
			@spvar_Antibiotico varchar(222), 
			@spvar_DNICir Char(8),
			@spvar_Cir VarChar(45), 
			@spvar_DNIAnes Char(8), 
			@spvar_Anes Varchar(45),
			@spvar_DNIEnf Char(8), 
			@spvar_Enf Varchar(45), 
			@spvar_DNI1 Char(8), 
			@spvar_Ayu1 Varchar(45),
			@spvar_DNI2 Char(8),
			@spvar_Ayu2 Varchar(45), 
			@spvar_DNI3 Char(8), 
			@spvar_Ayu3 Varchar(45),
			@spvar_CodCenRemite CHAR(5), 
			@spvar_TasaMorbilidad float ,  --mps
			@spvar_TasaMortalidad float ,   --mps
			@spvar_InfoPaciente varchar(4000)

	--	Valor inicial de las variables.
	Select @spvar_Antibiotico = ''
	Select @spvar_CodAntib = Null	
	Select @spvar_DNICir = ''
	Select @spvar_DNIAnes = ''
	Select @spvar_DNIEnf = ''
	Select @spvar_DNI1 = ''
	Select @spvar_DNI2 = ''
	Select @spvar_DNI3 = ''
	select @spvar_TasaMorbilidad = null
	select @spvar_TasaMortalidad = null

	--	Obtencin de los datos del antibitico empleado.	
	Select 
		@spvar_CodAntib = IQ.CodAntibioticos,
       		@spvar_Antibiotico = CF.DescEspecialidad + CF.DescPresentacion
	From 
		HClinica..InformeQuirurgico IQ,
       		Farmacias..Especialidad CF,
       		Farmacias..REspecialidad CFR
 	Where 
		IQ.CodIntervencion = @spvar_CodIntervencion And	
		CFR.IDEspecialidad = CodAntibioticos And
       		CF.CodEspec = CFR.CodEspec And
       		CF.Tipo = CFR.Tipo

	--	Obtencin del DNI del cirujano, del instrumentista y de los ayudantes.	
	Select 
		@spvar_DNICir = CodCirujano,
		@spvar_DNIEnf = CodInstrumentista,
		@spvar_DNI1 = CodAyudante1,
		@spvar_DNI2 = CodAyudante2,
		@spvar_DNI3 = CodAyudante3
	From 
		HClinica..InformeQuirurgico
	Where 
		CodIntervencion = @spvar_CodIntervencion

	--	Obtencin del nombre del cirujano.
	-- v4.47r2 - 1466 - Req. 68579 - ActualizaciÃ³n SP  INI 
	 IF EXISTS (SELECT * From Parametros..ParametrosMedicos  Where DNIMedico = @spvar_DNICir)
		  BEGIN
			 Select   
			  @spvar_Cir = Rtrim(parametros..ParametrosMedicos.NomMedico)+' '+RTrim(parametros..ParametrosMedicos.Apell1)+' '+RTrim(parametros..ParametrosMedicos.Apell2)  
			 From   
			  Parametros..ParametrosMedicos  
			 Where   
			  DNIMedico = @spvar_DNICir  
		  END
	 ELSE
		BEGIN
			 Select   
			  @spvar_Cir = Rtrim(parametros..DatosEnfermeras.NombreEnf)+' '+RTrim(parametros..DatosEnfermeras.Apell1Enf)+' '+RTrim(parametros..DatosEnfermeras.Apell2Enf)  
			 From   
			  Parametros..DatosEnfermeras 
			 Where   
			  DNIEnf = @spvar_DNICir   AND CodRol = '4'
		END
	 -- v4.47r2 - 1466 - Req. 68579 - ActualizaciÃ³n SP FIN

	--	Obtencin del DNI del anestesista.
	Select 
		@spvar_DNIAnes = DNIAnestesista
	From 
		HClinica..InformeAnestesico
	Where 
		CodIntervencion = @spvar_CodIntervencion

	--	Obtencin del nombre del anestesista.
	--CTF - 73569626D - CHC3335_ModificaciÃ³n Campo Analista en InfQuirurgico - INI
	IF (SELECT ValorConstante FROM Parametros..constantes WHERE NombreConstante = 'm_bolAnestesiologia' and CentroRef=@spvar_CodCentro)=1 
		BEGIN
	--CTF - 73569626D - CHC3335_ModificaciÃ³n Campo Analista en InfQuirurgico - FIN
			Select 
				@spvar_Anes = Rtrim(parametros..ParametrosMedicos.NomMedico)+' '+RTrim(parametros..ParametrosMedicos.Apell1)+' '+RTrim(parametros..ParametrosMedicos.Apell2)
			From 
				Parametros..ParametrosMedicos
			Where 
				DNIMedico = @spvar_DNIAnes
	--CTF - 73569626D - CHC3335_ModificaciÃ³n Campo Analista en InfQuirurgico - INI
		END	
	ELSE
		BEGIN
				Select 
					@spvar_Anes = RTRIM(NombreAnestesista)
				From 
					HClinica..InformeQuirurgico
				Where 
					CodIntervencion = @spvar_CodIntervencion
		END
	--CTF - 73569626D - CHC3335_ModificaciÃ³n Campo Analista en InfQuirurgico - FIN
				

	--	Obtencin del nombre del instrumentista.
	Select 
		@spvar_Enf = Rtrim(parametros..DatosEnfermeras.NombreEnf)+' '+RTrim(parametros..DatosEnfermeras.Apell1Enf)+' '+RTrim(parametros..DatosEnfermeras.Apell2Enf)
	From 
		Parametros..DatosEnfermeras
	Where 
		DNIEnf = @spvar_DNIEnf

	--	Obtencin del nombre del primer ayudante.
	Select 
		@spvar_Ayu1 = Rtrim(parametros..DatosEnfermeras.NombreEnf)+' '+RTrim(parametros..DatosEnfermeras.Apell1Enf)+' '+RTrim(parametros..DatosEnfermeras.Apell2Enf)
	From 
		Parametros..DatosEnfermeras
	Where 
		DNIEnf = @spvar_DNIEnf

	--	Obtencin del nombre del segundo ayudante.
	Select 
		@spvar_Ayu2 = Rtrim(parametros..DatosEnfermeras.NombreEnf)+' '+RTrim(parametros..DatosEnfermeras.Apell1Enf)+' '+RTrim(parametros..DatosEnfermeras.Apell2Enf)
	From 
		Parametros..DatosEnfermeras
	Where 
		DNIEnf = @spvar_DNIEnf

	--	Obtencin del nombre del tercer ayudante.
	Select 
		@spvar_Ayu3 = Rtrim(parametros..DatosEnfermeras.NombreEnf)+' '+RTrim(parametros..DatosEnfermeras.Apell1Enf)+' '+RTrim(parametros..DatosEnfermeras.Apell2Enf)
	From 
		Parametros..DatosEnfermeras
	Where 
		DNIEnf = @spvar_DNIEnf

	--	Obtencin del cdigo del centro remitente.
	SELECT 
		@spvar_CodCenRemite = CodCenRemite
	FROM 
		HClinica..Preoperatoria
	WHERE 
		CodIntervencion = @spvar_CodIntervencion

    -- Datos del resultado del possum. EstÃ¡n en la preoperatoria
	-- MORBILIDAD
	SELECT 
		@spvar_TasaMorbilidad = TasaMorbilidad
	FROM
		HClinica..Preoperatoria
	WHERE
		CodIntervencion = @spvar_CodIntervencion

	-- MORTALIDAD e InfoPaciente
	SELECT 
		@spvar_TasaMortalidad = TasaMortalidad,
		@spvar_InfoPaciente = InfoPaciente
	FROM
		HClinica..Preoperatoria
	WHERE
		CodIntervencion = @spvar_CodIntervencion
		
		
	
	--	Obtencin del resto de valores.
	Select 
		@spvar_DNICir, 
		@spvar_Cir, 
		@spvar_DNIAnes, 
		@spvar_Anes, 
		@spvar_DNIEnf, 
		@spvar_Enf,
       	@spvar_DNI1, 
		@spvar_Ayu1, 
		@spvar_DNI2, 
		@spvar_Ayu2, 
		@spvar_DNI3, 
		@spvar_Ayu3,
       	CodMedInforma,
       	Medico = (
			Select 
				Rtrim(Parametros..ParametrosMedicos.NomMedico)+' '+RTrim(Parametros..ParametrosMedicos.Apell1)+' '+RTrim(Parametros..ParametrosMedicos.Apell2)
                 		From 
				Parametros..ParametrosMedicos
                		Where 
				I.CodMedInforma = DNIMedico
		),
       		CodQuirofano,
       		PosicionInter,
       		Pos = (
			Select 
				Descripcion
              		From 
				Parametros..Codigos
             			Where 
				(Tabla = 'EstPosIntervencion' Or Tabla = 'N') And
                    			Codigo = IsNull(I.PosicionInter,'N')
		),
		CodVia,
      	Via = (
			Select 
				Descripcion
              		From 
				Parametros..Codigos
			Where 
				(Tabla = 'EstDescripcionVia' Or Tabla = 'N') And
				Codigo = IsNull(I.CodVia,'N')
		),
		CodProcedimiento, 
		DescProced,
       	CodPostCIE, 
		DescDiagnostico,
       	@spvar_CodAntib, 
		@spvar_Antibiotico,
       	TipoInter,
       	Interv = (
			Select 
				Descripcion
                 		From 
				Parametros..Codigos
                		Where 
				(Tabla = 'EstDesIntervencion' Or Tabla = 'N') And
				Codigo = IsNull(I.TipoInter,'N')
		),
		DestinoInter,
		Destino = (
			Select 
				Descripcion
			From 
				Parametros..Codigos
			Where 
				(Tabla = 'EstDestIntervencion' Or Tabla = 'N') And
                        			Codigo = IsNull(I.DestinoInter,'N')
		),
       	Solicitudes,
       	Drenaje,
       	DescOperatoria,
       	TecnicasEmpleadas,
       	TecnicaCierre,
       	PiezaExtirpada,
       	HInicioInter, 
		HFinInter, 
       	FInforme,
       	I.CodMutua,
       	Entidad,
       	Facturable,
       	CantidadProcesos,
       	@spvar_CodCenRemite,
		SolBiopsia,
		SolLaboratorio,
		SolCitologias,
		SolHormonales,
		SolRadiologia,
		SolPostmortem,
		CodInforme,
		Firmado,
		NumCordales,
		CodExamInterven,
		CodExamInterven1,
		CodExamInterven2,
		@spvar_TasaMorbilidad as TasaMorbilidad,
		@spvar_TasaMortalidad as TasaMortalidad,
		FSolicitud,
		I.CodEpisodio,
		@spvar_InfoPaciente as InfoPaciente
		--(04/09/2015) - v4.53r1 - SGN - 2500 - Plano y extremidad de intervenciones quirÃºrgicas - INI
		,I.IdPlano
		,I.IdCuadrante
		,Pl.DescPlano
		,Cd.DescCuadrante
		--(04/09/2015) - v4.53r1 - SGN - 2500 - Plano y extremidad de intervenciones quirÃºrgicas - FIN
		,I.IdTurnoInfQuirurgico
		,I.Estado
		
		From 
			HClinica..InformeQuirurgico I left join Parametros..CIEDiagnostico C on CodPostCIE = c.CodDiagnostico
			LEFT JOIN Parametros..Procedimientos P ON I.CodProcedimiento = P.CodDiagnostico
			--04/09/2015 - v4.53r1 - SGN - 2500 - Plano y extremidad de intervenciones quirÃºrgicas - INI
			LEFT JOIN Parametros..Planos Pl ON I.IdPlano = Pl.IdPlano
			LEFT JOIN Parametros..Cuadrantes Cd ON I.IdCuadrante = Cd.IdCuadrante
			--04/09/2015 - v4.53r1 - SGN - 2500 - Plano y extremidad de intervenciones quirÃºrgicas - FIN
			right join Parametros..MutuasSalud M on M.Codigo = I.CodMutua

 	Where 
		CodIntervencion = @spvar_CodIntervencion 
		 
GO

GO



--dbo.SpIngSQuiPrevio.sql

USE [Ingresos]
GO

IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[SpIngSQuiPrevio]') AND type in (N'P', N'PC'))
DROP PROCEDURE [dbo].[SpIngSQuiPrevio]
GO

USE [Ingresos]
GO

SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO



--	PROCEDIMIENTO		: 	SpIngSQuiPrevio
--	FUNCION                 		: 	Obtiene los datos previos de la hoja de preoperatoria
--	DEVUELVE                		: 
--	FECHA                  		: 	20/12/2005
--	VERSION                 		: 	1.0
--	AUTOR                   		: 	Gerardo Prieto David (MECEMSA Consultores)
--	APLICACIN ORIGEN   		: 	Informe quirúrgico

--  MODIFICACION			: MPS 31/05/07 obtener los campos del possum 
--	MODIFICACIÓN			: (08/09/2015) - v4.53r1 - 2500 - VAS - Plano y extremidad de intervenciones quirúrgicas
--  MODIFICACION			: (23/10/2017) - v17.3r1 - 16152 - MMM - Agregar estado de Diagnósticos en solicitud de pabellón	

CREATE Proc [dbo].[SpIngSQuiPrevio] 
	
	@spvar_CodIntervencion varchar(7),
	@spvar_CodPaciente varchar(16) = NULL,
	@spvar_CodEpisodio varchar(5) = NULL

As
If (SELECT Count(*) FROM Ingresos..EpisodioHospitalizacion WHERE CodPaciente = @spvar_CodPaciente AND CodEpisodio = @spvar_CodEpisodio) = 1 

		--	Episodio de ingreso.
		Select 
			P.DescProced,
       			HP.CodProc,
	       		D.DescDiagnostico,
       			HP.CodCIEPreop,
	       		HP.FPrevista,
       			EH.CodigoServicioHospitaliza,
       			HP.CodMutua,
       			Entidad,
       			Obligatorio_Quirofano = 
				CASE WHEN (
					SELECT COUNT(*) 
					FROM Ingresos..EpisodioUrgencias U 
					WHERE U.CodPaciente = HP.CodPaciente AND U.CodEpisodio = HP.CodEpisodio AND IsNull(U.FechaSalida,getdate())>HP.FPreoperatoria
					) > 0
                                   			THEN 0
                               			ELSE 1
                             		END,
       			--HP.CantProcesos,
	      		HP.FIntervencion,
				HP.CodExamInterven,
				HP.TasaMorbilidad,  -- mps
				HP.TasaMortalidad   -- mps
				--(08/09/2015) - v4.53r1 - 2500 - VAS - Plano y extremidad de intervenciones quirúrgicas - INI
				, HP.IdPlano
				, PL.DescPlano
				, HP.IdCuadrante
				, CU.DescCuadrante
				--(08/09/2015) - v4.53r1 - 2500 - VAS - Plano y extremidad de intervenciones quirúrgicas - FIN
				,HP.Estado

		From 
			HClinica..Preoperatoria HP,
     			Parametros..Procedimientos P,
     			Parametros..CIEDiagnostico D,
     			Parametros..MutuasSalud,
     			Ingresos..EpisodioHospitalizacion EH
     			, Parametros..Planos PL, Parametros..Cuadrantes CU	--(08/09/2015) - v4.53r1 - 2500 - VAS - Plano y extremidad de intervenciones quirúrgicas
		Where 
			HP.CodIntervencion = @spvar_CodIntervencion And
      			EH.CodPaciente = HP.CodPaciente And
      			EH.CodEpisodio = HP.CodEpisodio And
      			P.CodDiagnostico = HP.CodProc And
      			D.CodDiagnostico = HP.CodCIEPreop And
      			Codigo = HP.CodMutua
      			AND PL.IdPlano = HP.IdPlano AND CU.IdCuadrante = HP.IdCuadrante	--(08/09/2015) - v4.53r1 - 2500 - VAS - Plano y extremidad de intervenciones quirúrgicas

	Else

		Select 
			P.DescProced,
       			HP.CodProc,
       			D.DescDiagnostico,
       			HP.CodCIEPreop,
       			HP.FPrevista,
       			EU.CodigoServicioUrgenc,
       			HP.CodMutua,
       			Entidad,
       			Obligatorio_Quirofano = 
				CASE WHEN 
					FPrevista IS NULL AND 
					Ambulatoria = 0X1  
                                     			THEN 0
                               		WHEN (
					SELECT CodQuirofano 
					FROM HClinica..InformeQuirurgico IQ
                    WHERE IQ.CodPaciente = HP.CodPaciente AND IQ.CodEpisodio = HP.CodEpisodio AND IQ.FSolicitud = HP.FPreoperatoria
					) IS NULL AND 
					Ambulatoria = 0X1  
                                     			THEN 0
                                			ELSE 1
                             		END,
       		--	HP.CantProcesos,
       			HP.FIntervencion,
				HP.CodExamInterven,
				HP.TasaMorbilidad,  -- mps
				HP.TasaMortalidad   -- mps
				--(08/09/2015) - v4.53r1 - 2500 - VAS - Plano y extremidad de intervenciones quirúrgicas - INI
				, HP.IdPlano
				, PL.DescPlano
				, HP.IdCuadrante
				, CU.DescCuadrante
				--(08/09/2015) - v4.53r1 - 2500 - VAS - Plano y extremidad de intervenciones quirúrgicas - FIN
				,HP.Estado
				
		From 
			HClinica..Preoperatoria HP,
     			Parametros..Procedimientos P,
     			Parametros..CIEDiagnostico D,
     			Parametros..MutuasSalud,
     			Ingresos..EpisodioUrgencias EU
     			, Parametros..Planos PL, Parametros..Cuadrantes CU	--(08/09/2015) - v4.53r1 - 2500 - VAS - Plano y extremidad de intervenciones quirúrgicas
		Where 
			HP.CodIntervencion = @spvar_CodIntervencion And
      			EU.CodPaciente = HP.CodPaciente And
      			EU.CodEpisodio = HP.CodEpisodio And
      			P.CodDiagnostico = HP.CodProc And
      			D.CodDiagnostico = HP.CodCIEPreop And
      			Codigo = HP.CodMutua
      			AND PL.IdPlano = HP.IdPlano AND CU.IdCuadrante = HP.IdCuadrante	--(08/09/2015) - v4.53r1 - 2500 - VAS - Plano y extremidad de intervenciones quirúrgicas


GO



GO



--dbo.SpIngSQuiruEpisodio.sql

    USE [Ingresos];
    GO
    IF EXISTS 
    (
        SELECT * 
            FROM sys.procedures 
            WHERE [object_id] = OBJECT_ID('[dbo].[SpIngSQuiruEpisodio]')
    )
    BEGIN
        DROP PROCEDURE [dbo].[SpIngSQuiruEpisodio];
    END
    GO
    

--	PROCEDIMIENTO		: 	SpIngSQuiruEpisodio
--	FUNCION             : 	Realiza varias acciones
--  FECHA				:	24/11/2008
--  AUTOR				:	MPS 
--	COMENTARIOS			:	Procede del antiguo [SpIngSQuiEpisodio]
							--	FECHA               : 	20/12/2005
							--	VERSION             : 	1.0
							--	AUTOR               : 	Gerardo Prieto David (MECEMSA Consultores)
--	APLICACIN ORIGEN   	: 	Informe quirrgico
--  Modificacion        : Ismael(27/11/2007) Incluida la union en las select para que se vea la informacion
--											 en episodios de consulta e ingresos
--  Modificacion        : Ismael(27/01/2009) Ampliado el tamaño del campo CodHistoria
--  Modificacion		: Jesús Mañogil (31/03/2009) Se corrige problema de ambigüedad por un nuevo campo en Procedimientos
--  MODIFICACIÓN		: (04/09/2015) - v4.53r1 - SGN - 2500 - Plano y extremidad de intervenciones quirúrgicas
--  MODIFICACIÓN		: (23/10/2017) - v17.3r1 - MMM - 16152 - Agregar estado de Diagnósticos en solicitud de pabellón

CREATE PROC [dbo].[SpIngSQuiruEpisodio]

	@spvar_CodPaciente varchar(16),
    @spvar_CodEpisodio varchar(5),
	@spvar_Fecha Smalldatetime,
	@spvar_Tabla varchar(2),
	@spvar_Elemento VARCHAR(2),
	@spvar_Codigo varchar(7),
	@spvar_Accion CHAR(2),
	@spvar_CodHistoria varchar(8),
	@spvar_CodIntervencion varchar(7), 
	@spvar_ModoNuevo bit  
	--(04/09/2015) - v4.53r1 - SGN - 2500 - Plano y extremidad de intervenciones quirúrgicas - INI
	,@spvar_IdPlano tinyint = NULL
	,@spvar_IdCuadrante tinyint = NULL
	--(04/09/2015) - v4.53r1 - SGN - 2500 - Plano y extremidad de intervenciones quirúrgicas - FIN
	,@spvar_Estado int = NULL
	
	
AS

	--	Accion - Valores
	--
	--	01:	Mostrar - Protesis
	--	02:	Mostrar - Equipos
	--	03:	Mostrar - DiagnosticosCIE
	--	04:	Mostrar - Procedimientos

	--	1:	Insertar
	--	2:	Eliminar
	--	3:	Actualizar la Tabla Alertas

	DECLARE @F_Informe SMALLDATETIME

	--	Mostrar prtesis.
	IF @spvar_Accion = '01'
	
		SELECT 
			EQ.CodCapitulo,
          			CP.Implante + ' (' + CP.Fabricante + ')'
   		FROM 
			Consultas..CapituloQuirurgico EQ,
        	Parametros..CodProtesis CP
   		WHERE 
			CodIntervencion = @spvar_CodIntervencion AND
			TabCapitulo like @spvar_Tabla AND 
			EleCapitulo = '1' AND 
			EQ.CodCapitulo like @spvar_Codigo AND 
			EQ.CodCapitulo = CP.CodImplante

		union

		SELECT 
			EQ.CodCapitulo,
          			CP.Implante + ' (' + CP.Fabricante + ')'
   		FROM 
			Ingresos..CapituloQuirurgico EQ,
        	Parametros..CodProtesis CP
   		WHERE 
			CodIntervencion = @spvar_CodIntervencion AND
			TabCapitulo like @spvar_Tabla AND 
			EleCapitulo = '1' AND 
			EQ.CodCapitulo like @spvar_Codigo AND 
			EQ.CodCapitulo = CP.CodImplante

	--	Mostrar equipos.
	IF @spvar_Accion = '02'
   		
		SELECT 
			EQ.CodCapitulo,
          			CE.DescEquipo
   		FROM 
			Consultas..CapituloQuirurgico EQ,
        	Parametros..DatosEquipos CE
   		WHERE 
			CodIntervencion = @spvar_CodIntervencion AND
			TabCapitulo like @spvar_Tabla AND 
			EleCapitulo = '0' AND 
			EQ.CodCapitulo like @spvar_Codigo AND 
			EQ.CodCapitulo = CE.CodigoEquipo

		union

		SELECT 
			EQ.CodCapitulo,
          			CE.DescEquipo
   		FROM 
			Ingresos..CapituloQuirurgico EQ,
        	Parametros..DatosEquipos CE
   		WHERE 
			CodIntervencion = @spvar_CodIntervencion AND
			TabCapitulo like @spvar_Tabla AND 
			EleCapitulo = '0' AND 
			EQ.CodCapitulo like @spvar_Codigo AND 
			EQ.CodCapitulo = CE.CodigoEquipo

	--	Diagnsticos CIE.
	IF @spvar_Accion = '03'
	begin
        -- mps compruebo si existen registros con Procedencia = 1 
		if exists(SELECT *	FROM 
				  Consultas..CapituloQuirurgico EQ,
        		  Parametros..CIEDiagnostico D 
				  WHERE 
					CodIntervencion = @spvar_CodIntervencion AND
					TabCapitulo like @spvar_Tabla AND 
					EleCapitulo = '2' AND 
					EQ.CodCapitulo like @spvar_Codigo AND 
					EQ.CodCapitulo = D.CodDiagnostico ) or 
			exists(SELECT *
   					FROM 
					Ingresos..CapituloQuirurgico EQ,
        			Parametros..CIEDiagnostico D 
					WHERE 
					CodIntervencion = @spvar_CodIntervencion AND
					TabCapitulo like @spvar_Tabla AND 
					EleCapitulo = '2' AND 
					EQ.CodCapitulo like @spvar_Codigo AND 
					EQ.CodCapitulo = D.CodDiagnostico )
		begin
			
   			SELECT 
				EQ.CodCapitulo,
          				D.DescDiagnostico, EQ.Estado
   			FROM 
				Consultas..CapituloQuirurgico EQ,
        				Parametros..CIEDiagnostico D 
			WHERE 
				CodIntervencion = @spvar_CodIntervencion AND
				TabCapitulo like @spvar_Tabla AND 
				EleCapitulo = '2' AND 
				EQ.CodCapitulo like @spvar_Codigo AND 
				EQ.CodCapitulo = D.CodDiagnostico 

			union

			SELECT 
				EQ.CodCapitulo,
          				D.DescDiagnostico, EQ.Estado
   			FROM 
				Ingresos..CapituloQuirurgico EQ,
        				Parametros..CIEDiagnostico D 
			WHERE 
				CodIntervencion = @spvar_CodIntervencion AND
				TabCapitulo like @spvar_Tabla AND 
				EleCapitulo = '2' AND 
				EQ.CodCapitulo like @spvar_Codigo AND 
				EQ.CodCapitulo = D.CodDiagnostico 
			end
			-- sólo en el caso de modo nuevo sacaremos lo que escribió la preoperatoria
			else if @spvar_ModoNuevo = 1 
			begin
				SELECT 
					EQ.CodCapitulo,
          					D.DescDiagnostico, EQ.Estado
   				FROM 
					Consultas..CapituloQPreopera EQ,
        					Parametros..CIEDiagnostico D 
				WHERE 
					CodIntervencion = @spvar_CodIntervencion AND
					TabCapitulo like @spvar_Tabla AND 
					EleCapitulo = '2' AND 
					EQ.CodCapitulo like @spvar_Codigo AND 
					EQ.CodCapitulo = D.CodDiagnostico 

				union

				SELECT 
					EQ.CodCapitulo,
          					D.DescDiagnostico, EQ.Estado
   				FROM 
					Ingresos..CapituloQPreopera EQ,
        					Parametros..CIEDiagnostico D 
				WHERE 
					CodIntervencion = @spvar_CodIntervencion AND
					TabCapitulo like @spvar_Tabla AND 
					EleCapitulo = '2' AND 
					EQ.CodCapitulo like @spvar_Codigo AND 
					EQ.CodCapitulo = D.CodDiagnostico 
			end

		
    end
	--	Mostrar procedimientos.
	IF @spvar_Accion = '04'
	begin

        -- mps compruebo si existen registros con Procedencia = 1 
		if exists(	SELECT *
   					FROM 
						Consultas..CapituloQuirurgico EQ,
        				Parametros..Procedimientos P
   					WHERE 
					CodIntervencion = @spvar_CodIntervencion AND
					TabCapitulo like @spvar_Tabla AND 
					EleCapitulo = '3' AND 
					EQ.CodCapitulo like @spvar_Codigo AND 
					EQ.CodCapitulo = P.CodDiagnostico ) or 
					exists(SELECT *
   					FROM 
						Ingresos..CapituloQuirurgico EQ,
        				Parametros..Procedimientos P
   					WHERE 
					CodIntervencion = @spvar_CodIntervencion AND
					TabCapitulo like @spvar_Tabla AND 
					EleCapitulo = '3' AND 
					EQ.CodCapitulo like @spvar_Codigo AND 
					EQ.CodCapitulo = P.CodDiagnostico )
		begin
			SELECT 
				EQ.CodCapitulo,
          		P.DescProced
          		--(04/09/2015) - v4.53r1 - SGN - 2500 - Plano y extremidad de intervenciones quirúrgicas - INI
          		,EQ.IdPlano
          		,EQ.IdCuadrante
          		,Pl.DescPlano
          		,Cd.DescCuadrante
          		--(04/09/2015) - v4.53r1 - SGN - 2500 - Plano y extremidad de intervenciones quirúrgicas - FIN
   			FROM 
				Consultas..CapituloQuirurgico EQ
        		LEFT JOIN Parametros..Procedimientos P ON EQ.CodCapitulo = P.CodDiagnostico
        		--04/09/2015 - v4.53r1 - SGN - 2500 - Plano y extremidad de intervenciones quirúrgicas - INI
				LEFT JOIN Parametros..Planos Pl ON EQ.IdPlano = Pl.IdPlano
				LEFT JOIN Parametros..Cuadrantes Cd ON EQ.IdCuadrante = Cd.IdCuadrante
				--04/09/2015 - v4.53r1 - SGN - 2500 - Plano y extremidad de intervenciones quirúrgicas - FIN
   			WHERE 
				CodIntervencion = @spvar_CodIntervencion AND
				TabCapitulo like @spvar_Tabla AND 
				EleCapitulo = '3' AND 
				EQ.CodCapitulo like @spvar_Codigo 
				 
			union

			SELECT 
				EQ.CodCapitulo,
          		P.DescProced
          		--(04/09/2015) - v4.53r1 - SGN - 2500 - Plano y extremidad de intervenciones quirúrgicas - INI
          		,EQ.IdPlano
          		,EQ.IdCuadrante
          		,Pl.DescPlano
          		,Cd.DescCuadrante
          		--(04/09/2015) - v4.53r1 - SGN - 2500 - Plano y extremidad de intervenciones quirúrgicas - FIN
   			FROM 
				Ingresos..CapituloQuirurgico EQ
        		LEFT JOIN Parametros..Procedimientos P ON EQ.CodCapitulo = P.CodDiagnostico
        		--04/09/2015 - v4.53r1 - SGN - 2500 - Plano y extremidad de intervenciones quirúrgicas - INI
				LEFT JOIN Parametros..Planos Pl ON EQ.IdPlano = Pl.IdPlano
				LEFT JOIN Parametros..Cuadrantes Cd ON EQ.IdCuadrante = Cd.IdCuadrante
				--04/09/2015 - v4.53r1 - SGN - 2500 - Plano y extremidad de intervenciones quirúrgicas - FIN
   			WHERE 
				CodIntervencion = @spvar_CodIntervencion AND
				TabCapitulo like @spvar_Tabla AND 
				EleCapitulo = '3' AND 
				EQ.CodCapitulo like @spvar_Codigo
			end 
			-- sólo en el caso de modo nuevo sacaremos lo que escribió la preoperatoria
			else if @spvar_ModoNuevo = 1 
			begin

				SELECT 
					EQ.CodCapitulo,
          			P.DescProced
          			--(04/09/2015) - v4.53r1 - SGN - 2500 - Plano y extremidad de intervenciones quirúrgicas - INI
          			,EQ.IdPlano
          			,EQ.IdCuadrante
          			,Pl.DescPlano
          			,Cd.DescCuadrante
          			--(04/09/2015) - v4.53r1 - SGN - 2500 - Plano y extremidad de intervenciones quirúrgicas - FIN
   				FROM 
					Consultas..CapituloQPreopera EQ
        			LEFT JOIN Parametros..Procedimientos P ON EQ.CodCapitulo = P.CodDiagnostico
        			--04/09/2015 - v4.53r1 - SGN - 2500 - Plano y extremidad de intervenciones quirúrgicas - INI
					LEFT JOIN Parametros..Planos Pl ON EQ.IdPlano = Pl.IdPlano
					LEFT JOIN Parametros..Cuadrantes Cd ON EQ.IdCuadrante = Cd.IdCuadrante
					--04/09/2015 - v4.53r1 - SGN - 2500 - Plano y extremidad de intervenciones quirúrgicas - FIN
   				WHERE 
					CodIntervencion = @spvar_CodIntervencion AND
					TabCapitulo like @spvar_Tabla AND 
					EleCapitulo = '3' AND 
					EQ.CodCapitulo like @spvar_Codigo

				union

				SELECT 
					EQ.CodCapitulo,
          			P.DescProced
          			--(04/09/2015) - v4.53r1 - SGN - 2500 - Plano y extremidad de intervenciones quirúrgicas - INI
          			,EQ.IdPlano
          			,EQ.IdCuadrante
          			,Pl.DescPlano
          			,Cd.DescCuadrante
          			--(04/09/2015) - v4.53r1 - SGN - 2500 - Plano y extremidad de intervenciones quirúrgicas - FIN
   				FROM 
					Ingresos..CapituloQPreopera EQ
        			LEFT JOIN Parametros..Procedimientos P ON EQ.CodCapitulo = P.CodDiagnostico
        			--04/09/2015 - v4.53r1 - SGN - 2500 - Plano y extremidad de intervenciones quirúrgicas - INI
					LEFT JOIN Parametros..Planos Pl ON EQ.IdPlano = Pl.IdPlano
					LEFT JOIN Parametros..Cuadrantes Cd ON EQ.IdCuadrante = Cd.IdCuadrante
					--04/09/2015 - v4.53r1 - SGN - 2500 - Plano y extremidad de intervenciones quirúrgicas - FIN
   				WHERE 
					CodIntervencion = @spvar_CodIntervencion AND
					TabCapitulo like @spvar_Tabla AND 
					EleCapitulo = '3' AND 
					EQ.CodCapitulo like @spvar_Codigo AND 
					EQ.CodCapitulo = P.CodDiagnostico 
			end 
	end 
	--	Insertar.
	IF @spvar_Accion = '1'

		INSERT CapituloQuirurgico 
   		VALUES ( 
			@spvar_CodPaciente,
			@spvar_CodEpisodio,
			@spvar_Fecha,
			@spvar_Tabla,
			@spvar_Elemento,
			@spvar_Codigo, 
			@spvar_CodHistoria,
			@spvar_CodIntervencion
			--(04/09/2015) - v4.53r1 - SGN - 2500 - Plano y extremidad de intervenciones quirúrgicas - INI
			,@spvar_IdPlano
			,@spvar_IdCuadrante
          	--(04/09/2015) - v4.53r1 - SGN - 2500 - Plano y extremidad de intervenciones quirúrgicas - FIN
			,@spvar_Estado
		
		)

	--	Eliminar.
	IF @spvar_Accion = '2'

		BEGIN

			--	Borrar de Lista de Problemas si son Intervenciones desde InformeQuirurgico.
  			IF '1' Like @spvar_Tabla AND '3' Like @spvar_Elemento 
		
				BEGIN

					SELECT 
						@F_Informe = FInforme
					FROM 
						HClinica..InformeQuirurgico
					WHERE 
						CodPaciente = @spvar_CodPaciente AND 
						CodEpisodio = @spvar_CodEpisodio AND 
						FSolicitud=@spvar_Fecha

					DELETE 
						LP
    					FROM 
						HClinica..Problemas LP,
   	 					CapituloQuirurgico EQ
    					WHERE 
						CodIntervencion = @spvar_CodIntervencion AND
						EQ.TabCapitulo like @spvar_Tabla AND 
						EQ.EleCapitulo like @spvar_Elemento AND 
						EQ.CodCapitulo like @spvar_Codigo AND 
						LP.CodPaciente = EQ.CodPaciente AND 
						LP.FecIni = EQ.FecCapitulo AND 
						LP.FecEntrada = @F_Informe AND 
						LP.CodProblem = EQ.CodCapitulo AND 
						LP.CodGrupProblem = '6' AND 
						LP.CodVitRelevancia = 'R'

				END
   
			DELETE 
				CapituloQuirurgico
   			WHERE 
				CodIntervencion = @spvar_CodIntervencion AND
				TabCapitulo like @spvar_Tabla AND 
				EleCapitulo like @spvar_Elemento AND 
				CodCapitulo like @spvar_Codigo 

		END

	IF @spvar_Accion = '3'

		BEGIN 

			SELECT 
				@F_Informe = FInforme
   			FROM 
				HClinica..InformeQuirurgico
   			WHERE 
				CodIntervencion = @spvar_CodIntervencion

			INSERT Problemas (
				CodPaciente,
                           		FecIni,
                           		FecEntrada,
                           		CodGrupProblem,
                           		CodVitRelevancia,
                           		CodProblem,
                           		DescProblem,
				ObserProblem,
				CodEspec,
				CodHistoria
			)

			SELECT 
				CodPaciente,
          				Fecha,
          				@F_Informe,
          				"6",
          				"R", 
          				Codigo,
          				Procedimiento,
				NULL,
				NULL,
				NULL
   			FROM 
				CapituloQuirurgico EQ,
        				Parametros..Procedimientos P
   			WHERE 
				CodIntervencion = @spvar_CodIntervencion AND
				TabCapitulo = '1' And 
				EleCapitulo = '3' And 
				EQ.CodCapitulo = P.CodDiagnostico AND 
				NOT Exists(
					SELECT *
					FROM Problemas LP
                         				WHERE 	LP.CodPaciente = EQ.CodPaciente AND 
							LP.FecIni = EQ.Fecha AND 
							LP.FecEntrada = @F_Informe AND 
							EQ.Tabla = '1' AND 
							EQ.Elemento = '3' AND 
							EQ.Codigo = LP.CodProblem
				)

		END



    GO

GO



--dbo.SpParIDatosCamas.sql

USE [Parametros];
GO
IF EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[SpParIDatosCamas]') AND type in (N'P', N'PC'))
	DROP PROCEDURE [dbo].[SpParIDatosCamas]
GO

/****************************************************
PROCEDIMIENTO : SpParIDatosCamas
FUNCION		  : Inserta registro en DatosCamas
FECHA		  : 18/07/2017
VERSION		  : V17.3 - 18461
AUTOR		  : Marco Polo Ruiz
MODIFICACIÓN  : (27/10/2017) V17.3r1 - 20769 - APB - Constante códigos prestación creación camas
****************************************************/

CREATE PROCEDURE [dbo].[SpParIDatosCamas]
	 @spvar_CodPlanta as char(2)
	,@spvar_NumHabit as char(10)
	,@spvar_NumCama as char(7)
	,@spvar_Borrado as char(1)
	,@spvar_CuentaOcupacion as bit
	,@spvar_CodServ as char(4)
	,@spvar_ComplejidadCama as int
	,@spvar_TipoCama as char(2)
	,@spvar_GrupoEtario as int
	,@spvar_CodFacPernocta as char(10) = null
	,@spvar_CodFacNoPernocta as char(10) = null
	,@spvar_CodPrestacion as char(32) = null
	,@spvar_CodCentro as char(5)
	,@spvar_EstadoCama as char(1)
AS

BEGIN
	INSERT INTO Parametros..DatosCamas(
		  NumCama
		 ,CodPlanta
		 ,CodServ
		 ,CodDep
		 ,CodTIngreso
		 ,CodOfic
		 ,CodCent
		 ,CodTipo
		 ,NumHabit
		 ,EstadoCama
		 ,Borrado
		 ,MotivoNoFunc
		 ,CuentaOcupacion
		 ,ColectivoDUE
		 ,TipoCama
		 ,tipoCamaHospitalizacion
		 ,CodCategorizacion
		 ,ComplejidadCama
		 ,GrupoEtario
		 ,CodFacPernocta
		 ,CodfacNoPernocta
		 ,CodPrestacion)
	 VALUES( 
	      @spvar_NumCama
		 ,@spvar_CodPlanta
		 ,@spvar_CodServ
		 ,NULL
		 ,NULL
		 ,NULL
		 ,@spvar_CodCentro
		 ,NULL
		 ,@spvar_NumHabit
		 ,@spvar_EstadoCama
		 ,@spvar_Borrado
		 ,NULL
		 ,@spvar_CuentaOcupacion
		 ,NULL
		 ,NULL
		 ,@spvar_TipoCama
		 ,NULL
		 ,@spvar_ComplejidadCama
		 ,@spvar_GrupoEtario
		 ,@spvar_CodFacPernocta
		 ,@spvar_CodFacNoPernocta
		 ,@spvar_CodPrestacion) 
END

GO
GO



--dbo.SpParSCamasUrgencias.sql

USE [Parametros]
GO

IF EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[SpParSCamasUrgencias]') AND type in (N'P', N'PC'))
	DROP PROCEDURE [dbo].[SpParSCamasUrgencias]
GO

SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

/*
PROCEDIMIENTO: SpParCamasUrgencias
FUNCION: Obtiene el listado de camas de urgencias
DEVUELVE:
FECHA: 24/07/2013
VERSION: 1.0
AUTOR: MAIPU CHC2503 V4.40 FCB, Solicitudes de traslado
MODIFICACIÓN: (19/10/2017) - V17.3r1 - 20637 - APB - Observaciones Gestor de Solicitudes de Traslado
*/

CREATE PROCEDURE [dbo].[SpParSCamasUrgencias]
	@spvar_CodCentro char(5)
AS 

BEGIN 
	SELECT RTRIM(CodCama) + 'B' AS 'IdCama'
	      ,NombreBoxCorto
	      ,CodCentro
	      ,NombreBoxCorto AS DescCama
	FROM Parametros..CamasBoxesUrg
	WHERE CodCentro = @spvar_CodCentro
	UNION
	SELECT RTRIM(CodCama) + 'I' AS 'IdCama'
	      ,NombreCamaCorto
	      ,CodCentro
	      ,NombreCamaCorto AS DescCama
	FROM Parametros..CamasIngUrgencia
	WHERE CodCentro = @spvar_CodCentro
END

GO



--dbo.SpParSCuposCitasFechas.sql

USE [Parametros]
GO

IF EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[SpParSCuposCitasFechas]') AND type in (N'P', N'PC'))
	DROP PROCEDURE [dbo].[SpParSCuposCitasFechas]
GO

/**************************************************
--	PROCEDIMIENTO	  : SpParSCuposCitasFechas
--	FUNCION           : Carga los datos de los cupos
--	DEVUELVE          :
--	FECHA             : 24/02/2010
--	VERSION           : 1.0
--	AUTOR             : Paco Aznar
--	APLICACION ORIGEN : Buscador de Cupos - Admisión
************************************************
MODIFICACION: (28/04/2010) Paco Aznar. Se obtienen los bits de citaPrimera y citaSucesiva
MODIFICACION: (06/09/2010) Paco Aznar. Se obtiene el centro origen del cupo
MODIFICACION: (14/01/2011) Paco Aznar. Se elimina ambigüedad del campo CupoMaximo
MODIFICACION: (14/07/2011) A. Zaragoza. No estaba haciendo bien el cruce por fechas
MODIFICACION: (25/08/2011) A. Zaragoza. Cambios fecha
MODIFICACION: (24/11/2011) A. Zaragoza. Modifico cruces con fechas para evitar redondeos de BD
MODIFICACIÓN: (03/10/2012) Alberto Pagán CHC2117 - V4.32 Release 3 - Exportar Cupos
MODIFICACIÓN: (22/06/2015) V4.52 - 1899 - SGN - Problema distribución cupos florence
MODIFICACIÓN: (04/08/2017) V17.3 - 18705 - MPR - Filtrado fechas cupos por centro
MODIFICACIÓN: (25/10/2017) V17.3r1 - 20728 - APB - Modificar rango Fechas Cupos
************************************************/

CREATE PROCEDURE [dbo].[SpParSCuposCitasFechas]
	 @spvar_CodCentro char(5) = null
	,@spvar_FechaIni smalldatetime = null
	,@spvar_FechaFin smalldatetime = null
	,@spvar_CodServicio char(4) = null
	,@spvar_codUnidad int = null
	,@spvar_NomCupo varchar(100) = null
AS

BEGIN
	SELECT DISTINCT
		   parametros.dbo.fnParFechaHoraUTC(cc.FechaIni) AS FechaIni____
		  ,parametros.dbo.fnParFechaHoraUTC(cc.FechaFin) AS FechaFin____
		  ,parametros.dbo.fnParFechaHoraUTC(cc.fechaCaducidad) AS fechaCaducidad____
		  ,cc.CupoTotal AS cupoMaximo
		  ,cc.CodServicio
		  ,s.DescServicio
		  ,cc.CodUnidad
		  ,u.Descripcion
		  ,cc.NomCupo
		  ,cc.idCupo
		  ,(SELECT TOP 1 cu1.fechaCad1 FROM Parametros..CuposCentro cu1 WHERE cu1.idCupo = cu.idCupo and cu1.fechaCad1 is not null) AS fechaCad1
		  ,(SELECT TOP 1 cu2.fechaCad2 FROM Parametros..CuposCentro cu2 WHERE cu2.idCupo = cu.idCupo and cu2.fechaCad2 is not null) AS fechaCad2
		  ,cc.CitaPrimera 
		  ,cc.CitaSucesiva
		  ,cc.CodCentroOrigen 
		  ,cc.UsuCreacion
		  ,cc.FecCreacion
			
	FROM Parametros..CuposCitas cc
		 LEFT JOIN Parametros..CuposCentro cu ON cu.idCupo = cc.idCupo
		 LEFT JOIN Parametros..Servicios s ON s.Codigo = cc.CodServicio
		 LEFT JOIN Parametros..Unidad u ON u.IdUnidad = cc.CodUnidad
		
	WHERE (@spvar_CodCentro is null or @spvar_CodCentro = cc.codCentroOrigen) and
  	      (@spvar_codUnidad is null or @spvar_codUnidad = cc.CodUnidad) and
  	      (@spvar_FechaIni is null or convert(char(10),cc.FechaIni,101) >= @spvar_FechaIni) and
	      (@spvar_FechaFin is null or convert(char(10),cc.FechaFin,101) <= @spvar_FechaFin) and
	      (@spvar_CodServicio is null or @spvar_CodServicio = cc.CodServicio) and
		  (cu.fechaCad is not null or cu.fechaCad1 is not null or cu.fechaCad2 is not null) and
		  (cc.NomCupo like '%' + @spvar_NomCupo + '%' or @spvar_NomCupo is null)
		  
	ORDER BY FechaIni____
	        ,cc.NomCupo 
END
    
GO
GO



--dbo.SpParSObtenerDetallesCuposExcel.sql

USE [Parametros]
GO

IF EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[SpParSObtenerDetallesCuposExcel]') AND type in (N'P', N'PC'))
	DROP PROCEDURE [dbo].[SpParSObtenerDetallesCuposExcel]
GO
    
/**************************************************
--	PROCEDIMIENTO	  : SpParSObtenerDetallesCuposExcel
--	FUNCION           : Obtiene los datos detalle de los cupos que cumplan con los filtros para exportarlos a excel
--	DEVUELVE          : 
--	FECHA             : 10/11/2011
--	VERSION           : 1.0
--	AUTOR             : José Almela
--	APLICACION ORIGEN : Exportar a Excel en Buscador de Cupos - Admisión
--  MODIFICACION	  : (15/11/2011) Ampliado el campo descripcion a 255 de la tabla temporal.
--  MODIFICACIÓN      : (25/10/2017) V17.3r1 - 20728 - APB - Modificar rango Fechas Cupos
************************************************/

CREATE PROCEDURE [dbo].[SpParSObtenerDetallesCuposExcel]
	 @spvar_codCentro char(5) = null
    ,@spvar_IdCupo int = null
    ,@spvar_FechaIni smalldatetime = null
	,@spvar_FechaFin smalldatetime = null
	,@spvar_CodServicio char(4) = null
	,@spvar_codUnidad int = null
	,@spvar_NomCupo varchar(100) = null
AS	

BEGIN
	DECLARE @CuposCitas AS TABLE (
		   FechaIni smalldatetime
		  ,FechaFin smalldatetime
		  ,fechaCaducidad smalldatetime
		  ,cupoMaximo int 
		  ,CodServicio char(4)
		  ,DescServicio char(40)
		  ,CodUnidad int
		  ,Descripcion char(255)
		  ,NomCupo char(100)
		  ,idCupo int
		  ,fechaCad1 smalldatetime
		  ,fechaCad2 smalldatetime
		  ,citaPrimera bit
		  ,citaSucesiva bit 
		  ,codCentroOrigen char(5)
		  ,Centro varchar(50)
		  ,cupoTotalP int
		  ,cupoTotalS int) 

	--Se obtienen los datos del cupo 
	INSERT INTO @CuposCitas
	SELECT DISTINCT
		   convert(char(10),cc.FechaIni,101) AS FechaIni
		  ,convert(char(10),cc.FechaFin,101) AS FechaFin
		  ,convert(char(10),cc.FechaCaducidad,101) AS FechaCaducidad
		  ,cc.CupoTotal AS cupoMaximo
		  ,cc.CodServicio
		  ,s.DescServicio
		  ,cc.CodUnidad
		  ,u.Descripcion
		  ,cc.NomCupo
		  ,cc.idCupo
		  ,(SELECT TOP 1 cu1.fechaCad1 FROM Parametros..CuposCentro cu1 WHERE cu1.idCupo = cu.idCupo and cu1.fechaCad1 is not null) AS fechaCad1
		  ,(SELECT TOP 1 cu2.fechaCad2 FROM Parametros..CuposCentro cu2 WHERE cu2.idCupo = cu.idCupo and cu2.fechaCad2 is not null) AS fechaCad2
		  ,cc.CitaPrimera
		  ,cc.CitaSucesiva 
		  ,cc.CodCentroOrigen
		  ,cs.DescCentro AS Centro
		  ,cc.cupototal - (SELECT SUM(cuposCitados1) FROM Parametros..CuposCentro cup1 WHERE cup1.idCupo = cc.idCupo) AS cupoTotalP
		  ,cc.cupototal - (SELECT SUM(cuposCitados1) FROM Parametros..CuposCentro cup1 WHERE cup1.idCupo = cc.idCupo) - (SELECT SUM(cuposCitados2) FROM Parametros..CuposCentro cup2 WHERE cup2.idCupo = cc.idCupo) AS cupoTotalS
	
  FROM Parametros..CuposCitas cc
	   LEFT JOIN Parametros..CuposCentro cu ON cu.idCupo = cc.idCupo
	   LEFT JOIN Parametros..Servicios s ON s.Codigo = cc.CodServicio
	   LEFT JOIN Parametros..Unidad u ON u.IdUnidad = cc.CodUnidad
	   LEFT JOIN Parametros..CentrosSalud cs ON cs.CodCentro = cc.CodCentroOrigen

  WHERE (@spvar_CodCentro is null or @spvar_CodCentro = cc.codCentroOrigen) and
  	    (@spvar_codUnidad is null or @spvar_codUnidad = cc.CodUnidad) and
		(@spvar_FechaIni is null or convert(char(10),cc.FechaIni,101) >= @spvar_FechaIni) and
	    (@spvar_FechaFin is null or convert(char(10),cc.FechaFin,101) <= @spvar_FechaFin) and
	    (@spvar_CodServicio is null or @spvar_CodServicio = cc.CodServicio) and
		(cu.fechaCad is not null or cu.fechaCad1 is not null or cu.fechaCad2 is not null) and
		(@spvar_IdCupo is null or @spvar_IdCupo = cc.idCupo) and
		(cc.NomCupo like '%' + @spvar_NomCupo + '%' or @spvar_NomCupo is null)

  ORDER BY FechaIni
	      ,cc.NomCupo
	        		
  SELECT [Centro]
		,RTRIM(DescServicio) AS Servicio
  		,RTRIM(NomCupo) AS Cupo
		,RTRIM(Descripcion) AS Unidad
		,FechaIni AS [Fecha Inicio]
		,FechaFin AS [Fecha Fin]
		,citaPrimera
		,citaSucesiva
		,idCupo
  FROM @CuposCitas
	
  --Se obtienen los centros asignados en cada caducidad, que no sea el centro del cupo
  SELECT cs1.DescCentro AS Centro
		,convert(char(10),cc.fechaCad,103) AS fechaCad
		,convert(char(10),cc.fechaCad1,103) AS fechaCad1
		,convert(char(10),cc.fechaCad2,103) AS fechaCad2
		,cc.cuposCitados
		,cc.cuposCitados1
		,cc.cuposCitados2
		,isnull(cc.CupoMaximo,0) - isnull(cc.cuposCitados,0) AS [DisponiblesC]
		,isnull(cc.CupoMaximo,0) AS TotalesC
		,tmpCC.[cupoTotalP] - cc.cuposCitados1 AS DisponiblesP
		,tmpCC.[cupoTotalP] AS TotalesP
		,tmpCC.[cupoTotalS] - cc.cuposCitados2 AS DisponiblesS
		,tmpCC.[cupoTotalS] AS TotalesS
		,cc.idCupo
  
  FROM Parametros..CuposCentro cc
	   INNER JOIN @CuposCitas tmpCC ON tmpCC.idCupo = cc.idCupo
	   LEFT JOIN Parametros..CentrosSalud cs1 ON cs1.CodCentro = cc.codCentro

  WHERE (cc.codCentro <> tmpCC.codCentroOrigen) and
		 cc.excluido = 0
	
  --Se obtienen los cupos que se pueden citar en primera y segunda caducidad
  SELECT ci.cupototal - (SELECT SUM(cuposCitados1) FROM Parametros..CuposCentro cup1 WHERE cup1.idCupo = ci.idCupo) AS cupoTotalP
		,ci.cupototal - (SELECT SUM(cuposCitados1) FROM Parametros..CuposCentro cup1 WHERE cup1.idCupo = ci.idCupo) - (SELECT SUM(cuposCitados2) FROM Parametros..CuposCentro cup2 WHERE cup2.idCupo = ci.idCupo) AS cupoTotalS
		,ci.idCupo

  FROM Parametros..CuposCitas ci
	
  WHERE (ci.idCupo = @spvar_IdCupo or @spvar_IdCupo is null)	
END

GO
GO



