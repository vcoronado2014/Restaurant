USE [RAYEN]
GO

/****** Object:  StoredProcedure [dbo].[REP0026]    Script Date: 18-08-2016 16:25:12 ******/
DROP PROCEDURE [dbo].[REP0026]
GO

/****** Object:  StoredProcedure [dbo].[REP0026]    Script Date: 18-08-2016 16:25:12 ******/
SET ANSI_NULLS OFF
GO

SET QUOTED_IDENTIFIER OFF
GO


/*-----------------------------------------------------------*
** NOMBRE SISTEMA: RAYEN 
**
** NOMBRE DEL OBJETO: REP0026
**
** VER: 1.0.0.1
**
** DESCRIPCION: Modificacion según USYM
**
** AUTOR: Felipe Nieto
**
** FECHA DE CREACION: agosto-2008
**
** MODIFICACIONES:
** Ver 1.0.0.2 , 26/08/2008, Christopher Castro : Se agrega  inner join aten_atencion a alfa.
** Ver 1.0.0.2 , 03/09/2008, Christopher Castro : Se agrega  condicion para edad, con lo cual en pacientes menores de 10 años muestra el formato años, meses y días, si es menor de un mes muestra los días y cuando la edad es mayor de 10 años muestra solo los años del usuario
** Ver 1.0.0.3 , 18/08/2016, Víctor Coronado    : Se agrega JOIN con la tabla ATEN_ATENCION según sugerencia de USYM.

**-----------------------------------------------------------*/
-- exec REP0026 @Nod_Id=2449,@Fecha_Inicio='2010-10-17 00:00:00',@Fecha_Termino='2010-10-23 23:59:59'



CREATE PROCEDURE [dbo].[REP0026]
(
@NOD_ID INT,
@FECHA_INICIO DATETIME,
@FECHA_TERMINO DATETIME
)
/*05 - MONITOREO_INFLUENZA.sql*/
 AS
BEGIN

DECLARE @REMMONITOREO TABLE (id int IDENTITY,DIA VARCHAR(50), NDIA INT)
DECLARE @RESULTADO_MONITOREO TABLE  (fecha varchar(30),MENOR_DE1_lFEM INT,MENOR_DE1_lMASC INT,  D1_A_4FEM INT,D1_A_4MASC INT, D5_A_9FEM INT,D5_A_9MASC  INT,			  D10_A_14FEM INT, D10_A_14MASC int, D15_A_19FEM INT,D15_A_19MASC INT,D20_A_64FEM INT,D20_A_64MASC INT, D65_MAS_FEM INT, D65_MAS_MASC INT )
DECLARE
@DIA VARCHAR(50),
@NDIA INT,
@MENOR_DE1_lFEM INT,
@MENOR_DE1_lMASC INT,  
@D1_A_4FEM INT,
@D1_A_4MASC INT, 
@D5_A_9FEM INT,
@D5_A_9MASC  INT,
@D10_A_14FEM INT, 
@D10_A_14MASC INT, 
@D15_A_19FEM INT,
@D15_A_19MASC INT,
@D20_A_64FEM INT,
@D20_A_64MASC INT, 
@D65_MAS_FEM INT, 
@D65_MAS_MASC INT 

SELECT 
DATE_DIAGNOSTICOS_ATENCION.USP_ID,
USP_USUARIO_APS.HL7_0001_U_ID as 'SEXO',
DATE_DIAGNOSTICOS_ATENCION.FECHA as 'FECHA',
DATE_DIAGNOSTICOS_ATENCION.EDAD_USUARIO_APS as 'EDAD'
into #Resultado
FROM DATE_DIAGNOSTICOS_ATENCION
INNER JOIN USP_USUARIO_APS 
ON DATE_DIAGNOSTICOS_ATENCION.USP_ID = USP_USUARIO_APS.ID 
--******************** agregado por CORO ************************************
INNER JOIN ATEN_ATENCION aten
ON DATE_DIAGNOSTICOS_ATENCION.ATEN_ID=aten.ID
--***************************************************************************
WHERE 
--******************** agregado por CORO ************************************
aten.NOD_ID = @NOD_ID
--***************************************************************************
--USP_USUARIO_APS.NOD_ID = @NOD_ID 
AND DATE_DIAGNOSTICOS_ATENCION.FECHA BETWEEN @FECHA_INICIO AND @FECHA_TERMINO
AND DATE_DIAGNOSTICOS_ATENCION.DIAG_ID IN (4253,4255,4256,4257,4259,4260) 
--******************** agregado por CORO ************************************
AND DATE_DIAGNOSTICOS_ATENCION.ELIMINADO = 0
--***************************************************************************

DECLARE @FECHA DATETIME 
SET @FECHA = @FECHA_INICIO

SET DATEFIRST 1

WHILE (@FECHA <= @FECHA_TERMINO)
BEGIN
	SELECT @DIA = CASE DATEPART(DW,@FECHA) 
	WHEN 1 THEN 'LUNES' 
	WHEN 2 THEN 'MARTES' 
	WHEN 3 THEN 'MIERCOLES' 
	WHEN 4 THEN 'JUEVES' 
	WHEN 5 THEN 'VIERNES' 
	WHEN 6 THEN 'SABADO' 
	WHEN 7 THEN 'DOMINGO' 
	END
	SET @MENOR_DE1_lFEM  	= (SELECT COUNT(usp_id) FROM #resultado WHERE EDAD BETWEEN        0 AND    113023 AND SEXO = 2 AND FECHA BETWEEN @FECHA AND @FECHA + ' 23:59:59.999')
	SET @MENOR_DE1_lMASC 	= (SELECT COUNT(usp_id) FROM #resultado WHERE EDAD BETWEEN        0 AND    113023 AND SEXO = 3 AND FECHA BETWEEN @FECHA AND @FECHA + ' 23:59:59.999')
	SET @D1_A_4FEM 		= (SELECT COUNT(usp_id) FROM #resultado WHERE EDAD BETWEEN  1000000 AND   4113023 AND SEXO = 2 AND FECHA BETWEEN @FECHA AND @FECHA + ' 23:59:59.999')
	SET @D1_A_4MASC  	= (SELECT COUNT(usp_id) FROM #resultado WHERE EDAD BETWEEN  1000000 AND   4113023 AND SEXO = 3 AND FECHA BETWEEN @FECHA AND @FECHA + ' 23:59:59.999')
	SET @D5_A_9FEM 		= (SELECT COUNT(usp_id) FROM #resultado WHERE EDAD BETWEEN  5000000 AND   9113023 AND SEXO = 2 AND FECHA BETWEEN @FECHA AND @FECHA + ' 23:59:59.999')
	SET @D5_A_9MASC  	= (SELECT COUNT(usp_id) FROM #resultado WHERE EDAD BETWEEN  5000000 AND   9113023 AND SEXO = 3 AND FECHA BETWEEN @FECHA AND @FECHA + ' 23:59:59.999')
	SET @D10_A_14FEM 	= (SELECT COUNT(usp_id) FROM #resultado WHERE EDAD BETWEEN 10000000 AND  14113023 AND SEXO = 2 AND FECHA BETWEEN @FECHA AND @FECHA + ' 23:59:59.999')
	SET @D10_A_14MASC 	= (SELECT COUNT(usp_id) FROM #resultado WHERE EDAD BETWEEN 10000000 AND  14113023 AND SEXO = 3 AND FECHA BETWEEN @FECHA AND @FECHA + ' 23:59:59.999') 
	SET @D15_A_19FEM 	= (SELECT COUNT(usp_id) FROM #resultado WHERE EDAD BETWEEN 15000000 AND  19113023 AND SEXO = 2 AND FECHA BETWEEN @FECHA AND @FECHA + ' 23:59:59.999')
	SET @D15_A_19MASC 	= (SELECT COUNT(usp_id) FROM #resultado WHERE EDAD BETWEEN 15000000 AND  19113023 AND SEXO = 3 AND FECHA BETWEEN @FECHA AND @FECHA + ' 23:59:59.999')
	SET @D20_A_64FEM 	= (SELECT COUNT(usp_id) FROM #resultado WHERE EDAD BETWEEN 20000000 AND  64113023 AND SEXO = 2 AND FECHA BETWEEN @FECHA AND @FECHA + ' 23:59:59.999')
	SET @D20_A_64MASC 	= (SELECT COUNT(usp_id) FROM #resultado WHERE EDAD BETWEEN 20000000 AND  64113023 AND SEXO = 3 AND FECHA BETWEEN @FECHA AND @FECHA + ' 23:59:59.999')
	SET @D65_MAS_FEM 	= (SELECT COUNT(usp_id) FROM #resultado WHERE EDAD BETWEEN 65000000 AND 150113023 AND SEXO = 2 AND FECHA BETWEEN @FECHA AND @FECHA + ' 23:59:59.999')
	SET @D65_MAS_MASC 	= (SELECT COUNT(usp_id) FROM #resultado WHERE EDAD BETWEEN 65000000 AND 150113023 AND SEXO = 3 AND FECHA BETWEEN @FECHA AND @FECHA + ' 23:59:59.999') 

	INSERT INTO @RESULTADO_MONITOREO values(@dia + ' ' + convert(varchar,@fecha,103), @MENOR_DE1_lFEM, @MENOR_DE1_lMASC, @D1_A_4FEM, @D1_A_4MASC, @D5_A_9FEM, @D5_A_9MASC, @D10_A_14FEM, @D10_A_14MASC, @D15_A_19FEM, @D15_A_19MASC, @D20_A_64FEM, @D20_A_64MASC, @D65_MAS_FEM, @D65_MAS_MASC)
	SET @FECHA = @FECHA + 1
END

SELECT * FROM @RESULTADO_MONITOREO

DROP TABLE #Resultado

-- Comentado por VHP,  25-10-2010 
--select * from Date_diagnosticos_atencion where diag_ID IN (4253,4255,4256,4257,4259,4260)
--and usp_id in (select id from usp_usuario_aps where nod_id = 1939)
	
END





GO

